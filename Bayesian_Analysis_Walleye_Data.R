library(tidyverse)
library(tidybayes)
library(brms)
library(dplyr)
library(emmeans)

setwd("C:/Users/Treberg's Lab PC/Desktop/Walleye_Bayes")
# loading the amino acid data
raw_data <- read_csv(file = "Walleye_Bayes_Sheet.csv")
str(raw_data)
raw_dataf <- raw_data %>% 
  mutate(Year = relevel(as.factor(Year), '2017', '2018')) %>% 
  mutate(Site_Year = paste0(Site, "_", Year)) %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" ")))
str(raw_dataf)
view(raw_dataf)

names(raw_dataf)
summary(raw_dataf)
# ID          Year        Site                 TL              FL              W               K         
# Min.   :  1.0   2017:62   Length:122         Min.   :373.0   Min.   :350.0   Min.   :0.550   Min.   :0.7733  
# 1st Qu.:160.2   2018:60   Class :character   1st Qu.:483.0   1st Qu.:452.2   1st Qu.:1.125   1st Qu.:0.9834  
# Median :204.5             Mode  :character   Median :601.0   Median :570.0   Median :2.000   Median :1.0713  
# Mean   :199.4                                Mean   :574.1   Mean   :543.7   Mean   :2.127   Mean   :1.0959  
# 3rd Qu.:263.2                                3rd Qu.:653.5   3rd Qu.:620.0   3rd Qu.:3.019   3rd Qu.:1.2083  
# Max.   :355.0                                Max.   :755.0   Max.   :713.0   Max.   :4.850   Max.   :1.5796  
# 
# Sex              Scale_Age      Spine_Age         Alanine         Arginine        Asparagine         Aspartate     
# Length:122         Min.   : 4.0   Min.   : 3.000   Min.   : 51.0   Min.   : 15.01   Min.   :  0.0000   Min.   : 0.000  
# Class :character   1st Qu.: 5.0   1st Qu.: 5.000   1st Qu.:244.0   1st Qu.: 66.23   1st Qu.:  0.0000   1st Qu.: 9.875  
# Mode  :character   Median : 6.0   Median : 7.000   Median :352.9   Median :130.94   Median :  0.8365   Median :20.000  
# Mean   : 6.5   Mean   : 7.704   Mean   :368.4   Mean   :120.83   Mean   : 13.2386   Mean   :24.960  
# 3rd Qu.: 7.0   3rd Qu.: 9.000   3rd Qu.:465.8   3rd Qu.:180.17   3rd Qu.: 20.3250   3rd Qu.:35.200  
# Max.   :11.0   Max.   :15.000   Max.   :857.0   Max.   :270.50   Max.   :130.0000   Max.   :82.600  
# NA's   :68                                                                           
#    Glutamate        Glutamine        Glycine         Histidine        Isoleucine        Leucine           Lysine      
#  Min.   : 26.80   Min.   : 0.00   Min.   : 127.8   Min.   : 10.27   Min.   : 25.06   Min.   : 18.18   Min.   :  0.82  
#  1st Qu.: 81.82   1st Qu.:15.55   1st Qu.: 347.7   1st Qu.: 41.09   1st Qu.: 64.07   1st Qu.: 99.50   1st Qu.: 21.10  
#  Median :121.81   Median :27.30   Median : 469.4   Median : 53.29   Median : 95.18   Median :147.08   Median :106.00  
#  Mean   :147.73   Mean   :28.73   Mean   : 497.9   Mean   : 59.71   Mean   :124.65   Mean   :190.43   Mean   :118.70  
#  3rd Qu.:199.75   3rd Qu.:38.85   3rd Qu.: 613.0   3rd Qu.: 73.93   3rd Qu.:134.84   3rd Qu.:208.34   3rd Qu.:181.17  
#  Max.   :416.81   Max.   :84.00   Max.   :1285.9   Max.   :140.86   Max.   :540.06   Max.   :653.30   Max.   :431.12  
#                                                                                                                       
#    Methionine      Phenylalanine       Proline           Serine         Threonine        Tryptophan       Tyrosine     
#  Min.   :  3.795   Min.   : 16.73   Min.   : 10.19   Min.   : 23.50   Min.   : 23.27   Min.   : 5.22   Min.   : 10.13  
#  1st Qu.: 26.387   1st Qu.: 55.91   1st Qu.: 44.83   1st Qu.: 78.75   1st Qu.: 99.33   1st Qu.:14.03   1st Qu.: 44.42  
#  Median : 43.056   Median : 74.92   Median : 84.70   Median : 94.55   Median :142.05   Median :18.00   Median : 61.88  
#  Mean   : 49.340   Mean   : 82.00   Mean   :101.42   Mean   :109.55   Mean   :139.69   Mean   :20.24   Mean   : 73.29  
#  3rd Qu.: 68.050   3rd Qu.: 92.36   3rd Qu.:132.44   3rd Qu.:134.75   3rd Qu.:184.80   3rd Qu.:24.38   3rd Qu.: 85.70  
#  Max.   :156.562   Max.   :269.75   Max.   :377.81   Max.   :268.00   Max.   :300.88   Max.   :48.30   Max.   :381.19  
#                                                                                                                        
#      Valine        Site_Year        
#  Min.   : 49.99   Length:122        
#  1st Qu.:125.48   Class :character  
#  Median :169.44   Mode  :character  
#  Mean   :229.46                     
#  3rd Qu.:273.88                     
#  Max.   :826.19 


raw_dataf %>%                                        # Specify data frame
  group_by(Year) %>%                         # Specify group indicator
  summarise_at(vars(W),              # Specify column
               list(name = mean))               # Specify function
# A tibble: 2 × 2
# Year   name
# <fct> <dbl>
#   1 2017   2.46
# 2 2018   1.79

raw_dataf %>%                                        # Specify data frame
  group_by(Year) %>%                         # Specify group indicator
  summarise_at(vars(W),              # Specify column
               list(name = sd))               # Specify function
# A tibble: 2 × 2
# Year   name
# <fct> <dbl>
#   1 2017  0.989
# 2 2018  1.27 

raw_dataf %>% select(Year, Sex)
raw_dataf %>% group_by(Sex) %>% select(Year, Site)


# # Sheet with Site-Year
raw_data2 <- read_csv(file = "Walleye_Bayes_Site_Year_Sheet.csv")
# only 2018
data18 <- read_csv(file= "2018_MET_FM")
`2018_MET_FM` <- read.csv("C:/Users/user/Dropbox/PC/Desktop/Walleye_Bayes/2018_MET_FM.csv", quote="")
data18 <- `2018_MET_FM`

#### Age-Length Methionine ####
age_FL_met_model <- brm(data=data18,
                        family = skew_normal,
                        Methionine ~ -1 + Site + Spine.Age + Spine.Age*FL + (1 | Sex),
                        prior = c(prior(uniform(1,100), lb= 1, ub= 100, class = b)),
                        iter = 1000, warmup = 500, chains = 2, cores = 2,
                        control = list(adapt_delta = 0.96, max_treedepth = 20))
pp_check(age_FL_met_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(age_FL_met_model, N = 2, ask = FALSE)
plot(conditional_effects(age_FL_met_model), points = T)

summary(age_FL_met_model)
get_variables(age_FL_met_model)
model_dataframe_age_FL_met <- age_FL_met_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_SiteDauphinRiver:b_SiteSandyBar, names_to = "site", values_to = "est") %>% 
  separate(site, into = c("b", "site"), sep = "_") %>% 
  select(-b) %>% 
  mutate(site = str_remove(site, "Site"))
model_dataframe_age_FL_met$site <- factor(model_dataframe_age_FL_met$site, levels = c("RedRiver", "SandyBar", "Matheson", "DauphinRiver"))
# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_age_FL_met, aes(x = est, y = site)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Methionine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())

#### Age Methionine ####
age_met_model <- brm(data=data18,
                     family = student,
                     Methionine ~ -1 + Site + Spine.Age + (1 | Sex),
                     prior = c(prior(uniform(1,100), lb= 1, ub= 100, class = b)),
                     iter = 1000, warmup = 500, chains = 2, cores = 2,
                     control = list(adapt_delta = 0.96, max_treedepth = 20))
pp_check(age_met_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(age_met_model, N = 2, ask = FALSE)
plot(conditional_effects(age_met_model), points = T)

summary(age_met_model)
get_variables(age_met_model)
model_dataframe_age_met <- age_met_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_SiteDauphinRiver:b_SiteSandyBar, names_to = "site", values_to = "est") %>% 
  separate(site, into = c("b", "site"), sep = "_") %>% 
  select(-b) %>% 
  mutate(site = str_remove(site, "Site"))
model_dataframe_age_met$site <- factor(model_dataframe_age_met$site, levels = c("RedRiver", "SandyBar", "Matheson", "DauphinRiver"))
# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_age_met, aes(x = est, y = site)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Methionine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())

# not needed
#### Alanine ####
alanine_model <- brm(data=raw_dataf,
                     family = skew_normal,
                     Alanine ~ -1 + Site + K + (1 | Sex) + (1 | Year),
                     prior = c(prior(uniform(1,1000), lb= 1, ub= 1000, class = b)),
                     iter = 1000, warmup = 500, chains = 2, cores = 2,
                     control = list(adapt_delta = 0.96, max_treedepth = 20))
pp_check(alanine_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(alanine_model, N = 2, ask = FALSE)
plot(conditional_effects(alanine_model), points = T)

# Look at the variables available in the model
get_variables(alanine_model)
# [1] "b_SiteDauphinRiver"     "b_SiteMatheson"         "b_SiteRedRiver"        
# [4] "b_SiteSandyBar"         "b_SiteWinnipegRiver"    "b_K"                   
# [7] "sd_Sex__Intercept"      "sd_Year__Intercept"     "sigma"                 
# [10] "alpha"                  "r_Sex[F,Intercept]"     "r_Sex[M,Intercept]"    
# [13] "r_Sex[UN,Intercept]"    "r_Year[2017,Intercept]" "r_Year[2018,Intercept]"
# [16] "lprior"                 "lp__"                   "accept_stat__"         
# [19] "stepsize__"             "treedepth__"            "n_leapfrog__"          
# [22] "divergent__"            "energy__"  
# Pull variables. Here, treatments all start with "b" so use regex to pull just those
model_dataframe_ala <- alanine_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_SiteDauphinRiver:b_SiteSandyBar, names_to = "site", values_to = "est") %>% 
  separate(site, into = c("b", "site"), sep = "_") %>% 
  select(-b) %>% 
  mutate(site = str_remove(site, "Site"))
model_dataframe_ala$site <- factor(model_dataframe_ala$site, levels = c("RedRiver", "SandyBar", "Matheson", "DauphinRiver"))


# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_ala %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_ala, aes(x = est, y = site)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Alanine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_ala, aes(x = est, y = Sex)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Alanine") +
  ylab("Sex") +
  guides(fill = guide_legend(title="Sex")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
# did not work

summary(alanine_model)
# Family: skew_normal 
# Links: mu = identity; sigma = identity; alpha = identity 
# Formula: Alanine ~ -1 + Site + K + (1 | Sex) + (1 | Year) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 8000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    36.33     45.91     0.74   160.48 1.00     3060     3199
# 
# ~Year (Number of levels: 2) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)   151.08    104.43    41.62   417.36 1.00     3555     4322
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# SiteDauphinRiver    176.31    112.85    26.22   468.00 1.00     1266     1798
# SiteMatheson        167.48    111.60    19.86   462.43 1.00     1328     2177
# SiteRedRiver        189.57    115.12    36.57   483.63 1.00     1286     1926
# SiteSandyBar        161.26    113.78    13.63   453.51 1.00     1271     1771
# SiteWinnipegRiver   241.63    129.55    38.76   551.84 1.00     1512     2530
# K                   222.40     69.04    84.63   355.01 1.00     3347     3733
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma   131.67      9.60   114.58   151.82 1.00     6176     5166
# alpha     3.94      1.18     2.09     6.64 1.00     6318     3449
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

#### Alanine Site_Year ####
Leucine ~ -1 + Site_Year + K + (1 | Sex) # e.g.

alanine_sy_model <- brm(data=raw_dataf,
                        family = skew_normal,
                        Alanine ~ -1 + Site_Year + K + (1 | Sex),
                        prior = c(prior(uniform(1,1000), lb= 1, ub= 1000, class = b),
                                  prior(cauchy(4, 5), class = sigma)),
                        iter = 50000, warmup = 500, chains = 4, cores = 2,
                        control = list(adapt_delta = 0.98, max_treedepth = 10))
pp_check(alanine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(alanine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(alanine_sy_model), points = T)

# Look at the variables available in the model
get_variables(alanine_sy_model)
# [1] "b_Site_YearDR_2017"  "b_Site_YearDR_2018"  "b_Site_YearMT_2017"  "b_Site_YearMT_2018" 
# [5] "b_Site_YearRR_2017"  "b_Site_YearRR_2018"  "b_Site_YearSB_2017"  "b_Site_YearSB_2018" 
# [9] "b_Site_YearWR_2017"  "b_K"                 "sd_Sex__Intercept"   "sigma"              
# [13] "alpha"               "r_Sex[F,Intercept]"  "r_Sex[M,Intercept]"  "r_Sex[UN,Intercept]"
# [17] "lprior"              "lp__"                "accept_stat__"       "stepsize__"         
# [21] "treedepth__"         "n_leapfrog__"        "divergent__"         "energy__"     
# Pull variables. Here, treatments all start with "b" so use regex to pull just those


# When you then use the get_variables function, 
# you would then need to look at them to change the line in pivot_longer to grab the new variables. 
# The up and down posterior distributions are a little tricky. 
# You have to somehow filter for either 2017 or 2018 data within your model_dataframe object.
# The specific code for that filtering will depend on how you’ve named your variables. 
# Here is code I used for the up and down plot elsewhere, notice that 
# I filter within the state_halfeye functions in the plot code.



model_dataframe_ala_sy <- alanine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_ala_sy$Site<- factor(model_dataframe_ala_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

ala_site_year_plot <- ggplot(data = model_dataframe_ala_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_ala_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_ala_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()

ala_site_year_plot
save(alanine_sy_model, file= "alanine_sy_model")
# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_ala_sy %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_ala_sy, aes(x = est, y = site)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), 
               data = filter(alanine_sy__model, recovery == 0), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), 
               data = filter(alanine_sy__model, recovery == 1), slab_alpha = 0.8) +
  xlab("Alanine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
# When you then use the get_variables function, 
# you would then need to look at them to change the line in pivot_longer to grab the new variables. 
# The up and down posterior distributions are a little tricky. 
# You have to somehow filter for either 2017 or 2018 data within your model_dataframe object.
# The specific code for that filtering will depend on how you’ve named your variables. 
# Here is code I used for the up and down plot elsewhere, notice that 
# I filter within the state_halfeye functions in the plot code.

plot_dataframe_ala_sy <- ggplot(data = alanine_sy_model, aes(x = est, y = Site, fill = recovery)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), 
               data = filter(alanine-sy__model, recovery == 0), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), 
               data = filter(alanine_sy__model, recovery == 1), slab_alpha = 0.8) +
  pivot_longer(cols = b_Site_YearDR_2017:b_Site_YearWR_2017, names_to = "site", values_to = "est") +
  xlab("Alanine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
summary(alanine_model)
#### Methionine ####
hist(raw_dataf$Methionine)
methionine_model <- brm(data=raw_dataf,
                        family = student,
                        Methionine ~ -1 + Site + K + (1 | Sex) + (1 | Year),
                        prior = c(prior(uniform(1,100), lb= 1, ub= 100, class = b)),
                        iter = 5000, warmup = 1000, chains = 2, cores = 2,
                        control = list(adapt_delta = 0.96, max_treedepth = 20))
pp_check(methionine_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(methionine_model, N = 2, ask = FALSE)
plot(conditional_effects(methionine_model), points = T)


# Look at the variables available in the model
get_variables(methionine_model)
# [1] "b_SiteDauphinRiver"     "b_SiteMatheson"         "b_SiteRedRiver"         "b_SiteSandyBar"        
# [5] "b_SiteWinnipegRiver"    "b_K"                    "sd_Sex__Intercept"      "sd_Year__Intercept"    
# [9] "sigma"                  "nu"                     "r_Sex[F,Intercept]"     "r_Sex[M,Intercept]"    
# [13] "r_Sex[UN,Intercept]"    "r_Year[2017,Intercept]" "r_Year[2018,Intercept]" "lprior"                
# [17] "lp__"                   "accept_stat__"          "stepsize__"             "treedepth__"           
# [21] "n_leapfrog__"           "divergent__"            "energy__" 
model_dataframe_met <- methionine_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_SiteDauphinRiver:b_SiteSandyBar, names_to = "site", values_to = "est") %>% 
  separate(site, into = c("b", "site"), sep = "_") %>% 
  select(-b) %>% 
  mutate(site = str_remove(site, "Site"))
model_dataframe_met$site <- factor(model_dataframe_met$site, levels = c("RedRiver", "SandyBar", "Matheson", "DauphinRiver"))


# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_met %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_met, aes(x = est, y = site)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Methionine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())


summary(methionine_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Methionine ~ -1 + Site + K + (1 | Sex) + (1 | Year) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 8000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    12.31     12.92     0.38    48.45 1.00     2018     2631
# 
# ~Year (Number of levels: 2) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    41.76     25.38    11.93   107.85 1.00     2802     3925
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# SiteDauphinRiver     53.53     16.33    28.72    92.08 1.00     1741     2067
# SiteMatheson         33.75     16.48     8.72    72.38 1.00     1816     2366
# SiteRedRiver         36.63     16.06    12.62    74.81 1.00     1748     2248
# SiteSandyBar         26.04     15.96     3.27    63.56 1.00     1788     2534
# SiteWinnipegRiver    18.94     14.68     1.67    56.11 1.00     1993     2892
# K                    38.87     13.61    13.84    66.76 1.00     4663     4406
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    17.10      2.35    12.40    21.53 1.00     3891     4274
# nu        9.34      8.29     2.36    33.17 1.00     4235     5134
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

#### Methionine Stie_Year ####
hist(raw_dataf$Methionine)
methionine_sy_model <- brm(data=raw_dataf,
                           family = student,
                           Methionine ~ -1 + Site_Year + K + (1 | Sex),
                           prior = c(prior(uniform(1,160), lb= 1, ub= 160, class = b),
                                     prior(cauchy(4, 5), class = sigma)),
                           iter = 50000, warmup = 500, chains = 2, cores = 2,
                           control = list(adapt_delta = 0.98, max_treedepth = 10))
pp_check(methionine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(methionine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(methionine_sy_model), points = T)

# Look at the variables available in the model
get_variables(methionine_sy_model)
# [1] "b_Site_YearDauphinRiver_2017"  "b_Site_YearDauphinRiver_2018"  "b_Site_YearMatheson_2017"     
# [4] "b_Site_YearMatheson_2018"      "b_Site_YearRedRiver_2017"      "b_Site_YearRedRiver_2018"     
# [7] "b_Site_YearSandyBar_2017"      "b_Site_YearSandyBar_2018"      "b_Site_YearWinnipegRiver_2017"
# [10] "b_K"                           "sd_Sex__Intercept"             "sigma"                        
# [13] "nu"                            "r_Sex[F,Intercept]"            "r_Sex[M,Intercept]"           
# [16] "r_Sex[UN,Intercept]"           "lprior"                        "lp__"                         
# [19] "accept_stat__"                 "stepsize__"                    "treedepth__"                  
# [22] "n_leapfrog__"                  "divergent__"                   "energy__"  
model_dataframe_met_sy <- methionine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_met_sy$Site<- factor(model_dataframe_met_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

met_site_year_plot <- ggplot(data = model_dataframe_met_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_met_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_met_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()

met_site_year_plot
save(methionine_sy_model, file= "methionine_sy_model.rda")
# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_met_sy %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_met_sy, aes(x = est, y = site)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), 
               data = filter(methionine_sy__model, recovery == 0), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), 
               data = filter(methionine_sy__model, recovery == 1), slab_alpha = 0.8) +
  xlab("Methionine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
# When you then use the get_variables function, 
# you would then need to look at them to change the line in pivot_longer to grab the new variables. 
# The up and down posterior distributions are a little tricky. 
# You have to somehow filter for either 2017 or 2018 data within your model_dataframe object.
# The specific code for that filtering will depend on how you’ve named your variables. 
# Here is code I used for the up and down plot elsewhere, notice that 
# I filter within the state_halfeye functions in the plot code.
plot_dataframe_met_sy <- ggplot(data = methionine_sy_model, aes(x = est, y = Site, fill = recovery)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), 
               data = filter(methionine_sy__model, recovery == 0), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), 
               data = filter(methionine_sy__model, recovery == 1), slab_alpha = 0.8) +
  pivot_longer(cols = b_Site_YearDR_2017:b_Site_YearWR_2017, names_to = "site", values_to = "est") +
  xlab("Methionine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
summary(methionine_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Methionine ~ -1 + Site + K + (1 | Sex) + (1 | Year) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 8000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    12.87     13.40     0.49    51.80 1.00     2007     1656
# 
# ~Year (Number of levels: 2) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    41.72     24.76    11.84   104.18 1.00     2113     3485
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# SiteDauphinRiver     54.04     16.53    28.77    91.95 1.00     1465     1705
# SiteMatheson         34.22     16.69     8.58    72.31 1.00     1402     1863
# SiteRedRiver         37.16     16.27    12.05    74.31 1.00     1414     1700
# SiteSandyBar         26.55     16.22     2.78    64.22 1.00     1362     1861
# SiteWinnipegRiver    19.28     14.98     1.67    56.42 1.00     1765     2796
# K                    38.56     13.64    13.10    66.95 1.00     3933     3051
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    16.99      2.37    12.31    21.53 1.00     3235     1741
# nu        9.06      7.98     2.33    31.44 1.00     3734     5772
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 1 divergent transitions after warmup. Increasing adapt_delta above 0.96 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 

#### Leucine ####

leucine_model <- brm(data = raw_dataf,
                     family = student,
                     Leucine ~ -1 + Site + K + (1 | Sex) + (1 | Year),
                     prior = c(prior(uniform(1, 700), lb = 1, ub = 700, class = b)),
                     iter = 5000, warmup = 1000, chains = 4, cores = 4,
                     control = list(adapt_delta = 0.98, max_treedepth = 20))

# Look at the posterior distribution. It was left skewed when using a Gaussian family distribution, but was fixed by using skew_normal instead
pp_check(leucine_model, ndraws = 100) +
  theme_bw(base_size = 20)

# Look at trace plots
plot(leucine_model, N = 2, ask = FALSE)

plot(conditional_effects(leucine_model), points = T)


# Look at the variables available in the model
get_variables(leucine_model)
# [1] "b_SiteDauphinRiver"     "b_SiteMatheson"         "b_SiteRedRiver"         "b_SiteSandyBar"        
# [5] "b_SiteWinnipegRiver"    "b_K"                    "sd_Sex__Intercept"      "sd_Year__Intercept"    
# [9] "sigma"                  "nu"                     "r_Sex[F,Intercept]"     "r_Sex[M,Intercept]"    
# [13] "r_Sex[UN,Intercept]"    "r_Year[2017,Intercept]" "r_Year[2018,Intercept]" "lprior"                
# [17] "lp__"                   "accept_stat__"          "stepsize__"             "treedepth__"           
# [21] "n_leapfrog__"           "divergent__"            "energy__" 

# Pull variables. Here, treatments all start with "b" so use regex to pull just those
model_dataframe <- leucine_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_SiteDauphinRiver:b_SiteSandyBar, names_to = "site", values_to = "est") %>% 
  separate(site, into = c("b", "site"), sep = "_") %>% 
  select(-b) %>% 
  mutate(site = str_remove(site, "Site"))
model_dataframe$site <- factor(model_dataframe$site, levels = c("RedRiver", "SandyBar", "Matheson", "DauphinRiver"))


# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe, aes(x = est, y = site)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Leucine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
summary(leucine_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Leucine ~ -1 + Site + K + (1 | Sex) + (1 | Year) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    43.14     49.64     1.89   168.16 1.00     3703     5233
# 
# ~Year (Number of levels: 2) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)   107.99     86.49    22.38   339.10 1.00     3467     4466
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# SiteDauphinRiver    181.76     74.45    86.24   383.43 1.00     2449     2408
# SiteMatheson        111.60     70.30    26.37   304.22 1.00     2425     2594
# SiteRedRiver         67.12     63.91     3.31   246.03 1.00     2440     2646
# SiteSandyBar         92.48     67.79    13.49   280.06 1.00     2325     2448
# SiteWinnipegRiver   108.07     70.16    11.66   284.91 1.00     3052     3001
# K                   121.94     66.36    22.44   290.44 1.00     3758     5098
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    67.21     15.63    43.65   102.27 1.00     4382     7250
# nu        3.97      5.19     1.30    18.91 1.00     4225     6031
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

#### Leucine Site_Year ####
hist(raw_dataf$Leucine)
leucine_sy_model <- brm(data=raw_dataf,
                        family = student,
                        Leucine ~ -1 + Site_Year + K + (1 | Sex),
                        prior = c(prior(uniform(1,700), lb= 1, ub= 700, class = b),
                                  prior(cauchy(4, 5), class = sigma)),
                        iter = 50000, warmup = 500, chains = 2, cores = 2,
                        control = list(adapt_delta = 0.98, max_treedepth = 10))
pp_check(leucine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(leucine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(leucine_sy_model), points = T)

# Look at the variables available in the model
get_variables(leucine_sy_model)
# [1] "b_Site_YearDauphinRiver_2017"  "b_Site_YearDauphinRiver_2018" 
# [3] "b_Site_YearMatheson_2017"      "b_Site_YearMatheson_2018"     
# [5] "b_Site_YearRedRiver_2017"      "b_Site_YearRedRiver_2018"     
# [7] "b_Site_YearSandyBar_2017"      "b_Site_YearSandyBar_2018"     
# [9] "b_Site_YearWinnipegRiver_2017" "b_K"                          
# [11] "sd_Sex__Intercept"             "sigma"                        
# [13] "nu"                            "r_Sex[F,Intercept]"           
# [15] "r_Sex[M,Intercept]"            "r_Sex[UN,Intercept]"          
# [17] "lprior"                        "lp__"                         
# [19] "accept_stat__"                 "stepsize__"                   
# [21] "treedepth__"                   "n_leapfrog__"                 
# [23] "divergent__"                   "energy__"                     
model_dataframe_leu_sy <- leucine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_leu_sy$Site<- factor(model_dataframe_leu_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

leu_site_year_plot <- ggplot(data = model_dataframe_leu_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_leu_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_leu_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()

leu_site_year_plot
save(leucine_sy_model, file= "leucine_sy_model.rda")
# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_leu_sy %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_leu_sy, aes(x = est, y = site)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), 
               data = filter(leucine_sy__model, recovery == 0), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), 
               data = filter(leucine_sy__model, recovery == 1), slab_alpha = 0.8) +
  xlab("Leucine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
# When you then use the get_variables function, 
# you would then need to look at them to change the line in pivot_longer to grab the new variables. 
# The up and down posterior distributions are a little tricky. 
# You have to somehow filter for either 2017 or 2018 data within your model_dataframe object.
# The specific code for that filtering will depend on how you’ve named your variables. 
# Here is code I used for the up and down plot elsewhere, notice that 
# I filter within the state_halfeye functions in the plot code.
plot_dataframe_leu_sy <- ggplot(data = leucine_sy_model, aes(x = est, y = Site, fill = recovery)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), 
               data = filter(leucine_sy__model, recovery == 0), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), 
               data = filter(leucine_sy__model, recovery == 1), slab_alpha = 0.8) +
  pivot_longer(cols = b_Site_YearDR_2017:b_Site_YearWR_2017, names_to = "site", values_to = "est") +
  xlab("Leucine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
summary(leucine_sy_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Leucine ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    69.31     57.51    12.09   222.33 1.00    16338    25900
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017    350.00     59.13   251.86   478.10 1.00    19388    21196
# Site_YearDauphinRiver_2018     72.70     40.44    14.03   169.86 1.00    11888    15156
# Site_YearMatheson_2017        200.54     65.53    74.21   333.00 1.00    20565    22896
# Site_YearMatheson_2018         44.48     36.55     3.39   137.72 1.00    11673    14236
# Site_YearRedRiver_2017         63.06     40.50     7.13   160.12 1.00    11714    15868
# Site_YearRedRiver_2018         46.64     37.97     3.18   141.93 1.00    11175    15092
# Site_YearSandyBar_2017         94.97     40.86    35.41   192.32 1.00    12148    14932
# Site_YearSandyBar_2018         68.45     41.79     9.20   169.08 1.00    12598    15329
# Site_YearWinnipegRiver_2017   123.53     48.84    39.60   232.04 1.00    15084    20543
# K                              90.24     43.25    19.44   195.62 1.00    21009    28330
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    57.71      8.94    41.70    76.74 1.00    42592    49178
# nu        2.66      1.09     1.42     5.21 1.00    39441    43063
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

#### Asparagine ####
hist(raw_dataf$Asparagine)
asparagine_model <- brm(data = raw_dataf,
                        family = student,
                        Asparagine ~ -1 + Site + K + (1 | Sex) + (1 | Year),
                        prior = c(prior(uniform(1, 150), lb = 1, ub = 150, class = b)),
                        iter = 5000, warmup = 1000, chains = 3, cores = 2,
                        control = list(adapt_delta = 0.98, max_treedepth = 20))

# Look at the posterior distribution. It was left skewed when using a Gaussian family distribution, but was fixed by using skew_normal instead
pp_check(asparagine_model, ndraws = 100) +
  theme_bw(base_size = 20)

# Look at trace plots
plot(asparagine_model, N = 2, ask = FALSE)

plot(conditional_effects(asparagine_model), points = T)


# Look at the variables available in the model
get_variables(asparagine_model)


# Pull variables. Here, treatments all start with "b" so use regex to pull just those
model_dataframe_asn <- asparagine_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_SiteDauphinRiver:b_SiteSandyBar, names_to = "site", values_to = "est") %>% 
  separate(site, into = c("b", "site"), sep = "_") %>% 
  select(-b) %>% 
  mutate(site = str_remove(site, "Site"))
model_dataframe_asn$site <- factor(model_dataframe_asn$site, levels = c("RedRiver", "SandyBar", "Matheson", "DauphinRiver"))


# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_asn %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_asn, aes(x = est, y = site)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Asparagine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
summary(asparagine_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Asparagine ~ -1 + Site + K + (1 | Sex) + (1 | Year) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     5.71      2.87     1.73    12.76 1.01      871     1154
# 
# ~Year (Number of levels: 2) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     0.97      1.35     0.01     4.69 1.00     4006     4718
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# SiteDauphinRiver     31.47      3.34    27.48    40.38 1.00      835      438
# SiteMatheson          5.84      2.92     2.22    13.25 1.00     1288     3175
# SiteRedRiver          4.25      2.89     1.12    11.78 1.00     1044     3046
# SiteSandyBar          4.46      2.89     1.26    12.01 1.00     1051     2898
# SiteWinnipegRiver     7.22      3.13     3.04    14.95 1.00     1365     3322
# K                     1.52      0.46     1.02     2.69 1.00     8357     5780
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma     0.93      0.23     0.56     1.47 1.00     6276     9194
# nu        1.02      0.02     1.00     1.07 1.00     8687     5493
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

#### Asparagine Year_Site ####
hist(raw_dataf$Asparagine)
asparagine_sy_model <- brm(data=raw_dataf,
                           family = student,
                           Asparagine ~ -1 + Site_Year + K + (1 | Sex),
                           prior = c(prior(uniform(1,140), lb= 1, ub= 140, class = b),
                                     prior(cauchy(4, 5), class = sigma)),
                           iter = 50000, warmup = 500, chains = 2, cores = 2,
                           control = list(adapt_delta = 0.98, max_treedepth = 10))
pp_check(asparagine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(asparagine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(asparagine_sy_model), points = T)

# Look at the variables available in the model
get_variables(asparagine_sy_model)
# [1] "b_Site_YearDauphinRiver_2017"  "b_Site_YearDauphinRiver_2018"  "b_Site_YearMatheson_2017"      "b_Site_YearMatheson_2018"     
# [5] "b_Site_YearRedRiver_2017"      "b_Site_YearRedRiver_2018"      "b_Site_YearSandyBar_2017"      "b_Site_YearSandyBar_2018"     
# [9] "b_Site_YearWinnipegRiver_2017" "b_K"                           "sd_Sex__Intercept"             "sigma"                        
# [13] "nu"                            "r_Sex[F,Intercept]"            "r_Sex[M,Intercept]"            "r_Sex[UN,Intercept]"          
# [17] "lprior"                        "lp__"                          "accept_stat__"                 "stepsize__"                   
# [21] "treedepth__"                   "n_leapfrog__"                  "divergent__"                   "energy__"  
model_dataframe_asn_sy <- asparagine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_asn_sy$Site<- factor(model_dataframe_asn_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

asn_site_year_plot <- ggplot(data = model_dataframe_asn_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_asn_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_asn_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
summary(asparagine_sy_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Asparagine ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     4.08      2.09     1.64     9.51 1.00    13122    19117
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017     27.88      2.03    23.37    32.38 1.00    10627    12227
# Site_YearDauphinRiver_2018     45.22      2.85    38.63    50.29 1.00     8604    12168
# Site_YearMatheson_2017          7.87      3.76     2.29    16.25 1.00    20633    32889
# Site_YearMatheson_2018          4.56      2.04     2.00     9.56 1.00    13331    17235
# Site_YearRedRiver_2017          2.36      1.48     1.05     6.37 1.00     7576    11408
# Site_YearRedRiver_2018          2.40      1.48     1.07     6.43 1.00     7526    11372
# Site_YearSandyBar_2017          2.53      1.49     1.13     6.56 1.00     7592    11407
# Site_YearSandyBar_2018          2.63      1.50     1.17     6.69 1.00     7706    11462
# Site_YearWinnipegRiver_2017     5.33      1.92     2.69    10.00 1.00    12804    15646
# K                               1.46      0.44     1.01     2.61 1.00    46848    36460
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma     0.99      0.25     0.58     1.56 1.00    36173    55196
# nu        1.02      0.02     1.00     1.08 1.00    50843    34665
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
asn_site_year_plot
print(asparagine_sy_model)
save(asparagine_sy_model, file= "asparagine_sy_model.rda")
# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_asn_sy %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_asn_sy, aes(x = est, y = site)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), 
               data = filter(asparagine_sy__model, recovery == 0), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), 
               data = filter(asparagine_sy__model, recovery == 1), slab_alpha = 0.8) +
  xlab("Asparagine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
# When you then use the get_variables function, 
# you would then need to look at them to change the line in pivot_longer to grab the new variables. 
# The up and down posterior distributions are a little tricky. 
# You have to somehow filter for either 2017 or 2018 data within your model_dataframe object.
# The specific code for that filtering will depend on how you’ve named your variables. 
# Here is code I used for the up and down plot elsewhere, notice that 
# I filter within the state_halfeye functions in the plot code.
plot_dataframe_asn_sy <- ggplot(data = asparagine_sy_model, aes(x = est, y = Site, fill = recovery)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), 
               data = filter(asparagine_sy__model, recovery == 0), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), 
               data = filter(asparagine_sy__model, recovery == 1), slab_alpha = 0.8) +
  pivot_longer(cols = b_Site_YearDR_2017:b_Site_YearWR_2017, names_to = "site", values_to = "est") +
  xlab("Asparagine") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
summary(asparagine_sy_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Asparagine ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     4.08      2.09     1.64     9.51 1.00    13122    19117
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017     27.88      2.03    23.37    32.38 1.00    10627    12227
# Site_YearDauphinRiver_2018     45.22      2.85    38.63    50.29 1.00     8604    12168
# Site_YearMatheson_2017          7.87      3.76     2.29    16.25 1.00    20633    32889
# Site_YearMatheson_2018          4.56      2.04     2.00     9.56 1.00    13331    17235
# Site_YearRedRiver_2017          2.36      1.48     1.05     6.37 1.00     7576    11408
# Site_YearRedRiver_2018          2.40      1.48     1.07     6.43 1.00     7526    11372
# Site_YearSandyBar_2017          2.53      1.49     1.13     6.56 1.00     7592    11407
# Site_YearSandyBar_2018          2.63      1.50     1.17     6.69 1.00     7706    11462
# Site_YearWinnipegRiver_2017     5.33      1.92     2.69    10.00 1.00    12804    15646
# K                               1.46      0.44     1.01     2.61 1.00    46848    36460
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma     0.99      0.25     0.58     1.56 1.00    36173    55196
# nu        1.02      0.02     1.00     1.08 1.00    50843    34665
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

#### Asparatate Site_Year ####
hist(raw_dataf$Aspartate)
# [1] "b_Site_YearDauphinRiver_2017"  "b_Site_YearDauphinRiver_2018"  "b_Site_YearMatheson_2017"     
# [4] "b_Site_YearMatheson_2018"      "b_Site_YearRedRiver_2017"      "b_Site_YearRedRiver_2018"     
# [7] "b_Site_YearSandyBar_2017"      "b_Site_YearSandyBar_2018"      "b_Site_YearWinnipegRiver_2017"
# [10] "b_K"                           "sd_Sex__Intercept"             "sigma"                        
# [13] "alpha"                         "r_Sex[F,Intercept]"            "r_Sex[M,Intercept]"           
# [16] "r_Sex[UN,Intercept]"           "lprior"                        "lp__"                         
# [19] "accept_stat__"                 "stepsize__"                    "treedepth__"                  
# [22] "n_leapfrog__"                  "divergent__"                   "energy__" 
aspartate_sy_model <- brm(data=raw_dataf,
                          family = skew_normal,
                          Aspartate~ -1 + Site_Year + K + (1 | Sex),
                          prior = c(prior(uniform(1,90), lb= 1, ub= 90, class = b),
                                    prior(cauchy(4, 5), class = sigma)),
                          iter = 50000, warmup = 500, chains = 2, cores = 2,
                          control = list(adapt_delta = 0.98, max_treedepth = 10))
pp_check(aspartate_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(aspartate_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(aspartate_sy_model), points = T)

# Look at the variables available in the model
get_variables(aspartate_sy_model)
model_dataframe_asp_sy <- aspartate_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_asp_sy$Site<- factor(model_dataframe_asp_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

asp_site_year_plot <- ggplot(data = model_dataframe_asp_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_asp_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_asp_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
summary(aspartate_sy_model)
# Family: skew_normal 
# Links: mu = identity; sigma = identity; alpha = identity 
# Formula: Aspartate ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     3.89      4.56     0.09    16.66 1.00    23448    21540
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017     33.71      5.02    24.11    43.71 1.00    14199    18456
# Site_YearDauphinRiver_2018     19.22      5.06     9.53    29.31 1.00    13992    17201
# Site_YearMatheson_2017         20.82      6.19     8.18    32.81 1.00    19158    23302
# Site_YearMatheson_2018         14.01      4.92     4.67    23.73 1.00    13806    17115
# Site_YearRedRiver_2017         16.11      5.33     5.74    26.61 1.00    13969    21465
# Site_YearRedRiver_2018          9.86      4.81     1.77    19.61 1.00    13740    19426
# Site_YearSandyBar_2017         27.12      5.10    17.29    37.23 1.00    14331    17662
# Site_YearSandyBar_2018          9.32      4.63     1.72    18.86 1.00    13224    19381
# Site_YearWinnipegRiver_2017    33.80      7.54    19.14    49.18 1.00    21053    32574
# K                               5.52      3.20     1.18    12.71 1.00    16333    26914
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    13.94      1.00    12.13    16.06 1.00    68223    64984
# alpha     5.45      2.26     1.67    10.42 1.00    34668    42939
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 309 divergent transitions after warmup. Increasing adapt_delta above 0.98 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
asp_site_year_plot
save(aspartate_sy_model, file = "aspparatte_sy_model.rda")
print(aspartate_sy_model)
#### Aspartate ####
hist(raw_dataf$Aspartate)
aspartate_model <- brm(data = raw_dataf,
                       family = skew_normal,
                       Aspartate ~ -1 + Site + K + (1 | Sex) + (1 | Year),
                       prior = c(prior(uniform(1, 100), lb = 1, ub = 100 , class = b)),
                       iter = 5000, warmup = 1000, chains = 4, cores = 2,
                       control = list(adapt_delta = 0.98, max_treedepth = 20))

# Look at the posterior distribution. It was left skewed when using a Gaussian family distribution, but was fixed by using skew_normal instead
pp_check(aspartate_model, ndraws = 100) +
  theme_bw(base_size = 20)

# Look at trace plots
plot(aspartate_model, N = 2, ask = FALSE)

plot(conditional_effects(aspartate_model), points = T)


# Look at the variables available in the model
get_variables(asparagine_model)
# [1] "b_SiteDauphinRiver"     "b_SiteMatheson"         "b_SiteRedRiver"         "b_SiteSandyBar"        
# [5] "b_SiteWinnipegRiver"    "b_K"                    "sd_Sex__Intercept"      "sd_Year__Intercept"    
# [9] "sigma"                  "nu"                     "r_Sex[F,Intercept]"     "r_Sex[M,Intercept]"    
# [13] "r_Sex[UN,Intercept]"    "r_Year[2017,Intercept]" "r_Year[2018,Intercept]" "lprior"                
# [17] "lp__"                   "accept_stat__"          "stepsize__"             "treedepth__"           
# [21] "n_leapfrog__"           "divergent__"            "energy__" 

# Pull variables. Here, treatments all start with "b" so use regex to pull just those
model_dataframe_aspt <- aspartate_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_SiteDauphinRiver:b_SiteSandyBar, names_to = "site", values_to = "est") %>% 
  separate(site, into = c("b", "site"), sep = "_") %>% 
  select(-b) %>% 
  mutate(site = str_remove(site, "Site"))
model_dataframe_aspt$site <- factor(model_dataframe_aspt$site, levels = c("RedRiver", "SandyBar", "Matheson", "DauphinRiver"))


# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_aspt %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_aspt, aes(x = est, y = site)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Aspartate") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())
summary(aspartate_model)
# Family: skew_normal 
# Links: mu = identity; sigma = identity; alpha = identity 
# Formula: Aspartate ~ -1 + Site + K + (1 | Sex) + (1 | Year) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     4.22      5.02     0.10    17.98 1.00     5517     7040
# 
# ~Year (Number of levels: 2) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    15.26     11.20     3.87    45.30 1.00     4916     4931
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# SiteDauphinRiver     29.92     11.26    15.33    60.15 1.00     1977     2228
# SiteMatheson         21.70     11.33     6.53    51.89 1.00     1954     2205
# SiteRedRiver         15.12     11.20     1.76    45.37 1.00     1969     2161
# SiteSandyBar         21.17     11.33     6.43    51.61 1.00     1928     2210
# SiteWinnipegRiver    30.85     12.69    11.43    62.78 1.00     2324     2241
# K                     7.16      4.85     1.22    18.83 1.00     7370     6207
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    14.12      1.03    12.27    16.31 1.00    14555    11493
# alpha     4.74      2.27     0.93     9.82 1.00     9695     9611
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

#### Glutamate ####
hist(raw_dataf$Glutamate)
glutamate_model <- brm(data=raw_dataf,
                       family = skew_normal,
                       Glutamate ~ -1 + Site + K + (1 | Sex) + (1 | Year),
                       prior = c(prior(uniform(1,430), lb= 1, ub= 430, class = b)),
                       iter = 5000, warmup = 1000, chains = 2, cores = 2,
                       control = list(adapt_delta = 0.96, max_treedepth = 20))
pp_check(glutamate_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(glutamate_model, N = 2, ask = FALSE)
plot(conditional_effects(glutamate_model), points = T)


# Look at the variables available in the model
get_variables(glutamate_model)
# [1] "b_SiteDauphinRiver"     "b_SiteMatheson"         "b_SiteRedRiver"         "b_SiteSandyBar"        
# [5] "b_SiteWinnipegRiver"    "b_K"                    "sd_Sex__Intercept"      "sd_Year__Intercept"    
# [9] "sigma"                  "alpha"                  "r_Sex[F,Intercept]"     "r_Sex[M,Intercept]"    
# [13] "r_Sex[UN,Intercept]"    "r_Year[2017,Intercept]" "r_Year[2018,Intercept]" "lprior"                
# [17] "lp__"                   "accept_stat__"          "stepsize__"             "treedepth__"           
# [21] "n_leapfrog__"           "divergent__"            "energy__" 
model_dataframe_glu <- glutamate_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_SiteDauphinRiver:b_SiteSandyBar, names_to = "site", values_to = "est") %>% 
  separate(site, into = c("b", "site"), sep = "_") %>% 
  select(-b) %>% 
  mutate(site = str_remove(site, "Site"))
model_dataframe_glu$site <- factor(model_dataframe_glu$site, levels = c("RedRiver", "SandyBar", "Matheson", "DauphinRiver"))


# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_glu %>% 
  group_by(site) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_glu, aes(x = est, y = site)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Glutamate") +
  ylab("Site") +
  guides(fill = guide_legend(title="Site")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())


summary(glutamate_model)
# Family: skew_normal 
# Links: mu = identity; sigma = identity; alpha = identity 
# Formula: Glutamate ~ -1 + Site + K + (1 | Sex) + (1 | Year) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 8000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    24.72     27.59     0.82   100.20 1.00     2375     3532
# 
# ~Year (Number of levels: 2) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    93.35     64.85    25.98   268.10 1.00     2120     3158
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# SiteDauphinRiver     99.72     59.52    20.44   259.58 1.00     1041     1321
# SiteMatheson         94.22     59.18    15.85   252.54 1.00     1031     1349
# SiteRedRiver        127.66     59.60    48.35   286.99 1.00     1067     1395
# SiteSandyBar         91.53     59.05    15.06   248.71 1.00     1044     1363
# SiteWinnipegRiver    61.89     56.03     2.68   216.18 1.00     1175     1572
# K                    97.98     35.24    30.05   168.88 1.00     4218     3284
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    59.43      4.38    51.49    68.60 1.00     5694     5064
# alpha     3.16      1.14     1.40     5.93 1.00     4578     2736
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

model_dataframe_glu_year<- glutamate_model %>% 
  spread_draws(., `[\\(r].*`, regex = TRUE) %>% 
  pivot_longer(cols = r_Year[2017,Intercept]:r_Year[2018,Intercept], names_to = "year", values_to = "est") %>% 
  separate(site, into = c("r", "year"), sep = "_") %>% 
  select(-r) %>% 
  mutate(year = str_remove(year, "Year"))
model_dataframe_glu_year$year <- factor(model_dataframe_glu_year$year, levels = c("2017", "2018"))


# Create a smaller version of the model dataframe just for troubleshooting plots
subset_results <- model_dataframe_glu_year %>% 
  group_by(year) %>% 
  slice_sample(n = 500)

# Make halfeye plots of the different treatments
ggplot(data = model_dataframe_glu_year, aes(x = est, y = year)) +
  stat_halfeye(orientation = "horizontal", alpha = 0.5) +
  xlab("Glutamate") +
  ylab("Site") +
  guides(fill = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.91, 0.14), legend.background = element_blank())

#### Glutamate Year_Site ####
hist(raw_dataf$Glutamate)
glutamate_sy_model <- brm(data=raw_dataf,
                          family = skew_normal,
                          Glutamate ~ -1 + Site_Year + K + (1 | Sex),
                          prior = c(prior(uniform(1,450), lb= 1, ub= 450, class = b),
                                    prior(cauchy(4, 5), class = sigma)),
                          iter = 50000, warmup = 500, chains = 4, cores = 2,
                          control = list(adapt_delta = 0.98, max_treedepth = 10))
pp_check(glutamate_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(glutamate_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(glutamate_sy_model), points = T)

# Look at the variables available in the model
get_variables(glutamate_sy_model)
model_dataframe_glu_sy <- glutamate_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_glu_sy$Site<- factor(model_dataframe_glu_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

glu_site_year_plot <- ggplot(data = model_dataframe_glu_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_glu_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_glu_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
summary(glutamate_sy_model)
# Family: skew_normal 
# Links: mu = identity; sigma = identity; alpha = identity 
# Formula: Glutamate ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 198000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    20.05     23.98     0.56    87.62 1.00    41063    52328
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017     88.59     27.34    44.08   149.76 1.00    26300    36054
# Site_YearDauphinRiver_2018     63.56     26.00    20.14   121.12 1.00    26344    36506
# Site_YearMatheson_2017         79.19     31.36    23.18   146.43 1.00    30037    42618
# Site_YearMatheson_2018         41.46     24.08     5.22    96.08 1.00    25081    37487
# Site_YearRedRiver_2017        164.40     27.59   120.31   226.89 1.00    25109    34558
# Site_YearRedRiver_2018         46.94     26.09     6.86   106.62 1.00    24084    36618
# Site_YearSandyBar_2017         97.48     28.91    49.15   161.54 1.00    25987    35271
# Site_YearSandyBar_2018         32.45     24.03     2.42    90.17 1.00    24396    37058
# Site_YearWinnipegRiver_2017    74.01     35.42    11.91   150.59 1.00    29175    45690
# K                              69.40     21.76    22.37   108.53 1.00    33879    47292
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    58.30      4.17    50.77    67.14 1.00   130759   127116
# alpha     5.44      1.86     2.64     9.88 1.00    91644    83466
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 214 divergent transitions after warmup. Increasing adapt_delta above 0.98 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
glu_site_year_plot
save(glutamate_sy_model, file = "glutamate_sy_model.rda")
load(glutamate_sy_model)
#### Arginine Site_Year ####
hist(raw_dataf$Arginine)
arginine_sy_model <- brm(data=raw_dataf,
                         family = student,
                         Arginine~ -1 + Site_Year + K + (1 | Sex),
                         prior = c(prior(uniform(1,300), lb= 1, ub= 300, class = b),
                                   prior(cauchy(4, 5), class = sigma)),
                         iter = 50000, warmup = 500, chains = 2, cores = 2,
                         control = list(adapt_delta = 0.99, max_treedepth = 10))
pp_check(arginine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(arginine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(arginine_sy_model), points = T)

# Look at the variables available in the model
get_variables(arginine_sy_model)
# [1] "b_Site_YearDauphinRiver_2017"  "b_Site_YearDauphinRiver_2018"  "b_Site_YearMatheson_2017"     
# [4] "b_Site_YearMatheson_2018"      "b_Site_YearRedRiver_2017"      "b_Site_YearRedRiver_2018"     
# [7] "b_Site_YearSandyBar_2017"      "b_Site_YearSandyBar_2018"      "b_Site_YearWinnipegRiver_2017"
# [10] "b_K"                           "sd_Sex__Intercept"             "sigma"                        
# [13] "nu"                            "r_Sex[F,Intercept]"            "r_Sex[M,Intercept]"           
# [16] "r_Sex[UN,Intercept]"           "lprior"                        "lp__"                         
# [19] "accept_stat__"                 "stepsize__"                    "treedepth__"                  
# [22] "n_leapfrog__"                  "divergent__"                   "energy__"   
model_dataframe_arg_sy <- arginine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_arg_sy$Site<- factor(model_dataframe_arg_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

arg_site_year_plot <- ggplot(data = model_dataframe_arg_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_arg_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_arg_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
summary(arginine_sy_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Arginine ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    31.93     26.88     6.72   105.72 1.00    15407    20953
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017    148.41     22.57   113.12   201.61 1.00    10667    10906
# Site_YearDauphinRiver_2018     24.18     19.77     1.91    74.54 1.00    10355    11045
# Site_YearMatheson_2017        126.15     25.48    83.35   183.80 1.00    13218    12506
# Site_YearMatheson_2018         38.43     21.05     7.55    89.85 1.00    10350    10859
# Site_YearRedRiver_2017        145.85     23.12   109.37   199.49 1.00    10627    11250
# Site_YearRedRiver_2018         54.15     22.97    18.24   108.16 1.00    10520    11482
# Site_YearSandyBar_2017        145.18     22.26   110.72   198.18 1.00    10485    10646
# Site_YearSandyBar_2018         47.28     22.31    12.90   100.50 1.00    10180    11004
# Site_YearWinnipegRiver_2017   119.50     30.55    64.15   184.48 1.00    15425    16255
# K                              27.53     15.17     3.12    60.68 1.00    22559    29818
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    30.04      3.18    23.72    36.20 1.00    44772    51475
# nu       13.39     10.23     3.35    41.33 1.00    45690    58631
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 1 divergent transitions after warmup. Increasing adapt_delta above 0.99 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
arg_site_year_plot

save(arginine_sy_model , file = "arginine_sy_model.rda")
print(arginine_sy_model)

#### Glutamine Site_Year ####
hist(raw_dataf$Glutamine)
glutamine_sy_model <- brm(data=raw_dataf,
                          family = skew_normal,
                          Glutamine~ -1 + Site_Year + K + (1 | Sex),
                          prior = c(prior(uniform(1,90), lb= 1, ub= 90, class = b),
                                    prior(cauchy(4, 5), class = sigma)),
                          iter = 50000, warmup = 500, chains = 2, cores = 2,
                          control = list(adapt_delta = 0.99, max_treedepth = 10))
pp_check(glutamine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(glutamine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(glutamine_sy_model), points = T)

# Look at the variables available in the model
get_variables(glutamine_sy_model)
# [1] "b_Site_YearDauphinRiver_2017"  "b_Site_YearDauphinRiver_2018" 
# [3] "b_Site_YearMatheson_2017"      "b_Site_YearMatheson_2018"     
# [5] "b_Site_YearRedRiver_2017"      "b_Site_YearRedRiver_2018"     
# [7] "b_Site_YearSandyBar_2017"      "b_Site_YearSandyBar_2018"     
# [9] "b_Site_YearWinnipegRiver_2017" "b_K"                          
# [11] "sd_Sex__Intercept"             "sigma"                        
# [13] "alpha"                         "r_Sex[F,Intercept]"           
# [15] "r_Sex[M,Intercept]"            "r_Sex[UN,Intercept]"          
# [17] "lprior"                        "lp__"                         
# [19] "accept_stat__"                 "stepsize__"                   
# [21] "treedepth__"                   "n_leapfrog__"                 
# [23] "divergent__"                   "energy__"                     
model_dataframe_gln_sy <- glutamine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_gln_sy$Site<- factor(model_dataframe_gln_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

gln_site_year_plot <- ggplot(data = model_dataframe_gln_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_gln_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_gln_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()

summary(glutamine_sy_model)
# Family: skew_normal 
# Links: mu = identity; sigma = identity; alpha = identity 
# Formula: Glutamine ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     8.88     11.08     0.63    33.42 1.00     1767      599
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017     30.45      6.91    20.58    46.28 1.00     1825      603
# Site_YearDauphinRiver_2018     16.58      7.27     6.09    33.41 1.00     1788      608
# Site_YearMatheson_2017         20.10      8.46     6.09    37.96 1.00     1810      602
# Site_YearMatheson_2018         10.61      6.69     1.94    26.30 1.00     1762      593
# Site_YearRedRiver_2017         23.39      6.99    12.92    39.32 1.00     1772      599
# Site_YearRedRiver_2018         13.95      7.28     4.04    30.32 1.00     1748      603
# Site_YearSandyBar_2017         28.00      7.02    18.06    43.82 1.00     1737      604
# Site_YearSandyBar_2018          7.28      6.29     1.20    22.50 1.00     1830      599
# Site_YearWinnipegRiver_2017    34.64      8.37    19.04    52.44 1.00     1878      590
# K                              11.10      5.19     2.33    22.95 1.00     9749    14113
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    14.51      1.02    12.67    16.68 1.00    58827    61692
# alpha     7.00      2.03     3.69    11.60 1.00    48241    47499
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 738 divergent transitions after warmup. Increasing adapt_delta above 0.99 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
gln_site_year_plot
save(glutamine_sy_model, file= "glutamine_sy_model.rda")

#### Glycine Site_Year  ####

hist(raw_dataf$Glycine)
glycine_sy_model <- brm(data=raw_dataf,
                        family = skew_normal,
                        Glycine~ -1 + Site_Year + K + (1 | Sex),
                        prior = c(prior(uniform(1,1400), lb= 1, ub= 1400, class = b),
                                  prior(cauchy(4, 5), class = sigma)),
                        iter = 50000, warmup = 500, chains = 2, cores = 2,
                        control = list(adapt_delta = 0.99, max_treedepth = 12))
pp_check(glycine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(glycine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(glycine_sy_model), points = T)

# Look at the variables available in the model
get_variables(glycine_sy_model)
# [1] "b_Site_YearDauphinRiver_2017"  "b_Site_YearDauphinRiver_2018" 
# [3] "b_Site_YearMatheson_2017"      "b_Site_YearMatheson_2018"     
# [5] "b_Site_YearRedRiver_2017"      "b_Site_YearRedRiver_2018"     
# [7] "b_Site_YearSandyBar_2017"      "b_Site_YearSandyBar_2018"     
# [9] "b_Site_YearWinnipegRiver_2017" "b_K"                          
# [11] "sd_Sex__Intercept"             "sigma"                        
# [13] "alpha"                         "r_Sex[F,Intercept]"           
# [15] "r_Sex[M,Intercept]"            "r_Sex[UN,Intercept]"          
# [17] "lprior"                        "lp__"                         
# [19] "accept_stat__"                 "stepsize__"                   
# [21] "treedepth__"                   "n_leapfrog__"                 
# [23] "divergent__"                   "energy__"                     
model_dataframe_gly_sy <- glycine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_gly_sy$Site<- factor(model_dataframe_gly_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

gly_site_year_plot <- ggplot(data = model_dataframe_gly_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_gly_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_gly_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()

gly_site_year_plot
save(glycine_sy_model, file= "glycine_sy-model.rda")

summary(glycine_sy_model)
# Family: skew_normal 
# Links: mu = identity; sigma = identity; alpha = identity 
# Formula: Glycine ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    79.85     74.93     4.79   271.79 1.00    22317    25605
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017    273.51     95.82   111.15   479.61 1.00     9834    22451
# Site_YearDauphinRiver_2018    292.54     97.07   127.32   501.54 1.00    10040    22528
# Site_YearMatheson_2017        171.09    101.22    14.32   393.22 1.00    10360    19607
# Site_YearMatheson_2018        214.74     92.21    57.46   411.68 1.00     9536    20533
# Site_YearRedRiver_2017        361.38    102.66   186.93   581.23 1.00     9421    21509
# Site_YearRedRiver_2018        283.70     98.70   118.26   496.62 1.00     9334    21381
# Site_YearSandyBar_2017        217.34    100.83    48.03   434.26 1.00     9277    18720
# Site_YearSandyBar_2018        158.80     93.87    15.31   366.37 1.00     9046    19104
# Site_YearWinnipegRiver_2017   327.15    131.50    89.86   600.80 1.00    10961    23878
# K                             213.06     79.83    48.68   355.76 1.00    11371    21409
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma   158.87     11.60   138.03   183.52 1.00    45974    56155
# alpha     4.41      1.71     1.97     8.62 1.00    33098    31318
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 111 divergent transitions after warmup. Increasing adapt_delta above 0.99 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 

#### Histidine Year_Site ####
hist(raw_dataf$Histidine)
histidine_sy_model <- brm(data=raw_dataf,
                          family = skew_normal,
                          Histidine~ -1 + Site_Year + K + (1 | Sex),
                          prior = c(prior(uniform(1,160), lb= 1, ub= 160, class = b),
                                    prior(cauchy(4, 5), class = sigma)),
                          iter = 5000, warmup = 500, chains = 2, cores = 2,
                          control = list(adapt_delta = 0.99, max_treedepth = 10))
pp_check(histidine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(histidine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(histidine_sy_model), points = T)

# Look at the variables available in the model
get_variables(histidine_sy_model)
# [1] "b_Site_YearDauphinRiver_2017"  "b_Site_YearDauphinRiver_2018" 
# [3] "b_Site_YearMatheson_2017"      "b_Site_YearMatheson_2018"     
# [5] "b_Site_YearRedRiver_2017"      "b_Site_YearRedRiver_2018"     
# [7] "b_Site_YearSandyBar_2017"      "b_Site_YearSandyBar_2018"     
# [9] "b_Site_YearWinnipegRiver_2017" "b_K"                          
# [11] "sd_Sex__Intercept"             "sigma"                        
# [13] "alpha"                         "r_Sex[F,Intercept]"           
# [15] "r_Sex[M,Intercept]"            "r_Sex[UN,Intercept]"          
# [17] "lprior"                        "lp__"                         
# [19] "accept_stat__"                 "stepsize__"                   
# [21] "treedepth__"                   "n_leapfrog__"                 
# [23] "divergent__"                   "energy__"
model_dataframe_his_sy <- histidine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_his_sy$Site<- factor(model_dataframe_his_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

his_site_year_plot <- ggplot(data = model_dataframe_his_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_his_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_his_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()

summary(histidine_sy_model)
# Family: skew_normal 
# Links: mu = identity; sigma = identity; alpha = identity 
# Formula: Histidine ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     6.96      7.80     0.19    28.45 1.00    24766    34738
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017     54.45     10.55    36.23    76.94 1.00    14056    21877
# Site_YearDauphinRiver_2018     32.79     10.48    14.61    55.10 1.00    13222    22273
# Site_YearMatheson_2017         37.79     11.91    14.92    61.92 1.00    15943    27242
# Site_YearMatheson_2018         31.20      9.73    14.13    51.80 1.00    12959    22201
# Site_YearRedRiver_2017         35.62     11.28    16.02    59.72 1.00    12249    21619
# Site_YearRedRiver_2018         26.77     10.64     8.44    49.45 1.00    12355    21913
# Site_YearSandyBar_2017         36.41     10.77    17.91    59.50 1.00    12219    21465
# Site_YearSandyBar_2018         13.66      9.12     1.55    34.57 1.00    12585    22142
# Site_YearWinnipegRiver_2017    37.97     14.90    10.77    69.04 1.00    14328    22355
# K                              24.12      8.55     6.18    39.45 1.00    14524    23038
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    21.10      1.53    18.35    24.34 1.00    62807    60681
# alpha     4.96      1.71     2.29     8.95 1.00    44265    39788
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 28 divergent transitions after warmup. Increasing adapt_delta above 0.99 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
his_site_year_plot
save(histidine_sy_model, file= "histidine_sy_model.rda")

#### Isoleucine Year_Site ####
hist(raw_dataf$Isoleucine)
isoleucine_sy_model <- brm(data=raw_dataf,
                           family = student,
                           Isoleucine ~ -1 + Site_Year + K + (1 | Sex),
                           prior = c(prior(uniform(1,550), lb= 1, ub= 550, class = b),
                                     prior(cauchy(4, 5), class = sigma)),
                           iter = 5000, warmup = 1000, chains = 2, cores = 2,
                           control = list(adapt_delta = 0.99, max_treedepth = 10))
pp_check(isoleucine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(isoleucine_sy_model, N = 2, ask = FALSE)
plot(conditional_effects(isoleucine_sy_model), points = T)

# Look at the variables available in the model
get_variables(isoleucine_sy_model)
model_dataframe_iso_sy <- isoleucine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_iso_sy$Site<- factor(model_dataframe_iso_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

iso_site_year_plot <- ggplot(data = model_dataframe_iso_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_iso_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_iso_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()

summary(isoleucine_sy_model)
# Family: student 
# Links: mu = identity; sigma = identity; nu = identity 
# Formula: Isoleucine ~ -1 + Site_Year + K + (1 | Sex) 
# Data: raw_dataf (Number of observations: 122) 
# Draws: 2 chains, each with iter = 50000; warmup = 500; thin = 1;
# total post-warmup draws = 99000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    29.79     26.08     3.43   103.50 1.00     2713      678
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Site_YearDauphinRiver_2017    165.08     48.68   103.87   303.68 1.00     1998      652
# Site_YearDauphinRiver_2018     94.58     32.01    54.27   155.47 1.00     1790      664
# Site_YearMatheson_2017        101.58     45.22    22.64   188.68 1.00     1797      664
# Site_YearMatheson_2018         31.31     29.44     3.45    86.63 1.00     1821      666
# Site_YearRedRiver_2017         39.97     31.95     4.85   101.54 1.00     1776      660
# Site_YearRedRiver_2018         32.68     31.25     2.70    92.75 1.00     1834      670
# Site_YearSandyBar_2017         49.46     31.56    13.99   109.82 1.00     1817      664
# Site_YearSandyBar_2018         41.32     31.56     6.71   101.26 1.00     1814      663
# Site_YearWinnipegRiver_2017    42.96     33.80     4.37   107.81 1.00     1855      666
# K                              45.26     18.95     8.66    85.65 1.00    19352    20089
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma    28.36      4.74    20.30    38.78 1.00     6454     2377
# nu        1.56      0.36     1.06     2.41 1.00    19488    31611
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
iso_site_year_plot
save(isoleucine_sy_model, file= "isoleucine_sy_model.rda")





#### Phe sy year model ####
hist(raw_dataf$Phenylalanine)
phenylalanine_sy_model <- brm(data=raw_dataf,
                              family = student,
                              bf(Phenylalanine ~ -1 + Site_Year + K + (1 | Sex),
                                 sigma ~ Site_Year),
                              prior = c(prior(normal(0,150), lb= 0, class = b)),
                              iter = 5000, warmup = 1000, chains = 4, cores = 4,
                              control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations
pp_check(phenylalanine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(phenylalanine_sy_model, N = 2, ask = FALSE)
summary(phenylalanine_sy_model)
get_variables(phenylalanine_sy_model)
model_dataframe_phe_sy <- phenylalanine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_phe_sy$Site<- factor(model_dataframe_phe_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

phe_site_year_plot <- ggplot(data = model_dataframe_phe_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_phe_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_phe_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "phenylalanine_sy_plot.pdf", plot = phe_site_year_plot, dpi = 900)
summary(phenylalanine_sy_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Phenylalanine ~ -1 + Site_Year + K + (1 | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    18.76     12.19     5.10    51.06 1.00     3908     5643
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.05      0.20     3.67     4.46 1.00     4841     6099
# Site_YearDauphinRiver_2017          103.04     20.17    66.09   146.05 1.00     2891     5569
# Site_YearDauphinRiver_2018           49.89     12.93    30.60    80.12 1.00     1747     3044
# Site_YearMatheson_2017               47.95     17.46    16.67    86.53 1.00     2034     2275
# Site_YearMatheson_2018               14.12     11.36     0.59    41.80 1.00     1548     2883
# Site_YearRedRiver_2017               39.68     15.21    16.39    74.72 1.00     1653     2860
# Site_YearRedRiver_2018               42.48     15.87    16.06    77.80 1.00     1821     3421
# Site_YearSandyBar_2017               43.88     16.18    17.13    79.98 1.00     1846     3717
# Site_YearSandyBar_2018               24.71     13.76     3.89    56.44 1.00     1505     2951
# Site_YearWinnipegRiver_2017          35.03     15.77     9.34    70.53 1.00     1633     2944
# K                                    31.06     12.75     4.42    54.27 1.00     2162     3225
# sigma_Site_YearDauphinRiver_2018     -1.31      0.30    -1.88    -0.72 1.00     6535     8782
# sigma_Site_YearMatheson_2017         -0.92      0.46    -1.73     0.09 1.00     6265     6740
# sigma_Site_YearMatheson_2018         -1.84      0.29    -2.41    -1.27 1.00     6943     9139
# sigma_Site_YearRedRiver_2017         -1.05      0.28    -1.60    -0.50 1.00     7041     9497
# sigma_Site_YearRedRiver_2018         -0.71      0.30    -1.32    -0.13 1.00     6750     8573
# sigma_Site_YearSandyBar_2017         -0.45      0.27    -1.00     0.07 1.00     6615     8964
# sigma_Site_YearSandyBar_2018         -1.34      0.31    -1.93    -0.73 1.00     5895     8578
# sigma_Site_YearWinnipegRiver_2017    -1.90      0.61    -3.08    -0.62 1.00     4198     6816
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    21.03     13.41     5.09    55.28 1.00     9823     9392
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
phe_site_year_plot
save(phenylalanine_sy_model, file= "phenylalanine_sy_model.rda")
#### Pro sy year model ####
hist(raw_dataf$Proline)
proline_sy_model <- brm(data=raw_dataf,
                        family = student,
                        bf(Proline ~ -1 + Site_Year + K + (1 | Sex),
                           sigma ~ Site_Year),
                        prior = c(prior(normal(0,200), lb= 0, class = b)),
                        iter = 5000, warmup = 1000, chains = 4, cores = 4,
                        control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations
pp_check(proline_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(proline_sy_model, N = 2, ask = FALSE)
summary(proline_sy_model)
get_variables(proline_sy_model)
model_dataframe_pro_sy <- proline_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_pro_sy$Site<- factor(model_dataframe_pro_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

pro_site_year_plot <- ggplot(data = model_dataframe_pro_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_phe_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_pro_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "proline_sy_plot.pdf", plot = pro_site_year_plot, dpi = 900)
summary(proline_sy_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Proline ~ -1 + Site_Year + K + (1 | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    27.87     22.54     6.39    95.27 1.00     1136      308
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.57      0.23     4.11     5.02 1.00     4762     8656
# Site_YearDauphinRiver_2017          154.06     32.80    91.40   221.32 1.00     5168     6953
# Site_YearDauphinRiver_2018          103.47     17.44    72.59   142.00 1.00     3280     3624
# Site_YearMatheson_2017              103.18     46.53    19.12   204.92 1.00     5907     3718
# Site_YearMatheson_2018               19.33     13.26     1.75    51.05 1.00     1442     1004
# Site_YearRedRiver_2017               72.13     15.29    48.01   107.63 1.00     2546     2904
# Site_YearRedRiver_2018               16.44     13.19     0.77    48.91 1.00     2095     2769
# Site_YearSandyBar_2017               62.45     17.63    33.13   101.39 1.00     3057     3660
# Site_YearSandyBar_2018               21.72     14.31     2.04    55.31 1.00     1883     2259
# Site_YearWinnipegRiver_2017         113.98     18.60    83.37   155.30 1.00     2942     3851
# K                                    28.35     16.51     3.46    67.46 1.00      878      301
# sigma_Site_YearDauphinRiver_2018     -0.94      0.37    -1.66    -0.22 1.00     2386     2333
# sigma_Site_YearMatheson_2017         -0.18      0.50    -1.15     0.84 1.00     7891     9945
# sigma_Site_YearMatheson_2018         -1.77      0.37    -2.50    -1.03 1.00     6345     8792
# sigma_Site_YearRedRiver_2017         -1.49      0.35    -2.17    -0.81 1.00     5248     9458
# sigma_Site_YearRedRiver_2018         -2.24      0.40    -3.03    -1.47 1.00     5696     8212
# sigma_Site_YearSandyBar_2017         -0.89      0.34    -1.58    -0.24 1.00     5434     8829
# sigma_Site_YearSandyBar_2018         -1.56      0.38    -2.33    -0.85 1.00     6413     8489
# sigma_Site_YearWinnipegRiver_2017    -1.81      0.64    -3.03    -0.48 1.00     7672     8078
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     4.00      3.11     1.65    11.05 1.00     5800     6776
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# > pro_site_year_plot
pro_site_year_plot
save(proline_sy_model, file= "proline_sy_model.rda")



#### Ser sy year model ####
hist(raw_dataf$Serine)
serine_sy_model <- brm(data=raw_dataf,
                       family = student,
                       bf(Serine ~ -1 + Site_Year + K + (1 | Sex),
                          sigma ~ Site_Year),
                       prior = c(prior(normal(0,150), lb= 0, class = b)),
                       iter = 5000, warmup = 1000, chains = 4, cores = 4,
                       control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations
pp_check(serine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(serine_sy_model, N = 2, ask = FALSE)
summary(serine_sy_model)
get_variables(serine_sy_model)
model_dataframe_ser_sy <- serine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_ser_sy$Site<- factor(model_dataframe_ser_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

ser_site_year_plot <- ggplot(data = model_dataframe_ser_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_ser_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_ser_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "serine_sy_plot.pdf", plot = ser_site_year_plot, dpi = 900)
summary(serine_sy_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Serine ~ -1 + Site_Year + K + (1 | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    13.70     13.97     0.46    52.78 1.00     4227     5382
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.32      0.25     2.83     3.80 1.00     3972     5966
# Site_YearDauphinRiver_2017           44.29     16.96    13.05    80.76 1.00     1793     2038
# Site_YearDauphinRiver_2018           37.52     16.09     7.78    72.20 1.00     1800     2021
# Site_YearMatheson_2017               43.89     19.03     8.37    83.56 1.00     2553     3155
# Site_YearMatheson_2018               40.90     14.21    14.59    71.39 1.00     1643     1881
# Site_YearRedRiver_2017               76.80     19.77    39.29   118.11 1.00     1800     2430
# Site_YearRedRiver_2018               75.68     21.86    35.17   121.01 1.00     2699     4718
# Site_YearSandyBar_2017               52.23     17.71    19.07    89.76 1.00     1878     2850
# Site_YearSandyBar_2018               44.48     19.81     8.66    86.45 1.00     2775     3662
# Site_YearWinnipegRiver_2017          17.20     16.42     0.50    57.52 1.00     4404     6520
# K                                    52.16     15.39    21.24    83.14 1.00     1909     3910
# sigma_Site_YearDauphinRiver_2018     -0.01      0.32    -0.63     0.62 1.00     6269     8357
# sigma_Site_YearMatheson_2017         -0.11      0.49    -1.01     0.91 1.00     6518     8896
# sigma_Site_YearMatheson_2018         -0.47      0.32    -1.10     0.16 1.00     5730     7349
# sigma_Site_YearRedRiver_2017          0.29      0.30    -0.30     0.90 1.00     5768     8012
# sigma_Site_YearRedRiver_2018          0.66      0.33     0.00     1.32 1.00     5136     7643
# sigma_Site_YearSandyBar_2017          0.25      0.29    -0.33     0.84 1.00     5580     7525
# sigma_Site_YearSandyBar_2018          0.57      0.34    -0.07     1.24 1.00     5202     7930
# sigma_Site_YearWinnipegRiver_2017    -0.20      0.62    -1.25     1.17 1.00     4175     6162
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    14.47     11.25     3.23    45.28 1.00     8009     9940
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
ser_site_year_plot
save(serine_sy_model, file= "serine_sy_model.rda")







#### Val sy year model ####
hist(raw_dataf$Valine)
valine_sy_model <- brm(data=raw_dataf,
                       family = student,
                       bf(Valine ~ -1 + Site_Year + K + (1 | Sex),
                          sigma ~ Site_Year),
                       prior = c(prior(normal(0,450), lb= 0, class = b)),
                       iter = 5000, warmup = 1000, chains = 4, cores = 4,
                       control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations
pp_check(valine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(valine_sy_model, N = 2, ask = FALSE)
summary(valine_sy_model)
get_variables(valine_sy_model)
model_dataframe_val_sy <- valine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_val_sy$Site<- factor(model_dataframe_val_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

val_site_year_plot <- ggplot(data = model_dataframe_val_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_val_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_val_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "valine_sy_plot.pdf", plot = val_site_year_plot, dpi = 900)
summary(valine_sy_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Valine ~ -1 + Site_Year + K + (1 | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    51.05     37.18    10.27   149.21 1.00     2107      658
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       5.42      0.21     5.03     5.85 1.00     5779     8090
# Site_YearDauphinRiver_2017          397.80     69.75   263.26   536.53 1.00     5491     7137
# Site_YearDauphinRiver_2018          215.95     43.82   136.68   307.25 1.00     2885     3470
# Site_YearMatheson_2017              187.86     83.10    37.91   365.70 1.00     4986     3712
# Site_YearMatheson_2018               40.84     28.46     3.20   113.63 1.00     1392      545
# Site_YearRedRiver_2017               68.65     33.28    17.58   146.93 1.00     1624     1547
# Site_YearRedRiver_2018               49.69     31.92     4.62   127.01 1.00     1611     1136
# Site_YearSandyBar_2017              107.03     44.92    31.70   207.38 1.00     2392     2987
# Site_YearSandyBar_2018               54.56     31.81     7.56   133.44 1.00     1614      823
# Site_YearWinnipegRiver_2017          46.52     35.34     2.17   132.08 1.00     2420     3147
# K                                    82.91     29.31    24.78   145.03 1.00     2247      808
# sigma_Site_YearDauphinRiver_2018     -0.69      0.31    -1.32    -0.08 1.00     6655     8395
# sigma_Site_YearMatheson_2017         -0.40      0.47    -1.26     0.60 1.00     5349     6211
# sigma_Site_YearMatheson_2018         -1.89      0.30    -2.49    -1.30 1.00     6799     9647
# sigma_Site_YearRedRiver_2017         -1.72      0.32    -2.38    -1.13 1.00     5091     7771
# sigma_Site_YearRedRiver_2018         -1.81      0.32    -2.47    -1.19 1.00     6973     9188
# sigma_Site_YearSandyBar_2017         -0.74      0.39    -1.60    -0.06 1.00     4845     7900
# sigma_Site_YearSandyBar_2018         -1.74      0.32    -2.36    -1.09 1.00     5648     9432
# sigma_Site_YearWinnipegRiver_2017    -1.93      0.60    -3.05    -0.68 1.00     3520     2374
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    11.03     10.42     2.26    40.01 1.00     4250     9748
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 26 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
val_site_year_plot
save(valine_sy_model, file= "valine_sy_model.rda")

#### tyr sy year model ####
hist(raw_dataf$Tyrosine)
tyrosine_sy_model <- brm(data=raw_dataf,
                         family = student,
                         bf(Histidine ~ -1 + Site_Year + K + (1 | Sex),
                            sigma ~ Site_Year),
                         prior = c(prior(normal(0,200), lb= 0, class = b)),
                         iter = 5000, warmup = 1000, chains = 4, cores = 4,
                         control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations
pp_check(tyrosine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(tyrosine_sy_model, N = 2, ask = FALSE)
summary(tyrosine_sy_model)
get_variables(tyrosine_sy_model)
model_dataframe_tyr_sy <- tyrosine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_tyr_sy$Site<- factor(model_dataframe_tyr_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

tyr_site_year_plot <- ggplot(data = model_dataframe_tyr_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_tyr_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_tyr_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "tyrosine_sy_plot.pdf", plot = tyr_site_year_plot, dpi = 900)
summary(tyrosine_sy_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Histidine ~ -1 + Site_Year + K + (1 | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    19.51     16.76     1.98    63.71 1.00     2172     3815
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.24      0.20     2.86     3.65 1.00     4960     6523
# Site_YearDauphinRiver_2017           59.23     11.20    40.15    85.22 1.00     3044     2803
# Site_YearDauphinRiver_2018           30.57     10.41    13.89    55.34 1.00     2378     2353
# Site_YearMatheson_2017               34.89     13.91    10.45    66.00 1.00     3292     3968
# Site_YearMatheson_2018               24.16     10.07     8.73    48.62 1.00     2394     1826
# Site_YearRedRiver_2017               24.57     10.53     7.37    49.01 1.00     2720     3320
# Site_YearRedRiver_2018               23.29     10.20     6.94    47.53 1.00     2493     2276
# Site_YearSandyBar_2017               28.45     10.00    12.65    51.92 1.00     2600     2189
# Site_YearSandyBar_2018                8.06      8.14     0.21    30.26 1.00     2263     1943
# Site_YearWinnipegRiver_2017          43.47     24.41     5.54    99.62 1.00     5754     4308
# K                                    36.68     13.36    15.49    68.27 1.00     2766     4831
# sigma_Site_YearDauphinRiver_2018     -0.35      0.29    -0.91     0.22 1.00     6574     8604
# sigma_Site_YearMatheson_2017         -0.24      0.47    -1.09     0.75 1.00     7447     8400
# sigma_Site_YearMatheson_2018         -0.43      0.29    -1.02     0.15 1.00     6713     8850
# sigma_Site_YearRedRiver_2017         -0.22      0.30    -0.81     0.36 1.00     6564     8392
# sigma_Site_YearRedRiver_2018         -0.33      0.29    -0.89     0.23 1.00     6840     8603
# sigma_Site_YearSandyBar_2017         -0.29      0.27    -0.83     0.24 1.00     6276     9193
# sigma_Site_YearSandyBar_2018         -0.76      0.34    -1.43    -0.11 1.00     5973     8371
# sigma_Site_YearWinnipegRiver_2017     0.45      0.52    -0.46     1.59 1.00     7272     7764
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    17.30     11.99     4.26    49.14 1.00     8234    10255
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 22 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
tyr_site_year_plot
save(tyrosine_sy_model, file= "tyrosine_sy_model.rda")

#### Threonine sy model ####
hist(raw_dataf$Threonine)
threonine_sy_model <- brm(data=raw_dataf,
                          family = skew_normal,
                          bf(Threonine ~ -1 + Site_Year + K + (1 | Sex),
                             sigma ~ Site_Year),
                          prior = c(prior(normal(0,175), lb= 0, class = b)),
                          iter = 5000, warmup = 1000, chains = 4, cores = 4,
                          control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations
pp_check(threonine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(threonine_sy_model, N = 2, ask = FALSE)
summary(threonine_sy_model)
get_variables(threonine_sy_model)
model_dataframe_thr_sy <- threonine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_thr_sy$Site<- factor(model_dataframe_thr_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))
thr_site_year_plot <- ggplot(data = model_dataframe_thr_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_thr_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_thr_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "threonine_sy_plot.pdf", plot = thr_site_year_plot, dpi = 900)
summary(threonine_sy_model)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Threonine ~ -1 + Site_Year + K + (1 | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)    29.60     20.96     6.24    86.27 1.00     5907     8191
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.00      0.19     3.66     4.41 1.00     4778     5602
# Site_YearDauphinRiver_2017          116.08     22.85    76.54   165.95 1.00     2989     5147
# Site_YearDauphinRiver_2018           65.71     21.69    27.76   112.83 1.00     3291     6396
# Site_YearMatheson_2017              109.72     47.46    28.38   218.75 1.00     5741     4588
# Site_YearMatheson_2018               71.69     20.27    35.64   115.06 1.00     3259     6352
# Site_YearRedRiver_2017               91.24     20.59    57.29   137.01 1.00     2526     4651
# Site_YearRedRiver_2018               57.21     23.87    15.56   109.59 1.00     3182     5689
# Site_YearSandyBar_2017               72.99     21.45    36.34   119.80 1.00     2912     5401
# Site_YearSandyBar_2018               23.29     17.38     0.98    64.63 1.00     2551     5244
# Site_YearWinnipegRiver_2017          68.04     43.65     6.33   173.81 1.00     5229     5557
# K                                    54.60     17.88    17.61    87.79 1.00     3390     3483
# sigma_Site_YearDauphinRiver_2018     -0.06      0.28    -0.61     0.49 1.00     6541     8167
# sigma_Site_YearMatheson_2017          0.51      0.42    -0.25     1.42 1.00     8600    10107
# sigma_Site_YearMatheson_2018         -0.19      0.28    -0.74     0.35 1.00     6485     8181
# sigma_Site_YearRedRiver_2017         -0.71      0.26    -1.23    -0.19 1.00     6731     8710
# sigma_Site_YearRedRiver_2018          0.09      0.29    -0.47     0.67 1.00     5989     8944
# sigma_Site_YearSandyBar_2017         -0.13      0.25    -0.63     0.37 1.00     6356     7598
# sigma_Site_YearSandyBar_2018         -0.69      0.32    -1.31    -0.06 1.00     6158     8801
# sigma_Site_YearWinnipegRiver_2017     0.38      0.49    -0.47     1.44 1.00     8476     8662
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.64      1.69     1.83     8.47 1.00     9780     9300
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 16 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
thr_site_year_plot
save(threonine_sy_model, file= "threonine_sy_model.rda")

#### Tryp sy model ####
hist(raw_dataf$Tryptophan)
tryptophan_sy_model <- brm(data=raw_dataf,
                           family = student,
                           bf(Tryptophan ~ -1 + Site_Year + K + (1 | Sex),
                              sigma ~ Site_Year),
                           prior = c(prior(normal(0,25), lb= 0, class = b)),
                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
                           control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations
pp_check(tryptophan_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(tryptophan_sy_model, N = 2, ask = FALSE)
summary(tryptophan_sy_model)
get_variables(tryptophan_sy_model)
model_dataframe_trp_sy <- tryptophan_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_trp_sy$Site<- factor(model_dataframe_trp_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))
trp_site_year_plot <- ggplot(data = model_dataframe_trp_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_trp_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_trp_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "tryptophan_sy_plot.pdf", plot = trp_site_year_plot, dpi = 900)
summary(tryptophan_sy_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Tryptophan ~ -1 + Site_Year + K + (1 | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 5000; warmup = 1000; thin = 1;
# total post-warmup draws = 16000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)     3.05      2.61     0.19     9.95 1.00     4304     4865
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       2.29      0.20     1.93     2.70 1.00     4990     6611
# Site_YearDauphinRiver_2017           17.72      3.44    11.34    24.92 1.00     3922     6984
# Site_YearDauphinRiver_2018           19.50      3.45    12.99    26.56 1.00     4572     8214
# Site_YearMatheson_2017               10.91      4.57     2.48    20.62 1.00     4879     3762
# Site_YearMatheson_2018                4.11      2.19     0.52     9.13 1.00     2350     3111
# Site_YearRedRiver_2017                6.05      2.75     1.30    12.11 1.00     2386     3666
# Site_YearRedRiver_2018                7.02      2.63     2.40    12.86 1.00     2706     5259
# Site_YearSandyBar_2017                6.29      2.74     1.56    12.29 1.00     2729     4319
# Site_YearSandyBar_2018                2.46      2.05     0.08     7.55 1.00     2490     4897
# Site_YearWinnipegRiver_2017           8.08      3.58     1.74    15.87 1.00     2541     2839
# K                                    10.10      2.41     5.03    14.90 1.00     3207     4632
# sigma_Site_YearDauphinRiver_2018     -0.02      0.28    -0.56     0.55 1.00     7040     9110
# sigma_Site_YearMatheson_2017         -0.17      0.44    -0.97     0.77 1.00     7959     9356
# sigma_Site_YearMatheson_2018         -0.98      0.29    -1.53    -0.41 1.00     6937     8794
# sigma_Site_YearRedRiver_2017         -0.67      0.28    -1.22    -0.12 1.00     6430     8351
# sigma_Site_YearRedRiver_2018         -0.68      0.29    -1.26    -0.09 1.00     6549     8532
# sigma_Site_YearSandyBar_2017         -0.40      0.27    -0.94     0.12 1.00     6448     8124
# sigma_Site_YearSandyBar_2018         -0.95      0.31    -1.56    -0.35 1.00     6389     8302
# sigma_Site_YearWinnipegRiver_2017    -0.87      0.52    -1.79     0.28 1.00     7374     7722
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    20.94     13.26     4.90    54.88 1.00    10109     8623
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 13 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
trp_site_year_plot
save(tryptophan_sy_model, file= "tryptophan_sy_model.rda")



library(tools)
#### intercepts and random slopes models ####
#### Lysine Year_Site RS ####
hist(raw_dataf$Lysine)
lysine_sy_model <- brm(data=raw_dataf,
                       family = student,
                       bf(Lysine ~ -1 + Site_Year + K + (Site_Year | Sex),
                          sigma ~ Site_Year),
                       prior = c(prior(normal(225,50), lb= 0, class = b)),
                       iter = 50000, warmup = 10000, chains = 4, cores = 4,
                       control = list(adapt_delta = 0.95, max_treedepth = 15))

  pp_check(lysine_sy_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(lysine_sy_model, N = 2, ask = FALSE)
 summary(lysine_sy_model)
 # Family: student 
 # Links: mu = identity; sigma = log; nu = identity 
 # Formula: Lysine ~ -1 + Site_Year + K + (Site_Year | Sex) 
 # sigma ~ Site_Year
 # Data: raw_dataf (Number of observations: 122) 
 # Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
 # total post-warmup draws = 160000
 # 
 # Group-Level Effects: 
 #   ~Sex (Number of levels: 3) 
 # Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
 # sd(Intercept)                                                 201.09     88.83    85.83   422.45 1.00    50997    65472
 # sd(Site_YearDauphinRiver_2018)                                 57.54     61.09     1.67   202.77 1.00    16456     9599
 # sd(Site_YearMatheson_2017)                                     67.73     64.03     2.40   230.33 1.00    87982    78300
 # sd(Site_YearMatheson_2018)                                     75.07     69.14     2.38   252.17 1.00    50516    71486
 # sd(Site_YearRedRiver_2017)                                     50.33     52.54     1.48   189.15 1.00    84980    77952
 # sd(Site_YearRedRiver_2018)                                     67.69     67.34     1.84   240.03 1.00    58969    74623
 # sd(Site_YearSandyBar_2017)                                     60.34     60.10     1.91   216.00 1.00    82733    75240
 # sd(Site_YearSandyBar_2018)                                     54.91     49.94     2.38   183.93 1.00    55252    70411
 # sd(Site_YearWinnipegRiver_2017)                                99.67     98.63     3.40   342.60 1.00   106642    73776
 # cor(Intercept,Site_YearDauphinRiver_2018)                       0.11      0.32    -0.52     0.69 1.00   135633   114998
 # cor(Intercept,Site_YearMatheson_2017)                          -0.04      0.31    -0.63     0.56 1.00   177644   115600
 # cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.02      0.32    -0.62     0.59 1.00   161154   116700
 # cor(Intercept,Site_YearMatheson_2018)                           0.09      0.31    -0.52     0.66 1.00   163992   117167
 # cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.09      0.32    -0.54     0.67 1.00   128864   116515
 # cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.02      0.32    -0.62     0.58 1.00    84528    19363
 # cor(Intercept,Site_YearRedRiver_2017)                          -0.03      0.32    -0.63     0.58 1.00   172548   118725
 # cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.01      0.32    -0.60     0.61 1.00   145285   119028
 # cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.01      0.32    -0.60     0.61 1.00   145542   121974
 # cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.60 1.00   130969   122756
 # cor(Intercept,Site_YearRedRiver_2018)                           0.09      0.31    -0.52     0.67 1.00   152792   115429
 # cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.06      0.32    -0.56     0.65 1.00   120226   119707
 # cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.60 1.00   140384   124816
 # cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.04      0.31    -0.57     0.63 1.00   127213   126858
 # cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.60 1.00   107871   128249
 # cor(Intercept,Site_YearSandyBar_2017)                          -0.06      0.32    -0.64     0.56 1.00   171712   118485
 # cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.02      0.32    -0.62     0.59 1.00   158557   119227
 # cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.63 1.00   143424   121474
 # cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.02      0.31    -0.61     0.58 1.00   130149   128381
 # cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.62 1.00   118628   128087
 # cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.01      0.32    -0.62     0.60 1.00   104360   128512
 # cor(Intercept,Site_YearSandyBar_2018)                           0.10      0.32    -0.52     0.68 1.00   164674   116703
 # cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.07      0.32    -0.56     0.66 1.00   134201   121033
 # cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.01      0.32    -0.60     0.61 1.00   137013   122746
 # cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.03      0.32    -0.58     0.64 1.00   122104   126316
 # cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.01      0.32    -0.61     0.60 1.00   115564   130474
 # cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.06      0.32    -0.57     0.65 1.00    26693     9871
 # cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.00      0.32    -0.61     0.60 1.00   101301   126617
 # cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.04      0.31    -0.63     0.56 1.00   170278   114079
 # cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.03      0.31    -0.62     0.57 1.00   173926   122997
 # cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.02      0.32    -0.59     0.62 1.00   150021   122090
 # cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.02      0.31    -0.62     0.58 1.00   134278   124462
 # cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.60     0.61 1.00   115422   127852
 # cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.01      0.32    -0.61     0.59 1.00   100371   126135
 # cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.02      0.32    -0.59     0.61 1.00    98731   125684
 # cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   102679   123077
 # 
 # Population-Level Effects: 
 #   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
 # sigma_Intercept                       4.54      0.23     4.10     5.00 1.00    57290    76459
 # Site_YearDauphinRiver_2017          317.67     31.69   252.82   377.88 1.00    74072    76977
 # Site_YearDauphinRiver_2018          151.63     42.57    83.10   251.23 1.00    24433     9922
 # Site_YearMatheson_2017              246.42     40.18   163.14   321.72 1.00   103543    85373
 # Site_YearMatheson_2018              174.58     43.87   100.88   271.04 1.00    75179    90182
 # Site_YearRedRiver_2017              240.95     35.01   167.63   306.98 1.00    80815    75927
 # Site_YearRedRiver_2018              173.44     42.21   101.99   268.50 1.00    56700     9586
 # Site_YearSandyBar_2017              257.14     38.72   173.69   327.00 1.00    88714    81303
 # Site_YearSandyBar_2018              170.68     37.43   105.26   254.47 1.00    80847    84471
 # Site_YearWinnipegRiver_2017         242.37     46.08   149.94   330.00 1.00    83355    73612
 # K                                    76.55     24.84    30.02   126.98 1.00    83233    70633
 # sigma_Site_YearDauphinRiver_2018     -2.31      0.34    -2.96    -1.64 1.00    73333    93976
 # sigma_Site_YearMatheson_2017         -0.43      0.53    -1.49     0.64 1.00    90085    78978
 # sigma_Site_YearMatheson_2018         -1.83      0.32    -2.46    -1.19 1.00    76756    95108
 # sigma_Site_YearRedRiver_2017         -0.93      0.30    -1.52    -0.35 1.00    78290    94160
 # sigma_Site_YearRedRiver_2018         -1.43      0.31    -2.03    -0.82 1.00    81733    98682
 # sigma_Site_YearSandyBar_2017         -0.27      0.29    -0.86     0.29 1.00    77360    89825
 # sigma_Site_YearSandyBar_2018         -1.41      0.31    -2.02    -0.78 1.00    76593    91835
 # sigma_Site_YearWinnipegRiver_2017     0.16      0.52    -0.77     1.29 1.00   103136    96980
 # 
 # Family Specific Parameters: 
 #   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
 # nu    18.27     13.37     3.09    52.78 1.00    85786    65444
 # 
 # Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
 # and Tail_ESS are effective sample size measures, and Rhat is the potential
 # scale reduction factor on split chains (at convergence, Rhat = 1).
plot(conditional_effects(lysine_sy_model), points = T)

# Look at the variables available in the model
get_variables(lysine_sy_model)
model_dataframe_lys_sy <- lysine_sy_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_lys_sy$Site<- factor(model_dataframe_lys_sy$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

lys_site_year_plot <- ggplot(data = model_dataframe_lys_sy, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_lys_sy, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_lys_sy, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "lysine_rm_plot.pdf", plot = lys_site_year_plot, dpi = 900)
summary(lysine_sy_model)
lys_site_year_plot
save(lysine_sy_model, file= "lysine_rm_sy_model.rda")
load(lysine_sy_model)
#### Arginine Year_Site RS ####
hist(raw_dataf$Arginine)
arginine_syrm_model <- brm(data=raw_dataf,
                           family = student,
                           bf(Arginine ~ -1 + Site_Year + K + (Site_Year | Sex),
                              sigma ~ Site_Year),
                           prior = c(prior(normal(150,25), lb= 0, class = b)),
                           iter = 50000, warmup = 10000, chains = 4, cores = 4,
                           control = list(adapt_delta = 0.96, max_treedepth = 15))


pp_check(arginine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(arginine_syrm_model, N = 2, ask = FALSE)
summary(arginine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Arginine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                 110.85     56.31    32.70   248.70 1.00    61574    51760
# sd(Site_YearDauphinRiver_2018)                                 65.65     45.84     3.87   175.47 1.00    50559    56516
# sd(Site_YearMatheson_2017)                                     36.25     37.09     1.11   132.28 1.00   109579    88933
# sd(Site_YearMatheson_2018)                                     65.95     50.44     4.86   189.23 1.00    62845    60171
# sd(Site_YearRedRiver_2017)                                     40.54     39.38     1.30   141.88 1.00    92168    87655
# sd(Site_YearRedRiver_2018)                                     78.81     50.74    15.18   205.72 1.00    75855    61638
# sd(Site_YearSandyBar_2017)                                     39.36     38.66     1.18   140.24 1.00    86906    84474
# sd(Site_YearSandyBar_2018)                                     67.92     39.94    14.26   167.53 1.00    71046    64819
# sd(Site_YearWinnipegRiver_2017)                                56.79     58.54     1.81   205.12 1.00   137665    84704
# cor(Intercept,Site_YearDauphinRiver_2018)                       0.18      0.30    -0.43     0.72 1.00   155193   114197
# cor(Intercept,Site_YearMatheson_2017)                          -0.02      0.32    -0.62     0.59 1.00   222254   116106
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.01      0.32    -0.61     0.60 1.00   199211   124085
# cor(Intercept,Site_YearMatheson_2018)                           0.11      0.30    -0.49     0.66 1.00   195914   119038
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.13      0.31    -0.49     0.69 1.00   162606   122794
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.01      0.31    -0.60     0.60 1.00   147958   129126
# cor(Intercept,Site_YearRedRiver_2017)                          -0.06      0.32    -0.65     0.55 1.00   210409   107131
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.04      0.32    -0.63     0.57 1.00   190969   118915
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.02      0.32    -0.59     0.62 1.00   154577   118154
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)             -0.02      0.31    -0.62     0.58 1.00   139775   126925
# cor(Intercept,Site_YearRedRiver_2018)                           0.10      0.30    -0.49     0.65 1.00   207301   120797
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.11      0.31    -0.50     0.67 1.00   160026   122744
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.60 1.00   146967   126918
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.04      0.31    -0.56     0.63 1.00   130622   130596
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.06      0.31    -0.64     0.55 1.00   123439   131821
# cor(Intercept,Site_YearSandyBar_2017)                          -0.07      0.32    -0.65     0.55 1.00   214381   116741
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.04      0.31    -0.63     0.57 1.00   187477   122988
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   156176   124971
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.02      0.31    -0.62     0.58 1.00   138366   125867
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.04      0.32    -0.58     0.64 1.00   121819   130200
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.05      0.31    -0.64     0.56 1.00   118080   132352
# cor(Intercept,Site_YearSandyBar_2018)                           0.13      0.29    -0.46     0.67 1.00   193154   116836
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.15      0.31    -0.47     0.70 1.00   146590   119611
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.01      0.32    -0.61     0.59 1.00   138243   128282
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.07      0.32    -0.54     0.66 1.00   119715   128297
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.07      0.31    -0.64     0.54 1.00   115763   131095
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.17      0.30    -0.44     0.70 1.00   117534   132126
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.06      0.31    -0.64     0.55 1.00   109270   129688
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.31    -0.60     0.60 1.00   251141   115171
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.00      0.31    -0.60     0.60 1.00   198494   121267
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   163624   120054
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.31    -0.60     0.60 1.00   147597   124808
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   125504   123657
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.61     0.61 1.00   123666   130477
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   103427   127546
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   108406   132883
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.67      0.20     3.29     4.09 1.00    80733    89983
# Site_YearDauphinRiver_2017          175.22     18.20   139.42   210.56 1.00    62076    82461
# Site_YearDauphinRiver_2018          121.38     26.83    72.99   175.64 1.00    79668    88673
# Site_YearMatheson_2017              154.06     20.89   112.47   194.75 1.00   132242   109225
# Site_YearMatheson_2018              131.00     24.87    84.94   181.48 1.00   116894    93561
# Site_YearRedRiver_2017              163.45     20.76   120.28   202.06 1.00   124414   105635
# Site_YearRedRiver_2018              136.78     23.95    91.40   185.12 1.00   161420   106569
# Site_YearSandyBar_2017              164.50     20.86   120.96   203.07 1.00   116435    99395
# Site_YearSandyBar_2018              131.93     23.63    87.33   179.89 1.00   147994   103730
# Site_YearWinnipegRiver_2017         149.85     22.93   104.70   194.88 1.00   206270   104361
# K                                    75.32     19.52    36.42   113.43 1.00   100854    58517
# sigma_Site_YearDauphinRiver_2018     -0.67      0.30    -1.27    -0.07 1.00   104643   111927
# sigma_Site_YearMatheson_2017         -0.05      0.46    -0.87     0.94 1.00   132455   109972
# sigma_Site_YearMatheson_2018         -0.71      0.30    -1.29    -0.12 1.00   102964   113423
# sigma_Site_YearRedRiver_2017         -0.36      0.28    -0.93     0.20 1.00   100703   109722
# sigma_Site_YearRedRiver_2018         -0.16      0.30    -0.75     0.44 1.00   100821   110618
# sigma_Site_YearSandyBar_2017         -0.16      0.27    -0.71     0.37 1.00    97502   108078
# sigma_Site_YearSandyBar_2018         -0.49      0.30    -1.07     0.11 1.00   102160   110757
# sigma_Site_YearWinnipegRiver_2017     0.63      0.48    -0.22     1.68 1.00   139403   107087
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    20.96     13.50     4.77    55.38 1.00   157606   104184
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
plot(conditional_effects(arginine_syrm_model), points = T)

# Look at the variables available in the model
get_variables(arginine_syrm_model)
model_dataframe_arg_syrm <- arginine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_arg_syrm$Site<- factor(model_dataframe_arg_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

argrm_site_year_plot <- ggplot(data = model_dataframe_arg_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_arg_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_arg_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "arginine_rm_plot.pdf", plot = argtm_site_year_plot, dpi = 900)
summary(arginine_syrm_model)
argrm_site_year_plot
save(arginine_syrm_model, file= "arginine_syrm_model.rda")

#### Asparagine Year_Site RS ####
hist(raw_dataf$Asparagine)
asparagine_syrm_model <- brm(data=raw_dataf,
                             family = student,
                             bf(Asparagine ~ -1 + Site_Year + K + (Site_Year | Sex),
                                sigma ~ Site_Year),
                             prior = c(prior(normal(0,20), lb= 0, class = b)),
                             iter = 50000, warmup = 10000, chains = 4, cores = 4,
                             control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(asparagine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(asparagine_syrm_model, N = 2, ask = FALSE)
summary(asparagine_syrm_model)
plot(conditional_effects(asparagine_syrm_model), points = T)

# Look at the variables available in the model 
get_variables(asparagine_syrm_model)
model_dataframe_asn_syrm <- asparagine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_asn_syrm$Site<- factor(model_dataframe_asn_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

asnrm_site_year_plot <- ggplot(data = model_dataframe_asn_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_asn_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_asn_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "asparagine_syrm_plot.pdf", plot = asnrm_site_year_plot, dpi = 900)
summary(asparagine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Asparagine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                   0.17      0.28     0.00     0.66 3.10        5       15
# sd(Site_YearDauphinRiver_2018)                                  6.92     10.57     0.02    25.31 3.23        4       14
# sd(Site_YearMatheson_2017)                                      3.42      1.66     1.83     6.34 3.12        5       19
# sd(Site_YearMatheson_2018)                                      1.06      0.65     0.04     1.90 3.71        4       16
# sd(Site_YearRedRiver_2017)                                      0.01      0.02     0.00     0.04 3.78        4       11
# sd(Site_YearRedRiver_2018)                                      0.03      0.05     0.00     0.12 3.41        4       12
# sd(Site_YearSandyBar_2017)                                      0.29      0.49     0.00     1.15 3.07        5       13
# sd(Site_YearSandyBar_2018)                                      0.10      0.06     0.02     0.19 3.53        4       11
# sd(Site_YearWinnipegRiver_2017)                                 1.70      1.49     0.30     4.40 3.40        4       11
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.22      0.16    -0.41     0.10 1.95        5       16
# cor(Intercept,Site_YearMatheson_2017)                           0.01      0.51    -0.88     0.60 2.55        5       11
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.12      0.31    -0.54     0.43 3.25        4       11
# cor(Intercept,Site_YearMatheson_2018)                           0.31      0.21    -0.03     0.61 2.82        5       11
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)         -0.22      0.29    -0.64     0.22 3.68        4       11
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.23      0.28    -0.17     0.53 2.36        5       29
# cor(Intercept,Site_YearRedRiver_2017)                          -0.02      0.11    -0.16     0.12 2.93        5       24
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.20      0.27    -0.60     0.10 3.01        5       22
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.15      0.30    -0.37     0.40 3.14        5       25
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.10      0.35    -0.28     0.69 3.54        4       17
# cor(Intercept,Site_YearRedRiver_2018)                          -0.01      0.32    -0.41     0.45 3.14        5       38
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.16      0.16    -0.05     0.39 3.21        4       11
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.15      0.29    -0.31     0.51 3.40        4       11
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)             -0.23      0.10    -0.44    -0.14 3.14        5       12
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.04      0.24    -0.33     0.40 3.61        4       11
# cor(Intercept,Site_YearSandyBar_2017)                           0.09      0.12    -0.11     0.27 3.32        4       11
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)          0.10      0.25    -0.12     0.54 2.81        5       11
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)             -0.22      0.45    -0.70     0.57 3.33        4       14
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.26      0.37    -0.72     0.32 3.54        4       11
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)             -0.08      0.26    -0.45     0.22 3.30        4       16
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)              0.04      0.33    -0.42     0.45 3.52        4       13
# cor(Intercept,Site_YearSandyBar_2018)                          -0.12      0.28    -0.57     0.27 3.14        4       12
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.24      0.30    -0.11     0.72 3.62        4       14
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.11      0.15    -0.14     0.30 3.30        4       13
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)             -0.31      0.22    -0.53     0.08 1.89        6       14
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.03      0.42    -0.46     0.56 2.99        5       11
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.00      0.17    -0.27     0.21 4.03        4       11
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)              0.02      0.30    -0.38     0.37 3.38        4       11
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.36      0.13    -0.58    -0.21 3.18        4       11
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.02      0.30    -0.28     0.51 2.42        5       31
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.05      0.42    -0.68     0.59 3.14        4       13
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.28      0.17    -0.59    -0.11 2.61        5       11
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)        -0.00      0.19    -0.20     0.34 2.75        5       16
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.12      0.22    -0.14     0.47 3.00        5       15
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.25      0.20     0.01     0.55 3.38        4       16
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.04      0.29    -0.38     0.33 2.53        5       14
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                      -0.33      0.60    -1.42     0.52 3.96        4       11
# Site_YearDauphinRiver_2017           25.43      0.43    24.69    26.11 1.71        6       19
# Site_YearDauphinRiver_2018           20.40     18.90     1.10    46.94 3.30        4       12
# Site_YearMatheson_2017                3.33      2.65     0.01     6.35 3.37        4       11
# Site_YearMatheson_2018                5.97      2.47     1.91     8.57 3.18        4       14
# Site_YearRedRiver_2017                0.12      0.20     0.00     0.46 3.43        4       13
# Site_YearRedRiver_2018                0.10      0.18     0.00     0.41 2.98        5       25
# Site_YearSandyBar_2017                0.37      0.62     0.00     1.50 4.17        4       16
# Site_YearSandyBar_2018                0.14      0.13     0.00     0.30 3.94        4       11
# Site_YearWinnipegRiver_2017           2.94      0.43     2.41     3.64 3.39        4       13
# K                                     0.00      0.00     0.00     0.00 3.12        4       11
# sigma_Site_YearDauphinRiver_2018      3.24      1.00     2.57     4.98 3.39        4       13
# sigma_Site_YearMatheson_2017          1.29      1.13    -0.00     2.85 3.17        4       17
# sigma_Site_YearMatheson_2018          1.61      0.74     0.59     2.68 2.78        5       12
# sigma_Site_YearRedRiver_2017        -19.64      4.87   -26.74   -12.36 4.39        4       13
# sigma_Site_YearRedRiver_2018        -18.72      4.76   -22.95   -10.66 3.39        4       16
# sigma_Site_YearSandyBar_2017        -19.80      4.85   -25.97   -13.47 3.54        4       11
# sigma_Site_YearSandyBar_2018         -2.96      0.89    -4.37    -1.75 2.87        5       19
# sigma_Site_YearWinnipegRiver_2017     0.30      0.38    -0.12     0.95 3.48        4       11
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     1.01      0.00     1.00     1.02 3.58        4       11
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   Parts of the model have not converged (some Rhats are > 1.05). Be careful when analysing the results! We recommend running more iterations and/or setting stronger priors. 
asnrm_site_year_plot
save(asparagine_syrm_model, file= "asparagine_syrm_model.rda")

#### Aspartate Year_Site RS ####
hist(raw_dataf$Aspartate)
aspartate_syrm_model <- brm(data=raw_dataf,
                            family = student,
                            bf(Aspartate ~ -1 + Site_Year + K + (Site_Year | Sex),
                               sigma ~ Site_Year),
                            prior = c(prior(normal(45,10), lb= 0, class = b)),
                            iter = 50000, warmup = 10000, chains = 4, cores = 4,
                            control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(aspartate_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(aspartate_syrm_model, N = 2, ask = FALSE)
summary(aspartate_syrm_model)
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Aspartate ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  42.43     17.70    19.18    86.07 1.00    48758    74894
# sd(Site_YearDauphinRiver_2018)                                  6.85      6.48     0.23    23.54 1.00    99658    79977
# sd(Site_YearMatheson_2017)                                     18.54     10.53     6.04    45.25 1.00    94955    81102
# sd(Site_YearMatheson_2018)                                     10.54      9.37     0.41    34.32 1.00    86588    70999
# sd(Site_YearRedRiver_2017)                                     13.41     10.73     0.71    39.89 1.00    83858    65807
# sd(Site_YearRedRiver_2018)                                     11.42     10.97     0.33    39.35 1.00    71960    80482
# sd(Site_YearSandyBar_2017)                                      9.17      8.89     0.30    31.85 1.00    99459    80952
# sd(Site_YearSandyBar_2018)                                      8.19      8.05     0.24    29.33 1.00    73328    85287
# sd(Site_YearWinnipegRiver_2017)                                15.81     14.93     0.56    53.08 1.00   113776    73993
# cor(Intercept,Site_YearDauphinRiver_2018)                       0.01      0.32    -0.59     0.62 1.00   191212   120987
# cor(Intercept,Site_YearMatheson_2017)                          -0.01      0.29    -0.57     0.55 1.00   172557   117036
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.02      0.31    -0.58     0.62 1.00   141938   120033
# cor(Intercept,Site_YearMatheson_2018)                           0.04      0.31    -0.56     0.62 1.00   196865   119973
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.01      0.32    -0.59     0.61 1.00   165732   120539
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.04      0.31    -0.63     0.57 1.00   150855   123144
# cor(Intercept,Site_YearRedRiver_2017)                          -0.00      0.31    -0.58     0.58 1.00   189757   121914
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.01      0.32    -0.61     0.60 1.00   163469   122251
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.09      0.31    -0.65     0.51 1.00   148040   123338
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.03      0.32    -0.58     0.62 1.00   130992   125325
# cor(Intercept,Site_YearRedRiver_2018)                           0.11      0.31    -0.52     0.68 1.00   175379   118974
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.01      0.32    -0.60     0.62 1.00   160715   111824
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.01      0.31    -0.58     0.60 1.00   148479   121449
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.03      0.32    -0.58     0.63 1.00   129011   125913
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.00      0.31    -0.60     0.60 1.00   125437   127505
# cor(Intercept,Site_YearSandyBar_2017)                          -0.05      0.32    -0.63     0.57 1.00   188882   119016
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)          0.01      0.32    -0.60     0.61 1.00   176041   119947
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.02      0.31    -0.58     0.61 1.00   158215   126307
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.01      0.32    -0.61     0.59 1.00   136784   125268
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)             -0.00      0.32    -0.60     0.60 1.00   127511   128516
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.01      0.32    -0.61     0.60 1.00   113877   123559
# cor(Intercept,Site_YearSandyBar_2018)                           0.10      0.32    -0.54     0.68 1.00   165460   110562
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.02      0.32    -0.59     0.62 1.00   162754   120111
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.00      0.31    -0.60     0.59 1.00   148282   124612
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.03      0.32    -0.58     0.63 1.00   135283   127242
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.01      0.32    -0.59     0.61 1.00   119163   124741
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.05      0.32    -0.57     0.65 1.00   110237   126020
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.01      0.32    -0.61     0.60 1.00   105636   126026
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.06      0.31    -0.64     0.55 1.00   205139   115265
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.00      0.32    -0.60     0.61 1.00   180266   115166
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.04      0.31    -0.57     0.63 1.00   160846   123635
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.02      0.31    -0.62     0.58 1.00   139738   126719
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)        -0.02      0.31    -0.61     0.59 1.00   124009   129192
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.02      0.32    -0.62     0.58 1.00   115124   128507
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.02      0.32    -0.59     0.62 1.00   103061   129683
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.02      0.32    -0.61     0.59 1.00    97138   127758
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.01      0.21     2.63     3.44 1.00    71685    84544
# Site_YearDauphinRiver_2017           58.02      6.15    45.78    69.86 1.00   108084    99546
# Site_YearDauphinRiver_2018           42.15      6.27    29.85    54.63 1.00    94075    89798
# Site_YearMatheson_2017               45.03      8.00    29.23    60.82 1.00   115969    91681
# Site_YearMatheson_2018               39.49      7.37    26.08    55.31 1.00    95457    93643
# Site_YearRedRiver_2017               44.93      7.56    30.28    60.26 1.00   115734    94627
# Site_YearRedRiver_2018               32.77      8.23    19.27    51.66 1.00    81252    89417
# Site_YearSandyBar_2017               50.42      7.10    35.44    63.60 1.00   101923    85869
# Site_YearSandyBar_2018               31.71      7.08    19.55    47.98 1.00    82218    94551
# Site_YearWinnipegRiver_2017          49.73      9.25    31.07    67.31 1.00   153676    92085
# K                                    22.36      6.70     8.09    33.68 1.00    65351    56307
# sigma_Site_YearDauphinRiver_2018     -0.75      0.30    -1.35    -0.15 1.00    88019   102108
# sigma_Site_YearMatheson_2017         -2.40      0.66    -3.52    -0.95 1.00    61421    64658
# sigma_Site_YearMatheson_2018         -1.16      0.31    -1.77    -0.56 1.00    84505    99040
# sigma_Site_YearRedRiver_2017         -0.45      0.29    -1.02     0.12 1.00    86260    97807
# sigma_Site_YearRedRiver_2018         -1.47      0.37    -2.25    -0.78 1.00    68750    82239
# sigma_Site_YearSandyBar_2017         -0.25      0.27    -0.79     0.29 1.00    84111   101635
# sigma_Site_YearSandyBar_2018         -1.04      0.33    -1.70    -0.41 1.00    79705    96408
# sigma_Site_YearWinnipegRiver_2017     0.08      0.52    -0.84     1.19 1.00   114201   100937
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    15.87     12.22     3.32    48.48 1.00    85202   102196
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
plot(conditional_effects(aspartate_syrm_model), points = T)

# Look at the variables available in the model
get_variables(aspartate_syrm_model)
model_dataframe_asp_syrm <- aspartate_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_asp_syrm$Site<- factor(model_dataframe_asp_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

asprm_site_year_plot <- ggplot(data = model_dataframe_asp_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_asp_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_asp_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "aspartate_rm_plot.pdf", plot = asprm_site_year_plot, dpi = 900)
summary(aspartate_syrm_model)
asprm_site_year_plot
save(aspartate_syrm_model, file= "aspartate_syrm_model.rda")
load(aspartate_syrm_model)








#### Glutamine Year_Site RS ####
hist(raw_dataf$Glutamine)

glutamine_syrm_model <- brm(data=raw_dataf,
                            family = student,
                            bf(Glutamine ~ -1 + Site_Year + K + (Site_Year | Sex),
                               sigma ~ Site_Year),
                            prior = c(prior(normal(0,10), lb= 0, class = b)),
                            iter = 50000, warmup = 10000, chains = 4, cores = 4,
                            control = list(adapt_delta = 0.95, max_treedepth = 15))
 # model with less iterations
# glutamine_syrm_model <- brm(data=raw_dataf,
#                             family = student,
#                             bf(Glutamine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                                sigma ~ Site_Year),
#                             prior = c(prior(normal(0,10), lb= 0, class = b)),
#                             iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                             control = list(adapt_delta = 0.95, max_treedepth = 15))


pp_check(glutamine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(glutamine_syrm_model, N = 2, ask = FALSE)
summary(glutamine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Glutamine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                   6.61      6.03     0.24    22.09 1.00    59236    69912
# sd(Site_YearDauphinRiver_2018)                                  7.66      6.95     0.26    25.56 1.00    87956    69284
# sd(Site_YearMatheson_2017)                                      9.34      8.91     0.32    32.28 1.00    97836    70946
# sd(Site_YearMatheson_2018)                                     12.52      9.99     0.74    37.92 1.00    56195    51042
# sd(Site_YearRedRiver_2017)                                      9.17      8.94     0.31    32.11 1.00    98618    77094
# sd(Site_YearRedRiver_2018)                                     14.62     10.75     1.14    40.89 1.00    70225    46331
# sd(Site_YearSandyBar_2017)                                     10.62      9.68     0.39    35.10 1.00    87457    72834
# sd(Site_YearSandyBar_2018)                                     15.90      8.88     4.66    37.91 1.00    64375    69033
# sd(Site_YearWinnipegRiver_2017)                                16.30     15.66     0.60    54.95 1.00   114206    72295
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.00      0.32    -0.61     0.60 1.00   184930   117466
# cor(Intercept,Site_YearMatheson_2017)                          -0.00      0.32    -0.60     0.60 1.00   190606   117218
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.01      0.32    -0.60     0.61 1.00   172439   123059
# cor(Intercept,Site_YearMatheson_2018)                          -0.06      0.32    -0.64     0.56 1.00   143287   115879
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.00      0.32    -0.60     0.60 1.00   144741   122124
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.02      0.32    -0.61     0.59 1.00   123048   117676
# cor(Intercept,Site_YearRedRiver_2017)                          -0.00      0.32    -0.61     0.60 1.00   188687   118289
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.01      0.32    -0.60     0.61 1.00   165077   118715
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.01      0.32    -0.60     0.61 1.00   149442   125762
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)             -0.01      0.32    -0.61     0.59 1.00   135648   121222
# cor(Intercept,Site_YearRedRiver_2018)                           0.01      0.31    -0.59     0.61 1.00   164836   117929
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.01      0.32    -0.59     0.61 1.00   149666   124780
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.03      0.31    -0.57     0.63 1.00   136651   124044
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)             -0.03      0.31    -0.62     0.57 1.00   123743   125574
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.60 1.00   118405   127478
# cor(Intercept,Site_YearSandyBar_2017)                           0.01      0.32    -0.60     0.62 1.00   183835   115902
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)          0.02      0.32    -0.59     0.62 1.00   153869   120742
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   140946   124933
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.04      0.31    -0.63     0.56 1.00   136831   129530
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   120489   129157
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)              0.02      0.31    -0.58     0.62 1.00   114867   125827
# cor(Intercept,Site_YearSandyBar_2018)                          -0.05      0.32    -0.64     0.57 1.00   113137   109956
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)         -0.01      0.32    -0.61     0.60 1.00   120298   122186
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.02      0.31    -0.58     0.61 1.00   118329   126539
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.07      0.32    -0.55     0.66 1.00   107636   122569
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.04      0.31    -0.62     0.57 1.00   108244   128997
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.09      0.30    -0.50     0.65 1.00   109319   130861
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.03      0.31    -0.62     0.57 1.00   104905   129413
# cor(Intercept,Site_YearWinnipegRiver_2017)                      0.02      0.32    -0.59     0.62 1.00   198770   117895
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.01      0.32    -0.59     0.61 1.00   167636   119202
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.59     0.61 1.00   153300   124500
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.04      0.31    -0.63     0.57 1.00   140724   127469
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.59     0.61 1.00   118781   123480
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.02      0.32    -0.58     0.62 1.00   116511   128261
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.03      0.31    -0.58     0.62 1.00   104198   125690
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.02      0.32    -0.62     0.58 1.00   114107   136323
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       2.62      0.26     2.09     3.13 1.00    44512    73102
# Site_YearDauphinRiver_2017           15.94      4.96     6.11    25.60 1.00    60190    48770
# Site_YearDauphinRiver_2018            7.00      4.45     0.42    16.93 1.00    80253    56938
# Site_YearMatheson_2017                8.00      5.09     0.47    19.25 1.00    85513    58609
# Site_YearMatheson_2018                4.09      3.82     0.11    14.23 1.00    92336    74432
# Site_YearRedRiver_2017                9.82      5.45     0.80    21.21 1.00    78671    58206
# Site_YearRedRiver_2018                6.43      4.83     0.26    18.04 1.00    94579    63321
# Site_YearSandyBar_2017               11.68      6.05     1.05    23.86 1.00    76836    50505
# Site_YearSandyBar_2018                4.06      3.70     0.12    13.76 1.00   112416    79702
# Site_YearWinnipegRiver_2017           9.98      6.54     0.52    24.50 1.00   100993    57833
# K                                    15.97      4.04     7.73    23.78 1.00    60233    50618
# sigma_Site_YearDauphinRiver_2018     -0.03      0.34    -0.70     0.64 1.00    69296    94367
# sigma_Site_YearMatheson_2017         -0.28      0.50    -1.19     0.77 1.00    87616   101203
# sigma_Site_YearMatheson_2018         -0.85      0.33    -1.49    -0.18 1.00    64188    98525
# sigma_Site_YearRedRiver_2017         -0.07      0.32    -0.68     0.57 1.00    59513    92788
# sigma_Site_YearRedRiver_2018          0.02      0.34    -0.62     0.70 1.00    62880    95006
# sigma_Site_YearSandyBar_2017          0.15      0.31    -0.46     0.77 1.00    59968    91474
# sigma_Site_YearSandyBar_2018         -1.08      0.38    -1.85    -0.35 1.00    71323    93688
# sigma_Site_YearWinnipegRiver_2017     0.47      0.57    -0.59     1.66 1.00   100400    97789
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     9.66      8.68     2.48    34.65 1.00    83644   115958
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

plot(conditional_effects(glutamine_syrm_model), points = T)
plot(conditional_effects(glutamine_syrm_model), points = T, offset = T)
plot(conditional_effects(glutamine_syrm_model, prob = 0, offset = TRUE), ask = FALSE, points = T)
# Look at the variables available in the model
get_variables(glutamine_syrm_model)
model_dataframe_gln_syrm <- glutamine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_gln_syrm$Site<- factor(model_dataframe_gln_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

glnrm_site_year_plot <- ggplot(data = model_dataframe_gln_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_gln_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_gln_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "glutamine_rm_plot.pdf", plot = glnrm_site_year_plot, dpi = 900)
 sumary(glutamine_syrm_model)

glnrm_site_year_plot
 save(glutamine_syrm_model, file= "glutamine_syrm_model.rda")
load(glutamine_syrm_model)
#### Glutamate Year_Site RS ####
hist(raw_dataf$Glutamate)
glutamate_syrm_model <- brm(data=raw_dataf,
                            family = student,
                            bf(Glutamate ~ -1 + Site_Year + K + (Site_Year | Sex),
                               sigma ~ Site_Year),
                            prior = c(prior(normal(0,50), lb= 0, class = b)),
                            iter = 50000, warmup = 10000, chains = 4, cores = 4,
                            control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(glutamate_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(glutamate_syrm_model, N = 2, ask = FALSE)
summary(glutamate_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Glutamate ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# sd(Intercept)                                                  21.96     23.11     0.71    79.63 1.00    30637
# sd(Site_YearDauphinRiver_2018)                                 25.53     24.08     0.92    88.67 1.00    91554
# sd(Site_YearMatheson_2017)                                     48.11     44.19     1.68   160.56 1.00   125133
# sd(Site_YearMatheson_2018)                                     35.52     36.02     1.09   132.67 1.00    21556
# sd(Site_YearRedRiver_2017)                                     92.30     61.50     9.14   242.05 1.00    84034
# sd(Site_YearRedRiver_2018)                                     31.90     33.83     0.96   119.01 1.00    95158
# sd(Site_YearSandyBar_2017)                                     50.32     46.30     1.71   166.19 1.00   103012
# sd(Site_YearSandyBar_2018)                                     38.63     30.28     2.64   115.85 1.00    67218
# sd(Site_YearWinnipegRiver_2017)                                51.45     52.00     1.66   184.85 1.00    90371
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.01      0.32    -0.61     0.60 1.00   224554
# cor(Intercept,Site_YearMatheson_2017)                           0.01      0.32    -0.60     0.61 1.00   131459
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.01      0.32    -0.60     0.61 1.00   183731
# cor(Intercept,Site_YearMatheson_2018)                          -0.05      0.32    -0.64     0.57 1.00   214344
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)         -0.00      0.32    -0.61     0.60 1.00   170872
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.02      0.32    -0.61     0.59 1.00   156010
# cor(Intercept,Site_YearRedRiver_2017)                           0.04      0.31    -0.56     0.62 1.00   168097
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.04      0.31    -0.57     0.62 1.00   162357
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.04      0.31    -0.56     0.63 1.00   140696
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)             -0.07      0.31    -0.64     0.53 1.00   135269
# cor(Intercept,Site_YearRedRiver_2018)                          -0.01      0.32    -0.62     0.59 1.00   190397
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.02      0.32    -0.59     0.61 1.00   157708
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.00      0.32    -0.61     0.61 1.00   139385
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.01      0.32    -0.60     0.61 1.00   132598
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.60 1.00    52877
# cor(Intercept,Site_YearSandyBar_2017)                           0.00      0.32    -0.60     0.60 1.00   193813
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)          0.01      0.32    -0.60     0.61 1.00   117107
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   151616
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.02      0.32    -0.62     0.58 1.00   138293
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.05      0.31    -0.55     0.64 1.00   100364
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.01      0.32    -0.62     0.60 1.00    92922
# cor(Intercept,Site_YearSandyBar_2018)                          -0.01      0.32    -0.61     0.60 1.00    64010
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.05      0.32    -0.57     0.64 1.00   164202
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.01      0.32    -0.61     0.59 1.00   140707
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.03      0.32    -0.59     0.63 1.00   129428
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.02      0.31    -0.60     0.57 1.00   123284
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.04      0.32    -0.57     0.63 1.00   112332
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.04      0.31    -0.63     0.57 1.00   105920
# cor(Intercept,Site_YearWinnipegRiver_2017)                      0.00      0.32    -0.60     0.61 1.00    56452
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.01      0.32    -0.59     0.61 1.00   195028
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.61     0.61 1.00    29914
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.01      0.32    -0.61     0.60 1.00   123517
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.02      0.31    -0.58     0.61 1.00   128712
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   101170
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.60     0.61 1.00    96600
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00    97413
# Tail_ESS
# sd(Intercept)                                                   8351
# sd(Site_YearDauphinRiver_2018)                                 87786
# sd(Site_YearMatheson_2017)                                     72598
# sd(Site_YearMatheson_2018)                                      8445
# sd(Site_YearRedRiver_2017)                                     43158
# sd(Site_YearRedRiver_2018)                                     89089
# sd(Site_YearSandyBar_2017)                                     90867
# sd(Site_YearSandyBar_2018)                                     69866
# sd(Site_YearWinnipegRiver_2017)                                87131
# cor(Intercept,Site_YearDauphinRiver_2018)                     120081
# cor(Intercept,Site_YearMatheson_2017)                         107560
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)        114512
# cor(Intercept,Site_YearMatheson_2018)                         121080
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)        104991
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)            124978
# cor(Intercept,Site_YearRedRiver_2017)                         116206
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)        126255
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)            125646
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)            130468
# cor(Intercept,Site_YearRedRiver_2018)                          96762
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)        114473
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             94771
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)            117109
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             23504
# cor(Intercept,Site_YearSandyBar_2017)                         104583
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         61201
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)            114855
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)            127726
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)             77092
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             58596
# cor(Intercept,Site_YearSandyBar_2018)                          13779
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)         92014
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             95302
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)            132529
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)            133128
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)            133523
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)            130137
# cor(Intercept,Site_YearWinnipegRiver_2017)                     12152
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    95182
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         8604
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)       121469
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)       128183
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)       125570
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)       118563
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)       128908
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.38      0.21     3.98     4.81 1.00    41899    12158
# Site_YearDauphinRiver_2017           89.55     22.94    43.19   133.34 1.00   107057    74873
# Site_YearDauphinRiver_2018           30.07     16.46     2.80    65.87 1.00    51388     8310
# Site_YearMatheson_2017               52.67     29.54     3.74   113.90 1.00    41821     8209
# Site_YearMatheson_2018               17.16     16.54     0.51    61.77 1.00    34075     8479
# Site_YearRedRiver_2017               70.67     39.71     5.02   149.47 1.00   106939    74260
# Site_YearRedRiver_2018               23.76     17.81     1.10    67.51 1.00   105275    79407
# Site_YearSandyBar_2017               68.29     30.61     7.75   124.27 1.00    93293    62737
# Site_YearSandyBar_2018               15.22     14.51     0.43    54.10 1.00    74581    29617
# Site_YearWinnipegRiver_2017          40.82     25.04     2.59    96.14 1.00   102474    67487
# K                                    71.48     14.09    42.60    99.31 1.00    16894     7991
# sigma_Site_YearDauphinRiver_2018     -1.11      0.32    -1.75    -0.49 1.00    95061   104417
# sigma_Site_YearMatheson_2017         -0.19      0.48    -1.10     0.82 1.00   104154   115595
# sigma_Site_YearMatheson_2018         -1.69      0.31    -2.31    -1.08 1.00    19979     8018
# sigma_Site_YearRedRiver_2017         -0.05      0.29    -0.63     0.52 1.00    97552   107901
# sigma_Site_YearRedRiver_2018         -0.68      0.33    -1.35    -0.05 1.00    30811     8166
# sigma_Site_YearSandyBar_2017         -0.16      0.29    -0.74     0.40 1.00    88803   107723
# sigma_Site_YearSandyBar_2018         -1.36      0.31    -1.96    -0.74 1.00    56609    46760
# sigma_Site_YearWinnipegRiver_2017    -1.06      0.56    -2.10     0.12 1.00   121449    94738
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    15.77     12.11     3.13    47.95 1.00    93690    96857
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
plot(conditional_effects(glutamate_syrm_model), points = T)
plot(conditional_effects(glutamate_syrm_model), points = T, offset = FALSE)
 
# Look at the variables available in the model
get_variables(glutamate_syrm_model)
model_dataframe_glu_syrm <- glutamate_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_glu_syrm$Site<- factor(model_dataframe_glu_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

glurm_site_year_plot <- ggplot(data = model_dataframe_glu_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_glu_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_glu_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "glutamate_rm_plot.pdf", plot = glurm_site_year_plot, dpi = 900)
summary(glutamate_syrm_model)
glurm_site_year_plot
save(glutamate_syrm_model, file= "glutamate_syrm_model.rda")
load(glutamate_syrm_model)
#### Glycine Year_Site RS ####
hist(raw_dataf$Glycine)
glycine_syrm_model <- brm(data=raw_dataf,
                          family = student,
                          bf(Glycine ~ -1 + Site_Year + K + (Site_Year | Sex),
                             sigma ~ Site_Year),
                          prior = c(prior(normal(0,100), lb= 0, class = b)),
                          iter = 50000, warmup = 10000, chains = 4, cores = 4,
                          control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# glycine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Glycine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(glycine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(glycine_syrm_model, N = 2, ask = FALSE)
summary(glycine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Glycine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# sd(Intercept)                                                 146.14    113.77     6.87   424.95 1.00    49104
# sd(Site_YearDauphinRiver_2018)                                150.57     99.28    12.18   391.70 1.00    64147
# sd(Site_YearMatheson_2017)                                    119.09    106.03     4.96   388.68 1.00    83479
# sd(Site_YearMatheson_2018)                                     85.84     87.88     2.69   315.34 1.00   103672
# sd(Site_YearRedRiver_2017)                                    130.91    113.56     5.27   413.31 1.00    98108
# sd(Site_YearRedRiver_2018)                                    194.34    120.14    42.84   496.79 1.00    90661
# sd(Site_YearSandyBar_2017)                                     89.89     89.16     2.94   324.34 1.00    95850
# sd(Site_YearSandyBar_2018)                                    183.26     98.11    57.10   429.67 1.00    89865
# sd(Site_YearWinnipegRiver_2017)                               163.57    168.91     6.06   554.40 1.00   124782
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.02      0.31    -0.61     0.58 1.00   169558
# cor(Intercept,Site_YearMatheson_2017)                          -0.06      0.31    -0.64     0.55 1.00   193557
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.04      0.31    -0.62     0.56 1.00   171724
# cor(Intercept,Site_YearMatheson_2018)                          -0.04      0.32    -0.64     0.58 1.00   222681
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.01      0.32    -0.60     0.61 1.00   192108
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.02      0.32    -0.59     0.61 1.00   153094
# cor(Intercept,Site_YearRedRiver_2017)                           0.05      0.31    -0.57     0.63 1.00   208218
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.05      0.31    -0.55     0.63 1.00   178829
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.03      0.32    -0.63     0.58 1.00   158472
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)             -0.00      0.32    -0.61     0.60 1.00   134851
# cor(Intercept,Site_YearRedRiver_2018)                           0.00      0.30    -0.57     0.58 1.00   178036
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.12      0.30    -0.48     0.68 1.00   149995
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.05      0.31    -0.63     0.55 1.00   146847
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)             -0.00      0.31    -0.60     0.59 1.00   127597
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.06      0.31    -0.55     0.64 1.00   123052
# cor(Intercept,Site_YearSandyBar_2017)                           0.00      0.32    -0.60     0.60 1.00   214257
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.02      0.31    -0.61     0.58 1.00   180363
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   159343
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.61 1.00   138190
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   124218
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.02      0.31    -0.62     0.58 1.00   116665
# cor(Intercept,Site_YearSandyBar_2018)                          -0.09      0.30    -0.65     0.51 1.00   153746
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.13      0.30    -0.48     0.68 1.00   145432
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.02      0.31    -0.60     0.58 1.00   135707
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.01      0.32    -0.60     0.62 1.00   124848
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.03      0.31    -0.57     0.61 1.00   119760
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.13      0.30    -0.46     0.67 1.00   117732
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.03      0.31    -0.62     0.57 1.00   108798
# cor(Intercept,Site_YearWinnipegRiver_2017)                      0.03      0.31    -0.58     0.62 1.00   233413
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.03      0.31    -0.57     0.62 1.00   188433
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)        -0.02      0.32    -0.62     0.59 1.00   159532
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   140350
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.03      0.32    -0.58     0.62 1.00   124588
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.04      0.31    -0.56     0.63 1.00   117229
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   102809
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)         0.03      0.32    -0.58     0.62 1.00   111070
# Tail_ESS
# sd(Intercept)                                                  59562
# sd(Site_YearDauphinRiver_2018)                                 53641
# sd(Site_YearMatheson_2017)                                     74104
# sd(Site_YearMatheson_2018)                                     84739
# sd(Site_YearRedRiver_2017)                                     77015
# sd(Site_YearRedRiver_2018)                                     63010
# sd(Site_YearSandyBar_2017)                                     80846
# sd(Site_YearSandyBar_2018)                                     80357
# sd(Site_YearWinnipegRiver_2017)                                79239
# cor(Intercept,Site_YearDauphinRiver_2018)                     116998
# cor(Intercept,Site_YearMatheson_2017)                         120787
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)        122188
# cor(Intercept,Site_YearMatheson_2018)                         117317
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)        120283
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)            123782
# cor(Intercept,Site_YearRedRiver_2017)                         117507
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)        124400
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)            125986
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)            125076
# cor(Intercept,Site_YearRedRiver_2018)                         116818
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)        123939
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)            124533
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)            128102
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)            130467
# cor(Intercept,Site_YearSandyBar_2017)                         108227
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)        123399
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)            127680
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)            125678
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)            127080
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)            129770
# cor(Intercept,Site_YearSandyBar_2018)                         108865
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)        124070
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)            128279
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)            131120
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)            130806
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)            135144
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)            133536
# cor(Intercept,Site_YearWinnipegRiver_2017)                    116216
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)   120048
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)       121817
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)       126925
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)       122697
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)       126421
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)       128641
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)       130770
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.96      0.26     4.44     5.47 1.00    58539    86241
# Site_YearDauphinRiver_2017          138.95     51.29    39.23   240.69 1.00    89401    60578
# Site_YearDauphinRiver_2018           98.51     57.66     6.31   218.64 1.00    91036    63760
# Site_YearMatheson_2017               50.04     42.25     1.66   157.25 1.00   120423    78551
# Site_YearMatheson_2018               58.89     42.43     2.70   159.73 1.00    97535    73452
# Site_YearRedRiver_2017              122.08     64.33    10.50   250.86 1.00    98219    65314
# Site_YearRedRiver_2018               88.48     56.84     4.94   214.63 1.00   119556    70407
# Site_YearSandyBar_2017               75.53     47.63     4.72   181.76 1.00    95948    67342
# Site_YearSandyBar_2018               53.05     43.04     1.86   160.10 1.00   127881    79457
# Site_YearWinnipegRiver_2017          95.21     63.70     4.81   238.49 1.00   116062    66824
# K                                   255.34     69.82   102.48   368.62 1.00    58264    67200
# sigma_Site_YearDauphinRiver_2018     -0.41      0.36    -1.11     0.30 1.00    76552   105201
# sigma_Site_YearMatheson_2017         -0.54      0.58    -1.67     0.62 1.00   104589   103784
# sigma_Site_YearMatheson_2018         -0.62      0.36    -1.33     0.09 1.00    79533   102102
# sigma_Site_YearRedRiver_2017          0.01      0.36    -0.70     0.70 1.00    76483    98089
# sigma_Site_YearRedRiver_2018         -0.26      0.36    -0.99     0.45 1.00    79738   103856
# sigma_Site_YearSandyBar_2017         -0.35      0.33    -1.00     0.30 1.00    77501    99268
# sigma_Site_YearSandyBar_2018         -0.60      0.36    -1.31     0.11 1.00    83939   105122
# sigma_Site_YearWinnipegRiver_2017     0.31      0.56    -0.72     1.49 1.00   117684   104467
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     6.07      5.28     2.07    20.61 1.00    96275   104372
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
plot(conditional_effects(glycine_syrm_model), points = T)

# Look at the variables available in the model

get_variables(glycine_syrm_model)
model_dataframe_gly_syrm <- glycine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_gly_syrm$Site<- factor(model_dataframe_gly_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

glyrm_site_year_plot <- ggplot(data = model_dataframe_gly_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_gly_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_gly_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "glycine_syrm_plot.pdf", plot = glyrm_site_year_plot, dpi = 900)
summary(glycine_syrm_model)
glyrm_site_year_plot
save(glycine_syrm_model, file= "glycine_syrm_model.rda")
load(glycine_syrm_model)
 #### Histidine Year_Site RS ####
hist(raw_dataf$Histidine)
histidine_syrm_model <- brm(data=raw_dataf,
                            family = skew_normal,
                            bf(Histidine ~ -1 + Site_Year + K + (Site_Year | Sex),
                               sigma ~ Site_Year),
                            prior = c(prior(normal(0,160), lb= 0, class = b)),
                                         control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# histidine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Histidine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
   #                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(histidine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(histidine_syrm_model, N = 2 , ask = FALSE)
summary(histidine_syrm_model)
get_variables(histidine_syrm_model)
model_dataframe_his_syrm <- histidine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_his_syrm$Site<- factor(model_dataframe_his_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

hisrm_site_year_plot <- ggplot (data = model_dataframe_his_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_his_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_his_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "histidine_syrm_plot.pdf", plot = hisrm_site_year_plot, dpi = 900)
summary(histidine_syrm_model)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Histidine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                   8.12      8.61     0.24    31.46 1.00    84433    85089
# sd(Site_YearDauphinRiver_2018)                                 12.12     10.72     0.46    39.63 1.00    84588    69233
# sd(Site_YearMatheson_2017)                                     15.07     14.81     0.49    53.27 1.00   123811    83695
# sd(Site_YearMatheson_2018)                                     13.35     13.60     0.42    48.46 1.00   108933    82930
# sd(Site_YearRedRiver_2017)                                     13.86     14.09     0.44    49.60 1.00   111249    83410
# sd(Site_YearRedRiver_2018)                                     12.34     13.52     0.37    45.58 1.00   101415    85341
# sd(Site_YearSandyBar_2017)                                     13.70     13.53     0.45    48.72 1.00    96285    82413
# sd(Site_YearSandyBar_2018)                                     14.67     11.56     1.14    43.73 1.00    77808    62886
# sd(Site_YearWinnipegRiver_2017)                                21.99     22.81     0.73    78.82 1.00   145279    81990
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.01      0.32    -0.61     0.60 1.00   203753   115885
# cor(Intercept,Site_YearMatheson_2017)                          -0.01      0.32    -0.61     0.60 1.00   226440   113157
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.00      0.32    -0.61     0.60 1.00   188471   116278
# cor(Intercept,Site_YearMatheson_2018)                          -0.01      0.32    -0.62     0.60 1.00   208271   112619
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.01      0.32    -0.60     0.61 1.00   180362   111577
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.00      0.32    -0.60     0.61 1.00   146836   119655
# cor(Intercept,Site_YearRedRiver_2017)                          -0.01      0.32    -0.62     0.61 1.00   225193   114325
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.00      0.32    -0.61     0.60 1.00   185600   117619
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.00      0.32    -0.61     0.61 1.00   152547   120762
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)             -0.00      0.32    -0.60     0.60 1.00   132424   123727
# cor(Intercept,Site_YearRedRiver_2018)                          -0.01      0.32    -0.61     0.60 1.00   220156   111845
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.00      0.32    -0.60     0.61 1.00   176275   117065
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.61 1.00   155856   113658
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.60 1.00   134923   125111
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.61 1.00   115117   125707
# cor(Intercept,Site_YearSandyBar_2017)                          -0.01      0.32    -0.61     0.60 1.00   221827   113563
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.61     0.60 1.00   180538   119335
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   155903   117410
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   129549   121369
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.61     0.61 1.00   119846   123742
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.61 1.00   109960   128954
# cor(Intercept,Site_YearSandyBar_2018)                          -0.02      0.32    -0.62     0.59 1.00   189312   112905
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.02      0.32    -0.59     0.62 1.00   158894   113180
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.00      0.32    -0.60     0.60 1.00   146439   124356
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.00      0.32    -0.60     0.61 1.00   129474   122838
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.00      0.32    -0.60     0.60 1.00   117747   129569
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.02      0.32    -0.58     0.62 1.00   108450   121720
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.02      0.32    -0.62     0.59 1.00    99371   127724
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.61     0.60 1.00   228677   102896
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.00      0.32    -0.60     0.60 1.00   194304   118105
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.61     0.60 1.00   151747   112096
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   134271   121419
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   118906   122893
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   109049   123947
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00    99250   125050
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00    97506   124596
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.42      0.19     3.07     3.82 1.00    57938    67534
# Site_YearDauphinRiver_2017           62.31     12.72    39.34    89.18 1.00    46507    73712
# Site_YearDauphinRiver_2018           32.46     13.55     7.89    61.37 1.00    49372    50062
# Site_YearMatheson_2017               41.10     20.02     8.04    87.06 1.00    59496    55903
# Site_YearMatheson_2018               30.32     14.82     5.68    63.05 1.00    52757    53946
# Site_YearRedRiver_2017               36.92     16.53     7.90    72.63 1.00    47498    48156
# Site_YearRedRiver_2018               26.86     14.53     3.79    59.39 1.00    49801    54663
# Site_YearSandyBar_2017               36.93     15.52     9.55    70.91 1.00    48223    53123
# Site_YearSandyBar_2018               13.92     11.29     0.54    41.42 1.00    61330    76890
# Site_YearWinnipegRiver_2017          57.55     34.16     6.74   140.37 1.00    72886    61996
# K                                    24.74      8.74     6.87    41.44 1.00    50748    56123
# sigma_Site_YearDauphinRiver_2018     -0.41      0.28    -0.96     0.16 1.00    80420    95163
# sigma_Site_YearMatheson_2017         -0.24      0.46    -1.05     0.77 1.00   103118    96278
# sigma_Site_YearMatheson_2018         -0.51      0.28    -1.06     0.04 1.00    80222    94046
# sigma_Site_YearRedRiver_2017         -0.36      0.27    -0.90     0.18 1.00    76684    92229
# sigma_Site_YearRedRiver_2018         -0.44      0.28    -0.99     0.12 1.00    78938    91858
# sigma_Site_YearSandyBar_2017         -0.49      0.26    -1.01     0.03 1.00    74964    89266
# sigma_Site_YearSandyBar_2018         -0.78      0.29    -1.33    -0.21 1.00    83648    95405
# sigma_Site_YearWinnipegRiver_2017     0.35      0.51    -0.52     1.47 1.00   100280    91315
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.52      1.98     2.44    10.12 1.00   117091    88613
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 474 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
hisrm_site_year_plot
save(histidine_syrm_model, file= "histidine_syrm_model.rda")

#### Isoleucine Year_Site RS ####
hist(raw_dataf$Isoleucine)
isoleucine_syrm_model <- brm(data=raw_dataf,
                          family = student,
                          bf(Isoleucine ~ -1 + Site_Year + K + (Site_Year | Sex),
                             sigma ~ Site_Year),
                          prior = c(prior(normal(0,275), lb= 0, class = b)),
                          iter = 50000, warmup = 10000, chains = 4, cores = 4,
                          control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# isoleucine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Isoleucine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(isoleucine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(isoleucine_syrm_model, N = 2, ask = FALSE)
summary(isoleucine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Isoleucine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  22.64     22.46     0.81    77.99 1.00    35646    27598
# sd(Site_YearDauphinRiver_2018)                                 36.27     31.53     1.30   115.74 1.00    71976    47500
# sd(Site_YearMatheson_2017)                                     39.37     37.51     1.35   133.34 1.00   127443    75501
# sd(Site_YearMatheson_2018)                                     25.99     28.01     0.77    97.36 1.00    75806    77430
# sd(Site_YearRedRiver_2017)                                     35.40     31.52     1.51   115.92 1.00    74730    68863
# sd(Site_YearRedRiver_2018)                                     32.35     29.97     1.34   110.18 1.00    72326    68345
# sd(Site_YearSandyBar_2017)                                     29.32     29.30     0.96   104.49 1.00    96894    77378
# sd(Site_YearSandyBar_2018)                                     40.82     25.77     7.15   106.31 1.00    69611    53175
# sd(Site_YearWinnipegRiver_2017)                                43.44     46.06     1.33   159.73 1.00    85524    37064
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.00      0.32    -0.60     0.60 1.00   176885   115769
# cor(Intercept,Site_YearMatheson_2017)                           0.00      0.31    -0.60     0.60 1.00   204469   116494
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.00      0.32    -0.60     0.61 1.00   173817   118510
# cor(Intercept,Site_YearMatheson_2018)                          -0.02      0.32    -0.63     0.59 1.00   164209    68491
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)         -0.00      0.32    -0.61     0.60 1.00   163760   119372
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.00      0.32    -0.60     0.60 1.00   138101   105366
# cor(Intercept,Site_YearRedRiver_2017)                          -0.04      0.32    -0.63     0.57 1.00   182394   116028
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.01      0.32    -0.60     0.59 1.00   143988    62388
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.01      0.32    -0.61     0.60 1.00   130820    97581
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.60 1.00   127725   124591
# cor(Intercept,Site_YearRedRiver_2018)                           0.01      0.32    -0.60     0.61 1.00   108745    45483
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.02      0.32    -0.59     0.62 1.00   153589   121938
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.01      0.32    -0.59     0.61 1.00   143037   123021
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.01      0.32    -0.60     0.61 1.00   125815   107215
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.02      0.32    -0.62     0.59 1.00   116849   125769
# cor(Intercept,Site_YearSandyBar_2017)                          -0.02      0.32    -0.62     0.59 1.00   190449   111835
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.61     0.60 1.00   156965    99556
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   126279    50008
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.60 1.00   123614   100905
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.61 1.00   121005   124673
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   108703   107360
# cor(Intercept,Site_YearSandyBar_2018)                           0.03      0.31    -0.57     0.62 1.00   133608   113842
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.01      0.31    -0.59     0.60 1.00    91825    55362
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.02      0.32    -0.58     0.61 1.00   104188    60475
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.02      0.32    -0.58     0.62 1.00   102091    47531
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.06      0.31    -0.63     0.54 1.00   112918   115780
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.07      0.31    -0.54     0.64 1.00   110210   132982
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.01      0.31    -0.60     0.59 1.00    88124    51292
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.61     0.60 1.00   206496   114125
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.00      0.32    -0.60     0.61 1.00   175823   117266
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   104328    44811
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   134116   121720
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.59     0.61 1.00   120715   127400
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   108532   124780
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   100225   126801
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.01      0.32    -0.61     0.59 1.00    98558   129442
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.83      0.23     4.39     5.29 1.00    83864    98581
# Site_YearDauphinRiver_2017          208.83     43.54   125.22   296.36 1.00    66638    54750
# Site_YearDauphinRiver_2018          111.14     38.33    35.33   190.21 1.00    46026    38944
# Site_YearMatheson_2017              112.17     56.83    15.35   238.23 1.00    70114    46804
# Site_YearMatheson_2018               36.90     25.76     2.84   100.64 1.00    43270    26157
# Site_YearRedRiver_2017               57.62     33.56     6.83   136.93 1.00    43760    50263
# Site_YearRedRiver_2018               39.73     29.25     2.50   110.77 1.00    46675    27369
# Site_YearSandyBar_2017               62.93     33.13     9.91   138.45 1.00    50812    52022
# Site_YearSandyBar_2018               44.32     28.20     3.46   110.62 1.00    45236    41474
# Site_YearWinnipegRiver_2017          60.84     45.77     4.28   176.86 1.00    60509    61863
# K                                    36.07     16.60     4.64    68.46 1.00    54514    48056
# sigma_Site_YearDauphinRiver_2018     -0.65      0.37    -1.41     0.04 1.00    54243    38588
# sigma_Site_YearMatheson_2017         -0.39      0.52    -1.37     0.67 1.00    93568    51470
# sigma_Site_YearMatheson_2018         -2.15      0.35    -2.86    -1.48 1.00    52340    33094
# sigma_Site_YearRedRiver_2017         -1.73      0.35    -2.45    -1.07 1.00    65121    76974
# sigma_Site_YearRedRiver_2018         -1.81      0.37    -2.55    -1.08 1.00    65735    61550
# sigma_Site_YearSandyBar_2017         -1.04      0.47    -1.99    -0.21 1.00    40138    32498
# sigma_Site_YearSandyBar_2018         -2.06      0.35    -2.76    -1.38 1.00    76667    92847
# sigma_Site_YearWinnipegRiver_2017    -1.91      0.60    -3.01    -0.62 1.00   103099   100159
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     5.80      6.53     1.68    25.03 1.00    44347    44025
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# > ilerm_site_year_plot Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
get_variables(isoleucine_syrm_model)
model_dataframe_ile_syrm <- isoleucine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_ile_syrm$Site<- factor(model_dataframe_ile_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

ilerm_site_year_plot <- ggplot(data = model_dataframe_ile_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_ile_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_ile_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "isoleucine_syrm_plot.pdf", plot = ilerm_site_year_plot, dpi = 900)
summary(isoleucine_syrm_model)
ilerm_site_year_plot
save(isoleucine_syrm_model, file= "isoleucine_syrm_model.rda")

#### Leucine Year_Site RS ####
hist(raw_dataf$Leucine)
leucine_syrm_model <- brm(data=raw_dataf,
                          family = student,
                          bf(Leucine ~ -1 + Site_Year + K + (Site_Year | Sex),
                             sigma ~ Site_Year),
                          prior = c(prior(normal(0,350), lb= 0, class = b)),
                          iter = 50000, warmup = 10000, chains = 4, cores = 4,
                          control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# leucine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(leucine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(leucine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(leucine_syrm_model, N = 2, ask = FALSE)
summary(leucine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Leucine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  36.06     33.75     1.23   123.72 1.00    60035    48729
# sd(Site_YearDauphinRiver_2018)                                 39.79     37.65     1.33   136.83 1.00    74832    77515
# sd(Site_YearMatheson_2017)                                     64.72     61.02     2.19   218.56 1.00   117493    76473
# sd(Site_YearMatheson_2018)                                     46.04     73.88     1.34   168.08 1.00    15408     7618
# sd(Site_YearRedRiver_2017)                                     57.00     51.38     2.32   189.28 1.00    79645    71072
# sd(Site_YearRedRiver_2018)                                     58.82     52.98     2.76   194.49 1.00    80103    71641
# sd(Site_YearSandyBar_2017)                                     49.87     49.82     1.55   176.93 1.00    47945    29048
# sd(Site_YearSandyBar_2018)                                     92.08     50.10    28.05   217.09 1.00    91155    76198
# sd(Site_YearWinnipegRiver_2017)                                74.95     74.27     2.57   261.78 1.00    68979    78900
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.01      0.32    -0.61     0.59 1.00   122659    82024
# cor(Intercept,Site_YearMatheson_2017)                           0.00      0.32    -0.60     0.60 1.00   180830   110021
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.00      0.32    -0.60     0.61 1.00   149234   110814
# cor(Intercept,Site_YearMatheson_2018)                          -0.02      0.32    -0.62     0.60 1.00    29329     7558
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.00      0.32    -0.60     0.61 1.00   171925   118746
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.00      0.32    -0.60     0.60 1.00   136809   102795
# cor(Intercept,Site_YearRedRiver_2017)                          -0.04      0.32    -0.63     0.57 1.00   146183   108237
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.01      0.32    -0.61     0.60 1.00   154294    87460
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.01      0.32    -0.61     0.61 1.00    31450     7707
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.60 1.00   125164   124256
# cor(Intercept,Site_YearRedRiver_2018)                           0.02      0.32    -0.59     0.61 1.00   184111   113608
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.02      0.32    -0.59     0.62 1.00   159541   119294
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.01      0.32    -0.60     0.61 1.00   141652   123102
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.61 1.00   117143   114222
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.02      0.32    -0.62     0.58 1.00   115858   125873
# cor(Intercept,Site_YearSandyBar_2017)                          -0.02      0.32    -0.62     0.59 1.00   199913   112026
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.60     0.60 1.00   155909   113976
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.60 1.00   146886   121176
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.60 1.00   129211   120444
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   118990   126334
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.60 1.00    86581   114231
# cor(Intercept,Site_YearSandyBar_2018)                           0.05      0.31    -0.55     0.63 1.00   157112   119788
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.03      0.32    -0.58     0.62 1.00    63150    31486
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.02      0.31    -0.58     0.61 1.00   124186   127367
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.02      0.32    -0.59     0.61 1.00    65914    23298
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.07      0.30    -0.63     0.53 1.00   116272   127379
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.09      0.31    -0.52     0.65 1.00   104472   126356
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.02      0.31    -0.61     0.57 1.00    59486    11084
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.60     0.61 1.00    20305     7483
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.00      0.32    -0.61     0.60 1.00   123142   114029
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00    35304     7951
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00    94206   120938
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00    25111     7589
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   108138   119085
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00    98718   118184
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00   104623   128630
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.99      0.23     4.54     5.46 1.00    51532    13653
# Site_YearDauphinRiver_2017          339.44     56.28   230.07   451.60 1.00    97387    91585
# Site_YearDauphinRiver_2018           79.99     41.20    11.19   170.43 1.00    58010    55003
# Site_YearMatheson_2017              188.16     85.15    31.25   368.44 1.00    77851    48721
# Site_YearMatheson_2018               56.60     42.71     3.71   158.37 1.00    16784     7411
# Site_YearRedRiver_2017               91.91     52.05    11.56   213.21 1.00    59923    60897
# Site_YearRedRiver_2018               56.99     46.54     2.71   173.09 1.00    67219    71915
# Site_YearSandyBar_2017              110.26     51.85    22.68   227.38 1.00    60105    54113
# Site_YearSandyBar_2018               85.38     53.88     6.79   211.98 1.00    67001    63700
# Site_YearWinnipegRiver_2017         147.79     75.10    22.54   323.78 1.00    59455    48699
# K                                    57.77     26.41     8.65   110.42 1.00    64473    60136
# sigma_Site_YearDauphinRiver_2018     -0.95      0.38    -1.70    -0.21 1.00    49326    25618
# sigma_Site_YearMatheson_2017         -0.22      0.52    -1.20     0.87 1.00   124049   101778
# sigma_Site_YearMatheson_2018         -1.74      0.35    -2.43    -1.06 1.00    91022   110063
# sigma_Site_YearRedRiver_2017         -1.45      0.38    -2.22    -0.73 1.00    58414    57191
# sigma_Site_YearRedRiver_2018         -1.37      0.38    -2.12    -0.62 1.00    51715    23443
# sigma_Site_YearSandyBar_2017         -0.82      0.42    -1.65    -0.02 1.00    73711    81483
# sigma_Site_YearSandyBar_2018         -1.40      0.41    -2.25    -0.63 1.00    16723     7422
# sigma_Site_YearWinnipegRiver_2017    -1.98      0.64    -3.20    -0.66 1.00    78921    59585
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     3.35      2.19     1.55     7.97 1.00    65182    56020
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
get_variables(leucine_syrm_model)
model_dataframe_leu_syrm <- leucine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_leu_syrm$Site<- factor(model_dataframe_leu_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

leurm_site_year_plot <- ggplot(data = model_dataframe_leu_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_leu_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_leu_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "leucine_syrm_plot.pdf", plot = ilerm_site_year_plot, dpi = 900)
summary(leucine_syrm_model)
leurm_site_year_plot
save(leucine_syrm_model, file= "leucine_syrm_model.rda")

#### Lysine Year_Site RS ####
hist(raw_dataf$Lysine)
lysine_syrm_model <- brm(data=raw_dataf,
                         family = student,
                         bf(Lysine ~ -1 + Site_Year + K + (Site_Year | Sex),
                            sigma ~ Site_Year),
                         prior = c(prior(normal(0,225), lb= 0, class = b)),
                         iter = 50000, warmup = 10000, chains = 4, cores = 4,
                         control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# lysine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(lysine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(lysine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(lysine_syrm_model, N = 2, ask = FALSE)
summary(lysine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Lysine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  49.46     46.64     1.84   170.91 1.00    30994    52109
# sd(Site_YearDauphinRiver_2018)                                 31.24     36.12     0.83   130.64 1.00    45694    68279
# sd(Site_YearMatheson_2017)                                     79.03     72.36     2.90   262.71 1.00    85106    53565
# sd(Site_YearMatheson_2018)                                     44.69     55.06     0.93   196.13 1.00    56504    80067
# sd(Site_YearRedRiver_2017)                                     57.88     61.89     1.53   218.82 1.00    80797    78385
# sd(Site_YearRedRiver_2018)                                     57.98     61.01     2.11   217.22 1.00    63464    69868
# sd(Site_YearSandyBar_2017)                                     65.10     66.09     1.93   239.06 1.00    79595    79511
# sd(Site_YearSandyBar_2018)                                     50.99     42.75     4.07   163.31 1.00    60879    55427
# sd(Site_YearWinnipegRiver_2017)                               107.18    103.85     3.68   364.16 1.00   117390    76730
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.01      0.32    -0.62     0.60 1.00   166709   113982
# cor(Intercept,Site_YearMatheson_2017)                           0.01      0.32    -0.60     0.61 1.00   187216   114225
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.01      0.32    -0.61     0.60 1.00   152009    88601
# cor(Intercept,Site_YearMatheson_2018)                          -0.00      0.32    -0.61     0.61 1.00   177386    76322
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.04      0.32    -0.58     0.64 1.00   147371   106372
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.01      0.32    -0.61     0.60 1.00   136248    92033
# cor(Intercept,Site_YearRedRiver_2017)                          -0.01      0.32    -0.62     0.60 1.00   184237   118317
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.01      0.32    -0.60     0.61 1.00   162554   118454
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.61 1.00   142198   123360
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.61 1.00   130189   126683
# cor(Intercept,Site_YearRedRiver_2018)                           0.03      0.32    -0.59     0.63 1.00   175376   115661
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.01      0.32    -0.60     0.62 1.00   143618   114101
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.02      0.32    -0.59     0.62 1.00   140065   121821
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.61 1.00   121744   125019
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.00      0.32    -0.61     0.61 1.00   115806   127196
# cor(Intercept,Site_YearSandyBar_2017)                          -0.01      0.32    -0.61     0.61 1.00   191911   115286
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.61     0.61 1.00   157313   115862
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.61 1.00   142085   125759
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.60     0.60 1.00   124648   120244
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.61     0.61 1.00   119934   127358
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.61 1.00   111503   127915
# cor(Intercept,Site_YearSandyBar_2018)                           0.04      0.32    -0.57     0.64 1.00   161100   118343
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.01      0.32    -0.60     0.62 1.00   140476    80656
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.03      0.31    -0.57     0.63 1.00   131446   124716
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)             -0.00      0.32    -0.61     0.61 1.00   120384   126206
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.00      0.32    -0.60     0.60 1.00   118518   128690
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.05      0.31    -0.55     0.64 1.00   109359   127424
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)              0.02      0.32    -0.59     0.61 1.00   101244   128184
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.01      0.32    -0.61     0.60 1.00   197546   114637
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.01      0.32    -0.60     0.60 1.00   171493   120256
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.60     0.61 1.00   148887   122808
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   131904   123888
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   121944   124641
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   112648   124842
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   101478   127316
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.60     0.61 1.00   102612   126774
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.57      0.20     4.18     4.98 1.00    56442    73782
# Site_YearDauphinRiver_2017          241.58     31.72   181.65   307.85 1.00    77167    88177
# Site_YearDauphinRiver_2018           20.77     23.56     0.47    85.81 1.00    45488    65592
# Site_YearMatheson_2017              160.20     65.12    31.08   298.62 1.00    66468    42946
# Site_YearMatheson_2018               36.22     35.97     1.59   136.15 1.00    51164    69913
# Site_YearRedRiver_2017              153.39     47.92    46.98   254.54 1.00    53514    36441
# Site_YearRedRiver_2018               50.60     41.56     3.17   160.27 1.00    58310    61281
# Site_YearSandyBar_2017              177.15     53.80    54.45   285.69 1.00    54383    33636
# Site_YearSandyBar_2018               47.93     33.82     3.58   131.48 1.00    60666    60342
# Site_YearWinnipegRiver_2017         190.35     90.70    21.62   379.91 1.00    82054    49856
# K                                    24.52     18.35     1.18    68.87 1.00    43789    64084
# sigma_Site_YearDauphinRiver_2018     -2.52      0.31    -3.12    -1.90 1.00    81644    99069
# sigma_Site_YearMatheson_2017         -0.28      0.51    -1.24     0.77 1.00    82647    70465
# sigma_Site_YearMatheson_2018         -1.95      0.29    -2.51    -1.36 1.00    77830    96791
# sigma_Site_YearRedRiver_2017         -0.87      0.28    -1.43    -0.31 1.00    76012    93971
# sigma_Site_YearRedRiver_2018         -1.35      0.30    -1.92    -0.76 1.00    76437    94673
# sigma_Site_YearSandyBar_2017         -0.25      0.28    -0.81     0.29 1.00    72440    88208
# sigma_Site_YearSandyBar_2018         -1.43      0.30    -2.02    -0.83 1.00    79082    95270
# sigma_Site_YearWinnipegRiver_2017     0.16      0.51    -0.74     1.28 1.00   102398    95111
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    21.24     14.05     3.92    56.72 1.00    91793    58472
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1). 
get_variables(lysine_syrm_model)
model_dataframe_lys_syrm <- lysine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_lys_syrm$Site<- factor(model_dataframe_lys_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

lysrm_site_year_plot <- ggplot(data = model_dataframe_lys_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_lys_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_lys_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "lysine_syrm_plot.pdf", plot = lysrm_site_year_plot, dpi = 900)
summary(lysine_syrm_model)
lysrm_site_year_plot
save(lysine_syrm_model, file= "lysine_syrm_model.rda")
save(lysine_syrm_model, file= "lys_syrm_model.rda")
load(lysine_syrm_model.rda)
#### Methionine Year_Site RS ####
hist(raw_dataf$Methionine)
methionine_syrm_model <- brm(data=raw_dataf,
                             family = student,
                             bf(Methionine ~ -1 + Site_Year + K + (Site_Year | Sex),
                                sigma ~ Site_Year),
                             prior = c(prior(normal(0,80), lb= 0, class = b)),
                             iter = 50000, warmup = 10000, chains = 4, cores = 4,
                             control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# methionine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(methionine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(methionine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(methionine_syrm_model, N = 2, ask = FALSE)
summary(methionine_syrm_model)
get_variables(methionine_syrm_model)
model_dataframe_met_syrm <- methionine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_met_syrm$Site<- factor(model_dataframe_met_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

metrm_site_year_plot <- ggplot(data = model_dataframe_met_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_met_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_met_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "methionine_syrm_plot.pdf", plot = metrm_site_year_plot, dpi = 900)
summary(methionine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Methionine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                   9.65      9.64     0.32    35.38 1.00    66788    82657
# sd(Site_YearDauphinRiver_2018)                                 11.79     11.21     0.41    41.01 1.00    83774    78450
# sd(Site_YearMatheson_2017)                                     19.80     18.25     0.68    66.95 1.00    95092    58072
# sd(Site_YearMatheson_2018)                                     13.52     14.62     0.37    53.36 1.00    61124    42262
# sd(Site_YearRedRiver_2017)                                     15.81     16.29     0.47    57.94 1.00    91944    86749
# sd(Site_YearRedRiver_2018)                                     24.85     18.86     2.70    72.46 1.00    76051    53324
# sd(Site_YearSandyBar_2017)                                     15.66     15.98     0.47    57.47 1.00    95101    77743
# sd(Site_YearSandyBar_2018)                                     17.30     13.41     1.11    51.32 1.00    70234    52618
# sd(Site_YearWinnipegRiver_2017)                                24.54     24.42     0.82    87.20 1.00   100437    64695
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.01      0.32    -0.61     0.60 1.00   166715   100195
# cor(Intercept,Site_YearMatheson_2017)                          -0.02      0.32    -0.62     0.59 1.00   186416   103829
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.00      0.32    -0.61     0.60 1.00   161413   117664
# cor(Intercept,Site_YearMatheson_2018)                          -0.03      0.32    -0.63     0.58 1.00   184158    92553
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.00      0.32    -0.60     0.61 1.00   165957   117786
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.01      0.32    -0.60     0.61 1.00   138895   101691
# cor(Intercept,Site_YearRedRiver_2017)                          -0.01      0.32    -0.61     0.60 1.00   201838   111945
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.01      0.32    -0.60     0.61 1.00   174939   118057
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.00      0.32    -0.61     0.61 1.00   146352   123714
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)             -0.00      0.32    -0.60     0.60 1.00   129336   126467
# cor(Intercept,Site_YearRedRiver_2018)                           0.03      0.32    -0.58     0.62 1.00   132142    62450
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.02      0.32    -0.58     0.62 1.00   143341   111932
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.03      0.32    -0.62     0.58 1.00   130629   105370
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.59 1.00   128284   125287
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.01      0.32    -0.59     0.61 1.00   111938   120191
# cor(Intercept,Site_YearSandyBar_2017)                          -0.01      0.32    -0.62     0.60 1.00   167196    96799
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)          0.00      0.32    -0.60     0.61 1.00   149467   114033
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   148093   117671
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   131798   119962
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   116084   121527
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.60     0.60 1.00   115024   129335
# cor(Intercept,Site_YearSandyBar_2018)                           0.02      0.32    -0.59     0.61 1.00   139304    60308
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.03      0.32    -0.58     0.63 1.00   103000    62539
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.02      0.32    -0.62     0.59 1.00    95536    64104
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)             -0.00      0.32    -0.61     0.61 1.00   122666   105578
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.02      0.31    -0.59     0.61 1.00   118127   129531
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.09      0.31    -0.52     0.66 1.00   109713   129361
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.00      0.31    -0.60     0.60 1.00   101939    96232
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.60     0.60 1.00   193752   107152
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.00      0.32    -0.61     0.60 1.00   173842   105836
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   150389   116367
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   133772   121768
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   112532   106962
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00   105274   102821
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00    96554   124844
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00    97906   125687
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.48      0.21     3.09     3.90 1.00    61684    78914
# Site_YearDauphinRiver_2017           79.22     11.71    56.59   102.70 1.00    72525    51718
# Site_YearDauphinRiver_2018           21.02     10.80     2.99    44.94 1.00    57096    39062
# Site_YearMatheson_2017               42.97     18.58     8.59    83.42 1.00    67224    49438
# Site_YearMatheson_2018               13.72     11.24     0.69    43.32 1.00    42002    26643
# Site_YearRedRiver_2017               49.32     14.92    17.97    79.83 1.00    53727    45497
# Site_YearRedRiver_2018               22.78     16.01     1.54    62.46 1.00    70313    65662
# Site_YearSandyBar_2017               34.17     14.60     7.83    66.30 1.00    59963    47741
# Site_YearSandyBar_2018               15.06     11.36     0.78    42.92 1.00    70312    65659
# Site_YearWinnipegRiver_2017          34.78     21.41     3.22    87.83 1.00    74643    43187
# K                                    14.19      6.83     1.78    28.10 1.00    65503    55768
# sigma_Site_YearDauphinRiver_2018     -0.88      0.30    -1.46    -0.28 1.00    77091    56548
# sigma_Site_YearMatheson_2017         -0.46      0.49    -1.37     0.58 1.00    87552    68631
# sigma_Site_YearMatheson_2018         -1.73      0.30    -2.30    -1.14 1.00    76388    75426
# sigma_Site_YearRedRiver_2017         -0.90      0.30    -1.49    -0.32 1.00    71267    61188
# sigma_Site_YearRedRiver_2018         -0.83      0.30    -1.43    -0.23 1.00    74331    79134
# sigma_Site_YearSandyBar_2017         -0.42      0.30    -1.04     0.15 1.00    63078    54746
# sigma_Site_YearSandyBar_2018         -0.86      0.33    -1.54    -0.22 1.00    71718    63414
# sigma_Site_YearWinnipegRiver_2017    -0.79      0.54    -1.75     0.39 1.00   110478   102972
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    16.11     12.45     3.06    49.11 1.00    85068    89103
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 4 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
metrm_site_year_plot
save(methionine_syrm_model, file= "methionine_syrm_model.rda")

#### Phenylalanine Year_Site RS ####
hist(raw_dataf$Phenylalanine)
phenylalanine_syrm_model <- brm(data=raw_dataf,
                                family = student,
                                bf(Phenylalanine ~ -1 + Site_Year + K + (Site_Year | Sex),
                                   sigma ~ Site_Year),
                                prior = c(prior(normal(0,150), lb= 0, class = b)),
                                iter = 50000, warmup = 10000, chains = 4, cores = 4,
                                control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# phenylalanine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(methionine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(phenylalanine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(phenylalanine_syrm_model, N = 2, ask = FALSE)
summary(phenylalanine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Phenylalanine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  14.92     12.57     0.67    46.72 1.00    69421    73850
# sd(Site_YearDauphinRiver_2018)                                 15.76     13.98     0.61    51.27 1.00    80333    78692
# sd(Site_YearMatheson_2017)                                     19.49     18.83     0.67    67.62 1.00   120512    86251
# sd(Site_YearMatheson_2018)                                     15.01     15.97     0.44    57.04 1.00    93313    87654
# sd(Site_YearRedRiver_2017)                                     22.25     19.55     0.91    71.34 1.00    85765    78049
# sd(Site_YearRedRiver_2018)                                     25.46     20.78     1.32    77.29 1.00    82883    70629
# sd(Site_YearSandyBar_2017)                                     18.40     17.95     0.59    64.66 1.00   114998    88236
# sd(Site_YearSandyBar_2018)                                     19.24     14.56     1.15    55.40 1.00    77619    69538
# sd(Site_YearWinnipegRiver_2017)                                25.56     25.51     0.85    91.04 1.00   133653    86795
# cor(Intercept,Site_YearDauphinRiver_2018)                       0.02      0.32    -0.59     0.61 1.00   220489   115323
# cor(Intercept,Site_YearMatheson_2017)                           0.01      0.32    -0.59     0.61 1.00   240506   114929
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.02      0.32    -0.59     0.61 1.00   191093   117550
# cor(Intercept,Site_YearMatheson_2018)                          -0.03      0.32    -0.63     0.58 1.00   246566   114742
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.00      0.32    -0.60     0.61 1.00   191192   119763
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.00      0.32    -0.60     0.60 1.00   157405   115027
# cor(Intercept,Site_YearRedRiver_2017)                          -0.06      0.31    -0.64     0.55 1.00   206387   114655
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.02      0.31    -0.62     0.58 1.00   184033   119175
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.00      0.32    -0.61     0.60 1.00   158465   119562
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.01      0.32    -0.59     0.61 1.00   133689   119780
# cor(Intercept,Site_YearRedRiver_2018)                           0.04      0.31    -0.56     0.63 1.00   210366    96672
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.05      0.31    -0.57     0.63 1.00   181349   121423
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.02      0.32    -0.59     0.61 1.00   160030   124182
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.60 1.00   133267   122562
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.04      0.31    -0.62     0.57 1.00   125925   131023
# cor(Intercept,Site_YearSandyBar_2017)                          -0.02      0.32    -0.62     0.58 1.00   239357   114869
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.61     0.60 1.00   193816   122007
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   153452   107941
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.61 1.00   137212   123812
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   120819   126773
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.01      0.32    -0.61     0.60 1.00   110149   122823
# cor(Intercept,Site_YearSandyBar_2018)                           0.04      0.31    -0.56     0.63 1.00   214572   118913
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.06      0.32    -0.55     0.65 1.00   168534   122024
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.02      0.31    -0.58     0.62 1.00   150127   124032
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)             -0.00      0.32    -0.61     0.61 1.00   126352   119908
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.04      0.31    -0.63     0.56 1.00   123779   127977
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.07      0.31    -0.54     0.65 1.00   111049   125138
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.01      0.32    -0.60     0.60 1.00    99928   127794
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.01      0.32    -0.61     0.60 1.00   254319   111185
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.00      0.32    -0.60     0.60 1.00   200787   115878
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00   161301   115820
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   137895   117627
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   118577   124535
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00   109158   109014
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00    93982   123780
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00    93495   126347
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.04      0.20     3.66     4.45 1.00    86560    92320
# Site_YearDauphinRiver_2017          106.38     20.88    67.48   148.92 1.00    66002    96679
# Site_YearDauphinRiver_2018           52.50     17.80    18.98    88.95 1.00    47658    56289
# Site_YearMatheson_2017               51.06     23.50     9.55   102.40 1.00    64334    62785
# Site_YearMatheson_2018               23.34     16.57     1.39    61.58 1.00    53507    71545
# Site_YearRedRiver_2017               51.79     23.22    11.61   102.14 1.00    55031    64643
# Site_YearRedRiver_2018               46.13     23.62     6.87    98.55 1.00    54068    58320
# Site_YearSandyBar_2017               49.45     22.04    10.78    96.51 1.00    53985    58733
# Site_YearSandyBar_2018               28.83     17.66     2.47    68.63 1.00    52758    72193
# Site_YearWinnipegRiver_2017          46.99     28.46     4.78   114.49 1.00    56140    67958
# K                                    26.89     12.83     2.52    50.44 1.00    48672    53737
# sigma_Site_YearDauphinRiver_2018     -1.30      0.30    -1.88    -0.70 1.00   101581   114182
# sigma_Site_YearMatheson_2017         -0.84      0.47    -1.68     0.19 1.00   116897   102705
# sigma_Site_YearMatheson_2018         -1.84      0.29    -2.41    -1.26 1.00   109966   114040
# sigma_Site_YearRedRiver_2017         -1.19      0.29    -1.76    -0.62 1.00   101371   110224
# sigma_Site_YearRedRiver_2018         -0.73      0.31    -1.33    -0.13 1.00   104219   112334
# sigma_Site_YearSandyBar_2017         -0.48      0.28    -1.04     0.07 1.00   100386   106887
# sigma_Site_YearSandyBar_2018         -1.38      0.30    -1.98    -0.78 1.00   101632    98446
# sigma_Site_YearWinnipegRiver_2017    -1.99      0.64    -3.21    -0.66 1.00    70821    86487
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    19.32     13.07     4.23    53.12 1.00   142660    98924
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1). Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup  Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
get_variables(phenylalanine_syrm_model)
model_dataframe_phe_syrm <- phenylalanine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_phe_syrm$Site<- factor(model_dataframe_phe_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

pherm_site_year_plot <- ggplot(data = model_dataframe_phe_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_phe_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_phe_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "phenylalanine_syrm_plot.pdf", plot = pherm_site_year_plot, dpi = 900)
summary(phenylalanine_syrm_model)
pherm_site_year_plot
save(phenylalanine_syrm_model, file= "phenylalanine_syrm_model.rda")

#### Proline Year_Site RS ####
hist(raw_dataf$Proline)
proline_syrm_model <- brm(data=raw_dataf,
                          family = student,
                          bf(Proline ~ -1 + Site_Year + K + (Site_Year | Sex),
                             sigma ~ Site_Year),
                          prior = c(prior(normal(0,200), lb= 0, class = b)),
                          iter = 50000, warmup = 10000, chains = 4, cores = 4,
                          control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# proline_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(proline ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(proline_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(proline_syrm_model, N = 2, ask = FALSE)
summary(proline_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Proline ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  33.00     38.92     1.36   124.12 1.00     1575      417
# sd(Site_YearDauphinRiver_2018)                                 44.21     36.79     1.75   136.42 1.00    69260    72671
# sd(Site_YearMatheson_2017)                                     48.72     45.13     1.76   163.84 1.00   145084    83176
# sd(Site_YearMatheson_2018)                                     43.15     42.90     1.17   151.93 1.00     5321     7398
# sd(Site_YearRedRiver_2017)                                     33.66     35.44     0.99   126.59 1.00    51196    85607
# sd(Site_YearRedRiver_2018)                                     32.06     35.32     0.94   126.99 1.00    80534    92460
# sd(Site_YearSandyBar_2017)                                     34.91     36.54     1.05   129.78 1.00     4800     5800
# sd(Site_YearSandyBar_2018)                                     35.66     30.10     2.13   112.74 1.00    48355    65015
# sd(Site_YearWinnipegRiver_2017)                                61.33     58.99     2.15   207.15 1.00     4584     4927
# cor(Intercept,Site_YearDauphinRiver_2018)                       0.01      0.32    -0.59     0.62 1.00     3438      524
# cor(Intercept,Site_YearMatheson_2017)                           0.00      0.32    -0.60     0.60 1.00     8673    25123
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.00      0.31    -0.60     0.60 1.00    60241   117066
# cor(Intercept,Site_YearMatheson_2018)                          -0.01      0.32    -0.61     0.59 1.00   231100   117307
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)         -0.01      0.32    -0.61     0.60 1.00     8993   119340
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.00      0.32    -0.60     0.60 1.00    27396   114483
# cor(Intercept,Site_YearRedRiver_2017)                           0.00      0.32    -0.61     0.60 1.00    57594   118555
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.01      0.32    -0.59     0.61 1.00    25902   123107
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.00      0.32    -0.61     0.61 1.00   163061   124815
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.60 1.00    80868   123380
# cor(Intercept,Site_YearRedRiver_2018)                           0.01      0.32    -0.60     0.61 1.00    79628   116707
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.01      0.32    -0.59     0.61 1.00     7933   115852
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.61 1.00   144369   124792
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.61 1.00     4501     4745
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.02      0.32    -0.60     0.62 1.00   110696   125828
# cor(Intercept,Site_YearSandyBar_2017)                          -0.02      0.32    -0.61     0.59 1.00     5175    43050
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.31    -0.60     0.60 1.00   118839   121314
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)             -0.00      0.32    -0.60     0.60 1.00     7254    26426
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   123585   126713
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00    15776   124250
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.62 1.00   108350   121926
# cor(Intercept,Site_YearSandyBar_2018)                           0.02      0.32    -0.58     0.62 1.00    33552   120896
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.04      0.31    -0.57     0.63 1.00    28616   122884
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.00      0.31    -0.60     0.60 1.00   152061   127001
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)             -0.01      0.31    -0.61     0.59 1.00   131770   127916
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.02      0.32    -0.59     0.62 1.00   111611   125550
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.03      0.31    -0.58     0.63 1.00   109982   128323
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)              0.01      0.32    -0.60     0.60 1.00    16126   125288
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.01      0.32    -0.61     0.60 1.00    21856   111186
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.01      0.32    -0.60     0.60 1.00     9746   115500
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)        -0.00      0.31    -0.60     0.60 1.00   138833   118020
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.00      0.31    -0.60     0.60 1.00   134425   120049
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.60     0.60 1.00     6403    38044
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00    12255   126129
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.31    -0.60     0.60 1.00    98824   124012
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.60     0.60 1.00    91528   127175
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.56      0.24     4.08     5.02 1.00     2795      403
# Site_YearDauphinRiver_2017          156.83     38.20    89.75   237.87 1.00     1603      429
# Site_YearDauphinRiver_2018           98.20     36.62    25.98   182.82 1.00     2150      433
# Site_YearMatheson_2017              108.19     57.25    13.26   238.67 1.00     3004      516
# Site_YearMatheson_2018               42.64     41.80     2.04   164.84 1.00     1843      437
# Site_YearRedRiver_2017               75.91     34.61    17.30   168.99 1.00     2052      419
# Site_YearRedRiver_2018               28.57     28.98     0.98   120.26 1.00     2200      402
# Site_YearSandyBar_2017               69.04     35.58    12.54   167.79 1.00     2121      437
# Site_YearSandyBar_2018               32.95     28.23     1.60   111.61 1.00     1858      418
# Site_YearWinnipegRiver_2017         115.20     51.87    19.84   235.53 1.00     8884    50326
# K                                    29.86     16.14     3.58    67.05 1.00    45936    58165
# sigma_Site_YearDauphinRiver_2018     -0.98      0.38    -1.76    -0.25 1.00    19090    96778
# sigma_Site_YearMatheson_2017         -0.16      0.51    -1.11     0.90 1.00    23798   109951
# sigma_Site_YearMatheson_2018         -1.72      0.37    -2.45    -0.99 1.00    85901   105404
# sigma_Site_YearRedRiver_2017         -1.43      0.36    -2.13    -0.70 1.00     2369      409
# sigma_Site_YearRedRiver_2018         -2.23      0.41    -3.04    -1.44 1.00    13855   100225
# sigma_Site_YearSandyBar_2017         -0.87      0.35    -1.59    -0.21 1.00     8386    98707
# sigma_Site_YearSandyBar_2018         -1.60      0.38    -2.36    -0.89 1.00     6076   103201
# sigma_Site_YearWinnipegRiver_2017    -1.80      0.64    -3.02    -0.46 1.00   125665   102498
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     4.39      4.00     1.65    14.62 1.00    59239    82061
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

get_variables(proline_syrm_model)
model_dataframe_pro_syrm <- proline_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_pro_syrm$Site<- factor(model_dataframe_pro_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

prorm_site_year_plot <- ggplot(data = model_dataframe_pro_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_pro_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_pro_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "proline_syrm_plot.pdf", plot = prorm_site_year_plot, dpi = 900)
summary(proline_syrm_model)
prorm_site_year_plot
save(proline_syrm_model, file= "proline_syrm_model")
save(proline_syrm_model, file= "proline_syrm_model.RDA")
load(proline_syrm_model)
#### Serine Year_Site RS ####
hist(raw_dataf$Serine)
serine_syrm_model <- brm(data=raw_dataf,
                         family = student,
                         bf(Serine ~ -1 + Site_Year + K + (Site_Year | Sex),
                            sigma ~ Site_Year),
                         prior = c(prior(normal(0,150), lb= 0, class = b)),
                         iter = 50000, warmup = 10000, chains = 4, cores = 4,
                         control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# serine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Serine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))


pp_check(serine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(serine_syrm_model, N = 2, ask = FALSE)
summary(proline_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Proline ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI
# sd(Intercept)                                                  29.64     27.29     1.30   101.14
# sd(Site_YearDauphinRiver_2018)                                 44.31     37.31     1.70   137.60
# sd(Site_YearMatheson_2017)                                     48.74     46.14     1.64   166.49
# sd(Site_YearMatheson_2018)                                     42.53     43.30     1.19   153.92
# sd(Site_YearRedRiver_2017)                                     34.00     35.90     1.00   128.03
# sd(Site_YearRedRiver_2018)                                     32.33     35.66     0.90   130.59
# sd(Site_YearSandyBar_2017)                                     35.21     36.63     1.10   130.25
# sd(Site_YearSandyBar_2018)                                     35.96     29.99     1.99   112.62
# sd(Site_YearWinnipegRiver_2017)                                59.97     58.56     2.04   208.50
# cor(Intercept,Site_YearDauphinRiver_2018)                       0.02      0.32    -0.59     0.62
# cor(Intercept,Site_YearMatheson_2017)                          -0.00      0.32    -0.61     0.61
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.00      0.32    -0.60     0.61
# cor(Intercept,Site_YearMatheson_2018)                          -0.01      0.32    -0.62     0.60
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)         -0.00      0.32    -0.61     0.62
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.00      0.32    -0.60     0.60
# cor(Intercept,Site_YearRedRiver_2017)                          -0.00      0.32    -0.61     0.60
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.01      0.32    -0.59     0.61
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.61
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)             -0.00      0.32    -0.60     0.60
# cor(Intercept,Site_YearRedRiver_2018)                           0.01      0.32    -0.60     0.61
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.02      0.32    -0.59     0.61
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.61
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.01      0.32    -0.59     0.61
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.02      0.32    -0.60     0.62
# cor(Intercept,Site_YearSandyBar_2017)                          -0.01      0.32    -0.62     0.60
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.31    -0.60     0.60
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.62
# cor(Intercept,Site_YearSandyBar_2018)                           0.02      0.32    -0.58     0.62
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.04      0.31    -0.56     0.63
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.00      0.32    -0.60     0.60
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)             -0.01      0.32    -0.61     0.60
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.02      0.32    -0.59     0.62
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.03      0.32    -0.58     0.62
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.00      0.32    -0.60     0.60
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.61     0.60
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.00      0.32    -0.60     0.60
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61
# Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                               1.00    55252    64298
# sd(Site_YearDauphinRiver_2018)                              1.00    68617    72226
# sd(Site_YearMatheson_2017)                                  1.00   133544    77270
# sd(Site_YearMatheson_2018)                                  1.00    77825    80212
# sd(Site_YearRedRiver_2017)                                  1.00    97852    85645
# sd(Site_YearRedRiver_2018)                                  1.00    23746     6171
# sd(Site_YearSandyBar_2017)                                  1.00    51900    11503
# sd(Site_YearSandyBar_2018)                                  1.00    65247    57552
# sd(Site_YearWinnipegRiver_2017)                             1.00   119978    79393
# cor(Intercept,Site_YearDauphinRiver_2018)                   1.00   188237   112693
# cor(Intercept,Site_YearMatheson_2017)                       1.00    38119     6079
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)      1.00   117811   115036
# cor(Intercept,Site_YearMatheson_2018)                       1.00   217422   118981
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)      1.00    30695     6166
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)          1.00   145128   119683
# cor(Intercept,Site_YearRedRiver_2017)                       1.00   212756   112806
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)      1.00   120390   119612
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)          1.00   150917   117918
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)          1.00   114744   127512
# cor(Intercept,Site_YearRedRiver_2018)                       1.00    43650     8092
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)      1.00   168570   119660
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)          1.00   146278   124361
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)          1.00   127520   124759
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)          1.00    51354     7529
# cor(Intercept,Site_YearSandyBar_2017)                       1.00   203258   110978
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)      1.00   172170   116863
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)          1.00   154388   119692
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)          1.00   122072   124150
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)          1.00   117101   125812
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)          1.00   109497   125006
# cor(Intercept,Site_YearSandyBar_2018)                       1.00   118603   117115
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)      1.00   150923   121382
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)          1.00   131049   122459
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)          1.00   117829   126345
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)          1.00   115480   125522
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)          1.00    86851   128130
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)          1.00   100348   124542
# cor(Intercept,Site_YearWinnipegRiver_2017)                  1.00   244666   109113
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017) 1.00   183705   116890
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)     1.00    37192     6580
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)     1.00   136110   119341
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)     1.00    90760   117744
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)     1.00   107124   123244
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)     1.00    91094   123492
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)     1.00    95892   126739
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       4.56      0.23     4.10     5.02 1.00    75151    72171
# Site_YearDauphinRiver_2017          154.91     34.65    90.04   225.69 1.00    39064     6138
# Site_YearDauphinRiver_2018           96.83     34.68    25.32   168.18 1.00    59556    45996
# Site_YearMatheson_2017              106.36     55.77    12.94   229.29 1.00    71921    50877
# Site_YearMatheson_2018               40.25     35.98     1.95   136.81 1.00    65196    74717
# Site_YearRedRiver_2017               74.45     31.71    17.69   146.72 1.00    60151    51773
# Site_YearRedRiver_2018               27.72     28.73     0.99   101.15 1.00    13098     5967
# Site_YearSandyBar_2017               67.42     32.74    12.83   143.94 1.00    60619    50599
# Site_YearSandyBar_2018               31.45     24.74     1.66    93.27 1.00    69331    70606
# Site_YearWinnipegRiver_2017         115.84     51.48    19.82   234.56 1.00    66475    44923
# K                                    29.57     16.07     3.69    66.83 1.00    68924    58224
# sigma_Site_YearDauphinRiver_2018     -0.98      0.38    -1.76    -0.25 1.00    52165    73747
# sigma_Site_YearMatheson_2017         -0.15      0.51    -1.11     0.91 1.00   116430   103274
# sigma_Site_YearMatheson_2018         -1.72      0.38    -2.48    -0.99 1.00    20615     6430
# sigma_Site_YearRedRiver_2017         -1.44      0.35    -2.14    -0.77 1.00    70080    97436
# sigma_Site_YearRedRiver_2018         -2.23      0.41    -3.05    -1.44 1.00    43551    10453
# sigma_Site_YearSandyBar_2017         -0.88      0.35    -1.62    -0.22 1.00    25713     6124
# sigma_Site_YearSandyBar_2018         -1.61      0.37    -2.36    -0.89 1.00    73702    96122
# sigma_Site_YearWinnipegRiver_2017    -1.80      0.65    -3.03    -0.45 1.00   103398    96112
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     4.38      3.99     1.65    14.44 1.00    64483    77734
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
get_variables(serine_syrm_model)
model_dataframe_ser_syrm <- serine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_ser_syrm$Site<- factor(model_dataframe_ser_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

serrm_site_year_plot <- ggplot(data = model_dataframe_ser_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_ser_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_ser_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "serine_syrm_plot.pdf", plot = serrm_site_year_plot, dpi = 900)
summary(serine_syrm_model)
serrm_site_year_plot
save(serine_syrm_model, file= "serine_syrm_model")

#### Threonine Year_Site RS ####
hist(raw_dataf$Threonine)
threonine_syrm_model <- brm(data=raw_dataf,
                            family = student,
                            bf(Threonine ~ -1 + Site_Year + K + (Site_Year | Sex),
                               sigma ~ Site_Year),
                            prior = c(prior(normal(0,175), lb= 0, class = b)),
                            iter = 50000, warmup = 10000, chains = 4, cores = 4,
                            control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# threonine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Threonine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(threonine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(threonine_syrm_model, N = 2, ask = FALSE)
summary(threonine_syrm_model)
# get_variables(threonine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Threonine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  24.50     23.60     0.84    86.01 1.00    86011    84121
# sd(Site_YearDauphinRiver_2018)                                 33.08     30.29     1.16   110.41 1.00    96843    84568
# sd(Site_YearMatheson_2017)                                     48.29     43.99     1.79   159.44 1.00   116717    81634
# sd(Site_YearMatheson_2018)                                     37.68     36.79     1.24   132.25 1.00   114139    82840
# sd(Site_YearRedRiver_2017)                                     33.93     35.37     0.98   125.39 1.00    90915    89128
# sd(Site_YearRedRiver_2018)                                     74.23     47.22    14.42   193.62 1.00    95640    62969
# sd(Site_YearSandyBar_2017)                                     41.88     37.80     1.65   138.45 1.00    96824    80274
# sd(Site_YearSandyBar_2018)                                     39.73     30.15     3.41   117.27 1.00    77367    65935
# sd(Site_YearWinnipegRiver_2017)                                55.46     56.25     1.78   196.81 1.00   153847    85348
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.00      0.32    -0.60     0.60 1.00   236985   110377
# cor(Intercept,Site_YearMatheson_2017)                          -0.02      0.32    -0.62     0.59 1.00   263052   115510
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.01      0.32    -0.61     0.59 1.00   203884   119093
# cor(Intercept,Site_YearMatheson_2018)                          -0.00      0.32    -0.61     0.60 1.00   268322   113542
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.01      0.32    -0.60     0.61 1.00   203700   115166
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.00      0.32    -0.60     0.60 1.00   168418   124416
# cor(Intercept,Site_YearRedRiver_2017)                          -0.01      0.32    -0.61     0.60 1.00   249359    96278
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.01      0.32    -0.60     0.61 1.00   203165   122008
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.00      0.32    -0.61     0.60 1.00   162626   122030
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.60 1.00   145125   124104
# cor(Intercept,Site_YearRedRiver_2018)                           0.04      0.31    -0.57     0.62 1.00   216113   119020
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.05      0.31    -0.56     0.63 1.00   174249   127537
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.04      0.31    -0.63     0.56 1.00   150444   124401
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.01      0.32    -0.59     0.61 1.00   135699   132313
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.01      0.31    -0.59     0.61 1.00   127055   131980
# cor(Intercept,Site_YearSandyBar_2017)                          -0.03      0.32    -0.63     0.58 1.00   251610   112558
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.02      0.32    -0.62     0.59 1.00   199185   121191
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   150377    80895
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.60 1.00   137593   126968
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.60 1.00   115007    84131
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.05      0.31    -0.63     0.55 1.00   116112   126896
# cor(Intercept,Site_YearSandyBar_2018)                           0.02      0.32    -0.58     0.62 1.00   213534   119411
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.05      0.32    -0.57     0.64 1.00   167090    94036
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.03      0.31    -0.62     0.58 1.00   148276    87349
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.02      0.32    -0.59     0.62 1.00   133999   130593
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.02      0.32    -0.59     0.61 1.00   117833   128769
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.10      0.30    -0.50     0.66 1.00   113366   133657
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.04      0.31    -0.63     0.57 1.00   105118   131160
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.61     0.60 1.00   256847    81568
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.00      0.32    -0.60     0.60 1.00   204312   105878
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   165877   117685
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00   137608   120900
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   121184   125892
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   114472   124639
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00    95463   125178
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00    96613   126809
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.86      0.20     3.48     4.27 1.00    69493    83657
# Site_YearDauphinRiver_2017          118.55     25.25    71.60   170.43 1.00    62947    68709
# Site_YearDauphinRiver_2018           67.43     31.34    11.11   133.56 1.00    64921    50332
# Site_YearMatheson_2017              111.90     48.72    19.24   214.39 1.00    75653    50065
# Site_YearMatheson_2018               77.22     34.74    14.60   152.04 1.00    69952    54756
# Site_YearRedRiver_2017               92.98     35.02    26.09   166.24 1.00    57359    54519
# Site_YearRedRiver_2018               65.87     43.99     4.41   171.75 1.00    84955    72138
# Site_YearSandyBar_2017               82.33     36.79    16.52   162.91 1.00    66637    56454
# Site_YearSandyBar_2018               30.49     24.78     1.18    91.92 1.00    78856    85243
# Site_YearWinnipegRiver_2017          81.90     55.16     5.33   213.26 1.00    93441    68712
# K                                    56.06     20.41    15.03    95.66 1.00    66146    58562
# sigma_Site_YearDauphinRiver_2018      0.08      0.29    -0.48     0.65 1.00    89045   112358
# sigma_Site_YearMatheson_2017          0.33      0.46    -0.50     1.33 1.00   112707   105866
# sigma_Site_YearMatheson_2018         -0.05      0.29    -0.61     0.52 1.00    96105   111258
# sigma_Site_YearRedRiver_2017         -0.54      0.28    -1.09     0.02 1.00    94042    87787
# sigma_Site_YearRedRiver_2018          0.08      0.30    -0.50     0.67 1.00    94608   111541
# sigma_Site_YearSandyBar_2017         -0.20      0.27    -0.73     0.33 1.00    90411   105286
# sigma_Site_YearSandyBar_2018         -0.75      0.30    -1.33    -0.16 1.00    94250   100216
# sigma_Site_YearWinnipegRiver_2017     0.48      0.49    -0.37     1.58 1.00   132194   102722
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    24.11     14.09     6.25    59.60 1.00   207437   113158
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 9 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup easing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
model_dataframe_thr_syrm <- threonine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_thr_syrm$Site<- factor(model_dataframe_thr_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

model_dataframe_thr_syrm <- gather_emmeans_draws(emmeans(threonine_syrm_model, ~ Site_Year)) %>% 
  separate(Site_Year, into = c("Site", "Year"), sep = "_")

thrrm_site_year_plot <- ggplot(data = model_dataframe_thr_syrm, aes(x = .value, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_thr_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_thr_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "threonine_syrm_plot.pdf", plot = thrrm_site_year_plot, dpi = 900)
summary(threnine_syrm_model)
thrrm_site_year_plot
save(threonine_syrm_model, file= "threonine_syrm_model.rda")

#### Tryptophan Year_Site RS ####
hist(raw_dataf$Tryptophan)
tryptophan_syrm_model <- brm(data=raw_dataf,
                             family = student,
                             bf(Tryptophan ~ -1 + Site_Year + K + (Site_Year | Sex),
                                sigma ~ Site_Year),
                             prior = c(prior(normal(0,25), lb= 0, class = b)),
                             iter = 50000, warmup = 10000, chains = 4, cores = 4,
                             control = list(adapt_delta = 0.95, max_treedepth = 15))

tyrosine_emmeans <- summary(emmeans(tyrosine_syrm_model, ~ Site_Year, re_formula = NULL))
pairs(emmeans(tyrosine_syrm_model, ~ Site_Year, re_formula = NULL))


test_tyr <- brm(data=raw_dataf,
                             family = skew_normal,
                             bf(Tyrosine ~ Site_Year + K + Sex,
                                sigma ~ Site_Year + K + Sex),
                             prior = c(prior(normal(0,30), class = b),
                                       prior(normal(0,30), class = Intercept)),
                             iter = 20000, warmup = 5000, chains = 4, cores = 4,
                             control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_tyr)
pp_check(test_tyr, ndraws = 100) +
  theme_bw()
summary(test_tyr)
emmeans(test_tyr, ~ Site_Year)
pairs(emmeans(test_tyr, ~ Site_Year))
plot(emmeans(test_tyr, ~ Site_Year))
plot(emmeans(test_tyr, ~ Sex*Site_Year))
plot(pairs(emmeans(test_tyr, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)

# just try less iterations

# tryptophan_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Tryptophan ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(tryptophan_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(tryptophan_syrm_model, N = 2, ask = FALSE)
summary(tryptophan_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Tryptophan ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                   3.01      2.96     0.10    10.94 1.00    93302    87542
# sd(Site_YearDauphinRiver_2018)                                  5.31      4.82     0.18    17.56 1.00   100655    86591
# sd(Site_YearMatheson_2017)                                      5.66      5.34     0.20    19.15 1.00   135521    85055
# sd(Site_YearMatheson_2018)                                      4.28      4.42     0.14    15.75 1.00   113570    93730
# sd(Site_YearRedRiver_2017)                                      4.83      4.72     0.16    16.99 1.00   116708    89265
# sd(Site_YearRedRiver_2018)                                      5.14      4.72     0.21    17.21 1.00   105866    85484
# sd(Site_YearSandyBar_2017)                                      4.35      4.45     0.13    15.94 1.00   126899    90505
# sd(Site_YearSandyBar_2018)                                      3.50      3.34     0.12    12.30 1.00   100037    83750
# sd(Site_YearWinnipegRiver_2017)                                 6.83      6.84     0.23    24.34 1.00   143683    85108
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.00      0.32    -0.61     0.60 1.00   267364   113435
# cor(Intercept,Site_YearMatheson_2017)                           0.00      0.32    -0.60     0.61 1.00   285102   114258
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.01      0.32    -0.60     0.61 1.00   210072   117457
# cor(Intercept,Site_YearMatheson_2018)                          -0.01      0.32    -0.61     0.60 1.00   274577   120863
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)         -0.00      0.32    -0.61     0.61 1.00   206003   118981
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.00      0.32    -0.60     0.60 1.00   166288   123215
# cor(Intercept,Site_YearRedRiver_2017)                          -0.02      0.32    -0.62     0.59 1.00   256878   116796
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.01      0.32    -0.61     0.59 1.00   200958   119117
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.01      0.32    -0.61     0.60 1.00   167111   121880
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.61     0.60 1.00   144238   124125
# cor(Intercept,Site_YearRedRiver_2018)                           0.01      0.32    -0.60     0.61 1.00   266837   119963
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.02      0.32    -0.59     0.62 1.00   196857   121945
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.01      0.32    -0.59     0.61 1.00   165388   124584
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.61 1.00   141754   127973
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.01      0.32    -0.62     0.59 1.00   123562   125604
# cor(Intercept,Site_YearSandyBar_2017)                          -0.01      0.32    -0.61     0.60 1.00   266983   117076
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.60     0.60 1.00   205162   119230
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.61 1.00   171647   123403
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   146015   123590
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.61 1.00   125574   124771
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.61     0.61 1.00   108301   125843
# cor(Intercept,Site_YearSandyBar_2018)                          -0.00      0.32    -0.61     0.61 1.00   256275   118956
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.02      0.32    -0.59     0.61 1.00   200855   123019
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.01      0.32    -0.59     0.61 1.00   160435   121862
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.02      0.32    -0.59     0.61 1.00   139798   128997
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.01      0.32    -0.61     0.60 1.00   125128   128046
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.03      0.32    -0.58     0.63 1.00   110166   127741
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)              0.00      0.32    -0.60     0.61 1.00   100591   126667
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.61     0.60 1.00   294237   109585
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.00      0.32    -0.60     0.60 1.00   218707   118428
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00   170767   122598
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   146889   123841
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   126090   125944
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   108535   128348
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00    94647   121726
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00    93303   124623
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       2.29      0.20     1.92     2.70 1.00    78754    83937
# Site_YearDauphinRiver_2017           18.61      3.77    11.61    26.53 1.00    75034    90562
# Site_YearDauphinRiver_2018           19.12      5.34     7.58    29.44 1.00    77371    62484
# Site_YearMatheson_2017               11.74      5.98     1.55    25.01 1.00    83265    59631
# Site_YearMatheson_2018                5.56      3.79     0.44    14.76 1.00    70098    72488
# Site_YearRedRiver_2017                8.23      4.66     1.02    18.85 1.00    65049    63203
# Site_YearRedRiver_2018                8.22      4.50     1.10    18.67 1.00    68889    65922
# Site_YearSandyBar_2017                7.77      4.35     0.98    17.70 1.00    66880    64223
# Site_YearSandyBar_2018                3.68      2.98     0.15    11.05 1.00    72953    83396
# Site_YearWinnipegRiver_2017          10.36      6.38     0.97    25.73 1.00    77584    67833
# K                                     9.42      2.70     3.81    14.60 1.00    65407    59816
# sigma_Site_YearDauphinRiver_2018     -0.02      0.29    -0.58     0.55 1.00   101501   106848
# sigma_Site_YearMatheson_2017         -0.13      0.46    -0.94     0.84 1.00   127048   106568
# sigma_Site_YearMatheson_2018         -0.96      0.29    -1.52    -0.39 1.00   105216   111445
# sigma_Site_YearRedRiver_2017         -0.70      0.29    -1.27    -0.14 1.00    97115   102441
# sigma_Site_YearRedRiver_2018         -0.69      0.30    -1.26    -0.10 1.00    97294   102005
# sigma_Site_YearSandyBar_2017         -0.39      0.27    -0.94     0.14 1.00    97076   107980
# sigma_Site_YearSandyBar_2018         -0.94      0.31    -1.56    -0.33 1.00   100587   104767
# sigma_Site_YearWinnipegRiver_2017    -0.88      0.53    -1.79     0.28 1.00   134082   102416
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    20.65     13.38     4.80    55.08 1.00   170047   108198
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 8 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
get_variables(tryptophan_syrm_model)
model_dataframe_trp_syrm <- tryptophan_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_trp_syrm$Site<- factor(model_dataframe_trp_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

trprm_site_year_plot <- ggplot(data = model_dataframe_trp_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_trp_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_trp_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "tryptophan_syrm_plot.pdf", plot = trprm_site_year_plot, dpi = 900)
summary(tryptophan_syrm_model)
trprm_site_year_plot
save(tryptophan_syrm_model, file= "tryptophan_syrm_model")

#### Tyrosine Year_Site RS ####
hist(raw_dataf$Tyrosine)
tyrosine_syrm_model <- brm(data=raw_dataf,
                           family = student,
                           bf(Tyrosine ~ -1 + Site_Year + K + (Site_Year | Sex),
                              sigma ~ Site_Year),
                           prior = c(prior(normal(0,200), lb= 0, class = b)),
                           iter = 50000, warmup = 10000, chains = 4, cores = 4,
                           control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# tyrosine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Tyrosine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(tyrosine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(tyrosine_syrm_model, N = 2, ask = FALSE)
summary(tyrosine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Tyrosine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  11.63     11.20     0.42    40.90 1.00    48336    31376
# sd(Site_YearDauphinRiver_2018)                                 15.47     14.23     0.52    51.81 1.00    57946    46838
# sd(Site_YearMatheson_2017)                                     22.27     21.34     0.74    76.50 1.00   115042    72566
# sd(Site_YearMatheson_2018)                                     14.33     15.35     0.41    54.98 1.00    70814    83315
# sd(Site_YearRedRiver_2017)                                     17.27     17.91     0.53    63.50 1.00    69164    42270
# sd(Site_YearRedRiver_2018)                                     27.72     21.92     1.75    82.86 1.00    78920    64703
# sd(Site_YearSandyBar_2017)                                     16.88     17.23     0.52    61.25 1.00    90121    83093
# sd(Site_YearSandyBar_2018)                                     16.54     13.00     1.06    50.59 1.00    29230     7704
# sd(Site_YearWinnipegRiver_2017)                                26.61     27.86     0.86    97.68 1.00    83599    46290
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.01      0.32    -0.61     0.60 1.00   158164   117440
# cor(Intercept,Site_YearMatheson_2017)                          -0.01      0.32    -0.61     0.60 1.00   111184    47785
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.00      0.32    -0.60     0.60 1.00   124411   111171
# cor(Intercept,Site_YearMatheson_2018)                          -0.02      0.32    -0.62     0.59 1.00   166081   109020
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.00      0.32    -0.61     0.62 1.00    24344     7269
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.00      0.32    -0.60     0.60 1.00   122191   119987
# cor(Intercept,Site_YearRedRiver_2017)                          -0.01      0.32    -0.61     0.60 1.00    44646    13154
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.00      0.32    -0.60     0.61 1.00   133163    92020
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.60 1.00   137007   118358
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.60 1.00   131290   123462
# cor(Intercept,Site_YearRedRiver_2018)                           0.03      0.31    -0.57     0.63 1.00   158213   113377
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.01      0.32    -0.59     0.61 1.00   148717   117105
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.59 1.00   134695   122780
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.60 1.00   103630    45863
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.00      0.32    -0.60     0.60 1.00   117271   123740
# cor(Intercept,Site_YearSandyBar_2017)                          -0.03      0.32    -0.62     0.58 1.00   182745   116486
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.60     0.61 1.00    79859   102352
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.61 1.00   141409   122817
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   123102   125347
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.61 1.00   108425   122076
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.01      0.32    -0.61     0.59 1.00    76711    82050
# cor(Intercept,Site_YearSandyBar_2018)                           0.02      0.32    -0.58     0.61 1.00   148009   116991
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.00      0.31    -0.60     0.60 1.00   149990   120646
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.01      0.32    -0.60     0.60 1.00   128872   126379
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.02      0.32    -0.59     0.62 1.00   124693   125473
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.00      0.32    -0.60     0.61 1.00   108122    75041
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.06      0.31    -0.55     0.64 1.00    18983     7313
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.01      0.32    -0.61     0.59 1.00    65957    85944
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.60     0.60 1.00   200819   111842
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.00      0.32    -0.60     0.60 1.00   163538   116574
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   147948   121213
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   135381   127773
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   107034   122531
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00    74388   125074
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00    99069   123713
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.00      0.31    -0.60     0.60 1.00    96651   127601
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.76      0.24     3.29     4.24 1.00    65759    88055
# Site_YearDauphinRiver_2017           91.23     18.11    57.70   128.47 1.00    36889    33114
# Site_YearDauphinRiver_2018           44.06     16.72    12.87    79.21 1.00    44385    31346
# Site_YearMatheson_2017               65.87     30.56    11.84   132.23 1.00    67328    48135
# Site_YearMatheson_2018               22.82     15.01     1.95    59.09 1.00    43763    31867
# Site_YearRedRiver_2017               63.45     20.55    24.94   106.37 1.00    32252    38965
# Site_YearRedRiver_2018               46.32     24.27     7.14   101.52 1.00    47534    52781
# Site_YearSandyBar_2017               48.36     18.83    14.44    90.12 1.00    38544    31580
# Site_YearSandyBar_2018               20.29     15.06     1.13    54.25 1.00    12822     5975
# Site_YearWinnipegRiver_2017          45.31     29.75     4.66   120.25 1.00    21166     6875
# K                                    17.30      9.81     1.18    37.20 1.00    42249    31550
# sigma_Site_YearDauphinRiver_2018     -0.75      0.39    -1.50     0.03 1.00    79725   104762
# sigma_Site_YearMatheson_2017         -0.11      0.52    -1.08     0.98 1.00    91273    53615
# sigma_Site_YearMatheson_2018         -1.76      0.36    -2.45    -1.05 1.00    85508   107339
# sigma_Site_YearRedRiver_2017         -0.94      0.33    -1.58    -0.29 1.00    71299    43708
# sigma_Site_YearRedRiver_2018         -0.51      0.38    -1.25     0.24 1.00    56829    43836
# sigma_Site_YearSandyBar_2017         -0.90      0.35    -1.59    -0.23 1.00    79440    99287
# sigma_Site_YearSandyBar_2018         -1.79      0.37    -2.52    -1.06 1.00    34603     8339
# sigma_Site_YearWinnipegRiver_2017    -1.45      0.62    -2.60    -0.15 1.00    91728    43081
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     3.51      1.28     1.87     6.53 1.00   106604   107592
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
get_variables(tyrosine_syrm_model)
model_dataframe_tyr_syrm <- tyrosine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_tyr_syrm$Site<- factor(model_dataframe_tyr_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

tyrrm_site_year_plot <- ggplot(data = model_dataframe_tyr_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_tyr_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_tyr_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "tyrosine_syrm_plot.pdf", plot = tyrrm_site_year_plot, dpi = 900)
summary(tyrosine_syrm_model)
tyrrm_site_year_plot
save(tyrosine_syrm_model, file= "tyrosine_syrm_model")

#### Valine Year_Site RS ####
hist(raw_dataf$Valine)
valine_syrm_model <- brm(data=raw_dataf,
                         family = student,
                         bf(Valine ~ -1 + Site_Year + K + (Site_Year | Sex),
                            sigma ~ Site_Year),
                         prior = c(prior(normal(0,450), lb= 0, class = b)),
                         iter = 50000, warmup = 10000, chains = 4, cores = 4,
                         control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# valine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Valine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(valine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(valine_syrm_model, N = 2, ask = FALSE)
summary(valine_syrm_model)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Valine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  39.24     37.38     1.28   136.09 1.00    59543    72347
# sd(Site_YearDauphinRiver_2018)                                 66.01     56.38     2.51   208.73 1.00    69098    43702
# sd(Site_YearMatheson_2017)                                     68.77     66.03     2.26   234.74 1.00   104256    61299
# sd(Site_YearMatheson_2018)                                     46.17     53.54     1.31   174.52 1.00    52093    33952
# sd(Site_YearRedRiver_2017)                                     53.73     54.68     1.79   188.81 1.00    44136    41232
# sd(Site_YearRedRiver_2018)                                     58.85     52.87     2.66   196.16 1.00    66378    61409
# sd(Site_YearSandyBar_2017)                                     52.40     52.59     1.66   187.50 1.00    84008    64537
# sd(Site_YearSandyBar_2018)                                     63.01     44.86     5.64   175.04 1.00    69676    52504
# sd(Site_YearWinnipegRiver_2017)                                76.42     80.41     2.22   282.27 1.00    66262    38174
# cor(Intercept,Site_YearDauphinRiver_2018)                       0.00      0.32    -0.60     0.61 1.00   131358    57599
# cor(Intercept,Site_YearMatheson_2017)                           0.00      0.32    -0.60     0.60 1.00   201906   116337
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.00      0.32    -0.60     0.60 1.00    87678    53868
# cor(Intercept,Site_YearMatheson_2018)                          -0.02      0.32    -0.62     0.58 1.00   177284   114148
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)         -0.00      0.32    -0.61     0.61 1.00   148120   111782
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.00      0.32    -0.60     0.61 1.00   134312   104934
# cor(Intercept,Site_YearRedRiver_2017)                          -0.04      0.32    -0.63     0.57 1.00   167664   113533
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.01      0.32    -0.61     0.60 1.00   137127   112354
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.00      0.32    -0.60     0.60 1.00   126576    99347
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.01      0.32    -0.60     0.61 1.00   125821   122514
# cor(Intercept,Site_YearRedRiver_2018)                           0.01      0.31    -0.59     0.61 1.00   179912   114135
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.03      0.32    -0.58     0.62 1.00   152160   118118
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)              0.01      0.32    -0.60     0.61 1.00   125225   120603
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.00      0.32    -0.60     0.60 1.00   129242   127216
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.59 1.00    97696    72397
# cor(Intercept,Site_YearSandyBar_2017)                          -0.02      0.32    -0.62     0.59 1.00   179504    56654
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.60     0.60 1.00   142005   113759
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.61     0.61 1.00   134524   120271
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   127504   101766
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.59     0.62 1.00   100017    72753
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.60 1.00   108512   125692
# cor(Intercept,Site_YearSandyBar_2018)                           0.02      0.31    -0.58     0.62 1.00    78251    42308
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.01      0.31    -0.59     0.60 1.00    90282    40844
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.01      0.32    -0.59     0.61 1.00   130937   120923
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.01      0.32    -0.60     0.61 1.00   126207   127476
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.03      0.31    -0.62     0.57 1.00   108595   123129
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.07      0.31    -0.54     0.64 1.00   104685   116578
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.01      0.31    -0.61     0.59 1.00    98694   109818
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.01      0.31    -0.60     0.60 1.00   198191   112536
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.00      0.32    -0.60     0.60 1.00   156032   101357
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   142633   117578
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   132077   122323
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.01      0.32    -0.59     0.61 1.00   118368   121058
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   111325   126888
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00    83949    56373
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.02      0.32    -0.61     0.59 1.00   100225   128929
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       5.37      0.23     4.93     5.83 1.00    99331   102762
# Site_YearDauphinRiver_2017          404.29     74.52   260.25   554.07 1.00   100169    90276
# Site_YearDauphinRiver_2018          212.03     64.16    79.41   341.71 1.00    59831    45994
# Site_YearMatheson_2017              192.26     97.39    26.77   406.69 1.00    71761    51505
# Site_YearMatheson_2018               62.56     45.03     4.70   172.53 1.00    63317    66983
# Site_YearRedRiver_2017               95.34     53.01    13.69   220.39 1.00    56009    56547
# Site_YearRedRiver_2018               66.32     49.82     4.14   189.25 1.00    63802    73960
# Site_YearSandyBar_2017              108.79     57.46    18.40   241.47 1.00    58974    61028
# Site_YearSandyBar_2018               64.50     44.99     4.20   171.83 1.00    60864    68114
# Site_YearWinnipegRiver_2017          89.80     78.65     4.72   292.80 1.00    49350    35572
# K                                    73.49     28.33    17.15   129.39 1.00    70738    58213
# sigma_Site_YearDauphinRiver_2018     -0.82      0.38    -1.60    -0.11 1.00    75968    97283
# sigma_Site_YearMatheson_2017         -0.40      0.52    -1.38     0.67 1.00   117321   106688
# sigma_Site_YearMatheson_2018         -1.88      0.33    -2.53    -1.23 1.00    99252    70677
# sigma_Site_YearRedRiver_2017         -2.03      0.39    -2.83    -1.31 1.00    67551    94470
# sigma_Site_YearRedRiver_2018         -1.91      0.37    -2.64    -1.20 1.00    78182    99005
# sigma_Site_YearSandyBar_2017         -1.09      0.50    -2.07    -0.16 1.00    52383    98811
# sigma_Site_YearSandyBar_2018         -1.88      0.35    -2.57    -1.20 1.00    91414    98792
# sigma_Site_YearWinnipegRiver_2017    -2.07      0.67    -3.37    -0.71 1.00    97789    92283
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     5.65      6.71     1.62    25.83 1.00    51882   103162
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
get_variables(valine_syrm_model)
model_dataframe_val_syrm <- valine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_val_syrm$Site<- factor(model_dataframe_val_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

valrm_site_year_plot <- ggplot(data = model_dataframe_val_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_val_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_val_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "valine_syrm_plot.pdf", plot = valrm_site_year_plot, dpi = 900)
summary(valine_syrm_model)
valrm_site_year_plot
save(val_syrm_model, file= "valine_syrm_model.rda")

save(valine_syrm_model, file = "valine_syrm_model")
load("valine_syrm_model")
print(valine_syrm_model)

#### Alanine Year_Site RS ####
hist(raw_dataf$Alanine)
alanine_syrm_model <- brm(data= raw_dataf,
                          family = gaussian,
                          bf(Alanine ~ -1 + Site_Year + K + (Site_Year | Sex),
                             sigma ~ Site_Year),
                          prior = c(prior(normal(0,450), lb= 0, class = b)),
                          iter = 50000, warmup = 10000, chains = 4, cores = 4,
                          control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations

# alanine_syrm_model <- brm(data=raw_dataf,
#                           family = student,
#                           bf(Valine ~ -1 + Site_Year + K + (Site_Year | Sex),
#                              sigma ~ Site_Year),
#                           prior = c(prior(normal(0,100), lb= 0, class = b)),
#                           iter = 5000, warmup = 1000, chains = 4, cores = 4,
#                           control = list(adapt_delta = 0.95, max_treedepth = 15))

pp_check(alanine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(alanine_syrm_model, N = 2, ask = FALSE)
summary(alanine_syrm_model)
get_variables(alanine_syrm_model)
model_dataframe_ala_syrm <- alanine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_ala_syrm$Site<- factor(model_dataframe_ala_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

alarm_site_year_plot <- ggplot(data = model_dataframe_ala_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_ala_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_ala_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "alanine_syrm_plot.pdf", plot = valrm_site_year_plot, dpi = 900)
summary(alanine_syrm_model)
# Family: gaussian 
# Family: gaussian 
# Links: mu = identity; sigma = log 
# Formula: Alanine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  59.71     62.79     1.80   227.27 1.00    87810    96014
# sd(Site_YearDauphinRiver_2018)                                114.59     93.71     4.95   347.49 1.00    72188    74641
# sd(Site_YearMatheson_2017)                                     98.58     94.46     3.36   341.56 1.00   107631    81804
# sd(Site_YearMatheson_2018)                                    213.65    135.16    31.91   550.30 1.00    85360    48501
# sd(Site_YearRedRiver_2017)                                     99.87     96.52     3.24   350.26 1.00   119562    86051
# sd(Site_YearRedRiver_2018)                                    101.25     98.12     4.34   347.97 1.00    77523    76309
# sd(Site_YearSandyBar_2017)                                     88.79     90.62     2.62   324.83 1.00   111977    93951
# sd(Site_YearSandyBar_2018)                                     77.85     76.10     2.50   275.00 1.00   120976    89684
# sd(Site_YearWinnipegRiver_2017)                               144.04    139.85     4.86   501.16 1.00   143725    82978
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.02      0.32    -0.62     0.59 1.00   206979   115869
# cor(Intercept,Site_YearMatheson_2017)                          -0.01      0.32    -0.61     0.60 1.00   239089   115628
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.02      0.32    -0.59     0.62 1.00   191858   120628
# cor(Intercept,Site_YearMatheson_2018)                          -0.01      0.31    -0.60     0.59 1.00   199440   122505
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)         -0.03      0.31    -0.62     0.56 1.00   189577   123673
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)              0.02      0.31    -0.58     0.62 1.00   144546   123961
# cor(Intercept,Site_YearRedRiver_2017)                          -0.01      0.32    -0.61     0.60 1.00   257532   118683
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)         -0.01      0.32    -0.61     0.60 1.00   207655   121336
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.00      0.32    -0.61     0.60 1.00   166774   123150
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)             -0.01      0.32    -0.61     0.60 1.00   149886   128203
# cor(Intercept,Site_YearRedRiver_2018)                          -0.01      0.32    -0.62     0.60 1.00   234453   115833
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)         -0.03      0.32    -0.63     0.58 1.00   187007   117764
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.02      0.32    -0.61     0.59 1.00   159987   125861
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)             -0.01      0.32    -0.61     0.59 1.00   142055   129864
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.01      0.32    -0.60     0.62 1.00   123905   130247
# cor(Intercept,Site_YearSandyBar_2017)                          -0.01      0.32    -0.62     0.60 1.00   255001   114987
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.00      0.32    -0.61     0.60 1.00   193588    98288
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.61 1.00   161044   122342
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.60     0.60 1.00   144854   119240
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.60     0.61 1.00   121339   125736
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)              0.01      0.32    -0.60     0.61 1.00   110132   127985
# cor(Intercept,Site_YearSandyBar_2018)                          -0.01      0.32    -0.62     0.60 1.00   260865   115582
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.02      0.32    -0.60     0.62 1.00   202816   118511
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.01      0.32    -0.60     0.61 1.00   166310   124598
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.01      0.31    -0.59     0.61 1.00   150931   128784
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.00      0.32    -0.60     0.61 1.00   123085   127445
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.01      0.32    -0.60     0.61 1.00   112952   127113
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)              0.00      0.32    -0.61     0.60 1.00   100537   125702
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.00      0.32    -0.61     0.61 1.00   255201   104395
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)     0.00      0.32    -0.61     0.61 1.00   201051    96572
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   170414   119518
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00   151969   123775
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00   117239   123542
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00   108043   106287
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00    94165    95038
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.61 1.00    86516   120673
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       5.15      0.18     4.82     5.54 1.00    76708    80390
# Site_YearDauphinRiver_2017          259.66     69.97   132.36   407.76 1.00    68022    84832
# Site_YearDauphinRiver_2018          120.06     82.68     7.74   319.41 1.00    67809    69050
# Site_YearMatheson_2017              154.76     88.81    17.34   359.73 1.00    70457    62701
# Site_YearMatheson_2018              193.35    128.67    14.13   500.75 1.00    83477    60767
# Site_YearRedRiver_2017              222.95     97.98    44.48   434.69 1.00    65422    55471
# Site_YearRedRiver_2018              109.19     82.61     6.34   312.46 1.00    67893    75065
# Site_YearSandyBar_2017              232.36     89.92    60.77   425.14 1.00    64068    55457
# Site_YearSandyBar_2018               89.80     68.21     4.08   254.08 1.00    80130    77805
# Site_YearWinnipegRiver_2017         267.05    133.95    36.16   570.48 1.00    79299    64960
# K                                   202.03     53.92    91.40   307.34 1.00    71218    66798
# sigma_Site_YearDauphinRiver_2018     -0.48      0.28    -1.02     0.07 1.00    93582   107809
# sigma_Site_YearMatheson_2017         -0.81      0.46    -1.61     0.20 1.00   114578   104645
# sigma_Site_YearMatheson_2018         -0.26      0.28    -0.80     0.30 1.00    94274   108965
# sigma_Site_YearRedRiver_2017         -0.24      0.26    -0.75     0.27 1.00    99450   104615
# sigma_Site_YearRedRiver_2018         -0.91      0.27    -1.43    -0.37 1.00    99391   108831
# sigma_Site_YearSandyBar_2017         -0.41      0.25    -0.90     0.09 1.00    94217   105544
# sigma_Site_YearSandyBar_2018          0.03      0.27    -0.50     0.56 1.00    99083   105349
# sigma_Site_YearWinnipegRiver_2017    -0.63      0.50    -1.48     0.50 1.00   118413    97247
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 440 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup
alarm_site_year_plot
save(ala_syrm_model, file= "alanine_syrm_model.rda")

save(alanine_syrm_model, file = "alanine_syrm_mode.RDA")
load("alanine_syrm_model.rda")
print(alanine_syrm_model)
library(report)
load("alanine_syrm_mode")
report("alanine_syrm_mode")
report_table(alanine_syrm_model)
as.report(alanine_syrm_model)

#### Serine Year_Site RS ####
hist(raw_dataf$Serine)
serine_syrm_model <- brm(data=raw_dataf,
                         family = gaussian,
                         bf(Serine ~ -1 + Site_Year + K + (Site_Year | Sex),
                            sigma ~ Site_Year),
                         prior = c(prior(normal(0,150), lb= 0, class = b)),
                         iter = 50000, warmup = 10000, chains = 4, cores = 4,
                         control = list(adapt_delta = 0.95, max_treedepth = 15))
# just try less iterations


pp_check(serine_syrm_model, ndraws = 100) +
  theme_bw(base_size = 20)
plot(serine_syrm_model, N = 2, ask = FALSE)
summary(serine_syrm_model)
# Family: gaussian 
# Links: mu = identity; sigma = log 
# Formula: Serine ~ -1 + Site_Year + K + (Site_Year | Sex) 
# sigma ~ Site_Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                  13.08     14.32     0.38    49.75 1.00    55423    40653
# sd(Site_YearDauphinRiver_2018)                                 17.46     16.52     0.56    59.99 1.00    94359    78575
# sd(Site_YearMatheson_2017)                                     24.96     23.13     0.95    83.77 1.00    96388    71274
# sd(Site_YearMatheson_2018)                                     20.14     20.32     0.61    73.53 1.00   101552    60413
# sd(Site_YearRedRiver_2017)                                     23.47     22.73     0.80    82.10 1.00   113701    87169
# sd(Site_YearRedRiver_2018)                                     55.79     31.95    15.91   135.17 1.00    87425    53651
# sd(Site_YearSandyBar_2017)                                     26.09     23.81     0.99    86.18 1.00    94704    58876
# sd(Site_YearSandyBar_2018)                                     46.20     24.48    13.81   107.72 1.00    80152    59838
# sd(Site_YearWinnipegRiver_2017)                                36.45     37.35     1.18   130.07 1.00    69598    41215
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.01      0.32    -0.61     0.60 1.00   193754   116617
# cor(Intercept,Site_YearMatheson_2017)                          -0.02      0.32    -0.62     0.59 1.00   210245   110966
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)         -0.01      0.32    -0.61     0.60 1.00   158055   120410
# cor(Intercept,Site_YearMatheson_2018)                          -0.01      0.32    -0.62     0.60 1.00   216466   106030
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.01      0.32    -0.60     0.61 1.00   119992    49350
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.00      0.32    -0.60     0.60 1.00   150464   117441
# cor(Intercept,Site_YearRedRiver_2017)                          -0.01      0.32    -0.61     0.60 1.00   149791    48681
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.00      0.32    -0.60     0.61 1.00   179082   119545
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.00      0.32    -0.61     0.60 1.00   149413   119883
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.60 1.00   134076   122276
# cor(Intercept,Site_YearRedRiver_2018)                           0.02      0.31    -0.57     0.61 1.00   183765   118065
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)          0.03      0.31    -0.58     0.62 1.00   111766    43634
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.05      0.31    -0.63     0.55 1.00   103177    79957
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)              0.01      0.32    -0.59     0.61 1.00   123231   128907
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)              0.01      0.31    -0.58     0.61 1.00   104566   118859
# cor(Intercept,Site_YearSandyBar_2017)                          -0.02      0.32    -0.62     0.59 1.00   192279   108655
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)         -0.01      0.32    -0.61     0.59 1.00   168205   120956
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.02      0.32    -0.58     0.62 1.00   146583   112008
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.60     0.60 1.00   117996    72620
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.60 1.00    96405    44957
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.06      0.31    -0.64     0.54 1.00   110321   121445
# cor(Intercept,Site_YearSandyBar_2018)                           0.02      0.31    -0.58     0.61 1.00   127550    91096
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.03      0.31    -0.57     0.62 1.00   116287    49116
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)             -0.06      0.31    -0.63     0.54 1.00   133883   118010
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)              0.01      0.32    -0.60     0.61 1.00   100367    48619
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)              0.01      0.31    -0.58     0.60 1.00   119771   132848
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.16      0.29    -0.42     0.68 1.00   109173   124629
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)             -0.06      0.31    -0.64     0.53 1.00    92105    75958
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.01      0.32    -0.61     0.59 1.00   170239   105728
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.01      0.32    -0.61     0.60 1.00   133089    56585
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)         0.02      0.32    -0.59     0.61 1.00   130817    44333
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00   102768    61724
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.60 1.00   101139   122097
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.04      0.31    -0.62     0.57 1.00   115338   117799
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)         0.02      0.32    -0.59     0.61 1.00    98664   128134
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.04      0.31    -0.63     0.57 1.00    96085   117002
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma_Intercept                       3.53      0.18     3.20     3.92 1.00    75486    80918
# Site_YearDauphinRiver_2017           49.46     20.34    12.43    92.42 1.00    33420    23104
# Site_YearDauphinRiver_2018           42.12     21.89     5.21    89.15 1.00    35953    37124
# Site_YearMatheson_2017               47.31     25.84     5.33   104.15 1.00    50606    55349
# Site_YearMatheson_2018               43.99     22.96     6.14    94.72 1.00    44181    29175
# Site_YearRedRiver_2017               80.58     29.48    23.80   140.73 1.00    47792    49816
# Site_YearRedRiver_2018               79.34     38.67    11.45   163.75 1.00    65280    58479
# Site_YearSandyBar_2017               62.00     28.04    12.60   122.53 1.00    43706    40850
# Site_YearSandyBar_2018               52.30     30.05     4.83   119.36 1.00    57660    64241
# Site_YearWinnipegRiver_2017          34.37     32.14     1.12   119.24 1.00    63448    42128
# K                                    49.55     17.11    14.48    81.73 1.00    35118    36503
# sigma_Site_YearDauphinRiver_2018     -0.01      0.27    -0.54     0.53 1.00    95092   104363
# sigma_Site_YearMatheson_2017         -0.42      0.48    -1.27     0.62 1.00    88647   104166
# sigma_Site_YearMatheson_2018         -0.54      0.27    -1.07     0.00 1.00    98566   108223
# sigma_Site_YearRedRiver_2017          0.21      0.26    -0.30     0.72 1.00    95077   101567
# sigma_Site_YearRedRiver_2018          0.18      0.28    -0.37     0.75 1.00    62256    35430
# sigma_Site_YearSandyBar_2017          0.10      0.25    -0.40     0.59 1.00    91235    96448
# sigma_Site_YearSandyBar_2018          0.05      0.28    -0.50     0.62 1.00    90688   105043
# sigma_Site_YearWinnipegRiver_2017    -0.44      0.53    -1.34     0.78 1.00    80383    53091
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
get_variables(serine_syrm_model)
model_dataframe_ser_syrm <- serine_syrm_model %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2017:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_ser_syrm$Site<- factor(model_dataframe_ser_syrm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

serrm_site_year_plot <- ggplot(data = model_dataframe_ser_syrm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_ser_syrm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_ser_syrm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "serine_syrm_plot.pdf", plot = valrm_site_year_plot, dpi = 900)
summary(serine_syrm_model)
serrm_site_year_plot
save(serine_syrm_model, file= "serine_syrm_model.rda")

save(serine_syrm_model, file = "serine_syrm_model")
load("serine_syrm_model")
print(serine_syrm_model)


save(serrm_syrm_model, file = "serine_syrm_model")
load("serine_syrm_model")
print(serine_syrm_model)


#### Hurddle Models ####
library(tidyverse)       # ggplot, dplyr, and friends
library(brms)            # Bayesian modeling through Stan
library(emmeans)         # Calculate marginal effects in fancy ways
library(tidybayes)       # Manipulate Stan objects in a tidy way
library(broom)           # Convert model objects to data frames
library(broom.mixed)     # Convert brms model objects to data frames
library(scales)          # For formatting numbers with commas, percents, and dollars
library(patchwork)       # For combining plots
library(ggh4x)           # For nested facets in ggplot
library(ggtext)          # Use markdown and HTML in ggplot text
library(MetBrewer)       # Use pretty artistic colors
library(gapminder)       # Country-year panel data from the Gapminder project
library(palmerpenguins)  # Penguin data!

# Use the cmdstanr backend for Stan because it's faster and more modern than the
# default rstan You need to install the cmdstanr package first
# (https://mc-stan.org/cmdstanr/) and then run cmdstanr::install_cmdstan() to
# install cmdstan on your computer.
options(mc.cores = 4,
        brms.backend = "cmdstanr")

# Set some global Stan options
CHAINS <- 4
ITER <- 2000
WARMUP <- 1000
BAYES_SEED <- 1234

# Use the Johnson color palette
clrs <- MetBrewer::met.brewer("Johnson")

# Tell bayesplot to use the Johnson palette (for things like pp_check())
bayesplot::color_scheme_set(c("grey30", clrs[2], clrs[1], clrs[3], clrs[5], clrs[4]))

# Custom ggplot theme to make pretty plots
# Get the font at https://fonts.google.com/specimen/Jost
theme_nice <- function() {
  theme_minimal(base_family = "Jost") +
    theme(panel.grid.minor = element_blank(),
          plot.title = element_text(family = "Jost", face = "bold"),
          axis.title = element_text(family = "Jost Medium"),
          strip.text = element_text(family = "Jost", face = "bold",
                                    size = rel(1), hjust = 0),
          strip.background = element_rect(fill = "grey80", color = NA))
}
# explore data, find the zeroths
raw_dataf |> 
  count(is_zero) |> 
  mutate(prop = n / sum(n))
# Make a logged version of GDP per capita
mutate(log_gdpPercap = log1p(gdpPercap)) |> 
  mutate(is_zero = gdpPercap == 0)
#### Regular OLS model ####
#try only
ggplot(raw_dataf, aes(x = Site, y = Asparagine)) +
  geom_point(aes(color = Site), size = 1, alpha = 0.5) + 
  geom_smooth(method = "lm", color = "#0074D9") +
  scale_y_continuous(labels = label_dollar(scale_cut = cut_short_scale())) +
  #scale_color_manual(values = Site) +
  labs(x = "Site", y = "Asparaginne", color = NULL,
       title = "OLS model fit on asparagine") +
  guides(color = guide_legend(override.aes = list(size = 1.5, alpha = 1)))# +
  # theme_nice() +
  # theme(legend.position = "bottom")

#### Doing the OLS model ####
model_arg_basic <- brm(
  bf(Asparagine ~ Site),
  data = raw_dataf,
  family = gaussian(),
  # chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,
  # silent = 2
)
tidy(model_arg_basic)
# A tibble: 6 × 8
# effect   component group    term              estimate std.error conf.low conf.high
# <chr>    <chr>     <chr>    <chr>                <dbl>     <dbl>    <dbl>     <dbl>
#   1 fixed    cond      NA       (Intercept)           34.7      3.11     28.4      40.9
# 2 fixed    cond      NA       SiteMatheson         -27.2      4.90    -36.6     -17.5
# 3 fixed    cond      NA       SiteRedRiver         -35.4      4.23    -43.5     -26.8
# 4 fixed    cond      NA       SiteSandyBar         -26.7      4.28    -35.1     -18.2
# 5 fixed    cond      NA       SiteWinnipegRiver    -31.5      9.16    -49.7     -13.6
# 6 ran_pars cond      Residual sd__Observation       17.3      1.13     15.3      19.6

pp_check(model_arg_basic)
# bad fit

#### intercept only hurdle model ####
model_asp_hurdle <- brm(
  bf(Asparagine ~ Site,
     hu ~ 1),
  data = raw_dataf,
  family = hurdle_lognormal() #,
  # chains = CHAINS, iter = ITER, warmup = WARMUP, seed = BAYES_SEED,
  # silent = 2
)
tidy(model_asp_hurdle)
# A tibble: 7 × 8
# effect   component group    term              estimate std.error conf.low conf.high
# <chr>    <chr>     <chr>    <chr>                <dbl>     <dbl>    <dbl>     <dbl>
#   1 fixed    cond      NA       (Intercept)         3.25       0.234    2.78      3.70 
# 2 fixed    cond      NA       hu_(Intercept)     -0.0979     0.179   -0.462     0.247
# 3 fixed    cond      NA       SiteMatheson       -1.30       0.407   -2.08     -0.504
# 4 fixed    cond      NA       SiteRedRiver       -3.80       0.956   -5.63     -1.91 
# 5 fixed    cond      NA       SiteSandyBar       -1.16       0.466   -2.08     -0.223
# 6 fixed    cond      NA       SiteWinnipegRiver  -2.01       0.685   -3.38     -0.669
# 7 ran_pars cond      Residual sd__Observation     1.30       0.122    1.10      1.57 
# Warning message:
#   In tidy.brmsfit(model_asp_hurdle) :
#   some parameter names contain underscores: term naming may be unreliable!

hu_intercept <- tidy(model_asp_hurdle) |> 
  filter(term == "hu_(Intercept)") |> 
  pull(estimate)
# Warning message:
#   In tidy.brmsfit(model_asp_hurdle) :
#   some parameter names contain underscores: term naming may be unreliable!
hu_intercept
b_hu_Intercept 
#-0.09787101
plogis(hu_intercept)
b_hu_Intercept 
#0.4755518

# Exponential
pp_check(model_asp_hurdle)

# Logged
pred <- posterior_predict(model_asp_hurdle)
bayesplot::ppc_dens_overlay(y = log1p(raw_dataf$Asparagine), 
                            yrep = log1p(pred[1:10,]))

model_asp_hurdle_Site <- brm(
  bf(Asparagine ~ Site,
     hu ~ Site),
  data = raw_dataf,
  family = hurdle_lognormal(),
  chains = 4, iter = 2000, warmup = 1000, seed = 1234,
  silent = 2
)
tidy(model_asp_hurdle_Site)
# A tibble: 11 × 8
# effect   component group    term                 estimate std.error conf.low conf.high
# <chr>    <chr>     <chr>    <chr>                   <dbl>     <dbl>    <dbl>     <dbl>
#   1 fixed    cond      NA       (Intercept)              3.26     0.235    2.79      3.72 
# 2 fixed    cond      NA       hu_(Intercept)          -3.79     1.19    -6.51     -1.97 
# 3 fixed    cond      NA       SiteMatheson            -1.31     0.399   -2.11     -0.522
# 4 fixed    cond      NA       SiteRedRiver            -3.84     0.954   -5.63     -1.92 
# 5 fixed    cond      NA       SiteSandyBar            -1.15     0.464   -2.07     -0.243
# 6 fixed    cond      NA       SiteWinnipegRiver       -2.06     0.687   -3.38     -0.734
# 7 fixed    cond      NA       hu_SiteMatheson          2.34     1.34     0.103     5.28 
# 8 fixed    cond      NA       hu_SiteRedRiver          6.85     1.49     4.42     10.3  
# 9 fixed    cond      NA       hu_SiteSandyBar          4.58     1.25     2.55      7.33 
# 10 fixed    cond      NA       hu_SiteWinnipegRiver   -38.6     32.7   -118.        0.749
# 11 ran_pars cond      Residual sd__Observation          1.31     0.120    1.09      1.56 
# Warning message:
#   In tidy.brmsfit(model_asp_hurdle_Site) :
#   some parameter names contain underscores: term naming may be unreliable!

hurdle_intercept <- tidy(model_asp_hurdle_Site) |> 
  filter(term == "hu_(Intercept)") |> 
  pull(estimate)
# Matheson
hurdle_SiteMatheson <- tidy(model_asp_hurdle_Site) |> 
  filter(term == "hu_SiteMathesonp") |> 
  pull(estimate)

plogis(hurdle_intercept + hurdle_SiteMatheson) - plogis(hurdle_intercept)
#numeric(0)

# Red River
hurdle_SiteRedRiver <- tidy(model_asp_hurdle_Site) |> 
  filter(term == "hu_SiteRedRiver") |> 
  pull(estimate)

plogis(hurdle_intercept + hurdle_SiteRedRiver) - plogis(hurdle_intercept)
# b_hu_Intercept 
# 0.9329723

# Sandy Bar
hurdle_SiteSandyBar <- tidy(model_asp_hurdle_Site) |> 
  filter(term == "hu_SiteSandyBar") |> 
  pull(estimate)

plogis(hurdle_intercept + hurdle_SiteSandyBar) - plogis(hurdle_intercept)
# b_hu_Intercept 
# 0.6650493

# Winnipeg River
hurdle_SiteWinnipegRiver <- tidy(model_asp_hurdle_Site) |> 
  filter(term == "hu_SiteWinnipegRiver") |> 
  pull(estimate)

plogis(hurdle_intercept + hurdle_SiteWinnipegRiver) - plogis(hurdle_intercept)
# b_hu_Intercept 
# -0.0220741
conditional_effects(model_asp_hurdle_Site)
conditional_effects(model_asp_hurdle_Site, dpar = "hu")


#### The hurdle model with years ####
hist(raw_dataf$Asparagine)
model_asp_hurdle_year <- brm(
  bf(Asparagine ~ Site_Year + K + (1 + Site_Year | Sex),
     hu ~ Site-Year,
     decomp = "QR"),
  data = raw_dataf,
  family = hurdle_lognormal(),
  chains = 4, iter = 50000, warmup = 10000, #seed = 1234,
  silent = 2,
  threads = threading(2)  # Two CPUs per chain to speed things up
)
tidy(model_asp_hurdle_year)
# A tibble: 61 × 8
# effect component group term                       estimate std.error conf.low conf.high
# <chr>  <chr>     <chr> <chr>                         <dbl>     <dbl>    <dbl>     <dbl>
#   1 fixed  cond      NA    (Intercept)                   2.62       1.91   -1.13       6.31
# 2 fixed  cond      NA    hu_(Intercept)               -3.77       1.15   -6.43      -1.99
# 3 fixed  cond      NA    hu_SiteMatheson               2.31       1.29    0.114      5.15
# 4 fixed  cond      NA    hu_SiteRedRiver               6.84       1.43    4.45      10.0 
# 5 fixed  cond      NA    hu_SiteSandyBar               4.56       1.21    2.61       7.30
# 6 fixed  cond      NA    hu_SiteWinnipegRiver        -38.3       35.2  -130.         1.16
# 7 fixed  cond      NA    Site_YearDauphinRiver_2018   -0.729      1.82   -4.70       2.72
# 8 fixed  cond      NA    Site_YearMatheson_2017       -1.20       1.91   -5.10       2.57
# 9 fixed  cond      NA    Site_YearMatheson_2018       -1.28       1.68   -5.18       2.26
# 10 fixed  cond      NA    Site_YearRedRiver_2017       -3.54       4.08  -12.9        4.23
# # … with 51 more rows
# # ℹ Use `print(n = ...)` to see more rows
# Warning message:
#   In tidy.brmsfit(model_asp_hurdle_year) :
#   some parameter names contain underscores: term naming may be unreliable!
pp_check(model_asp_hurdle_year)

pp_check(model_asp_hurdle_year, ndraws = 100) +
  theme_bw(base_size = 20)
plot(model_asp_hurdle_year, N = 2, ask = FALSE)
summary(model_asp_hurdle_year)
# Family: hurdle_lognormal 
# Links: mu = identity; sigma = identity; hu = logit 
# Formula: Asparagine ~ Site_Year + K + (1 + Site_Year | Sex) 
# hu ~ Site - Year
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 50000; warmup = 10000; thin = 1;
# total post-warmup draws = 160000
# 
# Group-Level Effects: 
#   ~Sex (Number of levels: 3) 
# Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sd(Intercept)                                                   0.91      1.23     0.02     3.83 1.00     3547     1522
# sd(Site_YearDauphinRiver_2018)                                  2.44      1.73     0.24     6.88 1.00    13438    37407
# sd(Site_YearMatheson_2017)                                      1.80      1.94     0.05     6.94 1.00    10041     6772
# sd(Site_YearMatheson_2018)                                      1.71      1.83     0.04     6.52 1.00     6285     2687
# sd(Site_YearRedRiver_2017)                                      3.23      3.37     0.10    12.00 1.00    16046    48530
# sd(Site_YearRedRiver_2018)                                      3.47      3.94     0.11    13.65 1.00     2557      687
# sd(Site_YearSandyBar_2017)                                      1.92      2.02     0.06     7.31 1.00    10235     4936
# sd(Site_YearSandyBar_2018)                                      1.85      1.88     0.06     6.83 1.00    13941    43147
# sd(Site_YearWinnipegRiver_2017)                                 3.41      3.65     0.11    13.82 1.00     1678      487
# cor(Intercept,Site_YearDauphinRiver_2018)                      -0.01      0.32    -0.60     0.59 1.00     7421    19240
# cor(Intercept,Site_YearMatheson_2017)                          -0.01      0.32    -0.61     0.61 1.00     8185    15440
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2017)          0.02      0.31    -0.58     0.62 1.00     6662     3574
# cor(Intercept,Site_YearMatheson_2018)                          -0.01      0.32    -0.62     0.61 1.00     4197     2649
# cor(Site_YearDauphinRiver_2018,Site_YearMatheson_2018)          0.00      0.32    -0.60     0.61 1.00    22396    84312
# cor(Site_YearMatheson_2017,Site_YearMatheson_2018)             -0.00      0.32    -0.60     0.60 1.00    20163    29833
# cor(Intercept,Site_YearRedRiver_2017)                          -0.00      0.31    -0.60     0.60 1.00    56825    60375
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2017)          0.00      0.31    -0.60     0.60 1.00    25489    76688
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2017)             -0.01      0.32    -0.61     0.60 1.00     5654     5078
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2017)              0.00      0.32    -0.60     0.61 1.00    16550    13886
# cor(Intercept,Site_YearRedRiver_2018)                          -0.00      0.32    -0.60     0.60 1.00    11566    17060
# cor(Site_YearDauphinRiver_2018,Site_YearRedRiver_2018)         -0.00      0.31    -0.60     0.59 1.00    27500    40826
# cor(Site_YearMatheson_2017,Site_YearRedRiver_2018)             -0.01      0.31    -0.60     0.60 1.00    43236    66351
# cor(Site_YearMatheson_2018,Site_YearRedRiver_2018)             -0.00      0.31    -0.60     0.60 1.00    46648    54744
# cor(Site_YearRedRiver_2017,Site_YearRedRiver_2018)             -0.00      0.32    -0.60     0.60 1.00    16381    58284
# cor(Intercept,Site_YearSandyBar_2017)                          -0.01      0.32    -0.61     0.60 1.00    21707    67661
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2017)          0.03      0.31    -0.57     0.61 1.00    21309    79460
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2017)              0.00      0.32    -0.61     0.61 1.00    20722    16067
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.60 1.00     6961    19498
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2017)             -0.00      0.32    -0.60     0.60 1.00    22738    61932
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2017)             -0.00      0.32    -0.61     0.60 1.00    26665    34490
# cor(Intercept,Site_YearSandyBar_2018)                          -0.01      0.32    -0.62     0.60 1.00     3771     3762
# cor(Site_YearDauphinRiver_2018,Site_YearSandyBar_2018)          0.03      0.31    -0.57     0.62 1.00     6837    10576
# cor(Site_YearMatheson_2017,Site_YearSandyBar_2018)              0.01      0.32    -0.60     0.61 1.00    11612    18917
# cor(Site_YearMatheson_2018,Site_YearSandyBar_2018)             -0.00      0.32    -0.60     0.60 1.00    14938    58930
# cor(Site_YearRedRiver_2017,Site_YearSandyBar_2018)             -0.00      0.32    -0.60     0.61 1.00     8014    10698
# cor(Site_YearRedRiver_2018,Site_YearSandyBar_2018)              0.00      0.32    -0.61     0.60 1.00    10734    11435
# cor(Site_YearSandyBar_2017,Site_YearSandyBar_2018)              0.01      0.32    -0.59     0.61 1.00    29576    66235
# cor(Intercept,Site_YearWinnipegRiver_2017)                     -0.01      0.32    -0.61     0.60 1.00     9020     4479
# cor(Site_YearDauphinRiver_2018,Site_YearWinnipegRiver_2017)    -0.00      0.32    -0.61     0.60 1.00     5875    10490
# cor(Site_YearMatheson_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.61     0.61 1.00     4613     2090
# cor(Site_YearMatheson_2018,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00    19432    58551
# cor(Site_YearRedRiver_2017,Site_YearWinnipegRiver_2017)         0.00      0.32    -0.60     0.60 1.00     8200    21399
# cor(Site_YearRedRiver_2018,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00    28255    75269
# cor(Site_YearSandyBar_2017,Site_YearWinnipegRiver_2017)        -0.00      0.32    -0.60     0.60 1.00     9298    21111
# cor(Site_YearSandyBar_2018,Site_YearWinnipegRiver_2017)        -0.01      0.32    -0.60     0.60 1.00     9957    18883
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                       2.62      1.91    -1.13     6.31 1.00     4226     5132
# hu_Intercept                   -3.77      1.15    -6.43    -1.99 1.00     8032    33906
# hu_SiteMatheson                 2.31      1.29     0.11     5.15 1.00    10435    35427
# hu_SiteRedRiver                 6.84      1.43     4.45    10.04 1.00    22511    47651
# hu_SiteSandyBar                 4.56      1.21     2.61     7.30 1.00     5446     4774
# hu_SiteWinnipegRiver          -38.32     35.25  -130.27     1.16 1.00     5569     3260
# Site_YearDauphinRiver_2018     -0.73      1.82    -4.70     2.72 1.00    24166    12596
# Site_YearMatheson_2017         -1.20      1.91    -5.10     2.57 1.00     6637     5090
# Site_YearMatheson_2018         -1.28      1.68    -5.18     2.26 1.00    14978     4147
# Site_YearRedRiver_2017         -3.54      4.08   -12.87     4.23 1.00    18718    28681
# Site_YearRedRiver_2018         -4.98      5.12   -17.56     3.40 1.00     1705      584
# Site_YearSandyBar_2017         -0.38      1.94    -4.60     3.23 1.00    25043    30084
# Site_YearSandyBar_2018         -2.12      1.82    -6.03     1.49 1.00     4705     3478
# Site_YearWinnipegRiver_2017    -1.97      4.54   -10.95     7.87 1.00     1389      507
# K                               0.53      1.52    -2.47     3.49 1.00     7171     6732
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# sigma     1.23      0.13     1.01     1.51 1.00     6489    14894
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 8177 divergent transitions after warmup. Increasing adapt_delta above 0.8 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
get_variables(model_asp_hurdle_year)
# [1] "b_Intercept"                                                     
# [2] "b_hu_Intercept"                                                  
# [3] "b_hu_SiteMatheson"                                               
# [4] "b_hu_SiteRedRiver"                                               
# [5] "b_hu_SiteSandyBar"                                               
# [6] "b_hu_SiteWinnipegRiver"                                          
# [7] "b_Site_YearDauphinRiver_2018"                                    
# [8] "b_Site_YearMatheson_2017"                                        
# [9] "b_Site_YearMatheson_2018"                                        
# [10] "b_Site_YearRedRiver_2017"                                        
# [11] "b_Site_YearRedRiver_2018"                                        
# [12] "b_Site_YearSandyBar_2017"                                        
# [13] "b_Site_YearSandyBar_2018"                                        
# [14] "b_Site_YearWinnipegRiver_2017"                                   
# [15] "b_K"                                                             
# [16] "sd_Sex__Intercept"                                               
# [17] "sd_Sex__Site_YearDauphinRiver_2018"                              
# [18] "sd_Sex__Site_YearMatheson_2017"                                  
# [19] "sd_Sex__Site_YearMatheson_2018"
# [20] "sd_Sex__Site_YearRedRiver_2017"                                  
# [21] "sd_Sex__Site_YearRedRiver_2018"                                  
# [22] "sd_Sex__Site_YearSandyBar_2017"                                  
# [23] "sd_Sex__Site_YearSandyBar_2018"                                  
# [24] "sd_Sex__Site_YearWinnipegRiver_2017"                             
# [25] "cor_Sex__Intercept__Site_YearDauphinRiver_2018"                  
# [26] "cor_Sex__Intercept__Site_YearMatheson_2017"                      
# [27] "cor_Sex__Site_YearDauphinRiver_2018__Site_YearMatheson_2017"     
# [28] "cor_Sex__Intercept__Site_YearMatheson_2018"                      
# [29] "cor_Sex__Site_YearDauphinRiver_2018__Site_YearMatheson_2018"     
# [30] "cor_Sex__Site_YearMatheson_2017__Site_YearMatheson_2018"         
# [31] "cor_Sex__Intercept__Site_YearRedRiver_2017"                      
# [32] "cor_Sex__Site_YearDauphinRiver_2018__Site_YearRedRiver_2017"     
# [33] "cor_Sex__Site_YearMatheson_2017__Site_YearRedRiver_2017"         
# [34] "cor_Sex__Site_YearMatheson_2018__Site_YearRedRiver_2017"         
# [35] "cor_Sex__Intercept__Site_YearRedRiver_2018"                      
# [36] "cor_Sex__Site_YearDauphinRiver_2018__Site_YearRedRiver_2018"     
# [37] "cor_Sex__Site_YearMatheson_2017__Site_YearRedRiver_2018"         
# [38] "cor_Sex__Site_YearMatheson_2018__Site_YearRedRiver_2018"         
# [39] "cor_Sex__Site_YearRedRiver_2017__Site_YearRedRiver_2018"         
# [40] "cor_Sex__Intercept__Site_YearSandyBar_2017"                      
# [41] "cor_Sex__Site_YearDauphinRiver_2018__Site_YearSandyBar_2017"     
# [42] "cor_Sex__Site_YearMatheson_2017__Site_YearSandyBar_2017"         
# [43] "cor_Sex__Site_YearMatheson_2018__Site_YearSandyBar_2017"         
# [44] "cor_Sex__Site_YearRedRiver_2017__Site_YearSandyBar_2017"         
# [45] "cor_Sex__Site_YearRedRiver_2018__Site_YearSandyBar_2017"         
# [46] "cor_Sex__Intercept__Site_YearSandyBar_2018"                      
# [47] "cor_Sex__Site_YearDauphinRiver_2018__Site_YearSandyBar_2018"     
# [48] "cor_Sex__Site_YearMatheson_2017__Site_YearSandyBar_2018"         
# [49] "cor_Sex__Site_YearMatheson_2018__Site_YearSandyBar_2018"         
# [50] "cor_Sex__Site_YearRedRiver_2017__Site_YearSandyBar_2018"         
# [51] "cor_Sex__Site_YearRedRiver_2018__Site_YearSandyBar_2018"         
# [52] "cor_Sex__Site_YearSandyBar_2017__Site_YearSandyBar_2018"         
# [53] "cor_Sex__Intercept__Site_YearWinnipegRiver_2017"                 
# [54] "cor_Sex__Site_YearDauphinRiver_2018__Site_YearWinnipegRiver_2017"
# [55] "cor_Sex__Site_YearMatheson_2017__Site_YearWinnipegRiver_2017"    
# [56] "cor_Sex__Site_YearMatheson_2018__Site_YearWinnipegRiver_2017"    
# [57] "cor_Sex__Site_YearRedRiver_2017__Site_YearWinnipegRiver_2017"    
# [58] "cor_Sex__Site_YearRedRiver_2018__Site_YearWinnipegRiver_2017"    
# [59] "cor_Sex__Site_YearSandyBar_2017__Site_YearWinnipegRiver_2017"    
# [60] "cor_Sex__Site_YearSandyBar_2018__Site_YearWinnipegRiver_2017"    
# [61] "sigma"                                                           
# [62] "r_Sex[F,Intercept]"                                              
# [63] "r_Sex[M,Intercept]"                                              
# [64] "r_Sex[UN,Intercept]"                                             
# [65] "r_Sex[F,Site_YearDauphinRiver_2018]"                             
# [66] "r_Sex[M,Site_YearDauphinRiver_2018]"                             
# [67] "r_Sex[UN,Site_YearDauphinRiver_2018]"                            
# [68] "r_Sex[F,Site_YearMatheson_2017]"                                 
# [69] "r_Sex[M,Site_YearMatheson_2017]"                                 
# [70] "r_Sex[UN,Site_YearMatheson_2017]"                                
# [71] "r_Sex[F,Site_YearMatheson_2018]"                                 
# [72] "r_Sex[M,Site_YearMatheson_2018]"                                 
# [73] "r_Sex[UN,Site_YearMatheson_2018]"                                
# [74] "r_Sex[F,Site_YearRedRiver_2017]"                                 
# [75] "r_Sex[M,Site_YearRedRiver_2017]"                                 
# [76] "r_Sex[UN,Site_YearRedRiver_2017]"                                
# [77] "r_Sex[F,Site_YearRedRiver_2018]"                                 
# [78] "r_Sex[M,Site_YearRedRiver_2018]"                                 
# [79] "r_Sex[UN,Site_YearRedRiver_2018]"                                
# [80] "r_Sex[F,Site_YearSandyBar_2017]"                                 
# [81] "r_Sex[M,Site_YearSandyBar_2017]"                                 
# [82] "r_Sex[UN,Site_YearSandyBar_2017]"                                
# [83] "r_Sex[F,Site_YearSandyBar_2018]"                                 
# [84] "r_Sex[M,Site_YearSandyBar_2018]"                                 
# [85] "r_Sex[UN,Site_YearSandyBar_2018]"                                
# [86] "r_Sex[F,Site_YearWinnipegRiver_2017]"                            
# [87] "r_Sex[M,Site_YearWinnipegRiver_2017]"                            
# [88] "r_Sex[UN,Site_YearWinnipegRiver_2017]"                           
# [89] "lprior"                                                          
# [90] "lp__"                                                            
# [91] "accept_stat__"                                                   
# [92] "stepsize__"                                                      
# [93] "treedepth__"                                                     
# [94] "n_leapfrog__"                                                    
# [95] "divergent__"                                                     
# [96] "energy__"                                                        
model_dataframe_asp_hurm <- model_asp_hurdle_year %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Site_YearDauphinRiver_2018:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_asp_hurm$Site<- factor(model_dataframe_asp_hurm$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

asphurm_site_year_plot <- ggplot(data = model_dataframe_asp_hurm, aes(x = est, y = Site , fill = Year, group = Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(model_dataframe_asp_hurm, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(model_dataframe_asp_hurm, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "asparagine_hurm_plot.pdf", plot = asphurm_site_year_plot, dpi = 900)

asphurm_site_year_plot

save(model_asp_hurdle_year, file = "model_asp_hurdle_year")
load("model_asp_hurdle_year")
print(model_asp_hurdle_year)

#### Mat emmeans ####
library(rstanarm)
pairs(emmeans(model_asp_hurdle_year, ~ Site_Year))
# Loading required namespace: rstanarm
# Failed with error:  ‘there is no package called ‘rstanarm’’
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    0.6200     -2.73      4.82
# DauphinRiver_2017 - Matheson_2017        1.2149     -2.65      4.90
# DauphinRiver_2017 - Matheson_2018        1.2601     -2.55      4.93
# DauphinRiver_2017 - RedRiver_2017        3.4231     -4.95     12.22
# DauphinRiver_2017 - RedRiver_2018        4.5813     -3.68     14.28
# DauphinRiver_2017 - SandyBar_2017        0.3003     -3.41      4.61
# DauphinRiver_2017 - SandyBar_2018        2.0379     -1.63      6.01
# DauphinRiver_2017 - WinnipegRiver_2017   2.1836     -5.94     10.73
# DauphinRiver_2018 - Matheson_2017        0.5354     -4.95      5.67
# DauphinRiver_2018 - Matheson_2018        0.6326     -4.85      5.53
# DauphinRiver_2018 - RedRiver_2017        2.7537     -6.27     12.55
# DauphinRiver_2018 - RedRiver_2018        3.8785     -5.29     14.09
# DauphinRiver_2018 - SandyBar_2017       -0.3334     -6.00      4.99
# DauphinRiver_2018 - SandyBar_2018        1.3822     -4.15      6.55
# DauphinRiver_2018 - WinnipegRiver_2017   1.5185     -7.47     10.45
# Matheson_2017 - Matheson_2018            0.0548     -5.28      5.41
# Matheson_2017 - RedRiver_2017            2.2392     -6.82     12.07
# Matheson_2017 - RedRiver_2018            3.3927     -5.84     13.57
# Matheson_2017 - SandyBar_2017           -0.8863     -6.42      4.78
# Matheson_2017 - SandyBar_2018            0.8432     -4.44      6.41
# Matheson_2017 - WinnipegRiver_2017       0.9720     -8.02     10.25
# Matheson_2018 - RedRiver_2017            2.1603     -6.95     11.92
# Matheson_2018 - RedRiver_2018            3.3429     -6.01     13.50
# Matheson_2018 - SandyBar_2017           -0.9455     -6.17      4.95
# Matheson_2018 - SandyBar_2018            0.7913     -4.48      6.26
# Matheson_2018 - WinnipegRiver_2017       0.9129     -8.17      9.99
# RedRiver_2017 - RedRiver_2018            1.1649    -11.43     14.09
# RedRiver_2017 - SandyBar_2017           -3.0949    -12.65      6.49
# RedRiver_2017 - SandyBar_2018           -1.3975    -10.99      8.01
# RedRiver_2017 - WinnipegRiver_2017      -1.2524    -13.36     10.73
# RedRiver_2018 - SandyBar_2017           -4.2485    -14.40      5.40
# RedRiver_2018 - SandyBar_2018           -2.5317    -12.87      6.73
# RedRiver_2018 - WinnipegRiver_2017      -2.4150    -15.25      9.25
# SandyBar_2017 - SandyBar_2018            1.7201     -3.89      7.45
# SandyBar_2017 - WinnipegRiver_2017       1.8529     -7.31     11.13
# SandyBar_2018 - WinnipegRiver_2017       0.1415     -9.25      9.03
# 
# Point estimate displayed: median 
# HPD interval probability: 0.95 


emmeansdraws  <- gather_emmeans_draws(emmeans(model_asp_hurdle_year, ~ Site_Year))



ggplot(data = emmeansdraws, aes(x = .value, y = Site_Year)) +
  
  stat_halfeye(orientation = "horizontal", alpha = 0.5)

#### Compound Graphs ####
library("cowplot")
plot_grid(bxp, dp, bp + rremove("x.text"), 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

library("cowplot")
plot_grid(alarm_site_year_plot, asprm_site_year_plot, glutamate_syrm_model,
          glnrm_site_year_plot, glyrm_site_year_plot, prorm_site_year_plot, serrm_site_year_plot, tyrrm_site_year_plot + rremove("x.text"), 
          labels = c("A", "B", "C", "D", "E", "F", "G", "H"),
          ncol = 2, nrow = 5)

#### test simple model ####
test_tyr <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Tyrosine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,30), class = b),
                          prior(normal(0,30), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_tyr)
pp_check(test_tyr, ndraws = 100) +
  theme_bw()
summary(test_tyr)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Tyrosine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            45.95     18.36    11.31    83.52 1.00    27356    35963
# sigma_Intercept                       2.52      0.82     0.95     4.15 1.00    26880    34856
# Site_YearDauphinRiver_2018           -0.31     14.28   -27.27    28.92 1.00    31494    39094
# Site_YearMatheson_2017               -0.64     17.50   -33.14    36.59 1.00    38853    35252
# Site_YearMatheson_2018              -45.58      9.10   -63.07   -27.10 1.00    18345    27088
# Site_YearRedRiver_2017              -13.72      9.36   -30.98     5.97 1.00    19110    25616
# Site_YearRedRiver_2018              -21.20     12.38   -44.39     4.56 1.00    26191    34379
# Site_YearSandyBar_2017              -17.77      9.92   -36.28     2.92 1.00    22346    29236
# Site_YearSandyBar_2018              -50.05      9.21   -67.50   -31.25 1.00    18880    25348
# Site_YearWinnipegRiver_2017         -31.09     14.20   -54.98     1.25 1.00    25492    28855
# K                                    44.06     14.74    14.05    71.79 1.00    30961    38602
# SexM                                -11.21      5.96   -22.53     0.93 1.00    36719    41964
# SexUN                               -13.78      4.83   -23.78    -4.58 1.00    42226    39354
# sigma_Site_YearDauphinRiver_2018      0.48      0.30    -0.13     1.07 1.00    25096    28407
# sigma_Site_YearMatheson_2017          0.15      0.42    -0.64     1.03 1.00    27503    34808
# sigma_Site_YearMatheson_2018         -1.31      0.34    -2.00    -0.64 1.00    25426    30176
# sigma_Site_YearRedRiver_2017         -0.97      0.28    -1.53    -0.43 1.00    27424    29906
# sigma_Site_YearRedRiver_2018         -0.18      0.29    -0.75     0.38 1.00    25905    31697
# sigma_Site_YearSandyBar_2017         -0.54      0.27    -1.10    -0.02 1.00    24615    27856
# sigma_Site_YearSandyBar_2018         -1.13      0.36    -1.85    -0.42 1.00    24449    31859
# sigma_Site_YearWinnipegRiver_2017    -1.15      0.58    -2.17     0.09 1.00    24786    27407
# sigma_K                               1.15      0.67    -0.16     2.47 1.00    32243    39774
# sigma_SexM                           -0.05      0.22    -0.49     0.39 1.00    39704    40974
# sigma_SexUN                          -0.64      0.34    -1.32     0.03 1.00    40329    42773
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     6.09      2.18     2.69    11.10 1.00    35018    35781
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_tyr, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    86.2      68.4     101.8
# DauphinRiver_2018    84.8      61.4     110.6
# Matheson_2017        84.2      53.5     120.1
# Matheson_2018        40.3      32.2      48.6
# RedRiver_2017        71.9      62.3      82.8
# RedRiver_2018        64.0      46.6      84.5
# SandyBar_2017        67.8      55.6      80.6
# SandyBar_2018        35.5      28.7      43.9
# WinnipegRiver_2017   52.6      34.3      82.1
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_tyr, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     0.669    -28.18     27.86
# DauphinRiver_2017 - Matheson_2017         1.427    -34.98     34.64
# DauphinRiver_2017 - Matheson_2018        45.723     27.25     63.17
# DauphinRiver_2017 - RedRiver_2017        14.181     -5.11     31.71
# DauphinRiver_2017 - RedRiver_2018        21.691     -3.57     45.12
# DauphinRiver_2017 - SandyBar_2017        18.142     -1.93     37.05
# DauphinRiver_2017 - SandyBar_2018        50.309     31.57     67.78
# DauphinRiver_2017 - WinnipegRiver_2017   32.497      1.88     56.90
# DauphinRiver_2018 - Matheson_2017         0.552    -40.20     41.35
# DauphinRiver_2018 - Matheson_2018        44.488     21.04     70.95
# DauphinRiver_2018 - RedRiver_2017        13.079    -13.39     40.97
# DauphinRiver_2018 - RedRiver_2018        20.813     -9.33     52.07
# DauphinRiver_2018 - SandyBar_2017        17.008     -9.51     45.51
# DauphinRiver_2018 - SandyBar_2018        49.044     26.21     75.76
# DauphinRiver_2018 - WinnipegRiver_2017   31.232     -3.80     65.57
# Matheson_2017 - Matheson_2018            43.840     13.34     80.97
# Matheson_2017 - RedRiver_2017            12.123    -21.01     48.56
# Matheson_2017 - RedRiver_2018            20.281    -18.37     59.11
# Matheson_2017 - SandyBar_2017            16.188    -16.33     54.02
# Matheson_2017 - SandyBar_2018            48.434     16.66     84.21
# Matheson_2017 - WinnipegRiver_2017       30.516    -11.35     72.08
# Matheson_2018 - RedRiver_2017           -31.526    -45.40    -18.68
# Matheson_2018 - RedRiver_2018           -23.824    -46.48     -3.37
# Matheson_2018 - SandyBar_2017           -27.488    -42.45    -13.59
# Matheson_2018 - SandyBar_2018             4.533     -6.83     15.16
# Matheson_2018 - WinnipegRiver_2017      -12.801    -41.64      8.60
# RedRiver_2017 - RedRiver_2018             7.860    -14.51     28.78
# RedRiver_2017 - SandyBar_2017             4.168    -11.22     18.78
# RedRiver_2017 - SandyBar_2018            36.210     23.04     49.63
# RedRiver_2017 - WinnipegRiver_2017       19.401     -9.90     41.32
# RedRiver_2018 - SandyBar_2017            -3.816    -25.86     20.16
# RedRiver_2018 - SandyBar_2018            28.187      9.08     49.37
# RedRiver_2018 - WinnipegRiver_2017       10.971    -22.74     40.33
# SandyBar_2017 - SandyBar_2018            32.087     17.89     47.03
# SandyBar_2017 - WinnipegRiver_2017       14.897    -15.49     38.11
# SandyBar_2018 - WinnipegRiver_2017      -17.130    -46.64      4.00
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_tyr, ~ Site_Year)) #### That's the one!!!!!!
test_tr=yr_plot<- plot(emmeans(test_tyr, ~ Site_Year)) #### That's the one!!!!!!
test_tr=yr_plot
ggsave("test_tr=yr_plot.png")
plot(emmeans(test_tyr, ~ Sex*Site_Year))
plot(pairs(emmeans(test_tyr, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test_tyr.rda")
tyr_tets_plot <- gather_emmeans_draws(emmeans(test_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("tyr_tets_plot.png")
library(repmod)
library(report)
report(test_tyr)
report_table(test_tyr)

#### test ala ####
hist(raw_dataf$Alanine)
test_ala <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Alanine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,400), class = b),
                          prior(normal(0,400), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_ala)
pp_check(test_ala, ndraws = 100) +
  theme_bw()


summary(test_ala)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Alanine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000test_arg <- brm(data=raw_dataf,
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            85.34    110.79  -132.49   303.38 1.00    26212    34085
# sigma_Intercept                       4.37      0.81     2.81     5.97 1.00    27932    39063
# Site_YearDauphinRiver_2018         -135.19     53.54  -243.69   -31.31 1.00    21107    27337
# Site_YearMatheson_2017              -78.17     73.81  -211.19    81.92 1.00    21958    28836
# Site_YearMatheson_2018             -158.94     52.57  -263.59   -55.74 1.00    18725    23637
# Site_YearRedRiver_2017              -30.69     51.51  -131.72    71.31 1.00    21866    27443
# Site_YearRedRiver_2018             -155.95     43.33  -246.11   -74.88 1.00    18384    22234
# Site_YearSandyBar_2017               -6.01     48.78  -104.85    87.44 1.00    19182    24451
# Site_YearSandyBar_2018             -156.43     63.20  -278.19   -28.45 1.00    22395    29707
# Site_YearWinnipegRiver_2017          13.99     71.71  -116.94   166.01 1.00    22823    25484
# K                                   333.96     87.48   165.62   509.48 1.00    36800    42637
# SexM                                  9.19     30.84   -48.77    71.63 1.00    48001    41027
# SexUN                                57.10     89.48  -100.72   251.85 1.00    42059    34575
# sigma_Site_YearDauphinRiver_2018     -0.44      0.31    -1.02     0.18 1.00    26555    36302
# sigma_Site_YearMatheson_2017         -0.39      0.48    -1.25     0.63 1.00    27142    30182
# sigma_Site_YearMatheson_2018         -0.55      0.35    -1.21     0.15 1.00    24595    34362
# sigma_Site_YearRedRiver_2017         -0.27      0.27    -0.79     0.26 1.00    28876    37267
# sigma_Site_YearRedRiver_2018         -0.88      0.28    -1.43    -0.32 1.00    30378    37502
# sigma_Site_YearSandyBar_2017         -0.35      0.26    -0.85     0.16 1.00    26914    34817
# sigma_Site_YearSandyBar_2018          0.08      0.31    -0.53     0.71 1.00    25183    34910
# sigma_Site_YearWinnipegRiver_2017    -0.74      0.53    -1.63     0.43 1.00    29439    27062
# sigma_K                               0.67      0.66    -0.63     1.96 1.00    33535    41576
# sigma_SexM                            0.03      0.22    -0.40     0.47 1.00    53046    44067
# sigma_SexUN                           0.75      0.35     0.08     1.45 1.00    42777    43048
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.22      1.49     1.99     7.83 1.00    39917    29597
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_ala, ~ Site_Year)
# pairs(emmeans(test_ala, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    134.08     28.96    240.94
# DauphinRiver_2017 - Matheson_2017         82.40    -68.96    221.19
# DauphinRiver_2017 - Matheson_2018        158.67     56.00    263.70
# DauphinRiver_2017 - RedRiver_2017         30.98    -72.44    130.58
# DauphinRiver_2017 - RedRiver_2018        154.29     70.90    241.47
# DauphinRiver_2017 - SandyBar_2017          5.09    -89.29    102.71
# DauphinRiver_2017 - SandyBar_2018        157.67     31.53    280.97
# DauphinRiver_2017 - WinnipegRiver_2017   -11.37   -154.42    126.11
# DauphinRiver_2018 - Matheson_2017        -50.77   -203.44     70.35
# DauphinRiver_2018 - Matheson_2018         24.19    -63.40    114.07
# DauphinRiver_2018 - RedRiver_2017       -103.47   -206.41     -5.52
# DauphinRiver_2018 - RedRiver_2018         20.37    -63.32    105.28
# DauphinRiver_2018 - SandyBar_2017       -128.78   -217.56    -37.38
# DauphinRiver_2018 - SandyBar_2018         22.88   -100.00    139.36
# DauphinRiver_2018 - WinnipegRiver_2017  -146.11   -291.25    -11.31
# Matheson_2017 - Matheson_2018             75.16    -47.60    224.47
# Matheson_2017 - RedRiver_2017            -52.33   -184.99    100.69
# Matheson_2017 - RedRiver_2018             72.19    -43.11    210.29
# Matheson_2017 - SandyBar_2017            -78.06   -196.26     71.13
# Matheson_2017 - SandyBar_2018             75.25    -73.78    229.05
# Matheson_2017 - WinnipegRiver_2017       -94.79   -265.73     87.68
# Matheson_2018 - RedRiver_2017           -127.93   -226.17    -26.55
# Matheson_2018 - RedRiver_2018             -4.54    -81.96     78.77
# Matheson_2018 - SandyBar_2017           -153.80   -236.63    -65.26
# Matheson_2018 - SandyBar_2018             -1.63   -117.61    113.23
# Matheson_2018 - WinnipegRiver_2017      -171.06   -310.58    -32.61
# RedRiver_2017 - RedRiver_2018            123.95     47.10    207.16
# RedRiver_2017 - SandyBar_2017            -25.37   -113.91     67.36
# RedRiver_2017 - SandyBar_2018            127.63     -2.44    244.27
# RedRiver_2017 - WinnipegRiver_2017       -41.33   -181.11     88.83
# RedRiver_2018 - SandyBar_2017           -149.35   -220.64    -80.76
# RedRiver_2018 - SandyBar_2018              3.34   -105.41     99.37
# RedRiver_2018 - WinnipegRiver_2017      -165.79   -296.26    -43.33
# SandyBar_2017 - SandyBar_2018            152.62     37.38    258.76
# SandyBar_2017 - WinnipegRiver_2017       -16.77   -154.94    108.59
# SandyBar_2018 - WinnipegRiver_2017      -169.75   -321.71     -6.15
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95
plot(emmeans(test_ala, ~ Site_Year))
test_ala_plot<- plot(emmeans(test_ala, ~ Site_Year)) #### That's the one!!!!!!
test_ala_plot
plot(emmeans(test_ala, ~ Sex*Site_Year))
plot(pairs(emmeans(test_ala, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_ala, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_ala, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ala_tets_plot <- gather_emmeans_draws(emmeans(test_ala, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("ala_tets_plot.png")
ggsave("test_ala_plot.png")
save(test_ala, file = "alanine_simple_model.RData")
report(test_ala)
report_table(test_ala)

test_arg <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Argininee ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,150), class = b),
                          prior(normal(0,150), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
#### Arg ####
hist(raw_dataf$Arginine)
test_arg <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Arginine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,150), class = b),
                          prior(normal(0,150), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_arg)
pp_check(test_arg, ndraws = 100) +
  theme_bw()
summary(test_arg)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Arginine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           130.20     31.00    69.44   191.30 1.00    36641    40289
# sigma_Intercept                       2.55      0.83     0.94     4.21 1.00    33111    39510
# Site_YearDauphinRiver_2018         -123.82     12.63  -149.07   -99.05 1.00    22825    29773
# Site_YearMatheson_2017              -15.53     22.25   -58.44    29.53 1.00    28684    28393
# Site_YearMatheson_2018             -105.25     13.12  -131.03   -79.39 1.00    23932    32693
# Site_YearRedRiver_2017               -5.88     13.28   -31.92    20.45 1.00    27061    34491
# Site_YearRedRiver_2018              -87.63     16.76  -120.40   -54.49 1.00    26939    34933
# Site_YearSandyBar_2017               -3.31     13.38   -29.74    23.41 1.00    27685    35992
# Site_YearSandyBar_2018              -94.58     13.81  -122.45   -67.84 1.00    23748    32066
# Site_YearWinnipegRiver_2017         -16.23     43.70  -102.58    72.77 1.00    33770    27350
# K                                    47.47     26.48    -4.42    99.56 1.00    42074    42725
# SexM                                -28.31     12.16   -51.94    -4.56 1.00    33604    42458
# SexUN                               -21.26      8.67   -38.32    -4.04 1.00    45005    39663
# sigma_Site_YearDauphinRiver_2018     -0.43      0.31    -1.03     0.18 1.00    30298    38198
# sigma_Site_YearMatheson_2017          0.00      0.45    -0.78     0.99 1.00    31812    29905
# sigma_Site_YearMatheson_2018         -0.24      0.36    -0.93     0.48 1.00    29407    39193
# sigma_Site_YearRedRiver_2017         -0.25      0.26    -0.76     0.28 1.00    32965    38904
# sigma_Site_YearRedRiver_2018         -0.02      0.29    -0.59     0.57 1.00    31671    37610
# sigma_Site_YearSandyBar_2017         -0.03      0.25    -0.53     0.47 1.00    31641    37841
# sigma_Site_YearSandyBar_2018         -0.32      0.32    -0.93     0.31 1.00    29158    37034
# sigma_Site_YearWinnipegRiver_2017     0.48      0.51    -0.42     1.61 1.00    32821    31669
# sigma_K                               0.96      0.69    -0.40     2.31 1.00    37720    41737
# sigma_SexM                            0.25      0.24    -0.24     0.71 1.00    34225    41025
# sigma_SexUN                          -0.38      0.36    -1.05     0.36 1.00    42452    42371
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     0.67      1.27    -1.66     3.12 1.00    30443    36475
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_arg, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   165.8     144.5     186.4
# DauphinRiver_2018    41.9      26.9      56.2
# Matheson_2017       149.6     109.2     191.4
# Matheson_2018        60.5      42.2      78.8
# RedRiver_2017       159.7     140.6     179.9
# RedRiver_2018        77.9      53.7     103.6
# SandyBar_2017       162.3     142.2     182.8
# SandyBar_2018        71.4      53.5      87.5
# WinnipegRiver_2017  148.8      64.0     236.5
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_arg, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   123.710      98.5  148.4258
# DauphinRiver_2017 - Matheson_2017        15.967     -29.7   58.2347
# DauphinRiver_2017 - Matheson_2018       105.210      79.8  131.3771
# DauphinRiver_2017 - RedRiver_2017         5.926     -20.7   31.6799
# DauphinRiver_2017 - RedRiver_2018        87.719      55.0  120.7973
# DauphinRiver_2017 - SandyBar_2017         3.384     -22.7   30.3299
# DauphinRiver_2017 - SandyBar_2018        94.364      67.7  122.2289
# DauphinRiver_2017 - WinnipegRiver_2017   16.766     -72.9  102.3716
# DauphinRiver_2018 - Matheson_2017      -107.791    -152.1  -66.7199
# DauphinRiver_2018 - Matheson_2018       -18.683     -37.0   -0.0255
# DauphinRiver_2018 - RedRiver_2017      -117.795    -142.0  -93.3233
# DauphinRiver_2018 - RedRiver_2018       -36.281     -66.9   -4.8583
# DauphinRiver_2018 - SandyBar_2017      -120.240    -144.8  -97.1364
# DauphinRiver_2018 - SandyBar_2018       -29.832     -52.4   -5.0474
# DauphinRiver_2018 - WinnipegRiver_2017 -107.119    -196.4  -21.7458
# Matheson_2017 - Matheson_2018            89.248      46.1  132.7051
# Matheson_2017 - RedRiver_2017           -10.207     -53.8   35.4070
# Matheson_2017 - RedRiver_2018            71.979      24.5  120.4927
# Matheson_2017 - SandyBar_2017           -12.810     -55.8   32.5124
# Matheson_2017 - SandyBar_2018            78.659      35.1  123.5083
# Matheson_2017 - WinnipegRiver_2017        0.731     -93.3   94.7670
# Matheson_2018 - RedRiver_2017           -99.372    -124.9  -73.6325
# Matheson_2018 - RedRiver_2018           -17.805     -49.1   14.9564
# Matheson_2018 - SandyBar_2017          -101.846    -127.0  -77.7508
# Matheson_2018 - SandyBar_2018           -11.072     -35.1   14.7268
# Matheson_2018 - WinnipegRiver_2017      -88.822    -175.8   -0.1458
# RedRiver_2017 - RedRiver_2018            81.448      51.1  115.0246
# RedRiver_2017 - SandyBar_2017            -2.569     -27.3   22.1241
# RedRiver_2017 - SandyBar_2018            88.224      63.0  116.1379
# RedRiver_2017 - WinnipegRiver_2017       11.042     -76.1   97.2909
# RedRiver_2018 - SandyBar_2017           -84.096    -116.8  -51.1659
# RedRiver_2018 - SandyBar_2018             6.761     -19.9   32.9783
# RedRiver_2018 - WinnipegRiver_2017      -70.752    -162.5   17.1630
# SandyBar_2017 - SandyBar_2018            90.809      65.2  119.2494
# SandyBar_2017 - WinnipegRiver_2017       13.354     -74.1  100.3904
# SandyBar_2018 - WinnipegRiver_2017      -77.660    -166.9    8.2027
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_arg, ~ Site_Year))
test_arg_plot<- plot(emmeans(test_arg, ~ Site_Year)) #### That's the one!!!!!!
test_arg_plot
plot(emmeans(test_arg, ~ Sex*Site_Year))
plot(pairs(emmeans(test_arg, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_arg, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_arg, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
arg_tets_plot <- gather_emmeans_draws(emmeans(test_arg, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
arg_tets_plot
p5<- arg_tets_plot
ggsave("arg_tets_plot.png")
ggsave("test_arg_plot.png")
save(test_arg, file = "arginine_simple_model.RData")

#### Asn ####
# loads of zeroths
hist(raw_dataf$Asparagine)
test_asp <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Asparagine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,60), class = b),
                          prior(normal(0,60), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_asn)
pp_check(test_asn, ndraws = 100) +
  theme_bw()
summary(test_asn)
emmeans(test_asn, ~ Site_Year)
pairs(emmeans(test_asn, ~ Site_Year))
plot(emmeans(test_asn, ~ Site_Year))
test_arn_plot<- plot(emmeans(test_asn, ~ Site_Year)) #### That's the one!!!!!!
test_arn_plot
plot(emmeans(test_asn, ~ Sex*Site_Year))
plot(pairs(emmeans(test_asn, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_asn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_asn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
arg_tets_plot <- gather_emmeans_draws(emmeans(test_asn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("asn_tets_plot.png")
ggsave("test_asn_plot.png")
save(test_asn, file = "asparagine_simple_model.RData")

#### Asp ####
hist(raw_dataf$Aspartate)
test_asp <- brm(data=raw_dataf,
                family = student,
                bf(Aspartate ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,45), class = b),
                          prior(normal(0,45), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_asp)
pp_check(test_asp, ndraws = 100) +
  theme_bw()
summary(test_asp)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Aspartate ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            34.94      8.61    17.32    51.41 1.00    19161    30073
# sigma_Intercept                       2.84      1.02     0.89     4.91 1.00    23735    32532
# Site_YearDauphinRiver_2018          -19.99      6.01   -31.77    -8.09 1.00    16626    25365
# Site_YearMatheson_2017              -11.80      9.20   -30.27     5.87 1.00    24356    32757
# Site_YearMatheson_2018              -28.70      5.69   -39.90   -17.54 1.00    15228    22012
# Site_YearRedRiver_2017              -16.39      6.67   -29.47    -3.08 1.00    19610    29897
# Site_YearRedRiver_2018              -33.32      5.41   -43.94   -22.64 1.00    14812    21937
# Site_YearSandyBar_2017               -4.92      6.72   -18.12     8.39 1.00    19942    32086
# Site_YearSandyBar_2018              -32.33      5.60   -43.34   -21.21 1.00    15348    23431
# Site_YearWinnipegRiver_2017           7.78     14.30   -21.56    34.98 1.00    29073    29627
# K                                     6.46      5.91    -4.29    19.29 1.00    29249    30085
# SexM                                 -1.98      2.03    -5.75     2.29 1.00    33895    32138
# SexUN                                -2.31      4.32   -10.47     6.76 1.00    46042    36839
# sigma_Site_YearDauphinRiver_2018     -0.91      0.40    -1.71    -0.13 1.00    24147    32229
# sigma_Site_YearMatheson_2017         -0.45      0.50    -1.38     0.61 1.00    31671    34039
# sigma_Site_YearMatheson_2018         -1.30      0.44    -2.20    -0.45 1.00    22015    31538
# sigma_Site_YearRedRiver_2017         -0.32      0.31    -0.93     0.29 1.00    35465    41169
# sigma_Site_YearRedRiver_2018         -1.90      0.42    -2.72    -1.09 1.00    20825    34488
# sigma_Site_YearSandyBar_2017         -0.23      0.30    -0.81     0.35 1.00    30589    36757
# sigma_Site_YearSandyBar_2018         -1.29      0.37    -2.03    -0.55 1.00    23364    34714
# sigma_Site_YearWinnipegRiver_2017     0.08      0.58    -0.97     1.32 1.00    36061    34904
# sigma_K                               0.09      0.85    -1.63     1.71 1.00    25354    35079
# sigma_SexM                            0.10      0.26    -0.40     0.61 1.00    39198    43359
# sigma_SexUN                           0.41      0.40    -0.35     1.21 1.00    39884    39925
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     7.81      7.05     2.45    28.21 1.00    21560    31363
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_asp, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   40.60     29.63      51.5
# DauphinRiver_2018   20.54     15.01      26.4
# Matheson_2017       29.02     13.40      43.4
# Matheson_2018       11.79      7.10      17.0
# RedRiver_2017       24.13     15.50      33.0
# RedRiver_2018        7.19      3.91      10.8
# SandyBar_2017       35.69     27.02      44.5
# SandyBar_2018        8.11      4.04      12.8
# WinnipegRiver_2017  48.84     20.92      74.6
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_asp, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    19.985     8.381    32.028
# DauphinRiver_2017 - Matheson_2017        11.662    -6.456    29.615
# DauphinRiver_2017 - Matheson_2018        28.682    17.451    39.797
# DauphinRiver_2017 - RedRiver_2017        16.456     3.337    29.706
# DauphinRiver_2017 - RedRiver_2018        33.324    22.619    43.909
# DauphinRiver_2017 - SandyBar_2017         4.950    -8.439    18.073
# DauphinRiver_2017 - SandyBar_2018        32.355    21.377    43.459
# DauphinRiver_2017 - WinnipegRiver_2017   -8.157   -35.629    20.854
# DauphinRiver_2018 - Matheson_2017        -8.422   -23.327     8.337
# DauphinRiver_2018 - Matheson_2018         8.719     2.253    15.137
# DauphinRiver_2018 - RedRiver_2017        -3.585   -13.831     6.466
# DauphinRiver_2018 - RedRiver_2018        13.308     7.058    19.341
# DauphinRiver_2018 - SandyBar_2017       -15.066   -25.278    -5.073
# DauphinRiver_2018 - SandyBar_2018        12.349     5.652    18.824
# DauphinRiver_2018 - WinnipegRiver_2017  -28.224   -54.169     0.325
# Matheson_2017 - Matheson_2018            17.176     1.381    32.088
# Matheson_2017 - RedRiver_2017             4.814   -13.125    21.299
# Matheson_2017 - RedRiver_2018            21.731     6.125    35.860
# Matheson_2017 - SandyBar_2017            -6.797   -23.662     9.881
# Matheson_2017 - SandyBar_2018            20.773     4.583    35.279
# Matheson_2017 - WinnipegRiver_2017      -19.832   -48.932    11.608
# Matheson_2018 - RedRiver_2017           -12.297   -21.992    -2.785
# Matheson_2018 - RedRiver_2018             4.509    -0.117     9.552
# Matheson_2018 - SandyBar_2017           -23.775   -33.144   -14.460
# Matheson_2018 - SandyBar_2018             3.618    -1.726     9.040
# Matheson_2018 - WinnipegRiver_2017      -36.958   -62.914    -8.541
# RedRiver_2017 - RedRiver_2018            16.896     8.276    25.367
# RedRiver_2017 - SandyBar_2017           -11.479   -22.863     0.247
# RedRiver_2017 - SandyBar_2018            15.917     6.703    24.938
# RedRiver_2017 - WinnipegRiver_2017      -24.645   -51.386     4.120
# RedRiver_2018 - SandyBar_2017           -28.424   -36.724   -19.682
# RedRiver_2018 - SandyBar_2018            -0.918    -5.068     2.850
# RedRiver_2018 - WinnipegRiver_2017      -41.571   -66.967   -13.312
# SandyBar_2017 - SandyBar_2018            27.424    18.477    36.552
# SandyBar_2017 - WinnipegRiver_2017      -13.073   -39.659    16.000
# SandyBar_2018 - WinnipegRiver_2017      -40.519   -66.266   -12.167
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_asp, ~ Site_Year))
test_arg_plot<- plot(emmeans(test_asp, ~ Site_Year)) #### That's the one!!!!!!
test_arg_plot
plot(emmeans(test_asp, ~ Sex*Site_Year))
plot(pairs(emmeans(test_asp, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_asp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_asp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
arg_tets_plot <- gather_emmeans_draws(emmeans(test_asp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("asp_tets_plot.png")
ggsave("test_asp_plot.png")
save(test_asp, file = "aspartate_simple_model.RData")

#### gln ####
hist(raw_dataf$Glutamine)
test_gln <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Glutamine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,45), class = b),
                          prior(normal(0,45), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_gln)
pp_check(test_gln, ndraws = 100) +
  theme_bw()
summary(test_gln)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Glutamine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             4.11     12.72   -20.11    29.96 1.00    17816    28183
# sigma_Intercept                       0.83      0.93    -1.00     2.64 1.00    17697    30332
# Site_YearDauphinRiver_2018          -13.72      7.03   -27.33     0.23 1.00    20855    27892
# Site_YearMatheson_2017               -7.27      8.45   -22.35    11.46 1.00    20718    26316
# Site_YearMatheson_2018              -21.65      5.10   -32.37   -12.33 1.00    13462    19831
# Site_YearRedRiver_2017               -8.54      4.90   -18.27     1.21 1.00    22991    28285
# Site_YearRedRiver_2018              -16.55      5.22   -26.88    -6.16 1.00    17726    23580
# Site_YearSandyBar_2017               -1.28      4.91   -11.05     8.49 1.00    19094    26716
# Site_YearSandyBar_2018              -25.09      4.73   -34.86   -16.05 1.00    15815    20853
# Site_YearWinnipegRiver_2017           6.14     14.48   -20.41    38.45 1.00    25658    23192
# K                                    33.47     10.35    13.26    53.86 1.00    24989    37946
# SexM                                 -4.75      3.30   -11.15     1.81 1.00    29252    39817
# SexUN                                -2.74      4.33   -11.89     5.29 1.00    35684    33947
# sigma_Site_YearDauphinRiver_2018      0.51      0.40    -0.26     1.33 1.00    16215    28462
# sigma_Site_YearMatheson_2017          0.12      0.48    -0.75     1.14 1.00    21624    28980
# sigma_Site_YearMatheson_2018         -0.42      0.40    -1.20     0.35 1.00    14455    25875
# sigma_Site_YearRedRiver_2017         -0.19      0.28    -0.75     0.36 1.00    19277    29092
# sigma_Site_YearRedRiver_2018         -0.01      0.29    -0.59     0.57 1.00    18416    30175
# sigma_Site_YearSandyBar_2017          0.01      0.29    -0.55     0.57 1.00    16778    28672
# sigma_Site_YearSandyBar_2018         -0.41      0.33    -1.09     0.22 1.00    16602    26800
# sigma_Site_YearWinnipegRiver_2017     0.23      0.51    -0.67     1.35 1.00    23646    28068
# sigma_K                               1.69      0.73     0.28     3.12 1.00    24113    38407
# sigma_SexM                            0.00      0.24    -0.46     0.47 1.00    18331    31074
# sigma_SexUN                          -0.53      0.46    -1.47     0.33 1.00    25522    33782
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.86      1.97     1.77     9.43 1.00    31483    33050
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 3 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
emmeans(test_gln, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    38.1     31.00      46.4
# DauphinRiver_2018    24.3     13.48      35.6
# Matheson_2017        30.1     17.37      47.0
# Matheson_2018        16.6     10.97      22.9
# RedRiver_2017        29.6     22.31      37.7
# RedRiver_2018        21.5     14.20      29.4
# SandyBar_2017        36.8     29.90      44.6
# SandyBar_2018        13.1      7.52      18.9
# WinnipegRiver_2017   43.3     16.73      74.2
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_gln, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     13.78   -0.0191    27.481
# DauphinRiver_2017 - Matheson_2017          7.88   -9.7583    23.703
# DauphinRiver_2017 - Matheson_2018         21.38   12.0428    32.005
# DauphinRiver_2017 - RedRiver_2017          8.56   -1.3525    18.112
# DauphinRiver_2017 - RedRiver_2018         16.58    5.9460    26.605
# DauphinRiver_2017 - SandyBar_2017          1.24   -8.5405    10.984
# DauphinRiver_2017 - SandyBar_2018         24.99   15.8150    34.597
# DauphinRiver_2017 - WinnipegRiver_2017    -5.13  -36.3233    21.982
# DauphinRiver_2018 - Matheson_2017         -6.13  -25.4989    12.089
# DauphinRiver_2018 - Matheson_2018          7.55   -3.0931    19.934
# DauphinRiver_2018 - RedRiver_2017         -5.22  -18.8004     8.768
# DauphinRiver_2018 - RedRiver_2018          2.72  -11.0615    16.388
# DauphinRiver_2018 - SandyBar_2017        -12.54  -25.7461     1.185
# DauphinRiver_2018 - SandyBar_2018         11.10   -1.0902    24.437
# DauphinRiver_2018 - WinnipegRiver_2017   -19.10  -51.4900    10.173
# Matheson_2017 - Matheson_2018             13.68   -0.2972    30.268
# Matheson_2017 - RedRiver_2017              0.67  -14.7567    18.462
# Matheson_2017 - RedRiver_2018              8.60   -6.2494    25.924
# Matheson_2017 - SandyBar_2017             -6.64  -21.1896    11.276
# Matheson_2017 - SandyBar_2018             16.97    3.4853    33.815
# Matheson_2017 - WinnipegRiver_2017       -12.96  -47.6723    17.328
# Matheson_2018 - RedRiver_2017            -12.94  -23.2269    -3.302
# Matheson_2018 - RedRiver_2018             -4.98  -14.4848     4.349
# Matheson_2018 - SandyBar_2017            -20.24  -29.9524   -11.521
# Matheson_2018 - SandyBar_2018              3.40   -4.0583    10.800
# Matheson_2018 - WinnipegRiver_2017       -26.83  -58.9558     0.197
# RedRiver_2017 - RedRiver_2018              8.03   -2.2864    18.268
# RedRiver_2017 - SandyBar_2017             -7.28  -16.8747     2.418
# RedRiver_2017 - SandyBar_2018             16.49    7.2855    26.145
# RedRiver_2017 - WinnipegRiver_2017       -13.67  -45.6572    12.872
# RedRiver_2018 - SandyBar_2017            -15.31  -24.9751    -5.462
# RedRiver_2018 - SandyBar_2018              8.35    0.3387    17.551
# RedRiver_2018 - WinnipegRiver_2017       -21.69  -53.5782     5.444
# SandyBar_2017 - SandyBar_2018             23.76   14.9365    32.796
# SandyBar_2017 - WinnipegRiver_2017        -6.38  -37.7907    20.579
# SandyBar_2018 - WinnipegRiver_2017       -30.25  -61.5807    -3.069
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_gln, ~ Site_Year))
test_gln_plot<- plot(emmeans(test_gln, ~ Site_Year)) #### That's the one!!!!!!
test_gln_plot
plot(emmeans(test_gln, ~ Sex*Site_Year))
plot(pairs(emmeans(test_gln, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_gln, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_gln, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
gln_tets_plot <- gather_emmeans_draws(emmeans(test_gln, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("gln_tets_plot.png")
ggsave("test_gln_plot.png")
save(test_gln, file = "glutamine_simple_model.RData")

#### glu ####
hist(raw_dataf$Glutamate)
test_glu <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Glutamate ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,250), class = b),
                          prior(normal(0,250), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_glu)
pp_check(test_glu, ndraws = 100) +
  theme_bw()
summary(test_glu)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Glutamate ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           107.03     41.62    25.98   189.18 1.00    14043    23026
# sigma_Intercept                       3.73      0.83     2.08     5.34 1.00    18842    31988
# Site_YearDauphinRiver_2018          -83.46     25.75  -136.20   -35.67 1.00    11552    17240
# Site_YearMatheson_2017              -16.94     52.01  -109.43    98.89 1.00    20376    23707
# Site_YearMatheson_2018             -107.61     26.18  -162.26   -59.41 1.00    10751    15502
# Site_YearRedRiver_2017               45.63     29.30   -12.36   103.33 1.00    14425    21623
# Site_YearRedRiver_2018              -82.89     24.83  -133.55   -36.22 1.00    13005    18791
# Site_YearSandyBar_2017               -5.32     28.84   -62.93    50.96 1.00    14994    22455
# Site_YearSandyBar_2018             -110.51     24.15  -160.58   -65.57 1.00    11442    16188
# Site_YearWinnipegRiver_2017         -61.52     37.02  -128.81    17.48 1.00    15980    23553
# K                                    83.13     26.08    33.55   136.81 1.00    28673    33710
# SexM                                -24.21     10.33   -43.64    -3.09 1.00    24984    36932
# SexUN                                -7.10      7.76   -23.00     7.70 1.00    40617    38393
# sigma_Site_YearDauphinRiver_2018     -0.86      0.34    -1.50    -0.16 1.00    19330    31960
# sigma_Site_YearMatheson_2017          0.10      0.47    -0.73     1.11 1.00    27634    29525
# sigma_Site_YearMatheson_2018         -1.55      0.35    -2.24    -0.86 1.00    17963    29243
# sigma_Site_YearRedRiver_2017         -0.34      0.28    -0.87     0.21 1.00    23563    33837
# sigma_Site_YearRedRiver_2018         -0.75      0.27    -1.27    -0.22 1.00    26080    33203
# sigma_Site_YearSandyBar_2017         -0.22      0.26    -0.74     0.29 1.00    27274    35092
# sigma_Site_YearSandyBar_2018         -1.35      0.30    -1.92    -0.76 1.00    22860    33479
# sigma_Site_YearWinnipegRiver_2017    -0.99      0.53    -1.90     0.19 1.00    24818    24400
# sigma_K                               0.75      0.67    -0.54     2.10 1.00    23228    34983
# sigma_SexM                           -0.19      0.24    -0.64     0.28 1.00    21566    35836
# sigma_SexUN                          -0.78      0.41    -1.61     0.02 1.00    29064    31970
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.34      1.99     1.31     9.09 1.00    28233    29471
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 6 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
emmeans(test_glu, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   186.6     142.6     234.1
# DauphinRiver_2018   103.7      88.3     121.2
# Matheson_2017       165.3      88.1     273.2
# Matheson_2018        79.8      64.9      95.8
# RedRiver_2017       232.2     200.0     269.1
# RedRiver_2018       104.0      82.9     127.6
# SandyBar_2017       181.2     148.7     218.2
# SandyBar_2018        76.8      66.3      88.7
# WinnipegRiver_2017  122.3      74.5     186.2
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_glu, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    82.511     33.64    133.71
# DauphinRiver_2017 - Matheson_2017        20.551    -87.09    119.72
# DauphinRiver_2017 - Matheson_2018       106.641     55.99    157.97
# DauphinRiver_2017 - RedRiver_2017       -45.538   -102.14     13.45
# DauphinRiver_2017 - RedRiver_2018        82.160     34.77    131.93
# DauphinRiver_2017 - SandyBar_2017         5.070    -50.65     63.16
# DauphinRiver_2017 - SandyBar_2018       109.623     63.88    158.33
# DauphinRiver_2017 - WinnipegRiver_2017   63.050    -11.39    133.39
# DauphinRiver_2018 - Matheson_2017       -61.282   -168.02     19.66
# DauphinRiver_2018 - Matheson_2018        23.433      6.57     43.81
# DauphinRiver_2018 - RedRiver_2017      -128.269   -168.38    -89.72
# DauphinRiver_2018 - RedRiver_2018        -0.367    -29.64     28.88
# DauphinRiver_2018 - SandyBar_2017       -77.245   -117.44    -39.27
# DauphinRiver_2018 - SandyBar_2018        26.654      8.44     46.89
# DauphinRiver_2018 - WinnipegRiver_2017  -18.815    -84.42     34.36
# Matheson_2017 - Matheson_2018            85.467      7.17    194.16
# Matheson_2017 - RedRiver_2017           -66.976   -156.01     41.12
# Matheson_2017 - RedRiver_2018            60.800    -23.01    167.32
# Matheson_2017 - SandyBar_2017           -15.983   -102.56     94.48
# Matheson_2017 - SandyBar_2018            88.043     11.97    197.47
# Matheson_2017 - WinnipegRiver_2017       42.099    -64.70    159.14
# Matheson_2018 - RedRiver_2017          -152.531   -193.10   -115.43
# Matheson_2018 - RedRiver_2018           -24.225    -54.04      4.74
# Matheson_2018 - SandyBar_2017          -101.285   -142.14    -64.70
# Matheson_2018 - SandyBar_2018             2.896    -16.26     21.74
# Matheson_2018 - WinnipegRiver_2017      -42.799   -109.00      8.60
# RedRiver_2017 - RedRiver_2018           127.736     88.11    168.84
# RedRiver_2017 - SandyBar_2017            50.772      3.16     99.64
# RedRiver_2017 - SandyBar_2018           155.172    120.75    193.52
# RedRiver_2017 - WinnipegRiver_2017      109.528     39.70    170.14
# RedRiver_2018 - SandyBar_2017           -77.060   -119.15    -37.87
# RedRiver_2018 - SandyBar_2018            27.195      4.16     52.53
# RedRiver_2018 - WinnipegRiver_2017      -18.444    -85.48     35.48
# SandyBar_2017 - SandyBar_2018           104.143     69.49    141.81
# SandyBar_2017 - WinnipegRiver_2017       58.413    -12.32    119.36
# SandyBar_2018 - WinnipegRiver_2017      -45.569   -111.85      2.14
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_glu, ~ Site_Year))
test_glu_plot<- plot(emmeans(test_glu, ~ Site_Year)) #### That's the one!!!!!!
test_glu_plot
plot(emmeans(test_glu, ~ Sex*Site_Year))
plot(pairs(emmeans(test_glu, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_glu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_glu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
glu_tets_plot <- gather_emmeans_draws(emmeans(test_glu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("glu_tets_plot.png")
ggsave("test_glu_plot.png")
save(test_glu, file = "glutamate_simple_model.RData")

#### gly ####
hist(raw_dataf$Glycine)
test_gly <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Glycine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,700), class = b),
                          prior(normal(0,700), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_gly)
pp_check(test_gly, ndraws = 100) +
  theme_bw()
summary(test_gly)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Glycine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           363.80    187.37     0.55   734.04 1.00    13222    20437
# sigma_Intercept                       4.89      0.93     3.05     6.69 1.00    15239    29382
# Site_YearDauphinRiver_2018          -41.47     95.43  -248.50   126.31 1.00    10449    13421
# Site_YearMatheson_2017             -139.99    109.16  -342.90    90.29 1.00    17083    22177
# Site_YearMatheson_2018             -157.07     97.28  -369.88    13.73 1.00    10062    13118
# Site_YearRedRiver_2017               49.03     85.32  -127.17   210.30 1.00    14187    17936
# Site_YearRedRiver_2018              -21.77     88.64  -210.82   139.23 1.00    11938    14629
# Site_YearSandyBar_2017              -97.50     76.31  -259.19    42.28 1.00    13839    17132
# Site_YearSandyBar_2018             -166.61     87.34  -357.20   -12.79 1.00    11252    13938
# Site_YearWinnipegRiver_2017          45.75    163.15  -249.98   404.97 1.00    17272    23462
# K                                   219.45    135.29   -29.70   498.41 1.00    22136    33654
# SexM                               -127.18     50.66  -216.79   -19.25 1.00    18032    30248
# SexUN                               -81.12     64.42  -197.76    57.81 1.00    41885    30833
# sigma_Site_YearDauphinRiver_2018     -0.69      0.45    -1.57     0.19 1.00    13943    24175
# sigma_Site_YearMatheson_2017         -0.35      0.49    -1.26     0.69 1.00    26566    27462
# sigma_Site_YearMatheson_2018         -0.72      0.43    -1.55     0.12 1.00    12261    22632
# sigma_Site_YearRedRiver_2017         -0.20      0.30    -0.77     0.39 1.00    17932    30442
# sigma_Site_YearRedRiver_2018         -0.43      0.31    -1.02     0.19 1.00    17581    28991
# sigma_Site_YearSandyBar_2017         -0.32      0.26    -0.84     0.19 1.00    20825    30483
# sigma_Site_YearSandyBar_2018         -0.64      0.33    -1.27     0.03 1.00    16006    27827
# sigma_Site_YearWinnipegRiver_2017    -0.18      0.55    -1.14     1.01 1.00    21583    26636
# sigma_K                               0.51      0.73    -0.90     1.96 1.00    20659    35988
# sigma_SexM                           -0.06      0.30    -0.67     0.51 1.00    14634    21894
# sigma_SexUN                           0.31      0.40    -0.47     1.10 1.00    32844    36904
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.96      1.92     2.14     9.59 1.00    30554    29343
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).


emmeans(test_gly, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017     527       394       694
# DauphinRiver_2018     490       416       580
# Matheson_2017         382       230       593
# Matheson_2018         375       287       475
# RedRiver_2017         581       470       703
# RedRiver_2018         510       424       607
# SandyBar_2017         434       343       543
# SandyBar_2018         366       292       447
# WinnipegRiver_2017    566       314       884
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_gly, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     34.35   -136.64    236.07
# DauphinRiver_2017 - Matheson_2017        143.77    -78.72    352.18
# DauphinRiver_2017 - Matheson_2018        149.69    -26.79    353.21
# DauphinRiver_2017 - RedRiver_2017        -51.77   -214.68    122.09
# DauphinRiver_2017 - RedRiver_2018         16.89   -147.15    201.33
# DauphinRiver_2017 - SandyBar_2017         93.61    -47.91    252.39
# DauphinRiver_2017 - SandyBar_2018        160.38      4.48    345.49
# DauphinRiver_2017 - WinnipegRiver_2017   -36.67   -375.19    273.99
# DauphinRiver_2018 - Matheson_2017        109.04   -115.01    290.45
# DauphinRiver_2018 - Matheson_2018        116.67     18.45    211.39
# DauphinRiver_2018 - RedRiver_2017        -89.77   -234.55     55.88
# DauphinRiver_2018 - RedRiver_2018        -21.21   -137.09    101.35
# DauphinRiver_2018 - SandyBar_2017         58.02    -74.44    190.53
# DauphinRiver_2018 - SandyBar_2018        123.12     24.37    231.40
# DauphinRiver_2018 - WinnipegRiver_2017   -75.34   -398.24    188.25
# Matheson_2017 - Matheson_2018              4.97   -167.07    229.31
# Matheson_2017 - RedRiver_2017           -198.25   -396.70     30.74
# Matheson_2017 - RedRiver_2018           -126.18   -313.41     96.73
# Matheson_2017 - SandyBar_2017            -52.31   -224.74    155.27
# Matheson_2017 - SandyBar_2018             17.35   -157.72    235.88
# Matheson_2017 - WinnipegRiver_2017      -182.34   -541.00    156.63
# Matheson_2018 - RedRiver_2017           -205.77   -359.62    -51.10
# Matheson_2018 - RedRiver_2018           -136.10   -263.92     -7.54
# Matheson_2018 - SandyBar_2017            -57.13   -193.04     71.87
# Matheson_2018 - SandyBar_2018              8.33    -99.50    121.30
# Matheson_2018 - WinnipegRiver_2017      -192.45   -502.86     87.03
# RedRiver_2017 - RedRiver_2018             70.37    -65.07    206.43
# RedRiver_2017 - SandyBar_2017            145.40      8.13    281.01
# RedRiver_2017 - SandyBar_2018            214.34     85.74    347.14
# RedRiver_2017 - WinnipegRiver_2017        18.01   -321.93    279.39
# RedRiver_2018 - SandyBar_2017             75.87    -54.65    204.55
# RedRiver_2018 - SandyBar_2018            144.22     45.58    244.99
# RedRiver_2018 - WinnipegRiver_2017       -53.51   -378.11    211.00
# SandyBar_2017 - SandyBar_2018             67.60    -51.04    191.05
# SandyBar_2017 - WinnipegRiver_2017      -130.87   -466.49    126.95
# SandyBar_2018 - WinnipegRiver_2017      -198.66   -528.37     54.91
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95
plot(emmeans(test_gly, ~ Site_Year))
test_gly_plot<- plot(emmeans(test_gly, ~ Site_Year)) #### That's the one!!!!!!
test_gly_plot
plot(emmeans(test_gly, ~ Sex*Site_Year))
plot(pairs(emmeans(test_gly, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_gly, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_gly, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
gly_tets_plot <- gather_emmeans_draws(emmeans(test_gly, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("gly_tets_plot.png")
ggsave("test_gly_plot.png")
save(test_gly, file = "glycine_simple_model.RData")
#### his ####
hist(raw_dataf$Histidine)
test_his <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Histidine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,80), class = b),
                          prior(normal(0,80), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_his)
pp_check(test_his, ndraws = 100) +
  theme_bw()
summary(test_his)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Histidine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            28.34     19.72   -10.11    67.45 1.00    18271    28936
# sigma_Intercept                       1.91      0.85     0.24     3.58 1.00    19964    31432
# Site_YearDauphinRiver_2018          -24.19      9.61   -43.46    -5.57 1.00    16575    25031
# Site_YearMatheson_2017              -19.71     11.32   -40.25     4.52 1.00    21139    26697
# Site_YearMatheson_2018              -26.59      9.39   -45.53    -8.56 1.00    15063    21718
# Site_YearRedRiver_2017              -29.29      7.98   -45.39   -13.74 1.00    19212    24832
# Site_YearRedRiver_2018              -34.26      7.75   -50.09   -19.27 1.00    16625    22612
# Site_YearSandyBar_2017              -24.54      7.86   -40.42    -9.51 1.00    17342    23241
# Site_YearSandyBar_2018              -52.01      7.51   -67.30   -37.60 1.00    14835    20462
# Site_YearWinnipegRiver_2017          -3.45     25.92   -49.57    54.75 1.00    29724    25924
# K                                    54.42     15.37    24.75    85.09 1.00    26050    38579
# SexM                                 -4.39      4.82   -13.80     5.16 1.00    29892    36327
# SexUN                               -11.92      7.42   -25.72     3.21 1.00    40718    33063
# sigma_Site_YearDauphinRiver_2018     -0.20      0.37    -0.91     0.56 1.00    19621    30775
# sigma_Site_YearMatheson_2017         -0.32      0.44    -1.10     0.64 1.00    27318    27512
# sigma_Site_YearMatheson_2018         -0.33      0.34    -1.00     0.33 1.00    17630    29329
# sigma_Site_YearRedRiver_2017         -0.57      0.27    -1.10    -0.02 1.00    24064    35001
# sigma_Site_YearRedRiver_2018         -0.42      0.27    -0.94     0.12 1.00    24153    32248
# sigma_Site_YearSandyBar_2017         -0.45      0.27    -0.97     0.07 1.00    20935    30255
# sigma_Site_YearSandyBar_2018         -0.69      0.30    -1.27    -0.10 1.00    21823    31608
# sigma_Site_YearWinnipegRiver_2017     0.03      0.49    -0.82     1.10 1.00    30560    29712
# sigma_K                               1.39      0.66     0.10     2.70 1.00    25276    37776
# sigma_SexM                           -0.31      0.24    -0.77     0.16 1.00    25788    38754
# sigma_SexUN                          -0.33      0.38    -1.08     0.42 1.00    36929    36196
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.11      2.12     1.82    10.03 1.00    32596    34503
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_his, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    82.2      68.9      96.5
# DauphinRiver_2018    58.1      47.2      70.3
# Matheson_2017        61.8      45.4      83.1
# Matheson_2018        55.8      44.5      67.7
# RedRiver_2017        52.9      42.5      64.4
# RedRiver_2018        48.0      38.7      58.4
# SandyBar_2017        57.8      48.2      68.1
# SandyBar_2018        30.4      22.8      38.7
# WinnipegRiver_2017   76.9      32.3     132.9
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_his, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    24.106      5.36     43.20
# DauphinRiver_2017 - Matheson_2017        20.256     -2.35     41.92
# DauphinRiver_2017 - Matheson_2018        26.373      8.54     45.50
# DauphinRiver_2017 - RedRiver_2017        29.215     13.94     45.56
# DauphinRiver_2017 - RedRiver_2018        34.127     18.94     49.65
# DauphinRiver_2017 - SandyBar_2017        24.408      9.41     40.29
# DauphinRiver_2017 - SandyBar_2018        51.845     37.47     67.09
# DauphinRiver_2017 - WinnipegRiver_2017    5.351    -51.27     52.25
# DauphinRiver_2018 - Matheson_2017        -3.776    -27.63     17.76
# DauphinRiver_2018 - Matheson_2018         2.286    -12.34     17.14
# DauphinRiver_2018 - RedRiver_2017         5.169    -12.08     21.95
# DauphinRiver_2018 - RedRiver_2018        10.104     -5.55     26.09
# DauphinRiver_2018 - SandyBar_2017         0.354    -15.59     16.11
# DauphinRiver_2018 - SandyBar_2018        27.769     13.63     42.14
# DauphinRiver_2018 - WinnipegRiver_2017  -18.642    -74.55     28.78
# Matheson_2017 - Matheson_2018             6.072    -14.72     28.96
# Matheson_2017 - RedRiver_2017             8.835    -10.56     31.42
# Matheson_2017 - RedRiver_2018            13.872     -5.31     34.84
# Matheson_2017 - SandyBar_2017             4.024    -14.72     25.89
# Matheson_2017 - SandyBar_2018            31.525     13.87     52.57
# Matheson_2017 - WinnipegRiver_2017      -14.763    -72.70     35.81
# Matheson_2018 - RedRiver_2017             2.835    -13.57     19.05
# Matheson_2018 - RedRiver_2018             7.656     -6.92     22.52
# Matheson_2018 - SandyBar_2017            -2.026    -16.98     12.69
# Matheson_2018 - SandyBar_2018            25.229     12.46     38.64
# Matheson_2018 - WinnipegRiver_2017      -21.117    -77.28     25.38
# RedRiver_2017 - RedRiver_2018             4.953     -8.83     18.42
# RedRiver_2017 - SandyBar_2017            -4.808    -17.75      8.18
# RedRiver_2017 - SandyBar_2018            22.643     10.14     35.57
# RedRiver_2017 - WinnipegRiver_2017      -23.857    -78.37     22.99
# RedRiver_2018 - SandyBar_2017            -9.821    -22.27      2.70
# RedRiver_2018 - SandyBar_2018            17.738      7.40     27.69
# RedRiver_2018 - WinnipegRiver_2017      -28.776    -83.85     18.44
# SandyBar_2017 - SandyBar_2018            27.430     16.04     39.06
# SandyBar_2017 - WinnipegRiver_2017      -18.992    -74.53     26.84
# SandyBar_2018 - WinnipegRiver_2017      -46.416   -102.91     -1.40
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95
plot(emmeans(test_his, ~ Site_Year))
test_his_plot<- plot(emmeans(test_his, ~ Site_Year)) #### That's the one!!!!!!
test_his_plot
plot(emmeans(test_his, ~ Sex*Site_Year))
plot(pairs(emmeans(test_his, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_his, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_his, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
his_tets_plot <- gather_emmeans_draws(emmeans(test_his, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("his_tets_plot.png")
ggsave("test_his_plot.png")
save(test_his, file = "histidine_simple_model.RData")

#### ile ####
hist(raw_dataf$Isoleucine)
test_ile <- brm(data=raw_dataf,
                family = student,
                bf(Isoleucine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,200), class = b),
                          prior(normal(0,200), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_ile)
pp_check(test_ile, ndraws = 100) +
  theme_bw()
summary(test_ile)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Isoleucine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           107.25     47.67    16.56   202.50 1.00    17259    27008
# sigma_Intercept                       1.76      0.93    -0.07     3.61 1.00    25238    34703
# Site_YearDauphinRiver_2018          -24.95     38.17  -100.65    49.68 1.00    15916    27550
# Site_YearMatheson_2017              -45.42     47.04  -138.97    47.88 1.00    22313    31579
# Site_YearMatheson_2018             -107.80     32.20  -171.89   -46.41 1.00    12561    20837
# Site_YearRedRiver_2017              -98.61     32.09  -161.92   -36.24 1.00    13161    22541
# Site_YearRedRiver_2018             -108.45     30.83  -169.59   -48.92 1.00    12739    21356
# Site_YearSandyBar_2017              -82.65     32.89  -147.57   -18.46 1.00    14591    25478
# Site_YearSandyBar_2018              -99.86     31.32  -162.35   -39.56 1.00    12689    21140
# Site_YearWinnipegRiver_2017        -103.02     34.35  -171.29   -36.36 1.00    13839    23503
# K                                    76.14     31.26    15.35   138.35 1.00    32534    37994
# SexM                                -26.90     10.81   -48.38    -5.94 1.00    32977    40807
# SexUN                               -16.36     14.81   -43.27    16.21 1.00    35723    28643
# sigma_Site_YearDauphinRiver_2018     -0.25      0.40    -1.02     0.55 1.00    25917    35335
# sigma_Site_YearMatheson_2017         -0.25      0.46    -1.08     0.74 1.00    33709    32343
# sigma_Site_YearMatheson_2018         -1.53      0.38    -2.29    -0.79 1.00    24604    32973
# sigma_Site_YearRedRiver_2017         -1.52      0.30    -2.11    -0.94 1.00    29081    32803
# sigma_Site_YearRedRiver_2018         -1.71      0.30    -2.30    -1.11 1.00    32228    36951
# sigma_Site_YearSandyBar_2017         -0.76      0.32    -1.42    -0.16 1.00    27042    33460
# sigma_Site_YearSandyBar_2018         -1.62      0.33    -2.26    -0.96 1.00    29464    36654
# sigma_Site_YearWinnipegRiver_2017    -2.24      0.59    -3.29    -0.97 1.00    27395    27632
# sigma_K                               2.74      0.76     1.25     4.24 1.00    28212    37460
# sigma_SexM                            0.12      0.26    -0.38     0.63 1.00    32352    39347
# sigma_SexUN                          -0.15      0.45    -1.05     0.74 1.00    31520    37658
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    16.17     12.15     3.37    48.03 1.00    31395    33960
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_ile, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   175.8     117.1     237.0
# DauphinRiver_2018   150.8     107.7     196.3
# Matheson_2017       130.6      55.7     208.8
# Matheson_2018        68.4      48.2      87.9
# RedRiver_2017        77.5      54.2     101.5
# RedRiver_2018        67.5      52.4      83.7
# SandyBar_2017        92.9      63.7     125.0
# SandyBar_2018        76.3      60.6      92.5
# WinnipegRiver_2017   73.3      41.4     104.7
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_ile, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    24.743    -51.40     98.65
# DauphinRiver_2017 - Matheson_2017        45.536    -46.16    140.33
# DauphinRiver_2017 - Matheson_2018       107.035     46.37    171.85
# DauphinRiver_2017 - RedRiver_2017        98.288     36.56    162.18
# DauphinRiver_2017 - RedRiver_2018       108.036     48.59    169.15
# DauphinRiver_2017 - SandyBar_2017        82.261     18.44    147.55
# DauphinRiver_2017 - SandyBar_2018        99.436     38.39    160.86
# DauphinRiver_2017 - WinnipegRiver_2017  102.751     35.26    170.09
# DauphinRiver_2018 - Matheson_2017        20.493    -70.04    105.86
# DauphinRiver_2018 - Matheson_2018        82.418     37.68    127.02
# DauphinRiver_2018 - RedRiver_2017        73.283     23.78    126.11
# DauphinRiver_2018 - RedRiver_2018        82.979     34.57    131.06
# DauphinRiver_2018 - SandyBar_2017        57.468      4.03    112.40
# DauphinRiver_2018 - SandyBar_2018        74.236     27.10    122.91
# DauphinRiver_2018 - WinnipegRiver_2017   77.457     23.23    133.73
# Matheson_2017 - Matheson_2018            62.039    -15.79    139.90
# Matheson_2017 - RedRiver_2017            52.884    -26.07    133.36
# Matheson_2017 - RedRiver_2018            62.874    -12.52    140.69
# Matheson_2017 - SandyBar_2017            37.084    -42.24    118.99
# Matheson_2017 - SandyBar_2018            54.245    -21.94    130.72
# Matheson_2017 - WinnipegRiver_2017       57.153    -26.22    139.23
# Matheson_2018 - RedRiver_2017            -8.910    -39.28     20.86
# Matheson_2018 - RedRiver_2018             0.852    -23.61     24.29
# Matheson_2018 - SandyBar_2017           -24.422    -60.97      8.44
# Matheson_2018 - SandyBar_2018            -8.070    -30.16     13.89
# Matheson_2018 - WinnipegRiver_2017       -5.120    -40.53     33.02
# RedRiver_2017 - RedRiver_2018             9.803    -15.77     36.10
# RedRiver_2017 - SandyBar_2017           -15.638    -51.59     19.62
# RedRiver_2017 - SandyBar_2018             1.087    -25.62     29.05
# RedRiver_2017 - WinnipegRiver_2017        4.409    -31.13     38.99
# RedRiver_2018 - SandyBar_2017           -25.286    -58.62      4.99
# RedRiver_2018 - SandyBar_2018            -8.577    -25.02      7.42
# RedRiver_2018 - WinnipegRiver_2017       -5.502    -38.22     29.54
# SandyBar_2017 - SandyBar_2018            16.719    -15.14     49.74
# SandyBar_2017 - WinnipegRiver_2017       19.832    -21.27     62.77
# SandyBar_2018 - WinnipegRiver_2017        3.162    -32.09     36.91
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_ile, ~ Site_Year))
test_ile_plot<- plot(emmeans(test_ile, ~ Site_Year)) #### That's the one!!!!!!
test_ile_plot

plot(emmeans(test_ile, ~ Sex*Site_Year))
plot(pairs(emmeans(test_ile, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_ile, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_ile, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ile_tets_plot <- gather_emmeans_draws(emmeans(test_ile, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("ile_tets_plot.png")
ggsave("test_ile_plot.png")
save(test_ile, file = "isoleucine_simple_model.RData")

model_dataframe_test_ile <- test_ile %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Intercept:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_test_ile$Site<- factor(model_dataframe_test_ile$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))
ile_draws <- model_draws(test_ile)
ile_draws

test_ile_site_year_plot <- ggplot(data = ile_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(ile_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(ile_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_ile_site_year_plot.pdf", plot = test_leu_site_year_plot, dpi = 900)
test_ile_site_year_plot

test_ile_site_year_plot2 <- ggplot(data = ile_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(ile_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(ile_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Isoleucine (uM)") +
  ylab(element_blank()) +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.80, 0.24), legend.background = element_blank())
test_ile_site_year_plot2

ggsave("test_ile_site_year_plot2.png")

test_ile_site_year_plot3 <- ggplot(data = ile_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(ile_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(ile_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Isoleucine (uM)") +
  ylab("Site of capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_ile_site_year_plot3

ggsave("test_ile_site_year_plot3.png")

test_ile_site_year_plot4 <- ggplot(data = ile_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(ile_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(ile_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Isoleucine (µM)") +
  ylab(element_blank()) +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.80, 0.24), legend.background = element_blank())
test_ile_site_year_plot4

ggsave("test_ile_site_year_plot4.png")
#### leu ####
hist(raw_dataf$Leucine)
test_leu <- brm(data=raw_dataf,
                family = student,
                bf(Leucine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,300), class = b),
                          prior(normal(0,300), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_leu)
pp_check(test_leu, ndraws = 100) +
  theme_bw()

summary(test_leu)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Leucine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           204.24     81.97    41.89   363.24 1.00    18426    29752
# sigma_Intercept                       3.07      0.94     1.24     4.93 1.00    25614    36291
# Site_YearDauphinRiver_2018         -178.40     49.99  -276.90   -79.43 1.00    15282    24545
# Site_YearMatheson_2017              -88.33     73.93  -232.98    59.15 1.00    25114    31932
# Site_YearMatheson_2018             -220.26     46.75  -312.11  -128.16 1.00    13707    21028
# Site_YearRedRiver_2017             -195.04     45.40  -283.35  -104.30 1.00    15339    23581
# Site_YearRedRiver_2018             -225.30     44.65  -312.19  -136.73 1.00    14281    21673
# Site_YearSandyBar_2017             -153.18     46.95  -243.90   -58.52 1.00    16662    25822
# Site_YearSandyBar_2018             -211.31     46.67  -302.01  -117.85 1.00    14533    22275
# Site_YearWinnipegRiver_2017        -146.82     50.57  -244.18   -46.74 1.00    15594    23361
# K                                   133.04     58.37    23.24   251.23 1.00    27126    34774
# SexM                                -46.85     20.67   -87.98    -6.60 1.00    34250    37542
# SexUN                               -28.95     15.61   -60.79     1.64 1.00    35793    35851
# sigma_Site_YearDauphinRiver_2018     -0.21      0.40    -1.03     0.56 1.00    24972    35160
# sigma_Site_YearMatheson_2017         -0.05      0.47    -0.90     0.96 1.00    33767    34599
# sigma_Site_YearMatheson_2018         -1.42      0.38    -2.16    -0.69 1.00    23732    36099
# sigma_Site_YearRedRiver_2017         -1.26      0.30    -1.86    -0.67 1.00    27650    36762
# sigma_Site_YearRedRiver_2018         -1.13      0.31    -1.75    -0.52 1.00    28271    36427
# sigma_Site_YearSandyBar_2017         -0.58      0.30    -1.18    -0.00 1.00    27222    37298
# sigma_Site_YearSandyBar_2018         -0.81      0.31    -1.42    -0.19 1.00    28601    35843
# sigma_Site_YearWinnipegRiver_2017    -2.00      0.60    -3.07    -0.71 1.00    25527    27336
# sigma_K                               1.90      0.78     0.37     3.42 1.00    28071    37950
# sigma_SexM                           -0.23      0.26    -0.75     0.29 1.00    30641    39643
# sigma_SexUN                          -0.93      0.42    -1.72    -0.07 1.00    36490    37129
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    17.74     12.71     3.75    51.22 1.00    31834    33652
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_leu, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   325.3     241.5       409
# DauphinRiver_2018   146.1     100.7       193
# Matheson_2017       235.7     115.2       366
# Matheson_2018       104.3      75.4       135
# RedRiver_2017       129.9      92.0       168
# RedRiver_2018        99.5      69.6       130
# SandyBar_2017       171.1     123.9       221
# SandyBar_2018       113.6      78.7       149
# WinnipegRiver_2017  178.5     124.1       230
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_leu, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    178.87     79.45    276.92
# DauphinRiver_2017 - Matheson_2017         88.98    -56.29    234.97
# DauphinRiver_2017 - Matheson_2018        220.20    128.16    312.11
# DauphinRiver_2017 - RedRiver_2017        195.27    107.02    285.81
# DauphinRiver_2017 - RedRiver_2018        225.90    136.36    311.81
# DauphinRiver_2017 - SandyBar_2017        153.65     60.75    245.98
# DauphinRiver_2017 - SandyBar_2018        211.91    121.23    305.06
# DauphinRiver_2017 - WinnipegRiver_2017   147.25     46.83    244.24
# DauphinRiver_2018 - Matheson_2017        -88.97   -222.27     44.25
# DauphinRiver_2018 - Matheson_2018         41.78     -2.93     87.60
# DauphinRiver_2018 - RedRiver_2017         16.37    -47.79     78.42
# DauphinRiver_2018 - RedRiver_2018         46.79    -10.66    104.58
# DauphinRiver_2018 - SandyBar_2017        -24.83    -92.53     44.79
# DauphinRiver_2018 - SandyBar_2018         32.80    -26.00     90.52
# DauphinRiver_2018 - WinnipegRiver_2017   -32.50   -102.07     43.09
# Matheson_2017 - Matheson_2018            130.90      4.57    261.50
# Matheson_2017 - RedRiver_2017            105.96    -21.79    240.96
# Matheson_2017 - RedRiver_2018            136.28     13.61    266.36
# Matheson_2017 - SandyBar_2017             64.41    -66.90    198.56
# Matheson_2017 - SandyBar_2018            122.19     -7.25    248.45
# Matheson_2017 - WinnipegRiver_2017        57.76    -79.05    197.05
# Matheson_2018 - RedRiver_2017            -25.20    -77.44     25.94
# Matheson_2018 - RedRiver_2018              5.01    -38.91     51.01
# Matheson_2018 - SandyBar_2017            -66.42   -126.04     -8.70
# Matheson_2018 - SandyBar_2018             -9.22    -52.65     37.11
# Matheson_2018 - WinnipegRiver_2017       -74.79   -134.58     -7.45
# RedRiver_2017 - RedRiver_2018             30.50    -19.09     80.87
# RedRiver_2017 - SandyBar_2017            -41.27    -99.10     16.74
# RedRiver_2017 - SandyBar_2018             16.18    -40.09     72.53
# RedRiver_2017 - WinnipegRiver_2017       -48.20   -105.40      9.72
# RedRiver_2018 - SandyBar_2017            -71.91   -128.49    -18.08
# RedRiver_2018 - SandyBar_2018            -13.84    -52.08     26.61
# RedRiver_2018 - WinnipegRiver_2017       -78.71   -140.86    -13.76
# SandyBar_2017 - SandyBar_2018             58.23     -1.92    117.47
# SandyBar_2017 - WinnipegRiver_2017        -7.08    -75.10     64.51
# SandyBar_2018 - WinnipegRiver_2017       -64.67   -132.82      2.33
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test_leu, ~ Site_Year))
test_leu_plot<- plot(emmeans(test_leu, ~ Site_Year)) #### That's the one!!!!!!
test_leu_plot
plot(emmeans(test_leu, ~ Sex*Site_Year))
plot(pairs(emmeans(test_leu, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_leu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_leu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
leu_tets_plot <- gather_emmeans_draws(emmeans(test_leu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("leu_tets_plot.png")
ggsave("test_leu_plot.png")
save(test_leu, file = "leucine_simple_model.RData")

model_dataframe_test_leu <- test_leu %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Intercept:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_test_leu$Site<- factor(model_dataframe_test_leu$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))
leu_draws <- model_draws(test_leu)
leu_draws


test_leu_site_year_plot <- ggplot(data = leu_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(leu_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(leu_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_leu_site_year_plot.pdf", plot = test_leu_site_year_plot, dpi = 900)
test_leu_site_year_plot

test_leu_site_year_plot2 <- ggplot(data = leu_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(leu_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(leu_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Leucine (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_leu_site_year_plot2
ggsave(filename = "test_leu_site_year_plot2.pdf", plot = test_leu_site_year_plot2, dpi = 900)

ggsave("test_leu_site_year_plot2.png")

test_leu_site_year_plot3 <- ggplot(data = leu_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(leu_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(leu_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Leucine (uM)") +
  ylab(element_blank()) +  
  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_leu_site_year_plot3
ggsave(filename = "test_leu_site_year_plot3.pdf", plot = test_leu_site_year_plot3, dpi = 900)

ggsave("test_leu_site_year_plot3.png")

test_leu_site_year_plot4 <- ggplot(data = leu_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(leu_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(leu_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Leucine (µM)") +
  ylab(element_blank()) +  
  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_leu_site_year_plot4
ggsave(filename = "test_leu_site_year_plot4.pdf", plot = test_leu_site_year_plot4, dpi = 900)

ggsave("test_leu_site_year_plot4.png")


  #### lys ####
hist(raw_dataf$Lysine)
test_lys <- brm(data=raw_dataf,
                family = student,
                bf(Lysine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,170), class = b),
                          prior(normal(0,170), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_lys)
pp_check(test_lys, ndraws = 100) +
  theme_bw()
summary(test_lys)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Lysine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           174.60     34.04   105.84   239.56 1.00    16980    26427
# sigma_Intercept                       2.67      1.06     0.55     4.71 1.00    22325    31667
# Site_YearDauphinRiver_2018         -204.62     24.01  -252.49  -157.59 1.00    11904    18229
# Site_YearMatheson_2017              -58.75     31.63  -120.38     5.42 1.00    16956    25260
# Site_YearMatheson_2018             -189.47     24.35  -237.87  -141.49 1.00    12140    18414
# Site_YearRedRiver_2017              -65.41     25.26  -114.76   -14.74 1.00    13784    21355
# Site_YearRedRiver_2018             -179.95     24.31  -228.36  -132.06 1.00    12306    18942
# Site_YearSandyBar_2017              -33.34     27.60   -87.30    21.91 1.00    16012    23739
# Site_YearSandyBar_2018             -179.06     24.52  -228.18  -130.80 1.00    12209    18525
# Site_YearWinnipegRiver_2017           3.84     69.52  -132.60   147.88 1.00    31541    31421
# K                                    46.00     22.67     6.83    94.68 1.00    29184    33994
# SexM                                -25.08      7.91   -41.38   -10.55 1.00    31639    22908
# SexUN                               -14.91      4.20   -23.54    -6.94 1.00    41996    37553
# sigma_Site_YearDauphinRiver_2018     -2.13      0.38    -2.86    -1.38 1.00    22251    31567
# sigma_Site_YearMatheson_2017         -0.67      0.55    -1.73     0.43 1.00    25139    31587
# sigma_Site_YearMatheson_2018         -1.52      0.41    -2.32    -0.71 1.00    21883    31629
# sigma_Site_YearRedRiver_2017         -1.08      0.32    -1.71    -0.47 1.00    25769    32911
# sigma_Site_YearRedRiver_2018         -1.41      0.31    -2.03    -0.78 1.00    25786    34368
# sigma_Site_YearSandyBar_2017         -0.42      0.31    -1.05     0.18 1.00    25033    32145
# sigma_Site_YearSandyBar_2018         -1.28      0.33    -1.93    -0.63 1.00    25243    34147
# sigma_Site_YearWinnipegRiver_2017    -0.18      0.56    -1.20     0.99 1.00    26486    23876
# sigma_K                               1.74      0.86     0.09     3.45 1.00    25279    35324
# sigma_SexM                           -0.22      0.25    -0.73     0.28 1.00    31206    37359
# sigma_SexUN                          -0.91      0.43    -1.76    -0.08 1.00    24465    22346
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    14.39     11.86     2.65    46.28 1.00    20569    18643
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test_lys, ~ Site_Year)
#Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017  211.53    164.52     258.3
# DauphinRiver_2018    7.16     -1.47      15.0
# Matheson_2017      151.05    110.45     201.3
# Matheson_2018       22.20      9.15      34.7
# RedRiver_2017      146.31    123.78     168.7
# RedRiver_2018       31.61     19.39      45.2
# SandyBar_2017      177.82    146.70     211.1
# SandyBar_2018       32.58     19.85      45.7
# WinnipegRiver_2017 214.00     83.96     354.1
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_lys, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    204.45    157.06    251.82
# DauphinRiver_2017 - Matheson_2017         59.07     -3.22    121.95
# DauphinRiver_2017 - Matheson_2018        189.36    142.15    238.43
# DauphinRiver_2017 - RedRiver_2017         65.39     16.30    116.10
# DauphinRiver_2017 - RedRiver_2018        179.81    133.71    229.83
# DauphinRiver_2017 - SandyBar_2017         33.47    -22.21     86.90
# DauphinRiver_2017 - SandyBar_2018        178.93    131.84    229.05
# DauphinRiver_2017 - WinnipegRiver_2017    -2.66   -148.34    131.78
# DauphinRiver_2018 - Matheson_2017       -144.13   -194.50   -102.27
# DauphinRiver_2018 - Matheson_2018        -15.11    -25.17     -4.77
# DauphinRiver_2018 - RedRiver_2017       -139.14   -164.96   -115.32
# DauphinRiver_2018 - RedRiver_2018        -24.46    -41.41     -8.76
# DauphinRiver_2018 - SandyBar_2017       -170.79   -204.44   -137.70
# DauphinRiver_2018 - SandyBar_2018        -25.69    -41.12     -9.83
# DauphinRiver_2018 - WinnipegRiver_2017  -206.91   -344.24    -73.35
# Matheson_2017 - Matheson_2018            129.21     85.33    178.60
# Matheson_2017 - RedRiver_2017              5.63    -41.79     58.12
# Matheson_2017 - RedRiver_2018            119.67     77.50    168.63
# Matheson_2017 - SandyBar_2017            -25.87    -82.01     27.57
# Matheson_2017 - SandyBar_2018            118.72     77.50    169.17
# Matheson_2017 - WinnipegRiver_2017       -61.30   -209.60     75.48
# Matheson_2018 - RedRiver_2017           -124.01   -151.18    -97.45
# Matheson_2018 - RedRiver_2018             -9.31    -28.50      8.41
# Matheson_2018 - SandyBar_2017           -155.72   -191.64   -123.31
# Matheson_2018 - SandyBar_2018            -10.49    -27.34      7.71
# Matheson_2018 - WinnipegRiver_2017      -191.87   -333.16    -61.80
# RedRiver_2017 - RedRiver_2018            114.53     88.61    140.65
# RedRiver_2017 - SandyBar_2017            -31.74    -70.66      5.72
# RedRiver_2017 - SandyBar_2018            113.75     86.62    139.68
# RedRiver_2017 - WinnipegRiver_2017       -67.64   -209.26     63.22
# RedRiver_2018 - SandyBar_2017           -146.23   -181.14   -112.74
# RedRiver_2018 - SandyBar_2018             -0.85    -16.30     14.66
# RedRiver_2018 - WinnipegRiver_2017      -182.27   -321.92    -50.96
# SandyBar_2017 - SandyBar_2018            145.34    112.72    181.05
# SandyBar_2017 - WinnipegRiver_2017       -35.71   -177.49     97.70
# SandyBar_2018 - WinnipegRiver_2017      -181.41   -318.50    -46.81
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_lys, ~ Site_Year))
test_lys_plot<- plot(emmeans(test_lys, ~ Site_Year)) #### That's the one!!!!!!
test_lys_plot
plot(emmeans(test_lys, ~ Sex*Site_Year))
plot(pairs(emmeans(test_lys, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_lys, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_lys, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
lys_tets_plot <- gather_emmeans_draws(emmeans(test_lys, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)

ggsave("lys_tets_plot.png")
ggsave("test_lys_plot.png")
save(test_lys, file = "lysine_simple_model.RData")


#### met ####
hist(raw_dataf$Methionine)
test_met <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Methionine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,75), class = b),
                          prior(normal(0,75), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_met)
pp_check(test_met, ndraws = 100) +
  theme_bw()
summary(test_met)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Methionine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            69.00     16.54    36.36   101.29 1.00    16481    26749
# sigma_Intercept                       2.95      0.85     1.32     4.65 1.00    21289    32672
# Site_YearDauphinRiver_2018          -59.48      9.10   -77.66   -41.76 1.00    14446    23686
# Site_YearMatheson_2017              -24.17     15.18   -51.50     8.84 1.00    22073    24353
# Site_YearMatheson_2018              -70.40      9.33   -89.10   -52.49 1.00    13189    19526
# Site_YearRedRiver_2017              -29.97      8.29   -46.45   -13.60 1.00    16672    25738
# Site_YearRedRiver_2018              -64.66      8.82   -81.37   -46.52 1.00    14563    22677
# Site_YearSandyBar_2017              -42.26      8.51   -58.98   -25.29 1.00    17234    27871
# Site_YearSandyBar_2018              -69.28      8.88   -86.00   -51.00 1.00    14142    22728
# Site_YearWinnipegRiver_2017         -47.32     15.72   -73.72   -12.79 1.00    19385    21336
# K                                    26.87     10.99     5.89    49.26 1.00    27791    36948
# SexM                                -11.78      4.67   -21.07    -2.90 1.00    27589    41164
# SexUN                                -4.26      4.27   -12.70     4.15 1.00    41713    36668
# sigma_Site_YearDauphinRiver_2018     -0.92      0.31    -1.51    -0.30 1.00    25718    36351
# sigma_Site_YearMatheson_2017          0.06      0.47    -0.78     1.09 1.00    28767    29161
# sigma_Site_YearMatheson_2018         -1.59      0.35    -2.26    -0.91 1.00    21360    33115
# sigma_Site_YearRedRiver_2017         -1.01      0.26    -1.53    -0.49 1.00    30243    37855
# sigma_Site_YearRedRiver_2018         -0.81      0.29    -1.37    -0.22 1.00    29263    38128
# sigma_Site_YearSandyBar_2017         -0.58      0.24    -1.06    -0.10 1.00    31178    35839
# sigma_Site_YearSandyBar_2018         -0.79      0.31    -1.38    -0.18 1.00    25898    36680
# sigma_Site_YearWinnipegRiver_2017    -0.97      0.54    -1.89     0.24 1.00    27800    23145
# sigma_K                               0.71      0.70    -0.67     2.09 1.00    24147    35861
# sigma_SexM                           -0.70      0.27    -1.21    -0.15 1.00    25068    35577
# sigma_SexUN                          -0.32      0.35    -0.99     0.38 1.00    41725    38113
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.60      1.95     1.49     9.13 1.00    31471    31971
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_met, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    93.0      77.1     108.6
# DauphinRiver_2018    33.5      26.1      41.4
# Matheson_2017        67.5      43.3      97.0
# Matheson_2018        22.6      16.1      29.7
# RedRiver_2017        63.0      54.3      72.2
# RedRiver_2018        28.4      20.5      36.3
# SandyBar_2017        50.6      41.2      61.1
# SandyBar_2018        23.7      16.4      31.5
# WinnipegRiver_2017   44.0      22.0      72.6
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_met, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     59.40    41.043     76.90
# DauphinRiver_2017 - Matheson_2017         25.15    -7.079     53.04
# DauphinRiver_2017 - Matheson_2018         70.27    52.641     89.24
# DauphinRiver_2017 - RedRiver_2017         29.90    13.891     46.72
# DauphinRiver_2017 - RedRiver_2018         64.93    46.864     81.65
# DauphinRiver_2017 - SandyBar_2017         42.25    25.597     59.23
# DauphinRiver_2017 - SandyBar_2018         69.56    50.871     85.83
# DauphinRiver_2017 - WinnipegRiver_2017    48.55    16.199     75.93
# DauphinRiver_2018 - Matheson_2017        -34.05   -64.879     -9.25
# DauphinRiver_2018 - Matheson_2018         10.74     2.108     20.01
# DauphinRiver_2018 - RedRiver_2017        -29.41   -41.853    -17.35
# DauphinRiver_2018 - RedRiver_2018          5.23    -6.507     16.42
# DauphinRiver_2018 - SandyBar_2017        -17.01   -30.085     -4.05
# DauphinRiver_2018 - SandyBar_2018          9.83    -1.343     20.69
# DauphinRiver_2018 - WinnipegRiver_2017   -10.68   -39.116     13.37
# Matheson_2017 - Matheson_2018             44.99    20.713     76.08
# Matheson_2017 - RedRiver_2017              4.64   -20.279     35.20
# Matheson_2017 - RedRiver_2018             39.31    15.341     70.02
# Matheson_2017 - SandyBar_2017             16.90    -8.705     47.07
# Matheson_2017 - SandyBar_2018             43.88    19.439     73.69
# Matheson_2017 - WinnipegRiver_2017        23.40   -15.258     61.46
# Matheson_2018 - RedRiver_2017            -40.35   -52.585    -28.06
# Matheson_2018 - RedRiver_2018             -5.73   -16.758      5.50
# Matheson_2018 - SandyBar_2017            -27.92   -41.406    -15.17
# Matheson_2018 - SandyBar_2018             -1.12   -11.703      9.44
# Matheson_2018 - WinnipegRiver_2017       -21.63   -50.893      1.15
# RedRiver_2017 - RedRiver_2018             34.88    22.867     45.94
# RedRiver_2017 - SandyBar_2017             12.40     0.611     24.46
# RedRiver_2017 - SandyBar_2018             39.49    27.450     50.65
# RedRiver_2017 - WinnipegRiver_2017        18.94   -11.494     41.39
# RedRiver_2018 - SandyBar_2017            -22.58   -34.434    -10.24
# RedRiver_2018 - SandyBar_2018              4.59    -3.124     12.81
# RedRiver_2018 - WinnipegRiver_2017       -15.82   -44.376      8.77
# SandyBar_2017 - SandyBar_2018             27.22    14.943     39.04
# SandyBar_2017 - WinnipegRiver_2017         6.48   -23.256     31.06
# SandyBar_2018 - WinnipegRiver_2017       -20.42   -49.999      2.96
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_met, ~ Site_Year))
test_met_plot<- plot(emmeans(test_met, ~ Site_Year)) #### That's the one!!!!!!
tests_met_plot
plot(emmeans(test_met, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_met, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_met, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
met_tets_plot <- gather_emmeans_draws(emmeans(test_met, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("met_tets_plot.png")
ggsave("test_met_plot.png")
save(test_met, file = "methaionine_simple_model.RData")


#### phe ####
hist(raw_dataf$Phenylalanine)
test_phe <- brm(data=raw_dataf,
                family = student,
                bf(Phenylalanine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,75), class = b),
                          prior(normal(0,75), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_phe)
pp_check(test_phe, ndraws = 100) +
  theme_bw()
summary(test_phe)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Phenylalanine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            84.99     29.24    31.32   145.03 1.00     7721     4085
# sigma_Intercept                       2.68      0.86     1.01     4.39 1.00    16614    22394
# Site_YearDauphinRiver_2018          -33.81     15.04   -63.13    -3.94 1.00     9712    14211
# Site_YearMatheson_2017              -34.87     17.76   -69.23     1.02 1.00    11954    20614
# Site_YearMatheson_2018              -66.76     14.97   -96.26   -37.25 1.00     9290    11221
# Site_YearRedRiver_2017              -39.47     15.52   -69.20    -7.94 1.00    10372    12897
# Site_YearRedRiver_2018              -42.91     15.59   -73.03   -11.79 1.00    11301    14366
# Site_YearSandyBar_2017              -37.64     15.76   -68.01    -6.05 1.00    12308    18274
# Site_YearSandyBar_2018              -58.53     14.64   -86.94   -29.15 1.00     9729    13340
# Site_YearWinnipegRiver_2017         -44.43     15.88   -75.29   -12.97 1.00    10348    13996
# K                                    33.82     22.70   -12.36    74.12 1.00     7291     2668
# SexM                                -21.17      7.40   -35.92    -6.68 1.00    19159    17627
# SexUN                                -8.13      4.94   -18.50     1.36 1.00    12106     3975
# sigma_Site_YearDauphinRiver_2018     -0.96      0.40    -1.74    -0.15 1.00    15769    18624
# sigma_Site_YearMatheson_2017         -0.84      0.46    -1.66     0.17 1.00    25564    23115
# sigma_Site_YearMatheson_2018         -1.63      0.37    -2.35    -0.91 1.00    17120    26058
# sigma_Site_YearRedRiver_2017         -1.08      0.30    -1.69    -0.50 1.00    15511    14396
# sigma_Site_YearRedRiver_2018         -0.77      0.30    -1.36    -0.17 1.00    18012    24985
# sigma_Site_YearSandyBar_2017         -0.56      0.30    -1.15     0.02 1.00    17264    18830
# sigma_Site_YearSandyBar_2018         -1.22      0.32    -1.86    -0.59 1.00    17921    19448
# sigma_Site_YearWinnipegRiver_2017    -2.37      0.88    -4.37    -0.78 1.00     4821     1901
# sigma_K                               1.27      0.69    -0.10     2.62 1.00    20027    31920
# sigma_SexM                           -0.08      0.24    -0.56     0.39 1.00    17793    18893
# sigma_SexUN                          -0.66      0.44    -1.52     0.20 1.00    14918     4671
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    21.41     13.55     5.09    56.04 1.00    23469    23799
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_phe, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   112.5      85.2     140.3
# DauphinRiver_2018    78.5      67.8      89.3
# Matheson_2017        77.3      54.1     100.6
# Matheson_2018        45.9      33.7      56.4
# RedRiver_2017        72.7      57.7      87.6
# RedRiver_2018        69.2      55.0      84.8
# SandyBar_2017        74.6      57.1      91.1
# SandyBar_2018        53.8      44.9      62.7
# WinnipegRiver_2017   68.3      52.5      81.3
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_phe, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     33.89     3.503     62.62
# DauphinRiver_2017 - Matheson_2017         35.14     0.800     70.63
# DauphinRiver_2017 - Matheson_2018         66.77    38.043     96.87
# DauphinRiver_2017 - RedRiver_2017         39.76     9.393     70.60
# DauphinRiver_2017 - RedRiver_2018         43.08    12.393     73.47
# DauphinRiver_2017 - SandyBar_2017         37.85     6.094     68.05
# DauphinRiver_2017 - SandyBar_2018         58.64    29.311     87.03
# DauphinRiver_2017 - WinnipegRiver_2017    44.51    12.811     75.12
# DauphinRiver_2018 - Matheson_2017          1.26   -24.694     26.05
# DauphinRiver_2018 - Matheson_2018         32.64    21.929     44.45
# DauphinRiver_2018 - RedRiver_2017          5.76   -14.343     25.83
# DauphinRiver_2018 - RedRiver_2018          9.23   -10.120     27.88
# DauphinRiver_2018 - SandyBar_2017          3.90   -17.303     24.24
# DauphinRiver_2018 - SandyBar_2018         24.66    11.155     38.58
# DauphinRiver_2018 - WinnipegRiver_2017    10.31    -8.519     30.85
# Matheson_2017 - Matheson_2018             31.63     7.508     57.39
# Matheson_2017 - RedRiver_2017              4.67   -23.942     31.67
# Matheson_2017 - RedRiver_2018              8.02   -18.488     34.56
# Matheson_2017 - SandyBar_2017              2.68   -25.697     31.21
# Matheson_2017 - SandyBar_2018             23.51    -0.504     47.67
# Matheson_2017 - WinnipegRiver_2017         9.37   -17.978     38.35
# Matheson_2018 - RedRiver_2017            -26.95   -48.145     -7.50
# Matheson_2018 - RedRiver_2018            -23.67   -43.169     -4.75
# Matheson_2018 - SandyBar_2017            -28.90   -49.995     -9.10
# Matheson_2018 - SandyBar_2018             -8.15   -22.168      5.75
# Matheson_2018 - WinnipegRiver_2017       -22.57   -42.078     -2.92
# RedRiver_2017 - RedRiver_2018              3.42   -18.397     25.41
# RedRiver_2017 - SandyBar_2017             -1.81   -22.687     19.49
# RedRiver_2017 - SandyBar_2018             18.89     0.341     37.50
# RedRiver_2017 - WinnipegRiver_2017         4.94   -12.229     22.73
# RedRiver_2018 - SandyBar_2017             -5.38   -27.441     17.57
# RedRiver_2018 - SandyBar_2018             15.45    -0.243     31.30
# RedRiver_2018 - WinnipegRiver_2017         1.27   -20.582     23.59
# SandyBar_2017 - SandyBar_2018             20.90     1.451     40.47
# SandyBar_2017 - WinnipegRiver_2017         6.54   -14.398     28.38
# SandyBar_2018 - WinnipegRiver_2017       -14.32   -31.980      4.78
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_phe, ~ Site_Year))
test_phe_plot<- plot(emmeans(test_phe, ~ Site_Year)) #### That's the one!!!!!!
tests_phe_plot
plot(emmeans(test_phe, ~ Sex*Site_Year))
plot(pairs(emmeans(test_phe, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_phe, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_phe, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
phe_test_plot <- gather_emmeans_draws(emmeans(test_phe, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("phe_tets_plot.png")
ggsave("test_phe_plot.png")
save(test_phe, file = "phenylalanine_simple_model.RData")


#### pro ####
hist(raw_dataf$Proline)
test_pro <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Proline ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,150), class = b),
                          prior(normal(0,150), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_pro)
pp_check(test_pro, ndraws = 100) +
  theme_bw()
summary(test_pro)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Proline ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            78.41     35.34    11.59   151.29 1.00    13344    19140
# sigma_Intercept                       2.01      0.85     0.35     3.71 1.00    16892    25470
# Site_YearDauphinRiver_2018          -20.88     27.84   -79.30    30.14 1.00    12576    18515
# Site_YearMatheson_2017              -25.35     43.49  -103.96    70.59 1.00    23608    24996
# Site_YearMatheson_2018              -99.37     22.27  -146.51   -58.51 1.00    10710    15196
# Site_YearRedRiver_2017              -56.85     20.78   -99.54   -17.38 1.00    12260    17589
# Site_YearRedRiver_2018             -107.77     19.71  -149.01   -70.90 1.00    11191    15738
# Site_YearSandyBar_2017              -59.29     21.50  -103.01   -17.93 1.00    12949    18133
# Site_YearSandyBar_2018             -101.30     20.63  -144.66   -62.59 1.00    11173    15947
# Site_YearWinnipegRiver_2017         -22.12     21.40   -65.54    18.97 1.00    12236    17315
# K                                    73.05     22.98    29.42   120.00 1.00    25825    34388
# SexM                                -15.74      7.09   -30.03    -1.76 1.00    24825    35168
# SexUN                                 9.07     20.72   -29.78    53.21 1.00    35155    30467
# sigma_Site_YearDauphinRiver_2018     -0.47      0.31    -1.08     0.14 1.00    18959    29265
# sigma_Site_YearMatheson_2017          0.18      0.45    -0.61     1.16 1.00    26970    27567
# sigma_Site_YearMatheson_2018         -1.09      0.36    -1.81    -0.39 1.00    16641    27089
# sigma_Site_YearRedRiver_2017         -1.25      0.28    -1.81    -0.70 1.00    21411    30797
# sigma_Site_YearRedRiver_2018         -1.82      0.30    -2.40    -1.23 1.00    24301    33209
# sigma_Site_YearSandyBar_2017         -0.72      0.27    -1.26    -0.19 1.00    20766    30201
# sigma_Site_YearSandyBar_2018         -1.25      0.29    -1.81    -0.67 1.00    20364    31478
# sigma_Site_YearWinnipegRiver_2017    -2.39      0.55    -3.34    -1.15 1.00    25988    25559
# sigma_K                               2.27      0.69     0.91     3.62 1.00    20574    30789
# sigma_SexM                            0.01      0.24    -0.47     0.47 1.00    21368    30683
# sigma_SexUN                           0.48      0.32    -0.11     1.15 1.00    35084    35741
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.03      1.51     1.78     7.71 1.00    28804    24722
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_pro, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   155.2     116.6     200.2
# DauphinRiver_2018   135.0     102.6     169.5
# Matheson_2017       126.7      55.6     217.4
# Matheson_2018        56.6      38.5      76.7
# RedRiver_2017        99.0      78.2     120.7
# RedRiver_2018        48.2      33.3      65.0
# SandyBar_2017        96.4      72.9     121.7
# SandyBar_2018        54.4      37.7      73.2
# WinnipegRiver_2017  133.4     111.7     158.0
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_pro, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     19.49   -31.486     77.62
# DauphinRiver_2017 - Matheson_2017         28.27   -64.893    108.65
# DauphinRiver_2017 - Matheson_2018         98.15    56.820    144.30
# DauphinRiver_2017 - RedRiver_2017         56.21    16.604     98.60
# DauphinRiver_2017 - RedRiver_2018        106.81    71.155    149.15
# DauphinRiver_2017 - SandyBar_2017         58.78    17.785    102.80
# DauphinRiver_2017 - SandyBar_2018        100.42    61.672    143.54
# DauphinRiver_2017 - WinnipegRiver_2017    21.64   -19.350     65.02
# DauphinRiver_2018 - Matheson_2017          7.99   -86.636     85.97
# DauphinRiver_2018 - Matheson_2018         78.39    45.396    111.31
# DauphinRiver_2018 - RedRiver_2017         36.01    -2.871     74.07
# DauphinRiver_2018 - RedRiver_2018         86.88    51.049    121.40
# DauphinRiver_2018 - SandyBar_2017         38.56    -1.306     77.62
# DauphinRiver_2018 - SandyBar_2018         80.26    45.632    115.55
# DauphinRiver_2018 - WinnipegRiver_2017     1.60   -37.838     41.70
# Matheson_2017 - Matheson_2018             69.98     0.679    163.08
# Matheson_2017 - RedRiver_2017             27.62   -42.477    119.97
# Matheson_2017 - RedRiver_2018             78.21     7.033    166.59
# Matheson_2017 - SandyBar_2017             30.08   -44.007    119.34
# Matheson_2017 - SandyBar_2018             71.89     1.753    162.59
# Matheson_2017 - WinnipegRiver_2017        -6.99   -79.213     85.78
# Matheson_2018 - RedRiver_2017            -42.46   -67.639    -18.70
# Matheson_2018 - RedRiver_2018              8.26    -9.598     27.41
# Matheson_2018 - SandyBar_2017            -39.77   -66.282    -13.78
# Matheson_2018 - SandyBar_2018              1.80   -17.448     21.14
# Matheson_2018 - WinnipegRiver_2017       -77.02  -104.374    -50.33
# RedRiver_2017 - RedRiver_2018             50.75    32.120     69.20
# RedRiver_2017 - SandyBar_2017              2.66   -23.480     27.14
# RedRiver_2017 - SandyBar_2018             44.36    24.020     65.46
# RedRiver_2017 - WinnipegRiver_2017       -34.42   -57.827    -11.21
# RedRiver_2018 - SandyBar_2017            -48.01   -70.934    -27.70
# RedRiver_2018 - SandyBar_2018             -6.19   -20.283      6.63
# RedRiver_2018 - WinnipegRiver_2017       -85.24  -106.325    -64.43
# SandyBar_2017 - SandyBar_2018             41.73    18.707     65.50
# SandyBar_2017 - WinnipegRiver_2017       -37.10   -63.088     -9.40
# SandyBar_2018 - WinnipegRiver_2017       -78.91  -101.977    -56.01
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95
plot(emmeans(test_pro, ~ Site_Year))
test_pro_plot<- plot(emmeans(test_pro, ~ Site_Year)) #### That's the one!!!!!!
test_pro_plot
plot(emmeans(test_pro, ~ Sex*Site_Year))
plot(pairs(emmeans(test_pro, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_pro, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_pro, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
pro_tets_plot <- gather_emmeans_draws(emmeans(test_pro, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("pro_tets_plot.png")
ggsave("test_pro_plot.png")
save(test_pro, file = "proline_simple_model.RData")


?save
#### ser ####
hist(raw_dataf$Serine)
test_ser <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Serine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,150), class = b),
                          prior(normal(0,150), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_ser)
pp_check(test_ser, ndraws = 100) +
  theme_bw()
summary(test_ser)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Serine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           -20.39     30.85   -79.35    42.13 1.00    32003    36164
# sigma_Intercept                       1.64      0.76     0.20     3.19 1.00    30942    37768
# Site_YearDauphinRiver_2018           -0.43     11.11   -23.22    20.97 1.00    25245    31667
# Site_YearMatheson_2017               22.12     23.35   -19.41    72.89 1.00    32890    30531
# Site_YearMatheson_2018                0.59     10.75   -21.25    21.30 1.00    22151    26053
# Site_YearRedRiver_2017               24.64     11.70     1.82    48.46 1.00    33410    38621
# Site_YearRedRiver_2018               18.24     13.17    -4.91    47.27 1.00    31432    33005
# Site_YearSandyBar_2017               13.80     12.03    -9.47    38.25 1.00    33062    36065
# Site_YearSandyBar_2018               -6.35     14.13   -31.43    24.12 1.00    28475    32174
# Site_YearWinnipegRiver_2017         -45.87     24.31   -85.63     9.88 1.00    28455    21490
# K                                   117.82     27.18    63.43   169.94 1.00    36685    38394
# SexM                                -16.08      9.17   -36.00     0.44 1.00    33385    32305
# SexUN                               -17.07     11.25   -37.82     6.39 1.00    43902    33526
# sigma_Site_YearDauphinRiver_2018      0.16      0.34    -0.50     0.84 1.00    24552    33955
# sigma_Site_YearMatheson_2017          0.59      0.42    -0.18     1.49 1.00    30158    33224
# sigma_Site_YearMatheson_2018         -0.08      0.34    -0.74     0.59 1.00    22747    32861
# sigma_Site_YearRedRiver_2017          0.27      0.26    -0.25     0.79 1.00    25438    35091
# sigma_Site_YearRedRiver_2018          0.52      0.31    -0.10     1.11 1.00    25471    31112
# sigma_Site_YearSandyBar_2017          0.41      0.25    -0.09     0.90 1.00    25654    32702
# sigma_Site_YearSandyBar_2018          0.61      0.31    -0.00     1.20 1.00    23615    33026
# sigma_Site_YearWinnipegRiver_2017    -0.20      0.53    -1.11     0.97 1.00    26456    25338
# sigma_K                               1.56      0.62     0.32     2.75 1.00    38860    43501
# sigma_SexM                           -0.25      0.26    -0.72     0.28 1.00    32948    38412
# sigma_SexUN                          -0.14      0.35    -0.81     0.58 1.00    43724    35423
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.62      2.14     2.38    10.63 1.00    37669    33552
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_ser, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    97.2     83.12       112
# DauphinRiver_2018    97.0     81.45       114
# Matheson_2017       118.1     77.37       166
# Matheson_2018        98.1     82.18       114
# RedRiver_2017       121.9    101.66       144
# RedRiver_2018       114.9     93.61       140
# SandyBar_2017       111.0     89.20       134
# SandyBar_2018        90.4     67.59       117
# WinnipegRiver_2017   49.0      9.72       100
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_ser, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     0.178    -21.22     22.83
# DauphinRiver_2017 - Matheson_2017       -20.750    -69.34     21.70
# DauphinRiver_2017 - Matheson_2018        -0.782    -20.84     21.64
# DauphinRiver_2017 - RedRiver_2017       -24.428    -47.58     -1.08
# DauphinRiver_2017 - RedRiver_2018       -17.256    -45.50      6.10
# DauphinRiver_2017 - SandyBar_2017       -13.630    -37.22     10.49
# DauphinRiver_2017 - SandyBar_2018         7.379    -21.63     33.30
# DauphinRiver_2017 - WinnipegRiver_2017   48.312     -4.22     89.29
# DauphinRiver_2018 - Matheson_2017       -21.159    -70.81     23.57
# DauphinRiver_2018 - Matheson_2018        -1.066    -20.50     18.72
# DauphinRiver_2018 - RedRiver_2017       -24.719    -51.44      1.62
# DauphinRiver_2018 - RedRiver_2018       -17.762    -50.00      8.79
# DauphinRiver_2018 - SandyBar_2017       -13.919    -41.98     12.48
# DauphinRiver_2018 - SandyBar_2018         6.777    -24.01     35.69
# DauphinRiver_2018 - WinnipegRiver_2017   47.804     -4.82     90.79
# Matheson_2017 - Matheson_2018            19.884    -21.31     70.61
# Matheson_2017 - RedRiver_2017            -3.737    -51.96     46.79
# Matheson_2017 - RedRiver_2018             3.923    -49.26     55.28
# Matheson_2017 - SandyBar_2017             6.650    -36.93     57.02
# Matheson_2017 - SandyBar_2018            28.122    -24.25     80.58
# Matheson_2017 - WinnipegRiver_2017       67.944      4.46    136.21
# Matheson_2018 - RedRiver_2017           -23.789    -50.48      1.57
# Matheson_2018 - RedRiver_2018           -16.762    -47.23      9.95
# Matheson_2018 - SandyBar_2017           -12.803    -40.01     12.95
# Matheson_2018 - SandyBar_2018             7.727    -22.55     34.72
# Matheson_2018 - WinnipegRiver_2017       48.545     -3.54     92.23
# RedRiver_2017 - RedRiver_2018             7.009    -24.74     36.09
# RedRiver_2017 - SandyBar_2017            10.764    -17.21     40.15
# RedRiver_2017 - SandyBar_2018            31.745     -1.89     62.39
# RedRiver_2017 - WinnipegRiver_2017       72.794     19.45    117.07
# RedRiver_2018 - SandyBar_2017             3.670    -27.92     38.90
# RedRiver_2018 - SandyBar_2018            24.722     -3.59     52.00
# RedRiver_2018 - WinnipegRiver_2017       65.964     12.48    114.96
# SandyBar_2017 - SandyBar_2018            20.780    -15.32     54.46
# SandyBar_2017 - WinnipegRiver_2017       61.683      8.90    107.87
# SandyBar_2018 - WinnipegRiver_2017       41.154    -13.40     90.52
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95
plot(emmeans(test_ser, ~ Site_Year))
test_ser_plot<- plot(emmeans(test_ser, ~ Site_Year)) #### That's the one!!!!!!
test_ser_plot
plot(emmeans(test_ser, ~ Sex*Site_Year))
plot(pairs(emmeans(test_ser, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_ser, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_ser, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ser_tets_plot <- gather_emmeans_draws(emmeans(test_ser, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("ser_tets_plot.png")
ggsave("test_ser_plot.png")

save(test_ser, file = "serine_simple_model.RData")
#### thr ####
hist(raw_dataf$Threonine)
test_thr <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Threonine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,150), class = b),
                          prior(normal(0,540), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_thr)
pp_check(test_thr, ndraws = 100) +
  theme_bw()
summary(test_thr)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Threonine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           104.13     37.23    31.46   178.15 1.00    30829    37955
# sigma_Intercept                       2.92      0.80     1.35     4.48 1.00    31800    39795
# Site_YearDauphinRiver_2018          -45.13     21.36   -86.45    -2.29 1.00    22735    30829
# Site_YearMatheson_2017               10.49     49.60   -75.29   120.77 1.00    36823    29348
# Site_YearMatheson_2018              -37.51     19.75   -76.72     1.29 1.00    21895    29329
# Site_YearRedRiver_2017              -27.68     14.79   -58.26     0.17 1.00    20780    24788
# Site_YearRedRiver_2018              -67.36     20.89  -106.79   -24.88 1.00    23797    33936
# Site_YearSandyBar_2017              -38.27     17.15   -72.28    -4.30 1.00    24711    29126
# Site_YearSandyBar_2018              -92.44     15.83  -124.67   -62.08 1.00    20326    25794
# Site_YearWinnipegRiver_2017         -49.79     51.56  -135.76    72.65 1.00    30482    26126
# K                                    79.52     29.93    21.44   139.32 1.00    42532    43858
# SexM                                -29.85     10.78   -50.99    -8.70 1.00    39685    44304
# SexUN                               -32.88     17.27   -64.45     3.98 1.00    39000    33497
# sigma_Site_YearDauphinRiver_2018      0.19      0.35    -0.49     0.90 1.00    26491    37361
# sigma_Site_YearMatheson_2017          0.69      0.42    -0.07     1.59 1.00    32965    35101
# sigma_Site_YearMatheson_2018          0.03      0.32    -0.62     0.67 1.00    25365    34441
# sigma_Site_YearRedRiver_2017         -0.83      0.27    -1.36    -0.29 1.00    30573    37955
# sigma_Site_YearRedRiver_2018          0.02      0.29    -0.54     0.61 1.00    28984    36583
# sigma_Site_YearSandyBar_2017         -0.15      0.26    -0.65     0.35 1.00    29311    36400
# sigma_Site_YearSandyBar_2018         -0.58      0.32    -1.20     0.06 1.00    30537    37086
# sigma_Site_YearWinnipegRiver_2017     0.25      0.52    -0.64     1.37 1.00    30777    30859
# sigma_K                               0.99      0.67    -0.31     2.32 1.00    36260    41983
# sigma_SexM                           -0.09      0.25    -0.57     0.40 1.00    37184    44909
# sigma_SexUN                          -0.35      0.37    -1.07     0.41 1.00    42175    39502
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.72      1.77     1.86     8.71 1.00    39773    33916
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_thr, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   169.8     143.2     200.3
# DauphinRiver_2018   124.2      97.6     153.9
# Matheson_2017       176.4      90.3     284.4
# Matheson_2018       132.2     105.2     161.6
# RedRiver_2017       142.4     124.2     162.3
# RedRiver_2018       101.9      73.3     134.2
# SandyBar_2017       131.3     105.3     160.6
# SandyBar_2018        77.2      61.2      96.6
# WinnipegRiver_2017  113.8      31.3     233.3
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_thr, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    45.361     2.853      86.9
# DauphinRiver_2017 - Matheson_2017        -6.165  -116.343      78.5
# DauphinRiver_2017 - Matheson_2018        37.392    -0.656      77.2
# DauphinRiver_2017 - RedRiver_2017        27.169    -1.296      56.9
# DauphinRiver_2017 - RedRiver_2018        68.020    26.314     108.1
# DauphinRiver_2017 - SandyBar_2017        38.209     5.059      72.9
# DauphinRiver_2017 - SandyBar_2018        92.176    61.755     124.1
# DauphinRiver_2017 - WinnipegRiver_2017   55.906   -60.392     144.7
# DauphinRiver_2018 - Matheson_2017       -51.736  -166.167      38.4
# DauphinRiver_2018 - Matheson_2018        -7.956   -45.079      30.1
# DauphinRiver_2018 - RedRiver_2017       -18.322   -52.585      20.1
# DauphinRiver_2018 - RedRiver_2018        22.062   -19.803      65.2
# DauphinRiver_2018 - SandyBar_2017        -7.061   -48.111      35.4
# DauphinRiver_2018 - SandyBar_2018        46.594    14.221      81.4
# DauphinRiver_2018 - WinnipegRiver_2017   10.453  -112.382      99.6
# Matheson_2017 - Matheson_2018            43.838   -43.112     156.7
# Matheson_2017 - RedRiver_2017            33.826   -51.464     142.8
# Matheson_2017 - RedRiver_2018            74.643   -21.593     185.3
# Matheson_2017 - SandyBar_2017            44.507   -43.058     151.3
# Matheson_2017 - SandyBar_2018            98.674    11.447     206.8
# Matheson_2017 - WinnipegRiver_2017       61.289   -85.109     200.2
# Matheson_2018 - RedRiver_2017           -10.253   -43.108      23.8
# Matheson_2018 - RedRiver_2018            30.072   -12.395      70.3
# Matheson_2018 - SandyBar_2017             0.816   -36.692      39.0
# Matheson_2018 - SandyBar_2018            54.534    23.612      86.2
# Matheson_2018 - WinnipegRiver_2017       18.151  -100.858     109.1
# RedRiver_2017 - RedRiver_2018            40.593     5.570      71.5
# RedRiver_2017 - SandyBar_2017            11.065   -17.284      37.9
# RedRiver_2017 - SandyBar_2018            64.821    41.940      87.7
# RedRiver_2017 - WinnipegRiver_2017       28.727   -87.863     112.8
# RedRiver_2018 - SandyBar_2017           -29.506   -71.024      11.9
# RedRiver_2018 - SandyBar_2018            24.265    -5.713      58.7
# RedRiver_2018 - WinnipegRiver_2017      -11.752  -131.120      78.0
# SandyBar_2017 - SandyBar_2018            53.640    24.199      84.8
# SandyBar_2017 - WinnipegRiver_2017       17.598  -101.830     103.5
# SandyBar_2018 - WinnipegRiver_2017      -36.048  -154.048      49.3
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_thr, ~ Site_Year))
test_thr_plot<- plot(emmeans(test_thr, ~ Site_Year)) #### That's the one!!!!!!
test_thr_plot
plot(emmeans(test_thr, ~ Sex*Site_Year))
plot(pairs(emmeans(test_thr, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_thr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_thr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
thr_tets_plot <- gather_emmeans_draws(emmeans(test_ser, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("thr_tets_plot.png")
ggsave("test_thr_plot.png")

save(test_thr, file = "threonine_simple_model.RData")
#### trp ####
hist(raw_dataf$Tryptophan)
test_trp <- brm(data=raw_dataf,
                family = skew_normal,
                bf(Tryptophan ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,25), class = b),
                          prior(normal(0,25), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_trp)
pp_check(test_trp, ndraws = 100) +
  theme_bw()
summary(test_trp)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Tryptophan ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            12.61      6.36     0.29    25.29 1.00    22734    32545
# sigma_Intercept                       1.70      0.79     0.15     3.26 1.00    26505    34817
# Site_YearDauphinRiver_2018            3.60      4.05    -4.42    11.56 1.00    21916    32119
# Site_YearMatheson_2017               -5.70      5.33   -15.53     5.56 1.00    27073    27870
# Site_YearMatheson_2018              -11.65      3.13   -18.06    -5.71 1.00    16812    23098
# Site_YearRedRiver_2017              -10.26      3.13   -16.48    -4.15 1.00    19622    28822
# Site_YearRedRiver_2018               -9.68      2.96   -15.64    -3.96 1.00    19021    27036
# Site_YearSandyBar_2017              -10.04      2.96   -15.97    -4.30 1.00    20271    28466
# Site_YearSandyBar_2018              -14.22      2.85   -19.97    -8.74 1.00    17873    25443
# Site_YearWinnipegRiver_2017          -8.85      4.29   -16.63     0.02 1.00    22855    25459
# K                                    14.24      4.75     5.02    23.72 1.00    34661    38843
# SexM                                 -1.59      1.59    -4.74     1.53 1.00    41360    43232
# SexUN                                -2.78      2.33    -7.17     2.14 1.00    40845    34360
# sigma_Site_YearDauphinRiver_2018      0.12      0.35    -0.54     0.83 1.00    25900    37344
# sigma_Site_YearMatheson_2017         -0.07      0.45    -0.86     0.92 1.00    31463    30099
# sigma_Site_YearMatheson_2018         -0.90      0.32    -1.52    -0.27 1.00    24778    35307
# sigma_Site_YearRedRiver_2017         -0.65      0.28    -1.21    -0.10 1.00    28647    38187
# sigma_Site_YearRedRiver_2018         -0.63      0.28    -1.16    -0.08 1.00    31268    39561
# sigma_Site_YearSandyBar_2017         -0.46      0.26    -0.98     0.05 1.00    30706    37507
# sigma_Site_YearSandyBar_2018         -0.82      0.28    -1.37    -0.27 1.00    29395    37653
# sigma_Site_YearWinnipegRiver_2017    -0.89      0.54    -1.80     0.31 1.00    28933    25835
# sigma_K                               0.61      0.66    -0.68     1.90 1.00    32134    39483
# sigma_SexM                           -0.10      0.20    -0.48     0.30 1.00    36486    42280
# sigma_SexUN                          -0.19      0.37    -0.91     0.57 1.00    40359    39287
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     1.99      1.33    -0.69     4.79 1.00    33349    34152
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_trp, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    26.7     21.61      32.3
# DauphinRiver_2018    30.3     24.85      36.2
# Matheson_2017        20.7     11.71      30.8
# Matheson_2018        15.1     12.13      18.2
# RedRiver_2017        16.5     12.86      20.1
# RedRiver_2018        17.0     13.88      20.5
# SandyBar_2017        16.7     13.28      20.2
# SandyBar_2018        12.5      9.86      15.3
# WinnipegRiver_2017   17.7     11.48      25.3
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_trp, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    -3.644   -11.568      4.40
# DauphinRiver_2017 - Matheson_2017         5.935    -4.807     16.10
# DauphinRiver_2017 - Matheson_2018        11.571     5.640     17.94
# DauphinRiver_2017 - RedRiver_2017        10.229     4.002     16.32
# DauphinRiver_2017 - RedRiver_2018         9.638     4.013     15.68
# DauphinRiver_2017 - SandyBar_2017         9.996     4.214     15.85
# DauphinRiver_2017 - SandyBar_2018        14.169     8.687     19.90
# DauphinRiver_2017 - WinnipegRiver_2017    9.017     0.641     17.15
# DauphinRiver_2018 - Matheson_2017         9.543    -1.904     20.34
# DauphinRiver_2018 - Matheson_2018        15.163     9.294     21.19
# DauphinRiver_2018 - RedRiver_2017        13.777     7.116     20.80
# DauphinRiver_2018 - RedRiver_2018        13.222     6.627     19.92
# DauphinRiver_2018 - SandyBar_2017        13.590     6.944     20.42
# DauphinRiver_2018 - SandyBar_2018        17.751    11.559     24.21
# DauphinRiver_2018 - WinnipegRiver_2017   12.548     3.654     21.96
# Matheson_2017 - Matheson_2018             5.594    -3.625     15.98
# Matheson_2017 - RedRiver_2017             4.249    -5.575     14.54
# Matheson_2017 - RedRiver_2018             3.654    -5.457     14.04
# Matheson_2017 - SandyBar_2017             4.022    -5.380     14.43
# Matheson_2017 - SandyBar_2018             8.169    -0.608     18.72
# Matheson_2017 - WinnipegRiver_2017        3.058    -8.856     14.92
# Matheson_2018 - RedRiver_2017            -1.395    -5.968      3.22
# Matheson_2018 - RedRiver_2018            -1.974    -6.219      2.34
# Matheson_2018 - SandyBar_2017            -1.582    -6.045      2.81
# Matheson_2018 - SandyBar_2018             2.587    -1.249      6.32
# Matheson_2018 - WinnipegRiver_2017       -2.616   -10.547      4.63
# RedRiver_2017 - RedRiver_2018            -0.564    -5.092      3.81
# RedRiver_2017 - SandyBar_2017            -0.205    -4.663      4.17
# RedRiver_2017 - SandyBar_2018             3.974    -0.160      8.12
# RedRiver_2017 - WinnipegRiver_2017       -1.191    -8.789      5.59
# RedRiver_2018 - SandyBar_2017             0.369    -4.070      4.55
# RedRiver_2018 - SandyBar_2018             4.515     0.820      8.11
# RedRiver_2018 - WinnipegRiver_2017       -0.608    -8.582      6.13
# SandyBar_2017 - SandyBar_2018             4.169     0.205      8.18
# SandyBar_2017 - WinnipegRiver_2017       -0.977    -8.677      5.77
# SandyBar_2018 - WinnipegRiver_2017       -5.145   -12.758      1.57
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_trp, ~ Site_Year))
test_trp_plot<- plot(emmeans(test_trp, ~ Site_Year)) #### That's the one!!!!!!
test_trp_plot
plot(emmeans(test_trp, ~ Sex*Site_Year))
plot(pairs(emmeans(test_trp, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_trp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_trp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
trp_tets_plot <- gather_emmeans_draws(emmeans(test_trp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("trp_tets_plot.png")
ggsave("test_trp_plot.png")
ggsave(test_trp.rda)
save(test_trp, file = "tryptophan_simple_model.RData")



#### tyr ####
hist(raw_dataf$Tyrosine)
test_tyr <- brm(data=raw_dataf,
                family = student,
                bf(Tyrosine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,100), class = b),
                          prior(normal(0,100), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_tyr)
pp_check(test_tyr, ndraws = 100) +
  theme_bw()
summary(test_tyr)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Tyrosine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            74.74     23.93    29.64   123.41 1.00    25321    34024
# sigma_Intercept                       2.54      1.04     0.53     4.58 1.00    30820    40550
# Site_YearDauphinRiver_2018          -34.12     14.73   -63.68    -5.52 1.00    19723    27910
# Site_YearMatheson_2017              -12.53     26.94   -63.84    41.04 1.00    34615    33911
# Site_YearMatheson_2018              -62.46     12.70   -88.77   -38.53 1.00    16827    22724
# Site_YearRedRiver_2017              -22.17     12.85   -48.19     2.37 1.00    18782    26741
# Site_YearRedRiver_2018              -43.46     14.23   -71.91   -15.80 1.00    20878    30490
# Site_YearSandyBar_2017              -33.83     12.74   -59.87    -9.73 1.00    18327    25666
# Site_YearSandyBar_2018              -63.27     12.41   -88.77   -39.77 1.00    16949    22979
# Site_YearWinnipegRiver_2017         -45.75     15.42   -76.97   -16.21 1.00    20480    29232
# K                                    28.13     17.75    -7.56    61.75 1.00    37679    43403
# SexM                                -12.12      5.75   -23.28    -0.87 1.00    37958    44199
# SexUN                                -7.39      5.54   -17.90     3.83 1.00    48566    36577
# sigma_Site_YearDauphinRiver_2018     -0.34      0.49    -1.28     0.62 1.00    26547    37083
# sigma_Site_YearMatheson_2017          0.14      0.53    -0.85     1.23 1.00    37903    38567
# sigma_Site_YearMatheson_2018         -1.60      0.42    -2.43    -0.76 1.00    29188    38011
# sigma_Site_YearRedRiver_2017         -1.09      0.33    -1.73    -0.44 1.00    37058    40712
# sigma_Site_YearRedRiver_2018         -0.38      0.36    -1.10     0.32 1.00    34411    39421
# sigma_Site_YearSandyBar_2017         -0.85      0.33    -1.50    -0.21 1.00    34477    39292
# sigma_Site_YearSandyBar_2018         -1.34      0.41    -2.14    -0.55 1.00    30384    39049
# sigma_Site_YearWinnipegRiver_2017    -1.58      0.63    -2.74    -0.23 1.00    34884    33269
# sigma_K                               1.16      0.85    -0.51     2.83 1.00    35256    43456
# sigma_SexM                           -0.27      0.28    -0.81     0.29 1.00    46680    43945
# sigma_SexUN                          -0.51      0.49    -1.46     0.46 1.00    39991    42730
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     4.77      3.13     2.16    11.98 1.00    34308    29163
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_tyr, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    98.6      75.8     122.5
# DauphinRiver_2018    64.8      48.7      81.2
# Matheson_2017        85.8      40.1     135.3
# Matheson_2018        36.7      27.4      45.1
# RedRiver_2017        76.9      65.1      88.8
# RedRiver_2018        55.3      39.2      72.8
# SandyBar_2017        65.3      54.3      76.3
# SandyBar_2018        35.6      28.4      43.5
# WinnipegRiver_2017   53.6      33.6      72.3
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_tyr, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    33.920     5.288   63.3500
# DauphinRiver_2017 - Matheson_2017        12.995   -41.696   63.0764
# DauphinRiver_2017 - Matheson_2018        61.977    37.986   88.1178
# DauphinRiver_2017 - RedRiver_2017        21.976    -2.471   48.0489
# DauphinRiver_2017 - RedRiver_2018        43.326    15.657   71.7029
# DauphinRiver_2017 - SandyBar_2017        33.471     9.463   59.4734
# DauphinRiver_2017 - SandyBar_2018        62.867    38.940   87.9079
# DauphinRiver_2017 - WinnipegRiver_2017   45.462    15.332   75.9205
# DauphinRiver_2018 - Matheson_2017       -20.949   -73.817   27.2499
# DauphinRiver_2018 - Matheson_2018        28.392    11.481   44.8139
# DauphinRiver_2018 - RedRiver_2017       -12.155   -33.162    9.5147
# DauphinRiver_2018 - RedRiver_2018         9.303   -14.326   33.6159
# DauphinRiver_2018 - SandyBar_2017        -0.393   -20.656   19.8544
# DauphinRiver_2018 - SandyBar_2018        28.967    10.903   48.2235
# DauphinRiver_2018 - WinnipegRiver_2017   11.260   -13.740   37.7265
# Matheson_2017 - Matheson_2018            49.235     2.574   98.7645
# Matheson_2017 - RedRiver_2017             9.004   -38.986   59.0254
# Matheson_2017 - RedRiver_2018            30.290   -18.624   81.7841
# Matheson_2017 - SandyBar_2017            20.704   -25.998   70.7140
# Matheson_2017 - SandyBar_2018            50.044     3.814   99.1994
# Matheson_2017 - WinnipegRiver_2017       32.607   -16.834   86.8123
# Matheson_2018 - RedRiver_2017           -40.206   -56.454  -24.0825
# Matheson_2018 - RedRiver_2018           -18.766   -38.516   -0.0837
# Matheson_2018 - SandyBar_2017           -28.488   -42.956  -14.7682
# Matheson_2018 - SandyBar_2018             0.761   -10.314   11.6761
# Matheson_2018 - WinnipegRiver_2017      -17.010   -37.503    6.1755
# RedRiver_2017 - RedRiver_2018            21.595     0.809   41.2889
# RedRiver_2017 - SandyBar_2017            11.596    -3.022   26.5706
# RedRiver_2017 - SandyBar_2018            41.125    26.789   54.8387
# RedRiver_2017 - WinnipegRiver_2017       23.653     2.428   44.4347
# RedRiver_2018 - SandyBar_2017           -10.085   -28.948   10.7969
# RedRiver_2018 - SandyBar_2018            19.513     3.103   37.5917
# RedRiver_2018 - WinnipegRiver_2017        2.101   -22.835   29.2274
# SandyBar_2017 - SandyBar_2018            29.481    16.809   42.1963
# SandyBar_2017 - WinnipegRiver_2017       11.770    -8.830   33.4534
# SandyBar_2018 - WinnipegRiver_2017      -17.743   -37.469    3.9565
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_tyr, ~ Site_Year))
test_tyr_plot<- plot(emmeans(test_tyr, ~ Site_Year)) #### That's the one!!!!!!
test_tyr_plot
plot(emmeans(test_tyr, ~ Sex*Site_Year))
plot(pairs(emmeans(test_tyr, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
tyr_tets_plot <- gather_emmeans_draws(emmeans(test_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("tyr_tets_plot.png")
ggsave("test_tyr_plot.png")
save(test_tyr, file = "tyrosine_simple_model.RData")

#### val ####
hist(raw_dataf$Valine)
test_val <- brm(data=raw_dataf,
                family = student,
                bf(Valine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,200), class = b),
                          prior(normal(0,200), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_val)
pp_check(test_val, ndraws = 100) +
  theme_bw()
summary(test_val)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Valine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           174.13     75.26    26.36   322.15 1.00    19431    28876
# sigma_Intercept                       2.84      0.93     1.02     4.67 1.00    28487    38448
# Site_YearDauphinRiver_2018          -10.57     59.98  -126.08   110.18 1.00    15603    23755
# Site_YearMatheson_2017              -63.66     77.82  -212.82    92.92 1.00    23327    31481
# Site_YearMatheson_2018             -183.55     51.94  -282.31   -77.50 1.00    12487    17689
# Site_YearRedRiver_2017             -159.68     52.34  -258.77   -51.57 1.00    12491    16264
# Site_YearRedRiver_2018             -186.12     51.19  -282.74   -80.69 1.00    12171    16492
# Site_YearSandyBar_2017             -130.92     55.72  -235.80   -15.74 1.00    14290    21578
# Site_YearSandyBar_2018             -179.35     51.57  -277.09   -72.95 1.00    12195    16068
# Site_YearWinnipegRiver_2017        -185.10     59.33  -296.07   -63.05 1.00    14206    21956
# K                                   139.85     51.40    39.61   240.85 1.00    35754    42662
# SexM                                -36.39     16.64   -69.14    -3.78 1.00    38881    42090
# SexUN                               -22.56     25.07   -69.73    30.94 1.00    41733    32954
# sigma_Site_YearDauphinRiver_2018     -0.48      0.38    -1.25     0.27 1.00    23400    32016
# sigma_Site_YearMatheson_2017         -0.35      0.47    -1.20     0.64 1.00    32589    34664
# sigma_Site_YearMatheson_2018         -1.54      0.38    -2.28    -0.81 1.00    24445    34408
# sigma_Site_YearRedRiver_2017         -1.84      0.32    -2.50    -1.23 1.00    25077    32897
# sigma_Site_YearRedRiver_2018         -1.84      0.32    -2.49    -1.22 1.00    26695    33450
# sigma_Site_YearSandyBar_2017         -0.84      0.35    -1.56    -0.19 1.00    24251    30866
# sigma_Site_YearSandyBar_2018         -1.66      0.33    -2.30    -1.02 1.00    24396    34407
# sigma_Site_YearWinnipegRiver_2017    -2.12      0.59    -3.19    -0.85 1.00    29540    30660
# sigma_K                               2.35      0.75     0.89     3.83 1.00    33960    40437
# sigma_SexM                            0.06      0.25    -0.43     0.57 1.00    36101    41216
# sigma_SexUN                          -0.25      0.40    -1.01     0.57 1.00    38887    38846
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    14.61     11.54     2.92    45.72 1.00    27520    31579
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_val, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017     309     206.0       406
# DauphinRiver_2018     297     231.4       365
# Matheson_2017         243     120.1       377
# Matheson_2018         124      92.3       156
# RedRiver_2017         148     114.7       182
# RedRiver_2018         121      95.9       148
# SandyBar_2017         175     121.4       234
# SandyBar_2018         128     101.3       156
# WinnipegRiver_2017    121      59.8       186
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_val, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    11.370   -110.59   125.428
# DauphinRiver_2017 - Matheson_2017        64.761    -88.51   216.328
# DauphinRiver_2017 - Matheson_2018       184.761     79.64   283.999
# DauphinRiver_2017 - RedRiver_2017       161.201     56.16   262.845
# DauphinRiver_2017 - RedRiver_2018       187.651     84.25   286.037
# DauphinRiver_2017 - SandyBar_2017       132.559     19.81   239.174
# DauphinRiver_2017 - SandyBar_2018       180.760     78.24   281.663
# DauphinRiver_2017 - WinnipegRiver_2017  187.041     68.60   300.829
# DauphinRiver_2018 - Matheson_2017        54.057    -91.55   198.577
# DauphinRiver_2018 - Matheson_2018       172.611    104.31   240.827
# DauphinRiver_2018 - RedRiver_2017       148.812     73.35   228.048
# DauphinRiver_2018 - RedRiver_2018       174.938    102.69   250.303
# DauphinRiver_2018 - SandyBar_2017       120.723     32.48   207.844
# DauphinRiver_2018 - SandyBar_2018       168.189     96.60   244.754
# DauphinRiver_2018 - WinnipegRiver_2017  174.797     80.95   268.740
# Matheson_2017 - Matheson_2018           118.219     -7.94   252.990
# Matheson_2017 - RedRiver_2017            94.567    -37.60   226.387
# Matheson_2017 - RedRiver_2018           120.809     -3.79   253.195
# Matheson_2017 - SandyBar_2017            66.417    -72.51   203.607
# Matheson_2017 - SandyBar_2018           114.238    -11.08   247.724
# Matheson_2017 - WinnipegRiver_2017      120.713    -21.36   265.737
# Matheson_2018 - RedRiver_2017           -23.520    -69.86    22.889
# Matheson_2018 - RedRiver_2018             2.833    -35.47    41.700
# Matheson_2018 - SandyBar_2017           -51.206   -117.08     8.164
# Matheson_2018 - SandyBar_2018            -4.163    -42.97    32.606
# Matheson_2018 - WinnipegRiver_2017        2.443    -69.46    72.686
# RedRiver_2017 - RedRiver_2018            26.372    -12.43    63.872
# RedRiver_2017 - SandyBar_2017           -27.348    -91.85    29.303
# RedRiver_2017 - SandyBar_2018            19.659    -21.15    59.984
# RedRiver_2017 - WinnipegRiver_2017       27.171    -42.44    87.347
# RedRiver_2018 - SandyBar_2017           -53.804   -116.45     0.153
# RedRiver_2018 - SandyBar_2018            -6.806    -35.07    21.435
# RedRiver_2018 - WinnipegRiver_2017        0.439    -67.13    65.626
# SandyBar_2017 - SandyBar_2018            47.216     -9.16   110.199
# SandyBar_2017 - WinnipegRiver_2017       54.307    -25.90   138.052
# SandyBar_2018 - WinnipegRiver_2017        7.125    -64.25    71.474
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_val, ~ Site_Year))
test_val_plot<- plot(emmeans(test_val, ~ Site_Year)) #### That's the one!!!!!!
test_val_plot
plot(emmeans(test_val, ~ Sex*Site_Year))
plot(pairs(emmeans(test_val, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_val, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_val, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
val_tets_plot <- gather_emmeans_draws(emmeans(test_val, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("val_tets_plot.png")
ggsave("test_val_plot.png")
save(test_val, file = "valine_simple_model.RData")

# working on modifying the plot based on old models
get_variables(test_val)
# [1] "b_Intercept"                         "b_sigma_Intercept"                  
# [3] "b_Site_YearDauphinRiver_2018"        "b_Site_YearMatheson_2017"           
# [5] "b_Site_YearMatheson_2018"            "b_Site_YearRedRiver_2017"           
# [7] "b_Site_YearRedRiver_2018"            "b_Site_YearSandyBar_2017"           
# [9] "b_Site_YearSandyBar_2018"            "b_Site_YearWinnipegRiver_2017"      
# [11] "b_K"                                 "b_SexM"                             
# [13] "b_SexUN"                             "b_sigma_Site_YearDauphinRiver_2018" 
# [15] "b_sigma_Site_YearMatheson_2017"      "b_sigma_Site_YearMatheson_2018"     
# [17] "b_sigma_Site_YearRedRiver_2017"      "b_sigma_Site_YearRedRiver_2018"     
# [19] "b_sigma_Site_YearSandyBar_2017"      "b_sigma_Site_YearSandyBar_2018"     
# [21] "b_sigma_Site_YearWinnipegRiver_2017" "b_sigma_K"                          
# [23] "b_sigma_SexM"                        "b_sigma_SexUN"                      
# [25] "nu"                                  "lprior"                             
# [27] "lp__"                                "accept_stat__"                      
# [29] "stepsize__"                          "treedepth__"                        
# [31] "n_leapfrog__"                        "divergent__"                        
# [33] "energy__"   

val_draws <- gather_emmeans_draws(emmeans(test_val, ~Site_Year)) %>% 
  separate(Site_Year, into = c("Site", "Year"), sep = "_") %>% 
  rename(est = .value) %>% 
  mutate(Site = factor(Site, levels = rev(c("DauphinRiver", "Matheson", "SandyBar", "RedRiver", "WinnipegRiver"))))

# A custom function for taking a brms model, and pulling draws with emmeans assuming that Site_Year is the independent variable. It also reformats the draws for plotting.
# To use the function, run metabolite_draws <- model_draws(metabolite_brms_model)
model_draws <- function(brms_model){
  gather_emmeans_draws(emmeans(brms_model, ~Site_Year)) %>% 
    separate(Site_Year, into = c("Site", "Year"), sep = "_") %>% 
    rename(est = .value) %>% 
    mutate(Site = factor(Site, levels = rev(c("DauphinRiver", "Matheson", "SandyBar", "RedRiver", "WinnipegRiver"))))
}
# try on valine
test_val_site_year_plotX <- ggplot(val_draws)
test_val_site_year_plotX

test_val_site_year_plot <- ggplot(data = val_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(val_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(val_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_val_site_year_plot.pdf", plot = test_val_site_year_plot, dpi = 900)
test_val_site_year_plot

test_val_site_year_plot2 <- ggplot(data = val_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(val_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(val_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Valine (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_val_site_year_plot2
ggsave(filename = "test_val_site_year_plot2.pdf", plot = test_val_site_year_plot2, dpi = 900)

ggsave("test_val_site_year_plot2.png")

test_val_site_year_plot3 <- ggplot(data = val_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(val_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(val_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Valine (uM)") +
  ylab("Site of capture") +  theme_bw(base_size = 25) +
 theme(legend.position="none") 
test_val_site_year_plot3
ggsave(filename = "test_val_site_year_plot3.pdf", plot = test_val_site_year_plot3, dpi = 900)

ggsave("test_val_site_year_plot3.png")

test_val_site_year_plot4 <- ggplot(data = val_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(val_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(val_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("Valine (µM)") +
  ylab("Site of capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_val_site_year_plot4 # halfeye plot

ggsave(filename = "test_val_site_year_plot4.pdf", plot = test_val_site_year_plot4, dpi = 900)

ggsave("test_val_site_year_plot4.png")

# install.packages("devtools")
devtools::install_github("thomasp85/patchwork")
library(patchwork)
#### carnitine data ####
carn_data <- read_csv(file = "Carnitines_all.csv")
str(carn_data)
carn_dataf <- carn_data %>% 
  mutate(Year = relevel(as.factor(Year), '2017', '2018')) %>% 
  mutate(Site_Year = paste0(Site, "_", Year)) %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" ")))
str(carn_dataf)
view(carn_dataf)

#### metabolite all data ####
met_data <- read_csv(file = "Metabolites_All.csv")
str(raw_data)
met_dataf <- met_data %>% 
  mutate(Year = relevel(as.factor(Year), '2017', '2018')) %>% 
  mutate(Site_Year = paste0(Site, "_", Year)) %>% 
  mutate(across(where(is.character), str_remove_all, pattern = fixed(" ")))
str(met_dataf)
view(met_dataf)
names(met_dataf)
dim(met_dataf)
#### C3 ####
hist(carn_dataf$C3)
test_C3 <- brm(data=carn_dataf,
                family = student,
                bf(C3 ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,0.04), class = b),
                          prior(normal(0,0.04), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C3)
pp_check(test_C3, ndraws = 100) +
  theme_bw()
summary(test_C3)

c3_draws <- model_draws(test_C3)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C3 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.03      0.01     0.00     0.05 1.00    18775    31669
# sigma_Intercept                      -5.00      0.93    -6.91    -3.21 1.00    24128    31856
# Site_YearDauphinRiver_2018            0.01      0.01    -0.01     0.03 1.00    15905    26088
# Site_YearMatheson_2017               -0.02      0.01    -0.04     0.01 1.00    19733    27802
# Site_YearMatheson_2018               -0.02      0.01    -0.04    -0.01 1.00    13153    21816
# Site_YearRedRiver_2017               -0.04      0.01    -0.05    -0.02 1.00    13197    20262
# Site_YearRedRiver_2018               -0.03      0.01    -0.04    -0.01 1.00    13191    20816
# Site_YearSandyBar_2017               -0.02      0.01    -0.04    -0.00 1.00    16097    25044
# Site_YearSandyBar_2018               -0.03      0.01    -0.04    -0.01 1.00    13116    20060
# Site_YearWinnipegRiver_2017          -0.01      0.01    -0.03     0.01 1.00    16300    25050
# K                                     0.02      0.01     0.00     0.03 1.00    36944    42248
# SexM                                  0.00      0.00    -0.00     0.01 1.00    45212    45532
# SexUN                                -0.00      0.00    -0.01     0.01 1.00    49134    38168
# sigma_Site_YearDauphinRiver_2018     -0.59      0.35    -1.26     0.11 1.00    26486    37789
# sigma_Site_YearMatheson_2017         -0.65      0.48    -1.51     0.39 1.00    33662    30035
# sigma_Site_YearMatheson_2018         -1.38      0.35    -2.06    -0.69 1.00    26354    36162
# sigma_Site_YearRedRiver_2017         -1.75      0.32    -2.41    -1.14 1.00    25887    30633
# sigma_Site_YearRedRiver_2018         -1.64      0.29    -2.22    -1.06 1.00    30239    37321
# sigma_Site_YearSandyBar_2017         -0.64      0.28    -1.20    -0.09 1.00    27465    33868
# sigma_Site_YearSandyBar_2018         -1.83      0.30    -2.42    -1.24 1.00    30614    36150
# sigma_Site_YearWinnipegRiver_2017    -1.52      0.62    -2.67    -0.21 1.00    26947    30749
# sigma_K                               1.38      0.77    -0.07     2.97 1.00    25357    33015
# sigma_SexM                            0.11      0.23    -0.34     0.58 1.00    40280    41712
# sigma_SexUN                           0.21      0.37    -0.49     0.96 1.00    39314    41185
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    19.55     13.42     4.05    53.79 1.00    31757    31135
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C3, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.0475    0.0325    0.0632
# DauphinRiver_2018  0.0545    0.0449    0.0642
# Matheson_2017      0.0316    0.0160    0.0487
# Matheson_2018      0.0252    0.0196    0.0310
# RedRiver_2017      0.0102    0.0051    0.0152
# RedRiver_2018      0.0192    0.0146    0.0239
# SandyBar_2017      0.0282    0.0190    0.0378
# SandyBar_2018      0.0195    0.0155    0.0236
# WinnipegRiver_2017 0.0336    0.0205    0.0459
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C3, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018  -0.007038 -0.024692  1.10e-02
# DauphinRiver_2017 - Matheson_2017       0.015733 -0.006476  3.59e-02
# DauphinRiver_2017 - Matheson_2018       0.022286  0.006535  3.84e-02
# DauphinRiver_2017 - RedRiver_2017       0.037300  0.022135  5.32e-02
# DauphinRiver_2017 - RedRiver_2018       0.028297  0.012958  4.38e-02
# DauphinRiver_2017 - SandyBar_2017       0.019265  0.002159  3.57e-02
# DauphinRiver_2017 - SandyBar_2018       0.027983  0.012692  4.30e-02
# DauphinRiver_2017 - WinnipegRiver_2017  0.013881 -0.005739  3.29e-02
# DauphinRiver_2018 - Matheson_2017       0.022861  0.003966  4.10e-02
# DauphinRiver_2018 - Matheson_2018       0.029355  0.018829  3.95e-02
# DauphinRiver_2018 - RedRiver_2017       0.044384  0.033348  5.50e-02
# DauphinRiver_2018 - RedRiver_2018       0.035322  0.024418  4.56e-02
# DauphinRiver_2018 - SandyBar_2017       0.026370  0.012627  3.94e-02
# DauphinRiver_2018 - SandyBar_2018       0.035022  0.024698  4.52e-02
# DauphinRiver_2018 - WinnipegRiver_2017  0.021006  0.005044  3.68e-02
# Matheson_2017 - Matheson_2018           0.006424 -0.009780  2.35e-02
# Matheson_2017 - RedRiver_2017           0.021461  0.005850  3.87e-02
# Matheson_2017 - RedRiver_2018           0.012427 -0.003382  2.93e-02
# Matheson_2017 - SandyBar_2017           0.003491 -0.014290  2.16e-02
# Matheson_2017 - SandyBar_2018           0.012096 -0.003135  2.92e-02
# Matheson_2017 - WinnipegRiver_2017     -0.001875 -0.021584  1.93e-02
# Matheson_2018 - RedRiver_2017           0.015039  0.007829  2.19e-02
# Matheson_2018 - RedRiver_2018           0.005988 -0.000570  1.22e-02
# Matheson_2018 - SandyBar_2017          -0.002927 -0.013480  7.11e-03
# Matheson_2018 - SandyBar_2018           0.005703 -0.000109  1.16e-02
# Matheson_2018 - WinnipegRiver_2017     -0.008380 -0.021246  5.75e-03
# RedRiver_2017 - RedRiver_2018          -0.009064 -0.014276 -3.87e-03
# RedRiver_2017 - SandyBar_2017          -0.017991 -0.027368 -8.65e-03
# RedRiver_2017 - SandyBar_2018          -0.009369 -0.014234 -4.22e-03
# RedRiver_2017 - WinnipegRiver_2017     -0.023421 -0.035467 -1.04e-02
# RedRiver_2018 - SandyBar_2017          -0.008897 -0.018813 -4.99e-05
# RedRiver_2018 - SandyBar_2018          -0.000271 -0.004616  4.11e-03
# RedRiver_2018 - WinnipegRiver_2017     -0.014350 -0.026845 -1.16e-03
# SandyBar_2017 - SandyBar_2018           0.008611 -0.000297  1.79e-02
# SandyBar_2017 - WinnipegRiver_2017     -0.005463 -0.020034  9.98e-03
# SandyBar_2018 - WinnipegRiver_2017     -0.014118 -0.026453 -6.76e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
# HPD interval probability: 0.95 

C3_draws <- model_draws(test_C3)
C3_draws

plot(emmeans(test_C3, ~ Site_Year))
test_C3_plot<- plot(emmeans(test_C3, ~ Site_Year)) #### That's the one!!!!!!
test_C3_plot
plot(emmeans(test_C3, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C3, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C3, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C3, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C3_tets_plot <- gather_emmeans_draws(emmeans(test_C3, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C3_tets_plot
ggsave("C3_tets_plot.png")
ggsave("C3_tets_plot.pdf")
ggsave("C3_tets_plot.png", width = 4, height = 1.5, units = "cm")
save(test_C3, file = "C3_simple_model.RData")

gather_emmeans_draws(emmeans(test_C3, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_dotsinterval() +
  theme_bw(base_size = 18)

model_dataframe_test_C3 <- test_C3 %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Intercept:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_test_C3$Site<- factor(model_dataframe_test_C3$Site, levels = c("WinnipegRiver", "RedRiver", "SandyBar", "Matheson", "DauphinRiver"))

test_C3_site_year_plot <- ggplot(data = C3_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C3_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C3_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C3_site_year_plot.pdf", plot = test_C3_site_year_plot, dpi = 900)
test_C3_site_year_plot

test_C3_site_year_plot2 <- ggplot(data = C3_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C3_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C3_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C3 (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.24), legend.background = element_blank())
test_C3_site_year_plot2
ggsave(filename = "test_C3_site_year_plot2.pdf", plot = test_C3_site_year_plot2, dpi = 900)

ggsave("test_C3_site_year_plot2.png")

test_C3_site_year_plot3 <- ggplot(data = C3_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C3_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C3_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C3 (uM)") +
  ylab("Site of capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C3_site_year_plot3
ggsave(filename = "test_C3_site_year_plot3.pdf", plot = test_C3_site_year_plot3, dpi = 900)

ggsave("test_C3_site_year_plot3.png")

# pdf(file="C3_tets_plot.png",width=400,height=350)
# plot(x=rnorm(10),y=rnorm(10),main="example")
# dev.off()
test_C3_site_year_plot4 <- ggplot(data = C3_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C3_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C3_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C3 (µM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.24), legend.background = element_blank())
test_C3_site_year_plot4
ggsave(filename = "test_C3_site_year_plot4.pdf", plot = test_C3_site_year_plot4, dpi = 900)

ggsave("test_C3_site_year_plot4.png")
         

#### methionine sulfoxide ####
names(met_dataf)
hist(met_dataf$Methionine_Sulfoxide)
test_met.sul <- brm(data=met_dataf,
                    family = skew_normal,
                    bf(Methionine_Sulfoxide ~ Site_Year + K + Sex,
                       sigma ~ Site_Year + K + Sex),
                    prior = c(prior(normal(0,10), class = b),
                              prior(normal(0,10), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_met.sul)
pp_check(test_met.sul, ndraws = 100) +
  theme_bw()
summary(test_met.sul)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Methionine_Sulfoxide ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             3.08      1.30     0.47     5.61 1.00    20843    29903
# sigma_Intercept                      -0.00      0.82    -1.66     1.58 1.00    23951    36034
# Site_YearDauphinRiver_2018            5.82      1.31     3.37     8.55 1.00    25408    32940
# Site_YearMatheson_2017               -1.14      1.30    -3.38     1.77 1.00    19121    24049
# Site_YearMatheson_2018                3.58      0.76     1.99     5.01 1.00    15702    19695
# Site_YearRedRiver_2017               -2.81      0.64    -4.21    -1.68 1.00    16285    17511
# Site_YearRedRiver_2018                4.82      1.47     2.24     8.01 1.00    25727    33653
# Site_YearSandyBar_2017               -1.43      0.78    -3.00     0.08 1.00    18944    23886
# Site_YearSandyBar_2018                3.80      1.74     0.73     7.51 1.00    24849    34829
# Site_YearWinnipegRiver_2017          -2.91      0.79    -4.43    -1.48 1.00    15946    19206
# K                                     0.99      0.94    -0.71     3.02 1.00    35375    34048
# SexM                                 -0.10      0.39    -0.92     0.66 1.00    32499    35455
# SexUN                                -2.17      0.85    -3.94    -0.52 1.00    40925    33947
# sigma_Site_YearDauphinRiver_2018      0.72      0.32     0.11     1.36 1.00    21617    29165
# sigma_Site_YearMatheson_2017         -0.20      0.51    -1.15     0.87 1.00    19067    25807
# sigma_Site_YearMatheson_2018         -0.46      0.33    -1.10     0.19 1.00    20191    30949
# sigma_Site_YearRedRiver_2017         -1.39      0.31    -2.00    -0.76 1.00    22515    31603
# sigma_Site_YearRedRiver_2018          0.70      0.29     0.13     1.28 1.00    24320    30514
# sigma_Site_YearSandyBar_2017         -0.06      0.27    -0.60     0.47 1.00    24966    31385
# sigma_Site_YearSandyBar_2018          0.90      0.29     0.33     1.49 1.00    22948    29152
# sigma_Site_YearWinnipegRiver_2017    -1.63      0.55    -2.55    -0.40 1.00    27391    24980
# sigma_K                               0.79      0.69    -0.51     2.19 1.00    28728    35507
# sigma_SexM                           -0.05      0.30    -0.65     0.53 1.00    22923    30573
# sigma_SexUN                          -0.24      0.33    -0.90     0.42 1.00    39931    39997
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     6.50      2.01     3.30    11.10 1.00    43336    34109
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_met.sul, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   3.363     2.109      4.74
# DauphinRiver_2018   9.141     7.122     11.56
# Matheson_2017       2.094     0.241      4.70
# Matheson_2018       6.970     6.176      7.83
# RedRiver_2017       0.600    -0.106      1.29
# RedRiver_2018       8.084     5.680     11.07
# SandyBar_2017       1.943     0.825      3.22
# SandyBar_2018       7.073     4.227     10.53
# WinnipegRiver_2017  0.464    -0.531      1.56
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_met.sul, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   -5.7732   -8.4047    -3.257
# DauphinRiver_2017 - Matheson_2017        1.2469   -1.5318     3.553
# DauphinRiver_2017 - Matheson_2018       -3.6122   -5.0618    -2.055
# DauphinRiver_2017 - RedRiver_2017        2.7634    1.6269     4.112
# DauphinRiver_2017 - RedRiver_2018       -4.7117   -7.8687    -2.136
# DauphinRiver_2017 - SandyBar_2017        1.4237   -0.0792     3.005
# DauphinRiver_2017 - SandyBar_2018       -3.6854   -7.2530    -0.538
# DauphinRiver_2017 - WinnipegRiver_2017   2.8948    1.5047     4.453
# DauphinRiver_2018 - Matheson_2017        7.0007    3.5926    10.210
# DauphinRiver_2018 - Matheson_2018        2.1605   -0.0304     4.576
# DauphinRiver_2018 - RedRiver_2017        8.5596    6.3067    10.976
# DauphinRiver_2018 - RedRiver_2018        1.0609   -2.5047     4.275
# DauphinRiver_2018 - SandyBar_2017        7.1901    4.8520     9.734
# DauphinRiver_2018 - SandyBar_2018        2.0984   -1.8616     5.682
# DauphinRiver_2018 - WinnipegRiver_2017   8.6722    6.3380    11.228
# Matheson_2017 - Matheson_2018           -4.8785   -6.8935    -2.191
# Matheson_2017 - RedRiver_2017            1.4877   -0.2146     4.105
# Matheson_2017 - RedRiver_2018           -5.9441   -9.8944    -2.170
# Matheson_2017 - SandyBar_2017            0.1601   -2.0927     3.017
# Matheson_2017 - SandyBar_2018           -4.9093   -9.2873    -0.750
# Matheson_2017 - WinnipegRiver_2017       1.6020   -0.5380     4.421
# Matheson_2018 - RedRiver_2017            6.3730    5.4792     7.414
# Matheson_2018 - RedRiver_2018           -1.1053   -4.0462     1.474
# Matheson_2018 - SandyBar_2017            5.0262    3.6447     6.369
# Matheson_2018 - SandyBar_2018           -0.0801   -3.4938     2.873
# Matheson_2018 - WinnipegRiver_2017       6.4993    5.2895     7.764
# RedRiver_2017 - RedRiver_2018           -7.4943  -10.4749    -5.042
# RedRiver_2017 - SandyBar_2017           -1.3466   -2.5251    -0.255
# RedRiver_2017 - SandyBar_2018           -6.4837   -9.9633    -3.544
# RedRiver_2017 - WinnipegRiver_2017       0.1323   -0.8075     0.987
# RedRiver_2018 - SandyBar_2017            6.1222    3.7739     9.042
# RedRiver_2018 - SandyBar_2018            1.0430   -2.5973     4.513
# RedRiver_2018 - WinnipegRiver_2017       7.6173    5.1333    10.647
# SandyBar_2017 - SandyBar_2018           -5.1129   -8.5616    -2.278
# SandyBar_2017 - WinnipegRiver_2017       1.4828    0.2052     2.861
# SandyBar_2018 - WinnipegRiver_2017       6.5918    3.6679    10.135
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_met.sul, ~ Site_Year))
test_met.sul_plot<- plot(emmeans(test_met.sul, ~ Site_Year)) #### That's the one!!!!!!
test_met.sul_plot
plot(emmeans(test_met.sul, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met.sul, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_met.sul, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_met.sul, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
metsul_tets_plot <- gather_emmeans_draws(emmeans(test_met.sul, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
metsul_tets_plot
ggsave("test_met.sul_plot.png")
ggsave("kyn_test_plot.png")
save(test_met.sul, file = "Mehionine_sulfoxide_simple_model.RData")



#### Dimethyl sulfone ####
names(met_dataf)
hist(met_dataf$Dimethyl_Sulfone)
test_d.sul <- brm(data=met_dataf,
                    family = skew_normal,
                    bf(Dimethyl_Sulfone ~ Site_Year + K + Sex,
                       sigma ~ Site_Year + K + Sex),
                    prior = c(prior(normal(0,15), class = b),
                              prior(normal(0,15), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_d.sul)
pp_check(test_d.sul, ndraws = 100) +
  theme_bw()
summary(test_d.sul)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Dimethyl_Sulfone ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             3.01      2.16    -1.02     7.43 1.00    36524
# sigma_Intercept                      -0.37      0.84    -1.98     1.34 1.00    24574
# Site_YearDauphinRiver_2018           12.11      1.64     9.12    15.60 1.00    35584
# Site_YearMatheson_2017               -0.29      1.61    -2.97     3.33 1.00    32614
# Site_YearMatheson_2018                6.55      1.38     4.04     9.51 1.00    33860
# Site_YearRedRiver_2017               -2.15      0.69    -3.53    -0.80 1.00    29890
# Site_YearRedRiver_2018                4.91      0.99     3.03     6.92 1.00    37639
# Site_YearSandyBar_2017               -1.04      0.70    -2.46     0.30 1.00    28625
# Site_YearSandyBar_2018                3.63      1.44     1.00     6.69 1.00    42709
# Site_YearWinnipegRiver_2017          -0.45      2.77    -5.11     5.97 1.00    27947
# K                                     2.19      1.87    -1.57     5.73 1.00    37050
# SexM                                  2.28      0.93     0.50     4.15 1.00    32252
# SexUN                                -0.43      2.54    -4.94     5.15 1.00    37840
# sigma_Site_YearDauphinRiver_2018      1.06      0.36     0.35     1.76 1.00    20680
# sigma_Site_YearMatheson_2017          0.32      0.48    -0.53     1.37 1.00    28238
# sigma_Site_YearMatheson_2018          1.06      0.36     0.35     1.76 1.00    20476
# sigma_Site_YearRedRiver_2017         -0.18      0.29    -0.74     0.41 1.00    25486
# sigma_Site_YearRedRiver_2018          0.37      0.28    -0.19     0.93 1.00    25845
# sigma_Site_YearSandyBar_2017         -0.01      0.28    -0.57     0.53 1.00    22411
# sigma_Site_YearSandyBar_2018          0.83      0.30     0.25     1.42 1.00    24676
# sigma_Site_YearWinnipegRiver_2017     0.73      0.54    -0.19     1.93 1.00    25163
# sigma_K                               0.82      0.66    -0.49     2.09 1.00    29593
# sigma_SexM                            0.71      0.21     0.29     1.12 1.00    30077
# sigma_SexUN                           0.27      0.33    -0.36     0.95 1.00    39550
# Tail_ESS
# Intercept                            37120
# sigma_Intercept                      32327
# Site_YearDauphinRiver_2018           34167
# Site_YearMatheson_2017               23039
# Site_YearMatheson_2018               35287
# Site_YearRedRiver_2017               32187
# Site_YearRedRiver_2018               39255
# Site_YearSandyBar_2017               31728
# Site_YearSandyBar_2018               36782
# Site_YearWinnipegRiver_2017          20745
# K                                    40820
# SexM                                 38603
# SexUN                                32906
# sigma_Site_YearDauphinRiver_2018     29412
# sigma_Site_YearMatheson_2017         27175
# sigma_Site_YearMatheson_2018         29034
# sigma_Site_YearRedRiver_2017         36363
# sigma_Site_YearRedRiver_2018         35449
# sigma_Site_YearSandyBar_2017         30486
# sigma_Site_YearSandyBar_2018         34280
# sigma_Site_YearWinnipegRiver_2017    26323
# sigma_K                              36794
# sigma_SexM                           35280
# sigma_SexUN                          37824
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.12      1.67     1.66     8.12 1.00    34310    29930
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test_d.sul, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    5.98     4.058      8.04
# DauphinRiver_2018   18.04    15.404     21.07
# Matheson_2017        5.60     2.522      9.23
# Matheson_2018       12.52     9.942     15.44
# RedRiver_2017        3.82     1.967      5.83
# RedRiver_2018       10.88     8.614     13.33
# SandyBar_2017        4.94     3.076      7.01
# SandyBar_2018        9.52     6.669     13.02
# WinnipegRiver_2017   5.31     0.286     11.58
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_d.sul, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   -12.020   -15.310    -8.866
# DauphinRiver_2017 - Matheson_2017         0.441    -3.174     3.065
# DauphinRiver_2017 - Matheson_2018        -6.484    -9.300    -3.860
# DauphinRiver_2017 - RedRiver_2017         2.151     0.804     3.539
# DauphinRiver_2017 - RedRiver_2018        -4.891    -6.850    -2.977
# DauphinRiver_2017 - SandyBar_2017         1.023    -0.333     2.417
# DauphinRiver_2017 - SandyBar_2018        -3.556    -6.589    -0.921
# DauphinRiver_2017 - WinnipegRiver_2017    0.725    -5.199     5.715
# DauphinRiver_2018 - Matheson_2017        12.414     8.323    16.932
# DauphinRiver_2018 - Matheson_2018         5.535     2.007     9.266
# DauphinRiver_2018 - RedRiver_2017        14.166    11.199    17.625
# DauphinRiver_2018 - RedRiver_2018         7.132     3.719    10.726
# DauphinRiver_2018 - SandyBar_2017        13.048    10.060    16.397
# DauphinRiver_2018 - SandyBar_2018         8.485     4.398    12.631
# DauphinRiver_2018 - WinnipegRiver_2017   12.727     6.271    18.740
# Matheson_2017 - Matheson_2018            -6.911   -10.818    -2.886
# Matheson_2017 - RedRiver_2017             1.721    -1.080     5.043
# Matheson_2017 - RedRiver_2018            -5.298    -8.548    -1.819
# Matheson_2017 - SandyBar_2017             0.589    -2.251     3.961
# Matheson_2017 - SandyBar_2018            -3.965    -7.942     0.185
# Matheson_2017 - WinnipegRiver_2017        0.321    -6.250     6.310
# Matheson_2018 - RedRiver_2017             8.650     5.912    11.507
# Matheson_2018 - RedRiver_2018             1.594    -1.450     4.694
# Matheson_2018 - SandyBar_2017             7.512     4.999    10.265
# Matheson_2018 - SandyBar_2018             2.917    -0.740     6.756
# Matheson_2018 - WinnipegRiver_2017        7.183     0.901    12.816
# RedRiver_2017 - RedRiver_2018            -7.035    -8.948    -5.202
# RedRiver_2017 - SandyBar_2017            -1.125    -2.428     0.159
# RedRiver_2017 - SandyBar_2018            -5.704    -8.746    -2.973
# RedRiver_2017 - WinnipegRiver_2017       -1.407    -7.543     3.295
# RedRiver_2018 - SandyBar_2017             5.926     4.012     7.899
# RedRiver_2018 - SandyBar_2018             1.329    -1.881     4.421
# RedRiver_2018 - WinnipegRiver_2017        5.608    -0.596    10.665
# SandyBar_2017 - SandyBar_2018            -4.579    -7.647    -1.938
# SandyBar_2017 - WinnipegRiver_2017       -0.296    -6.598     4.323
# SandyBar_2018 - WinnipegRiver_2017        4.251    -2.071    10.027
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test_d.sul, ~ Site_Year))
test_d.sul_plot<- plot(emmeans(test_d.sul, ~ Site_Year)) #### That's the one!!!!!!
test_d.sul_plot
plot(emmeans(test_d.sul, ~ Sex*Site_Year))
plot(pairs(emmeans(test_d.sul, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_d.sul, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_d.sul, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
d.sul_tets_plot <- gather_emmeans_draws(emmeans(test_d.sul, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
d.sul_tets_plot
ggsave("test_d.sul_plot.png")
ggsave("d.sul_test_plot.png")
save(test_met.sul, file = "Dimethyl_sulfone_simple_model.RData")


#### Alph amino adipic acid ####
hist(met_dataf$Alpha_Aminoadipic_Acid)
test_AAAA <- brm(data=met_dataf,
                 family = student,
                 bf(Alpha_Aminoadipic_Acid ~ Site_Year + K + Sex,
                    sigma ~ Site_Year + K + Sex),
                 prior = c(prior(normal(0,10), class = b),
                           prior(normal(0,10), class = Intercept)),
                 iter = 20000, warmup = 5000, chains = 4, cores = 4,
                 control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_AAAA)
pp_check(test_AAAA, ndraws = 100) +
  theme_bw()
summary(test_AAAA)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Alpha_Aminoadipic_Acid ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            -2.28      2.02    -6.27     1.69 1.00    24814    33112
# sigma_Intercept                      -2.29      1.28    -4.85     0.17 1.00    26673    36116
# Site_YearDauphinRiver_2018            2.42      1.21     0.06     4.88 1.00    37712    40798
# Site_YearMatheson_2017               -0.04      1.61    -2.81     3.77 1.00    32719    25262
# Site_YearMatheson_2018               -0.08      0.78    -1.67     1.38 1.00    27023    31131
# Site_YearRedRiver_2017               -0.21      0.61    -1.37     1.06 1.00    39170    37761
# Site_YearRedRiver_2018               -0.84      0.63    -2.00     0.49 1.00    32224    34975
# Site_YearSandyBar_2017               -0.08      0.65    -1.38     1.18 1.00    33445    38918
# Site_YearSandyBar_2018                0.88      0.78    -0.65     2.44 1.00    34937    39911
# Site_YearWinnipegRiver_2017          -0.61      1.35    -3.28     1.96 1.00    37106    30115
# K                                     5.00      1.75     1.68     8.56 1.00    27355    34555
# SexM                                 -0.04      0.50    -1.06     0.90 1.00    33265    36453
# SexUN                                -0.27      2.04    -3.76     4.41 1.00    38983    28291
# sigma_Site_YearDauphinRiver_2018      1.00      0.47     0.09     1.94 1.00    23833    34447
# sigma_Site_YearMatheson_2017          0.82      0.70    -0.53     2.21 1.00    30429    34693
# sigma_Site_YearMatheson_2018          0.63      0.47    -0.29     1.57 1.00    24611    36552
# sigma_Site_YearRedRiver_2017          0.01      0.44    -0.87     0.86 1.00    29589    36978
# sigma_Site_YearRedRiver_2018          0.26      0.43    -0.60     1.09 1.00    30209    38159
# sigma_Site_YearSandyBar_2017          0.33      0.40    -0.45     1.11 1.00    23886    36815
# sigma_Site_YearSandyBar_2018          0.66      0.41    -0.15     1.47 1.00    27074    38491
# sigma_Site_YearWinnipegRiver_2017    -0.12      0.69    -1.46     1.30 1.00    34319    33075
# sigma_K                               2.17      1.06     0.12     4.27 1.00    31504    38895
# sigma_SexM                            0.02      0.31    -0.59     0.64 1.00    34518    40452
# sigma_SexUN                           0.52      0.52    -0.53     1.53 1.00    35697    39258
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     2.56      1.00     1.39     4.89 1.00    26530    28485
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_AAAA, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    3.03     1.609      4.69
# DauphinRiver_2018    5.48     3.298      7.81
# Matheson_2017        2.86    -0.114      6.80
# Matheson_2018        2.96     1.286      4.91
# RedRiver_2017        2.80     1.289      4.66
# RedRiver_2018        2.18     0.663      4.03
# SandyBar_2017        2.97     1.381      4.72
# SandyBar_2018        3.91     2.221      5.92
# WinnipegRiver_2017   2.47    -0.374      5.38
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_AAAA, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   -2.3986    -4.810    0.0028
# DauphinRiver_2017 - Matheson_2017        0.2082    -3.511    3.0176
# DauphinRiver_2017 - Matheson_2018        0.0542    -1.365    1.6878
# DauphinRiver_2017 - RedRiver_2017        0.2340    -1.026    1.3920
# DauphinRiver_2017 - RedRiver_2018        0.8656    -0.422    2.0568
# DauphinRiver_2017 - SandyBar_2017        0.0755    -1.196    1.3536
# DauphinRiver_2017 - SandyBar_2018       -0.8734    -2.435    0.6575
# DauphinRiver_2017 - WinnipegRiver_2017   0.6082    -2.027    3.2021
# DauphinRiver_2018 - Matheson_2017        2.5585    -1.581    6.2330
# DauphinRiver_2018 - Matheson_2018        2.4624     0.208    5.0477
# DauphinRiver_2018 - RedRiver_2017        2.6105     0.136    5.1150
# DauphinRiver_2018 - RedRiver_2018        3.2277     0.838    5.8030
# DauphinRiver_2018 - SandyBar_2017        2.4573     0.137    4.9836
# DauphinRiver_2018 - SandyBar_2018        1.5116    -1.002    4.1193
# DauphinRiver_2018 - WinnipegRiver_2017   3.0065    -0.453    6.4037
# Matheson_2017 - Matheson_2018           -0.1310    -2.928    3.8813
# Matheson_2017 - RedRiver_2017            0.0293    -2.873    3.8152
# Matheson_2017 - RedRiver_2018            0.6297    -2.223    4.4364
# Matheson_2017 - SandyBar_2017           -0.1181    -2.999    3.6950
# Matheson_2017 - SandyBar_2018           -1.0730    -3.992    2.8447
# Matheson_2017 - WinnipegRiver_2017       0.4396    -3.424    4.8385
# Matheson_2018 - RedRiver_2017            0.1533    -1.586    1.8034
# Matheson_2018 - RedRiver_2018            0.7808    -0.845    2.3335
# Matheson_2018 - SandyBar_2017           -0.0109    -1.521    1.5547
# Matheson_2018 - SandyBar_2018           -0.9591    -2.707    0.7786
# Matheson_2018 - WinnipegRiver_2017       0.5221    -2.419    3.5152
# RedRiver_2017 - RedRiver_2018            0.6278    -0.857    2.0638
# RedRiver_2017 - SandyBar_2017           -0.1491    -1.487    1.3225
# RedRiver_2017 - SandyBar_2018           -1.0996    -2.793    0.6153
# RedRiver_2017 - WinnipegRiver_2017       0.3866    -2.185    3.1570
# RedRiver_2018 - SandyBar_2017           -0.7692    -2.189    0.7133
# RedRiver_2018 - SandyBar_2018           -1.7277    -3.186   -0.1495
# RedRiver_2018 - WinnipegRiver_2017      -0.2463    -3.087    2.5658
# SandyBar_2017 - SandyBar_2018           -0.9542    -2.646    0.6416
# SandyBar_2017 - WinnipegRiver_2017       0.5201    -2.102    3.3411
# SandyBar_2018 - WinnipegRiver_2017       1.4762    -1.556    4.3942
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_AAAA, ~ Site_Year))
test_AAAA_plot<- plot(emmeans(test_AAAA, ~ Site_Year)) #### That's the one!!!!!!
test_AAAA_plot
plot(emmeans(test_AAAA, ~ Sex*Site_Year))
plot(pairs(emmeans(test_AAAA, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_AAAA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_AAAA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
AAAA_tets_plot <- gather_emmeans_draws(emmeans(test_AAAA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("AAAA_test_plot.png")
save(test_AAAA, file = " AAAA_simple_model.RData")
load("AAAA_simple_model.RData")

#### Total_Dimethylarginine ####
hist(met_dataf$Total_Dimethylarginine)
test_TDA <- brm(data=met_dataf,
                family = student,
                bf(Total_Dimethylarginine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,2), class = b),
                          prior(normal(0,2), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_TDA)
pp_check(test_TDA, ndraws = 100) +
  theme_bw()
summary(test_TDA)
emmeans(test_TDA, ~ Site_Year)
pairs(emmeans(test_TDA, ~ Site_Year))
plot(emmeans(test_TDA, ~ Site_Year))
test_TDA_plot<- plot(emmeans(test_TDA, ~ Site_Year)) #### That's the one!!!!!!
test_TDA_plot
plot(emmeans(test_TDA, ~ Sex*Site_Year))
plot(pairs(emmeans(test_TDA, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_TDA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_TDA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
TDA_tets_plot <- gather_emmeans_draws(emmeans(test_TDA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("TDA_test_plot.png")
save(test_TDA, file = " TDA_simple_model.RData")


#### Kynurenine ####
hist(met_dataf$Kynurenine)
test_kyn <- brm(data=met_dataf,
                    family = skew_normal,
                    bf(Kynurenine ~ Site_Year + K + Sex,
                       sigma ~ Site_Year + K + Sex),
                    prior = c(prior(normal(0,1), class = b),
                              prior(normal(0,1), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_kyn)
pp_check(test_kyn, ndraws = 100) +
  theme_bw()
summary(test_kyn)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Kynurenine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.47      0.08     0.32     0.65 1.00    10852    13804
# sigma_Intercept                      -0.94      0.56    -2.03     0.17 1.00    29487    35503
# Site_YearDauphinRiver_2018            0.11      0.15    -0.16     0.42 1.00    20027    25915
# Site_YearMatheson_2017                0.10      0.27    -0.38     0.71 1.00    21985    21983
# Site_YearMatheson_2018               -0.39      0.08    -0.56    -0.25 1.00    10244    12459
# Site_YearRedRiver_2017               -0.30      0.09    -0.48    -0.14 1.00    10947    13063
# Site_YearRedRiver_2018               -0.06      0.14    -0.31     0.25 1.00    17987    23966
# Site_YearSandyBar_2017               -0.33      0.08    -0.50    -0.19 1.00    10543    12535
# Site_YearSandyBar_2018               -0.38      0.08    -0.55    -0.24 1.00    10468    12480
# Site_YearWinnipegRiver_2017          -0.46      0.08    -0.62    -0.32 1.00    10175    12056
# K                                    -0.01      0.03    -0.07     0.05 1.00    28383    20377
# SexM                                 -0.04      0.03    -0.09     0.02 1.00    35171    38016
# SexUN                                -0.05      0.04    -0.14     0.02 1.00    34478    30120
# sigma_Site_YearDauphinRiver_2018      0.46      0.31    -0.13     1.10 1.00    19992    31087
# sigma_Site_YearMatheson_2017          0.54      0.45    -0.26     1.51 1.00    20636    28598
# sigma_Site_YearMatheson_2018         -1.64      0.28    -2.18    -1.07 1.00    19608    28645
# sigma_Site_YearRedRiver_2017         -0.96      0.26    -1.47    -0.44 1.00    17470    25550
# sigma_Site_YearRedRiver_2018          0.38      0.27    -0.14     0.92 1.00    18096    25745
# sigma_Site_YearSandyBar_2017         -1.06      0.25    -1.54    -0.56 1.00    17695    23713
# sigma_Site_YearSandyBar_2018         -1.40      0.29    -1.95    -0.83 1.00    18522    27609
# sigma_Site_YearWinnipegRiver_2017    -3.90      0.62    -4.91    -2.47 1.00    17070    21997
# sigma_K                               0.01      0.46    -0.89     0.91 1.00    35169    35947
# sigma_SexM                           -0.43      0.20    -0.82    -0.03 1.00    30280    38388
# sigma_SexUN                          -0.35      0.32    -1.01     0.26 1.00    34415    31728
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha    10.03      2.32     5.95    15.01 1.00    46399    30038
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 167 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
emmeans(test_kyn, ~ Site_Year)
# Site_Year           emmean lower.HPD upper.HPD
# DauphinRiver_2017   0.4292    0.2914    0.5913
# DauphinRiver_2018   0.5339    0.3128    0.8044
# Matheson_2017       0.5135    0.0459    1.0918
# Matheson_2018       0.0447    0.0023    0.0910
# RedRiver_2017       0.1343    0.0679    0.2162
# RedRiver_2018       0.3662    0.1616    0.6284
# SandyBar_2017       0.1000    0.0457    0.1608
# SandyBar_2018       0.0581    0.0135    0.1077
# WinnipegRiver_2017 -0.0217   -0.0593    0.0152
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_kyn, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   -0.1036  -0.39667   0.18206
# DauphinRiver_2017 - Matheson_2017       -0.0827  -0.66173   0.41352
# DauphinRiver_2017 - Matheson_2018        0.3840   0.24014   0.54875
# DauphinRiver_2017 - RedRiver_2017        0.2931   0.13528   0.46936
# DauphinRiver_2017 - RedRiver_2018        0.0642  -0.23255   0.31997
# DauphinRiver_2017 - SandyBar_2017        0.3283   0.18041   0.49219
# DauphinRiver_2017 - SandyBar_2018        0.3700   0.22580   0.53283
# DauphinRiver_2017 - WinnipegRiver_2017   0.4512   0.31064   0.61062
# DauphinRiver_2018 - Matheson_2017        0.0226  -0.59608   0.56033
# DauphinRiver_2018 - Matheson_2018        0.4879   0.26325   0.75921
# DauphinRiver_2018 - RedRiver_2017        0.3973   0.15668   0.67449
# DauphinRiver_2018 - RedRiver_2018        0.1664  -0.17740   0.50188
# DauphinRiver_2018 - SandyBar_2017        0.4324   0.20278   0.70580
# DauphinRiver_2018 - SandyBar_2018        0.4753   0.24501   0.74610
# DauphinRiver_2018 - WinnipegRiver_2017   0.5560   0.33246   0.82713
# Matheson_2017 - Matheson_2018            0.4679   0.00736   1.05464
# Matheson_2017 - RedRiver_2017            0.3761  -0.08022   0.96884
# Matheson_2017 - RedRiver_2018            0.1458  -0.42271   0.74223
# Matheson_2017 - SandyBar_2017            0.4130  -0.05618   0.99254
# Matheson_2017 - SandyBar_2018            0.4547  -0.00249   1.04399
# Matheson_2017 - WinnipegRiver_2017       0.5358   0.06252   1.10838
# Matheson_2018 - RedRiver_2017           -0.0888  -0.17981  -0.00997
# Matheson_2018 - RedRiver_2018           -0.3215  -0.58517  -0.11943
# Matheson_2018 - SandyBar_2017           -0.0554  -0.12586   0.01010
# Matheson_2018 - SandyBar_2018           -0.0131  -0.07635   0.05121
# Matheson_2018 - WinnipegRiver_2017       0.0665   0.02329   0.11749
# RedRiver_2017 - RedRiver_2018           -0.2305  -0.50545  -0.00402
# RedRiver_2017 - SandyBar_2017            0.0343  -0.05545   0.12548
# RedRiver_2017 - SandyBar_2018            0.0763  -0.00024   0.16423
# RedRiver_2017 - WinnipegRiver_2017       0.1556   0.08932   0.23850
# RedRiver_2018 - SandyBar_2017            0.2652   0.05938   0.52223
# RedRiver_2018 - SandyBar_2018            0.3068   0.09874   0.57541
# RedRiver_2018 - WinnipegRiver_2017       0.3892   0.18999   0.64966
# SandyBar_2017 - SandyBar_2018            0.0414  -0.02389   0.10964
# SandyBar_2017 - WinnipegRiver_2017       0.1223   0.07005   0.18340
# SandyBar_2018 - WinnipegRiver_2017       0.0799   0.02727   0.14039
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_kyn, ~ Site_Year))
test_met_kyn <- plot(emmeans(test_kyn, ~ Site_Year)) #### That's the one!!!!!!
test_met_kyn
plot(emmeans(test_met_kyn, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met_kyn, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_kyn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_kyn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
kyn_test_plot <- gather_emmeans_draws(emmeans(test_kyn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
kyn_test_plot

ggsave("kyn_test_plot.png")
ggsave("kyn_test_plot.png")
save(test_kyn, file = "Kynurenine_simple_model.RData")
 
#### Succinate ####
hist(met_dataf$Succinate)
test_succ <- brm(data=met_dataf,
                family = skew_normal,
                bf(Succinate ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,10), class = b),
                          prior(normal(0,10), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))


plot(test_succ)
pp_check(test_succ, ndraws = 100) +
  theme_bw()
summary(test_succ)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Succinate ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             1.82      2.92    -3.91     7.58 1.00    35793    40161
# sigma_Intercept                       1.53      0.84    -0.11     3.19 1.00    30471    39039
# Site_YearDauphinRiver_2018            1.35      1.33    -1.36     3.92 1.00    29939    35209
# Site_YearMatheson_2017               -1.00      1.64    -4.00     2.46 1.00    30904    30368
# Site_YearMatheson_2018               -1.43      1.16    -3.77     0.80 1.00    24663    30985
# Site_YearRedRiver_2017                3.48      2.07    -0.37     7.83 1.00    43260    38131
# Site_YearRedRiver_2018                4.65      1.40     1.97     7.50 1.00    38838    39745
# Site_YearSandyBar_2017               -2.40      0.93    -4.29    -0.60 1.00    27571    32035
# Site_YearSandyBar_2018                0.28      1.31    -2.24     2.98 1.00    33424    38499
# Site_YearWinnipegRiver_2017          -3.32      2.01    -6.75     1.15 1.00    31561    24956
# K                                     8.25      2.40     3.56    12.99 1.00    47529    44763
# SexM                                 -0.87      0.72    -2.30     0.54 1.00    47506    41001
# SexUN                                -1.65      1.20    -4.00     0.70 1.00    53126    40675
# sigma_Site_YearDauphinRiver_2018     -0.05      0.34    -0.69     0.63 1.00    28829    37398
# sigma_Site_YearMatheson_2017         -0.08      0.46    -0.89     0.92 1.00    29906    32908
# sigma_Site_YearMatheson_2018         -0.45      0.37    -1.17     0.27 1.00    24328    37402
# sigma_Site_YearRedRiver_2017          0.98      0.28     0.44     1.53 1.00    35563    40181
# sigma_Site_YearRedRiver_2018          0.46      0.29    -0.10     1.03 1.00    29584    38257
# sigma_Site_YearSandyBar_2017         -0.28      0.27    -0.81     0.24 1.00    27132    35041
# sigma_Site_YearSandyBar_2018          0.33      0.29    -0.23     0.89 1.00    29159    35900
# sigma_Site_YearWinnipegRiver_2017    -0.15      0.54    -1.07     1.05 1.00    29618    27443
# sigma_K                              -0.28      0.68    -1.62     1.07 1.00    37648    43629
# sigma_SexM                           -0.33      0.21    -0.74     0.09 1.00    45557    45143
# sigma_SexUN                          -0.17      0.38    -0.92     0.57 1.00    44832    43656
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     3.42      1.29     1.49     6.50 1.00    38126    29047
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_succ, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    9.99      8.37     11.71
# DauphinRiver_2018   11.35      9.48     13.29
# Matheson_2017        8.91      6.22     12.17
# Matheson_2018        8.57      7.09     10.08
# RedRiver_2017       13.41      9.65     17.56
# RedRiver_2018       14.62     12.15     17.18
# SandyBar_2017        7.60      6.28      9.02
# SandyBar_2018       10.25      8.15     12.60
# WinnipegRiver_2017   6.54      3.11     10.59
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_succ, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    -1.384    -3.930    1.3362
# DauphinRiver_2017 - Matheson_2017         1.079    -2.309    4.1133
# DauphinRiver_2017 - Matheson_2018         1.418    -0.787    3.7837
# DauphinRiver_2017 - RedRiver_2017        -3.401    -7.674    0.4992
# DauphinRiver_2017 - RedRiver_2018        -4.613    -7.421   -1.8996
# DauphinRiver_2017 - SandyBar_2017         2.389     0.634    4.3145
# DauphinRiver_2017 - SandyBar_2018        -0.253    -2.930    2.2657
# DauphinRiver_2017 - WinnipegRiver_2017    3.484    -0.675    7.0965
# DauphinRiver_2018 - Matheson_2017         2.435    -1.205    5.7572
# DauphinRiver_2018 - Matheson_2018         2.782     0.496    5.0646
# DauphinRiver_2018 - RedRiver_2017        -2.046    -6.665    2.2647
# DauphinRiver_2018 - RedRiver_2018        -3.253    -6.477   -0.0527
# DauphinRiver_2018 - SandyBar_2017         3.772     1.325    6.1568
# DauphinRiver_2018 - SandyBar_2018         1.083    -1.869    3.9401
# DauphinRiver_2018 - WinnipegRiver_2017    4.790     0.269    8.8712
# Matheson_2017 - Matheson_2018             0.339    -2.666    3.7703
# Matheson_2017 - RedRiver_2017            -4.450    -9.363    0.3099
# Matheson_2017 - RedRiver_2018            -5.687    -9.323   -1.8089
# Matheson_2017 - SandyBar_2017             1.311    -1.653    4.5644
# Matheson_2017 - SandyBar_2018            -1.315    -4.794    2.2966
# Matheson_2017 - WinnipegRiver_2017        2.386    -2.522    7.0573
# Matheson_2018 - RedRiver_2017            -4.852    -9.287   -0.7584
# Matheson_2018 - RedRiver_2018            -6.049    -9.058   -3.2109
# Matheson_2018 - SandyBar_2017             0.957    -0.980    2.8808
# Matheson_2018 - SandyBar_2018            -1.694    -4.342    0.8503
# Matheson_2018 - WinnipegRiver_2017        2.007    -2.177    5.9260
# RedRiver_2017 - RedRiver_2018            -1.211    -5.788    3.3831
# RedRiver_2017 - SandyBar_2017             5.805     1.951    9.9511
# RedRiver_2017 - SandyBar_2018             3.149    -1.162    7.5824
# RedRiver_2017 - WinnipegRiver_2017        6.860     1.655   12.0458
# RedRiver_2018 - SandyBar_2017             7.013     4.447    9.7579
# RedRiver_2018 - SandyBar_2018             4.357     1.223    7.6238
# RedRiver_2018 - WinnipegRiver_2017        8.064     3.566   12.4041
# SandyBar_2017 - SandyBar_2018            -2.645    -5.186   -0.3531
# SandyBar_2017 - WinnipegRiver_2017        1.084    -3.012    4.4323
# SandyBar_2018 - WinnipegRiver_2017        3.717    -0.804    7.7452
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_succ, ~ Site_Year))
test_met_succ <- plot(emmeans(test_succ, ~ Site_Year)) #### That's the one!!!!!!
test_met_succ
plot(emmeans(test_met_succ, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met_succ, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_succ, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_succ, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
succ_test_plot <- gather_emmeans_draws(emmeans(test_succ, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
succ_test_plot

ggsave("succ_test_plot.png")
ggsave("succ_test_plot.png")
save(test_succ, file = "Succinate_simple_model.RData")

#### Citrate ####
hist(met_dataf$Citrate)
test_cit <- brm(data=met_dataf,
                family = skew_normal,
                bf(Citrate ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,200), class = b),
                          prior(normal(0,200), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_cit)
pp_check(test_cit, ndraws = 100) +
  theme_bw()
summary(test_cit)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Citrate ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           -12.08     42.30   -95.04    71.82 1.00    41615    44027
# sigma_Intercept                       2.98      0.73     1.55     4.42 1.00    38964    42916
# Site_YearDauphinRiver_2018          224.52     47.20   139.94   326.46 1.00    34682    32043
# Site_YearMatheson_2017              -18.49     21.98   -58.66    28.11 1.00    29586    28647
# Site_YearMatheson_2018               64.89     19.15    27.41   103.22 1.00    33120    37784
# Site_YearRedRiver_2017              -57.52     14.70   -87.38   -28.89 1.00    31775    33577
# Site_YearRedRiver_2018               55.39     23.54    11.87   105.42 1.00    39413    38070
# Site_YearSandyBar_2017              -16.86     18.61   -52.45    21.15 1.00    31065    35890
# Site_YearSandyBar_2018               15.08     19.65   -22.23    55.73 1.00    38013    37704
# Site_YearWinnipegRiver_2017         -27.84     22.80   -69.31    21.18 1.00    28787    28370
# K                                   122.51     36.22    51.02   194.14 1.00    45045    44180
# SexM                                  1.99     13.12   -23.97    27.63 1.00    41330    41679
# SexUN                                66.39     57.70   -35.73   192.93 1.00    39081    33326
# sigma_Site_YearDauphinRiver_2018      1.22      0.33     0.59     1.89 1.00    26714    33125
# sigma_Site_YearMatheson_2017         -0.16      0.52    -1.12     0.92 1.00    25932    31395
# sigma_Site_YearMatheson_2018          0.23      0.31    -0.38     0.85 1.00    29404    35551
# sigma_Site_YearRedRiver_2017         -0.16      0.28    -0.71     0.40 1.00    29691    34731
# sigma_Site_YearRedRiver_2018          0.60      0.29     0.02     1.17 1.00    28997    34553
# sigma_Site_YearSandyBar_2017          0.25      0.27    -0.28     0.77 1.00    27022    34168
# sigma_Site_YearSandyBar_2018          0.47      0.29    -0.09     1.04 1.00    27463    32930
# sigma_Site_YearWinnipegRiver_2017    -0.56      0.55    -1.50     0.64 1.00    29294    29756
# sigma_K                               0.69      0.63    -0.53     1.93 1.00    40891    44680
# sigma_SexM                           -0.09      0.26    -0.59     0.41 1.00    38134    42066
# sigma_SexUN                           0.65      0.37    -0.06     1.38 1.00    35026    41493
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     3.20      2.19    -0.70     8.09 1.00    23585    35463
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_cit, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   143.7     102.9       190
# DauphinRiver_2018   367.7     283.1       459
# Matheson_2017       124.7      76.4       182
# Matheson_2018       208.1     164.8       260
# RedRiver_2017        86.2      45.2       133
# RedRiver_2018       198.9     146.9       261
# SandyBar_2017       126.9      81.7       176
# SandyBar_2018       158.7     111.6       211
# WinnipegRiver_2017  115.3      64.2       175
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_cit, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   -221.52   -324.32   -138.92
# DauphinRiver_2017 - Matheson_2017         19.62    -25.29     61.23
# DauphinRiver_2017 - Matheson_2018        -64.70   -101.98    -26.21
# DauphinRiver_2017 - RedRiver_2017         57.28     28.92     87.41
# DauphinRiver_2017 - RedRiver_2018        -54.25   -102.55     -9.67
# DauphinRiver_2017 - SandyBar_2017         17.24    -20.07     53.41
# DauphinRiver_2017 - SandyBar_2018        -14.58    -54.32     23.28
# DauphinRiver_2017 - WinnipegRiver_2017    28.98    -15.76     73.81
# DauphinRiver_2018 - Matheson_2017        240.49    148.04    342.36
# DauphinRiver_2018 - Matheson_2018        156.77     69.71    257.29
# DauphinRiver_2018 - RedRiver_2017        279.06    192.23    378.56
# DauphinRiver_2018 - RedRiver_2018        167.10     70.73    273.38
# DauphinRiver_2018 - SandyBar_2017        238.34    147.86    336.39
# DauphinRiver_2018 - SandyBar_2018        207.15    114.92    307.07
# DauphinRiver_2018 - WinnipegRiver_2017   250.15    153.91    352.36
# Matheson_2017 - Matheson_2018            -84.46   -130.05    -35.60
# Matheson_2017 - RedRiver_2017             37.57     -4.93     85.00
# Matheson_2017 - RedRiver_2018            -73.47   -135.77    -15.70
# Matheson_2017 - SandyBar_2017             -2.42    -46.04     44.29
# Matheson_2017 - SandyBar_2018            -33.66    -85.78     17.61
# Matheson_2017 - WinnipegRiver_2017         8.95    -47.73     70.68
# Matheson_2018 - RedRiver_2017            122.23     82.96    161.49
# Matheson_2018 - RedRiver_2018             10.13    -45.87     61.35
# Matheson_2018 - SandyBar_2017             81.96     38.65    122.44
# Matheson_2018 - SandyBar_2018             50.08      4.16     96.26
# Matheson_2018 - WinnipegRiver_2017        93.80     40.02    144.87
# RedRiver_2017 - RedRiver_2018           -111.97   -162.11    -67.79
# RedRiver_2017 - SandyBar_2017            -40.20    -77.13     -4.37
# RedRiver_2017 - SandyBar_2018            -72.01   -113.56    -32.77
# RedRiver_2017 - WinnipegRiver_2017       -28.58    -72.66     11.18
# RedRiver_2018 - SandyBar_2017             71.57     17.28    129.21
# RedRiver_2018 - SandyBar_2018             39.48     -9.36     92.26
# RedRiver_2018 - WinnipegRiver_2017        83.68     25.79    140.91
# SandyBar_2017 - SandyBar_2018            -31.68    -79.33     15.65
# SandyBar_2017 - WinnipegRiver_2017        11.55    -39.11     61.78
# SandyBar_2018 - WinnipegRiver_2017        43.71    -10.72     96.28
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_cit, ~ Site_Year))
test_met_cit <- plot(emmeans(test_cit, ~ Site_Year)) #### That's the one!!!!!!
test_met_cit
plot(emmeans(test_met_cit, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met_cit, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_cit, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_cit, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
cit_test_plot <- gather_emmeans_draws(emmeans(test_cit, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +citheme_bw(base_size = 18)
cit_test_plot <- gather_emmeans_draws(emmeans(test_cit, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
cit_test_plot

ggsave("cit_test_plot.png")
save(test_cit, file = "Citrate_simple_model.RData")
load(Citrate_simple_model.RData)
#### Malate ####
hist(met_dataf$Malate)
test_mal <- brm(data=met_dataf,
                family = skew_normal,
                bf(Malate ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,75), class = b),
                          prior(normal(0,75), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_mal)
pp_check(test_mal, ndraws = 100) +
  theme_bw()
summary(test_mal)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Malate ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            47.50      9.19    29.01    65.25 1.00    23015    27952
# sigma_Intercept                       1.11      0.84    -0.56     2.73 1.00    27850    36282
# Site_YearDauphinRiver_2018          -47.28      5.46   -58.56   -36.85 1.00    18324    20404
# Site_YearMatheson_2017              -13.56      8.16   -28.92     2.93 1.00    21236    25950
# Site_YearMatheson_2018              -45.98      5.42   -57.46   -35.92 1.00    17920    20468
# Site_YearRedRiver_2017               10.07      9.71    -7.90    30.44 1.00    32386    34512
# Site_YearRedRiver_2018              -49.63      5.83   -61.16   -38.03 1.00    22508    26167
# Site_YearSandyBar_2017               -0.89      7.58   -15.36    14.49 1.00    24763    31037
# Site_YearSandyBar_2018              -55.15      5.10   -66.01   -45.95 1.00    17248    19329
# Site_YearWinnipegRiver_2017          -3.47     11.35   -23.48    20.78 1.00    23752    21231
# K                                    15.40      6.60     4.03    29.99 1.00    35626    32432
# SexM                                  3.54      1.90    -0.26     7.34 1.00    40414    38108
# SexUN                                -0.37      5.00    -8.59    10.85 1.00    35313    31368
# sigma_Site_YearDauphinRiver_2018     -0.99      0.36    -1.65    -0.24 1.00    25542    33628
# sigma_Site_YearMatheson_2017         -0.36      0.46    -1.17     0.62 1.00    25309    27316
# sigma_Site_YearMatheson_2018         -0.92      0.33    -1.55    -0.27 1.00    25752    35145
# sigma_Site_YearRedRiver_2017          0.26      0.28    -0.29     0.81 1.00    27922    36383
# sigma_Site_YearRedRiver_2018         -0.25      0.29    -0.81     0.32 1.00    31065    37386
# sigma_Site_YearSandyBar_2017          0.12      0.26    -0.39     0.62 1.00    27563    34719
# sigma_Site_YearSandyBar_2018         -1.92      0.35    -2.58    -1.20 1.00    25952    32717
# sigma_Site_YearWinnipegRiver_2017    -0.72      0.54    -1.65     0.49 1.00    25541    23002
# sigma_K                               1.83      0.70     0.50     3.24 1.00    31916    39793
# sigma_SexM                           -0.20      0.22    -0.63     0.22 1.00    37102    41445
# sigma_SexUN                           0.59      0.40    -0.21     1.37 1.00    33577    36975
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.05      1.88     2.33     9.60 1.00    36006    30511
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 1 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
emmeans(test_mal, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   65.14     55.80      75.6
# DauphinRiver_2018   17.98     13.07      23.5
# Matheson_2017       51.29     39.91      65.5
# Matheson_2018       19.25     13.91      25.2
# RedRiver_2017       75.04     58.17      93.6
# RedRiver_2018       15.38      7.35      24.8
# SandyBar_2017       64.22     52.50      77.1
# SandyBar_2018        9.97      6.42      14.8
# WinnipegRiver_2017  60.94     42.95      83.8
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_mal, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     47.11     36.33     57.99
# DauphinRiver_2017 - Matheson_2017         13.74     -2.28     29.45
# DauphinRiver_2017 - Matheson_2018         45.72     35.41     56.83
# DauphinRiver_2017 - RedRiver_2017         -9.67    -29.64      8.58
# DauphinRiver_2017 - RedRiver_2018         49.63     38.49     61.56
# DauphinRiver_2017 - SandyBar_2017          1.03    -14.30     15.48
# DauphinRiver_2017 - SandyBar_2018         54.85     45.65     65.62
# DauphinRiver_2017 - WinnipegRiver_2017     4.07    -19.22     24.62
# DauphinRiver_2018 - Matheson_2017        -33.28    -47.73    -20.67
# DauphinRiver_2018 - Matheson_2018         -1.47     -7.40      5.17
# DauphinRiver_2018 - RedRiver_2017        -56.90    -76.41    -39.71
# DauphinRiver_2018 - RedRiver_2018          2.63     -8.07     11.79
# DauphinRiver_2018 - SandyBar_2017        -46.18    -60.07    -33.36
# DauphinRiver_2018 - SandyBar_2018          7.58      2.06     14.23
# DauphinRiver_2018 - WinnipegRiver_2017   -42.97    -65.90    -24.14
# Matheson_2017 - Matheson_2018             31.83     19.91     45.88
# Matheson_2017 - RedRiver_2017            -23.51    -46.13     -2.16
# Matheson_2017 - RedRiver_2018             36.07     20.40     50.84
# Matheson_2017 - SandyBar_2017            -12.70    -30.33      4.89
# Matheson_2017 - SandyBar_2018             40.96     30.10     54.91
# Matheson_2017 - WinnipegRiver_2017        -9.64    -34.48     14.07
# Matheson_2018 - RedRiver_2017            -55.61    -74.70    -37.86
# Matheson_2018 - RedRiver_2018              4.06     -6.52     13.13
# Matheson_2018 - SandyBar_2017            -44.82    -58.05    -32.07
# Matheson_2018 - SandyBar_2018              9.10      4.19     14.43
# Matheson_2018 - WinnipegRiver_2017       -41.64    -64.28    -22.52
# RedRiver_2017 - RedRiver_2018             59.32     41.40     78.29
# RedRiver_2017 - SandyBar_2017             10.83     -9.94     31.52
# RedRiver_2017 - SandyBar_2018             64.76     47.44     83.77
# RedRiver_2017 - WinnipegRiver_2017        13.77    -12.01     40.76
# RedRiver_2018 - SandyBar_2017            -48.59    -62.78    -35.04
# RedRiver_2018 - SandyBar_2018              4.94     -2.67     15.01
# RedRiver_2018 - WinnipegRiver_2017       -45.52    -69.19    -25.88
# SandyBar_2017 - SandyBar_2018             53.94     41.78     67.32
# SandyBar_2017 - WinnipegRiver_2017         3.08    -21.57     25.31
# SandyBar_2018 - WinnipegRiver_2017       -50.71    -73.83    -32.81
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_mal, ~ Site_Year))
test_met_mal <- plot(emmeans(test_mal, ~ Site_Year)) #### That's the one!!!!!!
test_met_mal
plot(emmeans(test_met_mal, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met_mal, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_mal, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_mal, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
mal_test_plot <- gather_emmeans_draws(emmeans(test_mal, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
mal_test_plot

ggsave("mal_test_plot.png")
ggsave("mal_test_plot.png")
save(test_mal, file = "Malate_simple_model.RData")

#### Citrulline ####
hist(met_dataf$Citrulline)
test_citr <- brm(data=met_dataf,
                family = student,
                bf(Citrulline ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,100), class = b),
                          prior(normal(0,100), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_citr)
pp_check(test_citr, ndraws = 100) +
  theme_bw()
summary(test_citr)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Citrulline ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            29.92      5.51    19.38    40.43 1.00     9560    16652
# sigma_Intercept                       1.83      1.38    -0.87     4.52 1.00    21246    25196
# Site_YearDauphinRiver_2018          -10.06      6.24   -22.03     1.98 1.00    10482    20170
# Site_YearMatheson_2017              -20.14      9.31   -36.21     0.43 1.00    13482    17806
# Site_YearMatheson_2018              -25.42      5.54   -35.97   -14.76 1.00     9360    16877
# Site_YearRedRiver_2017              -27.19      5.36   -37.38   -16.96 1.00     9078    16016
# Site_YearRedRiver_2018              -27.94      5.42   -38.26   -17.58 1.00     9163    16550
# Site_YearSandyBar_2017              -26.30      5.45   -36.66   -15.77 1.00     9133    16027
# Site_YearSandyBar_2018              -28.23      5.41   -38.51   -17.88 1.00     9115    16477
# Site_YearWinnipegRiver_2017         -28.49      5.37   -38.72   -18.24 1.00     9053    16029
# K                                     1.38      1.19    -1.52     3.37 1.00    32480    23597
# SexM                                 98.56     23.47    30.09   140.48 1.00    12815     5760
# SexUN                                 0.75      2.11    -4.13     4.50 1.00    25765    17972
# sigma_Site_YearDauphinRiver_2018     -0.14      0.59    -1.28     1.01 1.00    18888    20879
# sigma_Site_YearMatheson_2017         -0.50      0.72    -1.92     0.93 1.00    18760    18170
# sigma_Site_YearMatheson_2018         -0.90      0.55    -1.97     0.19 1.00    19663    23534
# sigma_Site_YearRedRiver_2017         -2.56      0.51    -3.55    -1.57 1.00    21732    21577
# sigma_Site_YearRedRiver_2018         -1.63      0.52    -2.64    -0.61 1.00    19474    25779
# sigma_Site_YearSandyBar_2017         -1.18      0.49    -2.15    -0.22 1.00    16731    21036
# sigma_Site_YearSandyBar_2018         -2.11      0.56    -3.21    -0.99 1.00    14172    17868
# sigma_Site_YearWinnipegRiver_2017    -3.81      0.89    -5.55    -2.03 1.00    12158     6539
# sigma_K                               0.30      1.18    -2.05     2.61 1.00    22939    24905
# sigma_SexM                            3.45      0.36     2.73     4.15 1.00    17277    14309
# sigma_SexUN                           0.00      0.58    -1.17     1.13 1.00    27614    25794
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     1.40      0.29     1.02     2.09 1.00    16623    10780
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_citr, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    65.1      45.4      84.0
# DauphinRiver_2018    55.1      37.4      72.3
# Matheson_2017        44.2      22.5      69.5
# Matheson_2018        39.8      23.2      56.6
# RedRiver_2017        38.1      21.5      54.5
# RedRiver_2018        37.4      20.3      53.3
# SandyBar_2017        39.0      21.4      55.0
# SandyBar_2018        37.0      20.9      53.8
# WinnipegRiver_2017   36.8      20.0      53.1
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_citr, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    10.040    -1.724    22.252
# DauphinRiver_2017 - Matheson_2017        20.908     0.485    36.904
# DauphinRiver_2017 - Matheson_2018        25.325    14.967    36.113
# DauphinRiver_2017 - RedRiver_2017        27.123    17.353    37.672
# DauphinRiver_2017 - RedRiver_2018        27.876    17.875    38.496
# DauphinRiver_2017 - SandyBar_2017        26.232    15.916    36.756
# DauphinRiver_2017 - SandyBar_2018        28.151    18.259    38.833
# DauphinRiver_2017 - WinnipegRiver_2017   28.428    18.580    38.966
# DauphinRiver_2018 - Matheson_2017        11.071    -8.602    24.342
# DauphinRiver_2018 - Matheson_2018        15.360     8.507    22.102
# DauphinRiver_2018 - RedRiver_2017        17.123    10.621    23.332
# DauphinRiver_2018 - RedRiver_2018        17.876    11.423    24.472
# DauphinRiver_2018 - SandyBar_2017        16.228     9.644    22.792
# DauphinRiver_2018 - SandyBar_2018        18.153    11.741    24.408
# DauphinRiver_2018 - WinnipegRiver_2017   18.434    11.947    24.699
# Matheson_2017 - Matheson_2018             4.155    -7.139    23.598
# Matheson_2017 - RedRiver_2017             5.888    -4.906    25.479
# Matheson_2017 - RedRiver_2018             6.626    -4.294    26.263
# Matheson_2017 - SandyBar_2017             5.030    -5.969    24.642
# Matheson_2017 - SandyBar_2018             6.918    -4.033    26.447
# Matheson_2017 - WinnipegRiver_2017        7.185    -3.923    26.390
# Matheson_2018 - RedRiver_2017             1.656    -1.009     4.814
# Matheson_2018 - RedRiver_2018             2.447    -0.659     5.882
# Matheson_2018 - SandyBar_2017             0.806    -2.427     4.397
# Matheson_2018 - SandyBar_2018             2.724    -0.274     6.011
# Matheson_2018 - WinnipegRiver_2017        2.967     0.209     6.160
# RedRiver_2017 - RedRiver_2018             0.807    -0.949     2.253
# RedRiver_2017 - SandyBar_2017            -0.831    -2.895     1.020
# RedRiver_2017 - SandyBar_2018             1.131    -0.559     2.424
# RedRiver_2017 - WinnipegRiver_2017        1.323     0.559     1.985
# RedRiver_2018 - SandyBar_2017            -1.625    -4.046     0.834
# RedRiver_2018 - SandyBar_2018             0.311    -1.840     2.342
# RedRiver_2018 - WinnipegRiver_2017        0.491    -1.024     2.233
# SandyBar_2017 - SandyBar_2018             1.934    -0.465     4.255
# SandyBar_2017 - WinnipegRiver_2017        2.141     0.143     4.186
# SandyBar_2018 - WinnipegRiver_2017        0.184    -1.203     1.968
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_citr, ~ Site_Year))
test_met_citr <- plot(emmeans(test_citr, ~ Site_Year)) #### That's the one!!!!!!
test_met_citr
plot(emmeans(test_met_citr, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met_citr, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_citr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_citr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
citr_test_plot <- gather_emmeans_draws(emmeans(test_citr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
citr_test_plot
p1 <- citr_test_plot
ggsave("citr_test_plot.png")
ggsave("citr_test_plot.png")
save(test_citr, file = "Citrulline_simple_model.RData")

#### Ornithine ####
hist(met_dataf$Ornithine)
test_orn <- brm(data=met_dataf,
                family = student,
                bf(Ornithine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,30), class = b),
                          prior(normal(0,30), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_orn)
pp_check(test_orn, ndraws = 100) +
  theme_bw()
summary(test_orn)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Ornithine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            24.71      6.20    12.58    37.06 1.00    22804    33191
# sigma_Intercept                       1.50      1.01    -0.48     3.46 1.00    27979    35893
# Site_YearDauphinRiver_2018          -24.55      3.75   -32.08   -17.22 1.00    13841    20237
# Site_YearMatheson_2017                1.24      5.39    -9.31    11.80 1.00    20382    29757
# Site_YearMatheson_2018              -24.20      3.79   -31.74   -16.80 1.00    14062    21139
# Site_YearRedRiver_2017               -5.91      4.22   -14.23     2.44 1.00    15676    24281
# Site_YearRedRiver_2018              -21.15      4.27   -29.45   -12.57 1.00    16608    25689
# Site_YearSandyBar_2017               -0.22      4.23    -8.51     8.25 1.00    17111    25799
# Site_YearSandyBar_2018              -23.39      3.99   -31.19   -15.48 1.00    14766    22686
# Site_YearWinnipegRiver_2017           2.57      7.47   -12.83    16.41 1.00    23598    28993
# K                                     4.06      4.48    -4.87    12.79 1.00    42983    43301
# SexM                                 -2.36      1.82    -6.13     0.95 1.00    38400    39490
# SexUN                                -2.60      1.16    -4.86    -0.28 1.00    49551    41997
# sigma_Site_YearDauphinRiver_2018     -1.68      0.38    -2.40    -0.89 1.00    22025    29689
# sigma_Site_YearMatheson_2017         -0.50      0.51    -1.41     0.59 1.00    30208    32402
# sigma_Site_YearMatheson_2018         -1.63      0.40    -2.40    -0.83 1.00    23268    31880
# sigma_Site_YearRedRiver_2017         -0.82      0.34    -1.46    -0.13 1.00    24070    30572
# sigma_Site_YearRedRiver_2018         -0.59      0.34    -1.24     0.10 1.00    27250    33481
# sigma_Site_YearSandyBar_2017         -0.51      0.31    -1.13     0.12 1.00    25423    34908
# sigma_Site_YearSandyBar_2018         -0.93      0.35    -1.60    -0.23 1.00    27818    37149
# sigma_Site_YearWinnipegRiver_2017    -0.63      0.58    -1.68     0.62 1.00    29252    31979
# sigma_K                               1.07      0.83    -0.58     2.69 1.00    32896    39751
# sigma_SexM                           -0.22      0.27    -0.78     0.31 1.00    32740    35836
# sigma_SexUN                          -0.32      0.37    -1.04     0.43 1.00    48161    41965
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    13.83     11.47     2.78    45.39 1.00    24559    30331
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_orn, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   27.47    20.282     34.61
# DauphinRiver_2018    3.01     1.012      4.76
# Matheson_2017       28.74    20.571     36.85
# Matheson_2018        3.31     0.907      5.63
# RedRiver_2017       21.62    17.292     25.88
# RedRiver_2018        6.26     1.758     11.20
# SandyBar_2017       27.24    22.639     31.99
# SandyBar_2018        4.11     0.724      7.50
# WinnipegRiver_2017  30.33    16.882     42.45
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_orn, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    24.493     17.00    31.834
# DauphinRiver_2017 - Matheson_2017        -1.259    -11.88     9.225
# DauphinRiver_2017 - Matheson_2018        24.174     16.94    31.855
# DauphinRiver_2017 - RedRiver_2017         5.902     -2.47    14.191
# DauphinRiver_2017 - RedRiver_2018        21.209     12.67    29.532
# DauphinRiver_2017 - SandyBar_2017         0.228     -7.99     8.732
# DauphinRiver_2017 - SandyBar_2018        23.404     15.50    31.207
# DauphinRiver_2017 - WinnipegRiver_2017   -2.816    -16.77    12.397
# DauphinRiver_2018 - Matheson_2017       -25.770    -34.14   -17.452
# DauphinRiver_2018 - Matheson_2018        -0.330     -2.61     1.764
# DauphinRiver_2018 - RedRiver_2017       -18.649    -23.30   -13.855
# DauphinRiver_2018 - RedRiver_2018        -3.283     -8.78     1.878
# DauphinRiver_2018 - SandyBar_2017       -24.281    -29.41   -19.454
# DauphinRiver_2018 - SandyBar_2018        -1.143     -5.31     2.812
# DauphinRiver_2018 - WinnipegRiver_2017  -27.376    -39.61   -13.716
# Matheson_2017 - Matheson_2018            25.415     16.72    33.523
# Matheson_2017 - RedRiver_2017             7.157     -1.95    16.629
# Matheson_2017 - RedRiver_2018            22.361     13.23    31.351
# Matheson_2017 - SandyBar_2017             1.480     -7.81    10.805
# Matheson_2017 - SandyBar_2018            24.557     16.10    33.187
# Matheson_2017 - WinnipegRiver_2017       -1.516    -16.63    14.228
# Matheson_2018 - RedRiver_2017           -18.315    -23.19   -13.350
# Matheson_2018 - RedRiver_2018            -2.955     -8.47     2.224
# Matheson_2018 - SandyBar_2017           -23.940    -29.05   -18.879
# Matheson_2018 - SandyBar_2018            -0.807     -4.85     3.409
# Matheson_2018 - WinnipegRiver_2017      -27.058    -39.17   -13.159
# RedRiver_2017 - RedRiver_2018            15.311      8.42    21.834
# RedRiver_2017 - SandyBar_2017            -5.676    -11.58     0.152
# RedRiver_2017 - SandyBar_2018            17.479     11.76    23.222
# RedRiver_2017 - WinnipegRiver_2017       -8.682    -21.32     4.857
# RedRiver_2018 - SandyBar_2017           -21.018    -27.75   -14.067
# RedRiver_2018 - SandyBar_2018             2.145     -2.48     7.074
# RedRiver_2018 - WinnipegRiver_2017      -23.944    -36.81    -9.325
# SandyBar_2017 - SandyBar_2018            23.175     17.42    29.023
# SandyBar_2017 - WinnipegRiver_2017       -2.984    -15.90    10.620
# SandyBar_2018 - WinnipegRiver_2017      -26.169    -39.24   -12.637
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_orn, ~ Site_Year))
test_met_orn <- plot(emmeans(test_orn, ~ Site_Year)) #### That's the one!!!!!!
test_met_orn
plot(emmeans(test_met_orn, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met_orn, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_orn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_orn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
orn_test_plot <- gather_emmeans_draws(emmeans(test_orn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
orn_test_plot
p2<- orn_test_plot
ggsave("orn_test_plot.png")
ggsave("orn_test_plot.png")
save(test_orn, file = "Ornithine_simple_model.RData")


#### Creatine ####
hist(met_dataf$Creatine)
test_crea <- brm(data=met_dataf,
                family = student,
                bf(Creatine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,500), class = b),
                          prior(normal(0,500), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_crea)
pp_check(test_crea, ndraws = 100) +
  theme_bw()
summary(test_crea)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Creatine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                           247.74    180.91   -98.08   618.43 1.00    30166    33113
# sigma_Intercept                       4.48      1.33     1.93     7.13 1.00    30026    38099
# Site_YearDauphinRiver_2018          217.92    121.36   -13.75   465.86 1.00    38682    38663
# Site_YearMatheson_2017              -66.26    192.14  -410.77   382.81 1.00    36826    25931
# Site_YearMatheson_2018              207.49    119.16   -30.86   434.24 1.00    33414    39012
# Site_YearRedRiver_2017             -210.93     59.99  -329.35   -90.83 1.00    30268    34403
# Site_YearRedRiver_2018             -134.28     58.70  -250.09   -17.48 1.00    30247    33885
# Site_YearSandyBar_2017             -101.64     69.53  -235.38    38.76 1.00    32446    38880
# Site_YearSandyBar_2018             -190.23     65.59  -322.55   -63.12 1.00    32562    35593
# Site_YearWinnipegRiver_2017          27.97    149.70  -276.08   315.94 1.00    37414    34361
# K                                   138.38    149.35  -153.99   438.87 1.00    33213    36550
# SexM                                 70.28     54.33   -31.38   182.18 1.00    38750    39828
# SexUN                               -31.29    152.83  -295.27   316.81 1.00    40884    33337
# sigma_Site_YearDauphinRiver_2018      0.67      0.45    -0.18     1.57 1.00    28306    35852
# sigma_Site_YearMatheson_2017          0.70      0.67    -0.59     2.01 1.00    28958    38572
# sigma_Site_YearMatheson_2018          0.70      0.45    -0.19     1.57 1.00    26519    35701
# sigma_Site_YearRedRiver_2017         -0.42      0.47    -1.38     0.46 1.00    28329    36981
# sigma_Site_YearRedRiver_2018         -0.53      0.42    -1.39     0.26 1.00    29331    37162
# sigma_Site_YearSandyBar_2017          0.09      0.37    -0.66     0.80 1.00    30364    39392
# sigma_Site_YearSandyBar_2018         -0.37      0.40    -1.17     0.42 1.00    31460    39226
# sigma_Site_YearWinnipegRiver_2017     0.30      0.65    -0.90     1.65 1.00    38120    37533
# sigma_K                               0.39      1.12    -1.86     2.53 1.00    33190    39657
# sigma_SexM                            0.54      0.32    -0.09     1.17 1.00    32865    38609
# sigma_SexUN                           0.43      0.45    -0.45     1.31 1.00    41594    42618
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     3.88      4.06     1.46    14.23 1.00    22622    28087
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_crea, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017     409     273.1       559
# DauphinRiver_2018     629     413.2       849
# Matheson_2017         326     -22.1       780
# Matheson_2018         617     401.9       847
# RedRiver_2017         194      76.4       346
# RedRiver_2018         273     159.6       413
# SandyBar_2017         305     168.1       461
# SandyBar_2018         215     105.7       355
# WinnipegRiver_2017    443     148.1       747
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_crea, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   -215.08    -451.3      26.8
# DauphinRiver_2017 - Matheson_2017         84.25    -351.3     436.3
# DauphinRiver_2017 - Matheson_2018       -209.56    -440.7      23.9
# DauphinRiver_2017 - RedRiver_2017        211.02      96.7     335.1
# DauphinRiver_2017 - RedRiver_2018        134.24      18.5     251.0
# DauphinRiver_2017 - SandyBar_2017        102.75     -35.2     238.7
# DauphinRiver_2017 - SandyBar_2018        189.35      59.5     318.1
# DauphinRiver_2017 - WinnipegRiver_2017   -31.81    -319.2     272.3
# DauphinRiver_2018 - Matheson_2017        297.90    -181.5     709.5
# DauphinRiver_2018 - Matheson_2018          6.48    -273.9     313.2
# DauphinRiver_2018 - RedRiver_2017        425.89     194.6     660.0
# DauphinRiver_2018 - RedRiver_2018        348.36     124.6     588.0
# DauphinRiver_2018 - SandyBar_2017        316.71      81.8     563.9
# DauphinRiver_2018 - SandyBar_2018        404.84     184.8     643.3
# DauphinRiver_2018 - WinnipegRiver_2017   185.59    -162.9     551.1
# Matheson_2017 - Matheson_2018           -288.25    -692.3     172.4
# Matheson_2017 - RedRiver_2017            126.49    -226.1     566.0
# Matheson_2017 - RedRiver_2018             49.78    -306.7     480.8
# Matheson_2017 - SandyBar_2017             18.73    -339.2     459.6
# Matheson_2017 - SandyBar_2018            104.32    -247.2     550.9
# Matheson_2017 - WinnipegRiver_2017      -109.28    -555.7     404.7
# Matheson_2018 - RedRiver_2017            420.35     186.8     640.0
# Matheson_2018 - RedRiver_2018            342.60     123.9     566.9
# Matheson_2018 - SandyBar_2017            310.31      83.5     537.7
# Matheson_2018 - SandyBar_2018            398.35     174.4     614.8
# Matheson_2018 - WinnipegRiver_2017       175.92    -154.7     526.3
# RedRiver_2017 - RedRiver_2018            -77.35    -173.3      21.9
# RedRiver_2017 - SandyBar_2017           -108.43    -231.3      10.2
# RedRiver_2017 - SandyBar_2018            -23.57    -131.6     103.2
# RedRiver_2017 - WinnipegRiver_2017      -242.48    -520.5      56.2
# RedRiver_2018 - SandyBar_2017            -31.06    -157.6      81.5
# RedRiver_2018 - SandyBar_2018             54.39     -53.0     169.1
# RedRiver_2018 - WinnipegRiver_2017      -165.77    -442.9     128.4
# SandyBar_2017 - SandyBar_2018             86.46     -41.2     220.9
# SandyBar_2017 - WinnipegRiver_2017      -133.33    -414.5     179.6
# SandyBar_2018 - WinnipegRiver_2017      -220.99    -513.8      77.5
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_crea, ~ Site_Year))
test_met_crea <- plot(emmeans(test_crea, ~ Site_Year)) #### That's the one!!!!!!
test_met_crea
plot(emmeans(test_met_crea, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met_crea, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_crea, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_crea, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
crea_test_plot <- gather_emmeans_draws(emmeans(test_crea, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
crea_test_plot
p3<- crea_test_plot
ggsave("crea_test_plot.png")
ggsave("crea_test_plot.png")
save(test_crea, file = "Creatinee_simple_model.RData")

#### Creatinine ####
hist(met_dataf$Creatinine)
test_crn <- brm(data=met_dataf,
                family = skew_normal,
                bf(Creatinine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,13), class = b),
                          prior(normal(0,13), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_crn)
pp_check(test_crn, ndraws = 100) +
  theme_bw()
summary(test_crn)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Creatinine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             7.81      2.92     2.08    13.62 1.00    32180    40738
# sigma_Intercept                       0.62      0.82    -0.94     2.27 1.00    22908    32209
# Site_YearDauphinRiver_2018            5.08      2.15     1.32     9.83 1.00    30846    31037
# Site_YearMatheson_2017                0.16      2.01    -3.58     4.30 1.00    30791    24698
# Site_YearMatheson_2018                3.19      1.61     0.08     6.41 1.00    38644    38769
# Site_YearRedRiver_2017               -2.02      1.17    -4.29     0.34 1.00    28516    37643
# Site_YearRedRiver_2018               -3.18      0.90    -4.96    -1.40 1.00    27715    33424
# Site_YearSandyBar_2017               -0.85      1.08    -2.93     1.35 1.00    30778    35936
# Site_YearSandyBar_2018               -3.61      1.05    -5.66    -1.50 1.00    33305    36568
# Site_YearWinnipegRiver_2017          -1.05      2.93    -6.60     5.29 1.00    32050    23683
# K                                     2.19      2.56    -2.81     7.27 1.00    30221    39101
# SexM                                 -0.21      1.05    -2.26     1.90 1.00    34360    41021
# SexUN                                -2.61      2.68    -7.25     3.23 1.00    32169    31900
# sigma_Site_YearDauphinRiver_2018      0.94      0.40     0.17     1.73 1.00    19629    30835
# sigma_Site_YearMatheson_2017          0.34      0.47    -0.49     1.35 1.00    24094    27330
# sigma_Site_YearMatheson_2018          0.89      0.35     0.18     1.56 1.00    20312    29273
# sigma_Site_YearRedRiver_2017          0.47      0.30    -0.12     1.05 1.00    22057    31440
# sigma_Site_YearRedRiver_2018         -0.18      0.29    -0.75     0.39 1.00    24458    33415
# sigma_Site_YearSandyBar_2017          0.42      0.27    -0.13     0.95 1.00    24107    31569
# sigma_Site_YearSandyBar_2018          0.13      0.30    -0.46     0.72 1.00    23162    34522
# sigma_Site_YearWinnipegRiver_2017     0.76      0.53    -0.15     1.92 1.00    26471    27096
# sigma_K                               0.12      0.65    -1.16     1.38 1.00    29283    37453
# sigma_SexM                            0.69      0.20     0.30     1.07 1.00    33954    39559
# sigma_SexUN                           0.34      0.40    -0.45     1.11 1.00    30457    38219
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     1.46      1.18    -0.95     3.71 1.00    27552    35407
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_crn, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    9.22      7.13     11.55
# DauphinRiver_2018   14.27     10.84     18.20
# Matheson_2017        9.35      5.42     13.69
# Matheson_2018       12.38      9.13     15.86
# RedRiver_2017        7.20      4.71     10.02
# RedRiver_2018        6.03      3.98      8.28
# SandyBar_2017        8.37      5.91     10.91
# SandyBar_2018        5.57      3.44      8.05
# WinnipegRiver_2017   8.10      2.43     14.61
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_crn, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   -4.9111    -9.470   -1.0493
# DauphinRiver_2017 - Matheson_2017       -0.0987    -4.112    3.7450
# DauphinRiver_2017 - Matheson_2018       -3.1711    -6.356   -0.0381
# DauphinRiver_2017 - RedRiver_2017        2.0345    -0.329    4.3001
# DauphinRiver_2017 - RedRiver_2018        3.1855     1.414    4.9717
# DauphinRiver_2017 - SandyBar_2017        0.8714    -1.258    3.0171
# DauphinRiver_2017 - SandyBar_2018        3.6230     1.556    5.7098
# DauphinRiver_2017 - WinnipegRiver_2017   1.1566    -5.055    6.7575
# DauphinRiver_2018 - Matheson_2017        4.8396    -0.452   10.5943
# DauphinRiver_2018 - Matheson_2018        1.7896    -2.910    6.9206
# DauphinRiver_2018 - RedRiver_2017        6.9521     2.687   11.8212
# DauphinRiver_2018 - RedRiver_2018        8.0977     4.243   12.7863
# DauphinRiver_2018 - SandyBar_2017        5.7717     1.698   10.5979
# DauphinRiver_2018 - SandyBar_2018        8.5495     4.423   13.0908
# DauphinRiver_2018 - WinnipegRiver_2017   6.1137    -0.737   13.3735
# Matheson_2017 - Matheson_2018           -3.0656    -7.805    1.7601
# Matheson_2017 - RedRiver_2017            2.1360    -1.943    6.3366
# Matheson_2017 - RedRiver_2018            3.2946    -0.563    7.2239
# Matheson_2017 - SandyBar_2017            0.9698    -3.018    5.1742
# Matheson_2017 - SandyBar_2018            3.7091    -0.372    7.7453
# Matheson_2017 - WinnipegRiver_2017       1.2907    -5.605    8.2924
# Matheson_2018 - RedRiver_2017            5.1981     1.603    8.9945
# Matheson_2018 - RedRiver_2018            6.3523     3.170    9.7376
# Matheson_2018 - SandyBar_2017            4.0271     0.601    7.5255
# Matheson_2018 - SandyBar_2018            6.7823     3.444   10.2329
# Matheson_2018 - WinnipegRiver_2017       4.2865    -2.252   10.6882
# RedRiver_2017 - RedRiver_2018            1.1601    -0.975    3.3491
# RedRiver_2017 - SandyBar_2017           -1.1661    -3.733    1.2122
# RedRiver_2017 - SandyBar_2018            1.5742    -0.817    4.2011
# RedRiver_2017 - WinnipegRiver_2017      -0.8264    -7.323    4.7986
# RedRiver_2018 - SandyBar_2017           -2.3225    -4.448   -0.3199
# RedRiver_2018 - SandyBar_2018            0.4258    -1.662    2.4333
# RedRiver_2018 - WinnipegRiver_2017      -2.0093    -8.214    3.5823
# SandyBar_2017 - SandyBar_2018            2.7536     0.384    5.1458
# SandyBar_2017 - WinnipegRiver_2017       0.3118    -5.930    6.0823
# SandyBar_2018 - WinnipegRiver_2017      -2.4563    -8.914    3.2338
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_crn, ~ Site_Year))
test_met_crn <- plot(emmeans(test_crn, ~ Site_Year)) #### That's the one!!!!!!
test_met_crn
plot(emmeans(test_met_crn, ~ Sex*Site_Year))
plot(pairs(emmeans(test_met_crn, ~ Site_Year)))
gather_emmeans_draws(emmeans(test_crn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test_crn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
crn_test_plot <- gather_emmeans_draws(emmeans(test_crn, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
crn_test_plot
p4<- crn_test_plot
ggsave("crn_test_plot.png")
ggsave("crn_test_plot.png")
save(test_crn, file = "Creatinine_simple_model.RData")

#### C4OH ####
hist(carn_dataf$C4OH)
test_hist(carn_dataf$C4OH)
test_C4OH<- brm(data=carn_dataf,
               family = student,
               bf(C4OH ~ Site_Year + K + Sex,
                  sigma ~ Site_Year + K + Sex),
               prior = c(prior(normal(0,0.002), class = b),
                         prior(normal(0,0.002), class = Intercept)),
               iter = 20000, warmup = 5000, chains = 4, cores = 4,
               control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C4OH)
pp_check(test_C4OH, ndraws = 100) +
  theme_bw()
summary(test_C4OH)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C4OH ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    55062    47391
# sigma_Intercept                      -8.15      1.07   -10.25    -6.05 1.00    25413    33361
# Site_YearDauphinRiver_2018            0.00      0.00    -0.00     0.00 1.00    55989    49235
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    51158    42002
# Site_YearMatheson_2018                0.00      0.00    -0.00     0.00 1.00    55027    46491
# Site_YearRedRiver_2017               -0.00      0.00    -0.00    -0.00 1.00    52655    49921
# Site_YearRedRiver_2018               -0.00      0.00    -0.00     0.00 1.00    54556    52455
# Site_YearSandyBar_2017               -0.00      0.00    -0.00    -0.00 1.00    53700    48855
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    53954    48507
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    56098    45072
# K                                     0.00      0.00    -0.00     0.00 1.00    53730    45500
# SexM                                  0.00      0.00    -0.00     0.00 1.00    56331    54488
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    55211    28618
# sigma_Site_YearDauphinRiver_2018      0.33      0.44    -0.52     1.22 1.00    20854    31926
# sigma_Site_YearMatheson_2017         -0.51      0.78    -2.05     1.00 1.00    19072    14581
# sigma_Site_YearMatheson_2018         -0.24      0.46    -1.15     0.66 1.00    20782    29248
# sigma_Site_YearRedRiver_2017         -0.11      0.39    -0.87     0.67 1.00    21554    32782
# sigma_Site_YearRedRiver_2018         -0.24      0.39    -1.00     0.52 1.00    21711    31413
# sigma_Site_YearSandyBar_2017         -0.37      0.36    -1.09     0.33 1.00    21174    31370
# sigma_Site_YearSandyBar_2018         -0.30      0.40    -1.09     0.47 1.00    24520    33360
# sigma_Site_YearWinnipegRiver_2017    -0.56      0.83    -2.17     1.09 1.00    26070    35056
# sigma_K                              -0.13      0.91    -1.93     1.64 1.00    27743    35666
# sigma_SexM                           -0.19      0.29    -0.75     0.38 1.00    29819    22066
# sigma_SexUN                           0.66      0.70    -0.65     2.09 1.00    19579    25528
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     2.47      1.14     1.38     4.75 1.00    15313    15932
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C4OH, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000926  0.000678  0.001181
# DauphinRiver_2018  0.001229  0.000895  0.001564
# Matheson_2017      0.000587  0.000330  0.000985
# Matheson_2018      0.000964  0.000731  0.001240
# RedRiver_2017      0.000645  0.000408  0.000905
# RedRiver_2018      0.000812  0.000591  0.001061
# SandyBar_2017      0.000658  0.000448  0.000900
# SandyBar_2018      0.000810  0.000594  0.001062
# WinnipegRiver_2017 0.001085  0.000784  0.001483
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C4OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018  -3.03e-04 -6.46e-04  6.37e-05
# DauphinRiver_2017 - Matheson_2017       3.33e-04  6.69e-06  5.96e-04
# DauphinRiver_2017 - Matheson_2018      -4.27e-05 -2.86e-04  1.89e-04
# DauphinRiver_2017 - RedRiver_2017       2.78e-04  6.18e-05  4.85e-04
# DauphinRiver_2017 - RedRiver_2018       1.10e-04 -9.41e-05  3.13e-04
# DauphinRiver_2017 - SandyBar_2017       2.65e-04  7.48e-05  4.49e-04
# DauphinRiver_2017 - SandyBar_2018       1.11e-04 -9.88e-05  3.05e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -1.65e-04 -5.03e-04  1.18e-04
# DauphinRiver_2018 - Matheson_2017       6.28e-04  2.19e-04  1.00e-03
# DauphinRiver_2018 - Matheson_2018       2.57e-04 -8.61e-05  5.85e-04
# DauphinRiver_2018 - RedRiver_2017       5.79e-04  2.27e-04  9.26e-04
# DauphinRiver_2018 - RedRiver_2018       4.12e-04  6.02e-05  7.39e-04
# DauphinRiver_2018 - SandyBar_2017       5.65e-04  2.21e-04  8.86e-04
# DauphinRiver_2018 - SandyBar_2018       4.12e-04  6.96e-05  7.40e-04
# DauphinRiver_2018 - WinnipegRiver_2017  1.30e-04 -3.08e-04  5.18e-04
# Matheson_2017 - Matheson_2018          -3.74e-04 -6.32e-04 -5.64e-05
# Matheson_2017 - RedRiver_2017          -5.70e-05 -3.13e-04  2.59e-04
# Matheson_2017 - RedRiver_2018          -2.24e-04 -4.67e-04  8.93e-05
# Matheson_2017 - SandyBar_2017          -7.26e-05 -2.93e-04  2.40e-04
# Matheson_2017 - SandyBar_2018          -2.22e-04 -4.63e-04  9.31e-05
# Matheson_2017 - WinnipegRiver_2017     -4.95e-04 -8.79e-04 -8.30e-05
# Matheson_2018 - RedRiver_2017           3.20e-04  9.10e-05  5.47e-04
# Matheson_2018 - RedRiver_2018           1.53e-04 -5.95e-05  3.68e-04
# Matheson_2018 - SandyBar_2017           3.06e-04  1.09e-04  5.05e-04
# Matheson_2018 - SandyBar_2018           1.54e-04 -5.40e-05  3.55e-04
# Matheson_2018 - WinnipegRiver_2017     -1.21e-04 -4.82e-04  1.73e-04
# RedRiver_2017 - RedRiver_2018          -1.66e-04 -3.58e-04  2.91e-05
# RedRiver_2017 - SandyBar_2017          -1.36e-05 -1.84e-04  1.58e-04
# RedRiver_2017 - SandyBar_2018          -1.66e-04 -3.61e-04  3.08e-05
# RedRiver_2017 - WinnipegRiver_2017     -4.39e-04 -7.79e-04 -1.69e-04
# RedRiver_2018 - SandyBar_2017           1.53e-04 -9.93e-06  3.19e-04
# RedRiver_2018 - SandyBar_2018           2.47e-06 -1.74e-04  1.83e-04
# RedRiver_2018 - WinnipegRiver_2017     -2.72e-04 -6.16e-04  7.30e-06
# SandyBar_2017 - SandyBar_2018          -1.52e-04 -3.18e-04  1.09e-05
# SandyBar_2017 - WinnipegRiver_2017     -4.23e-04 -7.61e-04 -1.75e-04
# SandyBar_2018 - WinnipegRiver_2017     -2.73e-04 -6.13e-04 -2.24e-06
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C4OH, ~ Site_Year))
test_C4OH_plot<- plot(emmeans(test_C4OH, ~ Site_Year)) #### That's the one!!!!!!
test_C4OH_plot
plot(emmeans(test_C4OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C4OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C4OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C4OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C4OH_tets_plot <- gather_emmeans_draws(emmeans(test_C4OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C4OH_tets_plot.png")
save(test_C4OH, file = "C4OH_simple_model.RData")

model_dataframe_test_C4OH <- test_C4OH %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Intercept:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_test_C4OH$Site<- factor(model_dataframe_test_C4OH$Site, levels = c("DauphinRiver", "Matheson", "SandyBar", "RedRiver", "WinnipegRiver"))

C4OH_draws <- model_draws(test_C4OH)

test_C4OH_site_year_plot <- ggplot(data = C4OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C4OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C4OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C4OH_site_year_plot.pdf", plot = test_C4OH_site_year_plot, dpi = 900)
test_C4OH_site_year_plot

test_C4OH_site_year_plot2 <- ggplot(data = C4OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C4OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C4OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C4:OH (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_C4OH_site_year_plot2
ggsave(filename = "test_C4OH_site_year_plot2.pdf", plot = test_C4OH_site_year_plot2, dpi = 900)

ggsave("test_C4OH_site_year_plot2.png")

test_C4OH_site_year_plot3 <- ggplot(data = C4OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C4OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C4OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C4:OH (uM)") +
  ylab("Site of capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C4OH_site_year_plot3
ggsave(filename = "test_C4OH_site_year_plot3.pdf", plot = test_C4OH_site_year_plot3, dpi = 900)

ggsave("test_C4OH_site_year_plot3.png")

test_C4OH_site_year_plot4 <- ggplot(data = C4OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C4OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C4OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C4:OH (µM)") +
  ylab("Site of capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C4OH_site_year_plot4
ggsave(filename = "test_C4OH_site_year_plot4.pdf", plot = test_C4OH_site_year_plot4, dpi = 900)

ggsave("test_C4OH_site_year_plot4.png")

#### C5MD ####
hist(carn_dataf$C5MDC)
test_C5MDC <- brm(data=carn_dataf,
                  family = student,
                  bf(C5MDC ~ Site_Year + K + Sex,
                     sigma ~ Site_Year + K + Sex),
                  prior = c(prior(normal(0,0.001), class = b),
                            prior(normal(0,0.001), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C5MDC)
pp_check(test_C5MDC, ndraws = 100) +
  theme_bw()
summary(test_C5MDC)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C5MDC ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    52900    49420
# sigma_Intercept                      -6.86      0.87    -8.53    -5.14 1.00    24548    34638
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    50109    50018
# Site_YearMatheson_2017               -0.00      0.00    -0.00    -0.00 1.00    53893    48066
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    55783    47897
# Site_YearRedRiver_2017               -0.00      0.00    -0.00     0.00 1.00    51339    51191
# Site_YearRedRiver_2018               -0.00      0.00    -0.00    -0.00 1.00    55051    46631
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    53531    49460
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    56169    49170
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    62855    40250
# K                                    -0.00      0.00    -0.00     0.00 1.00    53585    48313
# SexM                                  0.00      0.00    -0.00     0.00 1.00    49706    53352
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    59901    45045
# sigma_Site_YearDauphinRiver_2018     -0.34      0.32    -0.97     0.28 1.00    20103    29234
# sigma_Site_YearMatheson_2017         -1.42      0.49    -2.29    -0.37 1.00    28427    30759
# sigma_Site_YearMatheson_2018         -1.18      0.34    -1.84    -0.49 1.00    19375    27911
# sigma_Site_YearRedRiver_2017         -0.21      0.30    -0.79     0.40 1.00    20014    29056
# sigma_Site_YearRedRiver_2018         -0.62      0.30    -1.21    -0.02 1.00    20149    28818
# sigma_Site_YearSandyBar_2017         -0.19      0.27    -0.73     0.35 1.00    19113    28238
# sigma_Site_YearSandyBar_2018         -0.22      0.30    -0.81     0.39 1.00    19731    27229
# sigma_Site_YearWinnipegRiver_2017     0.41      0.55    -0.57     1.59 1.00    27532    30874
# sigma_K                              -0.91      0.74    -2.37     0.54 1.00    26587    36625
# sigma_SexM                           -0.32      0.22    -0.76     0.12 1.00    32239    39273
# sigma_SexUN                           0.16      0.35    -0.51     0.89 1.00    35195    37448
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    23.41     14.16     5.58    59.04 1.00    36860    31862
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C5MDC, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000807  0.000621  0.001008
# DauphinRiver_2018  0.000659  0.000477  0.000841
# Matheson_2017      0.000596  0.000474  0.000718
# Matheson_2018      0.000484  0.000367  0.000601
# RedRiver_2017      0.000750  0.000589  0.000914
# RedRiver_2018      0.000602  0.000478  0.000728
# SandyBar_2017      0.000657  0.000505  0.000819
# SandyBar_2018      0.000722  0.000555  0.000893
# WinnipegRiver_2017 0.001141  0.000533  0.001691
# 
# Results are averaged over the levels of: Sex
# Point estimate displayed: median
# HPD interval probability: 0.95
pairs(emmeans(test_C5MDC, ~ Site_Year))
# DauphinRiver_2017 - DauphinRiver_2018   1.47e-04 -1.26e-04  4.21e-04
# DauphinRiver_2017 - Matheson_2017       2.10e-04  1.63e-05  4.24e-04
# DauphinRiver_2017 - Matheson_2018       3.26e-04  1.05e-04  5.46e-04
# DauphinRiver_2017 - RedRiver_2017       5.68e-05 -1.71e-04  2.90e-04
# DauphinRiver_2017 - RedRiver_2018       2.04e-04  8.70e-06  4.11e-04
# DauphinRiver_2017 - SandyBar_2017       1.50e-04 -6.65e-05  3.77e-04
# DauphinRiver_2017 - SandyBar_2018       8.33e-05 -1.59e-04  3.16e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -3.30e-04 -8.90e-04  2.82e-04
# DauphinRiver_2018 - Matheson_2017       6.48e-05 -1.51e-04  2.79e-04
# DauphinRiver_2018 - Matheson_2018       1.75e-04 -1.65e-05  3.84e-04
# DauphinRiver_2018 - RedRiver_2017      -8.90e-05 -3.43e-04  1.39e-04
# DauphinRiver_2018 - RedRiver_2018       5.87e-05 -1.65e-04  2.79e-04
# DauphinRiver_2018 - SandyBar_2017       3.54e-06 -2.36e-04  2.42e-04
# DauphinRiver_2018 - SandyBar_2018      -6.19e-05 -3.02e-04  1.85e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -4.80e-04 -1.08e-03  1.46e-04
# Matheson_2017 - Matheson_2018           1.14e-04 -3.32e-05  2.52e-04
# Matheson_2017 - RedRiver_2017          -1.53e-04 -3.35e-04  2.44e-05
# Matheson_2017 - RedRiver_2018          -5.93e-06 -1.51e-04  1.34e-04
# Matheson_2017 - SandyBar_2017          -6.06e-05 -2.33e-04  1.09e-04
# Matheson_2017 - SandyBar_2018          -1.28e-04 -3.12e-04  6.21e-05
# Matheson_2017 - WinnipegRiver_2017     -5.44e-04 -1.12e-03  5.66e-05
# Matheson_2018 - RedRiver_2017          -2.67e-04 -4.61e-04 -8.26e-05
# Matheson_2018 - RedRiver_2018          -1.20e-04 -2.75e-04  4.04e-05
# Matheson_2018 - SandyBar_2017          -1.74e-04 -3.50e-04  1.16e-05
# Matheson_2018 - SandyBar_2018          -2.40e-04 -4.31e-04 -4.77e-05
# Matheson_2018 - WinnipegRiver_2017     -6.58e-04 -1.23e-03 -4.39e-05
# RedRiver_2017 - RedRiver_2018           1.48e-04 -2.93e-05  3.25e-04
# RedRiver_2017 - SandyBar_2017           9.32e-05 -1.04e-04  2.90e-04
# RedRiver_2017 - SandyBar_2018           2.74e-05 -1.85e-04  2.47e-04
# RedRiver_2017 - WinnipegRiver_2017     -3.89e-04 -9.55e-04  2.21e-04
# RedRiver_2018 - SandyBar_2017          -5.44e-05 -2.24e-04  1.15e-04
# RedRiver_2018 - SandyBar_2018          -1.21e-04 -3.09e-04  5.65e-05
# RedRiver_2018 - WinnipegRiver_2017     -5.38e-04 -1.10e-03  5.66e-05
# SandyBar_2017 - SandyBar_2018          -6.58e-05 -2.81e-04  1.39e-04
# SandyBar_2017 - WinnipegRiver_2017     -4.83e-04 -1.07e-03  1.16e-04
# SandyBar_2018 - WinnipegRiver_2017     -4.18e-04 -1.00e-03  1.84e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C5MDC, ~ Site_Year))
test_C5MDC_plot<- plot(emmeans(test_C5MDC, ~ Site_Year)) #### That's the one!!!!!!
test_C5MDC_plot
plot(emmeans(test_C5MDC, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C5MDC, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C5MDC, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C5MDC, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C5MDC_tets_plot <- gather_emmeans_draws(emmeans(test_C5MDC, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C5MDC_tets_plot.png")
save(test_C5MDC, file = " C5MDC_simple_model.RData")

model_dataframe_test_C5MDC <- test_C5MDC %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Intercept:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_test_C5MDC$Site<- factor(model_dataframe_test_C5MDC$Site, levels = c("DauphinRiver", "Matheson", "SandyBar", "RedRiver", "WinnipegRiver"))

C5MDC_draws <- model_draws(test_C5MDC)

test_C5MDC_site_year_plot <- ggplot(data = C5MDC_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C5MDC_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C5MDC_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C5MDC_site_year_plot.pdf", plot = test_C4OH_site_year_plot, dpi = 900)
test_C5MDC_site_year_plot

test_C5MDC_site_year_plot2 <- ggplot(data = C5MDC_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C5MDC_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C5MDC_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C5MDC (uM)") +
  ylab(element_blank()) +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.80, 0.80), legend.background = element_blank())
test_C5MDC_site_year_plot2
ggsave(filename = "test_C5MDC_site_year_plot2.pdf", plot = test_C5MDC_site_year_plot2, dpi = 900)

ggsave("test_C5MDC_site_year_plot2.png")
test_C5MDC_site_year_plot3 <- ggplot(data = C5MDC_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C5MDC_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C5MDC_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C5MDC (uM)") +
  ylab("Site of capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C5MDC_site_year_plot3
ggsave(filename = "test_C5MDC_site_year_plot3.pdf", plot = test_C5MDC_site_year_plot3, dpi = 900)

ggsave("test_C5MDC_site_year_plot3.png")

test_C5MDC_site_year_plot4 <- ggplot(data = C5MDC_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C5MDC_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C5MDC_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C5MDC (µM)") +
  ylab(element_blank()) +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.80, 0.80), legend.background = element_blank())
test_C5MDC_site_year_plot4
ggsave(filename = "test_C5MDC_site_year_plot4.pdf", plot = test_C5MDC_site_year_plot4, dpi = 900)

ggsave("test_C5MDC_site_year_plot4.png")

#### C5_1 ####
hist(carn_dataf$C5_1)
test_C5_1 <- brm(data=carn_dataf,
                  family = student,
                  bf(C5_1 ~ Site_Year + K + Sex,
                     sigma ~ Site_Year + K + Sex),
                  prior = c(prior(normal(0,0.001), class = b),
                            prior(normal(0,0.001), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C5_1)
pp_check(test_C5_1, ndraws = 100) +
  theme_bw()
summary(test_C5_1)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C5_1 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    52954    49182
# sigma_Intercept                      -7.96      0.94    -9.75    -6.08 1.00    28363    35743
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    60263    46903
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    57427    46227
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    57324    45972
# Site_YearRedRiver_2017               -0.00      0.00    -0.00    -0.00 1.00    58562    49417
# Site_YearRedRiver_2018               -0.00      0.00    -0.00    -0.00 1.00    60961    46738
# Site_YearSandyBar_2017               -0.00      0.00    -0.00    -0.00 1.00    60325    49805
# Site_YearSandyBar_2018               -0.00      0.00    -0.00    -0.00 1.00    60613    47543
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    65921    41118
# K                                    -0.00      0.00    -0.00     0.00 1.00    51007    45366
# SexM                                 -0.00      0.00    -0.00     0.00 1.00    55201    52814
# SexUN                                -0.00      0.00    -0.00     0.00 1.00    58269    45105
# sigma_Site_YearDauphinRiver_2018     -0.59      0.31    -1.21     0.03 1.00    25063    34403
# sigma_Site_YearMatheson_2017         -1.44      0.52    -2.40    -0.36 1.00    33177    32792
# sigma_Site_YearMatheson_2018         -1.19      0.36    -1.92    -0.48 1.00    23461    31009
# sigma_Site_YearRedRiver_2017         -0.64      0.30    -1.23    -0.04 1.00    28056    34581
# sigma_Site_YearRedRiver_2018         -1.08      0.31    -1.68    -0.47 1.00    27426    34687
# sigma_Site_YearSandyBar_2017         -0.18      0.27    -0.71     0.35 1.00    26549    32398
# sigma_Site_YearSandyBar_2018         -0.53      0.30    -1.11     0.07 1.00    27274    33759
# sigma_Site_YearWinnipegRiver_2017     0.52      0.54    -0.44     1.67 1.00    30612    31862
# sigma_K                              -0.01      0.81    -1.62     1.57 1.00    30021    37797
# sigma_SexM                            0.03      0.23    -0.41     0.48 1.00    35478    39643
# sigma_SexUN                           0.11      0.37    -0.59     0.86 1.00    34371    36031
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    21.59     13.68     5.02    56.50 1.00    33252    33760
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C5_1, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000811  0.000624  0.000998
# DauphinRiver_2018  0.000588  0.000465  0.000714
# Matheson_2017      0.000617  0.000509  0.000733
# Matheson_2018      0.000394  0.000296  0.000497
# RedRiver_2017      0.000511  0.000393  0.000634
# RedRiver_2018      0.000333  0.000251  0.000424
# SandyBar_2017      0.000561  0.000408  0.000718
# SandyBar_2018      0.000471  0.000349  0.000601
# WinnipegRiver_2017 0.001102  0.000417  0.001788
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
# pairs(emmeans(test_C5_1, ~ Site_Year))
plot(emmeans(test_C5_1, ~ Site_Year))
test_C5_1_plot<- plot(emmeans(test_C5_1, ~ Site_Year)) #### That's the one!!!!!!
test_C5_1_plot
plot(emmeans(test_C5_1, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C5_1, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C5_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C5_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C5_1_tets_plot <- gather_emmeans_draws(emmeans(test_C5_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C5_1_tets_plot.png")
save(test_C5_1, file = " C5_1_simple_model.RData")

model_dataframe_test_C5_1 <- test_C5_1 %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Intercept:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_test_C5_1$Site<- factor(model_dataframe_test_C5_1$Site, levels = c("DauphinRiver", "Matheson", "SandyBar", "RedRiver", "WinnipegRiver"))

C5_1_draws <- model_draws(test_C5_1)

test_C5_1_site_year_plot <- ggplot(data = C5_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C5_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C5_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C5_1_site_year_plot.pdf", plot = test_C5_1_site_year_plot, dpi = 900)
test_C5_1_site_year_plot

test_C5_1_site_year_plot2 <- ggplot(data = C5_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C5_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C5_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C5:1 (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_C5_1_site_year_plot2
ggsave(filename = "test_C5_1_site_year_plot2.pdf", plot = test_C5_1_site_year_plot2, dpi = 900)

ggsave("test_C5_1_site_year_plot2.png")
test_C5_1_site_year_plot3 <- ggplot(data = C5_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C5_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C5_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C5:1 (uM)") +
  ylab(element_blank()) +  
  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C5_1_site_year_plot3
ggsave(filename = "test_C5_1_site_year_plot3.pdf", plot = test_C5_1_site_year_plot3, dpi = 900)

ggsave("test_C5_1_site_year_plot3.png")


test_C5_1_site_year_plot4 <- ggplot(data = C5_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C5_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C5_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C5:1 (µM)") +
  ylab(element_blank()) +  
  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C5_1_site_year_plot4
ggsave(filename = "test_C5_1_site_year_plot4.pdf", plot = test_C5_1_site_year_plot4, dpi = 900)

ggsave("test_C5_1_site_year_plot4.png")

#### asymmetric_Dimethylarginine ####
hist(met_dataf$Asymmetric_Dimethylarginine)
test_ADA <- brm(data=met_dataf,
                family = skew_normal,
                bf(Asymmetric_Dimethylarginine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,1), class = b),
                          prior(normal(0,1), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_ADA)
pp_check(test_ADA, ndraws = 100) +
  theme_bw()
summary(test_ADA)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Asymmetric_Dimethylarginine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.67      0.33     0.02     1.34 1.00    16936    25764
# sigma_Intercept                      -1.86      0.80    -3.42    -0.27 1.00    18045    30100
# Site_YearDauphinRiver_2018           -0.41      0.16    -0.73    -0.11 1.00    15341    21757
# Site_YearMatheson_2017               -0.37      0.19    -0.73     0.04 1.00    19675    28247
# Site_YearMatheson_2018               -0.67      0.15    -0.99    -0.39 1.00    12926    18294
# Site_YearRedRiver_2017               -0.59      0.14    -0.86    -0.31 1.00    18150    24542
# Site_YearRedRiver_2018               -0.82      0.14    -1.11    -0.54 1.00    16063    23518
# Site_YearSandyBar_2017               -0.14      0.16    -0.46     0.18 1.00    18261    25548
# Site_YearSandyBar_2018               -0.83      0.14    -1.12    -0.56 1.00    14541    21364
# Site_YearWinnipegRiver_2017          -0.37      0.38    -1.02     0.49 1.00    26768    25051
# K                                     0.67      0.26     0.17     1.18 1.00    23654    34380
# SexM                                 -0.19      0.09    -0.37    -0.01 1.00    30029    37876
# SexUN                                -0.14      0.08    -0.29     0.02 1.00    34121    34609
# sigma_Site_YearDauphinRiver_2018      0.06      0.34    -0.59     0.76 1.00    20468    30954
# sigma_Site_YearMatheson_2017         -0.43      0.48    -1.30     0.60 1.00    26063    30469
# sigma_Site_YearMatheson_2018         -0.68      0.34    -1.35     0.00 1.00    16909    27888
# sigma_Site_YearRedRiver_2017         -0.45      0.27    -0.98     0.08 1.00    28144    37436
# sigma_Site_YearRedRiver_2018         -0.63      0.31    -1.22    -0.02 1.00    26090    35904
# sigma_Site_YearSandyBar_2017         -0.01      0.27    -0.54     0.52 1.00    21982    32890
# sigma_Site_YearSandyBar_2018         -0.58      0.31    -1.17     0.05 1.00    24008    36201
# sigma_Site_YearWinnipegRiver_2017     0.11      0.52    -0.81     1.23 1.00    28370    30481
# sigma_K                               0.94      0.64    -0.32     2.19 1.00    22667    36184
# sigma_SexM                            0.19      0.24    -0.29     0.67 1.00    28122    39235
# sigma_SexUN                          -0.65      0.36    -1.36     0.08 1.00    37261    37797
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     3.89      1.81     1.13     8.13 1.00    30824    29689
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 1 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
emmeans(test_ADA, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   1.289     1.056     1.542
# DauphinRiver_2018   0.880     0.709     1.070
# Matheson_2017       0.909     0.651     1.259
# Matheson_2018       0.621     0.473     0.780
# RedRiver_2017       0.703     0.535     0.888
# RedRiver_2018       0.472     0.330     0.637
# SandyBar_2017       1.147     0.943     1.381
# SandyBar_2018       0.459     0.332     0.596
# WinnipegRiver_2017  0.887     0.264     1.680
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_ADA, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   0.40562   0.10077   0.71532
# DauphinRiver_2017 - Matheson_2017       0.37266  -0.01613   0.74781
# DauphinRiver_2017 - Matheson_2018       0.66434   0.37569   0.97381
# DauphinRiver_2017 - RedRiver_2017       0.58498   0.31243   0.85655
# DauphinRiver_2017 - RedRiver_2018       0.81550   0.53986   1.10550
# DauphinRiver_2017 - SandyBar_2017       0.13782  -0.17398   0.46539
# DauphinRiver_2017 - SandyBar_2018       0.82787   0.55164   1.10190
# DauphinRiver_2017 - WinnipegRiver_2017  0.39534  -0.40384   1.08465
# DauphinRiver_2018 - Matheson_2017      -0.03274  -0.41596   0.30271
# DauphinRiver_2018 - Matheson_2018       0.25736   0.07500   0.46219
# DauphinRiver_2018 - RedRiver_2017       0.17684  -0.08599   0.44709
# DauphinRiver_2018 - RedRiver_2018       0.40728   0.16924   0.66818
# DauphinRiver_2018 - SandyBar_2017      -0.26798  -0.55880   0.00981
# DauphinRiver_2018 - SandyBar_2018       0.41974   0.19629   0.65050
# DauphinRiver_2018 - WinnipegRiver_2017 -0.00814  -0.81421   0.65302
# Matheson_2017 - Matheson_2018           0.29078  -0.01589   0.64741
# Matheson_2017 - RedRiver_2017           0.20717  -0.11725   0.59338
# Matheson_2017 - RedRiver_2018           0.43844   0.13123   0.81336
# Matheson_2017 - SandyBar_2017          -0.23542  -0.58835   0.15221
# Matheson_2017 - SandyBar_2018           0.45139   0.15437   0.80482
# Matheson_2017 - WinnipegRiver_2017      0.02919  -0.83415   0.71847
# Matheson_2018 - RedRiver_2017          -0.08129  -0.33994   0.16314
# Matheson_2018 - RedRiver_2018           0.14672  -0.08365   0.36801
# Matheson_2018 - SandyBar_2017          -0.52701  -0.79375  -0.28001
# Matheson_2018 - SandyBar_2018           0.15958  -0.03813   0.35500
# Matheson_2018 - WinnipegRiver_2017     -0.26906  -1.08155   0.36599
# RedRiver_2017 - RedRiver_2018           0.23053   0.00896   0.44984
# RedRiver_2017 - SandyBar_2017          -0.44373  -0.72035  -0.17712
# RedRiver_2017 - SandyBar_2018           0.24369   0.02678   0.46912
# RedRiver_2017 - WinnipegRiver_2017     -0.18186  -1.00061   0.44666
# RedRiver_2018 - SandyBar_2017          -0.67472  -0.94502  -0.42023
# RedRiver_2018 - SandyBar_2018           0.01289  -0.17769   0.21378
# RedRiver_2018 - WinnipegRiver_2017     -0.41378  -1.22280   0.21308
# SandyBar_2017 - SandyBar_2018           0.68741   0.44142   0.94152
# SandyBar_2017 - WinnipegRiver_2017      0.26237  -0.55237   0.91270
# SandyBar_2018 - WinnipegRiver_2017     -0.42658  -1.21761   0.21788
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_ADA, ~ Site_Year))
test_ADA_plot<- plot(emmeans(test_ADA, ~ Site_Year)) #### That's the one!!!!!!
test_ADA_plot
plot(emmeans(test_ADA, ~ Sex*Site_Year))
plot(pairs(emmeans(test_ADA, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_ADA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_ADA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ADA_tets_plot <- gather_emmeans_draws(emmeans(test_ADA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("ADA_test_plot.png")
save(test_ADA, file = " ADA_simple_model.RData")

#### Trans_Hydroxyproline####
hist(met_dataf$Trans_Hydroxyproline)
test_THP <- brm(data=met_dataf,
                family = student,
                bf(Trans_Hydroxyproline ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,40), class = b),
                          prior(normal(0,40), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_THP)
pp_check(test_THP, ndraws = 100) +
  theme_bw()
summary(test_THP)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Trans_Hydroxyproline ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            57.89      9.37    35.66    72.15 1.00     7583     8525
# sigma_Intercept                       1.12      1.59    -1.99     4.22 1.00    19447    30183
# Site_YearDauphinRiver_2018          -12.39     11.03   -31.35    12.02 1.00     9811    11284
# Site_YearMatheson_2017              -37.16     13.97   -61.06    -6.42 1.00    13533    17972
# Site_YearMatheson_2018              -49.02      9.75   -64.65   -26.46 1.00     7932     9126
# Site_YearRedRiver_2017              -57.11      9.32   -71.28   -34.96 1.00     7459     8476
# Site_YearRedRiver_2018              -57.18      9.32   -71.37   -35.02 1.00     7437     8430
# Site_YearSandyBar_2017              -55.92      9.33   -70.15   -33.79 1.00     7512     8479
# Site_YearSandyBar_2018              -57.08      9.33   -71.33   -34.91 1.00     7485     8541
# Site_YearWinnipegRiver_2017         -40.91      9.74   -56.59   -18.16 1.00     7724     8773
# K                                     0.35      0.89    -1.30     2.21 1.00    29423    32247
# SexM                                  0.24      0.39    -0.52     1.01 1.00    29347    35182
# SexUN                                 1.67      3.34    -2.50    11.03 1.00    23514    17105
# sigma_Site_YearDauphinRiver_2018     -0.09      0.62    -1.31     1.10 1.00    14049    23428
# sigma_Site_YearMatheson_2017         -0.41      0.74    -1.88     1.02 1.00    21054    32527
# sigma_Site_YearMatheson_2018         -0.82      0.61    -2.03     0.38 1.00    13738    23348
# sigma_Site_YearRedRiver_2017         -4.07      0.54    -5.14    -3.02 1.00    16794    25459
# sigma_Site_YearRedRiver_2018         -4.15      0.57    -5.28    -3.03 1.00    15927    24603
# sigma_Site_YearSandyBar_2017         -2.57      0.56    -3.67    -1.46 1.00    15458    25665
# sigma_Site_YearSandyBar_2018         -2.92      0.61    -4.13    -1.73 1.00    16311    28493
# sigma_Site_YearWinnipegRiver_2017    -2.26      0.91    -4.13    -0.51 1.00    23869    33782
# sigma_K                               1.61      1.31    -1.00     4.16 1.00    24463    30847
# sigma_SexM                            0.58      0.35    -0.11     1.28 1.00    32262    39053
# sigma_SexUN                          -0.29      0.63    -1.60     0.91 1.00    25600    30683
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     1.14      0.12     1.00     1.46 1.00    27961    21701
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_THP, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   60.34   39.3279     74.68
# DauphinRiver_2018   46.25   35.2563     59.02
# Matheson_2017       20.12    2.2511     44.99
# Matheson_2018        9.84    4.2282     15.39
# RedRiver_2017        1.48    0.1792      4.60
# RedRiver_2018        1.41    0.0558      4.47
# SandyBar_2017        2.72    1.0109      5.85
# SandyBar_2018        1.46    0.2037      4.84
# WinnipegRiver_2017  18.45   11.5135     23.60
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_THP, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   13.3587   -10.174    32.730
# DauphinRiver_2017 - Matheson_2017       38.5284     8.208    62.429
# DauphinRiver_2017 - Matheson_2018       50.3061    28.868    65.982
# DauphinRiver_2017 - RedRiver_2017       58.5826    37.853    72.835
# DauphinRiver_2017 - RedRiver_2018       58.6405    37.806    72.823
# DauphinRiver_2017 - SandyBar_2017       57.3954    36.580    71.652
# DauphinRiver_2017 - SandyBar_2018       58.5564    37.783    72.843
# DauphinRiver_2017 - WinnipegRiver_2017  42.2567    21.386    58.758
# DauphinRiver_2018 - Matheson_2017       25.7223    -1.034    48.191
# DauphinRiver_2018 - Matheson_2018       36.5850    24.331    49.514
# DauphinRiver_2018 - RedRiver_2017       44.3931    33.329    57.648
# DauphinRiver_2018 - RedRiver_2018       44.4724    33.306    57.647
# DauphinRiver_2018 - SandyBar_2017       43.2154    32.039    56.437
# DauphinRiver_2018 - SandyBar_2018       44.3829    32.976    57.425
# DauphinRiver_2018 - WinnipegRiver_2017  28.2497    15.388    42.326
# Matheson_2017 - Matheson_2018           10.4620    -8.604    35.355
# Matheson_2017 - RedRiver_2017           18.3093     0.951    43.538
# Matheson_2017 - RedRiver_2018           18.3772     1.003    43.550
# Matheson_2017 - SandyBar_2017           17.1218    -0.886    41.795
# Matheson_2017 - SandyBar_2018           18.2767     0.379    43.021
# Matheson_2017 - WinnipegRiver_2017       2.2020   -17.114    27.621
# Matheson_2018 - RedRiver_2017            8.0540     2.266    13.771
# Matheson_2018 - RedRiver_2018            8.1189     2.443    13.961
# Matheson_2018 - SandyBar_2017            6.8626     1.127    12.802
# Matheson_2018 - SandyBar_2018            8.0525     2.261    13.923
# Matheson_2018 - WinnipegRiver_2017      -8.3069   -16.189     0.347
# RedRiver_2017 - RedRiver_2018            0.0611    -0.355     0.509
# RedRiver_2017 - SandyBar_2017           -1.1543    -2.259    -0.171
# RedRiver_2017 - SandyBar_2018            0.0157    -1.037     0.944
# RedRiver_2017 - WinnipegRiver_2017     -16.8294   -20.864   -10.067
# RedRiver_2018 - SandyBar_2017           -1.2205    -2.335    -0.213
# RedRiver_2018 - SandyBar_2018           -0.0507    -1.146     0.842
# RedRiver_2018 - WinnipegRiver_2017     -16.8992   -20.937   -10.110
# SandyBar_2017 - SandyBar_2018            1.1646    -0.245     2.491
# SandyBar_2017 - WinnipegRiver_2017     -15.5805   -19.780    -8.773
# SandyBar_2018 - WinnipegRiver_2017     -16.7619   -20.801    -9.824
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_THP, ~ Site_Year))
test_THP_plot<- plot(emmeans(test_THP, ~ Site_Year)) #### That's the one!!!!!!
test_THP_plot
plot(emmeans(test_THP, ~ Sex*Site_Year))
plot(pairs(emmeans(test_THP, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_THP, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_THP, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
THP_tets_plot <- gather_emmeans_draws(emmeans(test_THP, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("THP_test_plot.png")
save(test_THP, file = " THP_simple_model.RData")

#### Total_Dimethylarginine####
hist(met_dataf$Total_Dimethylarginine)
test_TDA <- brm(data=met_dataf,
                family = student,
                bf(Total_Dimethylarginine ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,1.5), class = b),
                          prior(normal(0,1.5), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_TDA)
pp_check(test_TDA, ndraws = 100) +
  theme_bw()
summary(test_TDA)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Total_Dimethylarginine ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             1.21      0.43     0.38     2.06 1.00    28542    37589
# sigma_Intercept                      -1.52      0.92    -3.32     0.29 1.00    30537    36227
# Site_YearDauphinRiver_2018           -0.39      0.22    -0.82     0.04 1.00    25287    33476
# Site_YearMatheson_2017               -0.66      0.29    -1.23    -0.09 1.00    30415    33555
# Site_YearMatheson_2018               -0.92      0.18    -1.29    -0.56 1.00    20962    28435
# Site_YearRedRiver_2017               -0.76      0.20    -1.15    -0.36 1.00    28387    37617
# Site_YearRedRiver_2018               -1.07      0.19    -1.44    -0.69 1.00    24924    35642
# Site_YearSandyBar_2017               -0.34      0.20    -0.72     0.05 1.00    24814    34178
# Site_YearSandyBar_2018               -1.05      0.17    -1.38    -0.72 1.00    20898    29105
# Site_YearWinnipegRiver_2017          -0.00      0.65    -1.32     1.31 1.00    38159    33273
# K                                     0.83      0.35     0.15     1.51 1.00    35911    40531
# SexM                                 -0.33      0.11    -0.55    -0.11 1.00    40718    41609
# SexUN                                -0.16      0.16    -0.49     0.14 1.00    41175    36821
# sigma_Site_YearDauphinRiver_2018     -0.04      0.41    -0.86     0.74 1.00    27980    36183
# sigma_Site_YearMatheson_2017         -0.15      0.49    -1.04     0.90 1.00    30961    33292
# sigma_Site_YearMatheson_2018         -0.76      0.40    -1.57     0.02 1.00    27009    36251
# sigma_Site_YearRedRiver_2017         -0.27      0.30    -0.86     0.33 1.00    33135    40457
# sigma_Site_YearRedRiver_2018         -0.35      0.32    -1.00     0.29 1.00    32844    39837
# sigma_Site_YearSandyBar_2017         -0.18      0.30    -0.77     0.41 1.00    28737    38330
# sigma_Site_YearSandyBar_2018         -0.83      0.34    -1.49    -0.16 1.00    30321    39609
# sigma_Site_YearWinnipegRiver_2017     0.56      0.54    -0.41     1.72 1.00    36567    38418
# sigma_K                               0.84      0.75    -0.64     2.31 1.00    34738    39502
# sigma_SexM                            0.02      0.24    -0.45     0.49 1.00    41160    45187
# sigma_SexUN                           0.01      0.41    -0.75     0.84 1.00    40376    41202
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    13.42     10.85     3.11    43.10 1.00    30540    41656
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_TDA, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   1.956     1.638      2.26
# DauphinRiver_2018   1.565     1.271      1.87
# Matheson_2017       1.290     0.798      1.79
# Matheson_2018       1.042     0.824      1.26
# RedRiver_2017       1.195     0.898      1.49
# RedRiver_2018       0.883     0.633      1.15
# SandyBar_2017       1.619     1.349      1.88
# SandyBar_2018       0.904     0.740      1.07
# WinnipegRiver_2017  1.958     0.667      3.24
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_TDA, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   0.38862   -0.0424    0.8153
# DauphinRiver_2017 - Matheson_2017       0.66357    0.1112    1.2484
# DauphinRiver_2017 - Matheson_2018       0.91544    0.5557    1.2819
# DauphinRiver_2017 - RedRiver_2017       0.76353    0.3704    1.1569
# DauphinRiver_2017 - RedRiver_2018       1.07217    0.7001    1.4482
# DauphinRiver_2017 - SandyBar_2017       0.33891   -0.0411    0.7304
# DauphinRiver_2017 - SandyBar_2018       1.05078    0.7214    1.3859
# DauphinRiver_2017 - WinnipegRiver_2017 -0.00192   -1.3141    1.3073
# DauphinRiver_2018 - Matheson_2017       0.27716   -0.3172    0.8366
# DauphinRiver_2018 - Matheson_2018       0.52713    0.2055    0.8530
# DauphinRiver_2018 - RedRiver_2017       0.37061   -0.0620    0.8010
# DauphinRiver_2018 - RedRiver_2018       0.68095    0.3009    1.0896
# DauphinRiver_2018 - SandyBar_2017      -0.05298   -0.4377    0.3555
# DauphinRiver_2018 - SandyBar_2018       0.65869    0.3286    1.0069
# DauphinRiver_2018 - WinnipegRiver_2017 -0.39014   -1.7277    0.9172
# Matheson_2017 - Matheson_2018           0.25124   -0.2550    0.7868
# Matheson_2017 - RedRiver_2017           0.09274   -0.4576    0.6744
# Matheson_2017 - RedRiver_2018           0.40923   -0.1579    0.9336
# Matheson_2017 - SandyBar_2017          -0.32985   -0.8696    0.2179
# Matheson_2017 - SandyBar_2018           0.38519   -0.1148    0.8882
# Matheson_2017 - WinnipegRiver_2017     -0.66640   -2.0178    0.7128
# Matheson_2018 - RedRiver_2017          -0.15427   -0.5298    0.2076
# Matheson_2018 - RedRiver_2018           0.15445   -0.1805    0.4712
# Matheson_2018 - SandyBar_2017          -0.57763   -0.8994   -0.2608
# Matheson_2018 - SandyBar_2018           0.13295   -0.1094    0.3854
# Matheson_2018 - WinnipegRiver_2017     -0.91649   -2.2401    0.3745
# RedRiver_2017 - RedRiver_2018           0.30934   -0.0729    0.6829
# RedRiver_2017 - SandyBar_2017          -0.42292   -0.7929   -0.0714
# RedRiver_2017 - SandyBar_2018           0.28873   -0.0344    0.6028
# RedRiver_2017 - WinnipegRiver_2017     -0.76134   -2.0669    0.5443
# RedRiver_2018 - SandyBar_2017          -0.73497   -1.0760   -0.3669
# RedRiver_2018 - SandyBar_2018          -0.02374   -0.2897    0.2619
# RedRiver_2018 - WinnipegRiver_2017     -1.07249   -2.3650    0.2628
# SandyBar_2017 - SandyBar_2018           0.71336    0.4295    0.9926
# SandyBar_2017 - WinnipegRiver_2017     -0.33669   -1.6612    0.9319
# SandyBar_2018 - WinnipegRiver_2017     -1.05207   -2.3873    0.2153
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_TDA, ~ Site_Year))
test_TDA_plot<- plot(emmeans(test_TDA, ~ Site_Year)) #### That's the one!!!!!!
test_TDA_plot
plot(emmeans(test_TDA, ~ Sex*Site_Year))
plot(pairs(emmeans(test_TDA, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_TDA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_TDA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
TDA_tets_plot <- gather_emmeans_draws(emmeans(test_TDA, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("TDA_test_plot.png")
save(test_TDA, file = " TDA_simple_model.RData")

#### C14_2 ####
hist(carn_dataf$C14_2)
test_C14_2 <- brm(data=carn_dataf,
                   family = student,
                   bf(C14_2 ~ Site_Year + K + Sex,
                      sigma ~ Site_Year + K + Sex),
                   prior = c(prior(normal(0,0.0005), class = b),
                             prior(normal(0,0.0005), class = Intercept)),
                   iter = 20000, warmup = 5000, chains = 4, cores = 4,
                   control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C14_2)
pp_check(test_C14_2, ndraws = 100) +
  theme_bw()
summary(test_C14_2)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C14_2 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    53498    50858
# sigma_Intercept                      -6.80      0.89    -8.54    -5.04 1.00    22802    34139
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    57235    48667
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    57180    48075
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    54817    47820
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    52814    48108
# Site_YearRedRiver_2018               -0.00      0.00    -0.00     0.00 1.00    57620    48579
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    58039    48176
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    55071    47952
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    61817    40032
# K                                    -0.00      0.00    -0.00     0.00 1.00    56421    51338
# SexM                                  0.00      0.00    -0.00     0.00 1.00    52233    56170
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    58031    45939
# sigma_Site_YearDauphinRiver_2018     -0.91      0.34    -1.59    -0.23 1.00    18878    28737
# sigma_Site_YearMatheson_2017         -1.15      0.50    -2.06    -0.09 1.00    27973    32550
# sigma_Site_YearMatheson_2018         -1.45      0.36    -2.15    -0.74 1.00    19135    29070
# sigma_Site_YearRedRiver_2017         -0.33      0.30    -0.93     0.26 1.00    22963    32863
# sigma_Site_YearRedRiver_2018         -0.64      0.32    -1.26     0.00 1.00    22160    30929
# sigma_Site_YearSandyBar_2017          0.09      0.28    -0.48     0.65 1.00    21873    29887
# sigma_Site_YearSandyBar_2018         -0.80      0.32    -1.41    -0.17 1.00    21403    30743
# sigma_Site_YearWinnipegRiver_2017     0.09      0.55    -0.89     1.27 1.00    31480    30779
# sigma_K                              -1.29      0.73    -2.73     0.14 1.00    27610    36288
# sigma_SexM                           -0.61      0.24    -1.08    -0.14 1.00    31939    39995
# sigma_SexUN                           0.10      0.34    -0.53     0.82 1.00    36290    35964
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    18.89     12.92     4.12    52.45 1.00    29940    30600
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C14_2, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000474  0.000369  0.000583
# DauphinRiver_2018  0.000346  0.000281  0.000413
# Matheson_2017      0.000384  0.000297  0.000473
# Matheson_2018      0.000276  0.000210  0.000339
# RedRiver_2017      0.000583  0.000496  0.000676
# RedRiver_2018      0.000375  0.000308  0.000446
# SandyBar_2017      0.000463  0.000344  0.000584
# SandyBar_2018      0.000379  0.000319  0.000442
# WinnipegRiver_2017 0.000621  0.000353  0.000900
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C14_2, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   1.28e-04 -2.26e-06  2.54e-04
# DauphinRiver_2017 - Matheson_2017       8.99e-05 -3.79e-05  2.20e-04
# DauphinRiver_2017 - Matheson_2018       1.99e-04  7.24e-05  3.31e-04
# DauphinRiver_2017 - RedRiver_2017      -1.09e-04 -2.40e-04  2.34e-05
# DauphinRiver_2017 - RedRiver_2018       9.84e-05 -1.59e-05  2.19e-04
# DauphinRiver_2017 - SandyBar_2017       1.09e-05 -1.36e-04  1.64e-04
# DauphinRiver_2017 - SandyBar_2018       9.44e-05 -1.91e-05  2.12e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -1.48e-04 -4.25e-04  1.37e-04
# DauphinRiver_2018 - Matheson_2017      -3.83e-05 -1.45e-04  7.16e-05
# DauphinRiver_2018 - Matheson_2018       7.08e-05 -1.32e-05  1.54e-04
# DauphinRiver_2018 - RedRiver_2017      -2.37e-04 -3.45e-04 -1.18e-04
# DauphinRiver_2018 - RedRiver_2018      -2.87e-05 -1.28e-04  6.80e-05
# DauphinRiver_2018 - SandyBar_2017      -1.16e-04 -2.52e-04  2.22e-05
# DauphinRiver_2018 - SandyBar_2018      -3.30e-05 -1.23e-04  5.93e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -2.75e-04 -5.64e-04 -1.48e-06
# Matheson_2017 - Matheson_2018           1.10e-04  8.67e-06  2.09e-04
# Matheson_2017 - RedRiver_2017          -1.99e-04 -3.19e-04 -7.71e-05
# Matheson_2017 - RedRiver_2018           8.78e-06 -9.18e-05  1.13e-04
# Matheson_2017 - SandyBar_2017          -7.86e-05 -2.18e-04  6.65e-05
# Matheson_2017 - SandyBar_2018           4.34e-06 -9.02e-05  1.04e-04
# Matheson_2017 - WinnipegRiver_2017     -2.37e-04 -5.26e-04  4.12e-05
# Matheson_2018 - RedRiver_2017          -3.08e-04 -4.18e-04 -1.99e-04
# Matheson_2018 - RedRiver_2018          -9.98e-05 -1.96e-04 -8.69e-06
# Matheson_2018 - SandyBar_2017          -1.88e-04 -3.21e-04 -5.30e-05
# Matheson_2018 - SandyBar_2018          -1.04e-04 -1.91e-04 -1.86e-05
# Matheson_2018 - WinnipegRiver_2017     -3.46e-04 -6.36e-04 -7.50e-05
# RedRiver_2017 - RedRiver_2018           2.09e-04  1.05e-04  3.14e-04
# RedRiver_2017 - SandyBar_2017           1.20e-04 -1.85e-05  2.61e-04
# RedRiver_2017 - SandyBar_2018           2.04e-04  9.73e-05  3.07e-04
# RedRiver_2017 - WinnipegRiver_2017     -3.62e-05 -3.22e-04  2.37e-04
# RedRiver_2018 - SandyBar_2017          -8.79e-05 -2.20e-04  4.34e-05
# RedRiver_2018 - SandyBar_2018          -4.14e-06 -8.27e-05  7.70e-05
# RedRiver_2018 - WinnipegRiver_2017     -2.46e-04 -5.17e-04  3.65e-05
# SandyBar_2017 - SandyBar_2018           8.38e-05 -4.55e-05  2.15e-04
# SandyBar_2017 - WinnipegRiver_2017     -1.57e-04 -4.55e-04  1.30e-04
# SandyBar_2018 - WinnipegRiver_2017     -2.42e-04 -5.21e-04  3.19e-05
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C14_2, ~ Site_Year))
test_C14_2_plot<- plot(emmeans(test_C14_2, ~ Site_Year)) #### That's the one!!!!!!
test_C14_2_plot
plot(emmeans(test_C14_2, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C14_2, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C14_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C14_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C14_2_tets_plot <- gather_emmeans_draws(emmeans(test_C14_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C14_2_test_plot.png")

save(test_C14_2, file = "C14_2_simple_model.RData")
c1<- C14_2_tets_plot

#### C14_2OH ####
hist(carn_dataf$C14_2OH)
test_C14_2OH <- brm(data=carn_dataf,
                    family = student,
                    bf(C14_2OH ~ Site_Year + K + Sex,
                       sigma ~ Site_Year + K + Sex),
                    prior = c(prior(normal(0,0.001), class = b),
                              prior(normal(0,0.001), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C14_2OH)
pp_check(test_C14_2OH, ndraws = 100) +
  theme_bw()
summary(test_C14_2OH)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C14_2OH ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    53722    48921
# sigma_Intercept                      -6.94      0.82    -8.54    -5.30 1.00    27343    37468
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    54816    48444
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    60762    46647
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    56197    46367
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    58106    50119
# Site_YearRedRiver_2018               -0.00      0.00    -0.00    -0.00 1.00    58642    47733
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    57791    48399
# Site_YearSandyBar_2018               -0.00      0.00    -0.00    -0.00 1.00    56542    47174
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    63754    40330
# K                                    -0.00      0.00    -0.00     0.00 1.00    55360    45811
# SexM                                  0.00      0.00    -0.00     0.00 1.00    54226    53949
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    58788    42859
# sigma_Site_YearDauphinRiver_2018     -0.65      0.36    -1.35     0.08 1.00    21471    33471
# sigma_Site_YearMatheson_2017         -0.75      0.50    -1.65     0.31 1.00    29534    31928
# sigma_Site_YearMatheson_2018         -1.83      0.33    -2.49    -1.18 1.00    23547    31739
# sigma_Site_YearRedRiver_2017         -0.27      0.31    -0.87     0.35 1.00    22275    32115
# sigma_Site_YearRedRiver_2018         -0.64      0.30    -1.23    -0.04 1.00    23151    31808
# sigma_Site_YearSandyBar_2017         -0.35      0.28    -0.89     0.21 1.00    21906    30300
# sigma_Site_YearSandyBar_2018         -0.91      0.31    -1.52    -0.29 1.00    23771    32032
# sigma_Site_YearWinnipegRiver_2017     0.33      0.56    -0.66     1.54 1.00    27187    29352
# sigma_K                              -0.82      0.70    -2.20     0.56 1.00    28728    38323
# sigma_SexM                           -0.26      0.23    -0.71     0.21 1.00    31790    39838
# sigma_SexUN                           0.23      0.40    -0.55     1.04 1.00    31289    37011
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    18.72     13.10     3.88    52.78 1.00    26437    28112
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C14_2OH, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000826  0.000640  0.001023
# DauphinRiver_2018  0.000335  0.000195  0.000481
# Matheson_2017      0.000747  0.000543  0.000965
# Matheson_2018      0.000360  0.000282  0.000439
# RedRiver_2017      0.000960  0.000808  0.001115
# RedRiver_2018      0.000601  0.000484  0.000716
# SandyBar_2017      0.000732  0.000594  0.000863
# SandyBar_2018      0.000564  0.000469  0.000664
# WinnipegRiver_2017 0.001257  0.000660  0.001790
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C14_2OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   4.90e-04  2.47e-04  7.30e-04
# DauphinRiver_2017 - Matheson_2017       7.99e-05 -1.82e-04  3.59e-04
# DauphinRiver_2017 - Matheson_2018       4.67e-04  2.63e-04  6.82e-04
# DauphinRiver_2017 - RedRiver_2017      -1.33e-04 -3.65e-04  1.06e-04
# DauphinRiver_2017 - RedRiver_2018       2.25e-04  2.13e-05  4.36e-04
# DauphinRiver_2017 - SandyBar_2017       9.48e-05 -1.20e-04  3.27e-04
# DauphinRiver_2017 - SandyBar_2018       2.61e-04  6.96e-05  4.76e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -4.25e-04 -9.90e-04  1.67e-04
# DauphinRiver_2018 - Matheson_2017      -4.13e-04 -6.59e-04 -1.51e-04
# DauphinRiver_2018 - Matheson_2018      -2.58e-05 -1.64e-04  1.29e-04
# DauphinRiver_2018 - RedRiver_2017      -6.25e-04 -8.28e-04 -4.22e-04
# DauphinRiver_2018 - RedRiver_2018      -2.65e-04 -4.53e-04 -8.02e-05
# DauphinRiver_2018 - SandyBar_2017      -3.96e-04 -5.88e-04 -2.01e-04
# DauphinRiver_2018 - SandyBar_2018      -2.29e-04 -4.03e-04 -5.26e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -9.19e-04 -1.50e-03 -3.31e-04
# Matheson_2017 - Matheson_2018           3.90e-04  1.65e-04  6.01e-04
# Matheson_2017 - RedRiver_2017          -2.12e-04 -4.72e-04  3.77e-05
# Matheson_2017 - RedRiver_2018           1.45e-04 -7.98e-05  3.78e-04
# Matheson_2017 - SandyBar_2017           1.52e-05 -2.32e-04  2.55e-04
# Matheson_2017 - SandyBar_2018           1.81e-04 -3.91e-05  4.11e-04
# Matheson_2017 - WinnipegRiver_2017     -5.07e-04 -1.08e-03  1.13e-04
# Matheson_2018 - RedRiver_2017          -6.00e-04 -7.70e-04 -4.35e-04
# Matheson_2018 - RedRiver_2018          -2.42e-04 -3.82e-04 -1.04e-04
# Matheson_2018 - SandyBar_2017          -3.72e-04 -5.21e-04 -2.24e-04
# Matheson_2018 - SandyBar_2018          -2.05e-04 -3.25e-04 -8.47e-05
# Matheson_2018 - WinnipegRiver_2017     -8.97e-04 -1.45e-03 -3.06e-04
# RedRiver_2017 - RedRiver_2018           3.59e-04  1.80e-04  5.41e-04
# RedRiver_2017 - SandyBar_2017           2.29e-04  3.83e-05  4.20e-04
# RedRiver_2017 - SandyBar_2018           3.96e-04  2.19e-04  5.75e-04
# RedRiver_2017 - WinnipegRiver_2017     -2.95e-04 -8.55e-04  3.03e-04
# RedRiver_2018 - SandyBar_2017          -1.30e-04 -2.94e-04  3.64e-05
# RedRiver_2018 - SandyBar_2018           3.57e-05 -1.01e-04  1.75e-04
# RedRiver_2018 - WinnipegRiver_2017     -6.54e-04 -1.21e-03 -6.81e-05
# SandyBar_2017 - SandyBar_2018           1.67e-04  1.05e-05  3.23e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.24e-04 -1.08e-03  6.55e-05
# SandyBar_2018 - WinnipegRiver_2017     -6.92e-04 -1.24e-03 -1.03e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C14_2OH, ~ Site_Year))
test_C14_2OH_plot<- plot(emmeans(test_C14_2OH, ~ Site_Year)) #### That's the one!!!!!!
test_C14_2OH_plot
plot(emmeans(test_C14_2OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C14_2OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C14_2OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C14_2OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C14_2OH_tets_plot <- gather_emmeans_draws(emmeans(test_C14_2OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C14_2OH_test_plot.png")
save(test_C14_2OH, file = " C14_2OH_simple_model.RData")

#### C14_1OH ####
hist(carn_dataf$C14_1OH)
test_C14_1OH <- brm(data=carn_dataf,
                    family = student,
                    bf(C14_1OH ~ Site_Year + K + Sex,
                       sigma ~ Site_Year + K + Sex),
                    prior = c(prior(normal(0,0.0015), class = b),
                              prior(normal(0,0.0015), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C14_1OH)
pp_check(test_C14_1OH, ndraws = 100) +
  theme_bw()
summary(test_C14_1OH)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C14_1OH ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    56187    50447
# sigma_Intercept                      -6.93      0.88    -8.70    -5.23 1.00    24646    31076
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    51553    46438
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    51182    45420
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    53377    47370
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    53564    48427
# Site_YearRedRiver_2018                0.00      0.00    -0.00     0.00 1.00    57473    47983
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    52616    45652
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    52016    46926
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    65338    39676
# K                                    -0.00      0.00    -0.00     0.00 1.00    56189    48882
# SexM                                  0.00      0.00    -0.00     0.00 1.00    52447    52243
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    58074    34504
# sigma_Site_YearDauphinRiver_2018     -0.48      0.40    -1.23     0.33 1.00    21164    31818
# sigma_Site_YearMatheson_2017         -1.18      0.53    -2.16    -0.05 1.00    30010    33409
# sigma_Site_YearMatheson_2018         -1.04      0.35    -1.69    -0.30 1.00    19081    24522
# sigma_Site_YearRedRiver_2017         -0.10      0.35    -0.78     0.59 1.00    19894    28830
# sigma_Site_YearRedRiver_2018         -0.17      0.33    -0.81     0.50 1.00    19653    29882
# sigma_Site_YearSandyBar_2017         -0.43      0.32    -1.04     0.20 1.00    17989    27712
# sigma_Site_YearSandyBar_2018         -0.62      0.34    -1.26     0.07 1.00    20543    29811
# sigma_Site_YearWinnipegRiver_2017     0.00      0.57    -0.98     1.27 1.00    24523    27775
# sigma_K                              -0.73      0.74    -2.19     0.74 1.00    27485    36885
# sigma_SexM                           -0.19      0.25    -0.68     0.32 1.00    28822    36900
# sigma_SexUN                           0.67      0.55    -0.44     1.69 1.00    18283    34582
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    14.03     12.04     2.76    47.13 1.00    16323    30313
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C14_1OH, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000813  0.000555  0.001100
# DauphinRiver_2018  0.000443  0.000216  0.000682
# Matheson_2017      0.000695  0.000489  0.000913
# Matheson_2018      0.000483  0.000299  0.000691
# RedRiver_2017      0.001185  0.000941  0.001446
# RedRiver_2018      0.000910  0.000672  0.001164
# SandyBar_2017      0.000824  0.000641  0.001032
# SandyBar_2018      0.000748  0.000571  0.000951
# WinnipegRiver_2017 0.001550  0.001021  0.002076
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C14_1OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   3.71e-04  5.26e-05  7.09e-04
# DauphinRiver_2017 - Matheson_2017       1.23e-04 -1.52e-04  4.08e-04
# DauphinRiver_2017 - Matheson_2018       3.33e-04  4.11e-05  6.27e-04
# DauphinRiver_2017 - RedRiver_2017      -3.70e-04 -6.65e-04 -4.88e-05
# DauphinRiver_2017 - RedRiver_2018      -9.43e-05 -3.90e-04  2.03e-04
# DauphinRiver_2017 - SandyBar_2017      -9.86e-06 -2.68e-04  2.66e-04
# DauphinRiver_2017 - SandyBar_2018       6.34e-05 -1.92e-04  3.39e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -7.28e-04 -1.25e-03 -1.71e-04
# DauphinRiver_2018 - Matheson_2017      -2.55e-04 -5.18e-04  3.11e-05
# DauphinRiver_2018 - Matheson_2018      -4.44e-05 -2.71e-04  1.96e-04
# DauphinRiver_2018 - RedRiver_2017      -7.44e-04 -1.04e-03 -4.46e-04
# DauphinRiver_2018 - RedRiver_2018      -4.67e-04 -7.66e-04 -1.69e-04
# DauphinRiver_2018 - SandyBar_2017      -3.82e-04 -6.44e-04 -1.32e-04
# DauphinRiver_2018 - SandyBar_2018      -3.07e-04 -5.57e-04 -4.74e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -1.10e-03 -1.65e-03 -5.32e-04
# Matheson_2017 - Matheson_2018           2.14e-04 -6.88e-06  4.24e-04
# Matheson_2017 - RedRiver_2017          -4.92e-04 -7.69e-04 -2.20e-04
# Matheson_2017 - RedRiver_2018          -2.17e-04 -4.75e-04  3.83e-05
# Matheson_2017 - SandyBar_2017          -1.31e-04 -3.43e-04  8.66e-05
# Matheson_2017 - SandyBar_2018          -5.66e-05 -2.70e-04  1.48e-04
# Matheson_2017 - WinnipegRiver_2017     -8.54e-04 -1.36e-03 -2.83e-04
# Matheson_2018 - RedRiver_2017          -7.02e-04 -9.69e-04 -4.38e-04
# Matheson_2018 - RedRiver_2018          -4.25e-04 -6.88e-04 -1.66e-04
# Matheson_2018 - SandyBar_2017          -3.40e-04 -5.46e-04 -1.31e-04
# Matheson_2018 - SandyBar_2018          -2.66e-04 -4.70e-04 -6.04e-05
# Matheson_2018 - WinnipegRiver_2017     -1.06e-03 -1.59e-03 -5.09e-04
# RedRiver_2017 - RedRiver_2018           2.76e-04 -7.94e-06  5.59e-04
# RedRiver_2017 - SandyBar_2017           3.61e-04  1.18e-04  6.06e-04
# RedRiver_2017 - SandyBar_2018           4.36e-04  1.76e-04  6.88e-04
# RedRiver_2017 - WinnipegRiver_2017     -3.58e-04 -9.09e-04  1.76e-04
# RedRiver_2018 - SandyBar_2017           8.47e-05 -1.56e-04  3.27e-04
# RedRiver_2018 - SandyBar_2018           1.59e-04 -8.31e-05  4.07e-04
# RedRiver_2018 - WinnipegRiver_2017     -6.34e-04 -1.19e-03 -9.90e-05
# SandyBar_2017 - SandyBar_2018           7.41e-05 -1.21e-04  2.72e-04
# SandyBar_2017 - WinnipegRiver_2017     -7.20e-04 -1.23e-03 -1.87e-04
# SandyBar_2018 - WinnipegRiver_2017     -7.96e-04 -1.31e-03 -2.67e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C14_1OH, ~ Site_Year))
test_C14_1OH_plot<- plot(emmeans(test_C14_1OH, ~ Site_Year)) #### That's the one!!!!!!
test_C14_1OH_plot
plot(emmeans(test_C14_1OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C14_1OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C14_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C14_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C14_1OH_test_plot <- gather_emmeans_draws(emmeans(test_C14_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C14_1OH_test_plot.png")
ggsave("C14_1OH_test_plot.png")
save(test_C14_1OH, file = " C14_1OH_simple_model.RData")

C14_1OH_draws <- model_draws(test_C14_1OH)
C14_1OH_draws
test_C14_1OH_site_year_plot <- ggplot(data = C14_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C14_1OH_site_year_plot.pdf", plot = test_C14_1OH_site_year_plot, dpi = 900)
test_C14_1OH_site_year_plot

test_C14_1OH_site_year_plot2 <- ggplot(data = C14_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C14:1OH (uM)") +
  ylab(element_blank()) +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.80), legend.background = element_blank())
test_C14_1OH_site_year_plot2
ggsave(filename = "test_C14_1OH_site_year_plot2.pdf", plot = test_C14_1OH_site_year_plot2, dpi = 900)

ggsave("test_C14_1OH_site_year_plot2.png")

test_C14_1OH_site_year_plot3 <- ggplot(data = C14_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C14:1OH (uM)") +
  ylab(element_blank()) +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C14_1OH_site_year_plot3
ggsave(filename = "test_C14_1OH_site_year_plot3.pdf", plot = test_C14_1OH_site_year_plot3, dpi = 900)

ggsave("test_C14_1OH_site_year_plot3.png")

#### C14_1 ####
hist(carn_dataf$ C14_1)
test_C14_1 <- brm(data=carn_dataf,
                  family = student,
                  bf(C14_1 ~ Site_Year + K + Sex,
                     sigma ~ Site_Year + K + Sex),
                  prior = c(prior(normal(0,0.002), class = b),
                            prior(normal(0,0.002), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C14_1)
pp_check(test_C14_1, ndraws = 100) +
  theme_bw()
summary(test_C14_1)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C14_1 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    48265    45036
# sigma_Intercept                      -6.58      1.08    -8.75    -4.53 1.00    19548    25429
# Site_YearDauphinRiver_2018            0.00      0.00     0.00     0.00 1.00    57486    44396
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    40729    42794
# Site_YearMatheson_2018                0.00      0.00     0.00     0.00 1.00    53953    45354
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    50270    45634
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    55609    45961
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    48083    46039
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    52418    44898
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    46214    43768
# K                                    -0.00      0.00    -0.00     0.00 1.00    47838    45718
# SexM                                 -0.00      0.00    -0.00     0.00 1.00    45540    45701
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    58078    38760
# sigma_Site_YearDauphinRiver_2018      0.18      0.45    -0.70     1.08 1.00    17045    27990
# sigma_Site_YearMatheson_2017         -0.96      0.67    -2.27     0.40 1.00    20188    24715
# sigma_Site_YearMatheson_2018         -0.54      0.44    -1.39     0.35 1.00    17129    28174
# sigma_Site_YearRedRiver_2017          0.48      0.40    -0.31     1.26 1.00    19199    25022
# sigma_Site_YearRedRiver_2018          0.90      0.39     0.16     1.69 1.00    16003    26160
# sigma_Site_YearSandyBar_2017         -0.27      0.37    -0.97     0.47 1.00    14776    20048
# sigma_Site_YearSandyBar_2018          0.20      0.41    -0.62     1.02 1.00    19366    20080
# sigma_Site_YearWinnipegRiver_2017    -0.60      0.82    -2.39     0.95 1.00    14270     5324
# sigma_K                              -1.20      0.87    -2.90     0.53 1.00    20698     7635
# sigma_SexM                           -0.75      0.30    -1.34    -0.18 1.00    21189    18296
# sigma_SexUN                           0.38      0.46    -0.51     1.30 1.00    28229    30563
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     3.96      3.51     1.63    12.54 1.00    14495    18314
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C14_1, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000785  0.000560  0.001035
# DauphinRiver_2018  0.001652  0.001339  0.001980
# Matheson_2017      0.000721  0.000499  0.000968
# Matheson_2018      0.001425  0.001185  0.001655
# RedRiver_2017      0.001576  0.001220  0.001983
# RedRiver_2018      0.002110  0.001676  0.002565
# SandyBar_2017      0.000842  0.000636  0.001042
# SandyBar_2018      0.001825  0.001572  0.002099
# WinnipegRiver_2017 0.001603  0.001209  0.001940
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C14_1, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018  -8.70e-04 -1.21e-03 -4.90e-04
# DauphinRiver_2017 - Matheson_2017       6.39e-05 -1.82e-04  3.28e-04
# DauphinRiver_2017 - Matheson_2018      -6.38e-04 -9.08e-04 -3.57e-04
# DauphinRiver_2017 - RedRiver_2017      -7.89e-04 -1.17e-03 -4.47e-04
# DauphinRiver_2017 - RedRiver_2018      -1.32e-03 -1.76e-03 -8.82e-04
# DauphinRiver_2017 - SandyBar_2017      -5.74e-05 -2.52e-04  1.48e-04
# DauphinRiver_2017 - SandyBar_2018      -1.04e-03 -1.31e-03 -7.67e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -8.16e-04 -1.11e-03 -4.22e-04
# DauphinRiver_2018 - Matheson_2017       9.28e-04  5.73e-04  1.30e-03
# DauphinRiver_2018 - Matheson_2018       2.31e-04 -1.29e-04  5.84e-04
# DauphinRiver_2018 - RedRiver_2017       7.46e-05 -4.11e-04  5.12e-04
# DauphinRiver_2018 - RedRiver_2018      -4.55e-04 -9.62e-04  6.92e-05
# DauphinRiver_2018 - SandyBar_2017       8.12e-04  4.72e-04  1.16e-03
# DauphinRiver_2018 - SandyBar_2018      -1.73e-04 -5.49e-04  2.10e-04
# DauphinRiver_2018 - WinnipegRiver_2017  5.48e-05 -3.91e-04  5.41e-04
# Matheson_2017 - Matheson_2018          -7.04e-04 -9.67e-04 -4.37e-04
# Matheson_2017 - RedRiver_2017          -8.60e-04 -1.29e-03 -4.56e-04
# Matheson_2017 - RedRiver_2018          -1.39e-03 -1.83e-03 -9.36e-04
# Matheson_2017 - SandyBar_2017          -1.22e-04 -3.34e-04  1.01e-04
# Matheson_2017 - SandyBar_2018          -1.10e-03 -1.37e-03 -8.36e-04
# Matheson_2017 - WinnipegRiver_2017     -8.87e-04 -1.23e-03 -4.37e-04
# Matheson_2018 - RedRiver_2017          -1.54e-04 -5.69e-04  2.03e-04
# Matheson_2018 - RedRiver_2018          -6.86e-04 -1.15e-03 -2.32e-04
# Matheson_2018 - SandyBar_2017           5.83e-04  3.45e-04  8.23e-04
# Matheson_2018 - SandyBar_2018          -4.01e-04 -7.00e-04 -1.10e-04
# Matheson_2018 - WinnipegRiver_2017     -1.77e-04 -5.42e-04  2.25e-04
# RedRiver_2017 - RedRiver_2018          -5.25e-04 -1.05e-03  4.08e-06
# RedRiver_2017 - SandyBar_2017           7.34e-04  4.01e-04  1.11e-03
# RedRiver_2017 - SandyBar_2018          -2.48e-04 -6.45e-04  1.85e-04
# RedRiver_2017 - WinnipegRiver_2017     -1.86e-05 -4.03e-04  4.51e-04
# RedRiver_2018 - SandyBar_2017           1.27e-03  8.37e-04  1.70e-03
# RedRiver_2018 - SandyBar_2018           2.82e-04 -1.78e-04  7.44e-04
# RedRiver_2018 - WinnipegRiver_2017      5.16e-04 -2.56e-06  1.06e-03
# SandyBar_2017 - SandyBar_2018          -9.83e-04 -1.24e-03 -7.41e-04
# SandyBar_2017 - WinnipegRiver_2017     -7.61e-04 -1.07e-03 -3.85e-04
# SandyBar_2018 - WinnipegRiver_2017      2.24e-04 -1.42e-04  6.70e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C14_1, ~ Site_Year))
test_C14_1_plot<- plot(emmeans(test_C14_1, ~ Site_Year)) #### That's the one!!!!!!
test_C14_1_plot
plot(emmeans(test_C14_1, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C14_1, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C14, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C14_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C14_1_test_plot <- gather_emmeans_draws(emmeans(test_C14_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C14_1_test_plot.png")
save(test_C14_1, file = " C14_1_simple_model.RData")

C14_1_draws <- model_draws(test_C14_1)
c14_1_draws


test_C14_1_site_year_plot <- ggplot(data = C14_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C14_1_site_year_plot.pdf", plot = test_C14_1_site_year_plot, dpi = 900)
test_C14_1_site_year_plot

test_C14_1_site_year_plot2 <- ggplot(data = C14_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C14:1 (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_C14_1_site_year_plot2
ggsave(filename = "test_C14_1_site_year_plot2.pdf", plot = test_leu_site_year_plot2, dpi = 900)

ggsave("test_C14_1_site_year_plot2.png")

test_C14_1_site_year_plot3 <- ggplot(data = C14_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C14:1 (uM)") +
  ylab(element_blank()) +  
  theme_bw(base_size = 22) +
  theme(legend.position="none") 
test_C14_1_site_year_plot3
ggsave(filename = "test_C14_1_site_year_plot3.pdf", plot = test_C14_1_site_year_plot3, dpi = 900)

ggsave("test_C14_1_site_year_plot3.png")

test_C14_1_site_year_plot4 <- ggplot(data = C14_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C14_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C14:1 (µM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.24), legend.background = element_blank())
test_C14_1_site_year_plot4
ggsave(filename = "test_C14_1_site_year_plot4.pdf", plot = test_C14_1_site_year_plot4, dpi = 900)

ggsave("test_C14_1_site_year_plot4.png")

#### C14 ####
hist(carn_dataf$C14)
test_C14 <- brm(data=carn_dataf,
                family = student,
                bf(C14 ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,0.0015), class = b),
                          prior(normal(0,0.0015), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C14)
pp_check(test_C14, ndraws = 100) +
  theme_bw()
summary(test_C14)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C14 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    60442    48445
# sigma_Intercept                      -6.71      0.95    -8.66    -4.93 1.00    19178    26839
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    65299    49224
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    57441    48436
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    60022    46555
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    63607    50728
# Site_YearRedRiver_2018                0.00      0.00    -0.00     0.00 1.00    63842    49795
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    63601    49473
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    53675    47017
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    64247    45641
# K                                    -0.00      0.00    -0.00     0.00 1.00    62086    48189
# SexM                                 -0.00      0.00    -0.00     0.00 1.00    58521    55514
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    58530    35492
# sigma_Site_YearDauphinRiver_2018     -0.37      0.41    -1.16     0.45 1.00    17118    28553
# sigma_Site_YearMatheson_2017         -1.09      0.55    -2.08     0.07 1.00    24130    30338
# sigma_Site_YearMatheson_2018         -0.83      0.40    -1.57     0.00 1.00    15864    26297
# sigma_Site_YearRedRiver_2017          0.03      0.35    -0.65     0.71 1.00    19416    30260
# sigma_Site_YearRedRiver_2018         -0.10      0.35    -0.77     0.59 1.00    18034    28587
# sigma_Site_YearSandyBar_2017         -0.09      0.33    -0.72     0.57 1.00    16385    28590
# sigma_Site_YearSandyBar_2018         -0.50      0.36    -1.17     0.23 1.00    17177    29710
# sigma_Site_YearWinnipegRiver_2017    -0.15      0.59    -1.20     1.14 1.00    25701    30269
# sigma_K                              -0.76      0.76    -2.22     0.76 1.00    24969    33847
# sigma_SexM                           -0.20      0.24    -0.66     0.28 1.00    29419    35983
# sigma_SexUN                           0.66      0.54    -0.37     1.71 1.00    21328    35612
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     8.30      7.94     2.36    31.57 1.00    16514    27640
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C14, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.001214  0.000902  0.001573
# DauphinRiver_2018  0.000612  0.000303  0.000948
# Matheson_2017      0.000987  0.000708  0.001273
# Matheson_2018      0.000667  0.000405  0.000946
# RedRiver_2017      0.001604  0.001256  0.001980
# RedRiver_2018      0.001389  0.001071  0.001738
# SandyBar_2017      0.001477  0.001174  0.001790
# SandyBar_2018      0.001111  0.000862  0.001383
# WinnipegRiver_2017 0.002127  0.001543  0.002680
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C14, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   6.03e-04  2.00e-04  1.01e-03
# DauphinRiver_2017 - Matheson_2017       2.29e-04 -1.08e-04  5.86e-04
# DauphinRiver_2017 - Matheson_2018       5.48e-04  1.87e-04  9.27e-04
# DauphinRiver_2017 - RedRiver_2017      -3.88e-04 -7.76e-04 -1.03e-05
# DauphinRiver_2017 - RedRiver_2018      -1.74e-04 -5.46e-04  1.96e-04
# DauphinRiver_2017 - SandyBar_2017      -2.62e-04 -6.06e-04  1.03e-04
# DauphinRiver_2017 - SandyBar_2018       1.03e-04 -2.26e-04  4.44e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -9.02e-04 -1.49e-03 -3.21e-04
# DauphinRiver_2018 - Matheson_2017      -3.75e-04 -7.39e-04 -1.10e-05
# DauphinRiver_2018 - Matheson_2018      -5.67e-05 -3.95e-04  2.68e-04
# DauphinRiver_2018 - RedRiver_2017      -9.92e-04 -1.42e-03 -5.83e-04
# DauphinRiver_2018 - RedRiver_2018      -7.75e-04 -1.18e-03 -3.64e-04
# DauphinRiver_2018 - SandyBar_2017      -8.64e-04 -1.24e-03 -4.81e-04
# DauphinRiver_2018 - SandyBar_2018      -4.97e-04 -8.49e-04 -1.33e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -1.51e-03 -2.11e-03 -8.63e-04
# Matheson_2017 - Matheson_2018           3.22e-04  2.31e-05  6.08e-04
# Matheson_2017 - RedRiver_2017          -6.19e-04 -1.00e-03 -2.43e-04
# Matheson_2017 - RedRiver_2018          -4.02e-04 -7.61e-04 -6.10e-05
# Matheson_2017 - SandyBar_2017          -4.91e-04 -8.17e-04 -1.66e-04
# Matheson_2017 - SandyBar_2018          -1.25e-04 -4.11e-04  1.59e-04
# Matheson_2017 - WinnipegRiver_2017     -1.14e-03 -1.70e-03 -5.37e-04
# Matheson_2018 - RedRiver_2017          -9.38e-04 -1.32e-03 -5.55e-04
# Matheson_2018 - RedRiver_2018          -7.21e-04 -1.07e-03 -3.49e-04
# Matheson_2018 - SandyBar_2017          -8.11e-04 -1.14e-03 -4.76e-04
# Matheson_2018 - SandyBar_2018          -4.44e-04 -7.36e-04 -1.46e-04
# Matheson_2018 - WinnipegRiver_2017     -1.46e-03 -2.02e-03 -8.33e-04
# RedRiver_2017 - RedRiver_2018           2.15e-04 -1.79e-04  6.16e-04
# RedRiver_2017 - SandyBar_2017           1.26e-04 -2.44e-04  5.03e-04
# RedRiver_2017 - SandyBar_2018           4.92e-04  1.31e-04  8.81e-04
# RedRiver_2017 - WinnipegRiver_2017     -5.13e-04 -1.10e-03  8.18e-05
# RedRiver_2018 - SandyBar_2017          -8.91e-05 -4.56e-04  2.71e-04
# RedRiver_2018 - SandyBar_2018           2.76e-04 -5.91e-05  6.12e-04
# RedRiver_2018 - WinnipegRiver_2017     -7.31e-04 -1.31e-03 -1.17e-04
# SandyBar_2017 - SandyBar_2018           3.65e-04  4.36e-05  6.78e-04
# SandyBar_2017 - WinnipegRiver_2017     -6.42e-04 -1.22e-03 -5.40e-05
# SandyBar_2018 - WinnipegRiver_2017     -1.01e-03 -1.59e-03 -4.40e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C14, ~ Site_Year))
test_C14_plot<- plot(emmeans(test_C14, ~ Site_Year)) #### That's the one!!!!!!
test_C14_plot
plot(emmeans(test_C14, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C14, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C14, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C14, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)

gather_emmeans_draws(emmeans(test_C14, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C14_test_plot<- gather_emmeans_draws(emmeans(test_C14, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C14_test_plot
ggsave("C14_test_plot.png")
save(test_C14, file = " C14_simple_model.RData")

# graph
model_dataframe_test_C14 <- test_C14 %>% 
  spread_draws(., `[\\(b].*`, regex = TRUE) %>% 
  pivot_longer(cols = b_Intercept:b_Site_YearWinnipegRiver_2017, names_to = "site_year", values_to = "est") %>% 
  separate(site_year, into = c("b", "placeholder", "Site", "Year"), sep = "_") %>% 
  select(-b, -placeholder) %>% 
  mutate(Site = str_remove(Site, "Year"))
model_dataframe_test_C14$Site<- factor(model_dataframe_test_C14$Site, levels = c("DauphinRiver", "Matheson", "SandyBar", "RedRiver", "WinnipegRiver"))

C14_draws <- model_draws(test_C14)

C14_draws <- model_draws(test_C14)

test_C14_site_year_plot <- ggplot(data = C14_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C14_site_year_plot.pdf", plot = test_C14_site_year_plot, dpi = 900)
test_C14_site_year_plot

test_C14_site_year_plot2 <- ggplot(data = C14_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C14 (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_C14_site_year_plot2
ggsave(filename = "test_C14_site_year_plot2.pdf", plot = test_C14_site_year_plot2, dpi = 900)

ggsave("test_C14_site_year_plot2.png")

test_C14_site_year_plot3 <- ggplot(data = C14_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C14_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C14_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C14 (uM)") +
  ylab("Site of capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C14_site_year_plot3
ggsave(filename = "test_C14_site_year_plot3.pdf", plot = test_C14_site_year_plot3, dpi = 900)

ggsave("test_C14_site_year_plot3.png")


#### C16 ####
hist(carn_dataf$ C16)
test_C16 <- brm(data=carn_dataf,
                family = student,
                bf(C16 ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,0.002), class = b),
                          prior(normal(0,0.002), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C16)
pp_check(test_C16, ndraws = 100) +
  theme_bw()
summary(test_C16)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C16 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    76191    46233
# sigma_Intercept                      -6.25      1.00    -8.25    -4.33 1.00    21379    31679
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    62860    47603
# Site_YearMatheson_2017                0.00      0.00    -0.00     0.00 1.00    59467    40226
# Site_YearMatheson_2018                0.00      0.00    -0.00     0.00 1.00    60585    47472
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    61084    47663
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    66291    47397
# Site_YearSandyBar_2017                0.00      0.00     0.00     0.00 1.00    63042    47959
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    60248    46576
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    58202    36721
# K                                    -0.00      0.00    -0.00    -0.00 1.00    73764    46228
# SexM                                  0.00      0.00    -0.00     0.00 1.00    45833    45555
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    77489    37752
# sigma_Site_YearDauphinRiver_2018      0.24      0.44    -0.60     1.11 1.00    15345    25560
# sigma_Site_YearMatheson_2017         -0.51      0.56    -1.55     0.65 1.00    22407    28842
# sigma_Site_YearMatheson_2018         -0.18      0.42    -1.00     0.66 1.00    17293    29221
# sigma_Site_YearRedRiver_2017          0.53      0.39    -0.22     1.29 1.00    15576    26891
# sigma_Site_YearRedRiver_2018          0.55      0.39    -0.19     1.32 1.00    15401    25949
# sigma_Site_YearSandyBar_2017          0.23      0.37    -0.48     0.95 1.00    16522    26625
# sigma_Site_YearSandyBar_2018          0.45      0.39    -0.31     1.22 1.00    15901    26143
# sigma_Site_YearWinnipegRiver_2017     0.45      0.65    -0.73     1.81 1.00    22497    28794
# sigma_K                              -1.06      0.83    -2.71     0.57 1.00    24201    32774
# sigma_SexM                            0.04      0.26    -0.46     0.56 1.00    28285    35610
# sigma_SexUN                           0.63      0.46    -0.26     1.55 1.00    25953    32712
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     5.53      4.97     2.02    19.12 1.00    17331    19616
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C16, ~ Site_Year)
# Site_Year           emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.00147  0.000958   0.00204
# DauphinRiver_2018  0.00125  0.000603   0.00194
# Matheson_2017      0.00152  0.000940   0.00216
# Matheson_2018      0.00178  0.001237   0.00236
# RedRiver_2017      0.00319  0.002543   0.00389
# RedRiver_2018      0.00311  0.002373   0.00390
# SandyBar_2017      0.00229  0.001744   0.00289
# SandyBar_2018      0.00274  0.001993   0.00347
# WinnipegRiver_2017 0.00311  0.001874   0.00414
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C16, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   2.32e-04 -5.60e-04  9.89e-04
# DauphinRiver_2017 - Matheson_2017      -4.55e-05 -6.56e-04  5.71e-04
# DauphinRiver_2017 - Matheson_2018      -3.07e-04 -9.18e-04  2.98e-04
# DauphinRiver_2017 - RedRiver_2017      -1.71e-03 -2.34e-03 -1.07e-03
# DauphinRiver_2017 - RedRiver_2018      -1.63e-03 -2.36e-03 -8.76e-04
# DauphinRiver_2017 - SandyBar_2017      -8.18e-04 -1.37e-03 -2.65e-04
# DauphinRiver_2017 - SandyBar_2018      -1.26e-03 -2.01e-03 -4.71e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -1.63e-03 -2.61e-03 -4.06e-04
# DauphinRiver_2018 - Matheson_2017      -2.76e-04 -1.06e-03  5.75e-04
# DauphinRiver_2018 - Matheson_2018      -5.40e-04 -1.24e-03  2.13e-04
# DauphinRiver_2018 - RedRiver_2017      -1.94e-03 -2.81e-03 -1.10e-03
# DauphinRiver_2018 - RedRiver_2018      -1.86e-03 -2.80e-03 -9.33e-04
# DauphinRiver_2018 - SandyBar_2017      -1.05e-03 -1.82e-03 -2.76e-04
# DauphinRiver_2018 - SandyBar_2018      -1.49e-03 -2.44e-03 -5.93e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -1.85e-03 -3.04e-03 -4.85e-04
# Matheson_2017 - Matheson_2018          -2.55e-04 -9.34e-04  3.67e-04
# Matheson_2017 - RedRiver_2017          -1.67e-03 -2.41e-03 -9.38e-04
# Matheson_2017 - RedRiver_2018          -1.59e-03 -2.41e-03 -7.62e-04
# Matheson_2017 - SandyBar_2017          -7.70e-04 -1.43e-03 -1.39e-04
# Matheson_2017 - SandyBar_2018          -1.22e-03 -2.05e-03 -4.05e-04
# Matheson_2017 - WinnipegRiver_2017     -1.59e-03 -2.67e-03 -3.04e-04
# Matheson_2018 - RedRiver_2017          -1.41e-03 -2.15e-03 -6.82e-04
# Matheson_2018 - RedRiver_2018          -1.32e-03 -2.15e-03 -5.18e-04
# Matheson_2018 - SandyBar_2017          -5.12e-04 -1.13e-03  8.82e-05
# Matheson_2018 - SandyBar_2018          -9.54e-04 -1.75e-03 -1.49e-04
# Matheson_2018 - WinnipegRiver_2017     -1.31e-03 -2.46e-03 -8.70e-05
# RedRiver_2017 - RedRiver_2018           8.39e-05 -7.59e-04  9.39e-04
# RedRiver_2017 - SandyBar_2017           8.93e-04  2.17e-04  1.57e-03
# RedRiver_2017 - SandyBar_2018           4.52e-04 -4.38e-04  1.33e-03
# RedRiver_2017 - WinnipegRiver_2017      8.77e-05 -9.68e-04  1.33e-03
# RedRiver_2018 - SandyBar_2017           8.09e-04  1.05e-05  1.57e-03
# RedRiver_2018 - SandyBar_2018           3.67e-04 -5.48e-04  1.33e-03
# RedRiver_2018 - WinnipegRiver_2017      1.30e-05 -1.19e-03  1.32e-03
# SandyBar_2017 - SandyBar_2018          -4.42e-04 -1.24e-03  3.38e-04
# SandyBar_2017 - WinnipegRiver_2017     -8.10e-04 -1.85e-03  4.07e-04
# SandyBar_2018 - WinnipegRiver_2017     -3.62e-04 -1.56e-03  9.65e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C16, ~ Site_Year))
test_C16_plot<- plot(emmeans(test_C16, ~ Site_Year)) #### That's the one!!!!!!
test_C16_plot
plot(emmeans(test_C16, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C16, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C16, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C16, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C16_test_plot <- gather_emmeans_draws(emmeans(test_C16, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16_test_plot.png")
save(test_C16, file = " C16_simple_model.RData")


C16_draws <- model_draws(test_C16)

test_C16_site_year_plot <- ggplot(data = C16_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C16_site_year_plot.pdf", plot = test_C16_site_year_plot, dpi = 900)
test_C16_site_year_plot

test_C16_site_year_plot2 <- ggplot(data = C16_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C16 (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_C16_site_year_plot2
ggsave(filename = "test_C16_site_year_plot2.pdf", plot = test_C16_site_year_plot2, dpi = 900)

ggsave("test_C16_site_year_plot2.png")

test_C16_site_year_plot3 <- ggplot(data = C16_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C16 (uM)") +
  ylab("Site of Capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C16_site_year_plot3

ggsave(filename = "test_C16_site_year_plot3.pdf", plot = test_C16_site_year_plot3, dpi = 900)

ggsave("test_C16_site_year_plot3.png")

#### C16OH ####
hist(carn_dataf$C16OH)
test_C16OH <- brm(data=carn_dataf,
                  family = student,
                  bf(C16OH ~ Site_Year + K + Sex,
                     sigma ~ Site_Year + K + Sex),
                  prior = c(prior(normal(0,80), class = b),
                            prior(normal(0,80), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C16OH)
pp_check(test_C16, ndraws = 100) +
  theme_bw()
#Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C16OH ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                            62.18     21.11    21.50   104.31 1.00    28533    36591
# sigma_Intercept                       3.66      0.99     1.75     5.62 1.00    32981    40651
# Site_YearDauphinRiver_2018          -13.27      9.75   -32.78     5.50 1.00    18359    27237
# Site_YearMatheson_2017               25.66     16.22    -7.44    56.71 1.00    31731    31510
# Site_YearMatheson_2018               -0.74      9.84   -20.83    17.98 1.00    19505    27355
# Site_YearRedRiver_2017               18.49      9.54    -0.80    36.91 1.00    22879    31168
# Site_YearRedRiver_2018               -4.87      9.84   -25.11    13.72 1.00    19111    27585
# Site_YearSandyBar_2017               24.74      9.46     5.68    43.00 1.00    21827    31847
# Site_YearSandyBar_2018              -14.30      9.32   -33.18     3.76 1.00    19867    28392
# Site_YearWinnipegRiver_2017         -14.93     13.64   -41.70    11.61 1.00    24327    28898
# K                                     1.51     16.50   -31.24    33.50 1.00    41248    42526
# SexM                                 -6.03      5.63   -16.95     5.32 1.00    41249    42268
# SexUN                                 1.90     11.18   -19.81    24.50 1.00    47015    37026
# sigma_Site_YearDauphinRiver_2018     -0.68      0.38    -1.43     0.08 1.00    25907    36067
# sigma_Site_YearMatheson_2017         -0.02      0.49    -0.91     1.01 1.00    34618    34470
# sigma_Site_YearMatheson_2018         -0.68      0.39    -1.45     0.09 1.00    25554    35088
# sigma_Site_YearRedRiver_2017         -0.24      0.34    -0.90     0.43 1.00    26541    35649
# sigma_Site_YearRedRiver_2018         -0.37      0.33    -1.00     0.29 1.00    27693    36800
# sigma_Site_YearSandyBar_2017         -0.14      0.31    -0.75     0.47 1.00    24000    35288
# sigma_Site_YearSandyBar_2018         -0.41      0.32    -1.03     0.23 1.00    29071    39235
# sigma_Site_YearWinnipegRiver_2017    -0.57      0.60    -1.64     0.72 1.00    29168    29637
# sigma_K                              -0.25      0.84    -1.90     1.38 1.00    35782    40555
# sigma_SexM                           -0.26      0.25    -0.73     0.23 1.00    33970    41106
# sigma_SexUN                           0.57      0.37    -0.13     1.31 1.00    45913    41059
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    18.06     12.74     3.85    51.05 1.00    32208    32893
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
summary(test_C16OH)
emmeans(test_C16OH, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    62.2      45.5      79.2
# DauphinRiver_2018    49.1      38.1      60.9
# Matheson_2017        88.4      58.0     118.9
# Matheson_2018        61.6      48.7      74.9
# RedRiver_2017        80.9      66.4      95.6
# RedRiver_2018        57.6      44.1      70.8
# SandyBar_2017        87.2      72.4     100.8
# SandyBar_2018        48.1      35.6      60.9
# WinnipegRiver_2017   47.2      24.7      71.9
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C16OH, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    13.121     -5.76    32.472
# DauphinRiver_2017 - Matheson_2017       -25.923    -57.34     6.547
# DauphinRiver_2017 - Matheson_2018         0.546    -18.81    19.798
# DauphinRiver_2017 - RedRiver_2017       -18.655    -37.07     0.625
# DauphinRiver_2017 - RedRiver_2018         4.571    -13.52    25.286
# DauphinRiver_2017 - SandyBar_2017       -24.866    -43.16    -5.944
# DauphinRiver_2017 - SandyBar_2018        14.140     -4.11    32.812
# DauphinRiver_2017 - WinnipegRiver_2017   14.907    -12.31    40.905
# DauphinRiver_2018 - Matheson_2017       -39.266    -70.76    -7.193
# DauphinRiver_2018 - Matheson_2018       -12.524    -26.44     1.722
# DauphinRiver_2018 - RedRiver_2017       -31.790    -48.67   -14.361
# DauphinRiver_2018 - RedRiver_2018        -8.476    -24.80     8.025
# DauphinRiver_2018 - SandyBar_2017       -38.121    -54.37   -21.328
# DauphinRiver_2018 - SandyBar_2018         0.962    -14.27    16.631
# DauphinRiver_2018 - WinnipegRiver_2017    1.971    -24.00    27.435
# Matheson_2017 - Matheson_2018            26.576     -5.70    57.272
# Matheson_2017 - RedRiver_2017             7.372    -25.06    39.526
# Matheson_2017 - RedRiver_2018            30.882     -2.08    62.152
# Matheson_2017 - SandyBar_2017             1.227    -31.43    31.873
# Matheson_2017 - SandyBar_2018            40.468      8.01    70.629
# Matheson_2017 - WinnipegRiver_2017       40.832      1.78    77.622
# Matheson_2018 - RedRiver_2017           -19.270    -36.60    -1.498
# Matheson_2018 - RedRiver_2018             4.041    -12.30    21.136
# Matheson_2018 - SandyBar_2017           -25.548    -42.01    -8.366
# Matheson_2018 - SandyBar_2018            13.576     -2.15    28.819
# Matheson_2018 - WinnipegRiver_2017       14.545    -11.79    40.166
# RedRiver_2017 - RedRiver_2018            23.242      6.07    40.021
# RedRiver_2017 - SandyBar_2017            -6.259    -23.14    10.586
# RedRiver_2017 - SandyBar_2018            32.778     15.89    49.767
# RedRiver_2017 - WinnipegRiver_2017       33.545      8.81    57.447
# RedRiver_2018 - SandyBar_2017           -29.651    -47.16   -13.168
# RedRiver_2018 - SandyBar_2018             9.330     -5.37    24.328
# RedRiver_2018 - WinnipegRiver_2017       10.357    -14.89    34.466
# SandyBar_2017 - SandyBar_2018            39.175     22.99    55.891
# SandyBar_2017 - WinnipegRiver_2017       39.971     14.41    64.762
# SandyBar_2018 - WinnipegRiver_2017        0.998    -25.10    25.527
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C16OH, ~ Site_Year))
test_C16OH_plot<- plot(emmeans(test_C16OH, ~ Site_Year)) #### That's the one!!!!!!
test_C16OH_plot
plot(emmeans(test_C16OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C16OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C16OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C16OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C16OH_test_plot <- gather_emmeans_draws(emmeans(test_C16OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16OH_test_plot.png")
save(test_C16OH, file = " C16OH_simple_model.RData")

#### C16_1OH ####
hist(carn_dataf$ C16_1OH)
test_C16_1OH <- brm(data=carn_dataf,
                    family = student,
                    bf(C16_1OH ~ Site_Year + K + Sex,
                       sigma ~ Site_Year + K + Sex),
                    prior = c(prior(normal(0,0.001), class = b),
                              prior(normal(0,0.001), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C16_1OH)
pp_check(test_C16_1OH, ndraws = 100) +
  theme_bw()
summary(test_C16_1OH)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C16_1OH ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    56353    50122
# sigma_Intercept                      -7.63      0.89    -9.35    -5.85 1.00    29618    35622
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    54696    51352
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    56794    47082
# Site_YearMatheson_2018               -0.00      0.00    -0.00     0.00 1.00    53937    47507
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    43825    47797
# Site_YearRedRiver_2018                0.00      0.00    -0.00     0.00 1.00    48817    50482
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    50784    48351
# Site_YearSandyBar_2018                0.00      0.00    -0.00     0.00 1.00    55208    49821
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    65338    42287
# K                                    -0.00      0.00    -0.00     0.00 1.00    50220    48400
# SexM                                  0.00      0.00    -0.00     0.00 1.00    41992    52853
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    60399    35690
# sigma_Site_YearDauphinRiver_2018     -0.27      0.40    -1.02     0.53 1.00    23644    33124
# sigma_Site_YearMatheson_2017         -0.65      0.48    -1.50     0.38 1.00    30586    30576
# sigma_Site_YearMatheson_2018         -1.10      0.34    -1.76    -0.43 1.00    22860    32881
# sigma_Site_YearRedRiver_2017         -0.27      0.34    -0.93     0.41 1.00    21416    31756
# sigma_Site_YearRedRiver_2018         -0.29      0.32    -0.91     0.35 1.00    20494    31489
# sigma_Site_YearSandyBar_2017         -0.30      0.30    -0.90     0.30 1.00    21122    30574
# sigma_Site_YearSandyBar_2018         -0.17      0.34    -0.83     0.51 1.00    22451    32754
# sigma_Site_YearWinnipegRiver_2017     0.32      0.55    -0.64     1.52 1.00    29296    31711
# sigma_K                              -0.20      0.77    -1.75     1.29 1.00    29405    34275
# sigma_SexM                           -0.06      0.26    -0.57     0.45 1.00    31448    35373
# sigma_SexUN                           0.50      0.52    -0.59     1.46 1.00    22582    34572
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    16.16     12.76     3.06    49.89 1.00    20631    31502
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

# emmeans(test_C16_1OH, ~ Site_Year)
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   3.12e-04  1.19e-07  6.28e-04
# DauphinRiver_2017 - Matheson_2017       1.21e-04 -1.89e-04  4.32e-04
# DauphinRiver_2017 - Matheson_2018       2.20e-04 -5.18e-05  4.79e-04
# DauphinRiver_2017 - RedRiver_2017      -3.10e-04 -6.00e-04 -1.19e-05
# DauphinRiver_2017 - RedRiver_2018      -1.49e-04 -4.23e-04  1.41e-04
# DauphinRiver_2017 - SandyBar_2017       4.82e-06 -2.49e-04  2.72e-04
# DauphinRiver_2017 - SandyBar_2018      -7.56e-05 -3.64e-04  2.27e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -5.86e-04 -1.23e-03  9.79e-05
# DauphinRiver_2018 - Matheson_2017      -1.92e-04 -5.01e-04  1.36e-04
# DauphinRiver_2018 - Matheson_2018      -9.72e-05 -3.12e-04  1.39e-04
# DauphinRiver_2018 - RedRiver_2017      -6.20e-04 -9.00e-04 -3.36e-04
# DauphinRiver_2018 - RedRiver_2018      -4.57e-04 -7.36e-04 -1.77e-04
# DauphinRiver_2018 - SandyBar_2017      -3.06e-04 -5.63e-04 -4.77e-05
# DauphinRiver_2018 - SandyBar_2018      -3.87e-04 -6.73e-04 -9.80e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -8.97e-04 -1.55e-03 -2.01e-04
# Matheson_2017 - Matheson_2018           1.01e-04 -1.70e-04  3.51e-04
# Matheson_2017 - RedRiver_2017          -4.29e-04 -7.25e-04 -1.10e-04
# Matheson_2017 - RedRiver_2018          -2.69e-04 -5.60e-04  1.89e-05
# Matheson_2017 - SandyBar_2017          -1.14e-04 -3.93e-04  1.59e-04
# Matheson_2017 - SandyBar_2018          -1.96e-04 -5.02e-04  1.04e-04
# Matheson_2017 - WinnipegRiver_2017     -7.09e-04 -1.37e-03 -6.11e-06
# Matheson_2018 - RedRiver_2017          -5.24e-04 -7.67e-04 -2.91e-04
# Matheson_2018 - RedRiver_2018          -3.65e-04 -5.91e-04 -1.33e-04
# Matheson_2018 - SandyBar_2017          -2.11e-04 -4.16e-04 -1.86e-05
# Matheson_2018 - SandyBar_2018          -2.92e-04 -5.34e-04 -5.67e-05
# Matheson_2018 - WinnipegRiver_2017     -8.06e-04 -1.42e-03 -9.89e-05
# RedRiver_2017 - RedRiver_2018           1.63e-04 -8.71e-05  4.05e-04
# RedRiver_2017 - SandyBar_2017           3.14e-04  9.16e-05  5.38e-04
# RedRiver_2017 - SandyBar_2018           2.35e-04 -4.51e-05  5.05e-04
# RedRiver_2017 - WinnipegRiver_2017     -2.76e-04 -9.16e-04  3.88e-04
# RedRiver_2018 - SandyBar_2017           1.53e-04 -7.18e-05  3.74e-04
# RedRiver_2018 - SandyBar_2018           7.18e-05 -1.78e-04  3.30e-04
# RedRiver_2018 - WinnipegRiver_2017     -4.40e-04 -1.05e-03  2.59e-04
# SandyBar_2017 - SandyBar_2018          -8.07e-05 -3.27e-04  1.62e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.93e-04 -1.21e-03  9.61e-05
# SandyBar_2018 - WinnipegRiver_2017     -5.12e-04 -1.16e-03  1.72e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C16_1OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   3.13e-04  7.21e-07  6.31e-04
# DauphinRiver_2017 - Matheson_2017       1.22e-04 -1.91e-04  4.32e-04
# DauphinRiver_2017 - Matheson_2018       2.20e-04 -4.23e-05  4.89e-04
# DauphinRiver_2017 - RedRiver_2017      -3.08e-04 -5.97e-04 -1.20e-05
# DauphinRiver_2017 - RedRiver_2018      -1.47e-04 -4.21e-04  1.39e-04
# DauphinRiver_2017 - SandyBar_2017       4.99e-06 -2.55e-04  2.71e-04
# DauphinRiver_2017 - SandyBar_2018      -7.39e-05 -3.68e-04  2.25e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -5.88e-04 -1.22e-03  8.94e-05
# DauphinRiver_2018 - Matheson_2017      -1.93e-04 -5.06e-04  1.35e-04
# DauphinRiver_2018 - Matheson_2018      -9.79e-05 -3.18e-04  1.34e-04
# DauphinRiver_2018 - RedRiver_2017      -6.20e-04 -9.02e-04 -3.42e-04
# DauphinRiver_2018 - RedRiver_2018      -4.57e-04 -7.31e-04 -1.75e-04
# DauphinRiver_2018 - SandyBar_2017      -3.06e-04 -5.52e-04 -4.07e-05
# DauphinRiver_2018 - SandyBar_2018      -3.86e-04 -6.74e-04 -9.70e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -8.99e-04 -1.54e-03 -2.22e-04
# Matheson_2017 - Matheson_2018           1.02e-04 -1.71e-04  3.49e-04
# Matheson_2017 - RedRiver_2017          -4.28e-04 -7.40e-04 -1.23e-04
# Matheson_2017 - RedRiver_2018          -2.67e-04 -5.46e-04  2.90e-05
# Matheson_2017 - SandyBar_2017          -1.14e-04 -3.87e-04  1.67e-04
# Matheson_2017 - SandyBar_2018          -1.95e-04 -4.95e-04  1.07e-04
# Matheson_2017 - WinnipegRiver_2017     -7.12e-04 -1.36e-03 -1.73e-05
# Matheson_2018 - RedRiver_2017          -5.24e-04 -7.72e-04 -2.96e-04
# Matheson_2018 - RedRiver_2018          -3.63e-04 -5.90e-04 -1.34e-04
# Matheson_2018 - SandyBar_2017          -2.11e-04 -4.10e-04 -1.35e-05
# Matheson_2018 - SandyBar_2018          -2.91e-04 -5.43e-04 -6.49e-05
# Matheson_2018 - WinnipegRiver_2017     -8.08e-04 -1.42e-03 -1.21e-04
# RedRiver_2017 - RedRiver_2018           1.64e-04 -8.50e-05  4.00e-04
# RedRiver_2017 - SandyBar_2017           3.14e-04  8.45e-05  5.33e-04
# RedRiver_2017 - SandyBar_2018           2.34e-04 -3.94e-05  5.04e-04
# RedRiver_2017 - WinnipegRiver_2017     -2.78e-04 -8.93e-04  3.99e-04
# RedRiver_2018 - SandyBar_2017           1.52e-04 -6.96e-05  3.75e-04
# RedRiver_2018 - SandyBar_2018           7.11e-05 -1.86e-04  3.17e-04
# RedRiver_2018 - WinnipegRiver_2017     -4.42e-04 -1.05e-03  2.53e-04
# SandyBar_2017 - SandyBar_2018          -8.02e-05 -3.23e-04  1.66e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.95e-04 -1.22e-03  6.81e-05
# SandyBar_2018 - WinnipegRiver_2017     -5.13e-04 -1.12e-03  1.96e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C16_1OH, ~ Site_Year))
test_C16_1OH_plot<- plot(emmeans(test_C16_1OH, ~ Site_Year)) #### That's the one!!!!!!
test_C16_1OH_plot
plot(emmeans(test_C16_1OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C16_1OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C16_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C16_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C16_1OH_test_plot <- gather_emmeans_draws(emmeans(test_C16_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16_1OH_test_plot.png")
save(test_C16_1OH, file = " C16_1OH_simple_model.RData")

C16_1OH_draws <- model_draws(test_C16_1OH)
C16_1OH_draws
test_C16_1OH_site_year_plot <- ggplot(data = C16_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C16_1OH_site_year_plot.pdf", plot = test_C16_1OH_site_year_plot, dpi = 900)
test_C16_1OH_site_year_plot

test_C16_1OH_site_year_plot2 <- ggplot(data = C16_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C16:1OH (uM)") +
  ylab(element_blank()) +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.80), legend.background = element_blank())
test_C16_1OH_site_year_plot2
ggsave(filename = "test_C16_1OH_site_year_plot2.pdf", plot = test_C16_1OH_site_year_plot2, dpi = 900)

ggsave("test_C16_1OH_site_year_plot2.png")

test_C16_1OH_site_year_plot3 <- ggplot(data = C16_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C16:1OH (uM)") +
  ylab(element_blank()) +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C16_1OH_site_year_plot3
ggsave(filename = "test_C16_1OH_site_year_plot3.pdf", plot = test_C16_1OH_site_year_plot3, dpi = 900)

ggsave("test_C16_1OH_site_year_plot3.png")

#### C16_2OH ####
hist(carn_dataf$ C16_2OH)
test_C16_2OH <- brm(data=carn_dataf,
                    family = student,
                    bf(C16_2OH ~ Site_Year + K + Sex,
                       sigma ~ Site_Year + K + Sex),
                    prior = c(prior(normal(0,0.001), class = b),
                              prior(normal(0,0.001), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C16_2OH)
pp_check(test_C16_2OH, ndraws = 100) +
  theme_bw()
summary(test_C16_2OH)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C16_2OH ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    56623    49364
# sigma_Intercept                      -7.36      0.85    -9.05    -5.68 1.00    24795    34541
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    51216    44326
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    54383    45934
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    50525    42301
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    47917    44941
# Site_YearRedRiver_2018               -0.00      0.00    -0.00     0.00 1.00    43253    43133
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    42455    44930
# Site_YearSandyBar_2018               -0.00      0.00    -0.00    -0.00 1.00    48639    44011
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    50625    45259
# K                                    -0.00      0.00    -0.00     0.00 1.00    51080    42797
# SexM                                  0.00      0.00    -0.00     0.00 1.00    49887    54391
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    54278    34978
# sigma_Site_YearDauphinRiver_2018     -0.93      0.41    -1.71    -0.10 1.00    21754    32288
# sigma_Site_YearMatheson_2017         -0.66      0.50    -1.56     0.43 1.00    24341    28430
# sigma_Site_YearMatheson_2018         -1.49      0.36    -2.20    -0.78 1.00    20241    30292
# sigma_Site_YearRedRiver_2017         -0.33      0.34    -0.98     0.34 1.00    18831    29190
# sigma_Site_YearRedRiver_2018         -0.64      0.34    -1.29     0.04 1.00    18041    30605
# sigma_Site_YearSandyBar_2017         -0.34      0.32    -0.94     0.30 1.00    16478    27700
# sigma_Site_YearSandyBar_2018         -0.86      0.34    -1.51    -0.16 1.00    19824    30358
# sigma_Site_YearWinnipegRiver_2017    -0.65      0.58    -1.67     0.63 1.00    25611    27432
# sigma_K                              -0.43      0.73    -1.88     0.99 1.00    25107    34331
# sigma_SexM                           -0.18      0.26    -0.69     0.32 1.00    26253    33035
# sigma_SexUN                           0.30      0.59    -0.87     1.41 1.00    16504    35664
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    11.66     11.00     2.44    42.83 1.00    13610    32533
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C16_2OH, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000818  0.000606  0.001056
# DauphinRiver_2018  0.000311  0.000195  0.000445
# Matheson_2017      0.000696  0.000453  0.000933
# Matheson_2018      0.000345  0.000242  0.000463
# RedRiver_2017      0.001017  0.000851  0.001193
# RedRiver_2018      0.000619  0.000491  0.000752
# SandyBar_2017      0.000779  0.000628  0.000933
# SandyBar_2018      0.000526  0.000418  0.000645
# WinnipegRiver_2017 0.001313  0.001023  0.001576
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C16_2OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   5.07e-04  2.66e-04  7.62e-04
# DauphinRiver_2017 - Matheson_2017       1.27e-04 -1.74e-04  4.42e-04
# DauphinRiver_2017 - Matheson_2018       4.74e-04  2.33e-04  7.20e-04
# DauphinRiver_2017 - RedRiver_2017      -1.96e-04 -4.51e-04  7.16e-05
# DauphinRiver_2017 - RedRiver_2018       1.99e-04 -3.17e-05  4.50e-04
# DauphinRiver_2017 - SandyBar_2017       4.02e-05 -2.14e-04  3.01e-04
# DauphinRiver_2017 - SandyBar_2018       2.91e-04  7.21e-05  5.38e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -4.91e-04 -8.21e-04 -1.43e-04
# DauphinRiver_2018 - Matheson_2017      -3.83e-04 -6.36e-04 -1.11e-04
# DauphinRiver_2018 - Matheson_2018      -3.65e-05 -1.58e-04  9.66e-05
# DauphinRiver_2018 - RedRiver_2017      -7.04e-04 -9.06e-04 -5.02e-04
# DauphinRiver_2018 - RedRiver_2018      -3.04e-04 -4.77e-04 -1.31e-04
# DauphinRiver_2018 - SandyBar_2017      -4.64e-04 -6.56e-04 -2.79e-04
# DauphinRiver_2018 - SandyBar_2018      -2.15e-04 -3.65e-04 -5.76e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -9.99e-04 -1.30e-03 -6.92e-04
# Matheson_2017 - Matheson_2018           3.51e-04  9.26e-05  5.90e-04
# Matheson_2017 - RedRiver_2017          -3.22e-04 -6.04e-04 -3.83e-05
# Matheson_2017 - RedRiver_2018           7.65e-05 -1.83e-04  3.36e-04
# Matheson_2017 - SandyBar_2017          -8.42e-05 -3.59e-04  1.86e-04
# Matheson_2017 - SandyBar_2018           1.68e-04 -8.61e-05  4.11e-04
# Matheson_2017 - WinnipegRiver_2017     -6.18e-04 -9.66e-04 -2.48e-04
# Matheson_2018 - RedRiver_2017          -6.70e-04 -8.64e-04 -4.76e-04
# Matheson_2018 - RedRiver_2018          -2.71e-04 -4.32e-04 -1.11e-04
# Matheson_2018 - SandyBar_2017          -4.31e-04 -6.11e-04 -2.57e-04
# Matheson_2018 - SandyBar_2018          -1.80e-04 -3.18e-04 -4.38e-05
# Matheson_2018 - WinnipegRiver_2017     -9.66e-04 -1.26e-03 -6.66e-04
# RedRiver_2017 - RedRiver_2018           3.98e-04  2.01e-04  5.93e-04
# RedRiver_2017 - SandyBar_2017           2.38e-04  3.19e-05  4.49e-04
# RedRiver_2017 - SandyBar_2018           4.90e-04  2.98e-04  6.81e-04
# RedRiver_2017 - WinnipegRiver_2017     -2.95e-04 -5.87e-04  8.28e-06
# RedRiver_2018 - SandyBar_2017          -1.60e-04 -3.39e-04  2.19e-05
# RedRiver_2018 - SandyBar_2018           9.08e-05 -6.03e-05  2.42e-04
# RedRiver_2018 - WinnipegRiver_2017     -6.93e-04 -9.78e-04 -3.92e-04
# SandyBar_2017 - SandyBar_2018           2.52e-04  7.29e-05  4.22e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.34e-04 -8.22e-04 -2.19e-04
# SandyBar_2018 - WinnipegRiver_2017     -7.86e-04 -1.07e-03 -4.85e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C16_2OH, ~ Site_Year))
test_C16_2OH_plot<- plot(emmeans(test_C16_2OH, ~ Site_Year)) #### That's the one!!!!!!
test_C16_2OH_plot
plot(emmeans(test_C16_2OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C16_2OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C16_2OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C16_2OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C16_2OH_test_plot <- gather_emmeans_draws(emmeans(test_C16_2OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16_2OH_test_plot.png")
save(test_C16_2OH, file = " C16_2OH_simple_model.RData")


#### C16_2 ####
hist(carn_dataf$C16_2)
test_C16_2 <- brm(data=carn_dataf,
                  family = student,
                  bf(C16_2 ~ Site_Year + K + Sex,
                     sigma ~ Site_Year + K + Sex),
                  prior = c(prior(normal(0,0.0005), class = b),
                            prior(normal(0,0.0005), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C16_2)
pp_check(test_C16_2, ndraws = 100) +
  theme_bw()
summary(test_C16_2)
Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C16_2 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    53046    49204
# sigma_Intercept                      -7.20      0.83    -8.82    -5.56 1.00    25119    33617
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    57938    43902
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    60529    45550
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    54389    42277
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    59126    48726
# Site_YearRedRiver_2018               -0.00      0.00    -0.00    -0.00 1.00    57559    43425
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    58128    47036
# Site_YearSandyBar_2018               -0.00      0.00    -0.00    -0.00 1.00    59460    44141
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    58866    42938
# K                                    -0.00      0.00    -0.00     0.00 1.00    54977    46966
# SexM                                  0.00      0.00    -0.00     0.00 1.00    57216    52416
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    58751    49740
# sigma_Site_YearDauphinRiver_2018     -1.18      0.37    -1.90    -0.46 1.00    20622    29448
# sigma_Site_YearMatheson_2017         -0.55      0.48    -1.41     0.49 1.00    26191    32082
# sigma_Site_YearMatheson_2018         -1.95      0.34    -2.61    -1.29 1.00    19732    28240
# sigma_Site_YearRedRiver_2017         -0.22      0.31    -0.85     0.39 1.00    21554    32229
# sigma_Site_YearRedRiver_2018         -1.28      0.30    -1.87    -0.68 1.00    21416    29905
# sigma_Site_YearSandyBar_2017         -0.23      0.28    -0.78     0.33 1.00    20518    27421
# sigma_Site_YearSandyBar_2018         -1.02      0.32    -1.64    -0.39 1.00    21894    31896
# sigma_Site_YearWinnipegRiver_2017    -0.41      0.55    -1.38     0.80 1.00    27590    29862
# sigma_K                              -0.65      0.70    -2.01     0.72 1.00    27802    36343
# sigma_SexM                           -0.16      0.24    -0.64     0.31 1.00    28392    37093
# sigma_SexUN                          -0.11      0.37    -0.82     0.66 1.00    34450    35832
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    16.69     12.36     3.55    49.28 1.00    24695    32294
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C16_2, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000697  0.000540  0.000863
# DauphinRiver_2018  0.000258  0.000190  0.000330
# Matheson_2017      0.000670  0.000451  0.000909
# Matheson_2018      0.000228  0.000168  0.000286
# RedRiver_2017      0.000748  0.000599  0.000897
# RedRiver_2018      0.000374  0.000315  0.000437
# SandyBar_2017      0.000626  0.000488  0.000768
# SandyBar_2018      0.000362  0.000288  0.000439
# WinnipegRiver_2017 0.001028  0.000744  0.001280
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C16_2, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   4.39e-04  2.65e-04  6.19e-04
# DauphinRiver_2017 - Matheson_2017       2.57e-05 -2.40e-04  2.91e-04
# DauphinRiver_2017 - Matheson_2018       4.70e-04  2.96e-04  6.45e-04
# DauphinRiver_2017 - RedRiver_2017      -5.14e-05 -2.63e-04  1.58e-04
# DauphinRiver_2017 - RedRiver_2018       3.22e-04  1.60e-04  4.92e-04
# DauphinRiver_2017 - SandyBar_2017       7.10e-05 -1.39e-04  2.77e-04
# DauphinRiver_2017 - SandyBar_2018       3.35e-04  1.61e-04  5.07e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -3.28e-04 -6.26e-04 -2.45e-05
# DauphinRiver_2018 - Matheson_2017      -4.13e-04 -6.56e-04 -1.78e-04
# DauphinRiver_2018 - Matheson_2018       3.00e-05 -4.33e-05  1.07e-04
# DauphinRiver_2018 - RedRiver_2017      -4.90e-04 -6.61e-04 -3.31e-04
# DauphinRiver_2018 - RedRiver_2018      -1.16e-04 -2.16e-04 -2.17e-05
# DauphinRiver_2018 - SandyBar_2017      -3.67e-04 -5.22e-04 -2.08e-04
# DauphinRiver_2018 - SandyBar_2018      -1.04e-04 -2.09e-04 -1.33e-06
# DauphinRiver_2018 - WinnipegRiver_2017 -7.69e-04 -1.04e-03 -4.83e-04
# Matheson_2017 - Matheson_2018           4.45e-04  2.09e-04  6.79e-04
# Matheson_2017 - RedRiver_2017          -7.72e-05 -3.44e-04  1.95e-04
# Matheson_2017 - RedRiver_2018           2.95e-04  7.57e-05  5.42e-04
# Matheson_2017 - SandyBar_2017           4.47e-05 -2.14e-04  3.15e-04
# Matheson_2017 - SandyBar_2018           3.08e-04  7.60e-05  5.51e-04
# Matheson_2017 - WinnipegRiver_2017     -3.55e-04 -6.91e-04  8.07e-06
# Matheson_2018 - RedRiver_2017          -5.21e-04 -6.86e-04 -3.65e-04
# Matheson_2018 - RedRiver_2018          -1.47e-04 -2.37e-04 -5.91e-05
# Matheson_2018 - SandyBar_2017          -3.98e-04 -5.51e-04 -2.49e-04
# Matheson_2018 - SandyBar_2018          -1.35e-04 -2.34e-04 -4.19e-05
# Matheson_2018 - WinnipegRiver_2017     -8.00e-04 -1.07e-03 -5.13e-04
# RedRiver_2017 - RedRiver_2018           3.73e-04  2.18e-04  5.30e-04
# RedRiver_2017 - SandyBar_2017           1.23e-04 -7.46e-05  3.21e-04
# RedRiver_2017 - SandyBar_2018           3.86e-04  2.25e-04  5.54e-04
# RedRiver_2017 - WinnipegRiver_2017     -2.77e-04 -5.69e-04  2.75e-05
# RedRiver_2018 - SandyBar_2017          -2.52e-04 -3.96e-04 -9.91e-05
# RedRiver_2018 - SandyBar_2018           1.23e-05 -7.84e-05  1.04e-04
# RedRiver_2018 - WinnipegRiver_2017     -6.53e-04 -9.17e-04 -3.73e-04
# SandyBar_2017 - SandyBar_2018           2.64e-04  1.07e-04  4.22e-04
# SandyBar_2017 - WinnipegRiver_2017     -4.01e-04 -6.86e-04 -8.80e-05
# SandyBar_2018 - WinnipegRiver_2017     -6.65e-04 -9.29e-04 -3.78e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C16_2, ~ Site_Year))
test_C16_2_plot<- plot(emmeans(test_C16_2, ~ Site_Year)) #### That's the one!!!!!!
test_C16_2_plot
plot(emmeans(test_C16_2, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C16_2, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C16_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C16_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C16_2_test_plot <- gather_emmeans_draws(emmeans(test_C16_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16_2_test_plot.png")
save(test_C16_2, file = " C16_2_simple_model.RData")

#### C16_1 ####
hist(carn_dataf$ C16_1)
test_C16_1 <- brm(data=carn_dataf,
                  family = student,
                  bf(C16_1 ~ Site_Year + K + Sex,
                     sigma ~ Site_Year + K + Sex),
                  prior = c(prior(normal(0,0.003), class = b),
                            prior(normal(0,0.003), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C16_1)
pp_check(test_C16_1, ndraws = 100) +
  theme_bw()
summary(test_C16_1)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C16_1 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    53959    41098
# sigma_Intercept                      -6.06      1.01    -8.02    -4.04 1.00    22586    20691
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    53932    41756
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    43976    33063
# Site_YearMatheson_2018               -0.00      0.00    -0.00     0.00 1.00    46807    36261
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    57986    44334
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    59282    40640
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    50264    37697
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    47532    41088
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    42849    30794
# K                                    -0.00      0.00    -0.00    -0.00 1.00    58008    41246
# SexM                                  0.00      0.00    -0.00     0.00 1.00    52759    49468
# SexUN                                 0.00      0.00     0.00     0.00 1.00    63372    36416
# sigma_Site_YearDauphinRiver_2018     -0.26      0.45    -1.13     0.65 1.00    19031    30209
# sigma_Site_YearMatheson_2017         -2.01      0.72    -3.43    -0.58 1.00    14558    12500
# sigma_Site_YearMatheson_2018         -0.72      0.42    -1.54     0.12 1.00    18082    25759
# sigma_Site_YearRedRiver_2017          0.34      0.40    -0.45     1.13 1.00    17967    28253
# sigma_Site_YearRedRiver_2018          0.44      0.39    -0.33     1.21 1.00    17604    29443
# sigma_Site_YearSandyBar_2017         -0.48      0.37    -1.20     0.26 1.00    17789    29198
# sigma_Site_YearSandyBar_2018          0.08      0.39    -0.69     0.85 1.00    18216    25897
# sigma_Site_YearWinnipegRiver_2017     0.31      0.69    -0.98     1.73 1.00    23065    28993
# sigma_K                              -0.87      0.88    -2.63     0.82 1.00    21988    19711
# sigma_SexM                           -0.01      0.28    -0.56     0.54 1.00    29324    36716
# sigma_SexUN                          -0.04      0.58    -1.15     1.15 1.00    22626    27495
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     3.34      2.62     1.57     8.32 1.00    18047    17477
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C16_1, ~ Site_Year)
# Site_Year           emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.00199  0.001432   0.00264
# DauphinRiver_2018  0.00133  0.000842   0.00185
# Matheson_2017      0.00187  0.001555   0.00218
# Matheson_2018      0.00184  0.001441   0.00224
# RedRiver_2017      0.00422  0.003497   0.00499
# RedRiver_2018      0.00406  0.003074   0.00508
# SandyBar_2017      0.00227  0.001885   0.00268
# SandyBar_2018      0.00345  0.002725   0.00408
# WinnipegRiver_2017 0.00498  0.003177   0.00630
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C16_1, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   6.65e-04 -8.14e-05  1.47e-03
# DauphinRiver_2017 - Matheson_2017       1.25e-04 -4.67e-04  7.55e-04
# DauphinRiver_2017 - Matheson_2018       1.58e-04 -5.18e-04  8.88e-04
# DauphinRiver_2017 - RedRiver_2017      -2.22e-03 -3.09e-03 -1.35e-03
# DauphinRiver_2017 - RedRiver_2018      -2.06e-03 -3.17e-03 -9.68e-04
# DauphinRiver_2017 - SandyBar_2017      -2.79e-04 -8.93e-04  3.64e-04
# DauphinRiver_2017 - SandyBar_2018      -1.45e-03 -2.24e-03 -5.34e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -2.98e-03 -4.37e-03 -1.12e-03
# DauphinRiver_2018 - Matheson_2017      -5.40e-04 -1.09e-03  3.43e-05
# DauphinRiver_2018 - Matheson_2018      -5.10e-04 -1.07e-03  8.49e-05
# DauphinRiver_2018 - RedRiver_2017      -2.89e-03 -3.76e-03 -1.98e-03
# DauphinRiver_2018 - RedRiver_2018      -2.73e-03 -3.85e-03 -1.63e-03
# DauphinRiver_2018 - SandyBar_2017      -9.41e-04 -1.57e-03 -3.33e-04
# DauphinRiver_2018 - SandyBar_2018      -2.12e-03 -2.92e-03 -1.24e-03
# DauphinRiver_2018 - WinnipegRiver_2017 -3.64e-03 -5.08e-03 -1.81e-03
# Matheson_2017 - Matheson_2018           3.15e-05 -3.88e-04  4.48e-04
# Matheson_2017 - RedRiver_2017          -2.35e-03 -3.09e-03 -1.59e-03
# Matheson_2017 - RedRiver_2018          -2.19e-03 -3.23e-03 -1.24e-03
# Matheson_2017 - SandyBar_2017          -4.04e-04 -8.16e-04 -2.97e-05
# Matheson_2017 - SandyBar_2018          -1.58e-03 -2.22e-03 -8.33e-04
# Matheson_2017 - WinnipegRiver_2017     -3.12e-03 -4.40e-03 -1.25e-03
# Matheson_2018 - RedRiver_2017          -2.38e-03 -3.22e-03 -1.58e-03
# Matheson_2018 - RedRiver_2018          -2.22e-03 -3.27e-03 -1.18e-03
# Matheson_2018 - SandyBar_2017          -4.34e-04 -9.58e-04  5.94e-05
# Matheson_2018 - SandyBar_2018          -1.61e-03 -2.33e-03 -8.13e-04
# Matheson_2018 - WinnipegRiver_2017     -3.13e-03 -4.51e-03 -1.29e-03
# RedRiver_2017 - RedRiver_2018           1.60e-04 -1.04e-03  1.34e-03
# RedRiver_2017 - SandyBar_2017           1.94e-03  1.19e-03  2.72e-03
# RedRiver_2017 - SandyBar_2018           7.79e-04 -1.53e-04  1.79e-03
# RedRiver_2017 - WinnipegRiver_2017     -7.48e-04 -2.21e-03  1.15e-03
# RedRiver_2018 - SandyBar_2017           1.79e-03  7.78e-04  2.82e-03
# RedRiver_2018 - SandyBar_2018           6.28e-04 -5.06e-04  1.85e-03
# RedRiver_2018 - WinnipegRiver_2017     -8.80e-04 -2.53e-03  1.16e-03
# SandyBar_2017 - SandyBar_2018          -1.17e-03 -1.87e-03 -3.94e-04
# SandyBar_2017 - WinnipegRiver_2017     -2.71e-03 -4.06e-03 -8.94e-04
# SandyBar_2018 - WinnipegRiver_2017     -1.53e-03 -3.05e-03  3.26e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C16_1, ~ Site_Year))
test_C16_1_plot<- plot(emmeans(test_C16_1, ~ Site_Year)) #### That's the one!!!!!!
test_C16_1_plot
plot(emmeans(test_C16_1, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C16_1, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C16_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C16_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C16_1_test_plot <- gather_emmeans_draws(emmeans(test_C16_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16_1_test_plot.png")
save(test_C16_1, file = " C16_1_simple_model.RData")

C16_1_draws <- model_draws(test_C16_1)
C16_1_draws


test_C16_1_site_year_plot <- ggplot(data = C14_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C16_1_site_year_plot.pdf", plot = test_C16_1_site_year_plot, dpi = 900)
test_C16_1_site_year_plot

test_C16_1_site_year_plot2 <- ggplot(data = C16_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C16:1 (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_C16_1_site_year_plot2
ggsave(filename = "test_C16_1_site_year_plot2.pdf", plot = test_C16_1_site_year_plot2, dpi = 900)

ggsave("test_C16_1_site_year_plot2.png")

test_C16_1_site_year_plot3 <- ggplot(data = C16_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C16_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C16:1 (uM)") +
  ylab(element_blank()) +  
  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C14_1_site_year_plot3
ggsave(filename = "test_C16_1_site_year_plot3.pdf", plot = test_c16_1_site_year_plot3, dpi = 900)

ggsave("test_C16_1_site_year_plot3.png")

test_C16_1_site_year_plot4 <- ggplot(data = C16_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C16_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C16_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C16:1 (µM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.24), legend.background = element_blank())
test_C16_1_site_year_plot4
ggsave(filename = "test_C16_1_site_year_plot4.pdf", plot = test_C16_1_site_year_plot4, dpi = 900)

ggsave("test_C16_1_site_year_plot4.png")

#### C18_1 ####
hist(carn_dataf$ C18_1)
test_C18_1 <- brm(data=carn_dataf,
                  family = student,
                  bf(C18_1 ~ Site_Year + K + Sex,
                     sigma ~ Site_Year + K + Sex),
                  prior = c(prior(normal(0,0.004), class = b),
                            prior(normal(0,0.004), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C18_1)
pp_check(test_C18_1, ndraws = 100) +
  theme_bw()
summary(test_C18_1)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C18_1 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.01 1.00    61645    44779
# sigma_Intercept                      -5.80      0.95    -7.69    -3.93 1.00    14946     5089
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    31957    21437
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    44246    36500
# Site_YearMatheson_2018                0.00      0.00    -0.00     0.00 1.00    33897    33854
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    60512    44408
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    48569    36685
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    43629    43352
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    37578    31093
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    30532    30862
# K                                    -0.00      0.00    -0.00     0.00 1.00    67124    43920
# SexM                                  0.00      0.00    -0.00     0.00 1.00    55974    51824
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    54665    31055
# sigma_Site_YearDauphinRiver_2018     -0.24      0.44    -1.08     0.66 1.00    17314    22933
# sigma_Site_YearMatheson_2017         -0.88      0.56    -1.92     0.28 1.00    21815    29354
# sigma_Site_YearMatheson_2018         -0.57      0.41    -1.36     0.25 1.00    14207     6082
# sigma_Site_YearRedRiver_2017          0.50      0.37    -0.21     1.24 1.00    16098    25239
# sigma_Site_YearRedRiver_2018          0.22      0.37    -0.50     0.96 1.00    18186    29033
# sigma_Site_YearSandyBar_2017         -0.29      0.35    -0.98     0.41 1.00    18198    28652
# sigma_Site_YearSandyBar_2018          0.19      0.37    -0.54     0.93 1.00    15601    24451
# sigma_Site_YearWinnipegRiver_2017    -0.12      0.80    -1.90     1.38 1.00    10372     4191
# sigma_K                              -0.90      0.81    -2.52     0.67 1.00    15590     5185
# sigma_SexM                           -0.08      0.26    -0.59     0.44 1.00    19795     7781
# sigma_SexUN                           0.39      0.58    -0.72     1.56 1.00    20382    31193
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     5.32      5.40     1.81    20.53 1.00    13268    15598
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C18_1, ~ Site_Year)
# Site_Year           emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.00228  0.001533   0.00316
# DauphinRiver_2018  0.00162  0.000895   0.00236
# Matheson_2017      0.00210  0.001378   0.00286
# Matheson_2018      0.00259  0.001952   0.00327
# RedRiver_2017      0.00506  0.003946   0.00615
# RedRiver_2018      0.00486  0.003903   0.00589
# SandyBar_2017      0.00275  0.002141   0.00343
# SandyBar_2018      0.00392  0.002968   0.00487
# WinnipegRiver_2017 0.00559  0.003826   0.00689
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C18_1, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   0.000671 -0.000301  0.001708
# DauphinRiver_2017 - Matheson_2017       0.000197 -0.000676  0.001119
# DauphinRiver_2017 - Matheson_2018      -0.000293 -0.001192  0.000672
# DauphinRiver_2017 - RedRiver_2017      -0.002761 -0.003876 -0.001575
# DauphinRiver_2017 - RedRiver_2018      -0.002563 -0.003662 -0.001500
# DauphinRiver_2017 - SandyBar_2017      -0.000467 -0.001232  0.000350
# DauphinRiver_2017 - SandyBar_2018      -0.001621 -0.002667 -0.000454
# DauphinRiver_2017 - WinnipegRiver_2017 -0.003293 -0.004640 -0.001470
# DauphinRiver_2018 - Matheson_2017      -0.000475 -0.001392  0.000466
# DauphinRiver_2018 - Matheson_2018      -0.000968 -0.001773 -0.000168
# DauphinRiver_2018 - RedRiver_2017      -0.003436 -0.004681 -0.002199
# DauphinRiver_2018 - RedRiver_2018      -0.003235 -0.004392 -0.002089
# DauphinRiver_2018 - SandyBar_2017      -0.001134 -0.002013 -0.000329
# DauphinRiver_2018 - SandyBar_2018      -0.002294 -0.003378 -0.001148
# DauphinRiver_2018 - WinnipegRiver_2017 -0.003943 -0.005421 -0.002119
# Matheson_2017 - Matheson_2018          -0.000489 -0.001299  0.000323
# Matheson_2017 - RedRiver_2017          -0.002964 -0.004156 -0.001829
# Matheson_2017 - RedRiver_2018          -0.002763 -0.003878 -0.001693
# Matheson_2017 - SandyBar_2017          -0.000658 -0.001427  0.000107
# Matheson_2017 - SandyBar_2018          -0.001817 -0.002886 -0.000749
# Matheson_2017 - WinnipegRiver_2017     -0.003494 -0.004795 -0.001604
# Matheson_2018 - RedRiver_2017          -0.002474 -0.003663 -0.001304
# Matheson_2018 - RedRiver_2018          -0.002270 -0.003407 -0.001222
# Matheson_2018 - SandyBar_2017          -0.000167 -0.000936  0.000558
# Matheson_2018 - SandyBar_2018          -0.001327 -0.002366 -0.000285
# Matheson_2018 - WinnipegRiver_2017     -0.002986 -0.004379 -0.001158
# RedRiver_2017 - RedRiver_2018           0.000197 -0.001142  0.001541
# RedRiver_2017 - SandyBar_2017           0.002297  0.001217  0.003385
# RedRiver_2017 - SandyBar_2018           0.001149 -0.000208  0.002473
# RedRiver_2017 - WinnipegRiver_2017     -0.000512 -0.001978  0.001438
# RedRiver_2018 - SandyBar_2017           0.002099  0.001107  0.003116
# RedRiver_2018 - SandyBar_2018           0.000944 -0.000304  0.002219
# RedRiver_2018 - WinnipegRiver_2017     -0.000694 -0.002292  0.001177
# SandyBar_2017 - SandyBar_2018          -0.001162 -0.002148 -0.000142
# SandyBar_2017 - WinnipegRiver_2017     -0.002834 -0.004122 -0.001042
# SandyBar_2018 - WinnipegRiver_2017     -0.001654 -0.003223  0.000212
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C18_1, ~ Site_Year))
test_C18_1_plot<- plot(emmeans(test_C18_1, ~ Site_Year)) #### That's the one!!!!!!
test_C18_1_plot
plot(emmeans(test_C18_1, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C18_1, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C18_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C18_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C18_1_test_plot <- gather_emmeans_draws(emmeans(test_C18_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C18_1_test_plot.png")
save(test_C18_1, file = " C18_1_simple_model.RData")


C18_1_draws <- model_draws(test_C18_1)
C18_1_draws


test_C18_1_site_year_plot <- ggplot(data = C18_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C18_1_site_year_plot.pdf", plot = test_C18_1_site_year_plot, dpi = 900)
test_C18_1_site_year_plot

test_C18_1_site_year_plot2 <- ggplot(data = C18_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18:1 (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_C18_1_site_year_plot2
ggsave(filename = "test_C18_1_site_year_plot2.pdf", plot = test_C18_1_site_year_plot2, dpi = 900)

ggsave("test_C18_1_site_year_plot2.png")

test_C18_1_site_year_plot3 <- ggplot(data = C18_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18:1 (uM)") +
  ylab(element_blank()) +  
  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C18_1_site_year_plot3
ggsave(filename = "test_C18_1_site_year_plot3.pdf", plot = test_C18_1_site_year_plot3, dpi = 900)

ggsave("test_C18_1_site_year_plot3.png")


test_C18_1_site_year_plot4 <- ggplot(data = C18_1_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_1_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C18_1_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18:1 (µM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.24), legend.background = element_blank())
test_C18_site_year_plot4
ggsave(filename = "test_C18_1_site_year_plot4.pdf", plot = test_C18_1_site_year_plot4, dpi = 900)

ggsave("test_C18_1_site_year_plot4.png")

#### C18_2 ####
hist(carn_dataf$ C18_2)
test_C18_2 <- brm(data=carn_dataf,
                  family = student,
                  bf(C18_2 ~ Site_Year + K + Sex,
                     sigma ~ Site_Year + K + Sex),
                  prior = c(prior(normal(0,0.002), class = b),
                            prior(normal(0,0.002), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test_C18_2)
pp_check(test_C18_2, ndraws = 100) +
  theme_bw()
summary(test_C18_2)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C18_2 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    55121    50139
# sigma_Intercept                      -7.52      1.04    -9.60    -5.51 1.00    26419    34174
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    57382    41103
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    55594    46984
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    54218    39842
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    58402    50617
# Site_YearRedRiver_2018               -0.00      0.00    -0.00    -0.00 1.00    57344    43995
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    58601    47801
# Site_YearSandyBar_2018               -0.00      0.00    -0.00    -0.00 1.00    58925    40804
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    59555    46041
# K                                    -0.00      0.00    -0.00     0.00 1.00    56176    48684
# SexM                                 -0.00      0.00    -0.00     0.00 1.00    54035    55953
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    55872    42209
# sigma_Site_YearDauphinRiver_2018     -0.63      0.45    -1.50     0.28 1.00    20538    30100
# sigma_Site_YearMatheson_2017         -0.77      0.58    -1.88     0.44 1.00    27362    32293
# sigma_Site_YearMatheson_2018         -1.52      0.43    -2.36    -0.66 1.00    19709    28457
# sigma_Site_YearRedRiver_2017         -0.02      0.40    -0.82     0.75 1.00    21416    31510
# sigma_Site_YearRedRiver_2018         -0.45      0.39    -1.20     0.33 1.00    20518    32503
# sigma_Site_YearSandyBar_2017          0.07      0.36    -0.63     0.80 1.00    17850    28168
# sigma_Site_YearSandyBar_2018         -0.89      0.40    -1.68    -0.09 1.00    22266    32954
# sigma_Site_YearWinnipegRiver_2017    -0.70      0.68    -2.00     0.71 1.00    28892    34839
# sigma_K                              -0.48      0.86    -2.18     1.21 1.00    31175    37199
# sigma_SexM                           -0.36      0.29    -0.92     0.20 1.00    33118    37963
# sigma_SexUN                          -0.68      0.62    -1.86     0.61 1.00    20751    26199
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     3.36      2.52     1.62     8.03 1.00    19889    16906
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C18_2, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.001025  0.000866  0.001194
# DauphinRiver_2018  0.000310  0.000216  0.000402
# Matheson_2017      0.000872  0.000682  0.001043
# Matheson_2018      0.000379  0.000298  0.000457
# RedRiver_2017      0.001264  0.001072  0.001466
# RedRiver_2018      0.000706  0.000583  0.000823
# SandyBar_2017      0.001001  0.000815  0.001181
# SandyBar_2018      0.000536  0.000467  0.000616
# WinnipegRiver_2017 0.001610  0.001349  0.001828
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C18_2, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   7.15e-04  5.22e-04  9.15e-04
# DauphinRiver_2017 - Matheson_2017       1.58e-04 -8.24e-05  4.05e-04
# DauphinRiver_2017 - Matheson_2018       6.46e-04  4.56e-04  8.51e-04
# DauphinRiver_2017 - RedRiver_2017      -2.39e-04 -4.81e-04  1.13e-06
# DauphinRiver_2017 - RedRiver_2018       3.21e-04  1.26e-04  5.16e-04
# DauphinRiver_2017 - SandyBar_2017       2.56e-05 -2.09e-04  2.68e-04
# DauphinRiver_2017 - SandyBar_2018       4.88e-04  3.15e-04  6.61e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -5.78e-04 -8.43e-04 -2.88e-04
# DauphinRiver_2018 - Matheson_2017      -5.63e-04 -7.59e-04 -3.49e-04
# DauphinRiver_2018 - Matheson_2018      -7.08e-05 -1.67e-04  2.88e-05
# DauphinRiver_2018 - RedRiver_2017      -9.55e-04 -1.17e-03 -7.34e-04
# DauphinRiver_2018 - RedRiver_2018      -3.96e-04 -5.55e-04 -2.35e-04
# DauphinRiver_2018 - SandyBar_2017      -6.90e-04 -8.99e-04 -4.84e-04
# DauphinRiver_2018 - SandyBar_2018      -2.27e-04 -3.54e-04 -1.10e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -1.30e-03 -1.54e-03 -1.01e-03
# Matheson_2017 - Matheson_2018           4.94e-04  2.82e-04  6.67e-04
# Matheson_2017 - RedRiver_2017          -3.96e-04 -6.76e-04 -1.21e-04
# Matheson_2017 - RedRiver_2018           1.65e-04 -5.34e-05  3.69e-04
# Matheson_2017 - SandyBar_2017          -1.31e-04 -3.80e-04  1.30e-04
# Matheson_2017 - SandyBar_2018           3.34e-04  1.32e-04  5.17e-04
# Matheson_2017 - WinnipegRiver_2017     -7.38e-04 -1.04e-03 -4.08e-04
# Matheson_2018 - RedRiver_2017          -8.85e-04 -1.12e-03 -6.69e-04
# Matheson_2018 - RedRiver_2018          -3.27e-04 -4.77e-04 -1.76e-04
# Matheson_2018 - SandyBar_2017          -6.22e-04 -8.19e-04 -4.12e-04
# Matheson_2018 - SandyBar_2018          -1.57e-04 -2.75e-04 -5.04e-05
# Matheson_2018 - WinnipegRiver_2017     -1.23e-03 -1.47e-03 -9.35e-04
# RedRiver_2017 - RedRiver_2018           5.59e-04  3.32e-04  7.93e-04
# RedRiver_2017 - SandyBar_2017           2.65e-04 -3.50e-06  5.28e-04
# RedRiver_2017 - SandyBar_2018           7.27e-04  5.21e-04  9.34e-04
# RedRiver_2017 - WinnipegRiver_2017     -3.38e-04 -6.10e-04 -3.74e-05
# RedRiver_2018 - SandyBar_2017          -2.96e-04 -5.07e-04 -7.96e-05
# RedRiver_2018 - SandyBar_2018           1.68e-04  3.35e-05  3.00e-04
# RedRiver_2018 - WinnipegRiver_2017     -9.02e-04 -1.15e-03 -6.05e-04
# SandyBar_2017 - SandyBar_2018           4.63e-04  2.65e-04  6.56e-04
# SandyBar_2017 - WinnipegRiver_2017     -6.05e-04 -8.87e-04 -2.93e-04
# SandyBar_2018 - WinnipegRiver_2017     -1.07e-03 -1.30e-03 -7.97e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C18_2, ~ Site_Year))
test_C18_2_plot<- plot(emmeans(test_C18_2, ~ Site_Year)) #### That's the one!!!!!!
test_C18_2_plot
plot(emmeans(test_C18_2, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C18_2, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C18_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C18_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C18_2_test_plot <- gather_emmeans_draws(emmeans(test_C18_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C18_2_test_plot.png")
save(test_C18_2, file = " C18_2_simple_model.RData")

#### C18_1OH ####
hist(carn_dataf$ C18_1OH)
test_C18_1OH <- brm(data=carn_dataf,
                    family = student,
                    bf(C18_1OH ~ Site_Year + K + Sex,
                       sigma ~ Site_Year + K + Sex),
                    prior = c(prior(normal(0,0004), class = b),
                              prior(normal(0,0004), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C18_1OH)
pp_check(test_C18_1OH, ndraws = 100) +
  theme_bw()
summary(test_C18_1OH)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C18_1OH ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    46221    46996
# sigma_Intercept                      -7.52      0.90    -9.26    -5.72 1.00    22833    33331
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    43692    47485
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    54339    46691
# Site_YearMatheson_2018               -0.00      0.00    -0.00     0.00 1.00    45001    43805
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    44841    48493
# Site_YearRedRiver_2018                0.00      0.00    -0.00     0.00 1.00    49891    45466
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    49403    46335
# Site_YearSandyBar_2018                0.00      0.00    -0.00     0.00 1.00    50003    46854
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    56104    42761
# K                                    -0.00      0.00    -0.00     0.00 1.00    50164    46610
# SexM                                  0.00      0.00    -0.00     0.00 1.00    41983    51361
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    59302    40419
# sigma_Site_YearDauphinRiver_2018     -0.71      0.38    -1.46     0.04 1.00    19784    29433
# sigma_Site_YearMatheson_2017         -1.11      0.48    -1.97    -0.09 1.00    29952    31130
# sigma_Site_YearMatheson_2018         -1.48      0.35    -2.15    -0.80 1.00    19053    30140
# sigma_Site_YearRedRiver_2017         -0.17      0.30    -0.75     0.41 1.00    22519    32798
# sigma_Site_YearRedRiver_2018         -0.67      0.30    -1.25    -0.09 1.00    21331    30570
# sigma_Site_YearSandyBar_2017         -0.46      0.28    -1.00     0.08 1.00    20231    29376
# sigma_Site_YearSandyBar_2018         -0.80      0.31    -1.41    -0.18 1.00    21167    31237
# sigma_Site_YearWinnipegRiver_2017    -0.34      0.54    -1.26     0.87 1.00    27994    26560
# sigma_K                              -0.54      0.74    -2.00     0.90 1.00    26266    37957
# sigma_SexM                           -0.52      0.25    -1.00    -0.03 1.00    29659    39182
# sigma_SexUN                           0.40      0.39    -0.35     1.17 1.00    33556    37347
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    24.17     14.24     6.04    60.00 1.00    38817    33112
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C18_1OH, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000416  0.000273  0.000569
# DauphinRiver_2018  0.000353  0.000252  0.000449
# Matheson_2017      0.000369  0.000270  0.000476
# Matheson_2018      0.000331  0.000257  0.000403
# RedRiver_2017      0.000552  0.000426  0.000677
# RedRiver_2018      0.000463  0.000383  0.000544
# SandyBar_2017      0.000430  0.000340  0.000520
# SandyBar_2018      0.000429  0.000356  0.000505
# WinnipegRiver_2017 0.000783  0.000523  0.001039
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_C18_1OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   6.32e-05 -1.16e-04  2.51e-04
# DauphinRiver_2017 - Matheson_2017       4.70e-05 -1.13e-04  2.10e-04
# DauphinRiver_2017 - Matheson_2018       8.62e-05 -7.65e-05  2.55e-04
# DauphinRiver_2017 - RedRiver_2017      -1.37e-04 -3.19e-04  5.10e-05
# DauphinRiver_2017 - RedRiver_2018      -4.92e-05 -1.94e-04  1.05e-04
# DauphinRiver_2017 - SandyBar_2017      -1.51e-05 -1.69e-04  1.49e-04
# DauphinRiver_2017 - SandyBar_2018      -1.42e-05 -1.61e-04  1.40e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -3.68e-04 -6.55e-04 -8.62e-05
# DauphinRiver_2018 - Matheson_2017      -1.59e-05 -1.54e-04  1.24e-04
# DauphinRiver_2018 - Matheson_2018       2.10e-05 -8.26e-05  1.27e-04
# DauphinRiver_2018 - RedRiver_2017      -2.00e-04 -3.57e-04 -4.97e-05
# DauphinRiver_2018 - RedRiver_2018      -1.10e-04 -2.36e-04  8.87e-06
# DauphinRiver_2018 - SandyBar_2017      -7.71e-05 -2.05e-04  5.04e-05
# DauphinRiver_2018 - SandyBar_2018      -7.61e-05 -1.97e-04  3.72e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -4.30e-04 -7.04e-04 -1.61e-04
# Matheson_2017 - Matheson_2018           4.00e-05 -7.95e-05  1.49e-04
# Matheson_2017 - RedRiver_2017          -1.84e-04 -3.40e-04 -2.70e-05
# Matheson_2017 - RedRiver_2018          -9.56e-05 -2.05e-04  1.89e-05
# Matheson_2017 - SandyBar_2017          -6.21e-05 -1.84e-04  6.13e-05
# Matheson_2017 - SandyBar_2018          -6.14e-05 -1.70e-04  4.67e-05
# Matheson_2017 - WinnipegRiver_2017     -4.15e-04 -6.83e-04 -1.36e-04
# Matheson_2018 - RedRiver_2017          -2.22e-04 -3.65e-04 -8.28e-05
# Matheson_2018 - RedRiver_2018          -1.33e-04 -2.35e-04 -3.15e-05
# Matheson_2018 - SandyBar_2017          -9.93e-05 -2.08e-04  9.14e-06
# Matheson_2018 - SandyBar_2018          -9.83e-05 -1.93e-04 -5.69e-06
# Matheson_2018 - WinnipegRiver_2017     -4.53e-04 -7.19e-04 -1.87e-04
# RedRiver_2017 - RedRiver_2018           8.94e-05 -5.04e-05  2.22e-04
# RedRiver_2017 - SandyBar_2017           1.23e-04 -1.66e-05  2.63e-04
# RedRiver_2017 - SandyBar_2018           1.23e-04 -1.09e-05  2.62e-04
# RedRiver_2017 - WinnipegRiver_2017     -2.29e-04 -5.08e-04  4.13e-05
# RedRiver_2018 - SandyBar_2017           3.32e-05 -6.75e-05  1.37e-04
# RedRiver_2018 - SandyBar_2018           3.39e-05 -5.16e-05  1.23e-04
# RedRiver_2018 - WinnipegRiver_2017     -3.20e-04 -5.86e-04 -6.20e-05
# SandyBar_2017 - SandyBar_2018           8.57e-07 -1.01e-04  9.85e-05
# SandyBar_2017 - WinnipegRiver_2017     -3.53e-04 -6.10e-04 -8.31e-05
# SandyBar_2018 - WinnipegRiver_2017     -3.54e-04 -6.09e-04 -8.28e-05
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C18_1OH, ~ Site_Year))
test_C18_1OH_plot<- plot(emmeans(test_C18_1OH, ~ Site_Year)) #### That's the one!!!!!!
test_C18_1OH_plot
plot(emmeans(test_C18_1OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C18_1OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C18_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C18_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C18_1OH_test_plot <- gather_emmeans_draws(emmeans(test_C18_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C18_1OH_test_plot.png")
save(test_C18_1OH, file = " C18_1OH_simple_model.RData")

C18_1OH_draws <- model_draws(test_C18_1OH)
C18_1OH_draws
test_C18_1OH_site_year_plot <- ggplot(data = C18_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C18_1OH_site_year_plot.pdf", plot = test_C18_1OH_site_year_plot, dpi = 900)
test_C18_1OH_site_year_plot

test_C18_1OH_site_year_plot2 <- ggplot(data = C18_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18:1OH (uM)") +
  ylab(element_blank()) +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.24), legend.background = element_blank())
test_C18_1OH_site_year_plot2
ggsave(filename = "test_C18_1OH_site_year_plot2.pdf", plot = test_C18_1OH_site_year_plot2, dpi = 900)

ggsave("test_C18_1OH_site_year_plot2.png")

test_C18_1OH_site_year_plot3 <- ggplot(data = C18_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18:1OH (uM)") +
  ylab(element_blank()) +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C18_1OH_site_year_plot3
ggsave(filename = "test_C18_1OH_site_year_plot3.pdf", plot = test_C18_1OH_site_year_plot3, dpi = 900)

ggsave("test_C18_1OH_site_year_plot3.png")

test_C18_1OH_site_year_plot4 <- ggplot(data = C18_1OH_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_1OH_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C18_1OH_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18:1OH (µM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.24), legend.background = element_blank())
test_C18_1OH_site_year_plot4
ggsave(filename = "test_C18_1OH_site_year_plot4.pdf", plot = test_C18_1OH_site_year_plot4, dpi = 900)

ggsave("test_C18_1OH_site_year_plot4.png")

#### C18 ####
hist(carn_dataf$ C18)
test_C18 <- brm(data=carn_dataf,
                family = student,
                bf(C18 ~ Site_Year + K + Sex,
                   sigma ~ Site_Year + K + Sex),
                prior = c(prior(normal(0,001), class = b),
                          prior(normal(0,001), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_C18)
pp_check(test_C18, ndraws = 100) +
  theme_bw()
summary(test_C18)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C18 ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    43218    42565
# sigma_Intercept                      -6.91      0.97    -8.88    -5.07 1.00    25253    32861
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    56055    48558
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    56945    45639
# Site_YearMatheson_2018               -0.00      0.00    -0.00     0.00 1.00    49372    44216
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    60349    53754
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    55453    51902
# Site_YearSandyBar_2017                0.00      0.00     0.00     0.00 1.00    58480    53069
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    60330    51251
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    62635    38408
# K                                    -0.00      0.00    -0.00     0.00 1.00    44530    43790
# SexM                                  0.00      0.00    -0.00     0.00 1.00    51341    48337
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    56779    33320
# sigma_Site_YearDauphinRiver_2018      0.16      0.40    -0.60     0.97 1.00    19676    31456
# sigma_Site_YearMatheson_2017         -0.17      0.53    -1.13     0.95 1.00    25748    31950
# sigma_Site_YearMatheson_2018         -0.74      0.42    -1.59     0.07 1.00    22512    33027
# sigma_Site_YearRedRiver_2017          0.63      0.35    -0.05     1.34 1.00    18414    30367
# sigma_Site_YearRedRiver_2018          0.44      0.35    -0.23     1.15 1.00    18215    29407
# sigma_Site_YearSandyBar_2017          0.76      0.33     0.11     1.42 1.00    18283    29179
# sigma_Site_YearSandyBar_2018          0.64      0.38    -0.09     1.39 1.00    19205    29596
# sigma_Site_YearWinnipegRiver_2017     0.66      0.60    -0.39     1.99 1.00    24473    25732
# sigma_K                              -1.39      0.81    -2.97     0.23 1.00    26904    34572
# sigma_SexM                           -0.09      0.26    -0.61     0.43 1.00    30997    36275
# sigma_SexUN                           0.50      0.45    -0.38     1.40 1.00    28003    35539
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     9.14      8.82     2.24    34.84 1.00    17457    36057
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_C18, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000684  0.000533  0.000858
# DauphinRiver_2018  0.000520  0.000311  0.000733
# Matheson_2017      0.000649  0.000410  0.000923
# Matheson_2018      0.000610  0.000468  0.000749
# RedRiver_2017      0.001256  0.001031  0.001480
# RedRiver_2018      0.001086  0.000868  0.001303
# SandyBar_2017      0.000997  0.000741  0.001273
# SandyBar_2018      0.001042  0.000754  0.001345
# WinnipegRiver_2017 0.001073  0.000625  0.001514
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95
pairs(emmeans(test_C18, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   1.67e-04 -7.92e-05  4.27e-04
# DauphinRiver_2017 - Matheson_2017       4.15e-05 -2.33e-04  2.97e-04
# DauphinRiver_2017 - Matheson_2018       7.44e-05 -1.04e-04  2.74e-04
# DauphinRiver_2017 - RedRiver_2017      -5.68e-04 -7.93e-04 -3.41e-04
# DauphinRiver_2017 - RedRiver_2018      -3.99e-04 -6.21e-04 -1.73e-04
# DauphinRiver_2017 - SandyBar_2017      -3.09e-04 -5.80e-04 -5.17e-05
# DauphinRiver_2017 - SandyBar_2018      -3.55e-04 -6.72e-04 -5.38e-05
# DauphinRiver_2017 - WinnipegRiver_2017 -3.84e-04 -8.29e-04  4.84e-05
# DauphinRiver_2018 - Matheson_2017      -1.32e-04 -4.58e-04  1.80e-04
# DauphinRiver_2018 - Matheson_2018      -9.11e-05 -3.06e-04  1.29e-04
# DauphinRiver_2018 - RedRiver_2017      -7.35e-04 -1.03e-03 -4.45e-04
# DauphinRiver_2018 - RedRiver_2018      -5.65e-04 -8.51e-04 -2.71e-04
# DauphinRiver_2018 - SandyBar_2017      -4.78e-04 -8.01e-04 -1.63e-04
# DauphinRiver_2018 - SandyBar_2018      -5.23e-04 -8.68e-04 -1.85e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -5.52e-04 -1.05e-03 -8.43e-05
# Matheson_2017 - Matheson_2018           4.23e-05 -2.13e-04  3.04e-04
# Matheson_2017 - RedRiver_2017          -6.07e-04 -9.05e-04 -2.80e-04
# Matheson_2017 - RedRiver_2018          -4.38e-04 -7.30e-04 -1.13e-04
# Matheson_2017 - SandyBar_2017          -3.48e-04 -6.91e-04 -1.06e-05
# Matheson_2017 - SandyBar_2018          -3.92e-04 -7.62e-04 -2.13e-05
# Matheson_2017 - WinnipegRiver_2017     -4.24e-04 -9.09e-04  8.20e-05
# Matheson_2018 - RedRiver_2017          -6.45e-04 -8.86e-04 -4.16e-04
# Matheson_2018 - RedRiver_2018          -4.76e-04 -7.17e-04 -2.48e-04
# Matheson_2018 - SandyBar_2017          -3.87e-04 -6.60e-04 -1.20e-04
# Matheson_2018 - SandyBar_2018          -4.32e-04 -7.38e-04 -1.35e-04
# Matheson_2018 - WinnipegRiver_2017     -4.63e-04 -9.20e-04 -1.12e-05
# RedRiver_2017 - RedRiver_2018           1.70e-04 -1.03e-04  4.46e-04
# RedRiver_2017 - SandyBar_2017           2.58e-04 -4.77e-05  5.54e-04
# RedRiver_2017 - SandyBar_2018           2.14e-04 -1.33e-04  5.59e-04
# RedRiver_2017 - WinnipegRiver_2017      1.84e-04 -2.63e-04  6.47e-04
# RedRiver_2018 - SandyBar_2017           8.70e-05 -2.24e-04  3.96e-04
# RedRiver_2018 - SandyBar_2018           4.19e-05 -3.04e-04  3.79e-04
# RedRiver_2018 - WinnipegRiver_2017      1.35e-05 -4.45e-04  4.91e-04
# SandyBar_2017 - SandyBar_2018          -4.39e-05 -4.14e-04  3.38e-04
# SandyBar_2017 - WinnipegRiver_2017     -7.34e-05 -5.56e-04  4.13e-04
# SandyBar_2018 - WinnipegRiver_2017     -3.12e-05 -5.41e-04  4.95e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_C18, ~ Site_Year))
test_C18_plot<- plot(emmeans(test_C18, ~ Site_Year)) #### That's the one!!!!!!
test_C18_plot
plot(emmeans(test_C18, ~ Sex*Site_Year))
plot(pairs(emmeans(test_C18, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_C18, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_C18, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
C18_test_plot <- gather_emmeans_draws(emmeans(test_C18, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C18_test_plot.png")
save(test_C18, file = " C18_simple_model.RData")

C18_draws <- model_draws(test_C18)

test_C18_site_year_plot <- ggplot(data = C18_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw()
ggsave(filename = "test_C18_site_year_plot.pdf", plot = test_C18_site_year_plot, dpi = 900)
test_C18_site_year_plot

test_C18_site_year_plot2 <- ggplot(data = C18_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18 (uM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 20) +
  theme(legend.position = c(0.14, 0.14), legend.background = element_blank())
test_C18_site_year_plot2
ggsave(filename = "test_C18_site_year_plot2.pdf", plot = test_C18_site_year_plot2, dpi = 900)

ggsave("test_C18_site_year_plot2.png")

test_C18_site_year_plot3 <- ggplot(data = C18_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_pointinterval(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_draws, Year == 2017), slab_alpha = 0.8) +
  stat_pointinterval(side = "top", position = position_nudge(y = 0.03), data = filter(C18_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18 (uM)") +
  ylab("Site of Capture") +  theme_bw(base_size = 25) +
  theme(legend.position="none") 
test_C18_site_year_plot3
ggsave(filename = "test_C18_site_year_plot3.pdf", plot = test_C18_site_year_plot3, dpi = 900)

ggsave("test_C18_site_year_plot3.png")

test_C18_site_year_plot4 <- ggplot(data = C18_draws, aes(x = est, y = Site , fill = Year, group = Year, color= Year)) +
  stat_halfeye(side = "bottom", position = position_nudge(y = -0.03), data = filter(C18_draws, Year == 2017), slab_alpha = 0.8) +
  stat_halfeye(side = "top", position = position_nudge(y = 0.03), data = filter(C18_draws, Year == 2018), slab_alpha = 0.8) +
  theme_bw() +
  xlab("C18 (µM)") +
  ylab("Site of capture") +
  guides(fill = guide_legend(title="Year"), colour = guide_legend(title="Year")) +
  theme_bw(base_size = 25) +
  theme(legend.position = c(0.90, 0.24), legend.background = element_blank())
test_C18_site_year_plot4
ggsave(filename = "test_C18_site_year_plot4.pdf", plot = test_C18_site_year_plot4, dpi = 900)

ggsave("test_C18_site_year_plot4.png")

#### Propylene-glycol ####
hist(met_dataf$Propylene_glycol)
test_PG <- brm(data=met_dataf,
               family = student,
               bf(Propylene_glycol ~ Site_Year + K + Sex,
                  sigma ~ Site_Year + K + Sex),
               prior = c(prior(normal(0,15), class = b),
                         prior(normal(0,15), class = Intercept)),
               iter = 20000, warmup = 5000, chains = 4, cores = 4,
               control = list(adapt_delta = 0.95, max_treedepth = 15))
plot(test_PG)
pp_check(test_PG, ndraws = 100) +
  theme_bw()
summary(test_PG)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Propylene_glycol ~ Site_Year + K + Sex 
# sigma ~ Site_Year + K + Sex
# Data: met_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# Intercept                             8.81      3.02     3.23    15.07 1.00    13365    20950
# sigma_Intercept                       0.00      1.27    -2.56     2.45 1.00    26758    31019
# Site_YearDauphinRiver_2018            0.62      3.29    -6.00     7.00 1.00    14344    22526
# Site_YearMatheson_2017               -9.30      2.90   -15.23    -3.95 1.00    11786    18133
# Site_YearMatheson_2018               -4.72      3.02   -10.89     0.93 1.00    12819    20707
# Site_YearRedRiver_2017               -9.99      2.78   -15.80    -4.90 1.00    11176    17275
# Site_YearRedRiver_2018               -6.29      2.81   -12.14    -1.12 1.00    11473    17911
# Site_YearSandyBar_2017               -9.75      2.77   -15.56    -4.69 1.00    11295    17301
# Site_YearSandyBar_2018               -6.75      2.91   -12.80    -1.37 1.00    12063    19172
# Site_YearWinnipegRiver_2017          -6.45      5.92   -15.61     9.44 1.00    18704    18337
# K                                     2.35      1.26    -0.12     4.79 1.00    38147    43369
# SexM                                  0.41      0.33    -0.20     1.11 1.00    43710    34872
# SexUN                                 0.27      2.42    -3.95     5.45 1.00    43738    36737
# sigma_Site_YearDauphinRiver_2018     -0.69      0.51    -1.67     0.34 1.00    25226    33219
# sigma_Site_YearMatheson_2017         -2.09      0.82    -3.65    -0.47 1.00    25174    32310
# sigma_Site_YearMatheson_2018         -0.80      0.51    -1.79     0.22 1.00    26331    33115
# sigma_Site_YearRedRiver_2017         -3.21      0.43    -4.05    -2.35 1.00    34310    37387
# sigma_Site_YearRedRiver_2018         -1.91      0.44    -2.77    -1.06 1.00    32764    38547
# sigma_Site_YearSandyBar_2017         -2.51      0.54    -3.59    -1.49 1.00    22544    35285
# sigma_Site_YearSandyBar_2018         -1.32      0.46    -2.21    -0.42 1.00    31345    38564
# sigma_Site_YearWinnipegRiver_2017    -1.24      1.13    -3.40     0.83 1.00    18983    36132
# sigma_K                               1.98      1.04    -0.03     4.07 1.00    31238    35842
# sigma_SexM                            0.22      0.34    -0.44     0.90 1.00    36526    39005
# sigma_SexUN                          -0.02      0.51    -1.02     0.97 1.00    42770    39987
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     1.80      0.60     1.08     3.30 1.00    18455    20554
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test_PG, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   11.47     6.080     17.39
# DauphinRiver_2018   12.15     9.091     15.46
# Matheson_2017        2.23     0.200      4.67
# Matheson_2018        6.84     4.403      9.62
# RedRiver_2017        1.58     0.091      3.28
# RedRiver_2018        5.28     3.449      7.27
# SandyBar_2017        1.81     0.287      3.62
# SandyBar_2018        4.78     2.572      7.37
# WinnipegRiver_2017   3.63    -3.302     19.45
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test_PG, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    -0.689    -7.034    5.9544
# DauphinRiver_2017 - Matheson_2017         9.160     3.775   15.0535
# DauphinRiver_2017 - Matheson_2018         4.610    -0.994   10.8231
# DauphinRiver_2017 - RedRiver_2017         9.836     4.779   15.6533
# DauphinRiver_2017 - RedRiver_2018         6.138     1.063   12.0742
# DauphinRiver_2017 - SandyBar_2017         9.587     4.425   15.2731
# DauphinRiver_2017 - SandyBar_2018         6.592     1.278   12.6827
# DauphinRiver_2017 - WinnipegRiver_2017    7.303    -7.362   16.7276
# DauphinRiver_2018 - Matheson_2017         9.819     6.164   14.1302
# DauphinRiver_2018 - Matheson_2018         5.298     1.252    9.4831
# DauphinRiver_2018 - RedRiver_2017        10.482     7.108   14.4121
# DauphinRiver_2018 - RedRiver_2018         6.796     3.296   10.8799
# DauphinRiver_2018 - SandyBar_2017        10.241     6.853   14.1445
# DauphinRiver_2018 - SandyBar_2018         7.272     3.228   11.4634
# DauphinRiver_2018 - WinnipegRiver_2017    8.235    -7.212   16.4523
# Matheson_2017 - Matheson_2018            -4.586    -7.586   -1.6446
# Matheson_2017 - RedRiver_2017             0.625    -0.940    2.4773
# Matheson_2017 - RedRiver_2018            -3.063    -4.868   -1.0919
# Matheson_2017 - SandyBar_2017             0.387    -1.238    2.2191
# Matheson_2017 - SandyBar_2018            -2.583    -5.024   -0.0746
# Matheson_2017 - WinnipegRiver_2017       -1.331   -17.235    5.6630
# Matheson_2018 - RedRiver_2017             5.237     2.738    7.8604
# Matheson_2018 - RedRiver_2018             1.552    -1.128    4.2934
# Matheson_2018 - SandyBar_2017             4.992     2.493    7.5661
# Matheson_2018 - SandyBar_2018             2.038    -0.985    5.1541
# Matheson_2018 - WinnipegRiver_2017        3.042   -12.226   10.6703
# RedRiver_2017 - RedRiver_2018            -3.675    -4.857   -2.5831
# RedRiver_2017 - SandyBar_2017            -0.221    -0.968    0.4587
# RedRiver_2017 - SandyBar_2018            -3.204    -5.144   -1.3859
# RedRiver_2017 - WinnipegRiver_2017       -1.880   -17.687    4.8826
# RedRiver_2018 - SandyBar_2017             3.444     2.321    4.6392
# RedRiver_2018 - SandyBar_2018             0.459    -1.578    2.5418
# RedRiver_2018 - WinnipegRiver_2017        1.726   -14.240    8.3584
# SandyBar_2017 - SandyBar_2018            -2.984    -4.914   -1.1364
# SandyBar_2017 - WinnipegRiver_2017       -1.678   -17.630    4.9074
# SandyBar_2018 - WinnipegRiver_2017        1.166   -14.466    8.3037
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test_PG, ~ Site_Year))
test_PG_plot<- plot(emmeans(test_PG, ~ Site_Year)) #### That's the one!!!!!!
test_PG_plot
plot(emmeans(test_PG, ~ Sex*Site_Year))
plot(pairs(emmeans(test_PG, ~ Site_Year)))

gather_emmeans_draws(emmeans(test_PG, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()


gather_emmeans_draws(emmeans(test_PG, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
PG_tets_plot <- gather_emmeans_draws(emmeans(test_PG, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("PG_tets_plot.png")

save(test_PG, file = "PG_simple_model.RData")


# install.packages("devtools")
devtools::install_github("thomasp85/patchwork")


  
  library(ggplot2)
library(patchwork)

#### Biogenic Aines ####
# citrulline, ornithine, arginine
# creatine, creatinine


p1 <- citr_test_plot + 
  ggtitle('A')
p2 <- orn_test_plot + 
  ggtitle('B')
p3 <- arg_tets_plot + 
  ggtitle('C')
p4 <- crea_test_plot + 
  ggtitle('D')
p5 <- crn_test_plot + 
  ggtitle('E')

p1 + p2 + p3
p4 + p5

(p1 | p2 | p3) /
  (p4 | p5)

patchwork <- (p1 | p2 | p3) /
  (p4 | p5)
patchwork + plot_annotation(
  title = 'Biogenic Amines',
  subtitle = 'These 3 plots will reveal yet-untold secrets about our beloved data-set',
  caption = 'Disclaimer: None of these plots are insightful'
)

#### Valine, Isoleucine Breakdown  ####
# C4OH, C3, C5_I
# vALINE AND ISOLEUCINE

P6 <- val_tets_plot + 
  ggtitle('A')
P7 <- ile_tets_plot + 
  ggtitle('B')
P8 <- C4OH_tets_plot + 
  ggtitle('C')
P9 <- C3_tets_plot + 
  ggtitle('D')
P10<- C5_1_tets_plot + 
  ggtitle('E')


(P6 | P7 )/
(P8 |P9 | P10)

#### Leucine Breakdown  ####
# Leucine and C5MDC

p11 <- leu_tets_plot + 
  ggtitle('A')
p12 <- C5MDC_tets_plot + 
  ggtitle('B') 


(p11 | p12 )

#### Lysine Breakdown  ####
# Lysine, alpha amino adipic acid 7 nethionine sulfone
lys_tets_plot
AAAA_tets_plot
metsul_tets_plot

p13 <- lys_tets_plot + 
  ggtitle('C')
p14 <- AAAA_tets_plot + 
  ggtitle('D') 
p15 <- metsul_tets_plot + 
  ggtitle('E')

(p11 | p12 )/
(p13 | p14 | p15 )


#### Tryptophan breakdown ####

P16 <-trp_tets_plot + ggtitle('A')
P17 <-kyn_test_plot + ggtitle('B')
P18 <-TDA_tets_plot + ggtitle('C')
P19 <-ADA_tets_plot + ggtitle('D')

(P16 | P17) /
  (P18 | P19)
#### METHIONINE BREAKDOWN ###
P20<- THP_tets_plot + ggtitle('C')
P21<- met_tets_plot + ggtitle('A')

P22<- metsul_tets_plot + 
  ggtitle('B')

 (P20 | P21 | P22)

#### Krebs ####
P23<- succ_test_plot+ ggtitle('A')
P24<- cit_test_plot+ ggtitle('B')
P25<- mal_test_plot+ ggtitle('C')

(P23 | P24 | P25)

#### aa GRAPH ####

# transform it
p26 <-ile_tets_plot + ggtitle('C')
p27<- C5_1_tets_plot + ggtitle('E')
p28<-C3_tets_plot + ggtitle('G') 

p29<- leu_tets_plot+ ggtitle('B') 
p30<- C5MDC_tets_plot+ ggtitle('F')

p31<-val_tets_plot+ ggtitle('A')
p32<- C4OH_tets_plot+ ggtitle('D')

(ile_tets_plot|C3_tets_plot|C5_1_tets_plot)/
  (leu_tets_plot|C5MDC_tets_plot| plot_spacer() ) /
  (val_tets_plot | C4OH_tets_plot| plot_spacer() )

AA_PLOT<- (ile_tets_plot|C3_tets_plot|C5_1_tets_plot)/
  (leu_tets_plot|C5MDC_tets_plot| plot_spacer() ) /
  (val_tets_plot | C4OH_tets_plot| plot_spacer() )
ggsave("AA_PLOT.png")

AA_PLOT2<- (p26|p27|p28)/
  (p29|p30| plot_spacer() ) /
  (p31 | p32| plot_spacer() )
ggsave("AA_PLOT2.png")
AA_PLOT2
AA_PLOT3<- (p31|p29|p26)/
  (p32|p27| p30 ) /
  (p28 | plot_spacer() )
ggsave("AA_PLOT2.png")
AA_PLOT3

# last plot
p46 <- test_val_site_year_plot4
#+ ggtitle('Valine')
p47<- test_leu_site_year_plot4
#+ ggtitle('Leucine')
p48<- test_ile_site_year_plot4
#+ ggtitle('Isoleucine') 
p49<- test_C4OH_site_year_plot4
#+ ggtitle('Hydroxybutyrylcarnitine') 
p50<- test_C5_1_site_year_plot4
#+ ggtitle('Tigylcarnitine')
p51<- test_C5MDC_site_year_plot4
#+ ggtitle('Methylglutarylcarnitine')
p52<- test_C3_site_year_plot4
#+ ggtitle('Pronionylcarnitine')

AA_PLOT4<- (p46|p47|p48)/
  (p49|p50| p51 ) /
  (p52 | plot_spacer() )
ggsave("AA_PLOT4.png")
AA_PLOT4

#### cartine long chain graph ####
load("F:/Walleye_Bayes/C14_simple_model.RData")
load("F:/Walleye_Bayes/C14_1_simple_model.RData")
load("F:/Walleye_Bayes/C14_1OH_simple_model.RData")
load("F:/Walleye_Bayes/C16_simple_model.RData")
load("F:/Walleye_Bayes/C16_1_simple_model.RData")
load("F:/Walleye_Bayes/C16OH_simple_model.RData")
load("F:/Walleye_Bayes/C18_1_simple_model.RData")
load("F:/Walleye_Bayes/C18_1OH_simple_model.RData")
load("F:/Walleye_Bayes/C18_2_simple_model.RData")

# plot names
#C14
a<- test_C14_site_year_plot3
b<- test_C14_1_site_year_plot3
c<- test_C14_1OH_site_year_plot2
#C16
d<- test_C16_site_year_plot3
e<- test_C16_1_site_year_plot3
f<- test_C16_1OH_site_year_plot2
# C18
g<- test_C18_site_year_plot3
h<- test_C18_1_site_year_plot3
i<- test_C18_1OH_site_year_plot2

# graph carnitines
(a|b|c)/
  (d|e| f ) /
  (g | h| i )

carn_graph<- (a|b|c)/
  (d|e| f ) /
  (g | h| i )
carn_graph
ggsave("carn_graph.png")

# repeat of the graph last used:)
# plot names
#C14
a<- test_C14_site_year_plot3
b<- test_C14_1_site_year_plot3
c<- test_C14_1OH_site_year_plot2
#C16
d<- test_C16_site_year_plot3
e<- test_C16_1_site_year_plot3
f<- test_C16_1OH_site_year_plot2
# C18
g<- test_C18_site_year_plot3
h<- test_C18_1_site_year_plot3
i<- test_C18_1OH_site_year_plot2

# graph carnitines
(a|b|c)/
  (d|e| f ) /
  (g | h| i )

carn_graph<- (a|b|c)/
  (d|e| f ) /
  (g | h| i )
carn_graph
ggsave("carn_graph.png")

#### TWS Graphs ####


# library
library(ggplot2)
# example
# Plot boxplot using ggplot function
# diamonds dataset used here is inbuilt in the R Language
plot <- ggplot(raw_dataf, aes(x=Site, y=Valine, color = factor(Year)))+
  geom_boxplot()+
  theme( legend.position = "right" )

# print boxplot
plot


#### no K test 2 tyrosine simple model ####
Test2_tyr <- brm(data=raw_dataf,
                 family = skew_normal,
                 bf(Tyrosine ~ Site_Year + Sex,
                    sigma ~ Site_Year + Sex),
                 prior = c(prior(normal(0,30), class = b),
                           prior(normal(0,30), class = Intercept)),
                 iter = 20000, warmup = 5000, chains = 4, cores = 4,
                 control = list(adapt_delta = 0.95, max_treedepth = 15))


plot(Test2_tyr)
pp_check(Test2_tyr, ndraws = 100) +
  theme_bw()
summary(Test2_tyr)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Tyrosine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                            95.97      9.69    75.61   113.64 1.00    13944
# sigma_Intercept                       3.99      0.24     3.58     4.52 1.00    16769
# Site_YearDauphinRiver_2018           -7.62     14.57   -34.62    22.41 1.00    26252
# Site_YearMatheson_2017               -2.97     18.16   -36.52    35.49 1.00    33912
# Site_YearMatheson_2018              -52.20     10.26   -71.13   -31.11 1.00    15096
# Site_YearRedRiver_2017               -7.77     10.77   -27.69    14.66 1.00    16492
# Site_YearRedRiver_2018              -15.37     13.63   -41.02    12.41 1.00    22833
# Site_YearSandyBar_2017              -16.21     11.07   -36.70     6.66 1.00    18029
# Site_YearSandyBar_2018              -51.05      9.96   -69.54   -30.50 1.00    14821
# Site_YearWinnipegRiver_2017         -29.01     11.98   -50.24    -3.17 1.00    17230
# SexM                                -20.09      5.48   -29.80    -8.51 1.00    32936
# SexUN                               -12.99      4.93   -22.51    -3.33 1.00    29609
# sigma_Site_YearDauphinRiver_2018      0.31      0.33    -0.34     0.94 1.00    22328
# sigma_Site_YearMatheson_2017         -0.14      0.42    -0.92     0.71 1.00    25658
# sigma_Site_YearMatheson_2018         -1.41      0.35    -2.10    -0.74 1.00    19922
# sigma_Site_YearRedRiver_2017         -0.92      0.30    -1.55    -0.36 1.00    20090
# sigma_Site_YearRedRiver_2018         -0.29      0.30    -0.89     0.29 1.00    21554
# sigma_Site_YearSandyBar_2017         -0.64      0.29    -1.23    -0.09 1.00    20027
# sigma_Site_YearSandyBar_2018         -1.61      0.34    -2.27    -0.93 1.00    24646
# sigma_Site_YearWinnipegRiver_2017    -1.58      0.57    -2.57    -0.32 1.00    23541
# sigma_SexM                           -0.14      0.23    -0.60     0.30 1.00    30262
# sigma_SexUN                          -0.85      0.39    -1.61    -0.09 1.00    33990
# Tail_ESS
# Intercept                            18894
# sigma_Intercept                      20567
# Site_YearDauphinRiver_2018           36157
# Site_YearMatheson_2017               36094
# Site_YearMatheson_2018               21290
# Site_YearRedRiver_2017               23051
# Site_YearRedRiver_2018               33639
# Site_YearSandyBar_2017               25962
# Site_YearSandyBar_2018               20349
# Site_YearWinnipegRiver_2017          24466
# SexM                                 37237
# SexUN                                38721
# sigma_Site_YearDauphinRiver_2018     28742
# sigma_Site_YearMatheson_2017         34674
# sigma_Site_YearMatheson_2018         27196
# sigma_Site_YearRedRiver_2017         25657
# sigma_Site_YearRedRiver_2018         28306
# sigma_Site_YearSandyBar_2017         25983
# sigma_Site_YearSandyBar_2018         34460
# sigma_Site_YearWinnipegRiver_2017    24388
# sigma_SexM                           36325
# sigma_SexUN                          42089
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.93      1.94     2.18     9.69 1.00    29340    29265
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 2 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
emmeans(Test2_tyr, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    85.4      65.6     103.6
# DauphinRiver_2018    76.3      54.8     102.3
# Matheson_2017        80.8      48.9     117.6
# Matheson_2018        32.8      25.4      40.0
# RedRiver_2017        76.9      65.6      88.8
# RedRiver_2018        68.9      50.1      90.2
# SandyBar_2017        68.4      55.6      82.1
# SandyBar_2018        33.7      28.5      39.2
# WinnipegRiver_2017   54.7      41.9      74.1
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(Test2_tyr, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     8.153    -21.52     35.38
# DauphinRiver_2017 - Matheson_2017         3.851    -34.55     37.35
# DauphinRiver_2017 - Matheson_2018        52.650     31.64     71.51
# DauphinRiver_2017 - RedRiver_2017         8.291    -13.93     28.28
# DauphinRiver_2017 - RedRiver_2018        15.731    -11.67     41.63
# DauphinRiver_2017 - SandyBar_2017        16.694     -5.77     37.47
# DauphinRiver_2017 - SandyBar_2018        51.427     31.26     70.19
# DauphinRiver_2017 - WinnipegRiver_2017   29.824      5.19     51.58
# DauphinRiver_2018 - Matheson_2017        -4.333    -46.53     36.55
# DauphinRiver_2018 - Matheson_2018        43.462     19.93     71.14
# DauphinRiver_2018 - RedRiver_2017        -0.584    -24.87     28.36
# DauphinRiver_2018 - RedRiver_2018         7.602    -22.29     38.36
# DauphinRiver_2018 - SandyBar_2017         7.913    -19.15     35.62
# DauphinRiver_2018 - SandyBar_2018        42.451     21.05     68.20
# DauphinRiver_2018 - WinnipegRiver_2017   21.072     -6.66     51.71
# Matheson_2017 - Matheson_2018            48.050     15.60     85.87
# Matheson_2017 - RedRiver_2017             3.709    -29.46     41.55
# Matheson_2017 - RedRiver_2018            11.939    -26.24     53.50
# Matheson_2017 - SandyBar_2017            12.228    -21.48     50.83
# Matheson_2017 - SandyBar_2018            47.007     14.95     84.34
# Matheson_2017 - WinnipegRiver_2017       25.328     -9.81     66.03
# Matheson_2018 - RedRiver_2017           -44.322    -57.39    -31.24
# Matheson_2018 - RedRiver_2018           -36.360    -58.31    -14.88
# Matheson_2018 - SandyBar_2017           -35.803    -50.77    -21.41
# Matheson_2018 - SandyBar_2018            -0.960    -10.93      7.71
# Matheson_2018 - WinnipegRiver_2017      -22.244    -41.47     -6.87
# RedRiver_2017 - RedRiver_2018             7.930    -15.88     31.90
# RedRiver_2017 - SandyBar_2017             8.558     -7.87     24.84
# RedRiver_2017 - SandyBar_2018            43.040     30.39     56.13
# RedRiver_2017 - WinnipegRiver_2017       22.006      1.05     38.87
# RedRiver_2018 - SandyBar_2017             0.501    -22.80     26.61
# RedRiver_2018 - SandyBar_2018            35.108     15.92     56.53
# RedRiver_2018 - WinnipegRiver_2017       13.789    -12.71     39.99
# SandyBar_2017 - SandyBar_2018            34.556     20.82     49.38
# SandyBar_2017 - WinnipegRiver_2017       13.420     -7.66     32.39
# SandyBar_2018 - WinnipegRiver_2017      -20.932    -39.96     -6.05
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(Test2_tyr, ~ Site_Year)) #### That's the one!!!!!!
Test2_tr=yr_plot<- plot(emmeans(Test2_tyr, ~ Site_Year)) #### That's the one!!!!!!
Test2_tr=yr_plot
ggsave("test2_tr=yr_plot.png")
plot(emmeans(Test2_tyr, ~ Sex*Site_Year))
plot(pairs(emmeans(Test2_tyr, ~ Site_Year)))

gather_emmeans_draws(emmeans(Test2_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(Test2_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_tyr.rda")
tyr_tets2_plot <- gather_emmeans_draws(emmeans(Test2_tyr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("tyr_tets2_plot.png")
library(repmod)
library(report)
report(Test2_tyr)
report_table(Test2_tyr)


#### test 2 alanine simple model ####
test2_ala<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Alanine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,400), class = b),
                          prior(normal(0,400), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_ala)
pp_check(test2_ala, ndraws = 100) +
  theme_bw()
summary(test2_ala)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Alanine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           475.45     43.74   395.38   567.12 1.00    15148
# sigma_Intercept                       5.19      0.19     4.83     5.58 1.00    19823
# Site_YearDauphinRiver_2018         -185.65     56.91  -300.55   -75.14 1.00    20998
# Site_YearMatheson_2017             -118.22     77.69  -256.62    52.17 1.00    22790
# Site_YearMatheson_2018             -224.70     55.95  -332.72  -112.43 1.00    17588
# Site_YearRedRiver_2017                0.56     59.00  -115.73   117.86 1.00    20486
# Site_YearRedRiver_2018             -155.73     50.67  -258.07   -58.00 1.00    17425
# Site_YearSandyBar_2017              -15.98     50.13  -117.71    80.69 1.00    17722
# Site_YearSandyBar_2018             -188.08     57.94  -302.58   -72.37 1.00    21150
# Site_YearWinnipegRiver_2017          56.04     72.59   -75.59   209.76 1.00    20085
# SexM                                -37.27     33.38   -98.23    31.82 1.00    46667
# SexUN                                67.86     87.14   -84.17   257.78 1.00    37069
# sigma_Site_YearDauphinRiver_2018     -0.46      0.28    -1.01     0.11 1.00    27747
# sigma_Site_YearMatheson_2017         -0.47      0.45    -1.26     0.52 1.00    26218
# sigma_Site_YearMatheson_2018         -0.53      0.33    -1.15     0.15 1.00    24087
# sigma_Site_YearRedRiver_2017         -0.15      0.27    -0.68     0.38 1.00    24731
# sigma_Site_YearRedRiver_2018         -0.74      0.30    -1.31    -0.14 1.00    27477
# sigma_Site_YearSandyBar_2017         -0.45      0.25    -0.95     0.05 1.00    25534
# sigma_Site_YearSandyBar_2018         -0.22      0.29    -0.80     0.36 1.00    30785
# sigma_Site_YearWinnipegRiver_2017    -0.70      0.52    -1.58     0.47 1.00    26868
# sigma_SexM                            0.09      0.22    -0.33     0.52 1.00    45017
# sigma_SexUN                           0.62      0.35    -0.06     1.32 1.00    37975
# Tail_ESS
# Intercept                            18721
# sigma_Intercept                      25837
# Site_YearDauphinRiver_2018           25502
# Site_YearMatheson_2017               27565
# Site_YearMatheson_2018               23149
# Site_YearRedRiver_2017               27641
# Site_YearRedRiver_2018               22797
# Site_YearSandyBar_2017               22709
# Site_YearSandyBar_2018               27241
# Site_YearWinnipegRiver_2017          26361
# SexM                                 41574
# SexUN                                34276
# sigma_Site_YearDauphinRiver_2018     36877
# sigma_Site_YearMatheson_2017         27640
# sigma_Site_YearMatheson_2018         35189
# sigma_Site_YearRedRiver_2017         32851
# sigma_Site_YearRedRiver_2018         36763
# sigma_Site_YearSandyBar_2017         32801
# sigma_Site_YearSandyBar_2018         37836
# sigma_Site_YearWinnipegRiver_2017    26588
# sigma_SexM                           43801
# sigma_SexUN                          39415
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.30      1.63     1.89     8.22 1.00    34952    29761
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_ala, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017     483       386       588
# DauphinRiver_2018     296       217       395
# Matheson_2017         359       235       515
# Matheson_2018         260       187       341
# RedRiver_2017         484       390       588
# RedRiver_2018         328       256       410
# SandyBar_2017         468       392       551
# SandyBar_2018         295       203       398
# WinnipegRiver_2017    536       419       676
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_ala, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   184.973      72.8     297.8
# DauphinRiver_2017 - Matheson_2017       123.273     -38.9     267.0
# DauphinRiver_2017 - Matheson_2018       225.438     115.0     334.6
# DauphinRiver_2017 - RedRiver_2017        -0.485    -115.5     117.8
# DauphinRiver_2017 - RedRiver_2018       154.697      56.5     256.2
# DauphinRiver_2017 - SandyBar_2017        14.851     -82.7     115.4
# DauphinRiver_2017 - SandyBar_2018       188.004      74.0     304.0
# DauphinRiver_2017 - WinnipegRiver_2017  -52.933    -200.4      81.5
# DauphinRiver_2018 - Matheson_2017       -61.024    -225.9      72.4
# DauphinRiver_2018 - Matheson_2018        39.924     -65.5     142.6
# DauphinRiver_2018 - RedRiver_2017      -185.435    -298.0     -75.2
# DauphinRiver_2018 - RedRiver_2018       -30.882    -129.4      64.5
# DauphinRiver_2018 - SandyBar_2017      -169.872    -264.4     -77.9
# DauphinRiver_2018 - SandyBar_2018         2.691    -110.3     114.6
# DauphinRiver_2018 - WinnipegRiver_2017 -237.954    -381.8    -106.9
# Matheson_2017 - Matheson_2018           100.803     -37.7     264.6
# Matheson_2017 - RedRiver_2017          -124.225    -269.7      41.0
# Matheson_2017 - RedRiver_2018            30.894     -94.9     187.8
# Matheson_2017 - SandyBar_2017          -109.342    -230.3      49.4
# Matheson_2017 - SandyBar_2018            65.132     -80.2     225.0
# Matheson_2017 - WinnipegRiver_2017     -176.990    -341.6      18.0
# Matheson_2018 - RedRiver_2017          -225.861    -332.3    -116.5
# Matheson_2018 - RedRiver_2018           -71.923    -156.2      23.2
# Matheson_2018 - SandyBar_2017          -210.710    -295.8    -117.6
# Matheson_2018 - SandyBar_2018           -37.135    -144.8      74.7
# Matheson_2018 - WinnipegRiver_2017     -278.140    -417.9    -148.2
# RedRiver_2017 - RedRiver_2018           155.040      60.2     255.4
# RedRiver_2017 - SandyBar_2017            15.684     -78.3     116.1
# RedRiver_2017 - SandyBar_2018           188.712      71.0     303.3
# RedRiver_2017 - WinnipegRiver_2017      -52.788    -197.0      81.3
# RedRiver_2018 - SandyBar_2017          -139.231    -217.4     -62.8
# RedRiver_2018 - SandyBar_2018            33.920     -64.7     126.3
# RedRiver_2018 - WinnipegRiver_2017     -206.535    -344.2     -89.1
# SandyBar_2017 - SandyBar_2018           173.122      72.5     266.9
# SandyBar_2017 - WinnipegRiver_2017      -67.454    -203.9      49.7
# SandyBar_2018 - WinnipegRiver_2017     -240.769    -388.1    -102.9
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_ala, ~ Site_Year)) #### That's the one!!!!!!
test2_ala_yr_plot<- plot(emmeans(test2_ala, ~ Site_Year)) #### That's the one!!!!!!
test2_ala_yr_plot
ggsave("test2_ala_yr_plot.png")
plot(emmeans(test2_ala, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_ala, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_ala, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_ala, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_ala.rda")
ala_tets2_plot <- gather_emmeans_draws(emmeans(test2_ala, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("ala_tets2_plot.png")
# save model
save(a, b, c, file = "stuff.RData")
save(test2_ala, file = "test2_ala.RDA")
library(repmod)
library(report)
report(test2_ala)
#### test 2 valine simple model ####
test2_val<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Valine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,200), class = b),
                          prior(normal(0,200), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_val)
pp_check(test2_val, ndraws = 100) +
  theme_bw()
summary(test2_val)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Valine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           410.47     50.82   301.93   502.46 1.00    11269
# sigma_Intercept                       5.63      0.20     5.28     6.08 1.00    17402
# Site_YearDauphinRiver_2018         -100.85     62.41  -214.79    29.66 1.00    14410
# Site_YearMatheson_2017              -98.63     88.86  -250.28   100.87 1.00    21717
# Site_YearMatheson_2018             -283.77     52.12  -378.86  -172.62 1.00    11741
# Site_YearRedRiver_2017             -215.08     51.71  -308.64  -104.33 1.00    12230
# Site_YearRedRiver_2018             -244.39     51.55  -337.73  -134.56 1.00    11827
# Site_YearSandyBar_2017             -140.93     56.62  -244.45   -22.11 1.00    13993
# Site_YearSandyBar_2018             -247.24     51.63  -341.00  -137.03 1.00    11752
# Site_YearWinnipegRiver_2017        -241.43     57.80  -343.43  -116.54 1.00    12311
# SexM                                -77.66     12.67  -101.53   -51.23 1.00    38891
# SexUN                               -16.42     28.83   -69.69    45.49 1.00    35607
# sigma_Site_YearDauphinRiver_2018     -0.74      0.33    -1.38    -0.08 1.00    21099
# sigma_Site_YearMatheson_2017         -0.35      0.44    -1.14     0.59 1.00    24800
# sigma_Site_YearMatheson_2018         -1.86      0.30    -2.45    -1.28 1.00    22216
# sigma_Site_YearRedRiver_2017         -1.56      0.27    -2.10    -1.05 1.00    23461
# sigma_Site_YearRedRiver_2018         -1.70      0.28    -2.25    -1.16 1.00    23689
# sigma_Site_YearSandyBar_2017         -0.70      0.26    -1.24    -0.19 1.00    21440
# sigma_Site_YearSandyBar_2018         -1.82      0.29    -2.38    -1.24 1.00    23169
# sigma_Site_YearWinnipegRiver_2017    -2.07      0.57    -3.02    -0.77 1.00    21881
# sigma_SexM                           -0.38      0.19    -0.76     0.00 1.00    31045
# sigma_SexUN                           0.11      0.33    -0.52     0.79 1.00    34808
# Tail_ESS
# Intercept                            12919
# sigma_Intercept                      19488
# Site_YearDauphinRiver_2018           21619
# Site_YearMatheson_2017               29404
# Site_YearMatheson_2018               14125
# Site_YearRedRiver_2017               14474
# Site_YearRedRiver_2018               14356
# Site_YearSandyBar_2017               18583
# Site_YearSandyBar_2018               13626
# Site_YearWinnipegRiver_2017          15881
# SexM                                 36858
# SexUN                                30454
# sigma_Site_YearDauphinRiver_2018     29149
# sigma_Site_YearMatheson_2017         30237
# sigma_Site_YearMatheson_2018         26742
# sigma_Site_YearRedRiver_2017         26921
# sigma_Site_YearRedRiver_2018         27270
# sigma_Site_YearSandyBar_2017         24555
# sigma_Site_YearSandyBar_2018         29596
# sigma_Site_YearWinnipegRiver_2017    20609
# sigma_SexM                           40126
# sigma_SexUN                          33199
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     6.54      2.17     3.10    11.50 1.00    38801    32703
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_val, ~ Site_Year)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Valine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           410.47     50.82   301.93   502.46 1.00    11269
# sigma_Intercept                       5.63      0.20     5.28     6.08 1.00    17402
# Site_YearDauphinRiver_2018         -100.85     62.41  -214.79    29.66 1.00    14410
# Site_YearMatheson_2017              -98.63     88.86  -250.28   100.87 1.00    21717
# Site_YearMatheson_2018             -283.77     52.12  -378.86  -172.62 1.00    11741
# Site_YearRedRiver_2017             -215.08     51.71  -308.64  -104.33 1.00    12230
# Site_YearRedRiver_2018             -244.39     51.55  -337.73  -134.56 1.00    11827
# Site_YearSandyBar_2017             -140.93     56.62  -244.45   -22.11 1.00    13993
# Site_YearSandyBar_2018             -247.24     51.63  -341.00  -137.03 1.00    11752
# Site_YearWinnipegRiver_2017        -241.43     57.80  -343.43  -116.54 1.00    12311
# SexM                                -77.66     12.67  -101.53   -51.23 1.00    38891
# SexUN                               -16.42     28.83   -69.69    45.49 1.00    35607
# sigma_Site_YearDauphinRiver_2018     -0.74      0.33    -1.38    -0.08 1.00    21099
# sigma_Site_YearMatheson_2017         -0.35      0.44    -1.14     0.59 1.00    24800
# sigma_Site_YearMatheson_2018         -1.86      0.30    -2.45    -1.28 1.00    22216
# sigma_Site_YearRedRiver_2017         -1.56      0.27    -2.10    -1.05 1.00    23461
# sigma_Site_YearRedRiver_2018         -1.70      0.28    -2.25    -1.16 1.00    23689
# sigma_Site_YearSandyBar_2017         -0.70      0.26    -1.24    -0.19 1.00    21440
# sigma_Site_YearSandyBar_2018         -1.82      0.29    -2.38    -1.24 1.00    23169
# sigma_Site_YearWinnipegRiver_2017    -2.07      0.57    -3.02    -0.77 1.00    21881
# sigma_SexM                           -0.38      0.19    -0.76     0.00 1.00    31045
# sigma_SexUN                           0.11      0.33    -0.52     0.79 1.00    34808
# Tail_ESS
# Intercept                            12919
# sigma_Intercept                      19488
# Site_YearDauphinRiver_2018           21619
# Site_YearMatheson_2017               29404
# Site_YearMatheson_2018               14125
# Site_YearRedRiver_2017               14474
# Site_YearRedRiver_2018               14356
# Site_YearSandyBar_2017               18583
# Site_YearSandyBar_2018               13626
# Site_YearWinnipegRiver_2017          15881
# SexM                                 36858
# SexUN                                30454
# sigma_Site_YearDauphinRiver_2018     29149
# sigma_Site_YearMatheson_2017         30237
# sigma_Site_YearMatheson_2018         26742
# sigma_Site_YearRedRiver_2017         26921
# sigma_Site_YearRedRiver_2018         27270
# sigma_Site_YearSandyBar_2017         24555
# sigma_Site_YearSandyBar_2018         29596
# sigma_Site_YearWinnipegRiver_2017    20609
# sigma_SexM                           40126
# sigma_SexUN                          33199
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     6.54      2.17     3.10    11.50 1.00    38801    32703
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
pairs(emmeans(test2_val, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    103.82    -22.66    220.34
# DauphinRiver_2017 - Matheson_2017        106.20    -77.67    267.94
# DauphinRiver_2017 - Matheson_2018        286.49    181.06    384.84
# DauphinRiver_2017 - RedRiver_2017        218.02    109.16    312.45
# DauphinRiver_2017 - RedRiver_2018        246.98    140.56    343.05
# DauphinRiver_2017 - SandyBar_2017        143.69     25.23    246.83
# DauphinRiver_2017 - SandyBar_2018        250.01    142.85    345.70
# DauphinRiver_2017 - WinnipegRiver_2017   245.27    125.96    350.34
# DauphinRiver_2018 - Matheson_2017          5.18   -177.80    160.41
# DauphinRiver_2018 - Matheson_2018        179.90    113.56    257.91
# DauphinRiver_2018 - RedRiver_2017        111.59     36.65    195.69
# DauphinRiver_2018 - RedRiver_2018        140.16     71.63    219.52
# DauphinRiver_2018 - SandyBar_2017         38.40    -50.14    133.85
# DauphinRiver_2018 - SandyBar_2018        142.97     80.24    225.18
# DauphinRiver_2018 - WinnipegRiver_2017   140.62     51.69    234.83
# Matheson_2017 - Matheson_2018            174.27     48.43    356.33
# Matheson_2017 - RedRiver_2017            105.54    -19.24    290.42
# Matheson_2017 - RedRiver_2018            134.43      7.57    313.74
# Matheson_2017 - SandyBar_2017             32.75   -108.47    218.81
# Matheson_2017 - SandyBar_2018            137.38     13.07    318.42
# Matheson_2017 - WinnipegRiver_2017       134.39     -5.73    327.66
# Matheson_2018 - RedRiver_2017            -68.16   -111.11    -29.86
# Matheson_2018 - RedRiver_2018            -39.60    -75.59     -2.04
# Matheson_2018 - SandyBar_2017           -141.43   -206.28    -82.25
# Matheson_2018 - SandyBar_2018            -36.98    -71.73     -2.16
# Matheson_2018 - WinnipegRiver_2017       -38.20   -104.79     13.12
# RedRiver_2017 - RedRiver_2018             28.94     -8.95     69.28
# RedRiver_2017 - SandyBar_2017            -72.78   -141.10    -11.96
# RedRiver_2017 - SandyBar_2018             31.55     -5.03     70.98
# RedRiver_2017 - WinnipegRiver_2017        29.78    -36.53     87.36
# RedRiver_2018 - SandyBar_2017           -102.08   -165.71    -43.24
# RedRiver_2018 - SandyBar_2018              2.86    -26.20     32.20
# RedRiver_2018 - WinnipegRiver_2017         1.25    -64.78     54.16
# SandyBar_2017 - SandyBar_2018            104.83     46.61    167.40
# SandyBar_2017 - WinnipegRiver_2017       102.05     20.09    179.25
# SandyBar_2018 - WinnipegRiver_2017        -1.41    -69.59     46.79
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_val, ~ Site_Year)) #### That's the one!!!!!!
test2_val_yr_plot<- plot(emmeans(test2_val, ~ Site_Year)) #### That's the one!!!!!!
test2_val_yr_plot
ggsave("test2_val_yr_plot.png")
plot(emmeans(test2_val, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_val, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_val, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_val, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_val.rda")
val_tets2_plot <- gather_emmeans_draws(emmeans(test2_val, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("val_tets2_plot.png")
# save model
save(a, b, c, file = "stuff.RData")
save(test2_val, file = "test2_val.RDA")
library(repmod)
library(report)
report(test2_val)

#### test 2 tryptophan simple model ####
test2_trp<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Tryptophan~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,30), class = b),
                          prior(normal(0,30), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_trp)
pp_check(test2_trp, ndraws = 100) +
  theme_bw()
summary(test2_trp)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Tryptophan ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                            30.46      2.89    24.96    36.31 1.00    15407
# sigma_Intercept                       2.55      0.20     2.18     2.97 1.00    21447
# Site_YearDauphinRiver_2018           -0.06      4.14    -8.11     8.26 1.00    21552
# Site_YearMatheson_2017               -7.85      6.12   -18.85     5.46 1.00    25001
# Site_YearMatheson_2018              -16.15      3.12   -22.45   -10.16 1.00    16560
# Site_YearRedRiver_2017              -10.62      3.10   -16.83    -4.61 1.00    17474
# Site_YearRedRiver_2018              -11.13      3.27   -17.58    -4.72 1.00    17770
# Site_YearSandyBar_2017              -11.04      3.24   -17.49    -4.76 1.00    18410
# Site_YearSandyBar_2018              -16.24      3.09   -22.35   -10.16 1.00    17504
# Site_YearWinnipegRiver_2017          -7.99      4.54   -16.37     1.42 1.00    19924
# SexM                                 -3.85      1.52    -6.79    -0.83 1.00    44285
# SexUN                                -1.38      2.45    -6.00     3.87 1.00    39475
# sigma_Site_YearDauphinRiver_2018     -0.11      0.35    -0.77     0.60 1.00    27512
# sigma_Site_YearMatheson_2017         -0.13      0.45    -0.92     0.86 1.00    30630
# sigma_Site_YearMatheson_2018         -1.09      0.29    -1.64    -0.52 1.00    27999
# sigma_Site_YearRedRiver_2017         -0.87      0.27    -1.40    -0.35 1.00    28546
# sigma_Site_YearRedRiver_2018         -0.71      0.28    -1.26    -0.15 1.00    29553
# sigma_Site_YearSandyBar_2017         -0.53      0.26    -1.04    -0.03 1.00    28843
# sigma_Site_YearSandyBar_2018         -0.93      0.28    -1.47    -0.38 1.00    27853
# sigma_Site_YearWinnipegRiver_2017    -0.91      0.53    -1.80     0.27 1.00    25961
# sigma_SexM                           -0.23      0.19    -0.60     0.15 1.00    44273
# sigma_SexUN                          -0.15      0.39    -0.91     0.63 1.00    37870
# Tail_ESS
# Intercept                            20090
# sigma_Intercept                      26470
# Site_YearDauphinRiver_2018           29787
# Site_YearMatheson_2017               25108
# Site_YearMatheson_2018               21377
# Site_YearRedRiver_2017               23573
# Site_YearRedRiver_2018               24883
# Site_YearSandyBar_2017               26130
# Site_YearSandyBar_2018               23488
# Site_YearWinnipegRiver_2017          26217
# SexM                                 40836
# SexUN                                31601
# sigma_Site_YearDauphinRiver_2018     36125
# sigma_Site_YearMatheson_2017         29129
# sigma_Site_YearMatheson_2018         35691
# sigma_Site_YearRedRiver_2017         35022
# sigma_Site_YearRedRiver_2018         35970
# sigma_Site_YearSandyBar_2017         34669
# sigma_Site_YearSandyBar_2018         35060
# sigma_Site_YearWinnipegRiver_2017    25596
# sigma_SexM                           42685
# sigma_SexUN                          39012
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     2.27      1.28    -0.48     4.91 1.00    32388    31885
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_trp, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    28.7     23.01      34.5
# DauphinRiver_2018    28.5     23.32      34.4
# Matheson_2017        20.4     10.37      32.2
# Matheson_2018        12.5      9.89      15.3
# RedRiver_2017        18.1     14.92      21.3
# RedRiver_2018        17.5     14.19      21.2
# SandyBar_2017        17.6     14.00      21.5
# SandyBar_2018        12.4      9.66      15.4
# WinnipegRiver_2017   20.4     14.02      28.2
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_trp, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    0.1164     -7.86     8.500
# DauphinRiver_2017 - Matheson_2017        8.1698     -4.48    19.538
# DauphinRiver_2017 - Matheson_2018       16.1036     10.05    22.337
# DauphinRiver_2017 - RedRiver_2017       10.5819      4.54    16.738
# DauphinRiver_2017 - RedRiver_2018       11.1277      4.74    17.601
# DauphinRiver_2017 - SandyBar_2017       11.0085      4.71    17.432
# DauphinRiver_2017 - SandyBar_2018       16.2215     10.22    22.379
# DauphinRiver_2017 - WinnipegRiver_2017   8.1332     -0.86    16.783
# DauphinRiver_2018 - Matheson_2017        8.0890     -5.06    19.380
# DauphinRiver_2018 - Matheson_2018       15.9973     10.23    22.323
# DauphinRiver_2018 - RedRiver_2017       10.4620      4.15    17.126
# DauphinRiver_2018 - RedRiver_2018       10.9624      4.55    17.738
# DauphinRiver_2018 - SandyBar_2017       10.8913      4.33    17.880
# DauphinRiver_2018 - SandyBar_2018       16.0614      9.98    22.619
# DauphinRiver_2018 - WinnipegRiver_2017   8.0281     -0.90    17.100
# Matheson_2017 - Matheson_2018            7.8845     -2.33    19.755
# Matheson_2017 - RedRiver_2017            2.3487     -7.81    14.330
# Matheson_2017 - RedRiver_2018            2.8661     -7.20    15.141
# Matheson_2017 - SandyBar_2017            2.7915     -7.60    14.865
# Matheson_2017 - SandyBar_2018            7.9462     -2.05    19.897
# Matheson_2017 - WinnipegRiver_2017      -0.0635    -13.11    13.028
# Matheson_2018 - RedRiver_2017           -5.5300     -9.14    -1.951
# Matheson_2018 - RedRiver_2018           -5.0120     -9.09    -0.805
# Matheson_2018 - SandyBar_2017           -5.0831     -9.31    -1.039
# Matheson_2018 - SandyBar_2018            0.1013     -3.56     3.793
# Matheson_2018 - WinnipegRiver_2017      -7.9236    -15.97    -1.556
# RedRiver_2017 - RedRiver_2018            0.5259     -3.82     4.771
# RedRiver_2017 - SandyBar_2017            0.4464     -3.76     4.625
# RedRiver_2017 - SandyBar_2018            5.6528      1.79     9.433
# RedRiver_2017 - WinnipegRiver_2017      -2.3928    -10.47     4.234
# RedRiver_2018 - SandyBar_2017           -0.0974     -4.85     4.485
# RedRiver_2018 - SandyBar_2018            5.0818      1.30     9.036
# RedRiver_2018 - WinnipegRiver_2017      -2.9207    -10.90     4.295
# SandyBar_2017 - SandyBar_2018            5.2138      0.93     9.388
# SandyBar_2017 - WinnipegRiver_2017      -2.8359    -10.86     4.456
# SandyBar_2018 - WinnipegRiver_2017      -8.0275    -15.97    -1.144
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_trp, ~ Site_Year)) #### That's the one!!!!!!
test2_trp_yr_plot<- plot(emmeans(test2_trp, ~ Site_Year)) #### That's the one!!!!!!
test2_trp_yr_plot
ggsave("test2_trp_yr_plot.png")
plot(emmeans(test2_trp, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_trp, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_trp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_trp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_trp.rda")
trp_tets2_plot <- gather_emmeans_draws(emmeans(test2_trp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("trp_tets2_plot.png")
# save model
save(a, b, c, file = "stuff.RData")
save(test2_trp, file = "test2_trp.RDA")
library(repmod)
library(report)
report(test2_trp)

#### test 2 threonine simple model ####
test2_thr<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Threonine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,150), class = b),
                          prior(normal(0,150), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_thr)
pp_check(test2_thr, ndraws = 100) +
  theme_bw()
summary(test2_thr)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Threonine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           199.57     15.13   172.32   231.73 1.00    14329
# sigma_Intercept                       4.12      0.20     3.74     4.53 1.00    15894
# Site_YearDauphinRiver_2018          -59.52     21.47  -101.05   -16.57 1.00    18795
# Site_YearMatheson_2017                3.84     50.90   -83.18   118.10 1.00    36476
# Site_YearMatheson_2018              -57.74     19.95   -97.18   -18.70 1.00    17849
# Site_YearRedRiver_2017              -23.04     15.82   -55.28     6.95 1.00    16312
# Site_YearRedRiver_2018              -67.83     23.34  -111.06   -19.72 1.00    18677
# Site_YearSandyBar_2017              -39.47     18.22   -75.73    -3.53 1.00    23658
# Site_YearSandyBar_2018             -100.35     16.57  -133.38   -68.54 1.00    16419
# Site_YearWinnipegRiver_2017         -41.52     51.88  -128.07    82.20 1.00    27245
# SexM                                -42.86     10.48   -62.59   -21.54 1.00    38348
# SexUN                               -26.99     16.58   -57.30     8.48 1.00    36016
# sigma_Site_YearDauphinRiver_2018     -0.01      0.33    -0.63     0.67 1.00    21798
# sigma_Site_YearMatheson_2017          0.57      0.41    -0.15     1.44 1.00    28778
# sigma_Site_YearMatheson_2018         -0.23      0.28    -0.78     0.34 1.00    21223
# sigma_Site_YearRedRiver_2017         -0.68      0.26    -1.19    -0.17 1.00    22526
# sigma_Site_YearRedRiver_2018          0.01      0.30    -0.57     0.60 1.00    21678
# sigma_Site_YearSandyBar_2017         -0.13      0.25    -0.62     0.36 1.00    26137
# sigma_Site_YearSandyBar_2018         -0.75      0.31    -1.34    -0.13 1.00    24153
# sigma_Site_YearWinnipegRiver_2017     0.33      0.51    -0.55     1.45 1.00    25961
# sigma_SexM                           -0.23      0.24    -0.70     0.24 1.00    30606
# sigma_SexUN                          -0.25      0.36    -0.94     0.47 1.00    38938
# Tail_ESS
# Intercept                            20155
# sigma_Intercept                      23432
# Site_YearDauphinRiver_2018           28398
# Site_YearMatheson_2017               30389
# Site_YearMatheson_2018               26189
# Site_YearRedRiver_2017               22980
# Site_YearRedRiver_2018               30226
# Site_YearSandyBar_2017               26624
# Site_YearSandyBar_2018               23493
# Site_YearWinnipegRiver_2017          23300
# SexM                                 38568
# SexUN                                31312
# sigma_Site_YearDauphinRiver_2018     33887
# sigma_Site_YearMatheson_2017         33028
# sigma_Site_YearMatheson_2018         32397
# sigma_Site_YearRedRiver_2017         33598
# sigma_Site_YearRedRiver_2018         32955
# sigma_Site_YearSandyBar_2017         33989
# sigma_Site_YearSandyBar_2018         34435
# sigma_Site_YearWinnipegRiver_2017    28237
# sigma_SexM                           43143
# sigma_SexUN                          35688
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.40      1.88     2.37     9.73 1.00    41151    34876
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 1 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
emmeans(test2_thr, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   175.7     146.1     206.2
# DauphinRiver_2018   115.6      90.3     145.0
# Matheson_2017       175.0      88.2     287.5
# Matheson_2018       117.7      92.5     146.7
# RedRiver_2017       152.9     135.0     172.5
# RedRiver_2018       107.1      78.4     143.8
# SandyBar_2017       135.8     107.4     167.3
# SandyBar_2018        75.3      59.6      92.7
# WinnipegRiver_2017  127.5      43.2     243.2
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_thr, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    59.771    17.414    101.69
# DauphinRiver_2017 - Matheson_2017         0.928  -107.861     91.85
# DauphinRiver_2017 - Matheson_2018        57.745    17.844     96.26
# DauphinRiver_2017 - RedRiver_2017        22.593    -7.311     54.83
# DauphinRiver_2017 - RedRiver_2018        68.728    21.629    112.77
# DauphinRiver_2017 - SandyBar_2017        39.495     2.981     75.10
# DauphinRiver_2017 - SandyBar_2018       100.141    68.194    132.95
# DauphinRiver_2017 - WinnipegRiver_2017   47.985   -69.605    136.16
# DauphinRiver_2018 - Matheson_2017       -58.981  -174.469     35.05
# DauphinRiver_2018 - Matheson_2018        -2.020   -39.644     37.69
# DauphinRiver_2018 - RedRiver_2017       -37.173   -71.309     -3.09
# DauphinRiver_2018 - RedRiver_2018         8.567   -35.902     50.15
# DauphinRiver_2018 - SandyBar_2017       -20.127   -64.364     21.71
# DauphinRiver_2018 - SandyBar_2018        40.098     8.820     73.67
# DauphinRiver_2018 - WinnipegRiver_2017  -11.758  -131.363     76.55
# Matheson_2017 - Matheson_2018            56.890   -34.920    171.74
# Matheson_2017 - RedRiver_2017            21.702   -64.429    134.62
# Matheson_2017 - RedRiver_2018            67.856   -32.300    183.00
# Matheson_2017 - SandyBar_2017            38.157   -50.526    149.56
# Matheson_2017 - SandyBar_2018            99.296     9.063    210.34
# Matheson_2017 - WinnipegRiver_2017       46.214   -95.302    194.45
# Matheson_2018 - RedRiver_2017           -35.281   -64.568     -4.41
# Matheson_2018 - RedRiver_2018            10.447   -32.018     51.15
# Matheson_2018 - SandyBar_2017           -17.991   -57.247     21.52
# Matheson_2018 - SandyBar_2018            42.001    12.919     74.07
# Matheson_2018 - WinnipegRiver_2017       -9.578  -125.697     79.64
# RedRiver_2017 - RedRiver_2018            45.863     8.233     79.62
# RedRiver_2017 - SandyBar_2017            17.222   -14.476     46.96
# RedRiver_2017 - SandyBar_2018            77.263    56.356     99.64
# RedRiver_2017 - WinnipegRiver_2017       25.718   -90.174    111.11
# RedRiver_2018 - SandyBar_2017           -28.695   -77.263     17.00
# RedRiver_2018 - SandyBar_2018            31.332     0.638     66.37
# RedRiver_2018 - WinnipegRiver_2017      -20.196  -140.797     69.43
# SandyBar_2017 - SandyBar_2018            60.101    28.380     94.26
# SandyBar_2017 - WinnipegRiver_2017        8.491  -109.246     97.63
# SandyBar_2018 - WinnipegRiver_2017      -51.673  -169.051     33.01
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_thr, ~ Site_Year)) #### That's the one!!!!!!
test2_thr_yr_plot<- plot(emmeans(test2_thr, ~ Site_Year)) #### That's the one!!!!!!
test2_thr_yr_plot
ggsave("test2_thr_yr_plot.png")
plot(emmeans(test2_thr, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_thr, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_thr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_thr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_thr.rda")
thr_tets2_plot <- gather_emmeans_draws(emmeans(test2_thr, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("thr_tets2_plot.png")
# saving model
save(a, b, c, file = "stuff.RData")
save(test2_thr, file = "test2_thr.RDA")
library(repmod)
library(report)
report(test2_thr)

#### test 2 serine simple model ####
test2_ser<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Serine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,30), class = b),
                          prior(normal(0,30), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_ser)
pp_check(test2_ser, ndraws = 100) +
  theme_bw()
summary(test2_ser)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Serine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           109.36      6.91    96.45   123.57 1.00    27409
# sigma_Intercept                       3.50      0.19     3.14     3.89 1.00    20670
# Site_YearDauphinRiver_2018          -10.39     10.46   -31.11    10.22 1.00    34885
# Site_YearMatheson_2017               -7.67     12.48   -29.54    20.37 1.00    36657
# Site_YearMatheson_2018              -17.40      9.69   -35.87     2.46 1.00    31567
# Site_YearRedRiver_2017               29.67     10.84     8.98    51.85 1.00    38990
# Site_YearRedRiver_2018               18.06     15.30    -9.98    50.01 1.00    35796
# Site_YearSandyBar_2017                8.34     10.36   -11.46    29.41 1.00    40003
# Site_YearSandyBar_2018              -10.26     14.69   -36.99    20.48 1.00    34809
# Site_YearWinnipegRiver_2017         -27.22     14.50   -50.72     7.58 1.00    31107
# SexM                                -12.65      9.85   -32.75     6.18 1.00    36931
# SexUN                                -8.62     11.80   -30.59    15.99 1.00    54300
# sigma_Site_YearDauphinRiver_2018     -0.07      0.33    -0.68     0.61 1.00    27786
# sigma_Site_YearMatheson_2017         -0.36      0.46    -1.21     0.58 1.00    31906
# sigma_Site_YearMatheson_2018         -0.25      0.28    -0.79     0.31 1.00    27031
# sigma_Site_YearRedRiver_2017          0.26      0.25    -0.22     0.75 1.00    25245
# sigma_Site_YearRedRiver_2018          0.60      0.26     0.07     1.11 1.00    29177
# sigma_Site_YearSandyBar_2017          0.16      0.24    -0.31     0.63 1.00    31085
# sigma_Site_YearSandyBar_2018          0.51      0.27    -0.03     1.04 1.00    28144
# sigma_Site_YearWinnipegRiver_2017    -0.46      0.52    -1.37     0.67 1.00    28793
# sigma_SexM                           -0.16      0.24    -0.62     0.33 1.00    32543
# sigma_SexUN                           0.03      0.35    -0.67     0.73 1.00    47577
# Tail_ESS
# Intercept                            33817
# sigma_Intercept                      29665
# Site_YearDauphinRiver_2018           39485
# Site_YearMatheson_2017               31557
# Site_YearMatheson_2018               39645
# Site_YearRedRiver_2017               39895
# Site_YearRedRiver_2018               40537
# Site_YearSandyBar_2017               41024
# Site_YearSandyBar_2018               39759
# Site_YearWinnipegRiver_2017          27405
# SexM                                 38318
# SexUN                                40300
# sigma_Site_YearDauphinRiver_2018     37602
# sigma_Site_YearMatheson_2017         35381
# sigma_Site_YearMatheson_2018         37411
# sigma_Site_YearRedRiver_2017         37206
# sigma_Site_YearRedRiver_2018         37396
# sigma_Site_YearSandyBar_2017         38456
# sigma_Site_YearSandyBar_2018         37912
# sigma_Site_YearWinnipegRiver_2017    29402
# sigma_SexM                           42706
# sigma_SexUN                          41816
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     6.17      2.15     2.74    11.07 1.00    42310    37011
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_ser, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   102.1      88.6       116
# DauphinRiver_2018    91.5      75.2       109
# Matheson_2017        93.2      72.4       120
# Matheson_2018        84.5      69.5       101
# RedRiver_2017       131.5     112.1       152
# RedRiver_2018       119.6      90.9       150
# SandyBar_2017       110.2      91.4       129
# SandyBar_2018        91.3      65.0       120
# WinnipegRiver_2017   72.9      50.1       105
# 
# Results are averaged over the levels of: Sex
# Point estimate displayed: median
# HPD interval probability: 0.95
pairs(emmeans(test2_ser, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    10.364    -10.75     30.54
# DauphinRiver_2017 - Matheson_2017         8.753    -17.84     31.50
# DauphinRiver_2017 - Matheson_2018        17.635     -1.91     36.36
# DauphinRiver_2017 - RedRiver_2017       -29.408    -50.83     -8.02
# DauphinRiver_2017 - RedRiver_2018       -17.309    -48.09     11.61
# DauphinRiver_2017 - SandyBar_2017        -8.035    -28.58     12.05
# DauphinRiver_2017 - SandyBar_2018        10.936    -19.10     38.17
# DauphinRiver_2017 - WinnipegRiver_2017   29.036     -3.12     53.44
# DauphinRiver_2018 - Matheson_2017        -1.656    -33.00     25.45
# DauphinRiver_2018 - Matheson_2018         7.173    -14.50     28.23
# DauphinRiver_2018 - RedRiver_2017       -39.914    -65.91    -15.30
# DauphinRiver_2018 - RedRiver_2018       -27.792    -62.04      4.35
# DauphinRiver_2018 - SandyBar_2017       -18.527    -44.17      5.44
# DauphinRiver_2018 - SandyBar_2018         0.508    -32.72     31.13
# DauphinRiver_2018 - WinnipegRiver_2017   18.579    -17.06     45.92
# Matheson_2017 - Matheson_2018             8.569    -17.31     39.16
# Matheson_2017 - RedRiver_2017           -38.167    -66.07     -6.64
# Matheson_2017 - RedRiver_2018           -25.687    -64.51     12.53
# Matheson_2017 - SandyBar_2017           -16.765    -42.94     12.19
# Matheson_2017 - SandyBar_2018             2.561    -34.57     40.45
# Matheson_2017 - WinnipegRiver_2017       20.033    -18.15     55.99
# Matheson_2018 - RedRiver_2017           -47.010    -70.50    -23.65
# Matheson_2018 - RedRiver_2018           -35.102    -68.66     -3.55
# Matheson_2018 - SandyBar_2017           -25.566    -48.99     -2.34
# Matheson_2018 - SandyBar_2018            -6.759    -38.14     24.01
# Matheson_2018 - WinnipegRiver_2017       11.646    -22.13     38.31
# RedRiver_2017 - RedRiver_2018            12.156    -23.44     44.39
# RedRiver_2017 - SandyBar_2017            21.324     -3.94     47.13
# RedRiver_2017 - SandyBar_2018            40.431      6.86     72.27
# RedRiver_2017 - WinnipegRiver_2017       58.315     23.45     88.31
# RedRiver_2018 - SandyBar_2017             9.201    -25.37     46.72
# RedRiver_2018 - SandyBar_2018            28.527     -4.47     62.06
# RedRiver_2018 - WinnipegRiver_2017       45.813      4.82     84.23
# SandyBar_2017 - SandyBar_2018            18.992    -17.38     52.54
# SandyBar_2017 - WinnipegRiver_2017       36.851      1.63     66.29
# SandyBar_2018 - WinnipegRiver_2017       17.639    -22.15     55.23
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_ser, ~ Site_Year)) #### That's the one!!!!!!
test2_ser_yr_plot<- plot(emmeans(test2_ser, ~ Site_Year)) #### That's the one!!!!!!
test2_ser_yr_plot
ggsave("test2_ser_yr_plot.png")
plot(emmeans(test2_ser, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_ser, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_ser, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_ser, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_ser.rda")
ser_tets2_plot <- gather_emmeans_draws(emmeans(test2_ser, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("ser_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_ser, file = "test2_ser.RDA")
library(repmod)
library(report)


#### test 2 proline simple model ####
test2_pro<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Proline~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,150), class = b),
                          prior(normal(0,150), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_pro)
pp_check(test2_pro, ndraws = 100) +
  theme_bw()
summary(test2_pro)
emmeans(test2_pro, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   193.7     151.6     238.6
# DauphinRiver_2018   110.5      82.7     144.3
# Matheson_2017       138.7      62.3     245.5
# Matheson_2018        42.9      26.3      61.5
# RedRiver_2017       112.8      91.5     136.5
# RedRiver_2018        53.9      38.4      71.9
# SandyBar_2017       108.7      84.1     135.4
# SandyBar_2018        56.7      39.8      76.6
# WinnipegRiver_2017  152.4     121.8     191.8
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_pro, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     83.12     28.35    134.45
# DauphinRiver_2017 - Matheson_2017         54.02    -54.03    141.92
# DauphinRiver_2017 - Matheson_2018        150.51    106.12    193.57
# DauphinRiver_2017 - RedRiver_2017         80.64     35.43    124.35
# DauphinRiver_2017 - RedRiver_2018        139.41     97.92    181.21
# DauphinRiver_2017 - SandyBar_2017         84.58     38.01    130.40
# DauphinRiver_2017 - SandyBar_2018        136.65     93.56    179.10
# DauphinRiver_2017 - WinnipegRiver_2017    40.34    -12.13     93.00
# DauphinRiver_2018 - Matheson_2017        -28.04   -135.05     55.56
# DauphinRiver_2018 - Matheson_2018         67.33     38.03    102.63
# DauphinRiver_2018 - RedRiver_2017         -2.46    -34.93     35.35
# DauphinRiver_2018 - RedRiver_2018         55.84     27.84     90.77
# DauphinRiver_2018 - SandyBar_2017          1.43    -33.84     40.45
# DauphinRiver_2018 - SandyBar_2018         53.01     25.19     87.89
# DauphinRiver_2018 - WinnipegRiver_2017   -42.38    -85.65      4.45
# Matheson_2017 - Matheson_2018             95.60     16.05    199.50
# Matheson_2017 - RedRiver_2017             25.71    -49.63    134.07
# Matheson_2017 - RedRiver_2018             84.22      7.78    189.47
# Matheson_2017 - SandyBar_2017             29.78    -49.59    136.33
# Matheson_2017 - SandyBar_2018             81.48      6.53    188.60
# Matheson_2017 - WinnipegRiver_2017       -14.42    -99.29     96.13
# Matheson_2018 - RedRiver_2017            -69.86    -92.80    -47.71
# Matheson_2018 - RedRiver_2018            -11.26    -28.66      6.90
# Matheson_2018 - SandyBar_2017            -65.83    -91.94    -40.33
# Matheson_2018 - SandyBar_2018            -14.13    -33.01      5.48
# Matheson_2018 - WinnipegRiver_2017      -109.26   -147.86    -77.72
# RedRiver_2017 - RedRiver_2018             58.53     39.56     79.34
# RedRiver_2017 - SandyBar_2017              4.19    -23.74     31.40
# RedRiver_2017 - SandyBar_2018             55.85     35.08     77.32
# RedRiver_2017 - WinnipegRiver_2017       -39.62    -79.04     -5.78
# RedRiver_2018 - SandyBar_2017            -54.37    -79.00    -33.12
# RedRiver_2018 - SandyBar_2018             -2.61    -17.17     10.26
# RedRiver_2018 - WinnipegRiver_2017       -98.10   -135.87    -68.08
# SandyBar_2017 - SandyBar_2018             51.76     28.06     75.85
# SandyBar_2017 - WinnipegRiver_2017       -43.79    -83.70     -5.03
# SandyBar_2018 - WinnipegRiver_2017       -95.27   -135.16    -65.40
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_pro, ~ Site_Year)) #### That's the one!!!!!!
test2_pro_yr_plot<- plot(emmeans(test2_pro, ~ Site_Year)) #### That's the one!!!!!!
test2_pro_yr_plot
ggsave("test2_pro_yr_plot.png")
plot(emmeans(test2_pro, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_pro, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_pro, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_pro, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_pro.rda")
pro_tets2_plot <- gather_emmeans_draws(emmeans(test2_pro, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("pro_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_pro, file = "test2_pro.RDA")
library(repmod)
library(report)
report(test2_pro)

#### test 2 phenylalanine simple model ####
test2_phe<- brm(data=raw_dataf,
                family = student,
                bf(Phenylalanine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,75), class = b),
                          prior(normal(0,75), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_phe)
pp_check(test2_phe, ndraws = 100) +
  theme_bw()
summary(test2_phe)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Phenylalanine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           130.25     15.13    98.89   158.63 1.00    11386
# sigma_Intercept                       4.27      0.26     3.79     4.80 1.00    17736
# Site_YearDauphinRiver_2018          -43.44     15.90   -73.71   -11.12 1.00    11974
# Site_YearMatheson_2017              -40.61     19.91   -78.51    -0.22 1.00    16277
# Site_YearMatheson_2018              -79.56     15.39  -108.30   -47.65 1.00    11724
# Site_YearRedRiver_2017              -41.87     15.99   -71.76    -9.05 1.00    12666
# Site_YearRedRiver_2018              -46.69     17.22   -79.55   -11.67 1.00    13636
# Site_YearSandyBar_2017              -40.66     17.15   -72.98    -5.36 1.00    14503
# Site_YearSandyBar_2018              -65.40     15.76   -95.23   -33.14 1.00    12051
# Site_YearWinnipegRiver_2017         -47.46     15.28   -76.14   -15.91 1.00    11568
# SexM                                -28.56      6.48   -40.71   -15.18 1.00    38684
# SexUN                                -7.22      5.36   -18.70     2.52 1.00    41845
# sigma_Site_YearDauphinRiver_2018     -1.34      0.38    -2.08    -0.58 1.00    23717
# sigma_Site_YearMatheson_2017         -0.95      0.47    -1.77     0.06 1.00    29240
# sigma_Site_YearMatheson_2018         -1.91      0.34    -2.57    -1.25 1.00    22593
# sigma_Site_YearRedRiver_2017         -1.18      0.31    -1.79    -0.59 1.00    23132
# sigma_Site_YearRedRiver_2018         -0.84      0.32    -1.47    -0.21 1.00    25954
# sigma_Site_YearSandyBar_2017         -0.62      0.31    -1.24    -0.03 1.00    22023
# sigma_Site_YearSandyBar_2018         -1.48      0.32    -2.11    -0.84 1.00    25540
# sigma_Site_YearWinnipegRiver_2017    -3.17      0.55    -4.12    -1.95 1.00    26130
# sigma_SexM                           -0.26      0.24    -0.74     0.19 1.00    34879
# sigma_SexUN                          -0.40      0.42    -1.21     0.44 1.00    39369
# Tail_ESS
# Intercept                            16881
# sigma_Intercept                      22128
# Site_YearDauphinRiver_2018           18890
# Site_YearMatheson_2017               24824
# Site_YearMatheson_2018               17388
# Site_YearRedRiver_2017               19550
# Site_YearRedRiver_2018               21915
# Site_YearSandyBar_2017               22545
# Site_YearSandyBar_2018               17982
# Site_YearWinnipegRiver_2017          17340
# SexM                                 36473
# SexUN                                36921
# sigma_Site_YearDauphinRiver_2018     32272
# sigma_Site_YearMatheson_2017         30933
# sigma_Site_YearMatheson_2018         29837
# sigma_Site_YearRedRiver_2017         30242
# sigma_Site_YearRedRiver_2018         33047
# sigma_Site_YearSandyBar_2017         29070
# sigma_Site_YearSandyBar_2018         34856
# sigma_Site_YearWinnipegRiver_2017    27947
# sigma_SexM                           38455
# sigma_SexUN                          40520
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    19.33     12.87     4.51    52.77 1.00    38513    36588
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_phe, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   118.8      88.0     147.6
# DauphinRiver_2018    74.9      65.5      84.2
# Matheson_2017        77.4      50.8     104.6
# Matheson_2018        38.9      31.1      46.1
# RedRiver_2017        76.4      63.6      89.9
# RedRiver_2018        71.4      55.0      87.9
# SandyBar_2017        77.8      58.8      96.0
# SandyBar_2018        53.0      44.0      61.6
# WinnipegRiver_2017   70.8      63.5      78.3
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_phe, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    43.831    11.757     74.21
# DauphinRiver_2017 - Matheson_2017        41.063     0.975     79.05
# DauphinRiver_2017 - Matheson_2018        80.022    48.857    109.41
# DauphinRiver_2017 - RedRiver_2017        42.387     9.622     72.32
# DauphinRiver_2017 - RedRiver_2018        47.064    12.461     80.15
# DauphinRiver_2017 - SandyBar_2017        41.091     7.345     74.80
# DauphinRiver_2017 - SandyBar_2018        65.770    33.639     95.69
# DauphinRiver_2017 - WinnipegRiver_2017   47.878    16.206     76.38
# DauphinRiver_2018 - Matheson_2017        -2.548   -30.930     26.23
# DauphinRiver_2018 - Matheson_2018        35.976    25.101     48.21
# DauphinRiver_2018 - RedRiver_2017        -1.553   -17.203     14.88
# DauphinRiver_2018 - RedRiver_2018         3.416   -16.814     22.15
# DauphinRiver_2018 - SandyBar_2017        -2.798   -23.486     18.33
# DauphinRiver_2018 - SandyBar_2018        21.895     8.754     35.42
# DauphinRiver_2018 - WinnipegRiver_2017    4.099    -7.842     15.56
# Matheson_2017 - Matheson_2018            38.721    11.298     67.10
# Matheson_2017 - RedRiver_2017             1.017   -28.606     30.62
# Matheson_2017 - RedRiver_2018             5.980   -24.180     37.24
# Matheson_2017 - SandyBar_2017            -0.195   -32.704     31.50
# Matheson_2017 - SandyBar_2018            24.583    -2.909     52.57
# Matheson_2017 - WinnipegRiver_2017        6.648   -20.733     34.69
# Matheson_2018 - RedRiver_2017           -37.587   -51.187    -24.61
# Matheson_2018 - RedRiver_2018           -32.827   -51.293    -13.83
# Matheson_2018 - SandyBar_2017           -38.844   -58.502    -19.95
# Matheson_2018 - SandyBar_2018           -14.298   -26.468     -1.89
# Matheson_2018 - WinnipegRiver_2017      -32.142   -39.445    -24.55
# RedRiver_2017 - RedRiver_2018             4.843   -16.427     27.49
# RedRiver_2017 - SandyBar_2017            -1.120   -22.554     19.18
# RedRiver_2017 - SandyBar_2018            23.403     7.235     40.11
# RedRiver_2017 - WinnipegRiver_2017        5.437    -7.222     18.15
# RedRiver_2018 - SandyBar_2017            -6.184   -30.628     19.41
# RedRiver_2018 - SandyBar_2018            18.525     2.186     36.06
# RedRiver_2018 - WinnipegRiver_2017        0.774   -17.947     19.21
# SandyBar_2017 - SandyBar_2018            24.828     4.022     45.15
# SandyBar_2017 - WinnipegRiver_2017        6.766   -12.742     25.06
# SandyBar_2018 - WinnipegRiver_2017      -17.682   -30.334     -6.11
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_phe, ~ Site_Year)) #### That's the one!!!!!!
test2_phe_yr_plot<- plot(emmeans(test2_phe, ~ Site_Year)) #### That's the one!!!!!!
test2_phe_yr_plot
ggsave("test2_phe_yr_plot.png")
plot(emmeans(test2_phe, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_phe, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_phe, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_phe, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_phe.rda")
phe_tets2_plot <- gather_emmeans_draws(emmeans(test2_phe, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("phe_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_pro, file = "test2_pro.RDA")
library(repmod)
library(report)
report(test2_phe)

#### test 2 methionine simple model ####
test2_met<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Methionine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,75), class = b),
                          prior(normal(0,75), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_met)
pp_check(test2_met, ndraws = 100) +
  theme_bw()
summary(test2_met)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Methionine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           104.42      7.91    89.13   120.31 1.00    13039
# sigma_Intercept                       3.86      0.18     3.53     4.23 1.00    20351
# Site_YearDauphinRiver_2018          -66.63      8.69   -84.00   -49.76 1.00    15651
# Site_YearMatheson_2017              -29.90     15.27   -56.79     4.08 1.00    22349
# Site_YearMatheson_2018              -80.58      8.25   -97.12   -64.58 1.00    13769
# Site_YearRedRiver_2017              -30.38      8.40   -46.98   -13.73 1.00    15290
# Site_YearRedRiver_2018              -69.22      8.35   -84.97   -51.75 1.00    14357
# Site_YearSandyBar_2017              -43.68      8.65   -60.72   -26.54 1.00    16592
# Site_YearSandyBar_2018              -74.57      8.20   -90.22   -57.59 1.00    14055
# Site_YearWinnipegRiver_2017         -50.33     12.74   -72.06   -22.38 1.00    16889
# SexM                                -16.97      4.45   -25.42    -8.24 1.00    28088
# SexUN                                -2.69      4.68   -11.97     6.50 1.00    40899
# sigma_Site_YearDauphinRiver_2018     -1.01      0.30    -1.57    -0.40 1.00    29419
# sigma_Site_YearMatheson_2017         -0.04      0.46    -0.84     0.97 1.00    28362
# sigma_Site_YearMatheson_2018         -1.75      0.29    -2.31    -1.16 1.00    26602
# sigma_Site_YearRedRiver_2017         -0.95      0.26    -1.46    -0.46 1.00    26079
# sigma_Site_YearRedRiver_2018         -0.90      0.29    -1.46    -0.31 1.00    27015
# sigma_Site_YearSandyBar_2017         -0.55      0.24    -1.03    -0.09 1.00    27285
# sigma_Site_YearSandyBar_2018         -0.97      0.29    -1.51    -0.37 1.00    26638
# sigma_Site_YearWinnipegRiver_2017    -1.25      0.54    -2.14    -0.02 1.00    22825
# sigma_SexM                           -0.87      0.23    -1.29    -0.40 1.00    32915
# sigma_SexUN                          -0.31      0.37    -1.03     0.41 1.00    37865
# Tail_ESS
# Intercept                            18326
# sigma_Intercept                      26927
# Site_YearDauphinRiver_2018           22273
# Site_YearMatheson_2017               24194
# Site_YearMatheson_2018               19782
# Site_YearRedRiver_2017               22000
# Site_YearRedRiver_2018               22752
# Site_YearSandyBar_2017               24612
# Site_YearSandyBar_2018               22008
# Site_YearWinnipegRiver_2017          20809
# SexM                                 40371
# SexUN                                36731
# sigma_Site_YearDauphinRiver_2018     36743
# sigma_Site_YearMatheson_2017         28406
# sigma_Site_YearMatheson_2018         36206
# sigma_Site_YearRedRiver_2017         32144
# sigma_Site_YearRedRiver_2018         36245
# sigma_Site_YearSandyBar_2017         31902
# sigma_Site_YearSandyBar_2018         37403
# sigma_Site_YearWinnipegRiver_2017    20668
# sigma_SexM                           36549
# sigma_SexUN                          39416
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.79      1.92     1.79     9.23 1.00    29544    31680
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_met, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    97.8      82.6     112.8
# DauphinRiver_2018    31.0      22.9      39.6
# Matheson_2017        66.5      41.8      96.6
# Matheson_2018        17.2      11.8      22.9
# RedRiver_2017        67.3      58.8      76.4
# RedRiver_2018        28.6      20.6      36.3
# SandyBar_2017        53.9      44.1      64.6
# SandyBar_2018        23.3      16.1      30.8
# WinnipegRiver_2017   46.1      29.9      68.9
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_met, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    66.530    49.698    83.920
# DauphinRiver_2017 - Matheson_2017        31.069    -1.861    58.494
# DauphinRiver_2017 - Matheson_2018        80.514    64.291    96.774
# DauphinRiver_2017 - RedRiver_2017        30.393    14.059    47.290
# DauphinRiver_2017 - RedRiver_2018        69.543    52.621    85.710
# DauphinRiver_2017 - SandyBar_2017        43.690    26.648    60.796
# DauphinRiver_2017 - SandyBar_2018        74.870    57.735    90.297
# DauphinRiver_2017 - WinnipegRiver_2017   51.229    24.810    73.607
# DauphinRiver_2018 - Matheson_2017       -35.384   -67.292    -9.773
# DauphinRiver_2018 - Matheson_2018        13.780     4.326    24.077
# DauphinRiver_2018 - RedRiver_2017       -36.143   -48.432   -24.419
# DauphinRiver_2018 - RedRiver_2018         2.589    -9.576    14.330
# DauphinRiver_2018 - SandyBar_2017       -22.739   -36.236    -9.859
# DauphinRiver_2018 - SandyBar_2018         7.916    -3.668    19.614
# DauphinRiver_2018 - WinnipegRiver_2017  -15.184   -38.512     3.710
# Matheson_2017 - Matheson_2018            49.356    23.902    80.295
# Matheson_2017 - RedRiver_2017            -0.897   -26.028    30.596
# Matheson_2017 - RedRiver_2018            37.907    12.696    68.309
# Matheson_2017 - SandyBar_2017            12.418   -13.774    43.385
# Matheson_2017 - SandyBar_2018            43.195    18.796    73.952
# Matheson_2017 - WinnipegRiver_2017       20.056   -14.516    55.506
# Matheson_2018 - RedRiver_2017           -50.000   -60.520   -40.007
# Matheson_2018 - RedRiver_2018           -11.442   -21.797    -0.812
# Matheson_2018 - SandyBar_2017           -36.657   -48.858   -24.865
# Matheson_2018 - SandyBar_2018            -6.064   -16.454     4.094
# Matheson_2018 - WinnipegRiver_2017      -28.891   -51.775   -12.285
# RedRiver_2017 - RedRiver_2018            39.030    27.527    49.520
# RedRiver_2017 - SandyBar_2017            13.440     0.911    26.032
# RedRiver_2017 - SandyBar_2018            44.404    33.322    54.775
# RedRiver_2017 - WinnipegRiver_2017       21.048    -2.281    39.909
# RedRiver_2018 - SandyBar_2017           -25.797   -37.386   -13.700
# RedRiver_2018 - SandyBar_2018             5.284    -1.719    12.997
# RedRiver_2018 - WinnipegRiver_2017      -17.706   -41.401     0.158
# SandyBar_2017 - SandyBar_2018            31.125    19.314    42.286
# SandyBar_2017 - WinnipegRiver_2017        7.591   -16.291    27.695
# SandyBar_2018 - WinnipegRiver_2017      -23.041   -46.707    -5.232
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_met, ~ Site_Year)) #### That's the one!!!!!!
test2_met_yr_plot<- plot(emmeans(test2_met, ~ Site_Year)) #### That's the one!!!!!!
test2_met_yr_plot
ggsave("test2_met_yr_plot.png")
plot(emmeans(test2_met, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_met, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_met, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_met, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_met.rda")
met_tets2_plot <- gather_emmeans_draws(emmeans(test2_met, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("met_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_met, file = "test2_met.RDA")
library(repmod)
library(report)
report(test2_met)


#### test 2 Lysine simple model ####
test2_lys<- brm(data=raw_dataf,
                family = student,
                bf(Lysine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,170), class = b),
                          prior(normal(0,170), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_lys)
pp_check(test2_lys, ndraws = 100) +
  theme_bw()
summary(test2_lys)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Lysine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           241.02     25.04   190.24   289.16 1.00    11271
# sigma_Intercept                       4.74      0.27     4.21     5.27 1.00    17687
# Site_YearDauphinRiver_2018         -224.79     25.11  -273.02  -173.71 1.00    11391
# Site_YearMatheson_2017              -68.50     39.72  -142.36    17.67 1.00    19557
# Site_YearMatheson_2018             -212.72     25.28  -261.28  -161.35 1.00    11503
# Site_YearRedRiver_2017              -66.62     26.99  -118.90   -12.17 1.00    12434
# Site_YearRedRiver_2018             -192.09     26.33  -243.03  -139.19 1.00    11687
# Site_YearSandyBar_2017              -42.99     29.59   -99.68    17.39 1.00    14871
# Site_YearSandyBar_2018             -194.29     25.95  -244.77  -142.14 1.00    11518
# Site_YearWinnipegRiver_2017          -6.57     65.38  -136.19   126.67 1.00    29377
# SexM                                -33.15     10.71   -51.65   -11.82 1.00    18304
# SexUN                               -12.38      3.76   -19.94    -5.00 1.00    48959
# sigma_Site_YearDauphinRiver_2018     -2.42      0.38    -3.17    -1.67 1.00    21814
# sigma_Site_YearMatheson_2017         -0.62      0.64    -2.06     0.56 1.00    17896
# sigma_Site_YearMatheson_2018         -1.97      0.36    -2.68    -1.27 1.00    23006
# sigma_Site_YearRedRiver_2017         -1.03      0.33    -1.68    -0.40 1.00    22881
# sigma_Site_YearRedRiver_2018         -1.36      0.33    -2.02    -0.71 1.00    25651
# sigma_Site_YearSandyBar_2017         -0.46      0.32    -1.09     0.15 1.00    22043
# sigma_Site_YearSandyBar_2018         -1.45      0.38    -2.25    -0.73 1.00    18288
# sigma_Site_YearWinnipegRiver_2017    -0.09      0.56    -1.11     1.10 1.00    28948
# sigma_SexM                           -0.46      0.26    -1.00     0.02 1.00    25945
# sigma_SexUN                          -1.15      0.42    -2.02    -0.34 1.00    25949
# Tail_ESS
# Intercept                            16609
# sigma_Intercept                      21163
# Site_YearDauphinRiver_2018           16537
# Site_YearMatheson_2017               25970
# Site_YearMatheson_2018               16476
# Site_YearRedRiver_2017               18374
# Site_YearRedRiver_2018               17484
# Site_YearSandyBar_2017               22962
# Site_YearSandyBar_2018               16911
# Site_YearWinnipegRiver_2017          30431
# SexM                                 34024
# SexUN                                37447
# sigma_Site_YearDauphinRiver_2018     30251
# sigma_Site_YearMatheson_2017         22831
# sigma_Site_YearMatheson_2018         31008
# sigma_Site_YearRedRiver_2017         29778
# sigma_Site_YearRedRiver_2018         32191
# sigma_Site_YearSandyBar_2017         30725
# sigma_Site_YearSandyBar_2018         22914
# sigma_Site_YearWinnipegRiver_2017    33229
# sigma_SexM                           27797
# sigma_SexUN                          19004
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    13.14     12.33     1.97    46.39 1.00    11437    16204
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_lys, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017  226.26    175.74    274.46
# DauphinRiver_2018    1.02     -6.36      8.73
# Matheson_2017      153.12     98.34    228.47
# Matheson_2018       13.21      2.35     23.36
# RedRiver_2017      159.18    138.18    180.63
# RedRiver_2018       33.82     17.40     48.78
# SandyBar_2017      182.41    148.82    216.34
# SandyBar_2018       31.54     17.68     44.29
# WinnipegRiver_2017 217.98     91.04    342.77
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_lys, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    225.21     176.1   275.157
# DauphinRiver_2017 - Matheson_2017         70.35     -13.5   145.238
# DauphinRiver_2017 - Matheson_2018        213.21     162.9   262.467
# DauphinRiver_2017 - RedRiver_2017         66.90      12.4   119.099
# DauphinRiver_2017 - RedRiver_2018        192.37     141.0   244.613
# DauphinRiver_2017 - SandyBar_2017         43.67     -15.1   101.768
# DauphinRiver_2017 - SandyBar_2018        194.57     142.6   245.100
# DauphinRiver_2017 - WinnipegRiver_2017     7.56    -125.9   136.881
# DauphinRiver_2018 - Matheson_2017       -152.98    -227.0   -95.153
# DauphinRiver_2018 - Matheson_2018        -11.96     -21.4    -3.006
# DauphinRiver_2018 - RedRiver_2017       -158.12    -179.6  -135.140
# DauphinRiver_2018 - RedRiver_2018        -33.15     -52.2   -12.447
# DauphinRiver_2018 - SandyBar_2017       -181.41    -216.4  -148.064
# DauphinRiver_2018 - SandyBar_2018        -31.37     -45.7   -11.802
# DauphinRiver_2018 - WinnipegRiver_2017  -217.03    -342.3   -90.967
# Matheson_2017 - Matheson_2018            141.13      83.3   215.475
# Matheson_2017 - RedRiver_2017             -5.30     -66.2    69.754
# Matheson_2017 - RedRiver_2018            119.81      63.5   194.604
# Matheson_2017 - SandyBar_2017            -27.39     -94.8    48.494
# Matheson_2017 - SandyBar_2018            121.87      66.0   195.888
# Matheson_2017 - WinnipegRiver_2017       -61.69    -202.4    78.693
# Matheson_2018 - RedRiver_2017           -146.06    -168.9  -123.159
# Matheson_2018 - RedRiver_2018            -21.04     -40.8     1.009
# Matheson_2018 - SandyBar_2017           -169.32    -204.1  -134.905
# Matheson_2018 - SandyBar_2018            -19.13     -35.1     0.757
# Matheson_2018 - WinnipegRiver_2017      -204.84    -333.0   -81.935
# RedRiver_2017 - RedRiver_2018            125.54      98.8   152.316
# RedRiver_2017 - SandyBar_2017            -23.25     -63.1    16.132
# RedRiver_2017 - SandyBar_2018            127.64     102.6   152.986
# RedRiver_2017 - WinnipegRiver_2017       -58.80    -187.6    66.882
# RedRiver_2018 - SandyBar_2017           -148.83    -185.5  -112.115
# RedRiver_2018 - SandyBar_2018              2.32     -15.7    19.544
# RedRiver_2018 - WinnipegRiver_2017      -184.18    -317.2   -63.015
# SandyBar_2017 - SandyBar_2018            151.00     115.9   186.899
# SandyBar_2017 - WinnipegRiver_2017       -35.39    -167.8    90.799
# SandyBar_2018 - WinnipegRiver_2017      -186.46    -315.9   -63.222
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_lys, ~ Site_Year)) #### That's the one!!!!!!
test2_lys_yr_plot<- plot(emmeans(test2_lys, ~ Site_Year)) #### That's the one!!!!!!
test2_lys_yr_plot
ggsave("test2_lys_yr_plot.png")
plot(emmeans(test2_lys, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_lys, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_lys, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_lys, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_lys.rda")
lys_tets2_plot <- gather_emmeans_draws(emmeans(test2_lys, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("lys_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_met, file = "test2_met.RDA")
library(repmod)
library(report)
report(test2_lys)

#### test 2 Leucine simple model ####
test2_leu<- brm(data=raw_dataf,
                family = student,
                bf(Leucine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,300), class = b),
                          prior(normal(0,300), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_leu)
pp_check(test2_leu, ndraws = 100) +
  theme_bw()
summary(test2_leu)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Leucine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           393.90     46.45   298.57   480.97 1.00    12903
# sigma_Intercept                       5.38      0.26     4.89     5.92 1.00    22030
# Site_YearDauphinRiver_2018         -233.38     50.61  -329.06  -130.16 1.00    14693
# Site_YearMatheson_2017             -116.77     82.59  -273.53    49.53 1.00    23970
# Site_YearMatheson_2018             -284.75     47.11  -373.17  -187.56 1.00    13199
# Site_YearRedRiver_2017             -220.90     48.04  -311.59  -122.59 1.00    14335
# Site_YearRedRiver_2018             -263.13     47.79  -353.84  -164.90 1.00    14354
# Site_YearSandyBar_2017             -176.95     51.37  -274.96   -71.40 1.00    16416
# Site_YearSandyBar_2018             -255.23     49.26  -348.53  -154.20 1.00    14601
# Site_YearWinnipegRiver_2017        -170.01     48.96  -262.42   -70.44 1.00    13834
# SexM                                -72.36     21.34  -113.01   -29.07 1.00    34914
# SexUN                               -18.46     13.80   -45.24     9.95 1.00    43441
# sigma_Site_YearDauphinRiver_2018     -0.61      0.44    -1.50     0.25 1.00    25730
# sigma_Site_YearMatheson_2017         -0.26      0.47    -1.11     0.74 1.00    32725
# sigma_Site_YearMatheson_2018         -1.94      0.33    -2.59    -1.28 1.00    26933
# sigma_Site_YearRedRiver_2017         -1.30      0.32    -1.94    -0.67 1.00    27326
# sigma_Site_YearRedRiver_2018         -1.25      0.34    -1.94    -0.58 1.00    28331
# sigma_Site_YearSandyBar_2017         -0.63      0.32    -1.27    -0.01 1.00    26556
# sigma_Site_YearSandyBar_2018         -1.00      0.33    -1.65    -0.34 1.00    30054
# sigma_Site_YearWinnipegRiver_2017    -2.36      0.57    -3.36    -1.10 1.00    29007
# sigma_SexM                           -0.54      0.26    -1.05    -0.03 1.00    35333
# sigma_SexUN                          -0.91      0.48    -1.83     0.06 1.00    30631
# Tail_ESS
# Intercept                            18124
# sigma_Intercept                      28150
# Site_YearDauphinRiver_2018           21330
# Site_YearMatheson_2017               28614
# Site_YearMatheson_2018               18445
# Site_YearRedRiver_2017               20496
# Site_YearRedRiver_2018               21041
# Site_YearSandyBar_2017               23475
# Site_YearSandyBar_2018               21283
# Site_YearWinnipegRiver_2017          19944
# SexM                                 35219
# SexUN                                33545
# sigma_Site_YearDauphinRiver_2018     35469
# sigma_Site_YearMatheson_2017         31473
# sigma_Site_YearMatheson_2018         34883
# sigma_Site_YearRedRiver_2017         33878
# sigma_Site_YearRedRiver_2018         35358
# sigma_Site_YearSandyBar_2017         34829
# sigma_Site_YearSandyBar_2018         36717
# sigma_Site_YearWinnipegRiver_2017    28412
# sigma_SexM                           39677
# sigma_SexUN                          34691
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    11.98     10.23     2.78    40.32 1.00    26390    37311
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_leu, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   365.0     274.2     453.1
# DauphinRiver_2018   130.1      89.1     172.2
# Matheson_2017       245.5     110.4     387.7
# Matheson_2018        78.7      59.3      99.3
# RedRiver_2017       143.0     104.4     179.6
# RedRiver_2018       100.4      67.4     133.0
# SandyBar_2017       186.1     133.3     241.3
# SandyBar_2018       108.4      71.7     146.2
# WinnipegRiver_2017  193.5     159.9     227.1
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_leu, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    234.91    133.00    331.84
# DauphinRiver_2017 - Matheson_2017        118.51    -43.13    278.92
# DauphinRiver_2017 - Matheson_2018        286.23    192.86    377.77
# DauphinRiver_2017 - RedRiver_2017        222.05    126.90    315.20
# DauphinRiver_2017 - RedRiver_2018        264.22    168.42    356.96
# DauphinRiver_2017 - SandyBar_2017        178.33     77.50    279.99
# DauphinRiver_2017 - SandyBar_2018        256.58    155.71    349.75
# DauphinRiver_2017 - WinnipegRiver_2017   171.48     71.63    263.29
# DauphinRiver_2018 - Matheson_2017       -115.48   -264.10     25.98
# DauphinRiver_2018 - Matheson_2018         51.56      7.09     93.17
# DauphinRiver_2018 - RedRiver_2017        -12.57    -68.20     43.77
# DauphinRiver_2018 - RedRiver_2018         29.54    -25.05     86.62
# DauphinRiver_2018 - SandyBar_2017        -56.15   -124.68     14.14
# DauphinRiver_2018 - SandyBar_2018         21.96    -35.29     78.54
# DauphinRiver_2018 - WinnipegRiver_2017   -63.39   -116.89    -10.93
# Matheson_2017 - Matheson_2018            166.69     28.84    311.13
# Matheson_2017 - RedRiver_2017            102.82    -39.76    247.58
# Matheson_2017 - RedRiver_2018            145.09      8.07    289.55
# Matheson_2017 - SandyBar_2017             58.97    -91.47    205.34
# Matheson_2017 - SandyBar_2018            137.43     -2.47    280.40
# Matheson_2017 - WinnipegRiver_2017        52.13    -88.09    198.69
# Matheson_2018 - RedRiver_2017            -63.39   -105.00    -24.59
# Matheson_2018 - RedRiver_2018            -21.87    -64.48     23.64
# Matheson_2018 - SandyBar_2017           -107.17   -167.04    -49.76
# Matheson_2018 - SandyBar_2018            -30.24    -74.72     17.27
# Matheson_2018 - WinnipegRiver_2017      -114.64   -149.35    -80.68
# RedRiver_2017 - RedRiver_2018             42.49     -7.87     94.30
# RedRiver_2017 - SandyBar_2017            -42.77   -105.67     17.87
# RedRiver_2017 - SandyBar_2018             34.37    -22.07     91.57
# RedRiver_2017 - WinnipegRiver_2017       -51.46    -95.93     -4.92
# RedRiver_2018 - SandyBar_2017            -86.08   -146.22    -26.08
# RedRiver_2018 - SandyBar_2018             -7.41    -50.41     34.29
# RedRiver_2018 - WinnipegRiver_2017       -92.83   -144.14    -42.25
# SandyBar_2017 - SandyBar_2018             78.94     11.96    142.46
# SandyBar_2017 - WinnipegRiver_2017        -7.79    -69.68     58.09
# SandyBar_2018 - WinnipegRiver_2017       -84.57   -138.52    -31.14
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_leu, ~ Site_Year)) #### That's the one!!!!!!
test2_leu_yr_plot<- plot(emmeans(test2_leu, ~ Site_Year)) #### That's the one!!!!!!
test2_leu_yr_plot
ggsave("test2_leu_yr_plot.png")
plot(emmeans(test2_leu, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_leu, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_leu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_leu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_leu.rda")
leu_tets2_plot <- gather_emmeans_draws(emmeans(test2_leu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("leu_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_leu, file = "test2_leu.RDA")

library(repmod)
library(report)
report(test2_leu)

#### test 2 Isoleucine simple model ####
test2_ile<- brm(data=raw_dataf,
                family = student,
                bf(Isoleucine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,200), class = b),
                          prior(normal(0,200), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_ile)
pp_check(test2_ile, ndraws = 100) +
  theme_bw()
summary(test2_ile)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Isoleucine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           234.59     36.96   159.76   304.81 1.00    11944
# sigma_Intercept                       5.11      0.27     4.61     5.65 1.00    22469
# Site_YearDauphinRiver_2018          -76.97     43.30  -160.07    10.38 1.00    15340
# Site_YearMatheson_2017              -68.53     59.49  -182.91    53.23 1.00    21991
# Site_YearMatheson_2018             -164.08     37.23  -234.89   -89.04 1.00    12116
# Site_YearRedRiver_2017             -132.10     37.59  -203.89   -55.67 1.00    12702
# Site_YearRedRiver_2018             -142.82     37.08  -213.44   -67.53 1.00    12419
# Site_YearSandyBar_2017             -111.06     39.30  -186.27   -31.33 1.00    14215
# Site_YearSandyBar_2018             -140.33     37.11  -211.40   -65.08 1.00    12326
# Site_YearWinnipegRiver_2017        -139.52     38.66  -213.36   -61.50 1.00    12609
# SexM                                -48.67     10.06   -67.52   -27.92 1.00    35179
# SexUN                               -11.38     15.75   -40.52    23.31 1.00    38079
# sigma_Site_YearDauphinRiver_2018     -0.81      0.40    -1.59    -0.02 1.00    27278
# sigma_Site_YearMatheson_2017         -0.47      0.49    -1.36     0.56 1.00    32980
# sigma_Site_YearMatheson_2018         -2.26      0.34    -2.93    -1.59 1.00    28027
# sigma_Site_YearRedRiver_2017         -1.56      0.31    -2.19    -0.95 1.00    28561
# sigma_Site_YearRedRiver_2018         -1.82      0.34    -2.49    -1.16 1.00    28040
# sigma_Site_YearSandyBar_2017         -0.88      0.34    -1.58    -0.25 1.00    26105
# sigma_Site_YearSandyBar_2018         -2.00      0.34    -2.66    -1.31 1.00    29673
# sigma_Site_YearWinnipegRiver_2017    -2.36      0.57    -3.36    -1.08 1.00    28755
# sigma_SexM                           -0.35      0.24    -0.83     0.13 1.00    38941
# sigma_SexUN                           0.11      0.47    -0.82     1.04 1.00    32296
# Tail_ESS
# Intercept                            17144
# sigma_Intercept                      27246
# Site_YearDauphinRiver_2018           22966
# Site_YearMatheson_2017               28655
# Site_YearMatheson_2018               17517
# Site_YearRedRiver_2017               18475
# Site_YearRedRiver_2018               17909
# Site_YearSandyBar_2017               20950
# Site_YearSandyBar_2018               17666
# Site_YearWinnipegRiver_2017          18725
# SexM                                 37318
# SexUN                                27635
# sigma_Site_YearDauphinRiver_2018     35220
# sigma_Site_YearMatheson_2017         31569
# sigma_Site_YearMatheson_2018         34622
# sigma_Site_YearRedRiver_2017         35922
# sigma_Site_YearRedRiver_2018         35587
# sigma_Site_YearSandyBar_2017         35044
# sigma_Site_YearSandyBar_2018         37441
# sigma_Site_YearWinnipegRiver_2017    25764
# sigma_SexM                           37786
# sigma_SexUN                          37015
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    10.56      9.52     2.50    37.43 1.00    25034    41632
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_ile, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   215.2     140.9     286.0
# DauphinRiver_2018   136.6      91.9     185.1
# Matheson_2017       144.7      47.7     243.2
# Matheson_2018        50.4      35.7      65.5
# RedRiver_2017        82.3      58.1     106.4
# RedRiver_2018        71.4      54.3      90.1
# SandyBar_2017       102.7      66.8     140.1
# SandyBar_2018        74.0      58.0      90.8
# WinnipegRiver_2017   74.8      49.3     100.8
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_ile, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    77.951    -9.644   160.561
# DauphinRiver_2017 - Matheson_2017        69.737   -50.357   185.118
# DauphinRiver_2017 - Matheson_2018       164.830    89.910   235.481
# DauphinRiver_2017 - RedRiver_2017       132.975    57.765   205.484
# DauphinRiver_2017 - RedRiver_2018       143.567    70.137   215.789
# DauphinRiver_2017 - SandyBar_2017       112.016    32.002   186.783
# DauphinRiver_2017 - SandyBar_2018       141.045    65.977   212.098
# DauphinRiver_2017 - WinnipegRiver_2017  140.471    63.674   215.372
# DauphinRiver_2018 - Matheson_2017        -7.639  -116.195    99.361
# DauphinRiver_2018 - Matheson_2018        86.261    40.044   135.935
# DauphinRiver_2018 - RedRiver_2017        54.255     4.065   108.566
# DauphinRiver_2018 - RedRiver_2018        64.619    17.329   117.999
# DauphinRiver_2018 - SandyBar_2017        33.392   -23.303    94.970
# DauphinRiver_2018 - SandyBar_2018        62.145    14.388   113.771
# DauphinRiver_2018 - WinnipegRiver_2017   61.737    10.484   116.620
# Matheson_2017 - Matheson_2018            94.217     0.194   197.286
# Matheson_2017 - RedRiver_2017            62.090   -35.833   163.179
# Matheson_2017 - RedRiver_2018            73.025   -21.776   173.691
# Matheson_2017 - SandyBar_2017            41.239   -62.711   142.742
# Matheson_2017 - SandyBar_2018            70.355   -24.657   170.429
# Matheson_2017 - WinnipegRiver_2017       69.730   -28.535   171.886
# Matheson_2018 - RedRiver_2017           -31.714   -56.479    -9.027
# Matheson_2018 - RedRiver_2018           -21.180   -42.956     0.845
# Matheson_2018 - SandyBar_2017           -52.181   -91.077   -15.853
# Matheson_2018 - SandyBar_2018           -24.022   -44.736    -3.158
# Matheson_2018 - WinnipegRiver_2017      -24.344   -49.243     0.278
# RedRiver_2017 - RedRiver_2018            10.756   -16.691    37.362
# RedRiver_2017 - SandyBar_2017           -20.212   -60.169    18.325
# RedRiver_2017 - SandyBar_2018             7.970   -18.675    35.789
# RedRiver_2017 - WinnipegRiver_2017        7.309   -22.732    38.043
# RedRiver_2018 - SandyBar_2017           -31.181   -68.980     4.927
# RedRiver_2018 - SandyBar_2018            -2.374   -20.125    15.140
# RedRiver_2018 - WinnipegRiver_2017       -3.217   -32.376    26.475
# SandyBar_2017 - SandyBar_2018            28.962    -7.150    66.948
# SandyBar_2017 - WinnipegRiver_2017       27.862   -13.481    72.291
# SandyBar_2018 - WinnipegRiver_2017       -0.425   -29.770    27.242
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_ile, ~ Site_Year)) #### That's the one!!!!!!
test2_ile_yr_plot<- plot(emmeans(test2_ile, ~ Site_Year)) #### That's the one!!!!!!
test2_ile_yr_plot
ggsave("test2_ile_yr_plot.png")
plot(emmeans(test2_ile, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_ile, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_ile, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_ile, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_lys.rda")
ile_tets2_plot <- gather_emmeans_draws(emmeans(test2_ile, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("ile_tets2_plot.png")
ile_tets2_plot
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_ile, file = "test2_ile.RDA")

library(repmod)
library(report)
report(test2_ile)

#### test 2 Histidine simple model ####
test2_his<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Histidine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,80), class = b),
                          prior(normal(0,80), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_his)
pp_check(test2_his, ndraws = 100) +
  theme_bw()

summary(test2_his)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Histidine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                            96.44      7.77    81.91   112.58 1.00    12372
# sigma_Intercept                       3.71      0.20     3.33     4.13 1.00    15034
# Site_YearDauphinRiver_2018          -35.78      9.79   -55.51   -16.85 1.00    16665
# Site_YearMatheson_2017              -26.38     13.56   -50.34     2.21 1.00    19725
# Site_YearMatheson_2018              -43.51      9.20   -61.94   -25.53 1.00    14774
# Site_YearRedRiver_2017              -27.88      9.10   -46.06   -10.12 1.00    16210
# Site_YearRedRiver_2018              -41.05      8.30   -57.52   -24.70 1.00    14854
# Site_YearSandyBar_2017              -28.14      8.42   -45.38   -12.06 1.00    16220
# Site_YearSandyBar_2018              -59.67      7.96   -75.82   -44.10 1.00    13850
# Site_YearWinnipegRiver_2017          -9.75     23.95   -50.15    45.85 1.00    25478
# SexM                                -13.42      4.46   -21.86    -4.35 1.00    35746
# SexUN                                -8.00      8.27   -23.24     9.30 1.00    42146
# sigma_Site_YearDauphinRiver_2018     -0.60      0.33    -1.22     0.09 1.00    23862
# sigma_Site_YearMatheson_2017         -0.39      0.44    -1.16     0.56 1.00    23797
# sigma_Site_YearMatheson_2018         -0.77      0.29    -1.33    -0.20 1.00    20442
# sigma_Site_YearRedRiver_2017         -0.53      0.27    -1.05     0.00 1.00    21277
# sigma_Site_YearRedRiver_2018         -0.56      0.27    -1.08    -0.01 1.00    24343
# sigma_Site_YearSandyBar_2017         -0.57      0.25    -1.06    -0.08 1.00    23519
# sigma_Site_YearSandyBar_2018         -0.88      0.30    -1.44    -0.28 1.00    21245
# sigma_Site_YearWinnipegRiver_2017    -0.08      0.50    -0.95     1.02 1.00    25213
# sigma_SexM                           -0.59      0.20    -0.98    -0.19 1.00    33076
# sigma_SexUN                          -0.10      0.36    -0.82     0.63 1.00    36560
# Tail_ESS
# Intercept                            17468
# sigma_Intercept                      23142
# Site_YearDauphinRiver_2018           24489
# Site_YearMatheson_2017               23012
# Site_YearMatheson_2018               21333
# Site_YearRedRiver_2017               22895
# Site_YearRedRiver_2018               20792
# Site_YearSandyBar_2017               21554
# Site_YearSandyBar_2018               19494
# Site_YearWinnipegRiver_2017          23558
# SexM                                 39574
# SexUN                                30717
# sigma_Site_YearDauphinRiver_2018     33134
# sigma_Site_YearMatheson_2017         23890
# sigma_Site_YearMatheson_2018         30084
# sigma_Site_YearRedRiver_2017         31945
# sigma_Site_YearRedRiver_2018         33098
# sigma_Site_YearSandyBar_2017         32083
# sigma_Site_YearSandyBar_2018         30830
# sigma_Site_YearWinnipegRiver_2017    28044
# sigma_SexM                           38614
# sigma_SexUN                          35343
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.67      1.98     2.57    10.28 1.00    39215    34254
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_his, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    89.0      74.1     104.4
# DauphinRiver_2018    53.2      42.3      66.0
# Matheson_2017        61.7      41.9      87.2
# Matheson_2018        45.5      35.2      56.8
# RedRiver_2017        61.1      49.7      73.8
# RedRiver_2018        48.0      38.1      59.0
# SandyBar_2017        60.9      50.6      72.4
# SandyBar_2018        29.5      21.3      38.4
# WinnipegRiver_2017   76.6      38.9     130.6
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_his, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    35.623    16.615    55.173
# DauphinRiver_2017 - Matheson_2017        27.157     0.302    52.235
# DauphinRiver_2017 - Matheson_2018        43.446    25.018    61.407
# DauphinRiver_2017 - RedRiver_2017        27.821    10.056    45.971
# DauphinRiver_2017 - RedRiver_2018        41.001    24.631    57.433
# DauphinRiver_2017 - SandyBar_2017        27.976    11.599    44.848
# DauphinRiver_2017 - SandyBar_2018        59.595    44.324    76.011
# DauphinRiver_2017 - WinnipegRiver_2017   12.226   -40.799    53.691
# DauphinRiver_2018 - Matheson_2017        -8.311   -36.055    15.355
# DauphinRiver_2018 - Matheson_2018         7.723    -7.737    23.391
# DauphinRiver_2018 - RedRiver_2017        -7.789   -24.770     8.977
# DauphinRiver_2018 - RedRiver_2018         5.330   -11.208    20.798
# DauphinRiver_2018 - SandyBar_2017        -7.577   -24.029     7.923
# DauphinRiver_2018 - SandyBar_2018        23.899     9.220    38.736
# DauphinRiver_2018 - WinnipegRiver_2017  -23.403   -77.350    16.873
# Matheson_2017 - Matheson_2018            16.193    -7.769    42.307
# Matheson_2017 - RedRiver_2017             0.500   -23.491    26.178
# Matheson_2017 - RedRiver_2018            13.865    -8.397    38.970
# Matheson_2017 - SandyBar_2017             0.610   -21.172    27.020
# Matheson_2017 - SandyBar_2018            32.400    10.680    56.830
# Matheson_2017 - WinnipegRiver_2017      -14.837   -71.646    32.270
# Matheson_2018 - RedRiver_2017           -15.588   -30.708    -0.699
# Matheson_2018 - RedRiver_2018            -2.573   -16.964    11.832
# Matheson_2018 - SandyBar_2017           -15.376   -29.983    -0.937
# Matheson_2018 - SandyBar_2018            15.907     2.852    28.905
# Matheson_2018 - WinnipegRiver_2017      -30.994   -84.686     8.644
# RedRiver_2017 - RedRiver_2018            13.150    -0.995    27.758
# RedRiver_2017 - SandyBar_2017             0.202   -13.998    14.799
# RedRiver_2017 - SandyBar_2018            31.647    18.203    44.732
# RedRiver_2017 - WinnipegRiver_2017      -15.420   -68.427    25.151
# RedRiver_2018 - SandyBar_2017           -13.032   -25.827     0.480
# RedRiver_2018 - SandyBar_2018            18.491     8.331    29.247
# RedRiver_2018 - WinnipegRiver_2017      -28.576   -82.530    10.811
# SandyBar_2017 - SandyBar_2018            31.566    19.249    43.595
# SandyBar_2017 - WinnipegRiver_2017      -15.634   -68.359    24.614
# SandyBar_2018 - WinnipegRiver_2017      -47.094  -100.116    -7.746
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_his, ~ Site_Year)) #### That's the one!!!!!!
test2_his_yr_plot<- plot(emmeans(test2_his, ~ Site_Year)) #### That's the one!!!!!!
test2_his_yr_plot
ggsave("test2_his_yr_plot.png")
plot(emmeans(test2_his, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_his, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_his, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_his, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_his.rda")
his_tets2_plot <- gather_emmeans_draws(emmeans(test2_his, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("his_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_his, file = "test2_his.RDA")

library(repmod)
library(report)
report(test2_his)
#### test 2 glycine simple model ####
test2_gly<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Glycine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,700), class = b),
                          prior(normal(0,700), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_gly)
pp_check(test2_gly, ndraws = 100) +
  theme_bw()
summary(test2_gly)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Glycine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           632.86     85.07   487.91   820.29 1.00     8791
# sigma_Intercept                       5.57      0.26     5.07     6.07 1.00     9559
# Site_YearDauphinRiver_2018          -87.66     93.43  -284.53    82.84 1.00     9595
# Site_YearMatheson_2017             -178.76    103.02  -373.14    38.99 1.00    17631
# Site_YearMatheson_2018             -226.43     89.32  -420.27   -69.41 1.00     9214
# Site_YearRedRiver_2017               60.80     93.95  -132.74   238.94 1.00    11409
# Site_YearRedRiver_2018              -39.14     98.12  -241.34   145.46 1.00    10273
# Site_YearSandyBar_2017             -113.96     76.75  -277.63    25.76 1.00    12877
# Site_YearSandyBar_2018             -195.80     93.82  -391.05   -22.35 1.00     9963
# Site_YearWinnipegRiver_2017          46.95    145.97  -219.38   352.40 1.00    13662
# SexM                               -152.34     49.26  -235.75   -41.77 1.00    15860
# SexUN                               -67.44     64.51  -181.19    73.61 1.00    38088
# sigma_Site_YearDauphinRiver_2018     -0.87      0.41    -1.64    -0.02 1.00    13705
# sigma_Site_YearMatheson_2017         -0.54      0.47    -1.38     0.47 1.00    25673
# sigma_Site_YearMatheson_2018         -0.97      0.33    -1.60    -0.31 1.00    13219
# sigma_Site_YearRedRiver_2017         -0.19      0.30    -0.76     0.41 1.00    13512
# sigma_Site_YearRedRiver_2018         -0.47      0.32    -1.07     0.18 1.00    14652
# sigma_Site_YearSandyBar_2017         -0.41      0.25    -0.90     0.08 1.00    21029
# sigma_Site_YearSandyBar_2018         -0.69      0.33    -1.30    -0.00 1.00    14409
# sigma_Site_YearWinnipegRiver_2017    -0.37      0.55    -1.33     0.84 1.00    17166
# sigma_SexM                           -0.14      0.30    -0.72     0.45 1.00    13269
# sigma_SexUN                           0.36      0.38    -0.39     1.13 1.00    29962
# Tail_ESS
# Intercept                            13596
# sigma_Intercept                      16863
# Site_YearDauphinRiver_2018           15166
# Site_YearMatheson_2017               23899
# Site_YearMatheson_2018               14460
# Site_YearRedRiver_2017               17035
# Site_YearRedRiver_2018               16260
# Site_YearSandyBar_2017               17737
# Site_YearSandyBar_2018               15035
# Site_YearWinnipegRiver_2017          21311
# SexM                                 23742
# SexUN                                28416
# sigma_Site_YearDauphinRiver_2018     28283
# sigma_Site_YearMatheson_2017         24907
# sigma_Site_YearMatheson_2018         24998
# sigma_Site_YearRedRiver_2017         26003
# sigma_Site_YearRedRiver_2018         27323
# sigma_Site_YearSandyBar_2017         32786
# sigma_Site_YearSandyBar_2018         27246
# sigma_Site_YearWinnipegRiver_2017    20527
# sigma_SexM                           26798
# sigma_SexUN                          35266
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.69      1.97     2.64    10.32 1.00    33556    28059
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_gly, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017     553       411       724
# DauphinRiver_2018     468       402       553
# Matheson_2017         368       218       567
# Matheson_2018         331       262       405
# RedRiver_2017         617       511       737
# RedRiver_2018         516       430       619
# SandyBar_2017         442       346       550
# SandyBar_2018         360       284       447
# WinnipegRiver_2017    591       392       872
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_gly, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     83.18    -92.01   273.676
# DauphinRiver_2017 - Matheson_2017        181.72    -20.40   386.366
# DauphinRiver_2017 - Matheson_2018        219.58     63.97   412.203
# DauphinRiver_2017 - RedRiver_2017        -63.66   -240.83   130.754
# DauphinRiver_2017 - RedRiver_2018         35.18   -148.45   237.938
# DauphinRiver_2017 - SandyBar_2017        110.31    -33.00   268.507
# DauphinRiver_2017 - SandyBar_2018        191.96     20.40   388.681
# DauphinRiver_2017 - WinnipegRiver_2017   -41.99   -325.86   239.306
# DauphinRiver_2018 - Matheson_2017        101.50   -111.39   276.960
# DauphinRiver_2018 - Matheson_2018        138.83     49.65   226.907
# DauphinRiver_2018 - RedRiver_2017       -146.69   -278.03   -22.997
# DauphinRiver_2018 - RedRiver_2018        -47.76   -155.37    62.188
# DauphinRiver_2018 - SandyBar_2017         28.71   -107.70   149.613
# DauphinRiver_2018 - SandyBar_2018        108.09      7.68   206.364
# DauphinRiver_2018 - WinnipegRiver_2017  -120.18   -396.95    90.113
# Matheson_2017 - Matheson_2018             35.00   -120.86   253.076
# Matheson_2017 - RedRiver_2017           -247.86   -436.80   -31.970
# Matheson_2017 - RedRiver_2018           -147.53   -329.62    75.446
# Matheson_2017 - SandyBar_2017            -74.00   -238.26   121.991
# Matheson_2017 - SandyBar_2018              7.96   -172.94   215.713
# Matheson_2017 - WinnipegRiver_2017      -223.68   -522.20    93.644
# Matheson_2018 - RedRiver_2017           -284.25   -411.45  -173.987
# Matheson_2018 - RedRiver_2018           -186.43   -292.11   -81.134
# Matheson_2018 - SandyBar_2017           -108.48   -233.46     0.843
# Matheson_2018 - SandyBar_2018            -30.84   -125.66    65.243
# Matheson_2018 - WinnipegRiver_2017      -258.55   -534.09   -54.864
# RedRiver_2017 - RedRiver_2018             99.33    -34.88   238.367
# RedRiver_2017 - SandyBar_2017            174.60     38.38   316.856
# RedRiver_2017 - SandyBar_2018            255.43    127.88   385.082
# RedRiver_2017 - WinnipegRiver_2017        24.81   -248.37   265.477
# RedRiver_2018 - SandyBar_2017             75.36    -64.20   213.081
# RedRiver_2018 - SandyBar_2018            155.33     56.18   260.661
# RedRiver_2018 - WinnipegRiver_2017       -73.33   -350.97   152.203
# SandyBar_2017 - SandyBar_2018             80.51    -43.74   213.544
# SandyBar_2017 - WinnipegRiver_2017      -150.70   -431.43    79.580
# SandyBar_2018 - WinnipegRiver_2017      -228.99   -505.36    -9.681
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_gly, ~ Site_Year)) #### That's the one!!!!!!
test2_gly_yr_plot<- plot(emmeans(test2_gly, ~ Site_Year)) #### That's the one!!!!!!
test2_gly_yr_plot
ggsave("test2_gly_yr_plot.png")
plot(emmeans(test2_gly, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_gly, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_gly, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_gly, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_gly.rda")
gly_tets2_plot <- gather_emmeans_draws(emmeans(test2_gly, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("gly_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_gly, file = "test2_gly.RDA")

library(repmod)
library(report)
report(test2_gly)


#### test 2 glutamate simple model ####
test2_glu<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Glutamate~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,250), class = b),
                          prior(normal(0,250), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_glu)
pp_check(test2_glu, ndraws = 100) +
  theme_bw()
summary(test2_glu)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Glutamate ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           216.97     24.97   170.29   268.25 1.00    10798
# sigma_Intercept                       4.69      0.19     4.33     5.09 1.00    14047
# Site_YearDauphinRiver_2018         -107.64     25.89  -160.25   -58.45 1.00    11660
# Site_YearMatheson_2017              -34.82     53.27  -128.31    83.61 1.00    20809
# Site_YearMatheson_2018             -138.57     25.51  -190.89   -90.74 1.00    10975
# Site_YearRedRiver_2017               41.25     31.17   -20.20   102.59 1.00    13358
# Site_YearRedRiver_2018              -92.37     26.88  -145.79   -40.03 1.00    12433
# Site_YearSandyBar_2017              -14.08     29.84   -72.88    44.40 1.00    14363
# Site_YearSandyBar_2018             -126.07     24.87  -176.73   -79.02 1.00    11164
# Site_YearWinnipegRiver_2017         -61.52     39.48  -131.53    22.40 1.00    14451
# SexM                                -41.56      8.22   -56.83   -24.33 1.00    33748
# SexUN                                -2.64      7.81   -18.59    12.43 1.00    39226
# sigma_Site_YearDauphinRiver_2018     -0.99      0.31    -1.57    -0.36 1.00    21075
# sigma_Site_YearMatheson_2017          0.01      0.46    -0.80     1.00 1.00    26500
# sigma_Site_YearMatheson_2018         -1.67      0.29    -2.23    -1.08 1.00    20464
# sigma_Site_YearRedRiver_2017         -0.34      0.27    -0.87     0.19 1.00    19653
# sigma_Site_YearRedRiver_2018         -0.74      0.27    -1.26    -0.20 1.00    21684
# sigma_Site_YearSandyBar_2017         -0.23      0.25    -0.73     0.26 1.00    21554
# sigma_Site_YearSandyBar_2018         -1.53      0.28    -2.06    -0.96 1.00    21886
# sigma_Site_YearWinnipegRiver_2017    -0.95      0.53    -1.84     0.25 1.00    20962
# sigma_SexM                           -0.39      0.20    -0.77     0.01 1.00    27574
# sigma_SexUN                          -0.75      0.39    -1.49     0.02 1.00    36473
# Tail_ESS
# Intercept                            14553
# sigma_Intercept                      20929
# Site_YearDauphinRiver_2018           16234
# Site_YearMatheson_2017               24456
# Site_YearMatheson_2018               14548
# Site_YearRedRiver_2017               19135
# Site_YearRedRiver_2018               17506
# Site_YearSandyBar_2017               19208
# Site_YearSandyBar_2018               15284
# Site_YearWinnipegRiver_2017          21156
# SexM                                 36409
# SexUN                                37266
# sigma_Site_YearDauphinRiver_2018     30559
# sigma_Site_YearMatheson_2017         27699
# sigma_Site_YearMatheson_2018         29947
# sigma_Site_YearRedRiver_2017         28585
# sigma_Site_YearRedRiver_2018         30378
# sigma_Site_YearSandyBar_2017         29451
# sigma_Site_YearSandyBar_2018         30423
# sigma_Site_YearWinnipegRiver_2017    19971
# sigma_SexM                           35371
# sigma_SexUN                          39308
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.27      1.66     1.82     8.26 1.00    31672    27694
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_glu, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   201.5     154.0     249.4
# DauphinRiver_2018    93.8      79.7     111.1
# Matheson_2017       161.5      80.7     268.8
# Matheson_2018        63.6      51.9      75.3
# RedRiver_2017       242.3     209.7     279.8
# RedRiver_2018       109.1      86.7     133.9
# SandyBar_2017       187.0     154.7     224.9
# SandyBar_2018        75.9      66.3      86.7
# WinnipegRiver_2017  136.5      88.6     206.0
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_glu, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018     107.0    57.094    158.69
# DauphinRiver_2017 - Matheson_2017          38.6   -74.786    133.88
# DauphinRiver_2017 - Matheson_2018         137.9    88.913    188.64
# DauphinRiver_2017 - RedRiver_2017         -41.1  -103.261     19.37
# DauphinRiver_2017 - RedRiver_2018          92.1    39.572    145.19
# DauphinRiver_2017 - SandyBar_2017          14.0   -44.359     72.90
# DauphinRiver_2017 - SandyBar_2018         125.5    77.864    175.31
# DauphinRiver_2017 - WinnipegRiver_2017     63.7   -14.933    136.69
# DauphinRiver_2018 - Matheson_2017         -67.3  -171.703     19.49
# DauphinRiver_2018 - Matheson_2018          30.1    12.493     51.54
# DauphinRiver_2018 - RedRiver_2017        -148.1  -188.841   -111.21
# DauphinRiver_2018 - RedRiver_2018         -15.1   -44.198     14.57
# DauphinRiver_2018 - SandyBar_2017         -92.8  -132.348    -53.77
# DauphinRiver_2018 - SandyBar_2018          17.7     0.602     38.29
# DauphinRiver_2018 - WinnipegRiver_2017    -42.3  -110.354     11.39
# Matheson_2017 - Matheson_2018              98.1    15.785    205.50
# Matheson_2017 - RedRiver_2017             -80.9  -168.984     31.25
# Matheson_2017 - RedRiver_2018              52.1   -30.153    163.12
# Matheson_2017 - SandyBar_2017             -25.4  -113.626     86.83
# Matheson_2017 - SandyBar_2018              85.3     4.421    193.40
# Matheson_2017 - WinnipegRiver_2017         23.9   -84.193    146.34
# Matheson_2018 - RedRiver_2017            -178.8  -217.550   -144.89
# Matheson_2018 - RedRiver_2018             -45.7   -73.847    -19.73
# Matheson_2018 - SandyBar_2017            -123.6  -163.798    -89.38
# Matheson_2018 - SandyBar_2018             -12.3   -28.575      3.75
# Matheson_2018 - WinnipegRiver_2017        -73.1  -143.233    -24.14
# RedRiver_2017 - RedRiver_2018             132.9    93.375    177.13
# RedRiver_2017 - SandyBar_2017              55.3     5.911    105.31
# RedRiver_2017 - SandyBar_2018             166.2   132.700    204.59
# RedRiver_2017 - WinnipegRiver_2017        105.3    32.598    169.44
# RedRiver_2018 - SandyBar_2017             -77.8  -121.608    -37.10
# RedRiver_2018 - SandyBar_2018              33.1     9.117     58.58
# RedRiver_2018 - WinnipegRiver_2017        -27.7   -96.344     29.07
# SandyBar_2017 - SandyBar_2018             111.0    76.179    148.65
# SandyBar_2017 - WinnipegRiver_2017         49.8   -22.947    115.07
# SandyBar_2018 - WinnipegRiver_2017        -60.6  -129.541    -11.01
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_glu, ~ Site_Year)) #### That's the one!!!!!!
test2_glu_yr_plot<- plot(emmeans(test2_glu, ~ Site_Year)) #### That's the one!!!!!!
test2_glu_yr_plot
ggsave("test2_glu_yr_plot.png")
plot(emmeans(test2_glu, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_glu, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_glu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_glu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_glu.rda")
glu_tets2_plot <- gather_emmeans_draws(emmeans(test2_glu, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("glu_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_glu, file = "test2_glu.RDA")

library(repmod)
library(report)
report(test2_glu)

#### test 2 glutamine simple model ####
test2_gln<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Glutamine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,45), class = b),
                          prior(normal(0,45), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_gln)
pp_check(test2_gln, ndraws = 100) +
  theme_bw()
summary(test2_gln)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Glutamine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                            46.21      4.71    37.69    56.23 1.00    12861
# sigma_Intercept                       3.03      0.24     2.58     3.52 1.00    12132
# Site_YearDauphinRiver_2018          -19.47      7.75   -34.53    -4.21 1.00    21030
# Site_YearMatheson_2017              -15.19      8.62   -29.91     4.28 1.00    19626
# Site_YearMatheson_2018              -32.57      5.20   -43.26   -22.72 1.00    13794
# Site_YearRedRiver_2017               -8.92      5.68   -20.21     2.31 1.00    19066
# Site_YearRedRiver_2018              -19.71      6.37   -31.82    -6.78 1.00    15285
# Site_YearSandyBar_2017               -3.29      5.68   -14.52     7.90 1.00    17185
# Site_YearSandyBar_2018              -31.65      4.96   -41.71   -22.03 1.00    15158
# Site_YearWinnipegRiver_2017           7.29     14.29   -18.33    39.03 1.00    23907
# SexM                                 -9.48      3.16   -15.57    -3.19 1.00    27137
# SexUN                                 0.23      4.89    -9.92     9.73 1.00    38064
# sigma_Site_YearDauphinRiver_2018      0.00      0.34    -0.64     0.70 1.00    18510
# sigma_Site_YearMatheson_2017         -0.32      0.48    -1.16     0.71 1.00    23175
# sigma_Site_YearMatheson_2018         -0.96      0.32    -1.59    -0.32 1.00    15976
# sigma_Site_YearRedRiver_2017         -0.29      0.28    -0.84     0.27 1.00    17100
# sigma_Site_YearRedRiver_2018         -0.16      0.31    -0.76     0.46 1.00    16497
# sigma_Site_YearSandyBar_2017         -0.15      0.28    -0.69     0.40 1.00    16136
# sigma_Site_YearSandyBar_2018         -0.81      0.32    -1.43    -0.18 1.00    16225
# sigma_Site_YearWinnipegRiver_2017     0.14      0.52    -0.77     1.26 1.00    20155
# sigma_SexM                           -0.31      0.22    -0.72     0.13 1.00    20180
# sigma_SexUN                          -0.21      0.41    -1.04     0.55 1.00    29810
# Tail_ESS
# Intercept                            18682
# sigma_Intercept                      22277
# Site_YearDauphinRiver_2018           28131
# Site_YearMatheson_2017               22677
# Site_YearMatheson_2018               20147
# Site_YearRedRiver_2017               26481
# Site_YearRedRiver_2018               22655
# Site_YearSandyBar_2017               25853
# Site_YearSandyBar_2018               21288
# Site_YearWinnipegRiver_2017          25676
# SexM                                 35638
# SexUN                                31426
# sigma_Site_YearDauphinRiver_2018     32262
# sigma_Site_YearMatheson_2017         25108
# sigma_Site_YearMatheson_2018         29542
# sigma_Site_YearRedRiver_2017         29419
# sigma_Site_YearRedRiver_2018         29699
# sigma_Site_YearSandyBar_2017         29231
# sigma_Site_YearSandyBar_2018         29139
# sigma_Site_YearWinnipegRiver_2017    27290
# sigma_SexM                           31303
# sigma_SexUN                          36763
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.78      2.15     2.32    10.68 1.00    32640    34082
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_gln, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017    42.9     34.37      52.4
# DauphinRiver_2018    23.4     11.65      36.2
# Matheson_2017        26.9     14.88      43.7
# Matheson_2018        10.4      5.47      15.7
# RedRiver_2017        33.9     26.10      42.6
# RedRiver_2018        23.1     14.91      32.6
# SandyBar_2017        39.6     32.00      48.1
# SandyBar_2018        11.4      6.15      17.0
# WinnipegRiver_2017   49.1     24.92      80.5
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_gln, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018    19.457     3.886    34.173
# DauphinRiver_2017 - Matheson_2017        15.909    -1.857    31.545
# DauphinRiver_2017 - Matheson_2018        32.404    22.544    43.050
# DauphinRiver_2017 - RedRiver_2017         8.910    -2.289    20.222
# DauphinRiver_2017 - RedRiver_2018        19.878     6.820    31.841
# DauphinRiver_2017 - SandyBar_2017         3.268    -7.994    14.385
# DauphinRiver_2017 - SandyBar_2018        31.586    22.069    41.731
# DauphinRiver_2017 - WinnipegRiver_2017   -6.247   -37.901    19.065
# DauphinRiver_2018 - Matheson_2017        -3.888   -23.606    15.057
# DauphinRiver_2018 - Matheson_2018        12.862     0.232    25.406
# DauphinRiver_2018 - RedRiver_2017       -10.521   -25.562     3.527
# DauphinRiver_2018 - RedRiver_2018         0.259   -14.964    15.625
# DauphinRiver_2018 - SandyBar_2017       -16.233   -30.978    -1.907
# DauphinRiver_2018 - SandyBar_2018        12.112    -1.555    26.113
# DauphinRiver_2018 - WinnipegRiver_2017  -25.816   -57.685     2.073
# Matheson_2017 - Matheson_2018            16.600     2.934    33.154
# Matheson_2017 - RedRiver_2017            -6.950   -22.196    10.579
# Matheson_2017 - RedRiver_2018             3.883   -11.341    21.205
# Matheson_2017 - SandyBar_2017           -12.627   -27.668     4.245
# Matheson_2017 - SandyBar_2018            15.459     2.702    32.181
# Matheson_2017 - WinnipegRiver_2017      -21.799   -54.729     8.417
# Matheson_2018 - RedRiver_2017           -23.448   -32.841   -14.834
# Matheson_2018 - RedRiver_2018           -12.667   -22.724    -3.556
# Matheson_2018 - SandyBar_2017           -29.134   -38.568   -20.780
# Matheson_2018 - SandyBar_2018            -0.905    -8.321     6.084
# Matheson_2018 - WinnipegRiver_2017      -38.533   -70.136   -14.463
# RedRiver_2017 - RedRiver_2018            10.879    -0.892    22.349
# RedRiver_2017 - SandyBar_2017            -5.626   -16.074     5.119
# RedRiver_2017 - SandyBar_2018            22.610    13.433    31.945
# RedRiver_2017 - WinnipegRiver_2017      -14.973   -46.127    10.908
# RedRiver_2018 - SandyBar_2017           -16.566   -27.539    -5.237
# RedRiver_2018 - SandyBar_2018            11.578     3.092    21.517
# RedRiver_2018 - WinnipegRiver_2017      -25.894   -57.741    -0.187
# SandyBar_2017 - SandyBar_2018            28.285    19.627    37.366
# SandyBar_2017 - WinnipegRiver_2017       -9.418   -41.242    15.546
# SandyBar_2018 - WinnipegRiver_2017      -37.696   -69.675   -13.764
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_gln, ~ Site_Year)) #### That's the one!!!!!!
test2_gln_yr_plot<- plot(emmeans(test2_gln, ~ Site_Year)) #### That's the one!!!!!!
test2_gln_yr_plot
ggsave("test2_gln_yr_plot.png")
plot(emmeans(test2_gln, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_gln, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_gln, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_gln, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_gln.rda")
gln_tets2_plot <- gather_emmeans_draws(emmeans(test2_gln, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("gln_tets2_plot.png")
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_gln, file = "test2_gln.RDA")

library(repmod)
library(report)
report(test2_gln)

#### test 2 aspartate simple model ####
test2_asp<- brm(data=raw_dataf,
                family = student,
                bf(Aspartate~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,45), class = b),
                          prior(normal(0,45), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_asp)
pp_check(test2_asp, ndraws = 100) +
  theme_bw()
summary(test2_asp)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: Aspartate ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                            42.54      5.44    31.77    53.22 1.00    11602
# sigma_Intercept                       2.95      0.24     2.50     3.44 1.00    20636
# Site_YearDauphinRiver_2018          -20.80      6.09   -32.74    -8.85 1.00    13611
# Site_YearMatheson_2017              -12.49      9.50   -31.49     5.95 1.00    20144
# Site_YearMatheson_2018              -30.09      5.67   -41.28   -18.98 1.00    12528
# Site_YearRedRiver_2017              -15.77      6.83   -29.12    -2.31 1.00    16544
# Site_YearRedRiver_2018              -33.22      5.49   -44.05   -22.33 1.00    11882
# Site_YearSandyBar_2017               -4.93      6.84   -18.31     8.51 1.00    16399
# Site_YearSandyBar_2018              -32.54      5.63   -43.64   -21.43 1.00    12170
# Site_YearWinnipegRiver_2017           8.32     14.38   -21.39    36.06 1.00    26545
# SexM                                 -3.48      1.47    -6.30    -0.45 1.00    44178
# SexUN                                -2.12      4.36   -10.33     7.04 1.00    43645
# sigma_Site_YearDauphinRiver_2018     -0.92      0.36    -1.62    -0.21 1.00    25612
# sigma_Site_YearMatheson_2017         -0.44      0.49    -1.34     0.61 1.00    33447
# sigma_Site_YearMatheson_2018         -1.32      0.35    -2.00    -0.63 1.00    26340
# sigma_Site_YearRedRiver_2017         -0.30      0.30    -0.89     0.30 1.00    26728
# sigma_Site_YearRedRiver_2018         -1.96      0.40    -2.73    -1.16 1.00    22763
# sigma_Site_YearSandyBar_2017         -0.23      0.30    -0.81     0.35 1.00    25855
# sigma_Site_YearSandyBar_2018         -1.34      0.34    -2.01    -0.69 1.00    27978
# sigma_Site_YearWinnipegRiver_2017     0.11      0.56    -0.89     1.29 1.00    30939
# sigma_SexM                            0.07      0.24    -0.39     0.54 1.00    40348
# sigma_SexUN                           0.42      0.39    -0.33     1.20 1.00    39303
# Tail_ESS
# Intercept                            18669
# sigma_Intercept                      28644
# Site_YearDauphinRiver_2018           23217
# Site_YearMatheson_2017               27573
# Site_YearMatheson_2018               20867
# Site_YearRedRiver_2017               26643
# Site_YearRedRiver_2018               19509
# Site_YearSandyBar_2017               26711
# Site_YearSandyBar_2018               19712
# Site_YearWinnipegRiver_2017          28859
# SexM                                 35215
# SexUN                                34069
# sigma_Site_YearDauphinRiver_2018     35800
# sigma_Site_YearMatheson_2017         34803
# sigma_Site_YearMatheson_2018         35220
# sigma_Site_YearRedRiver_2017         35324
# sigma_Site_YearRedRiver_2018         33428
# sigma_Site_YearSandyBar_2017         34897
# sigma_Site_YearSandyBar_2018         35012
# sigma_Site_YearWinnipegRiver_2017    32609
# sigma_SexM                           42814
# sigma_SexUN                          39206
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     7.23      5.98     2.55    24.25 1.00    23655    26119
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

pp_check(test2_asp, ndraws = 100) +
  +   theme_bw()
summary(test2_asp)

emmeans(test2_asp, ~ Site_Year)
pairs(emmeans(test2_asp, ~ Site_Year))
plot(emmeans(test2_asp, ~ Site_Year)) #### That's the one!!!!!!
test2_asp_yr_plot<- plot(emmeans(test2_asp, ~ Site_Year)) #### That's the one!!!!!!
test2_asp_yr_plot
ggsave("test2_asp_yr_plot.png")
plot(emmeans(test2_asp, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_asp, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_asp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_asp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_asp.rda")
asp_tets2_plot <- gather_emmeans_draws(emmeans(test2_asp, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("asp_tets2_plot.png")
library(repmod)
library(report)
report(test2_asp)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_asp, file = "test2_asp.RDA")

#### test 2 Arginine simple model ####
load(test2_arg)
test2_arg<- brm(data=raw_dataf,
                family = skew_normal,
                bf(Arginine~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,150), class = b),
                          prior(normal(0,150), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_arg)
pp_check(test2_arg, ndraws = 100) +
  theme_bw()
summary(test2_arg)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: Arginine ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: raw_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                           182.73     11.20   161.34   205.63 1.00    16615
# sigma_Intercept                       3.67      0.21     3.29     4.10 1.00    20493
# Site_YearDauphinRiver_2018         -129.24     12.93  -155.43  -104.04 1.00    17705
# Site_YearMatheson_2017              -21.88     20.71   -60.59    20.55 1.00    24653
# Site_YearMatheson_2018             -112.20     13.12  -138.71   -86.75 1.00    18947
# Site_YearRedRiver_2017                0.53     13.55   -26.51    27.14 1.00    22577
# Site_YearRedRiver_2018              -81.67     18.32  -118.09   -46.09 1.00    21362
# Site_YearSandyBar_2017               -1.50     13.89   -28.96    26.05 1.00    24358
# Site_YearSandyBar_2018              -93.77     15.03  -124.41   -64.90 1.00    19019
# Site_YearWinnipegRiver_2017         -18.69     41.07   -97.46    68.46 1.00    29252
# SexM                                -31.73     12.78   -56.14    -6.70 1.00    31204
# SexUN                               -17.83      7.97   -33.31    -1.88 1.00    42713
# sigma_Site_YearDauphinRiver_2018     -0.59      0.29    -1.15    -0.01 1.00    26021
# sigma_Site_YearMatheson_2017         -0.23      0.44    -1.00     0.75 1.00    29375
# sigma_Site_YearMatheson_2018         -0.41      0.31    -1.01     0.20 1.00    26123
# sigma_Site_YearRedRiver_2017         -0.19      0.27    -0.71     0.34 1.00    25824
# sigma_Site_YearRedRiver_2018          0.04      0.30    -0.55     0.64 1.00    25707
# sigma_Site_YearSandyBar_2017         -0.04      0.25    -0.55     0.45 1.00    26557
# sigma_Site_YearSandyBar_2018         -0.37      0.34    -1.02     0.30 1.00    24871
# sigma_Site_YearWinnipegRiver_2017     0.56      0.50    -0.31     1.65 1.00    29127
# sigma_SexM                            0.23      0.24    -0.28     0.68 1.00    29437
# sigma_SexUN                          -0.40      0.34    -1.02     0.31 1.00    40920
# Tail_ESS
# Intercept                            21435
# sigma_Intercept                      26138
# Site_YearDauphinRiver_2018           25134
# Site_YearMatheson_2017               25687
# Site_YearMatheson_2018               25238
# Site_YearRedRiver_2017               30836
# Site_YearRedRiver_2018               32275
# Site_YearSandyBar_2017               33186
# Site_YearSandyBar_2018               27797
# Site_YearWinnipegRiver_2017          27578
# SexM                                 41768
# SexUN                                38521
# sigma_Site_YearDauphinRiver_2018     34299
# sigma_Site_YearMatheson_2017         28175
# sigma_Site_YearMatheson_2018         33487
# sigma_Site_YearRedRiver_2017         34806
# sigma_Site_YearRedRiver_2018         34066
# sigma_Site_YearSandyBar_2017         34133
# sigma_Site_YearSandyBar_2018         35828
# sigma_Site_YearWinnipegRiver_2017    30393
# sigma_SexM                           33576
# sigma_SexUN                          38157
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     1.06      1.27    -1.30     3.58 1.00    27873    32869
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_arg, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017   166.2     144.0     189.1
# DauphinRiver_2018    36.9      23.7      50.2
# Matheson_2017       143.6     108.6     181.4
# Matheson_2018        53.9      38.4      69.5
# RedRiver_2017       166.7     147.4     186.0
# RedRiver_2018        84.4      56.9     111.0
# SandyBar_2017       164.5     143.0     185.7
# SandyBar_2018        72.7      53.6      89.8
# WinnipegRiver_2017  146.1      66.9     229.3
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_arg, ~ Site_Year))
# contrast                               estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   129.044     103.5   154.786
# DauphinRiver_2017 - Matheson_2017        22.541     -18.2    62.532
# DauphinRiver_2017 - Matheson_2018       112.053      86.3   138.081
# DauphinRiver_2017 - RedRiver_2017        -0.619     -27.6    25.954
# DauphinRiver_2017 - RedRiver_2018        81.549      46.3   118.263
# DauphinRiver_2017 - SandyBar_2017         1.462     -26.5    28.517
# DauphinRiver_2017 - SandyBar_2018        93.406      64.4   123.877
# DauphinRiver_2017 - WinnipegRiver_2017   19.930     -62.8   102.281
# DauphinRiver_2018 - Matheson_2017      -106.560    -147.0   -69.639
# DauphinRiver_2018 - Matheson_2018       -17.113     -34.4     0.802
# DauphinRiver_2018 - RedRiver_2017      -129.615    -151.7  -108.205
# DauphinRiver_2018 - RedRiver_2018       -47.871     -78.8   -16.014
# DauphinRiver_2018 - SandyBar_2017      -127.467    -151.6  -104.120
# DauphinRiver_2018 - SandyBar_2018       -36.312     -57.7   -11.080
# DauphinRiver_2018 - WinnipegRiver_2017 -109.064    -193.3   -30.505
# Matheson_2017 - Matheson_2018            89.575      52.5   130.053
# Matheson_2017 - RedRiver_2017           -23.147     -61.0    17.789
# Matheson_2017 - RedRiver_2018            59.364      14.2   104.041
# Matheson_2017 - SandyBar_2017           -20.987     -60.6    19.269
# Matheson_2017 - SandyBar_2018            71.271      32.5   112.943
# Matheson_2017 - WinnipegRiver_2017       -2.513     -91.0    85.407
# Matheson_2018 - RedRiver_2017          -112.647    -134.4   -90.616
# Matheson_2018 - RedRiver_2018           -30.878     -61.5     1.936
# Matheson_2018 - SandyBar_2017          -110.454    -134.9   -86.627
# Matheson_2018 - SandyBar_2018           -19.115     -41.1     6.142
# Matheson_2018 - WinnipegRiver_2017      -92.244    -175.8   -12.998
# RedRiver_2017 - RedRiver_2018            81.948      48.2   116.014
# RedRiver_2017 - SandyBar_2017             2.230     -22.7    27.445
# RedRiver_2017 - SandyBar_2018            93.614      68.3   121.917
# RedRiver_2017 - WinnipegRiver_2017       20.381     -63.9    99.630
# RedRiver_2018 - SandyBar_2017           -79.716    -115.6   -43.687
# RedRiver_2018 - SandyBar_2018            11.993     -16.8    40.851
# RedRiver_2018 - WinnipegRiver_2017      -61.657    -149.9    21.172
# SandyBar_2017 - SandyBar_2018            91.600      63.3   121.432
# SandyBar_2017 - WinnipegRiver_2017       18.346     -67.2    97.824
# SandyBar_2018 - WinnipegRiver_2017      -73.808    -155.1    10.882
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_arg, ~ Site_Year)) #### That's the one!!!!!!
test2_arg_yr_plot<- plot(emmeans(test2_arg, ~ Site_Year)) #### That's the one!!!!!!
test2_arg_yr_plot
ggsave("test2_arg_yr_plot.png")
plot(emmeans(test2_arg, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_arg, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_arg, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_arg, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_arg.rda")
arg_tets2_plot <- gather_emmeans_draws(emmeans(test2_arg, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("arg_tets2_plot.png")
library(repmod)
library(report)
report(test2_arg)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_arg, file = "test2_arg.RDA")

#### test 2 C14_2 simple model ####
test2_C14_2<- brm(data=carn_dataf,
                  family = skew_normal,
                  bf(C14_2~ Site_Year + Sex,
                     sigma ~ Site_Year + Sex),
                  prior = c(prior(normal(0,0.0005), class = b),
                            prior(normal(0,0.0005), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C14_2)
pp_check(test2_C14_2, ndraws = 100) +
  theme_bw()
summary(test2_C14_2)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: C14_2 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    45189
# sigma_Intercept                      -8.33      0.19    -8.68    -7.92 1.00    16700
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    40255
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    39708
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    45081
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    45230
# Site_YearRedRiver_2018               -0.00      0.00    -0.00    -0.00 1.00    36676
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    46449
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    37215
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    55795
# SexM                                  0.00      0.00    -0.00     0.00 1.00    38265
# SexUN                                -0.00      0.00    -0.00     0.00 1.00    46662
# sigma_Site_YearDauphinRiver_2018     -0.60      0.30    -1.19     0.00 1.00    20208
# sigma_Site_YearMatheson_2017         -0.91      0.46    -1.71     0.11 1.00    26376
# sigma_Site_YearMatheson_2018         -1.16      0.30    -1.73    -0.56 1.00    20390
# sigma_Site_YearRedRiver_2017         -0.23      0.28    -0.77     0.31 1.00    18995
# sigma_Site_YearRedRiver_2018         -0.50      0.30    -1.08     0.11 1.00    21117
# sigma_Site_YearSandyBar_2017          0.17      0.26    -0.35     0.68 1.00    20890
# sigma_Site_YearSandyBar_2018         -0.53      0.30    -1.11     0.06 1.00    20118
# sigma_Site_YearWinnipegRiver_2017     0.00      0.50    -0.86     1.09 1.00    26824
# sigma_SexM                           -0.36      0.21    -0.76     0.05 1.00    34547
# sigma_SexUN                          -0.03      0.34    -0.66     0.68 1.00    32715
# Tail_ESS
# Intercept                            40910
# sigma_Intercept                      21503
# Site_YearDauphinRiver_2018           44674
# Site_YearMatheson_2017               43128
# Site_YearMatheson_2018               44013
# Site_YearRedRiver_2017               47045
# Site_YearRedRiver_2018               43162
# Site_YearSandyBar_2017               47625
# Site_YearSandyBar_2018               43645
# Site_YearWinnipegRiver_2017          37796
# SexM                                 47856
# SexUN                                46213
# sigma_Site_YearDauphinRiver_2018     29560
# sigma_Site_YearMatheson_2017         27860
# sigma_Site_YearMatheson_2018         28241
# sigma_Site_YearRedRiver_2017         27261
# sigma_Site_YearRedRiver_2018         31409
# sigma_Site_YearSandyBar_2017         27413
# sigma_Site_YearSandyBar_2018         30073
# sigma_Site_YearWinnipegRiver_2017    28360
# sigma_SexM                           39589
# sigma_SexUN                          35375
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.32      1.49     2.04     7.88 1.00    28696    22055
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
# Warning message:
#   There were 2 divergent transitions after warmup. Increasing adapt_delta above 0.95 may help. See http://mc-stan.org/misc/warnings.html#divergent-transitions-after-warmup 
emmeans(test2_C14_2, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000505  0.000409  0.000612
# DauphinRiver_2018  0.000366  0.000303  0.000442
# Matheson_2017      0.000402  0.000319  0.000509
# Matheson_2018      0.000290  0.000243  0.000342
# RedRiver_2017      0.000548  0.000455  0.000650
# RedRiver_2018      0.000382  0.000316  0.000461
# SandyBar_2017      0.000473  0.000362  0.000604
# SandyBar_2018      0.000395  0.000330  0.000474
# WinnipegRiver_2017 0.000651  0.000390  0.000958
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_C14_2, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   1.38e-04  1.93e-05  2.64e-04
# DauphinRiver_2017 - Matheson_2017       1.01e-04 -2.67e-05  2.35e-04
# DauphinRiver_2017 - Matheson_2018       2.14e-04  1.08e-04  3.20e-04
# DauphinRiver_2017 - RedRiver_2017      -4.30e-05 -1.79e-04  9.22e-05
# DauphinRiver_2017 - RedRiver_2018       1.21e-04  3.68e-06  2.47e-04
# DauphinRiver_2017 - SandyBar_2017       3.21e-05 -1.19e-04  1.74e-04
# DauphinRiver_2017 - SandyBar_2018       1.08e-04 -1.25e-05  2.33e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -1.46e-04 -4.54e-04  1.33e-04
# DauphinRiver_2018 - Matheson_2017      -3.70e-05 -1.62e-04  7.86e-05
# DauphinRiver_2018 - Matheson_2018       7.54e-05 -3.47e-06  1.61e-04
# DauphinRiver_2018 - RedRiver_2017      -1.82e-04 -3.05e-04 -6.12e-05
# DauphinRiver_2018 - RedRiver_2018      -1.64e-05 -1.22e-04  8.97e-05
# DauphinRiver_2018 - SandyBar_2017      -1.06e-04 -2.50e-04  3.15e-05
# DauphinRiver_2018 - SandyBar_2018      -2.93e-05 -1.34e-04  7.76e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -2.84e-04 -5.96e-04 -1.40e-05
# Matheson_2017 - Matheson_2018           1.12e-04  1.21e-05  2.21e-04
# Matheson_2017 - RedRiver_2017          -1.45e-04 -2.79e-04 -1.41e-05
# Matheson_2017 - RedRiver_2018           1.90e-05 -9.02e-05  1.36e-04
# Matheson_2017 - SandyBar_2017          -6.89e-05 -2.21e-04  7.76e-05
# Matheson_2017 - SandyBar_2018           5.88e-06 -1.01e-04  1.25e-04
# Matheson_2017 - WinnipegRiver_2017     -2.46e-04 -5.72e-04  2.46e-05
# Matheson_2018 - RedRiver_2017          -2.56e-04 -3.65e-04 -1.57e-04
# Matheson_2018 - RedRiver_2018          -9.14e-05 -1.82e-04 -3.20e-06
# Matheson_2018 - SandyBar_2017          -1.82e-04 -3.13e-04 -6.23e-05
# Matheson_2018 - SandyBar_2018          -1.04e-04 -1.98e-04 -1.91e-05
# Matheson_2018 - WinnipegRiver_2017     -3.59e-04 -6.65e-04 -9.52e-05
# RedRiver_2017 - RedRiver_2018           1.65e-04  4.72e-05  2.80e-04
# RedRiver_2017 - SandyBar_2017           7.46e-05 -8.13e-05  2.23e-04
# RedRiver_2017 - SandyBar_2018           1.52e-04  3.82e-05  2.69e-04
# RedRiver_2017 - WinnipegRiver_2017     -1.03e-04 -4.19e-04  1.74e-04
# RedRiver_2018 - SandyBar_2017          -8.97e-05 -2.34e-04  4.64e-05
# RedRiver_2018 - SandyBar_2018          -1.29e-05 -1.03e-04  7.35e-05
# RedRiver_2018 - WinnipegRiver_2017     -2.67e-04 -5.91e-04 -7.45e-06
# SandyBar_2017 - SandyBar_2018           7.65e-05 -5.85e-05  2.22e-04
# SandyBar_2017 - WinnipegRiver_2017     -1.77e-04 -4.94e-04  1.12e-04
# SandyBar_2018 - WinnipegRiver_2017     -2.55e-04 -5.62e-04  1.86e-05
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C14_2, ~ Site_Year)) #### That's the one!!!!!!
test2_C14_2_yr_plot<- plot(emmeans(test2_C14_2, ~ Site_Year)) #### That's the one!!!!!!
test2_C14_2_yr_plot
ggsave("test2_C14_2_yr_plot.png")
plot(emmeans(test2_C14_2, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C14_2, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C14_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C14_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C14_2.rda")
C14_2_tets2_plot <- gather_emmeans_draws(emmeans(test2_C14_2, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C14_2_tets2_plot.png")
library(repmod)
library(report)
report(test2_C14_2)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C14_2, file = "test2_C14_2.RDA")

#### test 2 C14_1 simple model ####
test2_C14_1<- brm(data=carn_dataf,
                  family = student(),
                  bf(C14_1~ Site_Year + Sex,
                     sigma ~ Site_Year + Sex),
                  prior = c(prior(normal(0,0.002), class = b),
                            prior(normal(0,0.002), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C14_1)
pp_check(test2_C14_1, ndraws = 100) +
  theme_bw()
summary(test2_C14_1)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C14_1 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    49876
# sigma_Intercept                      -8.03      0.34    -8.70    -7.36 1.00    10853
# Site_YearDauphinRiver_2018            0.00      0.00     0.00     0.00 1.00    58275
# Site_YearMatheson_2017                0.00      0.00    -0.00     0.00 1.00    36334
# Site_YearMatheson_2018                0.00      0.00     0.00     0.00 1.00    55000
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    58541
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    56995
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    40915
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    45762
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    54210
# SexM                                 -0.00      0.00    -0.00     0.00 1.00    46127
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    63002
# sigma_Site_YearDauphinRiver_2018      0.36      0.46    -0.52     1.27 1.00    16377
# sigma_Site_YearMatheson_2017         -0.59      0.64    -1.80     0.71 1.00    20612
# sigma_Site_YearMatheson_2018         -0.30      0.42    -1.12     0.53 1.00    15130
# sigma_Site_YearRedRiver_2017          0.32      0.40    -0.46     1.11 1.00    15611
# sigma_Site_YearRedRiver_2018          0.96      0.42     0.15     1.81 1.00    13424
# sigma_Site_YearSandyBar_2017         -0.23      0.39    -0.98     0.55 1.00    13694
# sigma_Site_YearSandyBar_2018          0.30      0.43    -0.55     1.16 1.00    16729
# sigma_Site_YearWinnipegRiver_2017    -0.50      0.67    -1.75     0.92 1.00    22897
# sigma_SexM                           -0.61      0.29    -1.21    -0.05 1.00    24601
# sigma_SexUN                           0.28      0.47    -0.62     1.23 1.00    30671
# Tail_ESS
# Intercept                            37745
# sigma_Intercept                      18386
# Site_YearDauphinRiver_2018           43308
# Site_YearMatheson_2017               40514
# Site_YearMatheson_2018               45355
# Site_YearRedRiver_2017               48313
# Site_YearRedRiver_2018               44510
# Site_YearSandyBar_2017               38345
# Site_YearSandyBar_2018               40572
# Site_YearWinnipegRiver_2017          41661
# SexM                                 49760
# SexUN                                38819
# sigma_Site_YearDauphinRiver_2018     27437
# sigma_Site_YearMatheson_2017         22054
# sigma_Site_YearMatheson_2018         24258
# sigma_Site_YearRedRiver_2017         25847
# sigma_Site_YearRedRiver_2018         23592
# sigma_Site_YearSandyBar_2017         23051
# sigma_Site_YearSandyBar_2018         27453
# sigma_Site_YearWinnipegRiver_2017    27696
# sigma_SexM                           25835
# sigma_SexUN                          31675
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     3.17      2.04     1.57     7.00 1.00    16303    19460
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C14_1, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000747  0.000529  0.000988
# DauphinRiver_2018  0.001662  0.001347  0.001981
# Matheson_2017      0.000788  0.000540  0.001027
# Matheson_2018      0.001438  0.001226  0.001670
# RedRiver_2017      0.001474  0.001176  0.001816
# RedRiver_2018      0.002099  0.001647  0.002530
# SandyBar_2017      0.000826  0.000628  0.001024
# SandyBar_2018      0.001846  0.001591  0.002104
# WinnipegRiver_2017 0.001461  0.001084  0.001797
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_C14_1, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018  -9.17e-04 -1.26e-03 -5.42e-04
# DauphinRiver_2017 - Matheson_2017      -4.57e-05 -2.63e-04  2.40e-04
# DauphinRiver_2017 - Matheson_2018      -6.88e-04 -9.30e-04 -4.33e-04
# DauphinRiver_2017 - RedRiver_2017      -7.21e-04 -1.05e-03 -4.22e-04
# DauphinRiver_2017 - RedRiver_2018      -1.34e-03 -1.78e-03 -9.04e-04
# DauphinRiver_2017 - SandyBar_2017      -8.01e-05 -2.68e-04  1.46e-04
# DauphinRiver_2017 - SandyBar_2018      -1.10e-03 -1.34e-03 -8.15e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -7.09e-04 -1.05e-03 -3.22e-04
# DauphinRiver_2018 - Matheson_2017       8.76e-04  5.08e-04  1.26e-03
# DauphinRiver_2018 - Matheson_2018       2.28e-04 -1.37e-04  5.74e-04
# DauphinRiver_2018 - RedRiver_2017       1.90e-04 -2.44e-04  5.91e-04
# DauphinRiver_2018 - RedRiver_2018      -4.32e-04 -9.62e-04  7.90e-05
# DauphinRiver_2018 - SandyBar_2017       8.39e-04  4.99e-04  1.19e-03
# DauphinRiver_2018 - SandyBar_2018      -1.83e-04 -5.64e-04  1.98e-04
# DauphinRiver_2018 - WinnipegRiver_2017  2.07e-04 -2.26e-04  6.81e-04
# Matheson_2017 - Matheson_2018          -6.52e-04 -9.35e-04 -3.80e-04
# Matheson_2017 - RedRiver_2017          -6.88e-04 -1.05e-03 -3.58e-04
# Matheson_2017 - RedRiver_2018          -1.31e-03 -1.76e-03 -8.56e-04
# Matheson_2017 - SandyBar_2017          -3.68e-05 -2.73e-04  1.70e-04
# Matheson_2017 - SandyBar_2018          -1.06e-03 -1.34e-03 -7.90e-04
# Matheson_2017 - WinnipegRiver_2017     -6.75e-04 -1.04e-03 -2.73e-04
# Matheson_2018 - RedRiver_2017          -3.70e-05 -3.62e-04  2.69e-04
# Matheson_2018 - RedRiver_2018          -6.58e-04 -1.13e-03 -2.11e-04
# Matheson_2018 - SandyBar_2017           6.11e-04  3.89e-04  8.39e-04
# Matheson_2018 - SandyBar_2018          -4.09e-04 -6.94e-04 -1.14e-04
# Matheson_2018 - WinnipegRiver_2017     -2.27e-05 -3.45e-04  3.63e-04
# RedRiver_2017 - RedRiver_2018          -6.19e-04 -1.11e-03 -1.12e-04
# RedRiver_2017 - SandyBar_2017           6.48e-04  3.57e-04  9.70e-04
# RedRiver_2017 - SandyBar_2018          -3.73e-04 -7.12e-04 -1.51e-06
# RedRiver_2017 - WinnipegRiver_2017      1.67e-05 -3.77e-04  4.53e-04
# RedRiver_2018 - SandyBar_2017           1.27e-03  8.47e-04  1.71e-03
# RedRiver_2018 - SandyBar_2018           2.51e-04 -2.04e-04  7.15e-04
# RedRiver_2018 - WinnipegRiver_2017      6.42e-04  1.16e-04  1.17e-03
# SandyBar_2017 - SandyBar_2018          -1.02e-03 -1.26e-03 -7.76e-04
# SandyBar_2017 - WinnipegRiver_2017     -6.35e-04 -9.67e-04 -2.80e-04
# SandyBar_2018 - WinnipegRiver_2017      3.86e-04  1.44e-05  8.01e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C14_1, ~ Site_Year)) #### That's the one!!!!!!
test2_C14_1_yr_plot<- plot(emmeans(test2_C14_1, ~ Site_Year)) #### That's the one!!!!!!
test2_C14_1_yr_plot
ggsave("test2_C14_1_yr_plot.png")
plot(emmeans(test2_C14_1, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C14_1, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C14_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C14_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C14_1.rda")
C14_1_tets2_plot <- gather_emmeans_draws(emmeans(test2_C14_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C14_1OH_tets2_plot.png")
library(repmod)
library(report)
report(test2_C14_1)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C14_1, file = "test2_C14_1.RDA")

#### test 2 C14_1OH simple model ####
test2_C14_1OH<- brm(data=carn_dataf,
                    family = skew_normal,
                    bf(C14_1OH~ Site_Year + Sex,
                       sigma ~ Site_Year + Sex),
                    prior = c(prior(normal(0,0.0015), class = b),
                              prior(normal(0,0.0015), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C14_1OH)
pp_check(test2_C14_1OH, ndraws = 100) +
  theme_bw()
summary(test2_C14_1OH)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: C14_1OH ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    37178
# sigma_Intercept                      -7.66      0.19    -8.00    -7.26 1.00    15649
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    30349
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    34732
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    37607
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    39447
# Site_YearRedRiver_2018                0.00      0.00    -0.00     0.00 1.00    34199
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    35947
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    33207
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    51388
# SexM                                  0.00      0.00    -0.00     0.00 1.00    37515
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    41814
# sigma_Site_YearDauphinRiver_2018     -0.52      0.37    -1.20     0.26 1.00    17870
# sigma_Site_YearMatheson_2017         -0.89      0.47    -1.70     0.13 1.00    25257
# sigma_Site_YearMatheson_2018         -0.95      0.28    -1.49    -0.38 1.00    20259
# sigma_Site_YearRedRiver_2017         -0.21      0.27    -0.74     0.33 1.00    19871
# sigma_Site_YearRedRiver_2018         -0.18      0.29    -0.74     0.39 1.00    19838
# sigma_Site_YearSandyBar_2017         -0.41      0.27    -0.93     0.11 1.00    18523
# sigma_Site_YearSandyBar_2018         -0.37      0.30    -0.96     0.22 1.00    18742
# sigma_Site_YearWinnipegRiver_2017    -0.12      0.51    -1.01     1.01 1.00    24651
# sigma_SexM                           -0.14      0.19    -0.50     0.23 1.00    33823
# sigma_SexUN                           0.91      0.41     0.09     1.71 1.00    24435
# Tail_ESS
# Intercept                            37494
# sigma_Intercept                      21969
# Site_YearDauphinRiver_2018           39725
# Site_YearMatheson_2017               41007
# Site_YearMatheson_2018               40166
# Site_YearRedRiver_2017               40940
# Site_YearRedRiver_2018               42629
# Site_YearSandyBar_2017               40715
# Site_YearSandyBar_2018               40427
# Site_YearWinnipegRiver_2017          38159
# SexM                                 46060
# SexUN                                42188
# sigma_Site_YearDauphinRiver_2018     28508
# sigma_Site_YearMatheson_2017         28299
# sigma_Site_YearMatheson_2018         28435
# sigma_Site_YearRedRiver_2017         28462
# sigma_Site_YearRedRiver_2018         29454
# sigma_Site_YearSandyBar_2017         27238
# sigma_Site_YearSandyBar_2018         28066
# sigma_Site_YearWinnipegRiver_2017    26225
# sigma_SexM                           38858
# sigma_SexUN                          29718
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.96      1.55     2.49     8.61 1.00    28749    23184
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).
emmeans(test2_C14_1OH, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.001000  0.000754  0.001283
# DauphinRiver_2018  0.000585  0.000382  0.000814
# Matheson_2017      0.000798  0.000572  0.001083
# Matheson_2018      0.000617  0.000437  0.000827
# RedRiver_2017      0.001224  0.000998  0.001487
# RedRiver_2018      0.001003  0.000774  0.001265
# SandyBar_2017      0.000902  0.000703  0.001127
# SandyBar_2018      0.000866  0.000646  0.001110
# WinnipegRiver_2017 0.001602  0.001098  0.002220
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

pairs(emmeans(test2_C14_1OH, ~ Site_Year))
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.001000  0.000754  0.001283
# DauphinRiver_2018  0.000585  0.000382  0.000814
# Matheson_2017      0.000798  0.000572  0.001083
# Matheson_2018      0.000617  0.000437  0.000827
# RedRiver_2017      0.001224  0.000998  0.001487
# RedRiver_2018      0.001003  0.000774  0.001265
# SandyBar_2017      0.000902  0.000703  0.001127
# SandyBar_2018      0.000866  0.000646  0.001110
# WinnipegRiver_2017 0.001602  0.001098  0.002220
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
# > pairs(emmeans(test2_C14_1OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   4.21e-04  1.04e-04  7.24e-04
# DauphinRiver_2017 - Matheson_2017       1.99e-04 -9.52e-05  4.93e-04
# DauphinRiver_2017 - Matheson_2018       3.79e-04  1.50e-04  6.16e-04
# DauphinRiver_2017 - RedRiver_2017      -2.23e-04 -4.97e-04  6.04e-05
# DauphinRiver_2017 - RedRiver_2018      -3.94e-06 -2.86e-04  2.87e-04
# DauphinRiver_2017 - SandyBar_2017       9.69e-05 -1.52e-04  3.60e-04
# DauphinRiver_2017 - SandyBar_2018       1.30e-04 -1.45e-04  4.30e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -5.99e-04 -1.21e-03 -6.05e-05
# DauphinRiver_2018 - Matheson_2017      -2.23e-04 -5.32e-04  9.92e-05
# DauphinRiver_2018 - Matheson_2018      -4.81e-05 -2.75e-04  2.20e-04
# DauphinRiver_2018 - RedRiver_2017      -6.48e-04 -9.35e-04 -3.44e-04
# DauphinRiver_2018 - RedRiver_2018      -4.24e-04 -7.11e-04 -1.13e-04
# DauphinRiver_2018 - SandyBar_2017      -3.27e-04 -5.73e-04 -4.13e-05
# DauphinRiver_2018 - SandyBar_2018      -2.89e-04 -5.70e-04  1.32e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -1.02e-03 -1.65e-03 -4.69e-04
# Matheson_2017 - Matheson_2018           1.78e-04 -4.24e-05  4.33e-04
# Matheson_2017 - RedRiver_2017          -4.23e-04 -7.02e-04 -1.38e-04
# Matheson_2017 - RedRiver_2018          -2.03e-04 -4.76e-04  9.09e-05
# Matheson_2017 - SandyBar_2017          -1.04e-04 -3.49e-04  1.56e-04
# Matheson_2017 - SandyBar_2018          -7.00e-05 -3.45e-04  2.13e-04
# Matheson_2017 - WinnipegRiver_2017     -7.97e-04 -1.42e-03 -2.50e-04
# Matheson_2018 - RedRiver_2017          -6.02e-04 -8.21e-04 -3.95e-04
# Matheson_2018 - RedRiver_2018          -3.79e-04 -6.23e-04 -1.58e-04
# Matheson_2018 - SandyBar_2017          -2.80e-04 -4.66e-04 -9.66e-05
# Matheson_2018 - SandyBar_2018          -2.44e-04 -4.77e-04 -2.36e-05
# Matheson_2018 - WinnipegRiver_2017     -9.75e-04 -1.61e-03 -5.11e-04
# RedRiver_2017 - RedRiver_2018           2.21e-04 -4.70e-05  5.01e-04
# RedRiver_2017 - SandyBar_2017           3.21e-04  8.53e-05  5.65e-04
# RedRiver_2017 - SandyBar_2018           3.57e-04  8.77e-05  6.31e-04
# RedRiver_2017 - WinnipegRiver_2017     -3.74e-04 -1.03e-03  1.12e-04
# RedRiver_2018 - SandyBar_2017           9.82e-05 -1.36e-04  3.48e-04
# RedRiver_2018 - SandyBar_2018           1.34e-04 -1.27e-04  3.95e-04
# RedRiver_2018 - WinnipegRiver_2017     -5.98e-04 -1.23e-03 -8.03e-05
# SandyBar_2017 - SandyBar_2018           3.58e-05 -2.07e-04  2.63e-04
# SandyBar_2017 - WinnipegRiver_2017     -6.96e-04 -1.33e-03 -2.10e-04
# SandyBar_2018 - WinnipegRiver_2017     -7.32e-04 -1.36e-03 -2.16e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C14_1OH, ~ Site_Year)) #### That's the one!!!!!!
test2_C14_1OH_yr_plot<- plot(emmeans(test2_C14_1OH, ~ Site_Year)) #### That's the one!!!!!!
test2_C14_1OH_yr_plot
ggsave("test2_C14_1OH_yr_plot.png")
plot(emmeans(test2_C14_1OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C14_1OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C14_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C14_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C14_1OH.rda")
C14_1OH_tets2_plot <- gather_emmeans_draws(emmeans(test2_C14_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C14_1OH_tets2_plot.png")
library(repmod)
library(report)
report(test2_C14_1OH)

#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C14_1OH, file = "test2_C14_1OH.RDA")






#### test 2 C14 simple model ####
test2_C14<- brm(data=carn_dataf,
                family = student,
                bf(C14~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,0.0015), class = b),
                          prior(normal(0,0.0015), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C14)
pp_check(test2_C14, ndraws = 100) +
  theme_bw()
summary(test2_C14)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C14 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    58984
# sigma_Intercept                      -7.61      0.33    -8.26    -6.98 1.00     9926
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00    -0.00 1.00    63791
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    56238
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    61332
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    65144
# Site_YearRedRiver_2018                0.00      0.00    -0.00     0.00 1.00    59610
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    60659
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    53556
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    67595
# SexM                                 -0.00      0.00    -0.00     0.00 1.00    50505
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    54946
# sigma_Site_YearDauphinRiver_2018     -0.31      0.42    -1.11     0.53 1.00    15008
# sigma_Site_YearMatheson_2017         -0.83      0.53    -1.80     0.29 1.00    19886
# sigma_Site_YearMatheson_2018         -0.65      0.39    -1.39     0.14 1.00    13896
# sigma_Site_YearRedRiver_2017         -0.07      0.36    -0.76     0.65 1.00    14682
# sigma_Site_YearRedRiver_2018         -0.10      0.37    -0.81     0.65 1.00    14131
# sigma_Site_YearSandyBar_2017         -0.09      0.35    -0.77     0.62 1.00    13461
# sigma_Site_YearSandyBar_2018         -0.39      0.37    -1.10     0.35 1.00    14402
# sigma_Site_YearWinnipegRiver_2017    -0.16      0.60    -1.22     1.15 1.00    19210
# sigma_SexM                           -0.12      0.21    -0.54     0.30 1.00    37120
# sigma_SexUN                           0.62      0.54    -0.41     1.69 1.00    20249
# Tail_ESS
# Intercept                            37831
# sigma_Intercept                      17029
# Site_YearDauphinRiver_2018           45519
# Site_YearMatheson_2017               43755
# Site_YearMatheson_2018               41911
# Site_YearRedRiver_2017               46993
# Site_YearRedRiver_2018               47207
# Site_YearSandyBar_2017               44754
# Site_YearSandyBar_2018               43207
# Site_YearWinnipegRiver_2017          38161
# SexM                                 52279
# SexUN                                33397
# sigma_Site_YearDauphinRiver_2018     24982
# sigma_Site_YearMatheson_2017         28964
# sigma_Site_YearMatheson_2018         24056
# sigma_Site_YearRedRiver_2017         25691
# sigma_Site_YearRedRiver_2018         25084
# sigma_Site_YearSandyBar_2017         23498
# sigma_Site_YearSandyBar_2018         25001
# sigma_Site_YearWinnipegRiver_2017    26437
# sigma_SexM                           38998
# sigma_SexUN                          31566
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     6.81      6.12     2.26    24.42 1.00    15257    20054
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C14, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.001171  0.000863  0.001542
# DauphinRiver_2018  0.000633  0.000351  0.000955
# Matheson_2017      0.001013  0.000715  0.001329
# Matheson_2018      0.000746  0.000501  0.001006
# RedRiver_2017      0.001521  0.001201  0.001883
# RedRiver_2018      0.001366  0.001057  0.001700
# SandyBar_2017      0.001453  0.001153  0.001763
# SandyBar_2018      0.001126  0.000869  0.001402
# WinnipegRiver_2017 0.002050  0.001415  0.002653
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_C14, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   5.40e-04  1.51e-04  9.19e-04
# DauphinRiver_2017 - Matheson_2017       1.63e-04 -1.90e-04  5.34e-04
# DauphinRiver_2017 - Matheson_2018       4.29e-04  1.07e-04  7.60e-04
# DauphinRiver_2017 - RedRiver_2017      -3.45e-04 -7.19e-04  3.65e-05
# DauphinRiver_2017 - RedRiver_2018      -1.90e-04 -5.63e-04  1.78e-04
# DauphinRiver_2017 - SandyBar_2017      -2.77e-04 -6.25e-04  9.15e-05
# DauphinRiver_2017 - SandyBar_2018       4.72e-05 -2.79e-04  4.02e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -8.67e-04 -1.51e-03 -2.25e-04
# DauphinRiver_2018 - Matheson_2017      -3.76e-04 -7.57e-04 -2.34e-05
# DauphinRiver_2018 - Matheson_2018      -1.12e-04 -4.21e-04  2.05e-04
# DauphinRiver_2018 - RedRiver_2017      -8.88e-04 -1.26e-03 -5.14e-04
# DauphinRiver_2018 - RedRiver_2018      -7.30e-04 -1.11e-03 -3.49e-04
# DauphinRiver_2018 - SandyBar_2017      -8.16e-04 -1.18e-03 -4.66e-04
# DauphinRiver_2018 - SandyBar_2018      -4.89e-04 -8.35e-04 -1.46e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -1.41e-03 -2.04e-03 -7.51e-04
# Matheson_2017 - Matheson_2018           2.66e-04 -4.09e-05  5.74e-04
# Matheson_2017 - RedRiver_2017          -5.10e-04 -8.83e-04 -1.47e-04
# Matheson_2017 - RedRiver_2018          -3.54e-04 -7.12e-04  7.60e-07
# Matheson_2017 - SandyBar_2017          -4.41e-04 -7.79e-04 -9.90e-05
# Matheson_2017 - SandyBar_2018          -1.15e-04 -4.27e-04  2.04e-04
# Matheson_2017 - WinnipegRiver_2017     -1.04e-03 -1.65e-03 -3.69e-04
# Matheson_2018 - RedRiver_2017          -7.75e-04 -1.09e-03 -4.61e-04
# Matheson_2018 - RedRiver_2018          -6.18e-04 -9.52e-04 -2.95e-04
# Matheson_2018 - SandyBar_2017          -7.05e-04 -1.00e-03 -4.14e-04
# Matheson_2018 - SandyBar_2018          -3.80e-04 -6.59e-04 -9.05e-05
# Matheson_2018 - WinnipegRiver_2017     -1.30e-03 -1.89e-03 -6.64e-04
# RedRiver_2017 - RedRiver_2018           1.57e-04 -2.12e-04  5.50e-04
# RedRiver_2017 - SandyBar_2017           6.94e-05 -2.76e-04  4.43e-04
# RedRiver_2017 - SandyBar_2018           3.97e-04  4.63e-05  7.45e-04
# RedRiver_2017 - WinnipegRiver_2017     -5.21e-04 -1.14e-03  1.41e-04
# RedRiver_2018 - SandyBar_2017          -8.57e-05 -4.43e-04  2.67e-04
# RedRiver_2018 - SandyBar_2018           2.39e-04 -9.06e-05  5.61e-04
# RedRiver_2018 - WinnipegRiver_2017     -6.78e-04 -1.31e-03 -1.74e-05
# SandyBar_2017 - SandyBar_2018           3.27e-04  1.21e-05  6.40e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.94e-04 -1.22e-03  4.52e-05
# SandyBar_2018 - WinnipegRiver_2017     -9.20e-04 -1.54e-03 -2.87e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
plot(emmeans(test2_C14, ~ Site_Year)) #### That's the one!!!!!!
test2_C14_yr_plot<- plot(emmeans(test2_C14, ~ Site_Year)) #### That's the one!!!!!!
test2_C14_yr_plot
ggsave("test2_C14_yr_plot.png")
plot(emmeans(test2_C14, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C14, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C14, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C14, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C14.rda")
C14_tets2_plot <- gather_emmeans_draws(emmeans(test2_C14, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C14_tets1_plot.png")
library(repmod)
library(report)
report(test2_C14)

#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C14, file = "test2_C14.RDA")

#### test 2 C16_1 simple model ####
test2_C16_1<- brm(data=carn_dataf,
                  family = student,
                  bf(C16_1~ Site_Year + Sex,
                     sigma ~ Site_Year + Sex),
                  prior = c(prior(normal(0,0.003), class = b),
                            prior(normal(0,0.003), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C16_1)
pp_check(test2_C16_1, ndraws = 100) +
  theme_bw()
summary(test2_C16_1)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C16_1 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    30843
# sigma_Intercept                      -6.93      0.36    -7.66    -6.26 1.00    10444
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    43103
# Site_YearMatheson_2017                0.00      0.00    -0.00     0.00 1.00    30690
# Site_YearMatheson_2018                0.00      0.00    -0.00     0.00 1.00    34315
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    49028
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    51279
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    35945
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    38703
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    43367
# SexM                                  0.00      0.00    -0.00     0.00 1.00    47897
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    68868
# sigma_Site_YearDauphinRiver_2018     -0.34      0.47    -1.23     0.60 1.00    16750
# sigma_Site_YearMatheson_2017         -1.21      0.63    -2.39     0.10 1.00    20824
# sigma_Site_YearMatheson_2018         -0.70      0.42    -1.48     0.16 1.00    15325
# sigma_Site_YearRedRiver_2017          0.15      0.39    -0.60     0.95 1.00    15104
# sigma_Site_YearRedRiver_2018          0.37      0.41    -0.40     1.19 1.00    13950
# sigma_Site_YearSandyBar_2017         -0.52      0.39    -1.27     0.26 1.00    15222
# sigma_Site_YearSandyBar_2018          0.08      0.41    -0.70     0.89 1.00    16380
# sigma_Site_YearWinnipegRiver_2017     0.02      0.68    -1.24     1.44 1.00    20601
# sigma_SexM                            0.01      0.24    -0.48     0.49 1.00    33748
# sigma_SexUN                           0.05      0.58    -1.03     1.24 1.00    20732
# Tail_ESS
# Intercept                            29652
# sigma_Intercept                      17803
# Site_YearDauphinRiver_2018           38463
# Site_YearMatheson_2017               31233
# Site_YearMatheson_2018               32446
# Site_YearRedRiver_2017               39361
# Site_YearRedRiver_2018               41881
# Site_YearSandyBar_2017               32317
# Site_YearSandyBar_2018               37087
# Site_YearWinnipegRiver_2017          29741
# SexM                                 47304
# SexUN                                32742
# sigma_Site_YearDauphinRiver_2018     27284
# sigma_Site_YearMatheson_2017         28208
# sigma_Site_YearMatheson_2018         22696
# sigma_Site_YearRedRiver_2017         27731
# sigma_Site_YearRedRiver_2018         25430
# sigma_Site_YearSandyBar_2017         25077
# sigma_Site_YearSandyBar_2018         27157
# sigma_Site_YearWinnipegRiver_2017    25071
# sigma_SexM                           35340
# sigma_SexUN                          26263
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     3.78      3.35     1.60    11.17 1.00    15449    14703
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C16_1, ~ Site_Year)
# Site_Year           emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.00186  0.001249   0.00265
# DauphinRiver_2018  0.00144  0.000955   0.00196
# Matheson_2017      0.00200  0.001542   0.00247
# Matheson_2018      0.00207  0.001681   0.00248
# RedRiver_2017      0.00396  0.003204   0.00475
# RedRiver_2018      0.00412  0.003177   0.00515
# SandyBar_2017      0.00224  0.001829   0.00269
# SandyBar_2018      0.00342  0.002668   0.00411
# WinnipegRiver_2017 0.00446  0.002659   0.00577
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_C16_1, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   0.000434 -0.000324  1.28e-03
# DauphinRiver_2017 - Matheson_2017      -0.000132 -0.000823  7.26e-04
# DauphinRiver_2017 - Matheson_2018      -0.000195 -0.000881  5.94e-04
# DauphinRiver_2017 - RedRiver_2017      -0.002074 -0.003008 -1.12e-03
# DauphinRiver_2017 - RedRiver_2018      -0.002226 -0.003337 -1.04e-03
# DauphinRiver_2017 - SandyBar_2017      -0.000372 -0.001058  3.81e-04
# DauphinRiver_2017 - SandyBar_2018      -0.001537 -0.002433 -5.53e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -0.002562 -0.004045 -7.45e-04
# DauphinRiver_2018 - Matheson_2017      -0.000559 -0.001197  1.08e-04
# DauphinRiver_2018 - Matheson_2018      -0.000630 -0.001166 -3.71e-05
# DauphinRiver_2018 - RedRiver_2017      -0.002520 -0.003387 -1.67e-03
# DauphinRiver_2018 - RedRiver_2018      -0.002673 -0.003787 -1.62e-03
# DauphinRiver_2018 - SandyBar_2017      -0.000802 -0.001396 -1.94e-04
# DauphinRiver_2018 - SandyBar_2018      -0.001977 -0.002800 -1.09e-03
# DauphinRiver_2018 - WinnipegRiver_2017 -0.003015 -0.004423 -1.21e-03
# Matheson_2017 - Matheson_2018          -0.000067 -0.000607  4.71e-04
# Matheson_2017 - RedRiver_2017          -0.001962 -0.002792 -1.13e-03
# Matheson_2017 - RedRiver_2018          -0.002118 -0.003144 -1.06e-03
# Matheson_2017 - SandyBar_2017          -0.000241 -0.000792  2.71e-04
# Matheson_2017 - SandyBar_2018          -0.001414 -0.002212 -6.14e-04
# Matheson_2017 - WinnipegRiver_2017     -0.002460 -0.003885 -7.12e-04
# Matheson_2018 - RedRiver_2017          -0.001892 -0.002690 -1.12e-03
# Matheson_2018 - RedRiver_2018          -0.002051 -0.003059 -1.00e-03
# Matheson_2018 - SandyBar_2017          -0.000177 -0.000671  2.94e-04
# Matheson_2018 - SandyBar_2018          -0.001352 -0.002109 -5.49e-04
# Matheson_2018 - WinnipegRiver_2017     -0.002395 -0.003779 -6.48e-04
# RedRiver_2017 - RedRiver_2018          -0.000154 -0.001347  1.06e-03
# RedRiver_2017 - SandyBar_2017           0.001715  0.000943  2.51e-03
# RedRiver_2017 - SandyBar_2018           0.000543 -0.000438  1.58e-03
# RedRiver_2017 - WinnipegRiver_2017     -0.000483 -0.002037  1.35e-03
# RedRiver_2018 - SandyBar_2017           0.001872  0.000842  2.87e-03
# RedRiver_2018 - SandyBar_2018           0.000705 -0.000440  1.92e-03
# RedRiver_2018 - WinnipegRiver_2017     -0.000314 -0.002029  1.58e-03
# SandyBar_2017 - SandyBar_2018          -0.001173 -0.001916 -3.56e-04
# SandyBar_2017 - WinnipegRiver_2017     -0.002215 -0.003643 -5.02e-04
# SandyBar_2018 - WinnipegRiver_2017     -0.001034 -0.002518  8.60e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C16_1, ~ Site_Year)) #### That's the one!!!!!!
test2_C16_1_yr_plot<- plot(emmeans(test2_C16_1, ~ Site_Year)) #### That's the one!!!!!!
test2_C16_1_yr_plot
ggsave("test2_C16_1_yr_plot.png")
plot(emmeans(test2_C16_1, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C16_1, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C16_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C16_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C16_1.rda")
C16_1_tets2_plot <- gather_emmeans_draws(emmeans(test2_C16_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16_1_tets2_plot.png")
library(repmod)
library(report)
report(test2_C16_1)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C16_1, file = "test2_C16_1.RDA")


#### test 2 C16_1OH simple model ####
test2_C16_1OH<- brm(data=carn_dataf,
                    family = skew_normal,
                    bf(C16_1OH~ Site_Year + Sex,
                       sigma ~ Site_Year + Sex),
                    prior = c(prior(normal(0,0.001), class = b),
                              prior(normal(0,0.001), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C16_1OH)
pp_check(test2_C16_1OH, ndraws = 100) +
  theme_bw()
summary(test2_C16_1OH)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: C16_1OH ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    49610
# sigma_Intercept                      -7.82      0.20    -8.19    -7.40 1.00    16472
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    38570
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    41372
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    50961
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    47770
# Site_YearRedRiver_2018                0.00      0.00    -0.00     0.00 1.00    35848
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    42863
# Site_YearSandyBar_2018                0.00      0.00    -0.00     0.00 1.00    37358
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    64681
# SexM                                  0.00      0.00    -0.00     0.00 1.00    32181
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    50213
# sigma_Site_YearDauphinRiver_2018     -0.24      0.38    -0.94     0.54 1.00    20405
# sigma_Site_YearMatheson_2017         -0.45      0.46    -1.26     0.54 1.00    25508
# sigma_Site_YearMatheson_2018         -0.90      0.30    -1.48    -0.31 1.00    20194
# sigma_Site_YearRedRiver_2017         -0.17      0.28    -0.72     0.38 1.00    18837
# sigma_Site_YearRedRiver_2018         -0.16      0.32    -0.77     0.48 1.00    17909
# sigma_Site_YearSandyBar_2017         -0.23      0.27    -0.77     0.31 1.00    18577
# sigma_Site_YearSandyBar_2018          0.05      0.32    -0.58     0.70 1.00    17602
# sigma_Site_YearWinnipegRiver_2017     0.33      0.50    -0.52     1.44 1.00    24172
# sigma_SexM                           -0.13      0.21    -0.54     0.29 1.00    31913
# sigma_SexUN                           0.62      0.41    -0.18     1.44 1.00    29413
# Tail_ESS
# Intercept                            43411
# sigma_Intercept                      22994
# Site_YearDauphinRiver_2018           45625
# Site_YearMatheson_2017               45613
# Site_YearMatheson_2018               46188
# Site_YearRedRiver_2017               47317
# Site_YearRedRiver_2018               44548
# Site_YearSandyBar_2017               46797
# Site_YearSandyBar_2018               47103
# Site_YearWinnipegRiver_2017          36259
# SexM                                 44319
# SexUN                                41371
# sigma_Site_YearDauphinRiver_2018     32671
# sigma_Site_YearMatheson_2017         31104
# sigma_Site_YearMatheson_2018         29260
# sigma_Site_YearRedRiver_2017         28467
# sigma_Site_YearRedRiver_2018         27776
# sigma_Site_YearSandyBar_2017         28977
# sigma_Site_YearSandyBar_2018         28300
# sigma_Site_YearWinnipegRiver_2017    25246
# sigma_SexM                           38907
# sigma_SexUN                          36981
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     3.32      1.43     0.85     6.57 1.00    27273    24422
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C16_1OH, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000933  0.000724  0.001170
# DauphinRiver_2018  0.000660  0.000456  0.000882
# Matheson_2017      0.000806  0.000559  0.001120
# Matheson_2018      0.000707  0.000566  0.000873
# RedRiver_2017      0.001197  0.001003  0.001411
# RedRiver_2018      0.001065  0.000867  0.001291
# SandyBar_2017      0.000917  0.000739  0.001112
# SandyBar_2018      0.001027  0.000797  0.001294
# WinnipegRiver_2017 0.001474  0.000872  0.002172
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_C16_1OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   2.76e-04 -2.47e-05  5.55e-04
# DauphinRiver_2017 - Matheson_2017       1.24e-04 -1.90e-04  4.42e-04
# DauphinRiver_2017 - Matheson_2018       2.24e-04  1.15e-05  4.34e-04
# DauphinRiver_2017 - RedRiver_2017      -2.64e-04 -5.15e-04 -2.26e-05
# DauphinRiver_2017 - RedRiver_2018      -1.36e-04 -4.05e-04  1.39e-04
# DauphinRiver_2017 - SandyBar_2017       1.42e-05 -2.14e-04  2.57e-04
# DauphinRiver_2017 - SandyBar_2018      -9.66e-05 -4.00e-04  2.10e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -5.39e-04 -1.22e-03  9.21e-05
# DauphinRiver_2018 - Matheson_2017      -1.51e-04 -4.88e-04  1.96e-04
# DauphinRiver_2018 - Matheson_2018      -5.64e-05 -2.71e-04  1.96e-04
# DauphinRiver_2018 - RedRiver_2017      -5.42e-04 -8.11e-04 -2.63e-04
# DauphinRiver_2018 - RedRiver_2018      -4.09e-04 -6.89e-04 -1.20e-04
# DauphinRiver_2018 - SandyBar_2017      -2.62e-04 -5.08e-04  1.04e-05
# DauphinRiver_2018 - SandyBar_2018      -3.70e-04 -6.84e-04 -5.61e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -8.14e-04 -1.50e-03 -1.54e-04
# Matheson_2017 - Matheson_2018           9.61e-05 -1.69e-04  3.92e-04
# Matheson_2017 - RedRiver_2017          -3.90e-04 -6.86e-04 -7.21e-05
# Matheson_2017 - RedRiver_2018          -2.60e-04 -5.63e-04  6.23e-05
# Matheson_2017 - SandyBar_2017          -1.11e-04 -3.90e-04  1.97e-04
# Matheson_2017 - SandyBar_2018          -2.20e-04 -5.54e-04  1.24e-04
# Matheson_2017 - WinnipegRiver_2017     -6.61e-04 -1.38e-03  9.97e-06
# Matheson_2018 - RedRiver_2017          -4.87e-04 -6.85e-04 -2.99e-04
# Matheson_2018 - RedRiver_2018          -3.54e-04 -5.91e-04 -1.39e-04
# Matheson_2018 - SandyBar_2017          -2.07e-04 -3.92e-04 -3.39e-05
# Matheson_2018 - SandyBar_2018          -3.16e-04 -5.89e-04 -6.50e-05
# Matheson_2018 - WinnipegRiver_2017     -7.63e-04 -1.43e-03 -1.49e-04
# RedRiver_2017 - RedRiver_2018           1.32e-04 -1.29e-04  3.74e-04
# RedRiver_2017 - SandyBar_2017           2.80e-04  5.74e-05  4.98e-04
# RedRiver_2017 - SandyBar_2018           1.71e-04 -1.18e-04  4.53e-04
# RedRiver_2017 - WinnipegRiver_2017     -2.74e-04 -9.84e-04  3.37e-04
# RedRiver_2018 - SandyBar_2017           1.48e-04 -8.46e-05  3.83e-04
# RedRiver_2018 - SandyBar_2018           3.93e-05 -2.37e-04  3.13e-04
# RedRiver_2018 - WinnipegRiver_2017     -4.06e-04 -1.11e-03  2.21e-04
# SandyBar_2017 - SandyBar_2018          -1.10e-04 -3.84e-04  1.55e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.54e-04 -1.24e-03  6.52e-05
# SandyBar_2018 - WinnipegRiver_2017     -4.45e-04 -1.14e-03  2.17e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C16_1OH, ~ Site_Year)) #### That's the one!!!!!!
test2_C16_1OH_yr_plot<- plot(emmeans(test2_C16_1OH, ~ Site_Year)) #### That's the one!!!!!!
test2_C16_1OH_yr_plot
ggsave("test2_C16_1OH_yr_plot.png")
plot(emmeans(test2_C16_1OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C16_1OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C16_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C16_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C16_1OH.rda")
C16_1OH_tets2_plot <- gather_emmeans_draws(emmeans(test2_C16_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16_1OH_tets2_plot.png")
library(repmod)
library(report)
report(test2_C16_1OH)

#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C16_1OH, file = "test2_C16_1OH.RDA")







#### test 2 C16 simple model ####
test2_C16<- brm(data=carn_dataf,
                family = skew_normal,
                bf(C16~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,0.002), class = b),
                          prior(normal(0,0.002), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C16)
pp_check(test2_C16, ndraws = 100) +
  theme_bw()
summary(test2_C16)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: C16 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    37229
# sigma_Intercept                      -6.96      0.20    -7.32    -6.53 1.00    15695
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    34085
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    35785
# Site_YearMatheson_2018                0.00      0.00    -0.00     0.00 1.00    44943
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    43129
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    34712
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    34113
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    31860
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    51254
# SexM                                  0.00      0.00    -0.00     0.00 1.00    31750
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    49929
# sigma_Site_YearDauphinRiver_2018     -0.01      0.38    -0.73     0.75 1.00    19009
# sigma_Site_YearMatheson_2017         -0.41      0.46    -1.22     0.59 1.00    23280
# sigma_Site_YearMatheson_2018         -0.04      0.28    -0.60     0.52 1.00    19595
# sigma_Site_YearRedRiver_2017          0.17      0.27    -0.38     0.70 1.00    18641
# sigma_Site_YearRedRiver_2018          0.30      0.30    -0.29     0.88 1.00    18258
# sigma_Site_YearSandyBar_2017          0.03      0.28    -0.52     0.57 1.00    18140
# sigma_Site_YearSandyBar_2018          0.36      0.31    -0.26     0.96 1.00    17614
# sigma_Site_YearWinnipegRiver_2017     0.09      0.49    -0.77     1.16 1.00    23688
# sigma_SexM                           -0.01      0.19    -0.38     0.38 1.00    31355
# sigma_SexUN                           0.81      0.39     0.04     1.58 1.00    27664
# Tail_ESS
# Intercept                            34492
# sigma_Intercept                      20238
# Site_YearDauphinRiver_2018           41353
# Site_YearMatheson_2017               38511
# Site_YearMatheson_2018               43130
# Site_YearRedRiver_2017               44314
# Site_YearRedRiver_2018               39375
# Site_YearSandyBar_2017               37138
# Site_YearSandyBar_2018               41022
# Site_YearWinnipegRiver_2017          38197
# SexM                                 43323
# SexUN                                42509
# sigma_Site_YearDauphinRiver_2018     29383
# sigma_Site_YearMatheson_2017         25883
# sigma_Site_YearMatheson_2018         26372
# sigma_Site_YearRedRiver_2017         27456
# sigma_Site_YearRedRiver_2018         26585
# sigma_Site_YearSandyBar_2017         25016
# sigma_Site_YearSandyBar_2018         25471
# sigma_Site_YearWinnipegRiver_2017    25969
# sigma_SexM                           37826
# sigma_SexUN                          34811
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     5.23      1.84     2.47     9.58 1.00    28201    24050
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C16, ~ Site_Year)
# Site_Year           emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.00200   0.00139   0.00271
# DauphinRiver_2018  0.00176   0.00110   0.00248
# Matheson_2017      0.00185   0.00111   0.00275
# Matheson_2018      0.00238   0.00173   0.00312
# RedRiver_2017      0.00328   0.00258   0.00403
# RedRiver_2018      0.00347   0.00272   0.00432
# SandyBar_2017      0.00265   0.00202   0.00333
# SandyBar_2018      0.00300   0.00218   0.00390
# WinnipegRiver_2017 0.00290   0.00170   0.00432
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
pairs(emmeans(test2_C16, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   0.000267 -6.00e-04  1.06e-03
# DauphinRiver_2017 - Matheson_2017       0.000146 -7.17e-04  9.42e-04
# DauphinRiver_2017 - Matheson_2018      -0.000379 -1.06e-03  3.06e-04
# DauphinRiver_2017 - RedRiver_2017      -0.001271 -1.98e-03 -5.72e-04
# DauphinRiver_2017 - RedRiver_2018      -0.001469 -2.31e-03 -6.57e-04
# DauphinRiver_2017 - SandyBar_2017      -0.000645 -1.29e-03  1.75e-05
# DauphinRiver_2017 - SandyBar_2018      -0.001003 -1.94e-03 -1.12e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -0.000888 -2.27e-03  3.08e-04
# DauphinRiver_2018 - Matheson_2017      -0.000113 -1.11e-03  8.88e-04
# DauphinRiver_2018 - Matheson_2018      -0.000643 -1.46e-03  2.64e-04
# DauphinRiver_2018 - RedRiver_2017      -0.001535 -2.39e-03 -6.10e-04
# DauphinRiver_2018 - RedRiver_2018      -0.001725 -2.65e-03 -7.32e-04
# DauphinRiver_2018 - SandyBar_2017      -0.000908 -1.70e-03 -3.98e-05
# DauphinRiver_2018 - SandyBar_2018      -0.001251 -2.31e-03 -2.42e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -0.001152 -2.58e-03  2.46e-04
# Matheson_2017 - Matheson_2018          -0.000528 -1.35e-03  3.93e-04
# Matheson_2017 - RedRiver_2017          -0.001419 -2.26e-03 -4.83e-04
# Matheson_2017 - RedRiver_2018          -0.001615 -2.57e-03 -6.57e-04
# Matheson_2017 - SandyBar_2017          -0.000795 -1.58e-03  7.77e-05
# Matheson_2017 - SandyBar_2018          -0.001146 -2.18e-03 -1.41e-04
# Matheson_2017 - WinnipegRiver_2017     -0.001034 -2.53e-03  3.09e-04
# Matheson_2018 - RedRiver_2017          -0.000891 -1.65e-03 -1.30e-04
# Matheson_2018 - RedRiver_2018          -0.001083 -1.98e-03 -2.29e-04
# Matheson_2018 - SandyBar_2017          -0.000262 -9.54e-04  4.51e-04
# Matheson_2018 - SandyBar_2018          -0.000616 -1.59e-03  3.17e-04
# Matheson_2018 - WinnipegRiver_2017     -0.000513 -1.93e-03  7.09e-04
# RedRiver_2017 - RedRiver_2018          -0.000195 -1.07e-03  6.94e-04
# RedRiver_2017 - SandyBar_2017           0.000628 -1.06e-04  1.33e-03
# RedRiver_2017 - SandyBar_2018           0.000272 -6.95e-04  1.22e-03
# RedRiver_2017 - WinnipegRiver_2017      0.000381 -1.05e-03  1.62e-03
# RedRiver_2018 - SandyBar_2017           0.000820  3.07e-05  1.65e-03
# RedRiver_2018 - SandyBar_2018           0.000468 -5.12e-04  1.43e-03
# RedRiver_2018 - WinnipegRiver_2017      0.000571 -9.16e-04  1.89e-03
# SandyBar_2017 - SandyBar_2018          -0.000354 -1.28e-03  4.77e-04
# SandyBar_2017 - WinnipegRiver_2017     -0.000245 -1.65e-03  9.62e-04
# SandyBar_2018 - WinnipegRiver_2017      0.000102 -1.38e-03  1.52e-03
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C16, ~ Site_Year)) #### That's the one!!!!!!
test2_C16_yr_plot<- plot(emmeans(test2_C16, ~ Site_Year)) #### That's the one!!!!!!
test2_C16_yr_plot
ggsave("test2_C16_yr_plot.png")
plot(emmeans(test2_C16, ~ Sex*Site_Year))
plot(pairs(emmeans(test6_C14, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C16, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C16, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C16.rda")
C16_tets2_plot <- gather_emmeans_draws(emmeans(test2_C16, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C16_tets2_plot.png")
library(repmod)
library(report)
report(test2_C16)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C16, file = "test2_C16.RDA")


#### test 2 C18_1 simple model ####
test2_C18_1<- brm(data=carn_dataf,
                  family = skew_normal,
                  bf(C18_1~ Site_Year + Sex,
                     sigma ~ Site_Year + Sex),
                  prior = c(prior(normal(0,0.004), class = b),
                            prior(normal(0,0.004), class = Intercept)),
                  iter = 20000, warmup = 5000, chains = 4, cores = 4,
                  control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C18_1)
pp_check(test2_C18_1, ndraws = 100) +
  theme_bw()
summary(test2_C18_1)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: C18_1 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    31383
# sigma_Intercept                      -6.43      0.20    -6.79    -6.02 1.00    15575
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    31068
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    31454
# Site_YearMatheson_2018                0.00      0.00    -0.00     0.00 1.00    37164
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    36514
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    33332
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    30921
# Site_YearSandyBar_2018                0.00      0.00    -0.00     0.00 1.00    32884
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    38159
# SexM                                  0.00      0.00    -0.00     0.00 1.00    42529
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    49813
# sigma_Site_YearDauphinRiver_2018     -0.39      0.39    -1.10     0.41 1.00    18868
# sigma_Site_YearMatheson_2017         -0.84      0.47    -1.65     0.18 1.00    26188
# sigma_Site_YearMatheson_2018         -0.41      0.29    -0.97     0.15 1.00    20481
# sigma_Site_YearRedRiver_2017          0.20      0.27    -0.34     0.73 1.00    19008
# sigma_Site_YearRedRiver_2018          0.04      0.28    -0.52     0.60 1.00    19581
# sigma_Site_YearSandyBar_2017         -0.36      0.27    -0.89     0.16 1.00    18958
# sigma_Site_YearSandyBar_2018          0.13      0.29    -0.44     0.72 1.00    18776
# sigma_Site_YearWinnipegRiver_2017    -0.01      0.50    -0.88     1.08 1.00    22476
# sigma_SexM                           -0.01      0.18    -0.35     0.35 1.00    35518
# sigma_SexUN                           0.93      0.42     0.10     1.74 1.00    25572
# Tail_ESS
# Intercept                            30835
# sigma_Intercept                      21386
# Site_YearDauphinRiver_2018           36947
# Site_YearMatheson_2017               34117
# Site_YearMatheson_2018               35959
# Site_YearRedRiver_2017               41167
# Site_YearRedRiver_2018               37921
# Site_YearSandyBar_2017               33628
# Site_YearSandyBar_2018               36522
# Site_YearWinnipegRiver_2017          30150
# SexM                                 48238
# SexUN                                36914
# sigma_Site_YearDauphinRiver_2018     28798
# sigma_Site_YearMatheson_2017         29916
# sigma_Site_YearMatheson_2018         28684
# sigma_Site_YearRedRiver_2017         28816
# sigma_Site_YearRedRiver_2018         28190
# sigma_Site_YearSandyBar_2017         27338
# sigma_Site_YearSandyBar_2018         27612
# sigma_Site_YearWinnipegRiver_2017    26053
# sigma_SexM                           38984
# sigma_SexUN                          32257
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     4.46      1.57     2.09     8.24 1.00    30467    23108
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C18_1, ~ Site_Year)
# Site_Year           emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.00314   0.00218   0.00423
# DauphinRiver_2018  0.00231   0.00148   0.00327
# Matheson_2017      0.00262   0.00171   0.00372
# Matheson_2018      0.00316   0.00233   0.00413
# RedRiver_2017      0.00551   0.00444   0.00672
# RedRiver_2018      0.00536   0.00433   0.00650
# SandyBar_2017      0.00332   0.00252   0.00419
# SandyBar_2018      0.00431   0.00324   0.00557
# WinnipegRiver_2017 0.00520   0.00335   0.00750
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

pairs(emmeans(test2_C18_1, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   8.43e-04 -0.000355  1.93e-03
# DauphinRiver_2017 - Matheson_2017       5.17e-04 -0.000598  1.64e-03
# DauphinRiver_2017 - Matheson_2018      -2.74e-05 -0.001002  1.01e-03
# DauphinRiver_2017 - RedRiver_2017      -2.36e-03 -0.003613 -1.16e-03
# DauphinRiver_2017 - RedRiver_2018      -2.22e-03 -0.003396 -1.04e-03
# DauphinRiver_2017 - SandyBar_2017      -1.91e-04 -0.001093  7.90e-04
# DauphinRiver_2017 - SandyBar_2018      -1.17e-03 -0.002501  1.09e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -2.05e-03 -0.004257 -6.05e-05
# DauphinRiver_2018 - Matheson_2017      -3.27e-04 -0.001441  8.93e-04
# DauphinRiver_2018 - Matheson_2018      -8.79e-04 -0.001879  1.97e-04
# DauphinRiver_2018 - RedRiver_2017      -3.20e-03 -0.004445 -1.90e-03
# DauphinRiver_2018 - RedRiver_2018      -3.06e-03 -0.004300 -1.84e-03
# DauphinRiver_2018 - SandyBar_2017      -1.04e-03 -0.001930  3.85e-05
# DauphinRiver_2018 - SandyBar_2018      -2.01e-03 -0.003320 -6.84e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -2.89e-03 -0.005146 -8.82e-04
# Matheson_2017 - Matheson_2018          -5.51e-04 -0.001553  5.21e-04
# Matheson_2017 - RedRiver_2017          -2.88e-03 -0.004144 -1.67e-03
# Matheson_2017 - RedRiver_2018          -2.73e-03 -0.003906 -1.56e-03
# Matheson_2017 - SandyBar_2017          -7.11e-04 -0.001616  2.64e-04
# Matheson_2017 - SandyBar_2018          -1.68e-03 -0.002969 -4.13e-04
# Matheson_2017 - WinnipegRiver_2017     -2.56e-03 -0.004912 -6.01e-04
# Matheson_2018 - RedRiver_2017          -2.33e-03 -0.003469 -1.18e-03
# Matheson_2018 - RedRiver_2018          -2.18e-03 -0.003338 -1.10e-03
# Matheson_2018 - SandyBar_2017          -1.52e-04 -0.001000  6.81e-04
# Matheson_2018 - SandyBar_2018          -1.14e-03 -0.002396  5.55e-05
# Matheson_2018 - WinnipegRiver_2017     -2.02e-03 -0.004319 -1.62e-04
# RedRiver_2017 - RedRiver_2018           1.46e-04 -0.001151  1.46e-03
# RedRiver_2017 - SandyBar_2017           2.17e-03  0.001104  3.26e-03
# RedRiver_2017 - SandyBar_2018           1.19e-03 -0.000225  2.56e-03
# RedRiver_2017 - WinnipegRiver_2017      3.10e-04 -0.002001  2.37e-03
# RedRiver_2018 - SandyBar_2017           2.03e-03  0.001015  3.06e-03
# RedRiver_2018 - SandyBar_2018           1.04e-03 -0.000321  2.35e-03
# RedRiver_2018 - WinnipegRiver_2017      1.64e-04 -0.002133  2.22e-03
# SandyBar_2017 - SandyBar_2018          -9.83e-04 -0.002176  1.03e-04
# SandyBar_2017 - WinnipegRiver_2017     -1.86e-03 -0.004155 -7.94e-05
# SandyBar_2018 - WinnipegRiver_2017     -8.76e-04 -0.003261  1.20e-03
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C18_1, ~ Site_Year)) #### That's the one!!!!!!
test2_C18_1_yr_plot<- plot(emmeans(test2_C18_1, ~ Site_Year)) #### That's the one!!!!!!
test2_C18_1_yr_plot
ggsave("test2_C18_1_yr_plot.png")
plot(emmeans(test2_C18_1, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C18_1, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C18_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C18_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C18_1.rda")
C18_1_tets2_plot <- gather_emmeans_draws(emmeans(test2_C18_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C18_1_tets2_plot.png")
library(repmod)
library(report)
report(test2_C18_1)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C18_1, file = "test2_c18_1.RDA")

#### test 2 C18_1OH simple model ####
test2_C18_1OH<- brm(data=carn_dataf,
                    family = student,
                    bf(C18_1OH~ Site_Year + Sex,
                       sigma ~ Site_Year + Sex),
                    prior = c(prior(normal(0,0.004), class = b),
                              prior(normal(0,0.004), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C18_1OH)
pp_check(test2_C18_1OH, ndraws = 100) +
  theme_bw()
summary(test2_C18_1OH)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C18_1OH ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    56056
# sigma_Intercept                      -8.14      0.21    -8.53    -7.71 1.00    14701
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    57707
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    56764
# Site_YearMatheson_2018               -0.00      0.00    -0.00     0.00 1.00    56415
# Site_YearRedRiver_2017                0.00      0.00    -0.00     0.00 1.00    58245
# Site_YearRedRiver_2018                0.00      0.00    -0.00     0.00 1.00    57365
# Site_YearSandyBar_2017                0.00      0.00    -0.00     0.00 1.00    56981
# Site_YearSandyBar_2018                0.00      0.00    -0.00     0.00 1.00    56655
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    61879
# SexM                                  0.00      0.00     0.00     0.00 1.00    48929
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    60134
# sigma_Site_YearDauphinRiver_2018     -0.70      0.35    -1.35     0.00 1.00    20965
# sigma_Site_YearMatheson_2017         -1.02      0.47    -1.84     0.01 1.00    26949
# sigma_Site_YearMatheson_2018         -1.40      0.29    -1.98    -0.82 1.00    19341
# sigma_Site_YearRedRiver_2017         -0.27      0.28    -0.82     0.29 1.00    19058
# sigma_Site_YearRedRiver_2018         -0.68      0.29    -1.25    -0.10 1.00    20239
# sigma_Site_YearSandyBar_2017         -0.50      0.27    -1.04     0.04 1.00    19123
# sigma_Site_YearSandyBar_2018         -0.77      0.30    -1.36    -0.18 1.00    20886
# sigma_Site_YearWinnipegRiver_2017    -0.41      0.54    -1.33     0.79 1.00    27220
# sigma_SexM                           -0.43      0.21    -0.82    -0.01 1.00    43205
# sigma_SexUN                           0.42      0.38    -0.31     1.19 1.00    37071
# Tail_ESS
# Intercept                            43185
# sigma_Intercept                      22883
# Site_YearDauphinRiver_2018           49049
# Site_YearMatheson_2017               45310
# Site_YearMatheson_2018               42920
# Site_YearRedRiver_2017               47271
# Site_YearRedRiver_2018               47257
# Site_YearSandyBar_2017               45765
# Site_YearSandyBar_2018               44945
# Site_YearWinnipegRiver_2017          39018
# SexM                                 52986
# SexUN                                38888
# sigma_Site_YearDauphinRiver_2018     31415
# sigma_Site_YearMatheson_2017         31559
# sigma_Site_YearMatheson_2018         29090
# sigma_Site_YearRedRiver_2017         31050
# sigma_Site_YearRedRiver_2018         29699
# sigma_Site_YearSandyBar_2017         28946
# sigma_Site_YearSandyBar_2018         30738
# sigma_Site_YearWinnipegRiver_2017    25792
# sigma_SexM                           42496
# sigma_SexUN                          38581
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    24.06     14.19     6.07    59.76 1.00    40877    36036
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C18_1OH, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000427  0.000285  0.000577
# DauphinRiver_2018  0.000353  0.000260  0.000448
# Matheson_2017      0.000381  0.000273  0.000487
# Matheson_2018      0.000343  0.000283  0.000405
# RedRiver_2017      0.000536  0.000416  0.000652
# RedRiver_2018      0.000464  0.000382  0.000545
# SandyBar_2017      0.000429  0.000339  0.000518
# SandyBar_2018      0.000434  0.000359  0.000512
# WinnipegRiver_2017 0.000767  0.000492  0.001033
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

pairs(emmeans(test2_C18_1OH, ~ Site_Year))
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000427  0.000285  0.000577
# DauphinRiver_2018  0.000353  0.000260  0.000448
# Matheson_2017      0.000381  0.000273  0.000487
# Matheson_2018      0.000343  0.000283  0.000405
# RedRiver_2017      0.000536  0.000416  0.000652
# RedRiver_2018      0.000464  0.000382  0.000545
# SandyBar_2017      0.000429  0.000339  0.000518
# SandyBar_2018      0.000434  0.000359  0.000512
# WinnipegRiver_2017 0.000767  0.000492  0.001033
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 
# > pairs(emmeans(test2_C18_1OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   7.37e-05 -9.20e-05  2.52e-04
# DauphinRiver_2017 - Matheson_2017       4.53e-05 -1.13e-04  2.17e-04
# DauphinRiver_2017 - Matheson_2018       8.44e-05 -5.96e-05  2.39e-04
# DauphinRiver_2017 - RedRiver_2017      -1.08e-04 -2.85e-04  7.15e-05
# DauphinRiver_2017 - RedRiver_2018      -3.74e-05 -1.84e-04  1.22e-04
# DauphinRiver_2017 - SandyBar_2017      -2.59e-06 -1.61e-04  1.62e-04
# DauphinRiver_2017 - SandyBar_2018      -7.82e-06 -1.53e-04  1.51e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -3.39e-04 -6.31e-04 -3.70e-05
# DauphinRiver_2018 - Matheson_2017      -2.70e-05 -1.68e-04  1.04e-04
# DauphinRiver_2018 - Matheson_2018       9.59e-06 -8.96e-05  1.11e-04
# DauphinRiver_2018 - RedRiver_2017      -1.83e-04 -3.23e-04 -3.91e-05
# DauphinRiver_2018 - RedRiver_2018      -1.10e-04 -2.25e-04  6.92e-06
# DauphinRiver_2018 - SandyBar_2017      -7.58e-05 -1.94e-04  4.50e-05
# DauphinRiver_2018 - SandyBar_2018      -8.06e-05 -1.93e-04  3.27e-05
# DauphinRiver_2018 - WinnipegRiver_2017 -4.14e-04 -7.04e-04 -1.45e-04
# Matheson_2017 - Matheson_2018           3.77e-05 -7.14e-05  1.53e-04
# Matheson_2017 - RedRiver_2017          -1.55e-04 -3.00e-04 -5.57e-06
# Matheson_2017 - RedRiver_2018          -8.36e-05 -1.98e-04  3.24e-05
# Matheson_2017 - SandyBar_2017          -4.88e-05 -1.71e-04  7.49e-05
# Matheson_2017 - SandyBar_2018          -5.44e-05 -1.65e-04  6.14e-05
# Matheson_2017 - WinnipegRiver_2017     -3.86e-04 -6.71e-04 -1.01e-04
# Matheson_2018 - RedRiver_2017          -1.93e-04 -3.09e-04 -7.43e-05
# Matheson_2018 - RedRiver_2018          -1.20e-04 -2.10e-04 -3.28e-05
# Matheson_2018 - SandyBar_2017          -8.57e-05 -1.79e-04  5.31e-06
# Matheson_2018 - SandyBar_2018          -9.05e-05 -1.78e-04 -6.67e-06
# Matheson_2018 - WinnipegRiver_2017     -4.23e-04 -7.00e-04 -1.65e-04
# RedRiver_2017 - RedRiver_2018           7.25e-05 -5.64e-05  2.03e-04
# RedRiver_2017 - SandyBar_2017           1.07e-04 -2.61e-05  2.40e-04
# RedRiver_2017 - SandyBar_2018           1.02e-04 -2.52e-05  2.32e-04
# RedRiver_2017 - WinnipegRiver_2017     -2.31e-04 -5.21e-04  4.52e-05
# RedRiver_2018 - SandyBar_2017           3.41e-05 -6.83e-05  1.36e-04
# RedRiver_2018 - SandyBar_2018           2.92e-05 -5.72e-05  1.19e-04
# RedRiver_2018 - WinnipegRiver_2017     -3.03e-04 -5.84e-04 -3.33e-05
# SandyBar_2017 - SandyBar_2018          -5.08e-06 -1.08e-04  9.24e-05
# SandyBar_2017 - WinnipegRiver_2017     -3.38e-04 -6.27e-04 -7.56e-05
# SandyBar_2018 - WinnipegRiver_2017     -3.33e-04 -6.13e-04 -6.33e-05
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C18_1OH, ~ Site_Year)) #### That's the one!!!!!!
test2_C18_1OH_yr_plot<- plot(emmeans(test2_C18_1OH, ~ Site_Year)) #### That's the one!!!!!!
test2_C18_1OH_yr_plot
ggsave("test2_C18_1OH_yr_plot.png")
plot(emmeans(test2_C18_1OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C18_1OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C18_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C18_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C18_1OH.rda")
C18_1OH_tets2_plot <- gather_emmeans_draws(emmeans(test2_C18_1OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C18_1OH_tets2_plot.png")
library(repmod)
library(report)
report(test2_C18_1OH)

#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C18_1OH, file = "test2_C18_1OH.RDA")







#### test 2 C18 simple model ####
test2_C18<- brm(data=carn_dataf,
                family = student,
                bf(C18~ Site_Year + Sex,
                   sigma ~ Site_Year + Sex),
                prior = c(prior(normal(0,0.001), class = b),
                          prior(normal(0,0.001), class = Intercept)),
                iter = 20000, warmup = 5000, chains = 4, cores = 4,
                control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C18)
pp_check(test2_C18, ndraws = 100) +
  theme_bw()
summary(test2_C18)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C18 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    51010
# sigma_Intercept                      -8.55      0.32    -9.19    -7.94 1.00    11819
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    58526
# Site_YearMatheson_2017                0.00      0.00    -0.00     0.00 1.00    58002
# Site_YearMatheson_2018               -0.00      0.00    -0.00     0.00 1.00    54390
# Site_YearRedRiver_2017                0.00      0.00     0.00     0.00 1.00    60397
# Site_YearRedRiver_2018                0.00      0.00     0.00     0.00 1.00    51844
# Site_YearSandyBar_2017                0.00      0.00     0.00     0.00 1.00    57405
# Site_YearSandyBar_2018                0.00      0.00     0.00     0.00 1.00    54835
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    61720
# SexM                                  0.00      0.00    -0.00     0.00 1.00    44877
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    57270
# sigma_Site_YearDauphinRiver_2018      0.26      0.42    -0.54     1.10 1.00    16738
# sigma_Site_YearMatheson_2017          0.05      0.54    -0.94     1.18 1.00    23339
# sigma_Site_YearMatheson_2018         -0.62      0.42    -1.45     0.19 1.00    20014
# sigma_Site_YearRedRiver_2017          0.47      0.37    -0.23     1.21 1.00    16148
# sigma_Site_YearRedRiver_2018          0.44      0.38    -0.30     1.22 1.00    15991
# sigma_Site_YearSandyBar_2017          0.65      0.36    -0.04     1.36 1.00    16644
# sigma_Site_YearSandyBar_2018          0.68      0.41    -0.11     1.50 1.00    16209
# sigma_Site_YearWinnipegRiver_2017     0.50      0.60    -0.56     1.80 1.00    22078
# sigma_SexM                            0.10      0.24    -0.37     0.59 1.00    35479
# sigma_SexUN                           0.42      0.45    -0.45     1.34 1.00    29782
# Tail_ESS
# Intercept                            42143
# sigma_Intercept                      20609
# Site_YearDauphinRiver_2018           53563
# Site_YearMatheson_2017               45822
# Site_YearMatheson_2018               43891
# Site_YearRedRiver_2017               52160
# Site_YearRedRiver_2018               47362
# Site_YearSandyBar_2017               50914
# Site_YearSandyBar_2018               49985
# Site_YearWinnipegRiver_2017          40666
# SexM                                 45077
# SexUN                                35289
# sigma_Site_YearDauphinRiver_2018     26306
# sigma_Site_YearMatheson_2017         30716
# sigma_Site_YearMatheson_2018         27018
# sigma_Site_YearRedRiver_2017         25533
# sigma_Site_YearRedRiver_2018         27040
# sigma_Site_YearSandyBar_2017         26149
# sigma_Site_YearSandyBar_2018         26149
# sigma_Site_YearWinnipegRiver_2017    29335
# sigma_SexM                           39512
# sigma_SexUN                          34684
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu     5.21      4.84     1.90    18.12 1.00    16797    18597
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C18, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000667  0.000526  0.000833
# DauphinRiver_2018  0.000518  0.000327  0.000719
# Matheson_2017      0.000692  0.000425  0.000975
# Matheson_2018      0.000646  0.000530  0.000769
# RedRiver_2017      0.001191  0.000986  0.001409
# RedRiver_2018      0.001059  0.000836  0.001278
# SandyBar_2017      0.000942  0.000711  0.001190
# SandyBar_2018      0.001053  0.000781  0.001349
# WinnipegRiver_2017 0.001007  0.000541  0.001441
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

pairs(emmeans(test2_C18, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   1.53e-04 -8.01e-05  3.77e-04
# DauphinRiver_2017 - Matheson_2017      -2.04e-05 -3.10e-04  2.62e-04
# DauphinRiver_2017 - Matheson_2018       2.29e-05 -1.28e-04  1.79e-04
# DauphinRiver_2017 - RedRiver_2017      -5.20e-04 -7.47e-04 -2.94e-04
# DauphinRiver_2017 - RedRiver_2018      -3.89e-04 -6.25e-04 -1.47e-04
# DauphinRiver_2017 - SandyBar_2017      -2.71e-04 -5.21e-04 -3.16e-05
# DauphinRiver_2017 - SandyBar_2018      -3.82e-04 -6.86e-04 -8.93e-05
# DauphinRiver_2017 - WinnipegRiver_2017 -3.34e-04 -7.78e-04  1.35e-04
# DauphinRiver_2018 - Matheson_2017      -1.75e-04 -5.07e-04  1.53e-04
# DauphinRiver_2018 - Matheson_2018      -1.30e-04 -3.23e-04  7.43e-05
# DauphinRiver_2018 - RedRiver_2017      -6.75e-04 -9.38e-04 -4.10e-04
# DauphinRiver_2018 - RedRiver_2018      -5.40e-04 -8.28e-04 -2.59e-04
# DauphinRiver_2018 - SandyBar_2017      -4.25e-04 -7.15e-04 -1.44e-04
# DauphinRiver_2018 - SandyBar_2018      -5.35e-04 -8.78e-04 -2.20e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -4.85e-04 -9.57e-04 -4.76e-06
# Matheson_2017 - Matheson_2018           4.81e-05 -2.33e-04  3.23e-04
# Matheson_2017 - RedRiver_2017          -4.98e-04 -8.23e-04 -1.71e-04
# Matheson_2017 - RedRiver_2018          -3.69e-04 -6.96e-04 -2.35e-05
# Matheson_2017 - SandyBar_2017          -2.51e-04 -5.92e-04  9.41e-05
# Matheson_2017 - SandyBar_2018          -3.64e-04 -7.51e-04  2.03e-05
# Matheson_2017 - WinnipegRiver_2017     -3.10e-04 -8.30e-04  2.00e-04
# Matheson_2018 - RedRiver_2017          -5.44e-04 -7.45e-04 -3.48e-04
# Matheson_2018 - RedRiver_2018          -4.12e-04 -6.44e-04 -1.80e-04
# Matheson_2018 - SandyBar_2017          -2.95e-04 -5.37e-04 -7.80e-05
# Matheson_2018 - SandyBar_2018          -4.04e-04 -7.03e-04 -1.24e-04
# Matheson_2018 - WinnipegRiver_2017     -3.59e-04 -8.04e-04  8.39e-05
# RedRiver_2017 - RedRiver_2018           1.32e-04 -1.55e-04  4.17e-04
# RedRiver_2017 - SandyBar_2017           2.48e-04 -4.02e-05  5.30e-04
# RedRiver_2017 - SandyBar_2018           1.39e-04 -1.94e-04  4.74e-04
# RedRiver_2017 - WinnipegRiver_2017      1.88e-04 -2.74e-04  6.72e-04
# RedRiver_2018 - SandyBar_2017           1.14e-04 -1.91e-04  4.14e-04
# RedRiver_2018 - SandyBar_2018           3.44e-06 -3.32e-04  3.32e-04
# RedRiver_2018 - WinnipegRiver_2017      5.53e-05 -4.24e-04  5.43e-04
# SandyBar_2017 - SandyBar_2018          -1.10e-04 -4.56e-04  2.38e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.84e-05 -5.40e-04  4.36e-04
# SandyBar_2018 - WinnipegRiver_2017      5.07e-05 -4.65e-04  5.72e-04
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C18, ~ Site_Year)) #### That's the one!!!!!!
test2_C18_yr_plot<- plot(emmeans(test2_C18, ~ Site_Year)) #### That's the one!!!!!!
test2_C18_yr_plot
ggsave("test2_C18_yr_plot.png")
plot(emmeans(test2_C18, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C18, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C18, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C18, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C18.rda")
C18_tets2_plot <- gather_emmeans_draws(emmeans(test2_C18, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C18_tets2_plot.png")
library(repmod)
library(report)
report(test2_C18)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C18, file = "test2_C18.RDA")

#### test 2 C4OH simple model ####
test2_C4OH<- brm(data=carn_dataf,
                 family = skew_normal,
                 bf(C4OH~ Site_Year + Sex,
                    sigma ~ Site_Year + Sex),
                 prior = c(prior(normal(0,0.002), class = b),
                           prior(normal(0,0.002), class = Intercept)),
                 iter = 20000, warmup = 5000, chains = 4, cores = 4,
                 control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C4OH)
pp_check(test2_C4OH, ndraws = 100) +
  theme_bw()
summary(test2_C4OH)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: C4OH ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    30329
# sigma_Intercept                      -7.91      0.19    -8.26    -7.51 1.00    16916
# Site_YearDauphinRiver_2018            0.00      0.00     0.00     0.00 1.00    38086
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    37361
# Site_YearMatheson_2018                0.00      0.00    -0.00     0.00 1.00    33856
# Site_YearRedRiver_2017               -0.00      0.00    -0.00     0.00 1.00    34952
# Site_YearRedRiver_2018               -0.00      0.00    -0.00     0.00 1.00    32144
# Site_YearSandyBar_2017               -0.00      0.00    -0.00    -0.00 1.00    29993
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    30260
# Site_YearWinnipegRiver_2017           0.00      0.00     0.00     0.00 1.00    42108
# SexM                                  0.00      0.00    -0.00     0.00 1.00    50733
# SexUN                                 0.00      0.00     0.00     0.00 1.00    49015
# sigma_Site_YearDauphinRiver_2018      0.06      0.27    -0.47     0.60 1.00    21638
# sigma_Site_YearMatheson_2017         -0.08      0.47    -0.91     0.94 1.00    26521
# sigma_Site_YearMatheson_2018          0.14      0.34    -0.49     0.85 1.00    20883
# sigma_Site_YearRedRiver_2017          0.00      0.27    -0.52     0.53 1.00    22193
# sigma_Site_YearRedRiver_2018         -0.26      0.27    -0.79     0.28 1.00    22370
# sigma_Site_YearSandyBar_2017         -0.33      0.26    -0.84     0.16 1.00    21098
# sigma_Site_YearSandyBar_2018         -0.22      0.27    -0.76     0.32 1.00    21894
# sigma_Site_YearWinnipegRiver_2017    -0.39      0.54    -1.28     0.83 1.00    27609
# sigma_SexM                           -0.28      0.18    -0.62     0.09 1.00    40856
# sigma_SexUN                           2.08      0.35     1.38     2.77 1.00    28426
# Tail_ESS
# Intercept                            34728
# sigma_Intercept                      21588
# Site_YearDauphinRiver_2018           43117
# Site_YearMatheson_2017               38990
# Site_YearMatheson_2018               42867
# Site_YearRedRiver_2017               41225
# Site_YearRedRiver_2018               37089
# Site_YearSandyBar_2017               35719
# Site_YearSandyBar_2018               36349
# Site_YearWinnipegRiver_2017          38040
# SexM                                 50864
# SexUN                                37207
# sigma_Site_YearDauphinRiver_2018     28185
# sigma_Site_YearMatheson_2017         29249
# sigma_Site_YearMatheson_2018         33089
# sigma_Site_YearRedRiver_2017         28521
# sigma_Site_YearRedRiver_2018         29755
# sigma_Site_YearSandyBar_2017         27303
# sigma_Site_YearSandyBar_2018         26507
# sigma_Site_YearWinnipegRiver_2017    25039
# sigma_SexM                           38234
# sigma_SexUN                          34558
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     6.63      2.15     3.17    11.45 1.00    31410    28550
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C4OH, ~ Site_Year)
# Site_Year           emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.00145  0.000837   0.00210
# DauphinRiver_2018  0.00175  0.001140   0.00243
# Matheson_2017      0.00131  0.000650   0.00204
# Matheson_2018      0.00169  0.001058   0.00230
# RedRiver_2017      0.00133  0.000723   0.00200
# RedRiver_2018      0.00142  0.000812   0.00207
# SandyBar_2017      0.00125  0.000668   0.00192
# SandyBar_2018      0.00142  0.000809   0.00208
# WinnipegRiver_2017 0.00179  0.001111   0.00253
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

pairs(emmeans(test2_C4OH, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018  -3.03e-04 -5.88e-04 -3.15e-05
# DauphinRiver_2017 - Matheson_2017       1.49e-04 -2.30e-04  4.90e-04
# DauphinRiver_2017 - Matheson_2018      -2.15e-04 -5.78e-04  1.01e-04
# DauphinRiver_2017 - RedRiver_2017       1.20e-04 -1.24e-04  3.59e-04
# DauphinRiver_2017 - RedRiver_2018       2.90e-05 -1.73e-04  2.40e-04
# DauphinRiver_2017 - SandyBar_2017       1.94e-04  3.94e-06  3.92e-04
# DauphinRiver_2017 - SandyBar_2018       2.88e-05 -1.67e-04  2.38e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -3.36e-04 -7.46e-04  5.32e-06
# DauphinRiver_2018 - Matheson_2017       4.52e-04  3.69e-05  8.24e-04
# DauphinRiver_2018 - Matheson_2018       8.58e-05 -2.97e-04  4.39e-04
# DauphinRiver_2018 - RedRiver_2017       4.24e-04  1.33e-04  7.11e-04
# DauphinRiver_2018 - RedRiver_2018       3.33e-04  7.92e-05  6.05e-04
# DauphinRiver_2018 - SandyBar_2017       4.98e-04  2.52e-04  7.56e-04
# DauphinRiver_2018 - SandyBar_2018       3.33e-04  7.91e-05  6.03e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -3.46e-05 -4.60e-04  3.66e-04
# Matheson_2017 - Matheson_2018          -3.64e-04 -8.15e-04  9.35e-05
# Matheson_2017 - RedRiver_2017          -2.82e-05 -3.77e-04  3.65e-04
# Matheson_2017 - RedRiver_2018          -1.20e-04 -4.40e-04  2.48e-04
# Matheson_2017 - SandyBar_2017           4.45e-05 -2.54e-04  4.26e-04
# Matheson_2017 - SandyBar_2018          -1.20e-04 -4.33e-04  2.55e-04
# Matheson_2017 - WinnipegRiver_2017     -4.85e-04 -9.71e-04  2.47e-05
# Matheson_2018 - RedRiver_2017           3.37e-04  1.57e-05  7.13e-04
# Matheson_2018 - RedRiver_2018           2.44e-04 -5.71e-05  6.00e-04
# Matheson_2018 - SandyBar_2017           4.09e-04  1.34e-04  7.71e-04
# Matheson_2018 - SandyBar_2018           2.44e-04 -5.70e-05  5.96e-04
# Matheson_2018 - WinnipegRiver_2017     -1.21e-04 -5.74e-04  3.59e-04
# RedRiver_2017 - RedRiver_2018          -9.07e-05 -3.14e-04  1.37e-04
# RedRiver_2017 - SandyBar_2017           7.39e-05 -1.32e-04  2.95e-04
# RedRiver_2017 - SandyBar_2018          -9.07e-05 -3.09e-04  1.43e-04
# RedRiver_2017 - WinnipegRiver_2017     -4.56e-04 -8.71e-04 -9.47e-05
# RedRiver_2018 - SandyBar_2017           1.65e-04 -7.93e-06  3.40e-04
# RedRiver_2018 - SandyBar_2018           1.50e-07 -1.82e-04  1.84e-04
# RedRiver_2018 - WinnipegRiver_2017     -3.65e-04 -7.62e-04 -2.66e-05
# SandyBar_2017 - SandyBar_2018          -1.65e-04 -3.40e-04  7.32e-06
# SandyBar_2017 - WinnipegRiver_2017     -5.29e-04 -9.27e-04 -2.05e-04
# SandyBar_2018 - WinnipegRiver_2017     -3.64e-04 -7.80e-04 -4.60e-05
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C4OH, ~ Site_Year)) #### That's the one!!!!!!
test2_C4OH_yr_plot<- plot(emmeans(test2_C4OH, ~ Site_Year)) #### That's the one!!!!!!
test2_C4OH_yr_plot
ggsave("test2_C4OH_yr_plot.png")
plot(emmeans(test2_C4OH, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C4OH, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C4OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C4OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C4OH.rda")
C4OH_tets2_plot <- gather_emmeans_draws(emmeans(test2_C4OH, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C4OH_tets2_plot.png")
library(repmod)
library(report)
report(test2_C4OH)

#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C4OH, file = "test2_C4OH.RDA")


#### test 2 C5_1 simple model ####
test2_C5_1 <- brm(data=carn_dataf,
                   family = student,
                   bf(C5_1 ~ Site_Year + Sex,
                      sigma ~ Site_Year + Sex),
                   prior = c(prior(normal(0,0.001), class = b),
                             prior(normal(0,0.001), class = Intercept)),
                   iter = 20000, warmup = 5000, chains = 4, cores = 4,
                   control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C5_1)
pp_check(test2_C5_1, ndraws = 100) +
  theme_bw()
summary(test2_C5_1)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C5_1 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    58002
# sigma_Intercept                      -7.97      0.20    -8.33    -7.55 1.00    17691
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    59306
# Site_YearMatheson_2017               -0.00      0.00    -0.00     0.00 1.00    58595
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    59470
# Site_YearRedRiver_2017               -0.00      0.00    -0.00    -0.00 1.00    57332
# Site_YearRedRiver_2018               -0.00      0.00    -0.00    -0.00 1.00    58514
# Site_YearSandyBar_2017               -0.00      0.00    -0.00    -0.00 1.00    59882
# Site_YearSandyBar_2018               -0.00      0.00    -0.00    -0.00 1.00    58728
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    70516
# SexM                                  0.00      0.00    -0.00     0.00 1.00    57451
# SexUN                                -0.00      0.00    -0.00     0.00 1.00    59246
# sigma_Site_YearDauphinRiver_2018     -0.61      0.30    -1.20    -0.00 1.00    22995
# sigma_Site_YearMatheson_2017         -1.28      0.47    -2.12    -0.26 1.00    27400
# sigma_Site_YearMatheson_2018         -1.18      0.31    -1.78    -0.56 1.00    22251
# sigma_Site_YearRedRiver_2017         -0.67      0.28    -1.22    -0.12 1.00    22882
# sigma_Site_YearRedRiver_2018         -1.08      0.31    -1.68    -0.48 1.00    23243
# sigma_Site_YearSandyBar_2017         -0.19      0.27    -0.72     0.33 1.00    21865
# sigma_Site_YearSandyBar_2018         -0.53      0.30    -1.11     0.06 1.00    23262
# sigma_Site_YearWinnipegRiver_2017     0.54      0.52    -0.36     1.68 1.00    26419
# sigma_SexM                            0.03      0.21    -0.38     0.43 1.00    36018
# sigma_SexUN                           0.08      0.35    -0.59     0.80 1.00    35023
# Tail_ESS
# Intercept                            45600
# sigma_Intercept                      22157
# Site_YearDauphinRiver_2018           49078
# Site_YearMatheson_2017               49256
# Site_YearMatheson_2018               47408
# Site_YearRedRiver_2017               48488
# Site_YearRedRiver_2018               46848
# Site_YearSandyBar_2017               49853
# Site_YearSandyBar_2018               50135
# Site_YearWinnipegRiver_2017          38584
# SexM                                 54371
# SexUN                                44933
# sigma_Site_YearDauphinRiver_2018     32440
# sigma_Site_YearMatheson_2017         29540
# sigma_Site_YearMatheson_2018         29736
# sigma_Site_YearRedRiver_2017         30207
# sigma_Site_YearRedRiver_2018         31658
# sigma_Site_YearSandyBar_2017         28800
# sigma_Site_YearSandyBar_2018         30684
# sigma_Site_YearWinnipegRiver_2017    27466
# sigma_SexM                           38494
# sigma_SexUN                          35141
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    22.08     13.90     5.13    57.08 1.00    31195    32037
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C5_1, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000806  0.000622  0.000993
# DauphinRiver_2018  0.000600  0.000488  0.000720
# Matheson_2017      0.000624  0.000501  0.000745
# Matheson_2018      0.000416  0.000337  0.000493
# RedRiver_2017      0.000500  0.000393  0.000613
# RedRiver_2018      0.000327  0.000242  0.000412
# SandyBar_2017      0.000558  0.000406  0.000707
# SandyBar_2018      0.000472  0.000348  0.000597
# WinnipegRiver_2017 0.001091  0.000387  0.001768
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

pairs(emmeans(test2_C5_1, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   2.05e-04 -1.18e-05  4.23e-04
# DauphinRiver_2017 - Matheson_2017       1.82e-04 -2.78e-05  3.90e-04
# DauphinRiver_2017 - Matheson_2018       3.89e-04  2.04e-04  5.86e-04
# DauphinRiver_2017 - RedRiver_2017       3.05e-04  9.44e-05  5.02e-04
# DauphinRiver_2017 - RedRiver_2018       4.78e-04  2.89e-04  6.70e-04
# DauphinRiver_2017 - SandyBar_2017       2.49e-04  2.21e-05  4.77e-04
# DauphinRiver_2017 - SandyBar_2018       3.34e-04  1.23e-04  5.45e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -2.85e-04 -9.76e-04  4.31e-04
# DauphinRiver_2018 - Matheson_2017      -2.26e-05 -1.91e-04  1.46e-04
# DauphinRiver_2018 - Matheson_2018       1.85e-04  4.79e-05  3.18e-04
# DauphinRiver_2018 - RedRiver_2017       1.00e-04 -5.94e-05  2.54e-04
# DauphinRiver_2018 - RedRiver_2018       2.73e-04  1.27e-04  4.15e-04
# DauphinRiver_2018 - SandyBar_2017       4.26e-05 -1.46e-04  2.30e-04
# DauphinRiver_2018 - SandyBar_2018       1.29e-04 -3.81e-05  2.96e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -4.90e-04 -1.21e-03  1.96e-04
# Matheson_2017 - Matheson_2018           2.08e-04  7.70e-05  3.38e-04
# Matheson_2017 - RedRiver_2017           1.23e-04 -2.16e-05  2.74e-04
# Matheson_2017 - RedRiver_2018           2.96e-04  1.66e-04  4.23e-04
# Matheson_2017 - SandyBar_2017           6.50e-05 -1.13e-04  2.46e-04
# Matheson_2017 - SandyBar_2018           1.52e-04 -1.27e-05  3.08e-04
# Matheson_2017 - WinnipegRiver_2017     -4.68e-04 -1.16e-03  2.38e-04
# Matheson_2018 - RedRiver_2017          -8.40e-05 -2.00e-04  2.80e-05
# Matheson_2018 - RedRiver_2018           8.87e-05 -7.77e-06  1.88e-04
# Matheson_2018 - SandyBar_2017          -1.42e-04 -3.01e-04  8.97e-06
# Matheson_2018 - SandyBar_2018          -5.52e-05 -1.93e-04  7.79e-05
# Matheson_2018 - WinnipegRiver_2017     -6.74e-04 -1.35e-03  2.96e-05
# RedRiver_2017 - RedRiver_2018           1.73e-04  5.38e-05  2.91e-04
# RedRiver_2017 - SandyBar_2017          -5.72e-05 -2.27e-04  1.10e-04
# RedRiver_2017 - SandyBar_2018           2.86e-05 -1.25e-04  1.80e-04
# RedRiver_2017 - WinnipegRiver_2017     -5.90e-04 -1.27e-03  1.27e-04
# RedRiver_2018 - SandyBar_2017          -2.30e-04 -3.87e-04 -7.48e-05
# RedRiver_2018 - SandyBar_2018          -1.44e-04 -2.79e-04 -1.15e-05
# RedRiver_2018 - WinnipegRiver_2017     -7.64e-04 -1.47e-03 -8.40e-05
# SandyBar_2017 - SandyBar_2018           8.66e-05 -9.55e-05  2.70e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.34e-04 -1.23e-03  1.69e-04
# SandyBar_2018 - WinnipegRiver_2017     -6.19e-04 -1.31e-03  8.35e-05
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C5_1, ~ Site_Year)) #### That's the one!!!!!!
test2_C5_1_yr_plot<- plot(emmeans(test2_C5_1, ~ Site_Year)) #### That's the one!!!!!!
test2_C5_1_yr_plot
ggsave("test2_C5_1 _yr_plot.png")
plot(emmeans(test2_C5_1, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C5_1, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C5_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C5_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_ C5_1.rda")
C5_1_tets2_plot <- gather_emmeans_draws(emmeans(test2_C5_1, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C5_1_tets2_plot.png")
library(repmod)
library(report)
report(test2_C5_1)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C5_1, file = "test2_C5_1.RDA")






#### test 2 C3 simple model ####
test2_C3<- brm(data=carn_dataf,
               family = skew_normal,
               bf(C3~ Site_Year + Sex,
                  sigma ~ Site_Year + Sex),
               prior = c(prior(normal(0,0.04), class = b),
                         prior(normal(0,0.04), class = Intercept)),
               iter = 20000, warmup = 5000, chains = 4, cores = 4,
               control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C3)
pp_check(test2_C3, ndraws = 100) +
  theme_bw()
summary(test2_C3)
# Family: skew_normal 
# Links: mu = identity; sigma = log; alpha = identity 
# Formula: C3 ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.05      0.01     0.04     0.07 1.00    12846
# sigma_Intercept                      -3.45      0.17    -3.77    -3.08 1.00    21052
# Site_YearDauphinRiver_2018           -0.00      0.01    -0.02     0.02 1.00    17440
# Site_YearMatheson_2017               -0.02      0.01    -0.04     0.01 1.00    19478
# Site_YearMatheson_2018               -0.03      0.01    -0.04    -0.02 1.00    13501
# Site_YearRedRiver_2017               -0.04      0.01    -0.05    -0.03 1.00    13041
# Site_YearRedRiver_2018               -0.03      0.01    -0.05    -0.02 1.00    13399
# Site_YearSandyBar_2017               -0.02      0.01    -0.03    -0.01 1.00    15657
# Site_YearSandyBar_2018               -0.03      0.01    -0.05    -0.02 1.00    13262
# Site_YearWinnipegRiver_2017          -0.02      0.01    -0.04     0.01 1.00    17768
# SexM                                  0.00      0.00    -0.00     0.00 1.00    55975
# SexUN                                -0.00      0.00    -0.01     0.01 1.00    40256
# sigma_Site_YearDauphinRiver_2018     -0.55      0.29    -1.12     0.03 1.00    26998
# sigma_Site_YearMatheson_2017         -0.63      0.45    -1.42     0.37 1.00    26306
# sigma_Site_YearMatheson_2018         -1.51      0.27    -2.04    -0.97 1.00    27910
# sigma_Site_YearRedRiver_2017         -1.66      0.25    -2.16    -1.15 1.00    28048
# sigma_Site_YearRedRiver_2018         -1.57      0.26    -2.08    -1.05 1.00    28487
# sigma_Site_YearSandyBar_2017         -0.58      0.25    -1.06    -0.09 1.00    25987
# sigma_Site_YearSandyBar_2018         -1.65      0.27    -2.16    -1.12 1.00    28817
# sigma_Site_YearWinnipegRiver_2017    -0.92      0.53    -1.80     0.27 1.00    24426
# sigma_SexM                            0.01      0.18    -0.34     0.38 1.00    43701
# sigma_SexUN                           0.21      0.32    -0.39     0.88 1.00    37268
# Tail_ESS
# Intercept                            16783
# sigma_Intercept                      24523
# Site_YearDauphinRiver_2018           24590
# Site_YearMatheson_2017               22883
# Site_YearMatheson_2018               17694
# Site_YearRedRiver_2017               17369
# Site_YearRedRiver_2018               17458
# Site_YearSandyBar_2017               21359
# Site_YearSandyBar_2018               18116
# Site_YearWinnipegRiver_2017          23465
# SexM                                 43388
# SexUN                                32675
# sigma_Site_YearDauphinRiver_2018     38074
# sigma_Site_YearMatheson_2017         23200
# sigma_Site_YearMatheson_2018         32760
# sigma_Site_YearRedRiver_2017         34722
# sigma_Site_YearRedRiver_2018         36062
# sigma_Site_YearSandyBar_2017         32627
# sigma_Site_YearSandyBar_2018         35988
# sigma_Site_YearWinnipegRiver_2017    23348
# sigma_SexM                           40499
# sigma_SexUN                          34456
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# alpha     6.53      2.17     3.01    11.45 1.00    38393    33694
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C3, ~ Site_Year)
# Site_Year          emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.0530   0.04027    0.0658
# DauphinRiver_2018  0.0519   0.04199    0.0637
# Matheson_2017      0.0337   0.01836    0.0555
# Matheson_2018      0.0224   0.01791    0.0273
# RedRiver_2017      0.0131   0.00879    0.0176
# RedRiver_2018      0.0208   0.01653    0.0258
# SandyBar_2017      0.0329   0.02481    0.0418
# SandyBar_2018      0.0209   0.01689    0.0256
# WinnipegRiver_2017 0.0350   0.02160    0.0565
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

pairs(emmeans(test2_C3, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   0.000892  -0.01619  0.017098
# DauphinRiver_2017 - Matheson_2017       0.018787  -0.00479  0.039064
# DauphinRiver_2017 - Matheson_2018       0.030448   0.01777  0.043845
# DauphinRiver_2017 - RedRiver_2017       0.039845   0.02710  0.052629
# DauphinRiver_2017 - RedRiver_2018       0.032077   0.01970  0.045346
# DauphinRiver_2017 - SandyBar_2017       0.019921   0.00545  0.034448
# DauphinRiver_2017 - SandyBar_2018       0.031930   0.01970  0.045312
# DauphinRiver_2017 - WinnipegRiver_2017  0.017395  -0.00521  0.037359
# DauphinRiver_2018 - Matheson_2017       0.018036  -0.00521  0.038290
# DauphinRiver_2018 - Matheson_2018       0.029442   0.01813  0.041432
# DauphinRiver_2018 - RedRiver_2017       0.038824   0.02819  0.051288
# DauphinRiver_2018 - RedRiver_2018       0.031067   0.02009  0.043607
# DauphinRiver_2018 - SandyBar_2017       0.019052   0.00510  0.033042
# DauphinRiver_2018 - SandyBar_2018       0.030916   0.01998  0.043251
# DauphinRiver_2018 - WinnipegRiver_2017  0.016671  -0.00612  0.035617
# Matheson_2017 - Matheson_2018           0.011275  -0.00439  0.033364
# Matheson_2017 - RedRiver_2017           0.020600   0.00532  0.042693
# Matheson_2017 - RedRiver_2018           0.012820  -0.00323  0.034245
# Matheson_2017 - SandyBar_2017           0.000923  -0.01759  0.022760
# Matheson_2017 - SandyBar_2018           0.012683  -0.00260  0.034817
# Matheson_2017 - WinnipegRiver_2017     -0.001458  -0.02714  0.026694
# Matheson_2018 - RedRiver_2017           0.009345   0.00422  0.014437
# Matheson_2018 - RedRiver_2018           0.001633  -0.00405  0.007337
# Matheson_2018 - SandyBar_2017          -0.010378  -0.01972 -0.001780
# Matheson_2018 - SandyBar_2018           0.001471  -0.00403  0.006776
# Matheson_2018 - WinnipegRiver_2017     -0.012536  -0.03356  0.001734
# RedRiver_2017 - RedRiver_2018          -0.007730  -0.01263 -0.002982
# RedRiver_2017 - SandyBar_2017          -0.019725  -0.02875 -0.011905
# RedRiver_2017 - SandyBar_2018          -0.007867  -0.01261 -0.003391
# RedRiver_2017 - WinnipegRiver_2017     -0.021886  -0.04299 -0.008030
# RedRiver_2018 - SandyBar_2017          -0.012015  -0.02160 -0.004139
# RedRiver_2018 - SandyBar_2018          -0.000152  -0.00494  0.004774
# RedRiver_2018 - WinnipegRiver_2017     -0.014172  -0.03552 -0.000247
# SandyBar_2017 - SandyBar_2018           0.011850   0.00377  0.020895
# SandyBar_2017 - WinnipegRiver_2017     -0.002249  -0.02347  0.014911
# SandyBar_2018 - WinnipegRiver_2017     -0.014042  -0.03531 -0.000219
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

plot(emmeans(test2_C3, ~ Site_Year)) #### That's the one!!!!!!
test2_C3_yr_plot<- plot(emmeans(test2_C3, ~ Site_Year)) #### That's the one!!!!!!
test2_C3_yr_plot
ggsave("test2_C3_yr_plot.png")
plot(emmeans(test2_C3, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C3, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C3, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C3, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C3.rda")
C3_tets2_plot <- gather_emmeans_draws(emmeans(test2_C3, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C3_tets2_plot.png")
library(repmod)
library(report)
report(test2_C3)
#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C3, file = "test2_c3.RDA")

#### test 2 C5MDC simple model ####
test2_C5MDC <- brm(data=carn_dataf,
                    family = student,
                    bf(C5MDC ~ Site_Year + Sex,
                       sigma ~ Site_Year + Sex),
                    prior = c(prior(normal(0,0.001), class = b),
                              prior(normal(0,0.001), class = Intercept)),
                    iter = 20000, warmup = 5000, chains = 4, cores = 4,
                    control = list(adapt_delta = 0.95, max_treedepth = 15))

plot(test2_C5MDC)
pp_check(test2_C5MDC, ndraws = 100) +
  theme_bw()
summary(test2_C5MDC)
# Family: student 
# Links: mu = identity; sigma = log; nu = identity 
# Formula: C5MDC ~ Site_Year + Sex 
# sigma ~ Site_Year + Sex
# Data: carn_dataf (Number of observations: 122) 
# Draws: 4 chains, each with iter = 20000; warmup = 5000; thin = 1;
# total post-warmup draws = 60000
# 
# Population-Level Effects: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS
# Intercept                             0.00      0.00     0.00     0.00 1.00    59088
# sigma_Intercept                      -7.88      0.20    -8.26    -7.46 1.00    16015
# Site_YearDauphinRiver_2018           -0.00      0.00    -0.00     0.00 1.00    60321
# Site_YearMatheson_2017               -0.00      0.00    -0.00    -0.00 1.00    59069
# Site_YearMatheson_2018               -0.00      0.00    -0.00    -0.00 1.00    60398
# Site_YearRedRiver_2017               -0.00      0.00    -0.00     0.00 1.00    58225
# Site_YearRedRiver_2018               -0.00      0.00    -0.00    -0.00 1.00    55160
# Site_YearSandyBar_2017               -0.00      0.00    -0.00     0.00 1.00    61443
# Site_YearSandyBar_2018               -0.00      0.00    -0.00     0.00 1.00    54947
# Site_YearWinnipegRiver_2017           0.00      0.00    -0.00     0.00 1.00    68155
# SexM                                  0.00      0.00    -0.00     0.00 1.00    48874
# SexUN                                 0.00      0.00    -0.00     0.00 1.00    61597
# sigma_Site_YearDauphinRiver_2018     -0.30      0.31    -0.91     0.32 1.00    20910
# sigma_Site_YearMatheson_2017         -1.38      0.47    -2.22    -0.38 1.00    30942
# sigma_Site_YearMatheson_2018         -1.04      0.31    -1.64    -0.41 1.00    21114
# sigma_Site_YearRedRiver_2017         -0.36      0.28    -0.91     0.20 1.00    20195
# sigma_Site_YearRedRiver_2018         -0.60      0.30    -1.19     0.00 1.00    20734
# sigma_Site_YearSandyBar_2017         -0.24      0.27    -0.77     0.29 1.00    20030
# sigma_Site_YearSandyBar_2018         -0.20      0.30    -0.78     0.41 1.00    20312
# sigma_Site_YearWinnipegRiver_2017     0.19      0.51    -0.70     1.33 1.00    29049
# sigma_SexM                           -0.20      0.20    -0.59     0.20 1.00    41836
# sigma_SexUN                           0.07      0.34    -0.57     0.78 1.00    36171
# Tail_ESS
# Intercept                            46022
# sigma_Intercept                      23015
# Site_YearDauphinRiver_2018           51631
# Site_YearMatheson_2017               45943
# Site_YearMatheson_2018               48531
# Site_YearRedRiver_2017               49920
# Site_YearRedRiver_2018               49205
# Site_YearSandyBar_2017               50691
# Site_YearSandyBar_2018               50645
# Site_YearWinnipegRiver_2017          40251
# SexM                                 51550
# SexUN                                43128
# sigma_Site_YearDauphinRiver_2018     30619
# sigma_Site_YearMatheson_2017         31409
# sigma_Site_YearMatheson_2018         30701
# sigma_Site_YearRedRiver_2017         29370
# sigma_Site_YearRedRiver_2018         29462
# sigma_Site_YearSandyBar_2017         28268
# sigma_Site_YearSandyBar_2018         29954
# sigma_Site_YearWinnipegRiver_2017    30989
# sigma_SexM                           42503
# sigma_SexUN                          36542
# 
# Family Specific Parameters: 
#   Estimate Est.Error l-95% CI u-95% CI Rhat Bulk_ESS Tail_ESS
# nu    22.68     13.94     5.44    58.08 1.00    35976    31123
# 
# Draws were sampled using sampling(NUTS). For each parameter, Bulk_ESS
# and Tail_ESS are effective sample size measures, and Rhat is the potential
# scale reduction factor on split chains (at convergence, Rhat = 1).

emmeans(test2_C5MDC, ~ Site_Year)
# Site_Year            emmean lower.HPD upper.HPD
# DauphinRiver_2017  0.000819  0.000628  0.001024
# DauphinRiver_2018  0.000650  0.000487  0.000820
# Matheson_2017      0.000597  0.000474  0.000719
# Matheson_2018      0.000503  0.000405  0.000602
# RedRiver_2017      0.000725  0.000569  0.000877
# RedRiver_2018      0.000607  0.000482  0.000739
# SandyBar_2017      0.000648  0.000496  0.000805
# SandyBar_2018      0.000730  0.000560  0.000903
# WinnipegRiver_2017 0.001207  0.000618  0.001771
# 
# Results are averaged over the levels of: Sex 
# Point estimate displayed: median 
# HPD interval probability: 0.95 

pairs(emmeans(test2_C5MDC, ~ Site_Year))
# contrast                                estimate lower.HPD upper.HPD
# DauphinRiver_2017 - DauphinRiver_2018   1.68e-04 -9.16e-05  4.26e-04
# DauphinRiver_2017 - Matheson_2017       2.22e-04  2.14e-05  4.34e-04
# DauphinRiver_2017 - Matheson_2018       3.18e-04  1.14e-04  5.26e-04
# DauphinRiver_2017 - RedRiver_2017       9.51e-05 -1.36e-04  3.29e-04
# DauphinRiver_2017 - RedRiver_2018       2.11e-04  5.46e-06  4.34e-04
# DauphinRiver_2017 - SandyBar_2017       1.71e-04 -5.68e-05  4.04e-04
# DauphinRiver_2017 - SandyBar_2018       8.85e-05 -1.55e-04  3.37e-04
# DauphinRiver_2017 - WinnipegRiver_2017 -3.86e-04 -9.69e-04  2.21e-04
# DauphinRiver_2018 - Matheson_2017       5.41e-05 -1.50e-04  2.63e-04
# DauphinRiver_2018 - Matheson_2018       1.48e-04 -3.86e-05  3.38e-04
# DauphinRiver_2018 - RedRiver_2017      -7.30e-05 -2.97e-04  1.45e-04
# DauphinRiver_2018 - RedRiver_2018       4.52e-05 -1.61e-04  2.57e-04
# DauphinRiver_2018 - SandyBar_2017       3.85e-06 -2.23e-04  2.29e-04
# DauphinRiver_2018 - SandyBar_2018      -7.83e-05 -3.15e-04  1.53e-04
# DauphinRiver_2018 - WinnipegRiver_2017 -5.54e-04 -1.12e-03  7.50e-05
# Matheson_2017 - Matheson_2018           9.59e-05 -4.65e-05  2.30e-04
# Matheson_2017 - RedRiver_2017          -1.27e-04 -3.00e-04  4.87e-05
# Matheson_2017 - RedRiver_2018          -1.03e-05 -1.55e-04  1.35e-04
# Matheson_2017 - SandyBar_2017          -5.13e-05 -2.23e-04  1.18e-04
# Matheson_2017 - SandyBar_2018          -1.34e-04 -3.26e-04  4.88e-05
# Matheson_2017 - WinnipegRiver_2017     -6.09e-04 -1.17e-03 -8.60e-06
# Matheson_2018 - RedRiver_2017          -2.23e-04 -3.81e-04 -6.33e-05
# Matheson_2018 - RedRiver_2018          -1.05e-04 -2.51e-04  3.78e-05
# Matheson_2018 - SandyBar_2017          -1.46e-04 -3.06e-04  2.09e-05
# Matheson_2018 - SandyBar_2018          -2.28e-04 -4.17e-04 -4.44e-05
# Matheson_2018 - WinnipegRiver_2017     -7.05e-04 -1.27e-03 -1.20e-04
# RedRiver_2017 - RedRiver_2018           1.18e-04 -5.55e-05  2.98e-04
# RedRiver_2017 - SandyBar_2017           7.70e-05 -1.14e-04  2.76e-04
# RedRiver_2017 - SandyBar_2018          -4.97e-06 -2.12e-04  2.13e-04
# RedRiver_2017 - WinnipegRiver_2017     -4.83e-04 -1.05e-03  1.20e-04
# RedRiver_2018 - SandyBar_2017          -4.12e-05 -2.19e-04  1.33e-04
# RedRiver_2018 - SandyBar_2018          -1.23e-04 -3.10e-04  6.77e-05
# RedRiver_2018 - WinnipegRiver_2017     -6.00e-04 -1.16e-03  6.10e-06
# SandyBar_2017 - SandyBar_2018          -8.24e-05 -2.92e-04  1.32e-04
# SandyBar_2017 - WinnipegRiver_2017     -5.58e-04 -1.11e-03  5.41e-05
# SandyBar_2018 - WinnipegRiver_2017     -4.75e-04 -1.04e-03  1.38e-04



plot(emmeans(test2_C5MDC, ~ Site_Year)) #### That's the one!!!!!!
test2_C5MDC_yr_plot<-plot(emmeans(test2_C5MDC, ~ Site_Year)) #### That's the one!!!!!!
test2_C5MDC_yr_plot
ggsave("test2_C5MDC _yr_plot.png")
plot(emmeans(test2_C5MDC, ~ Sex*Site_Year))
plot(pairs(emmeans(test2_C5MDC, ~ Site_Year)))

gather_emmeans_draws(emmeans(test2_C5MDC, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_halfeye()

gather_emmeans_draws(emmeans(test2_C5MDC, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("test2_C5MDC.rda")
C5MDC_tets2_plot <- gather_emmeans_draws(emmeans(test2_C5MDC, ~ Site_Year)) %>% 
  ggplot(aes(x = .value, y = Site_Year)) +
  stat_pointinterval() +
  theme_bw(base_size = 18)
ggsave("C5MDC _tets2_plot.png")
library(repmod)
library(report)
report(test2_C5MDC)

#saving model
save(a, b, c, file = "stuff.RData")
save()
save(test2_C5MDC, file = "test2_C5MDC.RDA")

